
# US Diabetes / Obesity  - DANUGLIPRON -
library(tidyverse)
library(data.table)
library(hacksaw)
library(splitstackshape)
library(spatstat)
library(lubridate)
library(openxlsx)
options(scipen = 999)
library(randomForest)
library(DALEX)
library(gbm)

# -------
# Semaglutide Oral dosages over time ----------------------------------------------------------------------


DIA_Medications <- fread("DANU Medications.txt")
                                    
DIA_Medications <- DIA_Medications %>% filter(brand_name =="Rybelsus") %>% select(drug_id, med_ingredient, med_strength)


Dia_US_Doses <- fread("DIA Doses.txt")

Dia_US_Doses <- Dia_US_Doses %>% filter(drug_group == "GLP1 Oral") %>% left_join(DIA_Medications) %>% mutate(from_dt = as.Date(from_dt))

Dia_US_Doses$doses <- parse_number(Dia_US_Doses$med_strength)

Dia_US_Doses %>% filter(drug_group == "GLP1 Oral") %>% 
  select(generic_name, dayssup, pat_id, from_dt, doses) %>% group_by(pat_id) %>% 
  summarise(n=n()) %>% arrange(-n)

unique(Dia_US_Doses$doses) #14, 7, 3
weighted.mean(Dia_US_Doses$doses, Dia_US_Doses$weight) #7.40316
weighted.median(Dia_US_Doses$doses, Dia_US_Doses$weight) #5

Dia_US_Doses_semaglutide_Oral <- Dia_US_Doses %>% filter(drug_group == "GLP1 Oral") %>% 
  select(generic_name, dayssup, pat_id, weight, from_dt, doses) 

Dia_US_Doses_semaglutide_Oral <- Dia_US_Doses_semaglutide_Oral %>% filter(!is.na(doses))

Dia_US_Doses_semaglutide_Oral_summary <- Dia_US_Doses_semaglutide_Oral %>% group_by(pat_id) %>% arrange(pat_id, from_dt) %>% 
  mutate(index = from_dt-lag(from_dt)) %>% ungroup() %>% mutate(index = as.numeric(index)) %>%
  mutate(index = ifelse(is.na(index), 0, index)) %>% group_by(pat_id) %>%
  mutate(time_progression = cumsum(index)) %>% select(-c(generic_name, dayssup, index))

Dia_US_Doses_semaglutide_Oral_summary %>% ungroup() %>% select(pat_id, doses, time_progression) %>%
  ggplot(aes(x=time_progression, y=doses, fill=doses, colour=-doses))+
  geom_jitter(height =0., width = 0.7, show.legend = F, alpha=0.2, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 20))+
  xlab("\nTime since therapy initiation (days)")+
  ylab("Dosage Prescribed\n")+
  scale_y_continuous(breaks = c(3, 7, 14))

length(unique(Dia_US_Doses_semaglutide_Oral_summary$pat_id)) #2553

Dia_US_Doses_semaglutide_Oral_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% slice_head() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))



Dia_US_Doses_semaglutide_Oral_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=30) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))


Dia_US_Doses_semaglutide_Oral_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=60) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))



Dia_US_Doses_semaglutide_Oral_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=90) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))

Dia_US_Doses_semaglutide_Oral_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=120) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))


Dia_US_Doses_semaglutide_Oral_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=150) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))



Dia_US_Doses_semaglutide_Oral_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=180) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))

# ----
# Generating Long Flows Table ------------------------
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)

# Flows table in long format
flDIA <- DIA_Drug_Histories
flDIA <- flDIA[,disease := NULL]

flDIA <- melt(flDIA, id = c("patient","weight"))
names(flDIA)[c(3,4)] <- c("p1","v1")
flDIA <- flDIA[, p1 := str_extract(p1,"[:digit:]+")]
flDIA$p1 <- as.numeric(flDIA$p1)
flDIA <- data.frame(cbind(flDIA[p1 < 60], flDIA[p1 > 1,.(p2 = p1, v2 = v1)]), stringsAsFactors = F)
flDIA <- flDIA[,c(1:3,5,4,6)]

# Any flow flag and stops flag
flDIA <- setDT(flDIA)[, flow := (v1 != v2)*1]
flDIA <- flDIA[, stops := (flow == 1 & v2 == "-")*1]

# Treatment experience
RxExp <- data.frame(DIA_Drug_Histories, stringsAsFactors = F)
RxExp$month1 <- (RxExp$month1 != "-")*1

for(i in 2:60){
  cat(i)
  RxExp[,i+2] <- (((RxExp[,i+2] != "-")*1 + RxExp[,i+2-1]) > 0)*1
}

RxExp <- setDT(RxExp)
RxExp <- melt(RxExp, id = c("patient","weight"))
RxExp <- RxExp[, month := str_extract(variable,"[:digit:]+")]
RxExp$month <- as.numeric(RxExp$month)
names(RxExp)[4] <- "DIA_RxExp"

flDIA <- RxExp[,.(patient,month,DIA_RxExp)][flDIA, on = .(patient, month = p1)]
flDIA <- flDIA[,.(patient, weight, p1 = month, p2, v1, v2, p1_RxExp = DIA_RxExp, flow, stops)]

# Starts and re-starts flag
flDIA <- flDIA[, starts := (flow == 1 & v1 == "-" & p1_RxExp == 0)*1]
flDIA <- flDIA[, re_starts := (flow == 1 & v1 == "-" & p1_RxExp == 1)*1]
flDIA <- flDIA[, disease := "DIA US"]
flDIA <- flDIA[,c(12,1:11)]

# Bring Therapy classes (Stocks) to the table
DIA_Box_Histories <- DIA_Box_Histories[,disease := NULL]
DIA_Box_Histories <- data.frame(DIA_Box_Histories, stringsAsFactors = F)

for(i in 1:60){
  cat(i)
  DIA_Box_Histories[,i+2] <- unlist(lapply(DIA_Box_Histories[,i+2],function(x) str_sub(x, 2L, 2L)))
}

setDT(DIA_Box_Histories) 
DIA_Box_Histories <- melt(DIA_Box_Histories, id = c("patient","weight"))
names(DIA_Box_Histories)[c(3,4)] <- c("p","s")
DIA_Box_Histories <- DIA_Box_Histories[, p := str_extract(p,"[:digit:]+")]
DIA_Box_Histories$p <- as.numeric(DIA_Box_Histories$p)

flDIA <- DIA_Box_Histories[,.(patient,p,s)][flDIA, on = .(patient, p = p1)]
names(flDIA)[c(2,3)] <- c("p1","s1")
flDIA <- DIA_Box_Histories[,.(patient,p,s)][flDIA, on = .(patient, p = p2)]
names(flDIA)[c(2,3)] <- c("p2","s2")

flDIA <- flDIA[,.(disease, patient, weight, p1, p2, v1, v2, s1, s2, p1_RxExp, flow, stops, starts, re_starts)]
names(flDIA)[c(6,7)] <- c("d1","d2")

fwrite(flDIA,"DIA_Flows_Aux._Long.txt")



DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long.     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

# -----
# Flows to/ from Rybelsus --------------------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))

# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_OralExp = ifelse(grepl("47",d1),1,0))
# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = cumsum(p1_OralExp))
# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = ifelse(p1_OralExp==0,0,1))
# 
# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_InjExp = ifelse(grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|grepl("51",d1)|grepl("52",d1)|grepl("53",d1),1,0))
# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = cumsum(p1_InjExp))
# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = ifelse(p1_InjExp==0,0,1))


DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("47",d1)) %>% filter(grepl("47",d2)) %>%
  group_by(s1) %>% summarise(pats=sum(as.numeric(weight))) #1727


DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(grepl("47",d1)) %>% filter(!grepl("47",d2)) %>% 
  group_by(s2) %>% summarise(pats=sum(as.numeric(weight))) #912
 


# ----
# Flows to/ from GLP1s --------------------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))

# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_OralExp = ifelse(grepl("47",d1),1,0))
# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = cumsum(p1_OralExp))
# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = ifelse(p1_OralExp==0,0,1))
# 
# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_InjExp = ifelse(grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|grepl("51",d1)|grepl("52",d1)|grepl("53",d1),1,0))
# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = cumsum(p1_InjExp))
# DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = ifelse(p1_InjExp==0,0,1))


DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("g",s1)) %>% filter(grepl("g",s2)) %>%
  group_by(s1) %>% summarise(pats=sum(as.numeric(weight))) 

DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("g",s1)) %>% filter(grepl("g",s2)) %>% select(patient) %>% distinct() #1661



DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("G",s1)) %>% filter(grepl("G",s2)) %>%
  group_by(s1) %>% summarise(pats=sum(as.numeric(weight)))




DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("G",s1)) %>% filter(grepl("G",s2)) %>% select(patient) %>% distinct() #14725

# Flows matrix ---------

df <- as.data.frame(DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(flow == "1") %>%
  mutate(s1=fct_relevel(s1,c("x","b","d","D","S","I","g","G"))) %>%
  mutate(s2=fct_relevel(s2,c("x","b","d","D","S","I","g","G"))) %>%
  group_by(s1, s2) %>% summarise(n=sum(weight)) %>%
  arrange(s1,s2) %>%
  spread(key = s2, value = n))

row.names(df) <- df$s1

df <- df %>% select(-c(s1))

df <- round(df/1000)



grid.bubble.plot <- function(df, 
                             axis_labels_size=16, 
                             aspect_ratio=1/1,
                             values_text_size=2,
                             values_text_color="black",
                             x_axis_position="top", # or "bottom",
                             bubble_size_range=c(5, 25),
                             bubble_alpha=0.5,
                             bubble_shape=21,
                             bubble_edge_stroke=0) {
  col_names <- colnames(df)
  row_names <- rownames(df)
  values <- as.vector(as.matrix(df))
  values_x <- as.vector(sapply(col_names, function(i) rep(i, nrow(df))))
  values_y <- as.vector(rep(row_names, dim(df)[2]))
  res_df <- data.frame(values = values, values_x = values_x, values_y)
  res_df <- data.frame(res_df %>% mutate(values_x=fct_relevel(values_x,c("x","b","d","D","S","I","g","G"))) %>%
                         mutate(values_y=fct_relevel(values_y,c("x","b","d","D","S","I","g","G"))))
  gg <- ggplot(res_df, aes(x=values_x, y=values_y, size = values, fill=factor(values_x))) +
    geom_point(alpha=bubble_alpha, shape=bubble_shape, stroke=bubble_edge_stroke) +
    scale_size(range = bubble_size_range) +
    ggsci::scale_fill_npg() +
    scale_x_discrete(position = x_axis_position) +
    scale_y_discrete(limits=rev)+
    geom_text(aes(label=values), size=values_text_size, color=values_text_color,) +
    theme(line=element_blank(), 
          panel.background=element_blank(),
          legend.position="none",
          axis.title=element_blank(),
          axis.text=element_text(size=axis_labels_size),
          aspect.ratio=aspect_ratio)
  gg
}

grid.bubble.plot(df)


# ------
# Of all the flows to Injectable GLP1, how many were already on Rybelsus ? -------------------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

# Since Rybelus came out
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(p1>=43)

DIA_Flows_Aux._Long %>% filter(!grepl("G",s1)) %>% filter(grepl("G",s2)) %>% filter(!grepl("x",s1)) %>%
  summarise(pats=sum(as.numeric(weight))) #5562372

DIA_Flows_Aux._Long %>% filter(!grepl("G",s1)) %>% filter(grepl("G",s2)) %>% filter(!grepl("x",s1)) %>%
  filter(grepl("47",d1)) %>% summarise(pats=sum(as.numeric(weight))) #12086.35

DIA_Flows_Aux._Long %>% filter(!grepl("G",s1)) %>% filter(grepl("G",s2)) %>% filter(!grepl("x",s1)) %>%
  filter(!grepl("47",d1)) %>% summarise(pats=sum(as.numeric(weight))) #5550286

# 0.002172877 Only ! Not so good



# -----
# Choord chart -----
library(circlize)

Choord_Chart_DIA_US <- read.csv("choord_Chart_US_DIA.csv")

Choord_Chart_DIA_US <- Choord_Chart_DIA_US[,2:9]

rownames(Choord_Chart_DIA_US) <- colnames(Choord_Chart_DIA_US)

Choord_Chart_DIA_US <- as.matrix(Choord_Chart_DIA_US)

circos.clear()

cols <- hcl.colors(8, "Zissou 1")

chordDiagram(Choord_Chart_DIA_US, 
             grid.col = cols, 
             directional = 1, 
             direction.type = c("arrows", "diffHeight"), 
             diffHeight  = -0.04, 
             annotationTrackHeight = c(0.1, 0.1),
             link.arr.type = "big.arrow", 
             link.sort = TRUE, 
             link.largest.ontop = TRUE,
             annotationTrack = c("grid","name"),  
             transparency = 0.3)
# -------
# Pick pats starting Inj GLP1 after month43 (and Oral GLP1), and then compare what they start first ------------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_OralExp = ifelse(grepl("47",d1),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = cumsum(p1_OralExp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = ifelse(p1_OralExp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_InjExp = ifelse(grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|grepl("51",d1)|grepl("52",d1)|grepl("53",d1),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = cumsum(p1_InjExp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = ifelse(p1_InjExp==0,0,1))

Pats_to_Track <- DIA_Flows_Aux._Long %>% filter(p1 == 42) %>% filter(p1_OralExp == 0 & p1_InjExp == 0) %>% select(patient) %>% distinct()

DIA_Flows_Aux._Long <- Pats_to_Track %>% left_join(DIA_Flows_Aux._Long)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(p1 >= 43)

# Any Oral after m43  -> 174977
DIA_Flows_Aux._Long %>% ungroup() %>% filter(p1_OralExp != 0) %>% select(patient, weight) %>% distinct() %>% summarise(n = sum(weight)) 

# Any Inj after m43  -> 1446167
DIA_Flows_Aux._Long %>% ungroup() %>% filter(p1_InjExp != 0) %>% select(patient, weight) %>% distinct() %>% summarise(n = sum(weight)) 

DIA_Flows_Aux._Long %>% filter(p1_OralExp != 0 | p1_InjExp != 0) %>% group_by(patient) %>% slice(1) %>%
  ungroup() %>% group_by(p1_OralExp, p1_InjExp) %>% summarise(n = sum(weight))


# -----
# Split inflows to Rybelsus based on prev treat exp for advanced therapies --------------------------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_OralExp = ifelse(grepl("47",d1),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = cumsum(p1_OralExp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = ifelse(p1_OralExp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_InjExp = ifelse(grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|grepl("51",d1)|grepl("52",d1)|grepl("53",d1),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = cumsum(p1_InjExp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = ifelse(p1_InjExp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_InsulinExp = ifelse(grepl("38",d1)|grepl("39",d1)|grepl("40",d1)|grepl("41",d1)|grepl("42",d1)|grepl("43",d1)|grepl("44",d1)|grepl("45",d1)|grepl("46",d1),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InsulinExp = cumsum(p1_InsulinExp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InsulinExp = ifelse(p1_InsulinExp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_SGLT2Exp = ifelse(grepl("34",d1)|grepl("35",d1)|grepl("36",d1)|grepl("41",d1)|grepl("37",d1),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_SGLT2Exp = cumsum(p1_SGLT2Exp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_SGLT2Exp = ifelse(p1_SGLT2Exp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_DPP4Exp = ifelse(grepl("30",d1)|grepl("31",d1)|grepl("32",d1)|grepl("33",d1),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_DPP4Exp = cumsum(p1_DPP4Exp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_DPP4Exp = ifelse(p1_DPP4Exp==0,0,1))


DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("47",d1)) %>% filter(grepl("47",d2)) %>%
  group_by(s1) %>% summarise(pats=sum(as.numeric(weight))) #1727



DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("47",d1)) %>% filter(grepl("47",d2)) %>%
  group_by(s1, p1_OralExp) %>% summarise(pats=sum(as.numeric(weight))) 


DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("47",d1)) %>% filter(grepl("47",d2)) %>%
  group_by(s1, p1_InjExp) %>% summarise(pats=sum(as.numeric(weight))) 



DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("47",d1)) %>% filter(grepl("47",d2)) %>%
  group_by(s1, p1_InsulinExp) %>% summarise(pats=sum(as.numeric(weight))) 



DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("47",d1)) %>% filter(grepl("47",d2)) %>%
  group_by(s1, p1_SGLT2Exp) %>% summarise(pats=sum(as.numeric(weight))) 



DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("47",d1)) %>% filter(grepl("47",d2)) %>%
  group_by(s1, p1_DPP4Exp) %>% summarise(pats=sum(as.numeric(weight))) 


data.frame(DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("47",d1)) %>% filter(grepl("47",d2)) %>%
  group_by(s1, p1_OralExp, p1_InjExp, p1_InsulinExp, p1_SGLT2Exp, p1_DPP4Exp) %>% 
    summarise(pats=sum(as.numeric(weight))) %>% filter(p1_OralExp==0 & p1_InjExp==0 & p1_InsulinExp==0 & p1_SGLT2Exp==0 & p1_DPP4Exp==0))


# -----

# Concomitant drugs before and after Rybelsus Start -------
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2)

DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long

# first occurence of Rybelsus, month before and after as well, remove those who started on m60
DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% group_by(patient) %>% filter(grepl("47",d2)) %>% slice(1) %>%
  select(patient, weight, p2) %>% mutate(before=p2-1) %>% mutate(after=p2+1) %>% filter(after <= 60)

# collpase month to single column
DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% select(-c(weight)) %>% pivot_longer(!patient,  names_to = "month", values_to = "n") %>% select(-c(month))
DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% arrange(patient, n)

#pick only month before and month after
DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% group_by(patient)%>% filter(n==min(n)|n==max(n))

# add drugs
DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% left_join((DIA_Flows_Aux._Long %>% select(patient, p2, d2)), by=c("patient"="patient", "n"="p2"))

# to long, each molecule
DIA_Flows_Aux._Long_Rybelsus <- separate_rows(DIA_Flows_Aux._Long_Rybelsus, d2, sep = ",", convert=T )
names(DIA_Flows_Aux._Long_Rybelsus)[3] <- "molecule"

# drugs look up
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients <- DANU_Ingredients %>% select(molecule, drug_group)

# add drug classes
DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% left_join(DANU_Ingredients) %>% arrange(patient)
DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% mutate(n=ifelse(n==min(n), "Before", "After"))
DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% left_join((DIA_Flows_Aux._Long %>% select(patient, weight) %>% distinct()))
DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% ungroup() %>% select(patient, n, drug_group, weight) %>% distinct()
DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% group_by(patient, n, weight) %>% summarise(drug_groups = toString(drug_group))

DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% ungroup() %>% mutate(drug_groups = ifelse(drug_groups=="NA", "Lapsed", drug_groups))

DIA_Flows_Aux._Long_Rybelsus  %>% filter(n=="Before") %>% group_by(n, drug_groups) %>% summarise(pats = sum(as.numeric(weight))) %>% arrange(-pats) %>%
  mutate(drug_groups= as.factor(drug_groups)) %>%
  filter(pats>=2000) %>%
  ggplot(aes(x=pats, y=reorder(drug_groups,pats))) +
  geom_bar(stat="identity", alpha = 0.7, show.legend = FALSE, fill="midnightblue" )+
  xlab("\nProjected Population") + ylab("Drug Class Combinations\n")+
  ggtitle("Concomitant drug therapy immediately BEFORE Rybelsus start")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

DIA_Flows_Aux._Long_Rybelsus  %>% filter(n=="After") %>% group_b
# -y(n, drug_groups) %>% summarise(pats = sum(as.numeric(weight))) %>% arrange(-pats) %>%
  mutate(drug_groups= as.factor(drug_groups)) %>%
  filter(pats>=2000) %>%
  ggplot(aes(x=pats, y=reorder(drug_groups,pats))) +
  geom_bar(stat="identity", alpha = 0.7, show.legend = FALSE, fill="firebrick" )+
  xlab("\nProjected Population") + ylab("Drug Class Combinations\n")+
  ggtitle("Concomitant drug therapy immediately AFTER Rybelsus start")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
# ----
  
 # Number of drugs before and after Rybelsus Start ---------------
  DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
  
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2)

  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long 
  
  # first occurence of Rybelsus, month before and after as well, remove those who started on m60
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% group_by(patient) %>% filter(grepl("47",d2)) %>% slice(1) %>%
    select(patient, weight, p2) %>% mutate(before=p2-1) %>% mutate(after=p2+1) %>% filter(after <= 60)
  
  # collpase month to single column
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% select(-c(weight)) %>% pivot_longer(!patient,  names_to = "month", values_to = "n") %>% select(-c(month))
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% arrange(patient, n)
  
  # add drugs
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% left_join((DIA_Flows_Aux._Long %>% select(patient, p2, d2)), by=c("patient"="patient", "n"="p2"))
  
  # to long, each molecule
  DIA_Flows_Aux._Long_Rybelsus <- separate_rows(DIA_Flows_Aux._Long_Rybelsus, d2, sep = ",", convert=T )
  names(DIA_Flows_Aux._Long_Rybelsus)[3] <- "molecule"
  
  # drugs look up
  DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
  DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
  DANU_Ingredients <- DANU_Ingredients %>% select(molecule, drug_group)
  
  # add drug classes
  DIA_Flows_Aux._Long_Rybelsus<- DIA_Flows_Aux._Long_Rybelsus %>% left_join(DANU_Ingredients) %>% arrange(patient)
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% mutate(n=ifelse(n==min(n), "Before", ifelse(n==max(n),"After", "Current")))
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% left_join((DIA_Flows_Aux._Long %>% select(patient, weight) %>% distinct()))
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% ungroup() %>% mutate(drug_group = ifelse(is.na(drug_group), "Lapsed", drug_group))
  
  length(unique(DIA_Flows_Aux._Long_Rybelsus$patient)) #1844
 
  data.frame(DIA_Flows_Aux._Long_Rybelsus  %>% filter(n=="Before") %>% filter(drug_group!="Lapsed") %>% group_by(n, patient, weight) %>% 
               summarise(ndrugs = n()) %>% ungroup() %>% summarise(weighted = weighted.mean(ndrugs, as.numeric(weight))))
  #1.948795
  
  data.frame(DIA_Flows_Aux._Long_Rybelsus  %>% filter(n=="Current") %>% filter(drug_group!="Lapsed") %>% group_by(n, patient, weight) %>% 
               summarise(ndrugs = n()) %>% ungroup() %>% summarise(weighted = weighted.mean(ndrugs, as.numeric(weight))))
  #2.472482
  
  data.frame(DIA_Flows_Aux._Long_Rybelsus  %>% filter(n=="After") %>% filter(drug_group!="Lapsed") %>% group_by(n, patient, weight) %>% 
               summarise(ndrugs = n()) %>% ungroup() %>% summarise(weighted = weighted.mean(ndrugs, as.numeric(weight))))
  #2.331701
  
# -----
# CLass Penetrance before and after Rybelsus Start ------------------------------------------------------------------------------
  DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
  DIA_Flows_Aux._Long <- MIG_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2)
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long 
  
  # first occurence of ORAL CGRP, month before and after as well, remove those who started on m60
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% group_by(patient) %>% filter(grepl("47",d2)) %>% slice(1) %>%
    select(patient, weight, p2) %>% mutate(before=p2-1) %>% mutate(after=p2+1) %>% filter(after <= 60)
  
  # collpase month to single column
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% select(-c(weight)) %>% pivot_longer(!patient,  names_to = "month", values_to = "n") %>% select(-c(month))
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% arrange(patient, n)
  
  # add drugs
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% left_join((DIA_Flows_Aux._Long %>% select(patient, p2, s2, d2)), by=c("patient"="patient", "n"="p2"))
  
  # to long, each molecule
  DIA_Flows_Aux._Long_Rybelsus <- separate_rows(DIA_Flows_Aux._Long_Rybelsus, d2, sep = ",", convert=T )
  
  names(DIA_Flows_Aux._Long_Rybelsus)[4] <- "molecule"
  
  # drugs look up
  DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
  DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
  DANU_Ingredients <- DANU_Ingredients %>% select(molecule, drug_group)
  
  # add drug classes
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% left_join(DANU_Ingredients) %>% arrange(patient)
  
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% mutate(n=ifelse(n==min(n), "Before", 
                                                                       ifelse(n==max(n),"After", "Current")))
  
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% left_join((DIA_Flows_Aux._Long %>% select(patient, weight) %>% distinct()))
  
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% ungroup() %>% select(patient, n, s2, drug_group, weight) %>% distinct()
  
  DIA_Flows_Aux._Long_Rybelsus <- DIA_Flows_Aux._Long_Rybelsus %>% ungroup() %>% mutate(drug_group = ifelse(is.na(drug_group), "Lapsed", drug_group))
  
  #Toal = 237500
  
  before_penetrance <- data.frame(DIA_Flows_Aux._Long_Rybelsus  %>% filter(n=="Before") %>% group_by(n, s2, drug_group) %>% summarise(penetrance = (sum(as.numeric(weight)))) %>% arrange(s2, -penetrance) %>%
                                    mutate(drug_group= as.factor(drug_group)))
  
  current_penetrance <- data.frame(DIA_Flows_Aux._Long_Rybelsus  %>% filter(n=="Current") %>% group_by(n, s2, drug_group) %>% summarise(penetrance = (sum(as.numeric(weight)))) %>% arrange(s2, -penetrance) %>%
                                     mutate(drug_group= as.factor(drug_group))) 
  
  after_penetrance <- data.frame(DIA_Flows_Aux._Long_Rybelsus  %>% filter(n=="After") %>% group_by(n, s2, drug_group) %>% summarise(penetrance = (sum(as.numeric(weight)))) %>% arrange(s2, -penetrance) %>%
                                   mutate(drug_group= as.factor(drug_group))) 
  
  write.csv(before_penetrance, "Month_before_Rybelsus_Functions2_penetrance.csv")
  write.csv(current_penetrance, "Month_current_Rybelsus_Functions2_penetrance.csv")
  write.csv(after_penetrance, "Month_after_Rybelsus_Functions2_penetrance.csv")
  write.csv(DIA_Flows_Aux._Long_Rybelsus, "DIA_Flows_Aux._Long_Rybelsus_Months_Before_After_Class_Penetrance.csv")
  
# -----
  
  
# Treatment-experienced -------------
  DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
  
  DIA_Drug_Histories <- DIA_Drug_Histories %>% select(4:63)
  
  DIA_Drug_Histories[DIA_Drug_Histories != "-"] <- 1  # on drug 
  DIA_Drug_Histories[DIA_Drug_Histories == "-"] <- 0  # no drug
  
  DIA_Drug_Histories[] <- lapply(DIA_Drug_Histories,as.numeric)
  
  DIA_Drug_Histories$SUM <- rowSums(DIA_Drug_Histories)
  
  DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
  
  Pats_vec <- DIA_Drug_Histories_LONG %>% select(patient, weight)
  
  DIA_Drug_Histories <- Pats_vec %>% bind_cols(DIA_Drug_Histories)
  
  DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(SUM != 0)
  
  sum(DIA_Drug_Histories$weight)
  
  Treatment_exp_Vector <- DIA_Drug_Histories %>% select(patient, weight)
  
  fwrite(Treatment_exp_Vector, "Treatment_exp_Vector.txt")
  
# ----

  
# lines of Therapy ------------
  # DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
  # Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
  # DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
  
  DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
  Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
  DIA_Flows_Aux._Long <- Treatment_exp_Vector %>% select(patient) %>% left_join(DIA_Flows_Aux._Long)
  
  setDT(DIA_Flows_Aux._Long)
  
  data1                <- DIA_Flows_Aux._Long[p1 >= 1, .(patient,weight,p1,d1)]
  names(data1)[c(3,4)] <- c("month","drugs")
  
  data2                <- DIA_Flows_Aux._Long[p2 == 60, .(patient,weight,p2,d2)]
  names(data2)[c(3,4)] <- c("month","drugs")
  
  data <- setDT(data.frame(rbind(data1,data2)))
  
  # nr of lines & nr of months rx by patient
  data$Rx <- (data$drugs != "-")*1
  data <- data[Rx == 1,  ':=' (nr_lines = length(unique(drugs)), months_rx = sum(Rx)), by = .(patient)]
  data <- data[Rx == 1]
  
  data <- data %>% select(patient, weight, nr_lines, months_rx) %>% distinct()
  
  Stocksm60 <- DIA_Flows_Aux._Long %>% filter(p2 == 60) %>% select(patient, s2)
  
  data <- data %>% left_join(Stocksm60)
  
  weighted.mean(data$nr_lines,  data$weight) #2.98841
  
  data %>% group_by(s2) %>% summarise(n = weighted.mean(nr_lines, weight))
  

  data %>% mutate(nr_lines = ifelse(nr_lines>=6, 6, nr_lines)) %>% group_by(nr_lines) %>% 
    summarise(n = sum(weight))

  
  data %>% mutate(nr_lines = ifelse(nr_lines>=6, 6, nr_lines)) %>% group_by(s2, nr_lines) %>% 
    summarise(n = sum(weight)) %>% spread(key = s2, value = n)
  

  
temp <-  data %>% mutate(nr_lines = ifelse(nr_lines>=6, 6, nr_lines)) %>% group_by(nr_lines, s2) %>% 
    summarise(n = sum(weight)) %>% spread(key = nr_lines, value = n)
  
fwrite(temp, "temp.csv")
  
# -------
# Stocks Over time ----------
  DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
  Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
  DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
  
  # length(unique(DIA_Drug_Histories$patient)) # 220769
  # sum(as.numeric(DIA_Drug_Histories$weight)) #30625690
  
  DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
  DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
  DANU_Ingredients  <- DANU_Ingredients %>% select(molecule, drug_group)
  
  # Repeat for each month
  
  DIA_Drug_Histories_month60 <- DIA_Drug_Histories %>% select(patient, weight, month60)
  DIA_Drug_Histories_month60 <- separate_rows(DIA_Drug_Histories_month60, month60, sep = ",", convert=T )
  names(DIA_Drug_Histories_month60)[3] <- "molecule"
  DIA_Drug_Histories_month60 <- DIA_Drug_Histories_month60 %>% left_join(DANU_Ingredients) %>% filter(!is.na(drug_group))
  DIA_Drug_Histories_month60 <- DIA_Drug_Histories_month60 %>% select(patient, weight, drug_group)
  DIA_Drug_Histories_month60 <- DIA_Drug_Histories_month60 %>% distinct()
  
  DIA_Drug_Histories_time_series_month60 <- data.frame(DIA_Drug_Histories_month60 %>% group_by(drug_group) %>% summarise(sum_weights_month60 = sum(as.numeric(weight))))
  
  DIA_Drug_Histories_time_series <- DIA_Drug_Histories_time_series %>% full_join(DIA_Drug_Histories_time_series_month60)
  
  rm(DIA_Drug_Histories_month60, DIA_Drug_Histories_time_series_month60)
  
  fwrite(DIA_Drug_Histories_time_series, "DIA_Drug_Histories_time_series.txt", sep = "\t")
  
  
# -----
# Drug Experience ~ stock month60 --------
  DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
  DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
  Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
  
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))
  
  DIA_Flows_Aux._Long <- Treatment_exp_Vector %>% left_join(DIA_Flows_Aux._Long)
  
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_OralExp = ifelse(grepl("47",d1)|grepl("47",d2),1,0))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = cumsum(p1_OralExp))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = ifelse(p1_OralExp==0,0,1))
  
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_InjExp = ifelse(grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|grepl("51",d1)|grepl("52",d1)|grepl("53",d1)|grepl("48",d2)|grepl("49",d2)|grepl("50",d2)|grepl("51",d2)|grepl("52",d2)|grepl("53",d2),1,0))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = cumsum(p1_InjExp))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = ifelse(p1_InjExp==0,0,1))
  
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_InsulinExp = ifelse(grepl("38",d1)|grepl("39",d1)|grepl("40",d1)|grepl("41",d1)|grepl("42",d1)|grepl("43",d1)|grepl("44",d1)|grepl("45",d1)|grepl("46",d1)|grepl("38",d2)|grepl("39",d2)|grepl("40",d2)|grepl("41",d2)|grepl("42",d2)|grepl("43",d2)|grepl("44",d2)|grepl("45",d2)|grepl("46",d2),1,0))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InsulinExp = cumsum(p1_InsulinExp))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InsulinExp = ifelse(p1_InsulinExp==0,0,1))
  
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_SGLT2Exp = ifelse(grepl("34",d1)|grepl("35",d1)|grepl("36",d1)|grepl("37",d1)|grepl("34",d2)|grepl("35",d2)|grepl("36",d2)|grepl("37",d2),1,0))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_SGLT2Exp = cumsum(p1_SGLT2Exp))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_SGLT2Exp = ifelse(p1_SGLT2Exp==0,0,1))
  
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_DPP4Exp = ifelse(grepl("30",d1)|grepl("31",d1)|grepl("32",d1)|grepl("33",d1)|grepl("30",d2)|grepl("31",d2)|grepl("32",d2)|grepl("33",d2),1,0))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_DPP4Exp = cumsum(p1_DPP4Exp))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_DPP4Exp = ifelse(p1_DPP4Exp==0,0,1))
  
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_AntiDiabeticExp = ifelse(grepl("14",d1)|grepl("15",d1)|grepl("16",d1)|grepl("17",d1)|grepl("18",d1)|grepl("19",d1)|grepl("20",d1)|grepl("21",d1)|grepl("22",d1)|grepl("23",d1)|grepl("24",d1)|grepl("25",d1)|grepl("26",d1)|grepl("27",d1)|grepl("28",d1)|grepl("29",d1)|grepl("14",d2)|grepl("15",d2)|grepl("16",d2)|grepl("17",d2)|grepl("18",d2)|grepl("19",d2)|grepl("20",d2)|grepl("21",d2)|grepl("22",d2)|grepl("23",d2)|grepl("24",d2)|grepl("25",d2)|grepl("26",d2)|grepl("27",d2)|grepl("28",d2)|grepl("29",d2),1,0))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_AntiDiabeticExp = cumsum(p1_AntiDiabeticExp))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_AntiDiabeticExp = ifelse(p1_AntiDiabeticExp==0,0,1))
  
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_BiguanideExp = ifelse(grepl("(^|\\D)(1{1})(\\D|$)",d1)|grepl("(^|\\D)(1{1})(\\D|$)",d2),1,0))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_BiguanideExp = cumsum(p1_BiguanideExp))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_BiguanideExp = ifelse(p1_BiguanideExp==0,0,1))
  
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_AdvancedExp = ifelse(grepl("34",d1)|grepl("35",d1)|grepl("36",d1)|grepl("37",d1)|grepl("38",d1)|grepl("39",d1)|grepl("40",d1)|grepl("41",d1)|grepl("42",d1)|grepl("43",d1)|grepl("44",d1)|grepl("45",d1)|grepl("46",d1)|grepl("47",d1)|grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|grepl("51",d1)|grepl("52",d1)|grepl("53",d1)|grepl("34",d2)|grepl("35",d2)|grepl("36",d2)|grepl("37",d2)|grepl("38",d2)|grepl("39",d2)|grepl("40",d2)|grepl("41",d2)|grepl("42",d2)|grepl("43",d2)|grepl("44",d2)|grepl("45",d2)|grepl("46",d2)|grepl("47",d2)|grepl("48",d2)|grepl("49",d2)|grepl("50",d2)|grepl("51",d2)|grepl("52",d2)|grepl("53",d2),1,0))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_AdvancedExp = cumsum(p1_AdvancedExp))
  DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_AdvancedExp = ifelse(p1_AdvancedExp==0,0,1))
  
  
  Start_df <- DIA_Flows_Aux._Long %>% filter(p2==60) %>% group_by(s2) %>% summarise(pats=sum(as.numeric(weight))) 
  

  Start_df <- Start_df %>% left_join(DIA_Flows_Aux._Long %>% filter(p2==60) %>% group_by(s2, p1_OralExp) %>% 
                                       summarise(pats_p1_OralExp=sum(as.numeric(weight))) %>% filter(p1_OralExp == 1))
  
  Start_df <- Start_df %>% left_join(DIA_Flows_Aux._Long %>% filter(p2==60) %>% group_by(s2, p1_InjExp) %>% 
                                       summarise(pats_p1_InjExp=sum(as.numeric(weight))) %>% filter(p1_InjExp == 1))
  
  Start_df <- Start_df %>% left_join(DIA_Flows_Aux._Long %>% filter(p2==60) %>% group_by(s2, p1_InsulinExp) %>% 
                                       summarise(pats_p1_InsulinExp=sum(as.numeric(weight))) %>% filter(p1_InsulinExp == 1))
  
  Start_df <- Start_df %>% left_join(DIA_Flows_Aux._Long %>% filter(p2==60) %>% group_by(s2, p1_SGLT2Exp) %>% 
                                       summarise(pats_p1_SGLT2Exp=sum(as.numeric(weight))) %>% filter(p1_SGLT2Exp == 1))
  
  Start_df <- Start_df %>% left_join(DIA_Flows_Aux._Long %>% filter(p2==60) %>% group_by(s2, p1_DPP4Exp) %>% 
                                       summarise(pats_p1_DPP4Exp=sum(as.numeric(weight))) %>% filter(p1_DPP4Exp == 1))
  
  Start_df <- Start_df %>% left_join(DIA_Flows_Aux._Long %>% filter(p2==60) %>% group_by(s2, p1_AntiDiabeticExp) %>% 
                                       summarise(pats_p1_AntiDiabeticExp=sum(as.numeric(weight))) %>% filter(p1_AntiDiabeticExp == 1))
  
  Start_df <- Start_df %>% left_join(DIA_Flows_Aux._Long %>% filter(p2==60) %>% group_by(s2, p1_BiguanideExp) %>% 
                                       summarise(pats_p1_BiguanideExp=sum(as.numeric(weight))) %>% filter(p1_BiguanideExp == 1))
  
  Start_df <- Start_df %>% left_join(DIA_Flows_Aux._Long %>% filter(p2==60) %>% group_by(s2, p1_AdvancedExp) %>% 
                                       summarise(pats_p1_AdvancedExp=sum(as.numeric(weight))) %>% filter(p1_AdvancedExp == 1))
  
  
  Start_df <- Start_df[,c(1,2,4,6,8,10,12,14,16,18)]
  
  
  fwrite(Start_df, "Drug_exp_m60_noDPP4.txt", sep="\t")
  
  
  # change the order and format and all that
  Drug_exp_m60 <- fread("Drug_exp_m60_noDPP4.txt")
  
  Drug_exp_m60 <- data.frame(lapply(Drug_exp_m60, function(x) if(is.numeric(x)) round(x, 0) else x))
  
  
  row.names(Drug_exp_m60) <- Drug_exp_m60$Stock
  
  Drug_exp_m60 <- Drug_exp_m60 %>% select(-c(Stock))
  
  
  grid.bubble.plot <- function(df, 
                               axis_labels_size=8, 
                               aspect_ratio=1/1,
                               values_text_size=4,
                               values_text_color="black",
                               x_axis_position="top", # or "bottom",
                               bubble_size_range=c(5, 30),
                               bubble_alpha=0.7,
                               bubble_shape=21,
                               bubble_edge_stroke=0) {
    col_names <- colnames(df)
    row_names <- rownames(df)
    values <- as.vector(as.matrix(df))
    values_x <- as.vector(sapply(col_names, function(i) rep(i, nrow(df))))
    values_y <- as.vector(rep(row_names, dim(df)[2]))
    res_df <- data.frame(values = values, values_x = values_x, values_y)
    res_df <- data.frame(res_df %>% mutate(values_x=fct_relevel(values_x,c("Biguanide_Exp","Antidiabetic_Exp","DPP4_Exp","SGLT2_Exp","Insulin_Exp","Oral_GLP1_Exp","Injectable_Exp","Advanced_Exp"))) %>%
                           mutate(values_y=fct_relevel(values_y,c("Lapsed_Stock","Biguanide_Stock","Antidiabetic_Stock","DPP4_Stock","SGLT2_Stock","Insulin_Stock","Oral_GLP1_Stock","Injectable_GLP1_Stock"))))
    gg <- ggplot(res_df, aes(x=values_x, y=values_y, size = values, fill=factor(values_x))) +
      geom_point(alpha=bubble_alpha, shape=bubble_shape, stroke=bubble_edge_stroke) +
      scale_size(range = bubble_size_range) +
      scale_fill_viridis_d() +
      scale_x_discrete(position = x_axis_position) +
      scale_y_discrete(limits=rev)+
      geom_text(aes(label=paste0(values,"%")), fontface="bold", size=values_text_size, color=values_text_color,) +
      theme(line=element_blank(), 
            panel.background=element_blank(),
            legend.position="none",
            axis.title=element_blank(),
            axis.text=element_text(size=axis_labels_size),
            aspect.ratio=aspect_ratio)
    gg
  }
  
  grid.bubble.plot(Drug_exp_m60)
  
  
  
# -------
  
# Concomitant classes on month 60 ------------------
  #Treat experienced
  Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")
  
  #Stock m60
  DIA_Box_Histories <- fread("DIA Box Histories.txt",  integer64 = "character", stringsAsFactors = F)
  DIA_Box_Histories <- DIA_Box_Histories %>% select(2,3,63)
  DIA_Box_Histories <- DIA_Box_Histories %>% mutate(month60 = str_sub(month60, 2L, 2L))
  names(DIA_Box_Histories)[3] <- "Box_m60"
  DIA_Box_Histories <- Treatment_exp_Vector %>% left_join(DIA_Box_Histories)
  
  #drugs m60
  DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
  DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease)) %>% select(1,2,62)
  DIA_Box_Histories <- DIA_Box_Histories %>% left_join(DIA_Drug_Histories)
  
  DIA_Box_Histories %>% group_by(Box_m60) %>% summarise(n=sum(as.numeric(weight)))
  
 
  
  DIA_Box_Histories <- DIA_Box_Histories %>% mutate(combo = ifelse(grepl(",",month60), "Combo", "Mono"))
  
  DIA_Box_Histories %>% group_by(Box_m60, combo) %>% summarise(n=sum(as.numeric(weight)))
  

  
  DIA_Box_Histories <- separate_rows(DIA_Box_Histories, month60, sep = ",", convert=T)
  names(DIA_Box_Histories)[4] <- "molecule"
  
  # drugs look up
  DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
  DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
  DANU_Ingredients <- DANU_Ingredients %>% select(molecule, drug_group)
  
  data.frame(DIA_Box_Histories %>% left_join(DANU_Ingredients) %>% select(patient, weight, Box_m60, drug_group) %>% distinct() %>%
               group_by(Box_m60, drug_group) %>% summarise(n=sum(as.numeric(weight))))
  
  
# -------
# SGLT2 & GLP1 Oral Status -----------------------------------------
  DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
  DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
  
  DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
  Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
  DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
  
  DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
  DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
  DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
  
  string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
  string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
  
  DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(SGLT2_GLP1_Status = ifelse(str_detect(Drugs,string_SGLT2) & str_detect(Drugs,string_OralGLP1),"SGLT2_&_GLP1",
                                                                                 ifelse(str_detect(Drugs,string_SGLT2), "SGLT2",
                                                                                        ifelse(str_detect(Drugs,string_OralGLP1), "GLP1", "None"))))
  
  SGLT2_GLP1Oral_Status <- DIA_Drug_Histories
  
  data.frame(DIA_Drug_Histories %>% group_by(patient) %>% 
               filter(SGLT2_GLP1_Status == "SGLT2_&_GLP1" & lag(SGLT2_GLP1_Status) == "None") %>% select(patient) %>% distinct())
  
  
  
  data.frame(DIA_Drug_Histories %>% group_by(patient) %>% 
               filter(SGLT2_GLP1_Status != "SGLT2" & SGLT2_GLP1_Status != "None" ) %>% select(patient) %>% count() %>% arrange(-n))
  
  
# ---------
# How many flows last year? ------------
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- DIA_Flows_Aux._Long %>% filter(p1 >=48)
DIA_Flows_Aux._Long     <- DIA_Flows_Aux._Long %>% filter(stops !=1)

DIA_Flows_Aux._Long %>% select(patient, weight, flow) %>% inner_join(Treatment_exp_Vector) %>% group_by(patient) %>%
  mutate(total_flows = sum(flow)) %>% select(patient, weight, total_flows) %>% distinct() %>%
  ungroup() %>% group_by(total_flows) %>% summarise(n = sum (weight))


DIA_Flows_Aux._Long %>% select(patient, weight, flow) %>% inner_join(Treatment_exp_Vector) %>% group_by(patient) %>%
  mutate(total_flows = sum(flow)) %>% select(patient, weight, total_flows) %>% distinct() %>%
  ungroup() %>% summarise(n = weighted.mean(total_flows, weight)) # 0.977


DIA_Flows_Aux._Long %>% select(patient, weight, flow) %>% inner_join(Treatment_exp_Vector) %>% group_by(patient) %>%
  mutate(total_flows = sum(flow)) %>% select(patient, weight, total_flows) %>% distinct() %>%
  ungroup() %>% summarise(n = weighted.median(total_flows, weight)) # 0


DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(month60 = str_sub(month60, 2L, 2L)) %>% select(patient, month60)

data.frame(DIA_Flows_Aux._Long %>% select(patient, weight, flow) %>%  inner_join(Treatment_exp_Vector) %>% group_by(patient) %>%
  mutate(total_flows = sum(flow)) %>% select(patient, weight, total_flows) %>% distinct() %>%
  ungroup() %>% left_join(DIA_Box_Histories) %>% group_by(month60, total_flows) %>% summarise(n = sum (weight)) %>%
    spread(key = month60, value = n))



DIA_Flows_Aux._Long %>% select(patient, weight, flow) %>%  inner_join(Treatment_exp_Vector) %>% group_by(patient) %>%
  mutate(total_flows = sum(flow)) %>% select(patient, weight, total_flows) %>% distinct() %>%
  ungroup() %>% left_join(DIA_Box_Histories) %>% group_by(month60) %>% summarise(n = weighted.mean(total_flows, weight)) 



DIA_Flows_Aux._Long %>% select(patient, weight, flow) %>%  inner_join(Treatment_exp_Vector) %>% group_by(patient) %>%
  mutate(total_flows = sum(flow)) %>% select(patient, weight, total_flows) %>% distinct() %>%
  ungroup() %>% left_join(DIA_Box_Histories) %>% group_by(month60) %>% summarise(n = weighted.median(total_flows, weight))


# --------
# For how long have they been lapsed? -----------
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories     <- DIA_Box_Histories %>% mutate(month60 = str_sub(month60, 2L, 2L)) %>% select(patient, month60)
names(DIA_Box_Histories)[2] <- "Stock_m60"

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Box_Histories      <- DIA_Box_Histories %>% left_join(DIA_Drug_Histories) %>% inner_join(Treatment_exp_Vector)
DIA_Box_Histories      <- DIA_Box_Histories %>% filter(Stock_m60 == "x") 

DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Treat = ifelse(Treat=="-", 0, 1))
DIA_Box_Histories$Month <- as.character(DIA_Box_Histories$Month)
DIA_Box_Histories$Month <- parse_number(DIA_Box_Histories$Month)

DIA_Box_Histories <- DIA_Box_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})
DIA_Box_Histories <- DIA_Box_Histories %>% group_by(patient) %>% arrange(patient)
DIA_Box_Histories <- DIA_Box_Histories %>% group_by(patient) %>%  filter(grp == max(grp))

DIA_Box_Histories %>% group_by(patient, weight) %>% count() %>% ungroup() %>%
  mutate(Total_lapsed_bucket = ifelse(n == 1, "1", 
                                      ifelse(n >1 & n < 6, "2 to 6",
                                             ifelse(n>=6 & n <12, "6 to 12",
                                                    ifelse(n>=12&n<24, "12 to 24",
                                                           ifelse(n>=24&n<36, "24 to 36",
                                                                  ifelse(n>=36&n<48, "36 to 48",
                                                                         ifelse(n>=48&n<60, "48 to 60", "60")))))))) %>%
  group_by(Total_lapsed_bucket) %>%
  summarise(pats = sum(as.numeric(weight)))



Lapsed_summary <- DIA_Box_Histories %>% group_by(patient, weight) %>% count() %>% ungroup()

library(spatstat)
weighted.mean(Lapsed_summary$n, as.numeric(Lapsed_summary$weight))  #21.10056
weighted.median(Lapsed_summary$n, as.numeric(Lapsed_summary$weight))  #15.5


# Check for lapsed periods followed by return to therapy vs no return
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories     <- DIA_Drug_Histories %>% inner_join(Treatment_exp_Vector)

DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories       <- DIA_Drug_Histories %>% mutate(Treat = ifelse(Treat=="-", 0, 1))
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient)

# All lapsed periods, exclusing the first counting from month1 (i.e. truncated)
temp <- DIA_Drug_Histories %>% group_by(patient) %>% filter(Treat == 0 & grp != min(grp))

# how many months in each of these lapsed periods
temp2 <- temp %>% group_by(patient, weight, grp) %>% count() %>% distinct()

# Not followed by return to therapy
data.frame(temp2 %>% group_by(patient) %>% filter(grp == max(grp)) %>% group_by(n) %>% summarise(pats = sum(weight)))

#  followed by return to therapy
data.frame(temp2 %>% group_by(patient) %>% filter(grp != max(grp)) %>% group_by(n) %>% summarise(pats = sum(weight)))


# ------

# Subdivide intraflows by type of accompaining flows ------------------------------------------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))


string_Biguanide <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_GLP1Oral <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_GLP1Injectable <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")


DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
data <- DIA_Flows_Aux._Long[flow == 1 & s1 == s2,.(patient,weight,p1,p2,d1,d2,s1,s2,flow)]




# Biguanide Therapy class - flags
data <- data[, Biguanide_d1 := unlist(lapply(d1, function(x) ifelse(str_detect(x, string_Biguanide), str_c(unlist(str_extract_all(x, string_Biguanide)), collapse = ","),"")))]
data <- data[, Biguanide_d2 := unlist(lapply(d2, function(x) ifelse(str_detect(x, string_Biguanide), str_c(unlist(str_extract_all(x, string_Biguanide)), collapse = ","),"")))]
data <- data[, nr_Biguanide_d1 := unlist(lapply(d1, function(x) mapply(function (x) sum(str_detect(x, string_Biguanide)*1), str_split(x,","))))]
data <- data[, nr_Biguanide_d2 := unlist(lapply(d2, function(x) mapply(function (x) sum(str_detect(x, string_Biguanide)*1), str_split(x,","))))]
data <- data[, nr_BiguanideUnq_d1d2 := .(apply(.SD, 1, function(x) sum((unique(unlist(str_split(str_c(x,","),","))) != "")*1))), ,.SDcols = c("Biguanide_d1","Biguanide_d2")] 
data <- data[, Biguanide_flow_type := ifelse(nr_Biguanide_d2 < nr_Biguanide_d1 & nr_BiguanideUnq_d1d2 > nr_Biguanide_d1, "D+S", 
                                         ifelse(nr_Biguanide_d2 > nr_Biguanide_d1 & nr_BiguanideUnq_d1d2 > nr_Biguanide_d2, "A+S",
                                                ifelse(nr_Biguanide_d2 < nr_Biguanide_d1, "D", 
                                                       ifelse(nr_Biguanide_d2 > nr_Biguanide_d1, "A", 
                                                              ifelse(nr_Biguanide_d2 == nr_Biguanide_d1 & Biguanide_d2 != Biguanide_d1, "S","-")))))] 


# Antidiabetic Therapy class - flags
data <- data[, Antidiabetic_d1 := unlist(lapply(d1, function(x) ifelse(str_detect(x, string_Antidiabetic), str_c(unlist(str_extract_all(x, string_Antidiabetic)), collapse = ","),"")))]
data <- data[, Antidiabetic_d2 := unlist(lapply(d2, function(x) ifelse(str_detect(x, string_Antidiabetic), str_c(unlist(str_extract_all(x, string_Antidiabetic)), collapse = ","),"")))]
data <- data[, nr_Antidiabetic_d1 := unlist(lapply(d1, function(x) mapply(function (x) sum(str_detect(x, string_Antidiabetic)*1), str_split(x,","))))]
data <- data[, nr_Antidiabetic_d2 := unlist(lapply(d2, function(x) mapply(function (x) sum(str_detect(x, string_Antidiabetic)*1), str_split(x,","))))]
data <- data[, nr_AntidiabeticUnq_d1d2 := .(apply(.SD, 1, function(x) sum((unique(unlist(str_split(str_c(x,","),","))) != "")*1))), ,.SDcols = c("Antidiabetic_d1","Antidiabetic_d2")] 
data <- data[, Antidiabetic_flow_type := ifelse(nr_Antidiabetic_d2 < nr_Antidiabetic_d1 & nr_AntidiabeticUnq_d1d2 > nr_Antidiabetic_d1, "D+S", 
                                             ifelse(nr_Antidiabetic_d2 > nr_Antidiabetic_d1 & nr_AntidiabeticUnq_d1d2 > nr_Antidiabetic_d2, "A+S",
                                                    ifelse(nr_Antidiabetic_d2 < nr_Antidiabetic_d1, "D", 
                                                           ifelse(nr_Antidiabetic_d2 > nr_Antidiabetic_d1, "A", 
                                                                  ifelse(nr_Antidiabetic_d2 == nr_Antidiabetic_d1 & Antidiabetic_d2 != Antidiabetic_d1, "S","-")))))] 


# DPP4 Therapy class - flags
data <- data[, DPP4_d1 := unlist(lapply(d1, function(x) ifelse(str_detect(x, string_DPP4), str_c(unlist(str_extract_all(x, string_DPP4)), collapse = ","),"")))]
data <- data[, DPP4_d2 := unlist(lapply(d2, function(x) ifelse(str_detect(x, string_DPP4), str_c(unlist(str_extract_all(x, string_DPP4)), collapse = ","),"")))]
data <- data[, nr_DPP4_d1 := unlist(lapply(d1, function(x) mapply(function (x) sum(str_detect(x, string_DPP4)*1), str_split(x,","))))]
data <- data[, nr_DPP4_d2 := unlist(lapply(d2, function(x) mapply(function (x) sum(str_detect(x, string_DPP4)*1), str_split(x,","))))]
data <- data[, nr_DPP4Unq_d1d2 := .(apply(.SD, 1, function(x) sum((unique(unlist(str_split(str_c(x,","),","))) != "")*1))), ,.SDcols = c("DPP4_d1","DPP4_d2")] 
data <- data[, DPP4_flow_type := ifelse(nr_DPP4_d2 < nr_DPP4_d1 & nr_DPP4Unq_d1d2 > nr_DPP4_d1, "D+S", 
                                              ifelse(nr_DPP4_d2 > nr_DPP4_d1 & nr_DPP4Unq_d1d2 > nr_DPP4_d2, "A+S",
                                                     ifelse(nr_DPP4_d2 < nr_DPP4_d1, "D", 
                                                            ifelse(nr_DPP4_d2 > nr_DPP4_d1, "A", 
                                                                   ifelse(nr_DPP4_d2 == nr_DPP4_d1 & DPP4_d2 != DPP4_d1, "S","-")))))] 


# SGLT2 Therapy class - flags
data <- data[, SGLT2_d1 := unlist(lapply(d1, function(x) ifelse(str_detect(x, string_SGLT2), str_c(unlist(str_extract_all(x, string_SGLT2)), collapse = ","),"")))]
data <- data[, SGLT2_d2 := unlist(lapply(d2, function(x) ifelse(str_detect(x, string_SGLT2), str_c(unlist(str_extract_all(x, string_SGLT2)), collapse = ","),"")))]
data <- data[, nr_SGLT2_d1 := unlist(lapply(d1, function(x) mapply(function (x) sum(str_detect(x, string_SGLT2)*1), str_split(x,","))))]
data <- data[, nr_SGLT2_d2 := unlist(lapply(d2, function(x) mapply(function (x) sum(str_detect(x, string_SGLT2)*1), str_split(x,","))))]
data <- data[, nr_SGLT2Unq_d1d2 := .(apply(.SD, 1, function(x) sum((unique(unlist(str_split(str_c(x,","),","))) != "")*1))), ,.SDcols = c("SGLT2_d1","SGLT2_d2")] 
data <- data[, SGLT2_flow_type := ifelse(nr_SGLT2_d2 < nr_SGLT2_d1 & nr_SGLT2Unq_d1d2 > nr_SGLT2_d1, "D+S", 
                                                ifelse(nr_SGLT2_d2 > nr_SGLT2_d1 & nr_SGLT2Unq_d1d2 > nr_SGLT2_d2, "A+S",
                                                       ifelse(nr_SGLT2_d2 < nr_SGLT2_d1, "D", 
                                                              ifelse(nr_SGLT2_d2 > nr_SGLT2_d1, "A", 
                                                                     ifelse(nr_SGLT2_d2 == nr_SGLT2_d1 & SGLT2_d2 != SGLT2_d1, "S","-")))))] 


# Insulin Therapy class - flags
data <- data[, Insulin_d1 := unlist(lapply(d1, function(x) ifelse(str_detect(x, string_Insulin), str_c(unlist(str_extract_all(x, string_Insulin)), collapse = ","),"")))]
data <- data[, Insulin_d2 := unlist(lapply(d2, function(x) ifelse(str_detect(x, string_Insulin), str_c(unlist(str_extract_all(x, string_Insulin)), collapse = ","),"")))]
data <- data[, nr_Insulin_d1 := unlist(lapply(d1, function(x) mapply(function (x) sum(str_detect(x, string_Insulin)*1), str_split(x,","))))]
data <- data[, nr_Insulin_d2 := unlist(lapply(d2, function(x) mapply(function (x) sum(str_detect(x, string_Insulin)*1), str_split(x,","))))]
data <- data[, nr_InsulinUnq_d1d2 := .(apply(.SD, 1, function(x) sum((unique(unlist(str_split(str_c(x,","),","))) != "")*1))), ,.SDcols = c("Insulin_d1","Insulin_d2")] 
data <- data[, Insulin_flow_type := ifelse(nr_Insulin_d2 < nr_Insulin_d1 & nr_InsulinUnq_d1d2 > nr_Insulin_d1, "D+S", 
                                              ifelse(nr_Insulin_d2 > nr_Insulin_d1 & nr_InsulinUnq_d1d2 > nr_Insulin_d2, "A+S",
                                                     ifelse(nr_Insulin_d2 < nr_Insulin_d1, "D", 
                                                            ifelse(nr_Insulin_d2 > nr_Insulin_d1, "A", 
                                                                   ifelse(nr_Insulin_d2 == nr_Insulin_d1 & Insulin_d2 != Insulin_d1, "S","-")))))] 


# GLP1Oral Therapy class - flags
data <- data[, GLP1Oral_d1 := unlist(lapply(d1, function(x) ifelse(str_detect(x, string_GLP1Oral), str_c(unlist(str_extract_all(x, string_GLP1Oral)), collapse = ","),"")))]
data <- data[, GLP1Oral_d2 := unlist(lapply(d2, function(x) ifelse(str_detect(x, string_GLP1Oral), str_c(unlist(str_extract_all(x, string_GLP1Oral)), collapse = ","),"")))]
data <- data[, nr_GLP1Oral_d1 := unlist(lapply(d1, function(x) mapply(function (x) sum(str_detect(x, string_GLP1Oral)*1), str_split(x,","))))]
data <- data[, nr_GLP1Oral_d2 := unlist(lapply(d2, function(x) mapply(function (x) sum(str_detect(x, string_GLP1Oral)*1), str_split(x,","))))]
data <- data[, nr_GLP1OralUnq_d1d2 := .(apply(.SD, 1, function(x) sum((unique(unlist(str_split(str_c(x,","),","))) != "")*1))), ,.SDcols = c("GLP1Oral_d1","GLP1Oral_d2")] 
data <- data[, GLP1Oral_flow_type := ifelse(nr_GLP1Oral_d2 < nr_GLP1Oral_d1 & nr_GLP1OralUnq_d1d2 > nr_GLP1Oral_d1, "D+S", 
                                           ifelse(nr_GLP1Oral_d2 > nr_GLP1Oral_d1 & nr_GLP1OralUnq_d1d2 > nr_GLP1Oral_d2, "A+S",
                                                  ifelse(nr_GLP1Oral_d2 < nr_GLP1Oral_d1, "D", 
                                                         ifelse(nr_GLP1Oral_d2 > nr_GLP1Oral_d1, "A", 
                                                                ifelse(nr_GLP1Oral_d2 == nr_GLP1Oral_d1 & GLP1Oral_d2 != GLP1Oral_d1, "S","-")))))] 


# GLP1Injectable Therapy class - flags
data <- data[, GLP1Injectable_d1 := unlist(lapply(d1, function(x) ifelse(str_detect(x, string_GLP1Injectable), str_c(unlist(str_extract_all(x, string_GLP1Injectable)), collapse = ","),"")))]
data <- data[, GLP1Injectable_d2 := unlist(lapply(d2, function(x) ifelse(str_detect(x, string_GLP1Injectable), str_c(unlist(str_extract_all(x, string_GLP1Injectable)), collapse = ","),"")))]
data <- data[, nr_GLP1Injectable_d1 := unlist(lapply(d1, function(x) mapply(function (x) sum(str_detect(x, string_GLP1Injectable)*1), str_split(x,","))))]
data <- data[, nr_GLP1Injectable_d2 := unlist(lapply(d2, function(x) mapply(function (x) sum(str_detect(x, string_GLP1Injectable)*1), str_split(x,","))))]
data <- data[, nr_GLP1InjectableUnq_d1d2 := .(apply(.SD, 1, function(x) sum((unique(unlist(str_split(str_c(x,","),","))) != "")*1))), ,.SDcols = c("GLP1Injectable_d1","GLP1Injectable_d2")] 
data <- data[, GLP1Injectable_flow_type := ifelse(nr_GLP1Injectable_d2 < nr_GLP1Injectable_d1 & nr_GLP1InjectableUnq_d1d2 > nr_GLP1Injectable_d1, "D+S", 
                                            ifelse(nr_GLP1Injectable_d2 > nr_GLP1Injectable_d1 & nr_GLP1InjectableUnq_d1d2 > nr_GLP1Injectable_d2, "A+S",
                                                   ifelse(nr_GLP1Injectable_d2 < nr_GLP1Injectable_d1, "D", 
                                                          ifelse(nr_GLP1Injectable_d2 > nr_GLP1Injectable_d1, "A", 
                                                                 ifelse(nr_GLP1Injectable_d2 == nr_GLP1Injectable_d1 & GLP1Injectable_d2 != GLP1Injectable_d1, "S","-")))))] 

# 
# data <- data %>% filter(p1>=48)
# 
# sum(data$weight)
# 
# data %>% filter( (s1=="I"& (grepl("A",Insulin_flow_type)|grepl("S",Insulin_flow_type)|grepl("D",Insulin_flow_type)))|
#                     (s1=="d"& (grepl("A",Antidiabetic_flow_type)|grepl("S",Antidiabetic_flow_type)|grepl("D",Antidiabetic_flow_type)))|
#                     (s1=="D"& (grepl("A",DPP4_flow_type)|grepl("S",DPP4_flow_type)|grepl("D",DPP4_flow_type)))|
#                     (s1=="S"& (grepl("A",SGLT2_flow_type)|grepl("S",SGLT2_flow_type)|grepl("D",SGLT2_flow_type)))|
#                     (s1=="g"& (grepl("A",GLP1Oral_flow_type)|grepl("S",GLP1Oral_flow_type)|grepl("D",GLP1Oral_flow_type)))|
#                     (s1=="G"& (grepl("A",GLP1Injectable_flow_type)|grepl("S",GLP1Injectable_flow_type)|grepl("D",GLP1Injectable_flow_type)))) %>% summarise(n=sum(weight))
# 


data %>% filter(p1>=48) %>% filter(s2=="I") %>% group_by(Biguanide_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="I") %>% group_by(Antidiabetic_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="I") %>% group_by(DPP4_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="I") %>% group_by(SGLT2_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="I") %>% group_by(Insulin_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="I") %>% group_by(GLP1Oral_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="I") %>% group_by(GLP1Injectable_flow_type) %>% summarise(n=sum(as.numeric(weight)))



data %>% filter(p1>=48) %>% filter(s2=="G") %>% group_by(Biguanide_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="G") %>% group_by(Antidiabetic_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="G") %>% group_by(DPP4_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="G") %>% group_by(SGLT2_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="G") %>% group_by(Insulin_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="G") %>% group_by(GLP1Oral_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="G") %>% group_by(GLP1Injectable_flow_type) %>% summarise(n=sum(as.numeric(weight)))




data %>% filter(p1>=48) %>% filter(s2=="g") %>% group_by(Biguanide_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="g") %>% group_by(Antidiabetic_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="g") %>% group_by(DPP4_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="g") %>% group_by(SGLT2_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="g") %>% group_by(Insulin_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="g") %>% group_by(GLP1Oral_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="g") %>% group_by(GLP1Injectable_flow_type) %>% summarise(n=sum(as.numeric(weight)))




data %>% filter(p1>=48) %>% filter(s2=="S") %>% group_by(Biguanide_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="S") %>% group_by(Antidiabetic_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="S") %>% group_by(DPP4_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="S") %>% group_by(SGLT2_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="S") %>% group_by(Insulin_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="S") %>% group_by(GLP1Oral_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="S") %>% group_by(GLP1Injectable_flow_type) %>% summarise(n=sum(as.numeric(weight)))




data %>% filter(p1>=48) %>% filter(s2=="D") %>% group_by(Biguanide_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="D") %>% group_by(Antidiabetic_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="D") %>% group_by(DPP4_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="D") %>% group_by(SGLT2_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="D") %>% group_by(Insulin_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="D") %>% group_by(GLP1Oral_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="D") %>% group_by(GLP1Injectable_flow_type) %>% summarise(n=sum(as.numeric(weight)))



data %>% filter(p1>=48) %>% filter(s2=="d") %>% group_by(Biguanide_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="d") %>% group_by(Antidiabetic_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="d") %>% group_by(DPP4_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="d") %>% group_by(SGLT2_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="d") %>% group_by(Insulin_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="d") %>% group_by(GLP1Oral_flow_type) %>% summarise(n=sum(as.numeric(weight)))
data %>% filter(p1>=48) %>% filter(s2=="d") %>% group_by(GLP1Injectable_flow_type) %>% summarise(n=sum(as.numeric(weight)))


# ---------

# Evolution of scripts over time --------------------------------------------
DIA_Doses_BIG <- read.table("DIA Doses.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)

DIA_Doses_BIG <- DIA_Doses_BIG %>% filter(status != "G")

DIA_Doses_BIG <- DIA_Doses_BIG %>% select(drug_id, generic_name, drug_group, pat_id, weight, from_dt)

setDT(DIA_Doses_BIG)[, Month_Yr := format(as.Date(from_dt), "%Y-%m") ]

min(DIA_Doses_BIG$from_dt) #"2015-10-01"
max(DIA_Doses_BIG$from_dt) #"2021-06-30"

DIA_Doses_BIG <- DIA_Doses_BIG %>% filter(from_dt >= "2016-05-01") %>% filter(from_dt <= "2021-04-30")

length(unique(DIA_Doses_BIG$Month_Yr)) # 60

length(unique(DIA_Doses_BIG$pat_id)) #221055


DIA_Doses_BIG %>% group_by(Month_Yr) %>% summarise(n=sum(as.numeric(weight))) %>%
  ggplot(aes(x=Month_Yr, y=n))+
  geom_col(show.legend = F, fill="deepskyblue4", alpha=.6)+
  theme(axis.text.x = element_text(angle = 45),
        legend.position = "none",
        panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank())+
  xlab("\nMonth")+ylab("Number of Scripts \n")


DIA_Doses_BIG %>% select(pat_id, weight, Month_Yr) %>% distinct() %>% group_by(Month_Yr) %>% summarise(n=sum(as.numeric(weight))) %>%
  ggplot(aes(x=Month_Yr, y=n))+
  geom_col(show.legend = F, fill="deepskyblue4", alpha=.6)+
  theme(axis.text.x = element_text(angle = 45),
        legend.position = "none",
        panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank())+
  xlab("\nMonth")+ylab("Number of Patients \n")


data.frame(DIA_Doses_BIG %>% select(pat_id,weight, Month_Yr) %>% group_by(Month_Yr) %>% mutate(script_count = sum(as.numeric(weight))) %>% ungroup() %>%
             select(pat_id, weight, Month_Yr, script_count) %>% distinct() %>% group_by(Month_Yr) %>% mutate(pat_count = sum(as.numeric(weight))) %>% 
             select(Month_Yr,script_count, pat_count) %>% distinct() %>% arrange(Month_Yr) %>% mutate(scripts_pat = script_count/pat_count))%>%
  ggplot(aes(x=Month_Yr, y=scripts_pat))+
  geom_col(show.legend = F, fill="deepskyblue4", alpha=.6)+
  theme(axis.text.x = element_text(angle = 45),
        legend.position = "none",
        panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank())+
  xlab("\nMonth")+ylab("Number of Scripts per Patient \n")

# ------

# HbA1c distribution -------------------
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]

DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)

# Total rows = 283,820
# n <= 25    = 283,488

plot1 <- DANU_Measures_HbA1c %>% group_by(patid) %>% count() %>% filter(n<=25) 

plot1 %>% filter(n==1) # 107,803    ~38% has only 1 read

plot1 %>%
  ggplot(aes(n))+
  geom_histogram(bins=25, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of HbA1c Reads")


Last_read <- DANU_Measures_HbA1c %>% group_by(patid) %>% slice(n())

# last read = 283829

Last_read %>% filter(value>=5 & value<=6) # #176275

# 62% (5 to 6)

Last_read %>% group_by(value) %>%
  ggplot(aes(value))+
  geom_histogram(bins=50, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(4,10)+
  ylab("Number of Patients\n")+
  xlab("\nLast HbA1c read (%)")


DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Box, month1:month60, factor_key=TRUE)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Box = str_sub(Box, 2L, 2L))
DIA_Box_Histories$Month <- as.character(DIA_Box_Histories$Month)
DIA_Box_Histories$Month <- parse_number(DIA_Box_Histories$Month)

Last_read <- Last_read %>% left_join(DIA_Box_Histories %>% select(patient, Month, Box), 
                        by = c("patid"="patient", "Exact_Month"="Month")) %>% filter(!is.na(Box))


Last_read %>% select(patid, weight, claimed, value, Exact_Month, Box) %>% distinct() %>% group_by(patid) %>% slice(n())

length(unique(Last_read$patid)) #129502

Last_read %>% group_by(Box) %>% summarise(n=sum(as.numeric(weight)))




Last_read %>% group_by(Box) %>% summarise(n=weighted.mean(as.numeric(value), as.numeric(weight))) %>% arrange(-n)


Last_read %>% group_by(Box) %>% summarise(n=weighted.median(as.numeric(value), as.numeric(weight))) %>% arrange(-n)


Last_read %>% ungroup() %>% select(Box, value) %>% 
  mutate(Box = factor(Box, levels=c("x", "b", "d", "D", "G", "S", "g", "I"))) %>% group_by(Box) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = Box, colour=Box), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~Box, ncol = 8)+
  scale_fill_viridis_d()+
  scale_colour_viridis_d()+
  coord_flip()+
  xlim(4,12)+
  xlab("HbA1c (%)\n")+ ylab("\nProportion of patients")

SGLT2_GLP1Oral_Status <- SGLT2_GLP1Oral_Status %>% left_join(DANU_Measures_HbA1c %>% select(patid, value, Exact_Month), 
                                    by= c("patient"="patid","Month"="Exact_Month"))

Pats_2PlusReads <- SGLT2_GLP1Oral_Status %>% select(patient, value) %>% filter(!is.na(value)) %>% 
  group_by(patient) %>% count() %>% filter(n>1) %>% select(patient)

SGLT2_GLP1Oral_Status <- Pats_2PlusReads %>% left_join(SGLT2_GLP1Oral_Status)

temp_df <- data.frame(SGLT2_GLP1Oral_Status %>% group_by(patient) %>% 
                        filter( (SGLT2_GLP1_Status!="None" & lag(SGLT2_GLP1_Status)=="None" & !is.na(value) & !is.na(lag(value))) |
                                  (SGLT2_GLP1_Status=="None" & lead(SGLT2_GLP1_Status)!="None" & !is.na(value) & !is.na(lead(value))) ) %>%
                        group_by(patient) %>% arrange(patient))
  
  
data.frame(SGLT2_GLP1Oral_Status %>% group_by(patient) %>% 
  filter( (SGLT2_GLP1_Status!="None" & lag(SGLT2_GLP1_Status)=="None" & !is.na(value) & !is.na(lag(value))) |
            (SGLT2_GLP1_Status=="None" & lead(SGLT2_GLP1_Status)!="None" & !is.na(value) & !is.na(lead(value))) ) %>%
  group_by(patient) %>% arrange(patient)) %>%
  ungroup() %>% group_by(SGLT2_GLP1_Status) %>% summarise(n=weighted.mean(value, weight))


data.frame(SGLT2_GLP1Oral_Status %>% group_by(patient) %>% 
             filter( (SGLT2_GLP1_Status!="None" & lag(SGLT2_GLP1_Status)=="None" & !is.na(value) & !is.na(lag(value))) |
                       (SGLT2_GLP1_Status=="None" & lead(SGLT2_GLP1_Status)!="None" & !is.na(value) & !is.na(lead(value))) ) %>%
             group_by(patient) %>% arrange(patient)) %>%
  ungroup() %>% group_by(SGLT2_GLP1_Status) %>% summarise(n=weighted.median(value, weight))


SGLT2_GLP1Oral_Status %>% ungroup() %>% filter(!is.na(value)) %>% group_by(patient, SGLT2_GLP1_Status) %>% 
             summarise(mean_value=weighted.mean(value, weight, na.rm = T)) %>% arrange(patient) %>% ungroup() %>%
  group_by(patient) %>% spread(key = SGLT2_GLP1_Status, value = mean_value) %>% 
  filter(!is.na(`SGLT2_&_GLP1`) & !is.na(GLP1) & !is.na(SGLT2) & !is.na(None)) %>% ungroup() %>%
  summarise(mean = mean(GLP1)) # 7.86
  
SGLT2_GLP1Oral_Status %>% ungroup() %>% filter(!is.na(value)) %>% group_by(patient, SGLT2_GLP1_Status) %>% 
  summarise(mean_value=weighted.mean(value, weight, na.rm = T)) %>% arrange(patient) %>% ungroup() %>%
  group_by(patient) %>% spread(key = SGLT2_GLP1_Status, value = mean_value) %>% 
  filter(!is.na(`SGLT2_&_GLP1`) & !is.na(GLP1) & !is.na(SGLT2) & !is.na(None)) %>% ungroup() %>%
  summarise(mean = mean(SGLT2)) # 8.65

SGLT2_GLP1Oral_Status %>% ungroup() %>% filter(!is.na(value)) %>% group_by(patient, SGLT2_GLP1_Status) %>% 
  summarise(mean_value=weighted.mean(value, weight, na.rm = T)) %>% arrange(patient) %>% ungroup() %>%
  group_by(patient) %>% spread(key = SGLT2_GLP1_Status, value = mean_value) %>% 
  filter(!is.na(`SGLT2_&_GLP1`) & !is.na(GLP1) & !is.na(SGLT2) & !is.na(None)) %>% ungroup() %>%
  summarise(mean = mean(`SGLT2_&_GLP1`)) # 7.95


SGLT2_GLP1Oral_Status %>% ungroup() %>% filter(!is.na(value)) %>% group_by(patient, SGLT2_GLP1_Status) %>% 
  summarise(mean_value=weighted.mean(value, weight, na.rm = T)) %>% arrange(patient) %>% ungroup() %>%
  group_by(patient) %>% spread(key = SGLT2_GLP1_Status, value = mean_value) %>% 
  filter(!is.na(`SGLT2_&_GLP1`) & !is.na(GLP1) & !is.na(SGLT2) & !is.na(None)) %>% ungroup() %>%
  summarise(mean = mean(None)) # 8.59


           
# --------
# HbA1c distribution all records (with vague) -------------------
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]

DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))

# Total rows = 289333
# n <= 25    = 283714

plot1 <- DANU_Measures_HbA1c %>% group_by(patid) %>% count() %>% filter(n<=25) 

plot1 %>% filter(n==1) # 97,779    ~34% has only 1 read

plot1 %>%
  ggplot(aes(n))+
  geom_histogram(bins=25, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of HbA1c Reads")


Last_read <- DANU_Measures_HbA1c %>% group_by(patid) %>% slice(n())

# last read = 289343

Last_read %>% filter(value>=5 & value<=6) # #176036

# 61% (5 to 6)

Last_read %>% group_by(value) %>%
  ggplot(aes(value))+
  geom_histogram(bins=50, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(4,10)+
  ylab("Number of Patients\n")+
  xlab("\nLast HbA1c read (%)")


DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Box, month1:month60, factor_key=TRUE)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Box = str_sub(Box, 2L, 2L))
DIA_Box_Histories$Month <- as.character(DIA_Box_Histories$Month)
DIA_Box_Histories$Month <- parse_number(DIA_Box_Histories$Month)

Last_read <- Last_read %>% left_join(DIA_Box_Histories %>% select(patient, Month, Box), 
                                     by = c("patid"="patient", "Exact_Month"="Month")) %>% filter(!is.na(Box))


Last_read %>% select(patid, weight, claimed, value, Exact_Month, Box) %>% distinct() %>% group_by(patid) %>% slice(n())

length(unique(Last_read$patid)) #132746

Last_read %>% group_by(Box) %>% summarise(n=sum(as.numeric(weight)))


Last_read %>% group_by(Box) %>% summarise(n=weighted.mean(as.numeric(value), as.numeric(weight))) %>% arrange(-n)


Last_read %>% group_by(Box) %>% summarise(n=weighted.median(as.numeric(value), as.numeric(weight))) %>% arrange(-n)


Last_read %>% ungroup() %>% select(Box, value) %>% 
  mutate(Box = factor(Box, levels=c("x", "b", "d", "D", "G", "S", "g", "I"))) %>% group_by(Box) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = Box, colour=Box), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~Box, ncol = 8)+
  scale_fill_viridis_d()+
  scale_colour_viridis_d()+
  coord_flip()+
  xlim(4,12)+
  xlab("HbA1c (%)\n")+ ylab("\nProportion of patients")

# ----
# HbA1c ON vs OFF  Drugs   (GLP1 Oral, SGLT2, Combo) -----------------
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)

GLP1_Histories     <- DIA_Drug_Histories %>% mutate(GLP1OralStatus = ifelse(grepl("47", Treat), "Yes", "No"))

GLP1_Histories$Month <- as.character(GLP1_Histories$Month)
GLP1_Histories$Month <- parse_number(GLP1_Histories$Month)

GLP1Oral_Pats <- GLP1_Histories %>% filter(GLP1OralStatus == "Yes") %>% select(patient) %>% distinct() #2050

GLP1_Histories <- GLP1Oral_Pats %>% left_join(GLP1_Histories)

GLP1_Histories <- GLP1_Histories %>% left_join(DANU_Measures_HbA1c %>% select(patid, value, Exact_Month), by = c("patient"="patid", "Month"="Exact_Month"))

GLP1Minus25 <- GLP1_Histories %>% select(patient, value) %>% filter(!is.na(value)) %>% group_by(patient) %>% count() %>% arrange(-n) %>% filter(n<25) %>% select(patient)

GLP1Minus25 %>% left_join(GLP1_Histories) %>% ungroup() %>% group_by(GLP1OralStatus) %>% summarise(n = mean(value, na.rm = T))



Pats_Both_States <- GLP1Minus25 %>% left_join(GLP1_Histories) %>% ungroup() %>% filter(!is.na(value)) %>% group_by(patient, GLP1OralStatus) %>% count() %>% ungroup() %>% filter(n!=0)  %>% group_by(patient) %>% count() %>% filter(n==2) %>% select(patient)

Pats_Both_States %>% left_join(GLP1_Histories) %>% ungroup() %>% group_by(GLP1OralStatus) %>% summarise(n = weighted.median(value, weight, na.rm = T))






DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)

SGLT2_Histories     <- DIA_Drug_Histories %>% mutate(SGLT2Status = ifelse(grepl("34", Treat)|grepl("35", Treat)|grepl("36", Treat)|grepl("37", Treat), "Yes", "No"))

SGLT2_Histories$Month <- as.character(SGLT2_Histories$Month)
SGLT2_Histories$Month <- parse_number(SGLT2_Histories$Month)

SGLT2_Pats <- SGLT2_Histories %>% filter(SGLT2Status == "Yes") %>% select(patient) %>% distinct() #35853

SGLT2_Histories <- SGLT2_Pats %>% left_join(SGLT2_Histories)

SGLT2_Histories <- SGLT2_Histories %>% left_join(DANU_Measures_HbA1c %>% select(patid, value, Exact_Month), by = c("patient"="patid", "Month"="Exact_Month"))

SGLT2Minus25 <- SGLT2_Histories %>% select(patient, value) %>% filter(!is.na(value)) %>% group_by(patient) %>% count() %>% arrange(-n) %>% filter(n<25) %>% select(patient)

SGLT2Minus25 %>% left_join(SGLT2_Histories) %>% ungroup() %>% group_by(SGLT2Status) %>% summarise(n = mean(value, na.rm = T))

Pats_Both_States <- SGLT2Minus25 %>% left_join(SGLT2_Histories) %>% ungroup() %>% filter(!is.na(value)) %>% group_by(patient, SGLT2Status) %>% count() %>% ungroup() %>% filter(n!=0) %>% group_by(patient) %>% count() %>% filter(n==2) %>% select(patient)

Pats_Both_States %>% left_join(SGLT2_Histories) %>% ungroup() %>% group_by(SGLT2Status) %>% summarise(n = weighted.median(value, weight, na.rm = T))

# SGLT2_Histories %>% filter(patient == "PT335980266") %>% select(Month, value) %>%
#   ggplot(aes(Month, value))+
#   geom_point(size=2, alpha=0.4, color="firebrick")+
#   theme(legend.position = "none",
#         panel.background = element_blank(),
#         panel.grid = element_blank(),
#         axis.ticks = element_blank())+
#   xlab("\n Month")+ylab("HbA1c (%) \n")



DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)

Combo_Histories     <- DIA_Drug_Histories %>% mutate(ComboStatus = ifelse((grepl("34", Treat)|grepl("35", Treat)|grepl("36", Treat)|grepl("37", Treat))&(grepl("47", Treat)), "Yes", "No"))

Combo_Histories$Month <- as.character(Combo_Histories$Month)
Combo_Histories$Month <- parse_number(Combo_Histories$Month)

Combo_Pats <- Combo_Histories %>% filter(ComboStatus == "Yes") %>% select(patient) %>% distinct() #538

Combo_Histories <- Combo_Pats %>% left_join(Combo_Histories)

Combo_Histories <- Combo_Histories %>% left_join(DANU_Measures_HbA1c %>% select(patid, value, Exact_Month), by = c("patient"="patid", "Month"="Exact_Month"))

ComboMinus25 <- Combo_Histories %>% select(patient, value) %>% filter(!is.na(value)) %>% group_by(patient) %>% count() %>% arrange(-n) %>% filter(n<25) %>% select(patient)

ComboMinus25 %>% left_join(Combo_Histories) %>% ungroup() %>% group_by(ComboStatus) %>% summarise(n = mean(value, na.rm = T))

Pats_Both_States <- ComboMinus25 %>% left_join(Combo_Histories) %>% ungroup() %>% filter(!is.na(value)) %>% group_by(patient, ComboStatus) %>% count() %>% ungroup() %>% filter(n!=0) %>% group_by(patient) %>% count() %>% filter(n==2) %>% select(patient)

Pats_Both_States %>% left_join(Combo_Histories) %>% ungroup() %>% group_by(ComboStatus) %>% summarise(n = weighted.median(value, weight, na.rm = T))


# -------
# Number patients per physician ----------
Dia_US_Doses <- fread("DIA Doses.txt")

temp_1 <- Dia_US_Doses %>% select(prov, pat_id) %>% group_by(prov, pat_id) %>% distinct() %>% ungroup() %>%
  group_by(prov) %>% count() %>% ungroup() %>% filter(prov != "" & prov != "0") %>%
  group_by(n) %>% count()

sum(temp_1$nn) # 238933

temp_1 %>% ggplot(aes(n, nn)) + 
  geom_col(fill="midnightblue")+
  xlim(0,25)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  geom_text(aes(label = paste0(round(nn/1000,0),"k")), vjust = -0.5)+
  xlab("\n Number of Patients per Physician")+ylab("Number of Physicians\n")

# ---------
# Scripts per Specialty -------------
Dia_US_Doses <- fread("DIA Doses.txt")
Dia_US_Doses <- Dia_US_Doses %>% filter(status != "G")
Dia_US_Doses <- Dia_US_Doses %>% select(-c(drug_id, weight, dayssup, taxonomy1, taxonomy2, status))
Dia_US_Doses <- Dia_US_Doses %>% mutate(from_dt = as.Date(from_dt))
Dia_US_Doses <- Dia_US_Doses %>%filter(from_dt >= "2016-05-01" & from_dt <= "2021-04-30") 


PROVCAT <- fread("PROVCAT.txt", sep="|")
PROVCAT$PROVCAT <- sub("^0+", "", PROVCAT$PROVCAT)  
PROVCAT <- PROVCAT %>% mutate(PROVCAT = ifelse(PROVCAT=="","0",PROVCAT))
PROVCAT$PROVCAT <- as.numeric(PROVCAT$PROVCAT)

Specialties_to_keep <- Dia_US_Doses %>% group_by(specialty) %>% summarise(n=n()) %>%
  left_join(PROVCAT, by=c("specialty"="PROVCAT"))

fwrite(Specialties_to_keep, "Specialties_to_keep.txt", sep="\t")

Specialties_to_keep <- fread("Specialties_to_keep.txt")

Dia_US_Doses %>% group_by(specialty) %>% summarise(n=n()) %>%
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) %>%
  ungroup() %>% group_by(PHYSICIAN) %>% summarise(n2=sum(n)) %>% arrange(-n2) %>% filter(PHYSICIAN != "FACILITY")



Dia_US_Doses %>% filter(drug_group == "GLP1 Oral") %>% group_by(specialty) %>% summarise(n=n()) %>%
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) %>%
  ungroup() %>% group_by(PHYSICIAN) %>% summarise(n2=sum(n)) %>% arrange(-n2) %>% filter(PHYSICIAN != "FACILITY")




Dia_US_Doses %>% filter(drug_group == "GLP1 Injectable") %>% group_by(specialty) %>% summarise(n=n()) %>%
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) %>%
  ungroup() %>% group_by(PHYSICIAN) %>% summarise(n2=sum(n)) %>% arrange(-n2) %>% filter(PHYSICIAN != "FACILITY")


Dia_US_Doses %>% filter(drug_group == "Insulin") %>% group_by(specialty) %>% summarise(n=n()) %>%
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) %>%
  ungroup() %>% group_by(PHYSICIAN) %>% summarise(n2=sum(n)) %>% arrange(-n2) %>% filter(PHYSICIAN != "FACILITY")



Dia_US_Doses %>% filter(drug_group == "SGLT2") %>% group_by(specialty) %>% summarise(n=n()) %>%
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) %>%
  ungroup() %>% group_by(PHYSICIAN) %>% summarise(n2=sum(n)) %>% arrange(-n2) %>% filter(PHYSICIAN != "FACILITY")

Dia_US_Doses %>% filter(drug_group == "DPP4") %>% group_by(specialty) %>% summarise(n=n()) %>%
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) %>%
  ungroup() %>% group_by(PHYSICIAN) %>% summarise(n2=sum(n)) %>% arrange(-n2) %>% filter(PHYSICIAN != "FACILITY")



Dia_US_Doses %>% filter(drug_group == "Antidiabetic") %>% group_by(specialty) %>% summarise(n=n()) %>%
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) %>%
  ungroup() %>% group_by(PHYSICIAN) %>% summarise(n2=sum(n)) %>% arrange(-n2) %>% filter(PHYSICIAN != "FACILITY")




Dia_US_Doses %>% filter(drug_group == "Biguanide") %>% group_by(specialty) %>% summarise(n=n()) %>%
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) %>%
  ungroup() %>% group_by(PHYSICIAN) %>% summarise(n2=sum(n)) %>% arrange(-n2) %>% filter(PHYSICIAN != "FACILITY")






Dia_US_Doses %>% filter(drug_group == "GLP1 Oral") %>% 
  arrange(pat_id, from_dt) %>% group_by(pat_id) %>% slice(1) %>% ungroup()%>%
  group_by(specialty) %>% summarise(n=n()) %>% 
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty"))%>%
  ungroup() %>% group_by(PHYSICIAN) %>% summarise(n2=sum(n)) %>% arrange(-n2) %>% filter(PHYSICIAN != "FACILITY")

                                                    

# -----
# HbA1c reductions -----------------------

# GLP1 Oral --------

# No GLP1 Oral first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  GLP1 Oral before month 12
Patients_GLP1Oral_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("47",d1)) %>% select(patient)

Patients_no_GLP1Oral_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_GLP1Oral_12) %>% select(patient) %>% distinct()

# filter for patient who did have an GLP1 Oral from 12 to 48
Patients_start_GLP1Oral_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("47",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_GLP1Oral_track <- Patients_no_GLP1Oral_12 %>% inner_join(Patients_start_GLP1Oral_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no GLP1 Oral too zero, and GLP1 Oral to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('47',.), ~replace(., grepl('47', .), "GLP1Oral"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1Oral",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on GLP1 Oral status
DIA_Drug_Histories <- Patients_GLP1Oral_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON GLP1 Oral
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to GLP1 Oral
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Oral
DIA_Drug_Histories_FIRST_GLP1Oral <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1Oral)[3] <- "Month_First_GLP1Oral"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Oral criteria
Patient_first_GLP1Oral<-  DIA_Drug_Histories_FIRST_GLP1Oral %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_GLP1Oral %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first GLP1 Oral month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_GLP1Oral, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_GLP1Oral <- as.numeric(DANU_Measures_HbA1c$Month_First_GLP1Oral)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before GLP1 Oral start and months after GLP1 Oral start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_GLP1Oral <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_GLP1Oral)
HbA1cs_before_GLP1Oral <- HbA1cs_before_GLP1Oral %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_GLP1Oral)[4] <- "Month_Prior"
names(HbA1cs_before_GLP1Oral)[3] <- "HbA1c_Prior"

HbA1cs_after_GLP1Oral <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_GLP1Oral)
HbA1cs_after_GLP1Oral <- HbA1cs_after_GLP1Oral %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_after_GLP1Oral)[4] <- "Month_After"
names(HbA1cs_after_GLP1Oral)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_GLP1Oral_BEFORE_vs_AFTER <- HbA1cs_before_GLP1Oral %>% full_join(HbA1cs_after_GLP1Oral)
HbA1cs_GLP1Oral_BEFORE_vs_AFTER <- HbA1cs_GLP1_BEFORE_vs_AFTER %>% na.omit()

write.csv(HbA1cs_GLP1Oral_BEFORE_vs_AFTER, "HbA1cs_GLP1Oral_BEFORE_vs_AFTER.csv")

# GLP1 Injectable  -----

# No GLP1 Injectable first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  GLP1 Injectable before month 12
Patients_GLP1Injectable_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|grepl("51",d1)|grepl("52",d1)|grepl("53",d1)) %>% select(patient)

Patients_no_GLP1Injectable_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_GLP1Injectable_12) %>% select(patient) %>% distinct()

# filter for patient who did have an GLP1 Injectable from 12 to 48
Patients_start_GLP1Injectable_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|grepl("51",d1)|grepl("52",d1)|grepl("53",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_GLP1Injectable_track <- Patients_no_GLP1Injectable_12 %>% inner_join(Patients_start_GLP1Injectable_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('48',.), ~replace(., grepl('48', .), "GLP1Injectable"))%>%
  mutate_if(grepl('49',.), ~replace(., grepl('49', .), "GLP1Injectable"))%>%
  mutate_if(grepl('50',.), ~replace(., grepl('50', .), "GLP1Injectable"))%>%
  mutate_if(grepl('51',.), ~replace(., grepl('51', .), "GLP1Injectable"))%>%
  mutate_if(grepl('52',.), ~replace(., grepl('52', .), "GLP1Injectable"))%>%
  mutate_if(grepl('53',.), ~replace(., grepl('53', .), "GLP1Injectable"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1Injectable",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on GLP1 Injectable status
DIA_Drug_Histories <- Patients_GLP1Injectable_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1Injectable <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1Injectable)[3] <- "Month_First_GLP1Injectable"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1Injectable<-  DIA_Drug_Histories_FIRST_GLP1Injectable %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_GLP1Injectable %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first GLP1 Injectable month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_GLP1Injectable, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_GLP1Injectable <- as.numeric(DANU_Measures_HbA1c$Month_First_GLP1Injectable)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_GLP1Injectable <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_GLP1Injectable)
HbA1cs_before_GLP1Injectable <- HbA1cs_before_GLP1Injectable %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_GLP1Injectable)[4] <- "Month_Prior"
names(HbA1cs_before_GLP1Injectable)[3] <- "HbA1c_Prior"

HbA1cs_after_GLP1Injectable <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_GLP1Injectable)
HbA1cs_after_GLP1Injectable <- HbA1cs_after_GLP1Injectable %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_after_GLP1Injectable)[4] <- "Month_After"
names(HbA1cs_after_GLP1Injectable)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- HbA1cs_before_GLP1Injectable %>% full_join(HbA1cs_after_GLP1Injectable)
HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- HbA1cs_GLP1Injectable_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER, "HbA1cs_GLP1Injectable_BEFORE_vs_AFTER.csv")

# SGLT2 --------

# No SGLT2 first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  SGLT2 before month 12
Patients_SGLT2_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("34",d1)|grepl("35",d1)|grepl("36",d1)|grepl("37",d1)) %>% select(patient)

Patients_no_SGLT2_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_SGLT2_12) %>% select(patient) %>% distinct()

# filter for patient who did have an SGLT2 from 12 to 48
Patients_start_SGLT2_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("34",d1)|grepl("35",d1)|grepl("36",d1)|grepl("37",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_SGLT2_track <- Patients_no_SGLT2_12 %>% inner_join(Patients_start_SGLT2_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no SGLT2 too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('34',.), ~replace(., grepl('34', .), "SGLT2"))%>%
  mutate_if(grepl('35',.), ~replace(., grepl('35', .), "SGLT2"))%>%
  mutate_if(grepl('36',.), ~replace(., grepl('36', .), "SGLT2"))%>%
  mutate_if(grepl('37',.), ~replace(., grepl('37', .), "SGLT2"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on SGLT2 status
DIA_Drug_Histories <- Patients_SGLT2_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_SGLT2 %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first SGLT2 month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_SGLT2 <- as.numeric(DANU_Measures_HbA1c$Month_First_SGLT2)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_SGLT2)
HbA1cs_before_SGLT2 <- HbA1cs_before_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_SGLT2)[4] <- "Month_Prior"
names(HbA1cs_before_SGLT2)[3] <- "HbA1c_Prior"

HbA1cs_after_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_SGLT2)
HbA1cs_after_SGLT2 <- HbA1cs_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_after_SGLT2)[4] <- "Month_After"
names(HbA1cs_after_SGLT2)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_before_SGLT2 %>% full_join(HbA1cs_after_SGLT2)
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_SGLT2_BEFORE_vs_AFTER, "HbA1cs_SGLT2_BEFORE_vs_AFTER.csv")
# DPP4 -------

# No DPP4 first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  DPP4 before month 12
Patients_DPP4_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("30",d1)|grepl("31",d1)|grepl("32",d1)|grepl("33",d1)) %>% select(patient)

Patients_no_DPP4_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_DPP4_12) %>% select(patient) %>% distinct()

# filter for patient who did have an DPP4 from 12 to 48
Patients_start_DPP4_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("30",d1)|grepl("31",d1)|grepl("32",d1)|grepl("33",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_DPP4_track <- Patients_no_DPP4_12 %>% inner_join(Patients_start_DPP4_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no DPP4 too zero, and DPP4 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('30',.), ~replace(., grepl('30', .), "DPP4"))%>%
  mutate_if(grepl('31',.), ~replace(., grepl('31', .), "DPP4"))%>%
  mutate_if(grepl('32',.), ~replace(., grepl('32', .), "DPP4"))%>%
  mutate_if(grepl('33',.), ~replace(., grepl('33', .), "DPP4"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="DPP4",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on DPP4 status
DIA_Drug_Histories <- Patients_DPP4_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON DPP4
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to DPP4
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took DPP4
DIA_Drug_Histories_FIRST_DPP4 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_DPP4)[3] <- "Month_First_DPP4"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the DPP4 criteria
Patient_first_DPP4<-  DIA_Drug_Histories_FIRST_DPP4 %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_DPP4 %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first DPP4 month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_DPP4, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_DPP4 <- as.numeric(DANU_Measures_HbA1c$Month_First_DPP4)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before DPP4 start and months after DPP4 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_DPP4 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_DPP4)
HbA1cs_before_DPP4 <- HbA1cs_before_DPP4 %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_DPP4)[4] <- "Month_Prior"
names(HbA1cs_before_DPP4)[3] <- "HbA1c_Prior"

HbA1cs_after_DPP4 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_DPP4)
HbA1cs_after_DPP4 <- HbA1cs_after_DPP4 %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_after_DPP4)[4] <- "Month_After"
names(HbA1cs_after_DPP4)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_DPP4_BEFORE_vs_AFTER <- HbA1cs_before_DPP4 %>% full_join(HbA1cs_after_DPP4)
HbA1cs_DPP4_BEFORE_vs_AFTER <- HbA1cs_DPP4_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_DPP4_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_DPP4_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_DPP4_BEFORE_vs_AFTER, "HbA1cs_DPP4_BEFORE_vs_AFTER.csv")
# Antidiabetic -------

# No Antidiabetic first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  Antidiabetic before month 12
Patients_Antidiabetic_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("14",d1)|grepl("15",d1)|grepl("16",d1)|grepl("17",d1)|grepl("18",d1)|grepl("19",d1)|grepl("20",d1)|grepl("21",d1)|grepl("22",d1)|grepl("23",d1)|grepl("24",d1)|grepl("25",d1)|grepl("26",d1)|grepl("27",d1)|grepl("28",d1)|grepl("29",d1)) %>% select(patient)

Patients_no_Antidiabetic_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_Antidiabetic_12) %>% select(patient) %>% distinct()

# filter for patient who did have an Antidiabetic from 12 to 48
Patients_start_Antidiabetic_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("14",d1)|grepl("15",d1)|grepl("16",d1)|grepl("17",d1)|grepl("18",d1)|grepl("19",d1)|grepl("20",d1)|grepl("21",d1)|grepl("22",d1)|grepl("23",d1)|grepl("24",d1)|grepl("25",d1)|grepl("26",d1)|grepl("27",d1)|grepl("28",d1)|grepl("29",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_Antidiabetic_track <- Patients_no_Antidiabetic_12 %>% inner_join(Patients_start_Antidiabetic_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no Antidiabetic too zero, and Antidiabetic to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('14',.), ~replace(., grepl('14', .), "Antidiabetic"))%>%
  mutate_if(grepl('15',.), ~replace(., grepl('15', .), "Antidiabetic"))%>%
  mutate_if(grepl('16',.), ~replace(., grepl('16', .), "Antidiabetic"))%>%
  mutate_if(grepl('17',.), ~replace(., grepl('17', .), "Antidiabetic"))%>%
  mutate_if(grepl('18',.), ~replace(., grepl('18', .), "Antidiabetic"))%>%
  mutate_if(grepl('19',.), ~replace(., grepl('19', .), "Antidiabetic"))%>%
  mutate_if(grepl('20',.), ~replace(., grepl('20', .), "Antidiabetic"))%>%
  mutate_if(grepl('21',.), ~replace(., grepl('21', .), "Antidiabetic"))%>%
  mutate_if(grepl('22',.), ~replace(., grepl('22', .), "Antidiabetic"))%>%
  mutate_if(grepl('23',.), ~replace(., grepl('23', .), "Antidiabetic"))%>%
  mutate_if(grepl('24',.), ~replace(., grepl('24', .), "Antidiabetic"))%>%
  mutate_if(grepl('25',.), ~replace(., grepl('25', .), "Antidiabetic"))%>%
  mutate_if(grepl('26',.), ~replace(., grepl('26', .), "Antidiabetic"))%>%
  mutate_if(grepl('27',.), ~replace(., grepl('27', .), "Antidiabetic"))%>%
  mutate_if(grepl('28',.), ~replace(., grepl('28', .), "Antidiabetic"))%>%
  mutate_if(grepl('29',.), ~replace(., grepl('29', .), "Antidiabetic"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Antidiabetic",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on Antidiabetic status
DIA_Drug_Histories <- Patients_Antidiabetic_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Antidiabetic
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to Antidiabetic
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Antidiabetic
DIA_Drug_Histories_FIRST_Antidiabetic <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Antidiabetic)[3] <- "Month_First_Antidiabetic"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Antidiabetic criteria
Patient_first_Antidiabetic<-  DIA_Drug_Histories_FIRST_Antidiabetic %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Antidiabetic %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Antidiabetic month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Antidiabetic, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_Antidiabetic <- as.numeric(DANU_Measures_HbA1c$Month_First_Antidiabetic)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before Antidiabetic start and months after Antidiabetic start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Antidiabetic <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_Antidiabetic)
HbA1cs_before_Antidiabetic <- HbA1cs_before_Antidiabetic %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Antidiabetic)[4] <- "Month_Prior"
names(HbA1cs_before_Antidiabetic)[3] <- "HbA1c_Prior"

HbA1cs_after_Antidiabetic <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_Antidiabetic)
HbA1cs_after_Antidiabetic <- HbA1cs_after_Antidiabetic %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_after_Antidiabetic)[4] <- "Month_After"
names(HbA1cs_after_Antidiabetic)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Antidiabetic_BEFORE_vs_AFTER <- HbA1cs_before_Antidiabetic %>% full_join(HbA1cs_after_Antidiabetic)
HbA1cs_Antidiabetic_BEFORE_vs_AFTER <- HbA1cs_Antidiabetic_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Antidiabetic_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Antidiabetic_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_Antidiabetic_BEFORE_vs_AFTER, "HbA1cs_Antidiabetic_BEFORE_vs_AFTER.csv")
# Biguanide --------

# No Biguanide first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  Biguanide before month 12
Patients_Biguanide_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("(^|\\D)(1{1})(\\D|$)",d1)) %>% select(patient)

Patients_no_Biguanide_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_Biguanide_12) %>% select(patient) %>% distinct()

# filter for patient who did have an Biguanide from 12 to 48
Patients_start_Biguanide_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("(^|\\D)(1{1})(\\D|$)",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_Biguanide_track <- Patients_no_Biguanide_12 %>% inner_join(Patients_start_Biguanide_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no Biguanide too zero, and Biguanide to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('(^|\\D)(1{1})(\\D|$)',.), ~replace(., grepl('(^|\\D)(1{1})(\\D|$)', .), "Biguanide"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Biguanide",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on Biguanide status
DIA_Drug_Histories <- Patients_Biguanide_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Biguanide
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to Biguanide
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Biguanide
DIA_Drug_Histories_FIRST_Biguanide <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Biguanide)[3] <- "Month_First_Biguanide"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Biguanide criteria
Patient_first_Biguanide<-  DIA_Drug_Histories_FIRST_Biguanide %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Biguanide %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Biguanide month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Biguanide, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_Biguanide <- as.numeric(DANU_Measures_HbA1c$Month_First_Biguanide)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before Biguanide start and months after Biguanide start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Biguanide <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_Biguanide)
HbA1cs_before_Biguanide <- HbA1cs_before_Biguanide %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Biguanide)[4] <- "Month_Prior"
names(HbA1cs_before_Biguanide)[3] <- "HbA1c_Prior"

HbA1cs_after_Biguanide <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_Biguanide)
HbA1cs_after_Biguanide <- HbA1cs_after_Biguanide %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_after_Biguanide)[4] <- "Month_After"
names(HbA1cs_after_Biguanide)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Biguanide_BEFORE_vs_AFTER <- HbA1cs_before_Biguanide %>% full_join(HbA1cs_after_Biguanide)
HbA1cs_Biguanide_BEFORE_vs_AFTER <- HbA1cs_Biguanide_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Biguanide_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Biguanide_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_Biguanide_BEFORE_vs_AFTER, "HbA1cs_Biguanide_BEFORE_vs_AFTER.csv")



# Insulin --------

# No Insulin first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  Insulin before month 12
Patients_Insulin_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("38",d1)|grepl("39",d1)|grepl("40",d1)|grepl("41",d1)|grepl("42",d1)|grepl("43",d1)|grepl("44",d1)|grepl("45",d1)|grepl("46",d1)) %>% select(patient)

Patients_no_Insulin_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_Insulin_12) %>% select(patient) %>% distinct()

# filter for patient who did have an Insulin from 12 to 48
Patients_start_Insulin_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("38",d1)|grepl("39",d1)|grepl("40",d1)|grepl("41",d1)|grepl("42",d1)|grepl("43",d1)|grepl("44",d1)|grepl("45",d1)|grepl("46",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_Insulin_track <- Patients_no_Insulin_12 %>% inner_join(Patients_start_Insulin_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no Insulin too zero, and Insulin to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('38',.), ~replace(., grepl('38', .), "Insulin")) %>%
  mutate_if(grepl('39',.), ~replace(., grepl('39', .), "Insulin")) %>%
  mutate_if(grepl('40',.), ~replace(., grepl('40)', .), "Insulin")) %>%
  mutate_if(grepl('41',.), ~replace(., grepl('41)', .), "Insulin")) %>%
  mutate_if(grepl('42',.), ~replace(., grepl('42)', .), "Insulin")) %>%
  mutate_if(grepl('43',.), ~replace(., grepl('43)', .), "Insulin")) %>%
  mutate_if(grepl('44',.), ~replace(., grepl('44)', .), "Insulin")) %>%
  mutate_if(grepl('45',.), ~replace(., grepl('45)', .), "Insulin")) %>%
  mutate_if(grepl('46',.), ~replace(., grepl('46)', .), "Insulin"))
  

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Insulin",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on Insulin status
DIA_Drug_Histories <- Patients_Insulin_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Insulin
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to Insulin
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Insulin
DIA_Drug_Histories_FIRST_Insulin <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Insulin)[3] <- "Month_First_Insulin"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Insulin criteria
Patient_first_Insulin<-  DIA_Drug_Histories_FIRST_Insulin %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Insulin %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Insulin month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Insulin, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_Insulin <- as.numeric(DANU_Measures_HbA1c$Month_First_Insulin)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before Insulin start and months after Insulin start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Insulin <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_Insulin)
HbA1cs_before_Insulin <- HbA1cs_before_Insulin %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Insulin)[4] <- "Month_Prior"
names(HbA1cs_before_Insulin)[3] <- "HbA1c_Prior"

HbA1cs_after_Insulin <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_Insulin)
HbA1cs_after_Insulin <- HbA1cs_after_Insulin %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_after_Insulin)[4] <- "Month_After"
names(HbA1cs_after_Insulin)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Insulin_BEFORE_vs_AFTER <- HbA1cs_before_Insulin %>% full_join(HbA1cs_after_Insulin)
HbA1cs_Insulin_BEFORE_vs_AFTER <- HbA1cs_Insulin_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Insulin_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Insulin_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_Insulin_BEFORE_vs_AFTER, "HbA1cs_Insulin_BEFORE_vs_AFTER.csv")






# -----
# Closest to Drug initiation -----

# GLP1 Oral --------

# No GLP1 Oral first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  GLP1 Oral before month 12
Patients_GLP1Oral_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("47",d1)) %>% select(patient)

Patients_no_GLP1Oral_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_GLP1Oral_12) %>% select(patient) %>% distinct()

# filter for patient who did have an GLP1 Oral from 12 to 48
Patients_start_GLP1Oral_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12) %>%
  filter(grepl("47",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_GLP1Oral_track <- Patients_no_GLP1Oral_12 %>% inner_join(Patients_start_GLP1Oral_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no GLP1 Oral too zero, and GLP1 Oral to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('47',.), ~replace(., grepl('47', .), "GLP1Oral"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1Oral",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on GLP1 Oral status
DIA_Drug_Histories <- Patients_GLP1Oral_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON GLP1 Oral
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to GLP1 Oral
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Oral
DIA_Drug_Histories_FIRST_GLP1Oral <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1Oral)[3] <- "Month_First_GLP1Oral"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Oral criteria
Patient_first_GLP1Oral<-  DIA_Drug_Histories_FIRST_GLP1Oral %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_GLP1Oral %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first GLP1 Oral month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_GLP1Oral, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_GLP1Oral <- as.numeric(DANU_Measures_HbA1c$Month_First_GLP1Oral)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before GLP1 Oral start and months after GLP1 Oral start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_GLP1Oral <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_GLP1Oral)
HbA1cs_before_GLP1Oral <- HbA1cs_before_GLP1Oral %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_GLP1Oral)[4] <- "Month_Prior"
names(HbA1cs_before_GLP1Oral)[3] <- "HbA1c_Prior"

HbA1cs_after_GLP1Oral <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_GLP1Oral)
HbA1cs_after_GLP1Oral <- HbA1cs_after_GLP1Oral %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_GLP1Oral)[4] <- "Month_After"
names(HbA1cs_after_GLP1Oral)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_GLP1Oral_BEFORE_vs_AFTER <- HbA1cs_before_GLP1Oral %>% full_join(HbA1cs_after_GLP1Oral)
HbA1cs_GLP1Oral_BEFORE_vs_AFTER <- HbA1cs_GLP1Oral_BEFORE_vs_AFTER %>% na.omit()

write.csv(HbA1cs_GLP1Oral_BEFORE_vs_AFTER, "HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest.csv")

# GLP1 Injectable  -----

# No GLP1 Injectable first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  GLP1 Injectable before month 12
Patients_GLP1Injectable_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|grepl("51",d1)|grepl("52",d1)|grepl("53",d1)) %>% select(patient)

Patients_no_GLP1Injectable_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_GLP1Injectable_12) %>% select(patient) %>% distinct()

# filter for patient who did have an GLP1 Injectable from 12 to 48
Patients_start_GLP1Injectable_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|grepl("51",d1)|grepl("52",d1)|grepl("53",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_GLP1Injectable_track <- Patients_no_GLP1Injectable_12 %>% inner_join(Patients_start_GLP1Injectable_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('48',.), ~replace(., grepl('48', .), "GLP1Injectable"))%>%
  mutate_if(grepl('49',.), ~replace(., grepl('49', .), "GLP1Injectable"))%>%
  mutate_if(grepl('50',.), ~replace(., grepl('50', .), "GLP1Injectable"))%>%
  mutate_if(grepl('51',.), ~replace(., grepl('51', .), "GLP1Injectable"))%>%
  mutate_if(grepl('52',.), ~replace(., grepl('52', .), "GLP1Injectable"))%>%
  mutate_if(grepl('53',.), ~replace(., grepl('53', .), "GLP1Injectable"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1Injectable",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on GLP1 Injectable status
DIA_Drug_Histories <- Patients_GLP1Injectable_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1Injectable <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1Injectable)[3] <- "Month_First_GLP1Injectable"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1Injectable<-  DIA_Drug_Histories_FIRST_GLP1Injectable %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_GLP1Injectable %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first GLP1 Injectable month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_GLP1Injectable, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_GLP1Injectable <- as.numeric(DANU_Measures_HbA1c$Month_First_GLP1Injectable)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_GLP1Injectable <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_GLP1Injectable)
HbA1cs_before_GLP1Injectable <- HbA1cs_before_GLP1Injectable %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_GLP1Injectable)[4] <- "Month_Prior"
names(HbA1cs_before_GLP1Injectable)[3] <- "HbA1c_Prior"

HbA1cs_after_GLP1Injectable <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_GLP1Injectable)
HbA1cs_after_GLP1Injectable <- HbA1cs_after_GLP1Injectable %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_GLP1Injectable)[4] <- "Month_After"
names(HbA1cs_after_GLP1Injectable)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- HbA1cs_before_GLP1Injectable %>% full_join(HbA1cs_after_GLP1Injectable)
HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- HbA1cs_GLP1Injectable_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER, "HbA1cs_GLP1Injectable_BEFORE_vs_AFTER_closest.csv")

# SGLT2 --------

# No SGLT2 first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  SGLT2 before month 12
Patients_SGLT2_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("34",d1)|grepl("35",d1)|grepl("36",d1)|grepl("37",d1)) %>% select(patient)

Patients_no_SGLT2_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_SGLT2_12) %>% select(patient) %>% distinct()

# filter for patient who did have an SGLT2 from 12 to 48
Patients_start_SGLT2_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("34",d1)|grepl("35",d1)|grepl("36",d1)|grepl("37",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_SGLT2_track <- Patients_no_SGLT2_12 %>% inner_join(Patients_start_SGLT2_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no SGLT2 too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('34',.), ~replace(., grepl('34', .), "SGLT2"))%>%
  mutate_if(grepl('35',.), ~replace(., grepl('35', .), "SGLT2"))%>%
  mutate_if(grepl('36',.), ~replace(., grepl('36', .), "SGLT2"))%>%
  mutate_if(grepl('37',.), ~replace(., grepl('37', .), "SGLT2"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on SGLT2 status
DIA_Drug_Histories <- Patients_SGLT2_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_SGLT2 %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first SGLT2 month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_SGLT2 <- as.numeric(DANU_Measures_HbA1c$Month_First_SGLT2)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_SGLT2)
HbA1cs_before_SGLT2 <- HbA1cs_before_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_SGLT2)[4] <- "Month_Prior"
names(HbA1cs_before_SGLT2)[3] <- "HbA1c_Prior"

HbA1cs_after_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_SGLT2)
HbA1cs_after_SGLT2 <- HbA1cs_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_SGLT2)[4] <- "Month_After"
names(HbA1cs_after_SGLT2)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_before_SGLT2 %>% full_join(HbA1cs_after_SGLT2)
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_SGLT2_BEFORE_vs_AFTER, "HbA1cs_SGLT2_BEFORE_vs_AFTER_closest.csv")
# DPP4 -------

# No DPP4 first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  DPP4 before month 12
Patients_DPP4_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("30",d1)|grepl("31",d1)|grepl("32",d1)|grepl("33",d1)) %>% select(patient)

Patients_no_DPP4_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_DPP4_12) %>% select(patient) %>% distinct()

# filter for patient who did have an DPP4 from 12 to 48
Patients_start_DPP4_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("30",d1)|grepl("31",d1)|grepl("32",d1)|grepl("33",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_DPP4_track <- Patients_no_DPP4_12 %>% inner_join(Patients_start_DPP4_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no DPP4 too zero, and DPP4 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('30',.), ~replace(., grepl('30', .), "DPP4"))%>%
  mutate_if(grepl('31',.), ~replace(., grepl('31', .), "DPP4"))%>%
  mutate_if(grepl('32',.), ~replace(., grepl('32', .), "DPP4"))%>%
  mutate_if(grepl('33',.), ~replace(., grepl('33', .), "DPP4"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="DPP4",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on DPP4 status
DIA_Drug_Histories <- Patients_DPP4_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON DPP4
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to DPP4
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took DPP4
DIA_Drug_Histories_FIRST_DPP4 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_DPP4)[3] <- "Month_First_DPP4"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the DPP4 criteria
Patient_first_DPP4<-  DIA_Drug_Histories_FIRST_DPP4 %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_DPP4 %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first DPP4 month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_DPP4, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_DPP4 <- as.numeric(DANU_Measures_HbA1c$Month_First_DPP4)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before DPP4 start and months after DPP4 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_DPP4 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_DPP4)
HbA1cs_before_DPP4 <- HbA1cs_before_DPP4 %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_DPP4)[4] <- "Month_Prior"
names(HbA1cs_before_DPP4)[3] <- "HbA1c_Prior"

HbA1cs_after_DPP4 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_DPP4)
HbA1cs_after_DPP4 <- HbA1cs_after_DPP4 %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_DPP4)[4] <- "Month_After"
names(HbA1cs_after_DPP4)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_DPP4_BEFORE_vs_AFTER <- HbA1cs_before_DPP4 %>% full_join(HbA1cs_after_DPP4)
HbA1cs_DPP4_BEFORE_vs_AFTER <- HbA1cs_DPP4_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_DPP4_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_DPP4_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_DPP4_BEFORE_vs_AFTER, "HbA1cs_DPP4_BEFORE_vs_AFTER_closest.csv")
# Antidiabetic -------

# No Antidiabetic first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  Antidiabetic before month 12
Patients_Antidiabetic_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("14",d1)|grepl("15",d1)|grepl("16",d1)|grepl("17",d1)|grepl("18",d1)|grepl("19",d1)|grepl("20",d1)|grepl("21",d1)|grepl("22",d1)|grepl("23",d1)|grepl("24",d1)|grepl("25",d1)|grepl("26",d1)|grepl("27",d1)|grepl("28",d1)|grepl("29",d1)) %>% select(patient)

Patients_no_Antidiabetic_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_Antidiabetic_12) %>% select(patient) %>% distinct()

# filter for patient who did have an Antidiabetic from 12 to 48
Patients_start_Antidiabetic_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("14",d1)|grepl("15",d1)|grepl("16",d1)|grepl("17",d1)|grepl("18",d1)|grepl("19",d1)|grepl("20",d1)|grepl("21",d1)|grepl("22",d1)|grepl("23",d1)|grepl("24",d1)|grepl("25",d1)|grepl("26",d1)|grepl("27",d1)|grepl("28",d1)|grepl("29",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_Antidiabetic_track <- Patients_no_Antidiabetic_12 %>% inner_join(Patients_start_Antidiabetic_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no Antidiabetic too zero, and Antidiabetic to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('14',.), ~replace(., grepl('14', .), "Antidiabetic"))%>%
  mutate_if(grepl('15',.), ~replace(., grepl('15', .), "Antidiabetic"))%>%
  mutate_if(grepl('16',.), ~replace(., grepl('16', .), "Antidiabetic"))%>%
  mutate_if(grepl('17',.), ~replace(., grepl('17', .), "Antidiabetic"))%>%
  mutate_if(grepl('18',.), ~replace(., grepl('18', .), "Antidiabetic"))%>%
  mutate_if(grepl('19',.), ~replace(., grepl('19', .), "Antidiabetic"))%>%
  mutate_if(grepl('20',.), ~replace(., grepl('20', .), "Antidiabetic"))%>%
  mutate_if(grepl('21',.), ~replace(., grepl('21', .), "Antidiabetic"))%>%
  mutate_if(grepl('22',.), ~replace(., grepl('22', .), "Antidiabetic"))%>%
  mutate_if(grepl('23',.), ~replace(., grepl('23', .), "Antidiabetic"))%>%
  mutate_if(grepl('24',.), ~replace(., grepl('24', .), "Antidiabetic"))%>%
  mutate_if(grepl('25',.), ~replace(., grepl('25', .), "Antidiabetic"))%>%
  mutate_if(grepl('26',.), ~replace(., grepl('26', .), "Antidiabetic"))%>%
  mutate_if(grepl('27',.), ~replace(., grepl('27', .), "Antidiabetic"))%>%
  mutate_if(grepl('28',.), ~replace(., grepl('28', .), "Antidiabetic"))%>%
  mutate_if(grepl('29',.), ~replace(., grepl('29', .), "Antidiabetic"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Antidiabetic",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on Antidiabetic status
DIA_Drug_Histories <- Patients_Antidiabetic_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Antidiabetic
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to Antidiabetic
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Antidiabetic
DIA_Drug_Histories_FIRST_Antidiabetic <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Antidiabetic)[3] <- "Month_First_Antidiabetic"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Antidiabetic criteria
Patient_first_Antidiabetic<-  DIA_Drug_Histories_FIRST_Antidiabetic %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Antidiabetic %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Antidiabetic month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Antidiabetic, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_Antidiabetic <- as.numeric(DANU_Measures_HbA1c$Month_First_Antidiabetic)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before Antidiabetic start and months after Antidiabetic start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Antidiabetic <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_Antidiabetic)
HbA1cs_before_Antidiabetic <- HbA1cs_before_Antidiabetic %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Antidiabetic)[4] <- "Month_Prior"
names(HbA1cs_before_Antidiabetic)[3] <- "HbA1c_Prior"

HbA1cs_after_Antidiabetic <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_Antidiabetic)
HbA1cs_after_Antidiabetic <- HbA1cs_after_Antidiabetic %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_Antidiabetic)[4] <- "Month_After"
names(HbA1cs_after_Antidiabetic)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Antidiabetic_BEFORE_vs_AFTER <- HbA1cs_before_Antidiabetic %>% full_join(HbA1cs_after_Antidiabetic)
HbA1cs_Antidiabetic_BEFORE_vs_AFTER <- HbA1cs_Antidiabetic_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Antidiabetic_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Antidiabetic_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_Antidiabetic_BEFORE_vs_AFTER, "HbA1cs_Antidiabetic_BEFORE_vs_AFTER_closest.csv")
# Biguanide --------

# No Biguanide first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  Biguanide before month 12
Patients_Biguanide_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("(^|\\D)(1{1})(\\D|$)",d1)) %>% select(patient)

Patients_no_Biguanide_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_Biguanide_12) %>% select(patient) %>% distinct()

# filter for patient who did have an Biguanide from 12 to 48
Patients_start_Biguanide_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("(^|\\D)(1{1})(\\D|$)",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_Biguanide_track <- Patients_no_Biguanide_12 %>% inner_join(Patients_start_Biguanide_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no Biguanide too zero, and Biguanide to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('(^|\\D)(1{1})(\\D|$)',.), ~replace(., grepl('(^|\\D)(1{1})(\\D|$)', .), "Biguanide"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Biguanide",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on Biguanide status
DIA_Drug_Histories <- Patients_Biguanide_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Biguanide
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to Biguanide
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Biguanide
DIA_Drug_Histories_FIRST_Biguanide <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Biguanide)[3] <- "Month_First_Biguanide"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Biguanide criteria
Patient_first_Biguanide<-  DIA_Drug_Histories_FIRST_Biguanide %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Biguanide %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Biguanide month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Biguanide, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_Biguanide <- as.numeric(DANU_Measures_HbA1c$Month_First_Biguanide)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before Biguanide start and months after Biguanide start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Biguanide <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_Biguanide)
HbA1cs_before_Biguanide <- HbA1cs_before_Biguanide %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Biguanide)[4] <- "Month_Prior"
names(HbA1cs_before_Biguanide)[3] <- "HbA1c_Prior"

HbA1cs_after_Biguanide <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_Biguanide)
HbA1cs_after_Biguanide <- HbA1cs_after_Biguanide %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_Biguanide)[4] <- "Month_After"
names(HbA1cs_after_Biguanide)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Biguanide_BEFORE_vs_AFTER <- HbA1cs_before_Biguanide %>% full_join(HbA1cs_after_Biguanide)
HbA1cs_Biguanide_BEFORE_vs_AFTER <- HbA1cs_Biguanide_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Biguanide_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Biguanide_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_Biguanide_BEFORE_vs_AFTER, "HbA1cs_Biguanide_BEFORE_vs_AFTER_closest.csv")



# Insulin --------

# No Insulin first 12months
#started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

#filter for patients who had no  Insulin before month 12
Patients_Insulin_12 <- DIA_Flows_Aux._Long %>% filter(p1 < 12) %>% filter(grepl("38",d1)|grepl("39",d1)|grepl("40",d1)|grepl("41",d1)|grepl("42",d1)|grepl("43",d1)|grepl("44",d1)|grepl("45",d1)|grepl("46",d1)) %>% select(patient)

Patients_no_Insulin_12 <- DIA_Flows_Aux._Long %>% filter(p1<12) %>% anti_join(Patients_Insulin_12) %>% select(patient) %>% distinct()

# filter for patient who did have an Insulin from 12 to 48
Patients_start_Insulin_12_48 <- DIA_Flows_Aux._Long %>% filter(p1 >= 12 &  p1 < 48) %>%
  filter(grepl("38",d1)|grepl("39",d1)|grepl("40",d1)|grepl("41",d1)|grepl("42",d1)|grepl("43",d1)|grepl("44",d1)|grepl("45",d1)|grepl("46",d1)) %>% select(patient) %>% distinct()

# select patient intersection 
Patients_Insulin_track <- Patients_no_Insulin_12 %>% inner_join(Patients_start_Insulin_12_48)

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no Insulin too zero, and Insulin to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('38',.), ~replace(., grepl('38', .), "Insulin")) %>%
  mutate_if(grepl('39',.), ~replace(., grepl('39', .), "Insulin")) %>%
  mutate_if(grepl('40',.), ~replace(., grepl('40)', .), "Insulin")) %>%
  mutate_if(grepl('41',.), ~replace(., grepl('41)', .), "Insulin")) %>%
  mutate_if(grepl('42',.), ~replace(., grepl('42)', .), "Insulin")) %>%
  mutate_if(grepl('43',.), ~replace(., grepl('43)', .), "Insulin")) %>%
  mutate_if(grepl('44',.), ~replace(., grepl('44)', .), "Insulin")) %>%
  mutate_if(grepl('45',.), ~replace(., grepl('45)', .), "Insulin")) %>%
  mutate_if(grepl('46',.), ~replace(., grepl('46)', .), "Insulin"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Insulin",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on Insulin status
DIA_Drug_Histories <- Patients_Insulin_track %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Insulin
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to Insulin
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Insulin
DIA_Drug_Histories_FIRST_Insulin <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Insulin)[3] <- "Month_First_Insulin"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Insulin criteria
Patient_first_Insulin<-  DIA_Drug_Histories_FIRST_Insulin %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Insulin %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Insulin month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Insulin, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_Insulin <- as.numeric(DANU_Measures_HbA1c$Month_First_Insulin)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before Insulin start and months after Insulin start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Insulin <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_Insulin)
HbA1cs_before_Insulin <- HbA1cs_before_Insulin %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Insulin)[4] <- "Month_Prior"
names(HbA1cs_before_Insulin)[3] <- "HbA1c_Prior"

HbA1cs_after_Insulin <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_Insulin)
HbA1cs_after_Insulin <- HbA1cs_after_Insulin %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_Insulin)[4] <- "Month_After"
names(HbA1cs_after_Insulin)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Insulin_BEFORE_vs_AFTER <- HbA1cs_before_Insulin %>% full_join(HbA1cs_after_Insulin)
HbA1cs_Insulin_BEFORE_vs_AFTER <- HbA1cs_Insulin_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Insulin_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Insulin_BEFORE_vs_AFTER$HbA1c_After)

write.csv(HbA1cs_Insulin_BEFORE_vs_AFTER, "HbA1cs_Insulin_BEFORE_vs_AFTER_closest.csv")


# Oral GLP1 & SG?LT2  combo  --------
  
# No Combo first 12months
 #started between 12 and 48months, follow from 12 to 60 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, d1, s1)

# there are no patient sin combos before month 12 so, no one to remove

# filter for patients who did have a combo
Patients_combo <- DIA_Flows_Aux._Long %>% 
  filter((grepl("34",d1)|grepl("35",d1)|grepl("36",d1)|grepl("37",d1))&(grepl("47",d1))) %>% select(patient) %>% distinct()

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(15:63)

# convert no combo too zero, and combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(is.character, funs(ifelse( (grepl("34",.)|grepl("35",.)|grepl("36",.)|grepl("37",.))&(grepl("47",.)), "Combo", .)))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

# filter for the patients selected based on Insulin status
DIA_Drug_Histories <- Patients_combo %>% left_join(DIA_Drug_Histories)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month12:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Insulin criteria
Patient_first_Combo <-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Combo %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Insulin month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_Combo <- as.numeric(DANU_Measures_HbA1c$Month_First_Combo)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before combo start and months after combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Combo <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_Combo)
HbA1cs_before_Combo <- HbA1cs_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Combo)[4] <- "Month_Prior"
names(HbA1cs_before_Combo)[3] <- "HbA1c_Prior"

HbA1cs_after_Combo <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_Combo)
HbA1cs_after_Combo <- HbA1cs_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_Combo)[4] <- "Month_After"
names(HbA1cs_after_Combo)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Combo_BEFORE_vs_AFTER <- HbA1cs_before_Combo %>% full_join(HbA1cs_after_Combo)
HbA1cs_Combo_BEFORE_vs_AFTER <- HbA1cs_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_After)

#1.677465

write.csv(HbA1cs_Combo_BEFORE_vs_AFTER, "HbA1cs_Combo_BEFORE_vs_AFTER_closest.csv")




# -------
# Summary HbA1c Reductions -------------

HbA1cs_Biguanide_BEFORE_vs_AFTER <- fread("HbA1cs_Biguanide_BEFORE_vs_AFTER_closest.csv")
HbA1cs_Biguanide_BEFORE_vs_AFTER <- HbA1cs_Biguanide_BEFORE_vs_AFTER %>% filter(Months_Lapsed_Before>=-12 & Months_Lapsed_After<=12)

HbA1cs_Antidiabetic_BEFORE_vs_AFTER <- fread("HbA1cs_Antidiabetic_BEFORE_vs_AFTER_closest.csv")
HbA1cs_Antidiabetic_BEFORE_vs_AFTER <- HbA1cs_Antidiabetic_BEFORE_vs_AFTER %>% filter(Months_Lapsed_Before>=-12 & Months_Lapsed_After<=12)


HbA1cs_DPP4_BEFORE_vs_AFTER <- fread("HbA1cs_DPP4_BEFORE_vs_AFTER_closest.csv")
HbA1cs_DPP4_BEFORE_vs_AFTER <- HbA1cs_DPP4_BEFORE_vs_AFTER %>% filter(Months_Lapsed_Before>=-12 & Months_Lapsed_After<=12)


HbA1cs_SGLT2_BEFORE_vs_AFTER <- fread("HbA1cs_SGLT2_BEFORE_vs_AFTER_closest.csv")
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_SGLT2_BEFORE_vs_AFTER %>% filter(Months_Lapsed_Before>=-12 & Months_Lapsed_After<=12)


HbA1cs_Insulin_BEFORE_vs_AFTER <- fread("HbA1cs_Insulin_BEFORE_vs_AFTER_closest.csv")
HbA1cs_Insulin_BEFORE_vs_AFTER <- HbA1cs_Insulin_BEFORE_vs_AFTER %>% filter(Months_Lapsed_Before>=-12 & Months_Lapsed_After<=12)


HbA1cs_GLP1Oral_BEFORE_vs_AFTER <- fread("HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest.csv")
HbA1cs_GLP1Oral_BEFORE_vs_AFTER <- HbA1cs_GLP1Oral_BEFORE_vs_AFTER %>% filter(Months_lapsed_before>=-12 & Months_lapsed_after<=12)


HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- fread("HbA1cs_GLP1Injectable_BEFORE_vs_AFTER_closest.csv")
HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- HbA1cs_GLP1Injectable_BEFORE_vs_AFTER %>% filter(Months_Lapsed_Before>=-12 & Months_Lapsed_After<=12)


HbA1cs_Combo_BEFORE_vs_AFTER <- fread("HbA1cs_Combo_BEFORE_vs_AFTER_closest.csv")


mean(HbA1cs_Biguanide_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Biguanide_BEFORE_vs_AFTER$HbA1c_After)
mean(HbA1cs_Antidiabetic_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Antidiabetic_BEFORE_vs_AFTER$HbA1c_After)
mean(HbA1cs_DPP4_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_DPP4_BEFORE_vs_AFTER$HbA1c_After)
mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_After)
mean(HbA1cs_Insulin_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Insulin_BEFORE_vs_AFTER$HbA1c_After)
mean(HbA1cs_GLP1Oral_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_GLP1Oral_BEFORE_vs_AFTER$HbA1c_After)
mean(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_After)
mean(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_After)




median(HbA1cs_Biguanide_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Biguanide_BEFORE_vs_AFTER$HbA1c_After)
median(HbA1cs_Antidiabetic_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Antidiabetic_BEFORE_vs_AFTER$HbA1c_After)
median(HbA1cs_DPP4_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_DPP4_BEFORE_vs_AFTER$HbA1c_After)
median(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_After)
median(HbA1cs_Insulin_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Insulin_BEFORE_vs_AFTER$HbA1c_After)
median(HbA1cs_GLP1Oral_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_GLP1Oral_BEFORE_vs_AFTER$HbA1c_After)
median(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_After)
median(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_Prior-HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_After)


HbA1c_Evolution_US_PAIRED <- fread("HbA1c_Evolution_US_PAIRED.csv")

Pats_to_keep_paired <- HbA1c_Evolution_US_PAIRED %>% group_by(patient, Therapy) %>% filter(Month>=-12 & Month<=12) %>% 
   count() %>% filter(n%%2==0) %>% select(patient, Therapy)

HbA1c_Evolution_US_PAIRED <- Pats_to_keep_paired %>% left_join(HbA1c_Evolution_US_PAIRED)

HbA1c_Evolution_US_PAIRED %>% 
  group_by(Therapy, Month) %>%  
  ggplot(aes(x=Month, y=HbA1c, fill=Therapy, colour=Therapy))+
  geom_smooth(size=2.5, method = "loess", se=F )+
  ylab("HbA1c %\n")+
  xlab("\nMonth")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_colour_jama()+
  ggsci::scale_fill_jama()

HbA1c_Evolution_US_PAIRED %>% group_by(Therapy, Period) %>% summarise(n=median(HbA1c))


HbA1c_Evolution_US_PAIRED_combos <- fread("HbA1c_Evolution_US_PAIRED_combos.csv")

Pats_to_keep_paired_combos <- HbA1c_Evolution_US_PAIRED_combos %>% group_by(patient, Therapy) %>% filter(Month>=-12 & Month<=12) %>% 
  count() %>% filter(n%%2==0) %>% select(patient, Therapy)

HbA1c_Evolution_US_PAIRED_combos <- Pats_to_keep_paired_combos %>% left_join(HbA1c_Evolution_US_PAIRED_combos)

HbA1c_Evolution_US_PAIRED_combos %>% 
  group_by(Therapy, Month) %>%  
  ggplot(aes(x=Month, y=HbA1c, fill=Therapy, colour=Therapy))+
  geom_smooth(size=2.5, method = "loess", se=F )+
  ylab("HbA1c %\n")+
  xlab("\nMonth")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_colour_jama()+
  ggsci::scale_fill_jama()

HbA1c_Evolution_US_PAIRED_combos %>% group_by(Therapy, Period) %>% summarise(n=median(HbA1c))



# ------
#	Rybelsus vs Injectable interaction ------------
# First move from Inj to Rybelsus
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% 
  filter(grepl("47",d2) & !grepl("47",d1)) %>% slice(1) %>% filter(grepl("G",s1))
First_Oral_GLP1 <- DIA_Flows_Aux._Long

# First month ON Inj 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% filter(grepl("G",s1)) %>% slice(1)
First_Inj <- DIA_Flows_Aux._Long %>% select(patient, p1) 
names(First_Inj)[2] <- "Start_Inj"
First_Oral_GLP1 <- First_Oral_GLP1 %>% left_join(First_Inj)
First_Oral_GLP1 <- First_Oral_GLP1 %>% mutate(Time_Since_Inj_Start = p2-Start_Inj)

weighted.mean(First_Oral_GLP1$Time_Since_Inj_Start, First_Oral_GLP1$weight) # 23.08841
weighted.median(First_Oral_GLP1$Time_Since_Inj_Start, First_Oral_GLP1$weight) # 16.5

First_Oral_GLP1 %>%
  ggplot(aes(Time_Since_Inj_Start))+
  geom_histogram(bins=60, fill="deepskyblue4", colour="aliceblue")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

First_Oral_GLP1 %>%
  ggplot(aes(Time_Since_Inj_Start))+
  geom_density(fill="deepskyblue4", colour="aliceblue", alpha=0.6)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Time from First GLP1 Injectable to Rybelsus\n(months)")+
  ylab("Proportion of GLP1 Patients\n(originating from GLP1 Injectable)\n")

sum(First_Oral_GLP1$weight) # 23379.8

sum(First_Oral_GLP1$weight[First_Oral_GLP1$Time_Since_Inj_Start<=6]) # 6177.59
sum(First_Oral_GLP1$weight[First_Oral_GLP1$Time_Since_Inj_Start>6]) # 17202.21

sum(First_Oral_GLP1$weight[First_Oral_GLP1$Time_Since_Inj_Start<=12]) # 9803.74
sum(First_Oral_GLP1$weight[First_Oral_GLP1$Time_Since_Inj_Start>12]) # 13576.06


First_Oral_GLP1 <- First_Oral_GLP1 %>% arrange(Time_Since_Inj_Start)
First_Oral_GLP1 <- First_Oral_GLP1 %>% group_by(Time_Since_Inj_Start) %>% summarise(n=sum(weight))
First_Oral_GLP1 <- First_Oral_GLP1 %>% mutate(Cum = cumsum(n))
First_Oral_GLP1 <- First_Oral_GLP1 %>% mutate(perc = (Cum/23379.8)*100)
First_Oral_GLP1 <- First_Oral_GLP1 %>% mutate(perc=round(perc,0))

First_Oral_GLP1 %>% ggplot(aes(Time_Since_Inj_Start, perc))+
  geom_line(size=2, colour="firebrick")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  scale_y_continuous(position = "right")+
  xlab("")+ylab("Cummulative %\n")+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),  
        plot.background = element_rect(fill = "transparent", colour = NA),
        rect = element_rect(fill = "transparent"))





# --------

# Pathways / Class Penetrance to Oral GLP1 ---------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Oral_GLP1_pats <- DIA_Flows_Aux._Long %>% filter(grepl("47",d1)|grepl("47",d2)) %>% select(patient) %>% distinct()

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Oral_GLP1_pats)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories_2 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl("47",Treat))) 1:which.max(grepl("47",Treat)) else row_number())   

DIA_Drug_Histories_2 <-DIA_Drug_Histories_2 %>% arrange(patient, desc(Month))

DIA_Drug_Histories_2 <- DIA_Drug_Histories_2 %>% mutate(New_Month = row_number()) %>% mutate(New_Month=New_Month-1L)

Month_total <- data.frame(DIA_Drug_Histories_2 %>% ungroup() %>% group_by(New_Month) %>% summarise(Month_total=sum(weight)))

DIA_Drug_Histories_2 <- separate_rows(DIA_Drug_Histories_2, Treat, sep = ",", convert=T )
names(DIA_Drug_Histories_2)[4] <- "molecule"

DIA_Drug_Histories_2 <- DIA_Drug_Histories_2 %>% left_join(DANU_Ingredients, by=c("molecule"="drug_id")) 

Drug_penetrance_month <- DIA_Drug_Histories_2 %>% ungroup() %>% group_by(New_Month, drug_group) %>% summarise(n=sum(weight))
Drug_penetrance_month <- Drug_penetrance_month %>% left_join(Month_total)
Drug_penetrance_month <- Drug_penetrance_month %>% mutate(Penetrance= round((n/Month_total)*100,0))

Drug_penetrance_month %>% 
  filter(New_Month!=0) %>% 
  filter(New_Month<=42)%>%
  mutate(drug_group=ifelse(is.na(drug_group),"Lapsed",drug_group))%>%
  mutate(New_Month=New_Month*-1L) %>% filter(!is.na(drug_group))%>%
  ggplot(aes(x=New_Month, y=Penetrance, fill=factor(drug_group, levels=c("Lapsed", "Biguanide", "Antidiabetic", "DPP4", "SGLT2", "Insulin", "GLP1 Oral", "GLP1 Injectable")))) + 
  geom_area(alpha=0.8 , size=1, position = "stack", show.legend = T)+
  scale_fill_brewer(palette = "Paired") + theme(panel.background = element_blank())+
  xlab("\nMonths to Rybelsus")+ylab("Drug Penetrance (%)\n")

# ------
# Flows before GLP1 Oral ----------
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Pats_to_exclude <- DIA_Flows_Aux._Long %>% filter(p1<=47) %>% filter(grepl("47",d1)|grepl("47",d2)) %>% select(patient) %>% distinct()
Oral_GLP1_pats <- DIA_Flows_Aux._Long %>% filter(grepl("47",d1)|grepl("47",d2)) %>% select(patient) %>% distinct()
Oral_GLP1_pats <- Oral_GLP1_pats %>% anti_join(Pats_to_exclude)

DIA_Flows_Aux._Long <- Oral_GLP1_pats %>% left_join(DIA_Flows_Aux._Long)

DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long %>% group_by(patient, weight) %>% 
  slice(if(any(grepl("47",d2))) 1:which.max(grepl("47",d2)) else row_number())   

DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long_2 %>% select(-c(p1_RxExp, stops, starts, re_starts))

DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long_2 %>% arrange(patient, desc(p1))

DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long_2 %>% mutate(New_Month = row_number()) %>% mutate(New_Month=New_Month-1L)

DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long_2 %>% filter(New_Month<=12) %>% filter(New_Month != 0)

DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long_2 %>% mutate(Total_flows=sum(flow))

DIA_Flows_Aux._Long_2 %>% slice(1) %>% ungroup() %>% summarise(totalpats=sum(weight)) # 215902

DIA_Flows_Aux._Long_2 %>% slice(1) %>% ungroup() %>% group_by(Total_flows) %>% summarise(totalpats=sum(weight))



DIA_Flows_Aux._Long_2 %>% slice(1) %>% ungroup() %>% group_by(s2) %>% summarise(mean_totalpats=weighted.mean(Total_flows, weight))




Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

DIA_Flows_Aux._Long_3 <- DIA_Flows_Aux._Long_2 %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid", "weight"="weight", "p2"="Exact_Month"))

DIA_Flows_Aux._Long_3 <- data.frame(DIA_Flows_Aux._Long_3 %>% 
                                      group_by(patient, disease, weight,Total_flows) %>% 
                                      mutate(Mean_HbA1c=mean(value, na.rm=T)))


DIA_Flows_Aux._Long_3 %>% group_by(patient) %>% slice(1) %>% ungroup() %>% group_by(Total_flows) %>% summarise(MeanHbA1c=weighted.mean(Mean_HbA1c,weight, na.rm = T))



DIA_Flows_Aux._Long_3  %>% group_by(patient) %>% slice(1) %>% ungroup() %>% group_by(s2) %>% summarise(MeanHbA1c=weighted.mean(Mean_HbA1c,weight, na.rm = T))



# -------
# Naive on month 12, on which class do they start? -------------
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- Treatment_exp_Vector %>% left_join(DIA_Flows_Aux._Long)

Naive_12m <- DIA_Flows_Aux._Long %>% filter(p1 <= 12) %>% filter(p1_RxExp==0) %>% group_by(patient) %>% summarise(n = n()) %>% filter(n == 12) %>% select(patient) %>% distinct()
#11897307

# Starts before m18
Naive_12m %>% left_join(DIA_Flows_Aux._Long) %>% filter(s2!="x") %>% group_by(patient) %>% slice(1) %>% filter(p2 <=18) %>% group_by(s2) %>% summarise(pats=sum(weight))



# Starts  m18 - m24
Naive_12m %>% left_join(DIA_Flows_Aux._Long) %>% filter(s2!="x") %>% group_by(patient) %>% slice(1) %>% filter(p2 >18 & p2 <=24) %>% group_by(s2) %>% summarise(pats=sum(weight))



# Starts  m24 - m36
Naive_12m %>% left_join(DIA_Flows_Aux._Long) %>% filter(s2!="x") %>% group_by(patient) %>% slice(1) %>% filter(p2 >24 & p2 <=36) %>% group_by(s2) %>% summarise(pats=sum(weight))


# Starts  m36 - m48
Naive_12m %>% left_join(DIA_Flows_Aux._Long) %>% filter(s2!="x") %>% group_by(patient) %>% slice(1) %>% filter(p2 >36 & p2 <=48) %>% group_by(s2) %>% summarise(pats=sum(weight))




# Starts  m48 - m60
Naive_12m %>% left_join(DIA_Flows_Aux._Long) %>% filter(s2!="x") %>% group_by(patient) %>% slice(1) %>% filter(p2 >48 & p2 <=60) %>% group_by(s2) %>% summarise(pats=sum(weight))


# -----------

# Number of months / lines until each class initiation ------------
# Drugs / Classes to lookupstring_InjectableGLP1
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))

DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% filter(Month<=12)
DIA_Drug_Histories <-  DIA_Drug_Histories %>% filter(Drugs == "-")

# Naive until 12m, apts to track
Naive_until_12 <- DIA_Drug_Histories %>% group_by(patient) %>% count() %>% filter(n==12) %>% select(patient)


# ------
# Number of months -------
# Pats lapsed for the first 12months  --------

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories     <- Naive_until_12 %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Time to first  Biguanide
DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Biguanide,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Biguanide,Drugs)) else NA) 

DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories_Biguanide %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_Biguanide %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Biguanide %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.81
DIA_Drug_Histories_Biguanide %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Biguanide$weight) #8715979
sum(DIA_Drug_Histories_Biguanide$weight[DIA_Drug_Histories_Biguanide$n==1]) #8041423

DIA_Drug_Histories_Biguanide %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first Biguanide")

# Time to first  Antidiabetic
DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Antidiabetic,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Antidiabetic,Drugs)) else NA) 

DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories_Antidiabetic %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 6.65
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Antidiabetic$weight) #1980133
sum(DIA_Drug_Histories_Antidiabetic$weight[DIA_Drug_Histories_Antidiabetic$n==1]) #1108686

DIA_Drug_Histories_Antidiabetic %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first Antidiabetic")

# Time to first  DPP4
DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_DPP4,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_DPP4,Drugs)) else NA) 

DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories_DPP4 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_DPP4 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_DPP4 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 7.79
DIA_Drug_Histories_DPP4 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1.5

sum(DIA_Drug_Histories_DPP4$weight) #955504.1
sum(DIA_Drug_Histories_DPP4$weight[DIA_Drug_Histories_DPP4$n==1]) #458386.2

DIA_Drug_Histories_DPP4 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first DPP4")

# Time to first  SGLT2
DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_SGLT2,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_SGLT2,Drugs)) else NA) 

DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories_SGLT2 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 11.1
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 4.5

sum(DIA_Drug_Histories_SGLT2$weight) #972640
sum(DIA_Drug_Histories_SGLT2$weight[DIA_Drug_Histories_SGLT2$n==1]) #344025.6

DIA_Drug_Histories_SGLT2 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first SGLT2")

# Time to first  Insulin
DIA_Drug_Histories_Insulin <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Insulin,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Insulin,Drugs)) else NA) 

DIA_Drug_Histories_Insulin <- DIA_Drug_Histories_Insulin %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_Insulin %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Insulin %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 3.86
DIA_Drug_Histories_Insulin %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Insulin$weight) #3601342
sum(DIA_Drug_Histories_Insulin$weight[DIA_Drug_Histories_Insulin$n==1]) #344025.6

DIA_Drug_Histories_Insulin %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first Insulin")

# Time to first  OralGLP1
DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_OralGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_OralGLP1,Drugs)) else NA) 

DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories_OralGLP1 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 16.2
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 12.5

sum(DIA_Drug_Histories_OralGLP1$weight) #102165.8
sum(DIA_Drug_Histories_OralGLP1$weight[DIA_Drug_Histories_OralGLP1$n==1]) #25725

DIA_Drug_Histories_OralGLP1 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first GLP1 Oral")

# Time to first  InjectableGLP1
DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_InjectableGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_InjectableGLP1,Drugs)) else NA) 

DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories_InjectableGLP1 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 9.00
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1.5

sum(DIA_Drug_Histories_InjectableGLP1$weight) #1362998
sum(DIA_Drug_Histories_InjectableGLP1$weight[DIA_Drug_Histories_InjectableGLP1$n==1]) #615791.7

DIA_Drug_Histories_InjectableGLP1 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first GLP1 Injectable")




# --------
# Without filtering lapsed pats 12m ------------

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Time to first  Biguanide
DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Biguanide,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Biguanide,Drugs)) else NA) 

DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories_Biguanide %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_Biguanide %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Biguanide %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 2.69
DIA_Drug_Histories_Biguanide %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Biguanide$weight) #23551993
sum(DIA_Drug_Histories_Biguanide$weight[DIA_Drug_Histories_Biguanide$n==1]) #20946331

DIA_Drug_Histories_Biguanide %>% ggplot(aes(n))+
  geom_histogram(bins=60, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first Biguanide")

# Time to first  Antidiabetic
DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Antidiabetic,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Antidiabetic,Drugs)) else NA) 

DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories_Antidiabetic %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 8.93
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Antidiabetic$weight) #9575292
sum(DIA_Drug_Histories_Antidiabetic$weight[DIA_Drug_Histories_Antidiabetic$n==1]) #5759288

DIA_Drug_Histories_Antidiabetic %>% ggplot(aes(n))+
  geom_histogram(bins=60, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first Antidiabetic")

# Time to first  DPP4
DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_DPP4,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_DPP4,Drugs)) else NA) 

DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories_DPP4 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_DPP4 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_DPP4 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 12.2
DIA_Drug_Histories_DPP4 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1.5

sum(DIA_Drug_Histories_DPP4$weight) #5354049
sum(DIA_Drug_Histories_DPP4$weight[DIA_Drug_Histories_DPP4$n==1]) #2527977

DIA_Drug_Histories_DPP4 %>% ggplot(aes(n))+
  geom_histogram(bins=60, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first DPP4")

# Time to first  SGLT2
DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_SGLT2,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_SGLT2,Drugs)) else NA) 

DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories_SGLT2 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
data.frame(DIA_Drug_Histories_SGLT2 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight)))
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 19.7
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 13.5

sum(DIA_Drug_Histories_SGLT2$weight) #4742756
sum(DIA_Drug_Histories_SGLT2$weight[DIA_Drug_Histories_SGLT2$n==1]) #1382767

DIA_Drug_Histories_SGLT2 %>% ggplot(aes(n))+
  geom_histogram(bins=60, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first SGLT2")

# Time to first  Insulin
DIA_Drug_Histories_Insulin <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Insulin,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Insulin,Drugs)) else NA) 

DIA_Drug_Histories_Insulin <- DIA_Drug_Histories_Insulin %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_Insulin %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Insulin %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 8.07
DIA_Drug_Histories_Insulin %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Insulin$weight) #11808892
sum(DIA_Drug_Histories_Insulin$weight[DIA_Drug_Histories_Insulin$n==1]) #7909388

DIA_Drug_Histories_Insulin %>% ggplot(aes(n))+
  geom_histogram(bins=60, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first Insulin")

# Time to first  OralGLP1
DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_OralGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_OralGLP1,Drugs)) else NA) 

DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories_OralGLP1 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 38.3
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 46.5

sum(DIA_Drug_Histories_OralGLP1$weight) #264137.4
sum(DIA_Drug_Histories_OralGLP1$weight[DIA_Drug_Histories_OralGLP1$n==1]) #25725

DIA_Drug_Histories_OralGLP1 %>% ggplot(aes(n))+
  geom_histogram(bins=60, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first GLP1 Oral")

# Time to first  InjectableGLP1
DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_InjectableGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_InjectableGLP1,Drugs)) else NA) 

DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories_InjectableGLP1 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 19.1
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 13.5

sum(DIA_Drug_Histories_InjectableGLP1$weight) #5373357
sum(DIA_Drug_Histories_InjectableGLP1$weight[DIA_Drug_Histories_InjectableGLP1$n==1]) #1568392

DIA_Drug_Histories_InjectableGLP1 %>% ggplot(aes(n))+
  geom_histogram(bins=60, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Months from first treatment to first GLP1 Injectable")








# -----



# Number of lines ------
# Pats lapsed for the first 12months ----------

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories     <- Naive_until_12 %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Lines to first  Biguanide
DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Biguanide,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Biguanide,Drugs)) else NA) 

DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories_Biguanide %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_Biguanide %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Biguanide %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.11
DIA_Drug_Histories_Biguanide %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Biguanide$weight) #8715979
sum(DIA_Drug_Histories_Biguanide$weight[DIA_Drug_Histories_Biguanide$n==1]) #8041423

DIA_Drug_Histories_Biguanide %>% ggplot(aes(n))+
  geom_histogram(fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,10)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first Biguanide")

# Time to first  Antidiabetic
DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Antidiabetic,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Antidiabetic,Drugs)) else NA) 

DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories_Antidiabetic %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.64
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Antidiabetic$weight) #1980133
sum(DIA_Drug_Histories_Antidiabetic$weight[DIA_Drug_Histories_Antidiabetic$n==1]) #1108686

DIA_Drug_Histories_Antidiabetic %>% ggplot(aes(n))+
  geom_histogram(fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,10)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first Antidiabetic")

# Time to first  DPP4
DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_DPP4,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_DPP4,Drugs)) else NA) 

DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories_DPP4 %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_DPP4 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_DPP4 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.81
DIA_Drug_Histories_DPP4 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1.5

sum(DIA_Drug_Histories_DPP4$weight) #955504.1
sum(DIA_Drug_Histories_DPP4$weight[DIA_Drug_Histories_DPP4$n==1]) #458386.2

DIA_Drug_Histories_DPP4 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,10)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first DPP4")

# Time to first  SGLT2
DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_SGLT2,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_SGLT2,Drugs)) else NA) 

DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories_SGLT2 %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 2.21
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1.5

sum(DIA_Drug_Histories_SGLT2$weight) #972640
sum(DIA_Drug_Histories_SGLT2$weight[DIA_Drug_Histories_SGLT2$n==1]) #344025.6

DIA_Drug_Histories_SGLT2 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,10)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first SGLT2")

# Time to first  Insulin
DIA_Drug_Histories_Insulin <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Insulin,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Insulin,Drugs)) else NA) 

DIA_Drug_Histories_Insulin <- DIA_Drug_Histories_Insulin %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_Insulin %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Insulin %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.33
DIA_Drug_Histories_Insulin %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Insulin$weight) #3601342
sum(DIA_Drug_Histories_Insulin$weight[DIA_Drug_Histories_Insulin$n==1]) #2830048

DIA_Drug_Histories_Insulin %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,10)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first Insulin")

# Time to first  OralGLP1
DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_OralGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_OralGLP1,Drugs)) else NA) 

DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories_OralGLP1 %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 2.62
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1.5

sum(DIA_Drug_Histories_OralGLP1$weight) #102165.8
sum(DIA_Drug_Histories_OralGLP1$weight[DIA_Drug_Histories_OralGLP1$n==1]) #25725

DIA_Drug_Histories_OralGLP1 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,10)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first GLP1 Oral")

# Time to first  InjectableGLP1
DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_InjectableGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_InjectableGLP1,Drugs)) else NA) 

DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories_InjectableGLP1 %>% select(-c(Month)) %>%  filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.99
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1.5

sum(DIA_Drug_Histories_InjectableGLP1$weight) #1362998
sum(DIA_Drug_Histories_InjectableGLP1$weight[DIA_Drug_Histories_InjectableGLP1$n==1]) #615791.7

DIA_Drug_Histories_InjectableGLP1 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,10)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first GLP1 Injectable")






# -----
# without filtering lapsed patients 12m -----
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Lines to first  Biguanide
DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Biguanide,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Biguanide,Drugs)) else NA) 

DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories_Biguanide %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_Biguanide %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Biguanide %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.19
DIA_Drug_Histories_Biguanide %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Biguanide$weight) #23551993
sum(DIA_Drug_Histories_Biguanide$weight[DIA_Drug_Histories_Biguanide$n==1]) #20946331

DIA_Drug_Histories_Biguanide %>% ggplot(aes(n))+
  geom_histogram(fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,15)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first Biguanide")

# Time to first  Antidiabetic
DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Antidiabetic,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Antidiabetic,Drugs)) else NA) 

DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories_Antidiabetic %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.74
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Antidiabetic$weight) #9575292
sum(DIA_Drug_Histories_Antidiabetic$weight[DIA_Drug_Histories_Antidiabetic$n==1]) #5759288

DIA_Drug_Histories_Antidiabetic %>% ggplot(aes(n))+
  geom_histogram(fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,15)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first Antidiabetic")

# Time to first  DPP4
DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_DPP4,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_DPP4,Drugs)) else NA) 

DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories_DPP4 %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_DPP4 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_DPP4 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 2.11
DIA_Drug_Histories_DPP4 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1.5

sum(DIA_Drug_Histories_DPP4$weight) #5354049
sum(DIA_Drug_Histories_DPP4$weight[DIA_Drug_Histories_DPP4$n==1]) #2527977

DIA_Drug_Histories_DPP4 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,15)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first DPP4")

# Time to first  SGLT2
DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_SGLT2,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_SGLT2,Drugs)) else NA) 

DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories_SGLT2 %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 2.96
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1.5

sum(DIA_Drug_Histories_SGLT2$weight) #4742756
sum(DIA_Drug_Histories_SGLT2$weight[DIA_Drug_Histories_SGLT2$n==1]) #1382767

DIA_Drug_Histories_SGLT2 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,15)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first SGLT2")

# Time to first  Insulin
DIA_Drug_Histories_Insulin <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Insulin,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Insulin,Drugs)) else NA) 

DIA_Drug_Histories_Insulin <- DIA_Drug_Histories_Insulin %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_Insulin %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Insulin %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.70
DIA_Drug_Histories_Insulin %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1

sum(DIA_Drug_Histories_Insulin$weight) #11808892
sum(DIA_Drug_Histories_Insulin$weight[DIA_Drug_Histories_Insulin$n==1]) #7909388

DIA_Drug_Histories_Insulin %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,15)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first Insulin")

# Time to first  OralGLP1
DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_OralGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_OralGLP1,Drugs)) else NA) 

DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories_OralGLP1 %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 4.71
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 3.5

sum(DIA_Drug_Histories_OralGLP1$weight) #264137.4
sum(DIA_Drug_Histories_OralGLP1$weight[DIA_Drug_Histories_OralGLP1$n==1]) #25725

DIA_Drug_Histories_OralGLP1 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,15)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first GLP1 Oral")

# Time to first  InjectableGLP1
DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_InjectableGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_InjectableGLP1,Drugs)) else NA) 

DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories_InjectableGLP1 %>% select(-c(Month)) %>%  filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 3.00
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% summarise(median=weighted.median(n, weight)) # 1.5

sum(DIA_Drug_Histories_InjectableGLP1$weight) #5373357
sum(DIA_Drug_Histories_InjectableGLP1$weight[DIA_Drug_Histories_InjectableGLP1$n==1]) #1568392

DIA_Drug_Histories_InjectableGLP1 %>% ggplot(aes(n))+
  geom_histogram(bins=48, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  xlim(0,15)+
  ylab("Number of Patients\n")+
  xlab("\nNumber of Therapy Lines from first treatment to first GLP1 Injectable")



# ------
# X vs Y plot of months to class vs lines to class -----------

Months_vs_Lines_to_class <- fread("Months_vs_Lines_to_class.txt")

library(ggrepel)
library(hrbrthemes)
library(viridis)

ggplot(Months_vs_Lines_to_class, aes(x=average_months_to_class_all, y=average_lines_to_class_all, size = pop_all, fill=drug_class, colour=drug_class)) +
  geom_point(alpha=0.7)+
  geom_text_repel(aes(label = drug_class), 
                  colour = "black", 
                  size = 6,
                  hjust = -1,
                  vjust=0.1,
                  fontface=2)+ 
  scale_size(range = c(.1, 24))+
  theme(legend.position = "none",
        panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        text = element_text(size = 15))+
  scale_colour_viridis_d(option = "D")+
  xlab("\nAverage Number of Months to Class Initiation")+
  ylab("Average Number of Therapy Lines to Class Initiation\n")















# -----
# Diabetes type (with or with complications, etc)  ---------

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(patient, weight)

DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% select(patid, weight, diabetes_condition)

DIA_Drug_Histories <- DIA_Drug_Histories %>% left_join(DANU_Demographics, by=c("patient"="patid", "weight"="weight"))

DIA_Drug_Histories %>% group_by(diabetes_condition) %>% summarise(n=sum(weight))


DIA_Box_Histories <- fread("DIA Box Histories.txt",  integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories <- DIA_Box_Histories %>% select(2,3,63)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(month60 = str_sub(month60, 2L, 2L))
names(DIA_Box_Histories)[3] <- "Box_m60"

DIA_Drug_Histories <- DIA_Drug_Histories %>% left_join(DIA_Box_Histories, by=c("patient"="patient", "weight"="weight"))

data.frame(DIA_Drug_Histories %>% group_by(Box_m60, diabetes_condition) %>% summarise(n=sum(weight)))

# ------



# Comorbidities based on stock -------------------------
DIA_Disorders <- fread("DIA Disorders.txt")

# Charlson index distribution
data.frame(DIA_Drug_Histories %>% left_join(DIA_Disorders %>% select(patient, charlson_index)) %>%
             group_by(charlson_index) %>% summarise(pats=sum(weight)))

# Charlson index distribution based on last stock
data.frame(DIA_Drug_Histories %>% left_join(DIA_Disorders %>% select(patient, charlson_index)) %>%
             group_by(charlson_index, Box_m60) %>% summarise(pats=sum(weight)) %>% spread(key = Box_m60, value = pats))

# Charlson index distribution at the time of each stock (global)
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Disorders_Histories <- fread("DIA Disorder Histories.txt")
DIA_Disorders_Histories <- Treatment_exp_Vector %>% left_join(DIA_Disorders_Histories)

DIA_Disorders_Histories <- gather(DIA_Disorders_Histories, Month, Charlson, month1:month60, factor_key=TRUE)
DIA_Disorders_Histories$Month <- as.character(DIA_Disorders_Histories$Month)
DIA_Disorders_Histories$Month <- parse_number(DIA_Disorders_Histories$Month)
DIA_Disorders_Histories$Charlson <- as.character(DIA_Disorders_Histories$Charlson)
DIA_Disorders_Histories$Charlson <- parse_number(DIA_Disorders_Histories$Charlson)
DIA_Disorders_Histories <- DIA_Disorders_Histories %>% select(-c(disease))

DIA_Box_Histories   <- fread("DIA Box Histories.txt")
DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Box, month1:month60, factor_key=TRUE)
DIA_Box_Histories$Month <- as.character(DIA_Box_Histories$Month)
DIA_Box_Histories$Month <- parse_number(DIA_Box_Histories$Month)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Box = str_sub(Box, 2L, 2L))
DIA_Box_Histories <- DIA_Box_Histories %>% select(-c(disease))
DIA_Box_Histories <- Treatment_exp_Vector %>% left_join(DIA_Box_Histories)

DIA_Disorders_Histories <- DIA_Disorders_Histories %>% left_join(DIA_Box_Histories)

data.frame(DIA_Disorders_Histories %>% group_by(Charlson, Box) %>% summarise(pats=sum(weight)) %>%
             spread(key = Box, value = pats))

Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Disorders <- fread("DIA Disorders.txt")
DIA_Disorders <- Treatment_exp_Vector %>% left_join(DIA_Disorders)
DIA_Disorders <- gather(DIA_Disorders, Disease, label, heart_attack:metastatic_cancer, factor_key=TRUE)
DIA_Disorders <- DIA_Disorders %>% filter(!is.na(label))

DIA_Disorders %>% group_by(Disease) %>% summarise(pats=sum(weight)) %>% arrange(-pats)

DIA_Box_Histories   <- fread("DIA Box Histories.txt")
DIA_Box_Histories <- DIA_Box_Histories %>% select(2,63)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(month60 = str_sub(month60, 2L, 2L))
DIA_Box_Histories <- Treatment_exp_Vector %>% left_join(DIA_Box_Histories)

data.frame(DIA_Box_Histories %>% left_join(DIA_Disorders) %>% group_by(month60, Disease) 
           %>% summarise(pats=sum(weight)) %>% spread(key=month60, value=pats))

# ------
# Interaction between rybelsus and different glp1 injectables -------------
DANU_Ingredients          <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients          <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients          <- DANU_Ingredients %>% select(molecule, generic_name, drug_group)
DANU_Ingredients$molecule <- as.character(DANU_Ingredients$molecule)


DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("47",d1)) %>% filter(grepl("47",d2)) %>% filter(s1=="G") %>%
  select(patient, weight, d1)

sum(DIA_Flows_Aux._Long$weight) # 20053.25

DIA_Flows_Aux._Long <- separate_rows(DIA_Flows_Aux._Long, d1, sep = ",", convert=T)

DIA_Flows_Aux._Long %>% left_join(DANU_Ingredients, by=c("d1"="molecule")) %>% filter(drug_group=="GLP1 Injectable") %>%
  group_by(generic_name) %>% summarise(n=sum(weight))

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(grepl("47",d1)) %>% filter(!grepl("47",d2)) %>% filter(s2=="G") %>%
  select(patient, weight, d2)

sum(DIA_Flows_Aux._Long$weight) # 15732

DIA_Flows_Aux._Long <- separate_rows(DIA_Flows_Aux._Long, d2, sep = ",", convert=T)

DIA_Flows_Aux._Long %>% left_join(DANU_Ingredients, by=c("d2"="molecule")) %>% filter(drug_group=="GLP1 Injectable") %>%
  group_by(generic_name) %>% summarise(n=sum(weight))


DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight, month60)

DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, month60, sep = ",", convert=T)

DIA_Drug_Histories %>% left_join(DANU_Ingredients, by=c("month60"="molecule")) %>% filter(drug_group=="GLP1 Injectable") %>%
  group_by(generic_name) %>% summarise(n=sum(weight))
# -----
# HbA1c reductions of patients eclusively on 1 or 2 therapies -----------------
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]

DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)

DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)


# Lookup Drugs
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Pick patients that had *ONLY* |Biguanide| AND |SGLT2|

Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_InjectableGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

Pats_Biguanide_SGLT2_only <- Pats_Biguanide_SGLT2_only %>% mutate(Therapy = ifelse(Drugs=="-","none", 
                                                                                   ifelse(grepl(string_Biguanide, Drugs) & grepl(string_SGLT2, Drugs),"Both",
                                                                                          ifelse(grepl(string_Biguanide, Drugs), "Biguanide", "SGLT2"))))


Pats_to_keep <- Pats_Biguanide_SGLT2_only %>% group_by(patient) %>% 
  filter(Therapy == "Biguanide" & 
           lead(Therapy, n=1L)=="Both" & lead(Therapy, n=2L)=="Both" & 
           lead(Therapy, n=3L)=="Both" & lead(Therapy, n=4L)=="Both" & 
           lead(Therapy, n=5L)=="Both" & lead(Therapy, n=6L)=="Both") %>%
  select(patient) %>% distinct()

Pats_Biguanide_SGLT2_only <- Pats_to_keep %>% left_join(Pats_Biguanide_SGLT2_only)

Pats_Biguanide_SGLT2_only <- Pats_Biguanide_SGLT2_only %>% left_join(DANU_Measures_HbA1c, by= c("patient"="patid", "weight"="weight", "Month"="Exact_Month"))

Pats_to_keep <- Pats_Biguanide_SGLT2_only %>% filter(!is.na(value)) %>% group_by(patient, Therapy) %>% count() %>% 
  filter(Therapy=="Biguanide"|Therapy=="Both") %>% ungroup() %>% group_by(patient) %>% count() %>% filter(n==2) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_only <- Pats_to_keep %>% left_join(Pats_Biguanide_SGLT2_only)

Pats_Biguanide_SGLT2_only %>% ungroup() %>% group_by(Therapy) %>% summarise(n = weighted.mean(value, weight, na.rm = T))

Pats_Biguanide_SGLT2_only %>% group_by(Therapy) %>% count()



# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj|

Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% mutate(Therapy = ifelse(Drugs=="-","none", 
                                                                                       ifelse(grepl(string_Biguanide, Drugs) & grepl(string_InjectableGLP1, Drugs),"Both",
                                                                                              ifelse(grepl(string_Biguanide, Drugs), "Biguanide", "InjectableGLP1"))))


Pats_to_keep <- Pats_Biguanide_GLP1Inj_only %>% group_by(patient) %>% 
  filter(Therapy == "Biguanide" & 
           lead(Therapy, n=1L)=="Both" & lead(Therapy, n=2L)=="Both" & 
           lead(Therapy, n=3L)=="Both" & lead(Therapy, n=4L)=="Both" & 
           lead(Therapy, n=5L)=="Both" & lead(Therapy, n=6L)=="Both") %>%
  select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- Pats_to_keep %>% left_join(Pats_Biguanide_GLP1Inj_only)

Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% left_join(DANU_Measures_HbA1c, by= c("patient"="patid", "weight"="weight", "Month"="Exact_Month"))

Pats_to_keep <- Pats_Biguanide_GLP1Inj_only %>% filter(!is.na(value)) %>% group_by(patient, Therapy) %>% count() %>% 
  filter(Therapy=="Biguanide"|Therapy=="Both") %>% ungroup() %>% group_by(patient) %>% count() %>% filter(n==2) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- Pats_to_keep %>% left_join(Pats_Biguanide_GLP1Inj_only)

Pats_Biguanide_GLP1Inj_only %>% group_by(Therapy) %>% summarise(n = weighted.mean(value, weight, na.rm = T)) 

Pats_Biguanide_GLP1Inj_only %>% group_by(Therapy) %>% count()



# Pick patients that had *ONLY* |SGLT2| AND |GLP1 Inj|

Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_Biguanide, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_SGLT2_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

Pats_SGLT2_GLP1Inj_only <- Pats_SGLT2_GLP1Inj_only %>% mutate(Therapy = ifelse(Drugs=="-","none", 
                                                                               ifelse(grepl(string_SGLT2, Drugs) & grepl(string_InjectableGLP1, Drugs),"Both",
                                                                                      ifelse(grepl(string_SGLT2, Drugs), "SGLT2", "InjectableGLP1"))))


Pats_to_keep <- Pats_SGLT2_GLP1Inj_only %>% group_by(patient) %>% 
  filter(Therapy == "SGLT2" & 
           lead(Therapy, n=1L)=="Both" & lead(Therapy, n=2L)=="Both" & 
           lead(Therapy, n=3L)=="Both" & lead(Therapy, n=4L)=="Both" & 
           lead(Therapy, n=5L)=="Both" & lead(Therapy, n=6L)=="Both") %>%
  select(patient) %>% distinct()

Pats_SGLT2_GLP1Inj_only <- Pats_to_keep %>% left_join(Pats_SGLT2_GLP1Inj_only)

Pats_SGLT2_GLP1Inj_only <- Pats_SGLT2_GLP1Inj_only %>% left_join(DANU_Measures_HbA1c, by= c("patient"="patid", "weight"="weight", "Month"="Exact_Month"))

Pats_SGLT2_GLP1Inj_only %>% ungroup() %>% group_by(Therapy) %>% summarise(n = weighted.mean(value, weight, na.rm = T))

Pats_to_keep <- Pats_SGLT2_GLP1Inj_only %>% filter(!is.na(value)) %>% group_by(patient, Therapy) %>% count() %>% 
  filter(Therapy=="SGLT2"|Therapy=="Both") %>% ungroup() %>% group_by(patient) %>% count() %>% filter(n==2) %>% select(patient) %>% distinct()

Pats_SGLT2_GLP1Inj_only <- Pats_to_keep %>% left_join(Pats_SGLT2_GLP1Inj_only)

Pats_SGLT2_GLP1Inj_only %>% group_by(Therapy) %>% summarise(n = weighted.mean(value, weight, na.rm = T)) 

Pats_SGLT2_GLP1Inj_only %>% group_by(Therapy) %>% count()



# Pick patients that had *ONLY* |BIGUANIDE|  AND  |SGLT2| AND |GLP1 Inj|

# Pats_to_remove <- DIA_Drug_Histories %>% 
#   mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
#                              grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs),1,0)) %>% 
#   filter(Toremove==1) %>% select(patient) %>% distinct()
# 
# Pats_Biguanide_SGLT2_Injectable_only <- DIA_Drug_Histories %>% 
#   anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)
# 
# Pats_Biguanide_SGLT2_Injectable_only <- Pats_Biguanide_SGLT2_Injectable_only %>% 
#                           mutate(Therapy = ifelse(Drugs=="-","none", 
#                           ifelse(grepl(string_Biguanide, Drugs)&!grepl(string_SGLT2, Drugs)&!grepl(string_InjectableGLP1, Drugs),"Biguanide",
#                           ifelse(grepl(string_SGLT2, Drugs) & grepl(string_InjectableGLP1, Drugs),"Both",
#                           ifelse(grepl(string_InjectableGLP1, Drugs), "InjectableGLP1", 
#                           ifelse(grepl(string_SGLT2, Drugs), "SGLT2", "other"))))))


# Pats_to_keep <- Pats_Biguanide_SGLT2_Injectable_only %>% group_by(patient) %>% 
#   filter(Therapy == "Biguanide" & 
#            lead(Therapy, n=1L)=="Both" & lead(Therapy, n=2L)=="Both" & 
#            lead(Therapy, n=3L)=="Both" & lead(Therapy, n=4L)=="Both" & 
#            lead(Therapy, n=5L)=="Both" & lead(Therapy, n=6L)=="Both") %>%
#   select(patient) %>% distinct()
# 
# Pats_Biguanide_SGLT2_Injectable_only <- Pats_to_keep %>% left_join(Pats_Biguanide_SGLT2_Injectable_only)

# Pats_Biguanide_SGLT2_Injectable_only <- Pats_Biguanide_SGLT2_Injectable_only %>% left_join(DANU_Measures_HbA1c, by= c("patient"="patid", "weight"="weight", "Month"="Exact_Month"))
# 
# Pats_to_keep <- Pats_Biguanide_SGLT2_Injectable_only %>% filter(!is.na(value)) %>% group_by(patient, Therapy) %>% count() %>% 
#   filter(Therapy=="Biguanide"|Therapy=="Both") %>% ungroup() %>% group_by(patient) %>% count() %>% filter(n==2) %>% select(patient) %>% distinct()
# 
# Pats_Biguanide_SGLT2_Injectable_only <- Pats_to_keep %>% left_join(Pats_Biguanide_SGLT2_Injectable_only)
# 
# Pats_Biguanide_SGLT2_Injectable_only %>% ungroup() %>% group_by(Therapy) %>% summarise(n = weighted.mean(value, weight, na.rm = T))


# --------
# Wegovy dosages over time ----------------------------------------------------------------------
DIA_Medications <- fread("DANU Medications.txt")

DIA_Medications <- DIA_Medications %>% filter(brand_name =="Wegovy") %>% select(drug_id, med_ingredient, med_strength)

Dia_US_Doses <- fread("DIA Doses.txt")

Dia_US_Doses <- Dia_US_Doses %>% filter(drug_group == "GLP1 Injectable") %>% left_join(DIA_Medications) %>% mutate(from_dt = as.Date(from_dt))

Dia_US_Doses$doses <- parse_number(Dia_US_Doses$med_strength)

Dia_US_Doses %>% filter(drug_group == "GLP1 Injectable") %>% 
  select(generic_name, dayssup, pat_id, from_dt, doses) %>% group_by(pat_id) %>% 
  summarise(n=n()) %>% arrange(-n)

unique(Dia_US_Doses$doses) #0.25 0.50 1.00 1.70 2.40
weighted.mean(Dia_US_Doses$doses, Dia_US_Doses$weight, na.rm=T) #0.7427677
weighted.median(Dia_US_Doses$doses, Dia_US_Doses$weight, na.rm=T) #0.375

Dia_US_Doses_Wegovy <- Dia_US_Doses %>% filter(drug_group == "GLP1 Injectable") %>% 
  select(generic_name, dayssup, pat_id, weight, from_dt, doses) 

Dia_US_Doses_Wegovy <- Dia_US_Doses_Wegovy %>% filter(!is.na(doses))

Dia_US_Doses_Wegovy_summary <- Dia_US_Doses_Wegovy %>% group_by(pat_id) %>% arrange(pat_id, from_dt) %>% 
  mutate(index = from_dt-lag(from_dt)) %>% ungroup() %>% mutate(index = as.numeric(index)) %>%
  mutate(index = ifelse(is.na(index), 0, index)) %>% group_by(pat_id) %>%
  mutate(time_progression = cumsum(index)) %>% select(-c(generic_name, dayssup, index))

Dia_US_Doses_Wegovy_summary %>% ungroup() %>% select(pat_id, doses, time_progression) %>%
  ggplot(aes(x=time_progression, y=doses, fill=doses, colour=-doses))+
  geom_jitter(height =0.1, width = 0.1, show.legend = F, alpha=0.8, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 20))+
  xlab("\nTime since therapy initiation (days)")+
  ylab("Dosage Prescribed\n")+
  scale_y_continuous(breaks = c(0.25, 0.5, 1, 1.7, 2.4))

length(unique(Dia_US_Doses_Wegovy_summary$pat_id)) #28




# Ozempic dosages over time ----------------------------------------------------------------------
DIA_Medications <- fread("DANU Medications.txt")

DIA_Medications <- DIA_Medications %>% filter(brand_name =="Ozempic") %>% select(drug_id, med_ingredient, med_strength)

Dia_US_Doses <- fread("DIA Doses.txt")

Dia_US_Doses <- Dia_US_Doses %>% filter(drug_group == "GLP1 Injectable") %>% left_join(DIA_Medications) %>% mutate(from_dt = as.Date(from_dt))

Dia_US_Doses$doses <- parse_number(Dia_US_Doses$med_strength)

Dia_US_Doses %>% filter(drug_group == "GLP1 Injectable") %>% 
  select(generic_name, dayssup, pat_id, from_dt, doses) %>% group_by(pat_id) %>% 
  summarise(n=n()) %>% arrange(-n)

unique(Dia_US_Doses$doses) #2 1.00 0.25
weighted.mean(Dia_US_Doses$doses, Dia_US_Doses$weight, na.rm=T) #1.980051
weighted.median(Dia_US_Doses$doses, Dia_US_Doses$weight, na.rm=T) #1.5

Dia_US_Doses_Ozempic <- Dia_US_Doses %>% filter(drug_group == "GLP1 Injectable") %>% 
  select(generic_name, dayssup, pat_id, weight, from_dt, doses) 

Dia_US_Doses_Ozempic <- Dia_US_Doses_Ozempic %>% filter(!is.na(doses))

Dia_US_Doses_Ozempic_summary <- Dia_US_Doses_Ozempic %>% group_by(pat_id) %>% arrange(pat_id, from_dt) %>% 
  mutate(index = from_dt-lag(from_dt)) %>% ungroup() %>% mutate(index = as.numeric(index)) %>%
  mutate(index = ifelse(is.na(index), 0, index)) %>% group_by(pat_id) %>%
  mutate(time_progression = cumsum(index)) %>% select(-c(generic_name, dayssup, index))

Dia_US_Doses_Ozempic_summary %>% ungroup() %>% select(pat_id, doses, time_progression) %>%
  ggplot(aes(x=time_progression, y=doses, fill=doses, colour=-doses))+
  geom_jitter(height =0.4, width = 0.1, show.legend = F, alpha=0.1, size=1)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 20))+
  xlab("\nTime since therapy initiation (days)")+
  ylab("Dosage Prescribed\n")+
  scale_y_continuous(breaks = c(0.25, 1,2))

length(unique(Dia_US_Doses_Ozempic_summary$pat_id)) #13080


Dia_US_Doses_Ozempic_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% slice_head() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))



Dia_US_Doses_Ozempic_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=30) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))


Dia_US_Doses_Ozempic_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=60) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))


Dia_US_Doses_Ozempic_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=90) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))


Dia_US_Doses_Ozempic_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=120) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))

Dia_US_Doses_Ozempic_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=150) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))

Dia_US_Doses_Ozempic_summary %>% ungroup() %>% 
  left_join(Dia_US_Doses %>% select(pat_id, weight) %>% distinct()) %>%
  group_by(pat_id) %>% filter(time_progression <=180) %>% slice_tail() %>% ungroup() %>% group_by(doses) %>% summarise(n=sum(as.numeric(weight)))


# ------
# Restarts (same stock, same drug, etc) --------------
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

# 6826295 re_starts in the last year
DIA_Flows_Aux._Long %>% mutate(p1=as.numeric(p1)) %>% filter(p1>=48)%>% 
  filter(re_starts=="1") %>% summarise(pats=sum(as.numeric(weight)))

# Pats with restarts in the last year
Pats_keep <- DIA_Flows_Aux._Long %>% mutate(p1=as.numeric(p1)) %>% filter(p1>=48) %>% filter(re_starts=="1") %>% select(patient) %>% distinct()

DIA_Flows_Aux._Long <- Pats_keep %>% left_join(DIA_Flows_Aux._Long)

# keep everything until last re_start
DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long %>% 
  group_by(patient)%>% slice(1:max(which(re_starts == "1")))

# 6826295 re_starts in the last year
DIA_Flows_Aux._Long %>% mutate(p1=as.numeric(p1)) %>% filter(p1>=48)%>% 
  filter(re_starts=="1") %>% summarise(pats=sum(as.numeric(weight)))

# pick months of stops and restarts
DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long_2 %>% group_by(patient) %>% filter(stops=="1" | re_starts=="1")

# remove unnecessary cols
DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long_2  %>% select(-c(disease, flow, p1_RxExp, starts))

DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long_2 %>% group_by(patient) %>% 
  mutate(Stock_comp = ifelse(re_starts=="1" & s2==lag(s1), "Same", "diff"))

DIA_Flows_Aux._Long_2 <- DIA_Flows_Aux._Long_2 %>% group_by(patient) %>% 
  mutate(Drugs_comp = ifelse(re_starts=="1" & d2==lag(d1), "Same", "diff"))

DIA_Flows_Aux._Long_2 %>% ungroup() %>% mutate(p1=as.numeric(p1)) %>% filter(p1>=48) %>% filter(re_starts=="1") %>% 
  group_by(Stock_comp, Drugs_comp) %>% summarise(pats=sum(as.numeric(weight)))



data.frame(DIA_Flows_Aux._Long_2 %>% ungroup() %>% mutate(p1=as.numeric(p1)) %>% filter(p1>=48) %>% filter(re_starts=="1") %>% 
             group_by(s2, Stock_comp, Drugs_comp) %>% summarise(pats=sum(as.numeric(weight))))

# -------
# Total Durations on each class over 60 months------------------------------------------------------------
# GLP1 Injectable
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('48',.), ~replace(., grepl('48', .), "GLP1 Injectable"))%>% 
  mutate_if(grepl('49',.), ~replace(., grepl('49', .), "GLP1 Injectable"))%>% 
  mutate_if(grepl('50',.), ~replace(., grepl('50', .), "GLP1 Injectable"))%>% 
  mutate_if(grepl('51',.), ~replace(., grepl('51', .), "GLP1 Injectable"))%>% 
  mutate_if(grepl('52',.), ~replace(., grepl('52', .), "GLP1 Injectable"))%>% 
  mutate_if(grepl('53',.), ~replace(., grepl('53', .), "GLP1 Injectable"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1 Injectable",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

GLP1_Injectable_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(GLP1_Injectable_Periods)[3] <- "Duration"
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% left_join(DIA_Drug_Histories) 
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% mutate(weight = as.numeric(weight))
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% distinct()

library(spatstat)
weighted.mean(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight)  # 17.3716
weighted.median(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight) # 10.5

data.frame(GLP1_Injectable_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))


GLP1_Injectable_Periods %>% 
  mutate(Total_Duration_bucket = ifelse(Total_Duration == 1, "1", 
                                        ifelse(Total_Duration >1 & Total_Duration < 6, "2 to 6",
                                               ifelse(Total_Duration>=6 & Total_Duration <12, "6 to 12",
                                                      ifelse(Total_Duration>=12&Total_Duration<24, "12 to 24",
                                                             ifelse(Total_Duration>=24&Total_Duration<36, "24 to 36",
                                                                    ifelse(Total_Duration>=36&Total_Duration<48, "36 to 48",
                                                                           ifelse(Total_Duration>=48&Total_Duration<60, "48 to 60", "60")))))))) %>%
  group_by(Total_Duration_bucket) %>%
  summarise(pats = sum(weight))


# GLP1 Oral
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('47',.), ~replace(., grepl('47', .), "GLP1 Oral"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1 Oral",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

GLP1_Oral_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(GLP1_Oral_Periods)[3] <- "Duration"
GLP1_Oral_Periods <- GLP1_Oral_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
GLP1_Oral_Periods <- GLP1_Oral_Periods %>% left_join(DIA_Drug_Histories) 
GLP1_Oral_Periods <- GLP1_Oral_Periods %>% mutate(weight = as.numeric(weight))
GLP1_Oral_Periods <- GLP1_Oral_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
GLP1_Oral_Periods <- GLP1_Oral_Periods %>% distinct()

library(spatstat)
weighted.mean(GLP1_Oral_Periods$Total_Duration, GLP1_Oral_Periods$weight)  # 4.285284
weighted.median(GLP1_Oral_Periods$Total_Duration, GLP1_Oral_Periods$weight) # 2.5

data.frame(GLP1_Oral_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))


GLP1_Oral_Periods %>% 
  mutate(Total_Duration_bucket = ifelse(Total_Duration == 1, "1", 
                                        ifelse(Total_Duration >1 & Total_Duration < 6, "2 to 6",
                                               ifelse(Total_Duration>=6 & Total_Duration <12, "6 to 12",
                                                      ifelse(Total_Duration>=12&Total_Duration<24, "12 to 24",
                                                             ifelse(Total_Duration>=24&Total_Duration<36, "24 to 36",
                                                                    ifelse(Total_Duration>=36&Total_Duration<48, "36 to 48",
                                                                           ifelse(Total_Duration>=48&Total_Duration<60, "48 to 60", "60")))))))) %>%
  group_by(Total_Duration_bucket) %>%
  summarise(pats = sum(weight))


# Insulin
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('38',.), ~replace(., grepl('38', .), "Insulin")) %>% 
  mutate_if(grepl('39',.), ~replace(., grepl('39', .), "Insulin")) %>% 
  mutate_if(grepl('40',.), ~replace(., grepl('40', .), "Insulin")) %>% 
  mutate_if(grepl('41',.), ~replace(., grepl('41', .), "Insulin")) %>% 
  mutate_if(grepl('42',.), ~replace(., grepl('42', .), "Insulin")) %>% 
  mutate_if(grepl('43',.), ~replace(., grepl('43', .), "Insulin")) %>% 
  mutate_if(grepl('44',.), ~replace(., grepl('44', .), "Insulin")) %>% 
  mutate_if(grepl('45',.), ~replace(., grepl('45', .), "Insulin")) %>% 
  mutate_if(grepl('46',.), ~replace(., grepl('46', .), "Insulin"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Insulin",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

Insulin_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(Insulin_Periods)[3] <- "Duration"
Insulin_Periods <- Insulin_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
Insulin_Periods <- Insulin_Periods %>% left_join(DIA_Drug_Histories) 
Insulin_Periods <- Insulin_Periods %>% mutate(weight = as.numeric(weight))
Insulin_Periods <- Insulin_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
Insulin_Periods <- Insulin_Periods %>% distinct()

library(spatstat)
weighted.mean(Insulin_Periods$Total_Duration, Insulin_Periods$weight)  # 22.82028
weighted.median(Insulin_Periods$Total_Duration, Insulin_Periods$weight) #  13.5

data.frame(Insulin_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))


Insulin_Periods %>% 
  mutate(Total_Duration_bucket = ifelse(Total_Duration == 1, "1", 
                                        ifelse(Total_Duration >1 & Total_Duration < 6, "2 to 6",
                                               ifelse(Total_Duration>=6 & Total_Duration <12, "6 to 12",
                                                      ifelse(Total_Duration>=12&Total_Duration<24, "12 to 24",
                                                             ifelse(Total_Duration>=24&Total_Duration<36, "24 to 36",
                                                                    ifelse(Total_Duration>=36&Total_Duration<48, "36 to 48",
                                                                           ifelse(Total_Duration>=48&Total_Duration<60, "48 to 60", "60")))))))) %>%
  group_by(Total_Duration_bucket) %>%
  summarise(pats = sum(weight))



# SGLT2
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('34',.), ~replace(., grepl('34', .), "SGLT2")) %>% 
  mutate_if(grepl('35',.), ~replace(., grepl('35', .), "SGLT2")) %>% 
  mutate_if(grepl('36',.), ~replace(., grepl('36', .), "SGLT2")) %>% 
  mutate_if(grepl('37',.), ~replace(., grepl('37', .), "SGLT2")) 
 
DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

SGLT2_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(SGLT2_Periods)[3] <- "Duration"
SGLT2_Periods <- SGLT2_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
SGLT2_Periods <- SGLT2_Periods %>% left_join(DIA_Drug_Histories) 
SGLT2_Periods <- SGLT2_Periods %>% mutate(weight = as.numeric(weight))
SGLT2_Periods <- SGLT2_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
SGLT2_Periods <- SGLT2_Periods %>% distinct()

library(spatstat)
weighted.mean(SGLT2_Periods$Total_Duration, SGLT2_Periods$weight)  # 18.29962
weighted.median(SGLT2_Periods$Total_Duration, SGLT2_Periods$weight) # 10.5

data.frame(SGLT2_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))


SGLT2_Periods %>% 
  mutate(Total_Duration_bucket = ifelse(Total_Duration == 1, "1", 
                                        ifelse(Total_Duration >1 & Total_Duration < 6, "2 to 6",
                                               ifelse(Total_Duration>=6 & Total_Duration <12, "6 to 12",
                                                      ifelse(Total_Duration>=12&Total_Duration<24, "12 to 24",
                                                             ifelse(Total_Duration>=24&Total_Duration<36, "24 to 36",
                                                                    ifelse(Total_Duration>=36&Total_Duration<48, "36 to 48",
                                                                           ifelse(Total_Duration>=48&Total_Duration<60, "48 to 60", "60")))))))) %>%
  group_by(Total_Duration_bucket) %>%
  summarise(pats = sum(weight))



# DPP4
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('30',.), ~replace(., grepl('30', .), "DPP4")) %>% 
  mutate_if(grepl('31',.), ~replace(., grepl('31', .), "DPP4")) %>% 
  mutate_if(grepl('32',.), ~replace(., grepl('32', .), "DPP4")) %>% 
  mutate_if(grepl('33',.), ~replace(., grepl('33', .), "DPP4")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="DPP4",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

DPP4_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(DPP4_Periods)[3] <- "Duration"
DPP4_Periods <- DPP4_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
DPP4_Periods <- DPP4_Periods %>% left_join(DIA_Drug_Histories) 
DPP4_Periods <- DPP4_Periods %>% mutate(weight = as.numeric(weight))
DPP4_Periods <- DPP4_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
DPP4_Periods <- DPP4_Periods %>% distinct()

library(spatstat)
weighted.mean(DPP4_Periods$Total_Duration, DPP4_Periods$weight)  # 21.73646
weighted.median(DPP4_Periods$Total_Duration, DPP4_Periods$weight) #14.5

data.frame(DPP4_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))


DPP4_Periods %>% 
  mutate(Total_Duration_bucket = ifelse(Total_Duration == 1, "1", 
                                        ifelse(Total_Duration >1 & Total_Duration < 6, "2 to 6",
                                               ifelse(Total_Duration>=6 & Total_Duration <12, "6 to 12",
                                                      ifelse(Total_Duration>=12&Total_Duration<24, "12 to 24",
                                                             ifelse(Total_Duration>=24&Total_Duration<36, "24 to 36",
                                                                    ifelse(Total_Duration>=36&Total_Duration<48, "36 to 48",
                                                                           ifelse(Total_Duration>=48&Total_Duration<60, "48 to 60", "60")))))))) %>%
  group_by(Total_Duration_bucket) %>%
  summarise(pats = sum(weight))


# Antidiabetic
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('14',.), ~replace(., grepl('14', .), "Antidiabetic")) %>% 
  mutate_if(grepl('15',.), ~replace(., grepl('15', .), "Antidiabetic")) %>% 
  mutate_if(grepl('16',.), ~replace(., grepl('16', .), "Antidiabetic")) %>% 
  mutate_if(grepl('17',.), ~replace(., grepl('17', .), "Antidiabetic")) %>%
  mutate_if(grepl('18',.), ~replace(., grepl('18', .), "Antidiabetic")) %>% 
  mutate_if(grepl('19',.), ~replace(., grepl('19', .), "Antidiabetic")) %>% 
  mutate_if(grepl('20',.), ~replace(., grepl('20', .), "Antidiabetic")) %>% 
  mutate_if(grepl('21',.), ~replace(., grepl('21', .), "Antidiabetic")) %>%
  mutate_if(grepl('22',.), ~replace(., grepl('22', .), "Antidiabetic")) %>% 
  mutate_if(grepl('23',.), ~replace(., grepl('23', .), "Antidiabetic")) %>% 
  mutate_if(grepl('24',.), ~replace(., grepl('24', .), "Antidiabetic")) %>% 
  mutate_if(grepl('25',.), ~replace(., grepl('25', .), "Antidiabetic")) %>%
  mutate_if(grepl('26',.), ~replace(., grepl('26', .), "Antidiabetic")) %>% 
  mutate_if(grepl('27',.), ~replace(., grepl('27', .), "Antidiabetic")) %>% 
  mutate_if(grepl('28',.), ~replace(., grepl('28', .), "Antidiabetic")) %>% 
  mutate_if(grepl('29',.), ~replace(., grepl('29', .), "Antidiabetic")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Antidiabetic",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

Antidiabetic_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(Antidiabetic_Periods)[3] <- "Duration"
Antidiabetic_Periods <- Antidiabetic_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
Antidiabetic_Periods <- Antidiabetic_Periods %>% left_join(DIA_Drug_Histories) 
Antidiabetic_Periods <- Antidiabetic_Periods %>% mutate(weight = as.numeric(weight))
Antidiabetic_Periods <- Antidiabetic_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
Antidiabetic_Periods <- Antidiabetic_Periods %>% distinct()

library(spatstat)
weighted.mean(Antidiabetic_Periods$Total_Duration, Antidiabetic_Periods$weight)  # 26.74429
weighted.median(Antidiabetic_Periods$Total_Duration, Antidiabetic_Periods$weight) # 22.5

data.frame(Antidiabetic_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))


Antidiabetic_Periods %>% 
  mutate(Total_Duration_bucket = ifelse(Total_Duration == 1, "1", 
                                        ifelse(Total_Duration >1 & Total_Duration < 6, "2 to 6",
                                               ifelse(Total_Duration>=6 & Total_Duration <12, "6 to 12",
                                                      ifelse(Total_Duration>=12&Total_Duration<24, "12 to 24",
                                                             ifelse(Total_Duration>=24&Total_Duration<36, "24 to 36",
                                                                    ifelse(Total_Duration>=36&Total_Duration<48, "36 to 48",
                                                                           ifelse(Total_Duration>=48&Total_Duration<60, "48 to 60", "60")))))))) %>%
  group_by(Total_Duration_bucket) %>%
  summarise(pats = sum(weight))


# Biguanide
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('(^|\\D)(1{1})(\\D|$)',.), ~replace(., grepl('(^|\\D)(1{1})(\\D|$)', .), "Biguanide"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Biguanide",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

Biguanide_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(Biguanide_Periods)[3] <- "Duration"
Biguanide_Periods <- Biguanide_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
Biguanide_Periods <- Biguanide_Periods %>% left_join(DIA_Drug_Histories) 
Biguanide_Periods <- Biguanide_Periods %>% mutate(weight = as.numeric(weight))
Biguanide_Periods <- Biguanide_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
Biguanide_Periods <- Biguanide_Periods %>% distinct()

library(spatstat)
weighted.mean(Biguanide_Periods$Total_Duration, Biguanide_Periods$weight)  # 27.60358
weighted.median(Biguanide_Periods$Total_Duration, Biguanide_Periods$weight) # 23.5

data.frame(Biguanide_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))


Biguanide_Periods %>% 
  mutate(Total_Duration_bucket = ifelse(Total_Duration == 1, "1", 
                                        ifelse(Total_Duration >1 & Total_Duration < 6, "2 to 6",
                                               ifelse(Total_Duration>=6 & Total_Duration <12, "6 to 12",
                                                      ifelse(Total_Duration>=12&Total_Duration<24, "12 to 24",
                                                             ifelse(Total_Duration>=24&Total_Duration<36, "24 to 36",
                                                                    ifelse(Total_Duration>=36&Total_Duration<48, "36 to 48",
                                                                           ifelse(Total_Duration>=48&Total_Duration<60, "48 to 60", "60")))))))) %>%
  group_by(Total_Duration_bucket) %>%
  summarise(pats = sum(weight))



# -----
# % of patients on each stock FLow vs no flow + hbA1c -------------------------------------------
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- Treatment_exp_Vector  %>% left_join(DIA_Flows_Aux._Long)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2, stops, flow)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1 = as.numeric(p1)) %>% filter(p1>=48)

Patient_Stocks_m60 <- DIA_Flows_Aux._Long %>% filter(p2 == "60") %>% select(patient, weight, s2)
Patient_flows_12m <- DIA_Flows_Aux._Long %>% filter(stops!=1) %>% group_by(patient) %>% summarise(flows = sum(as.numeric(flow)))
Patient_Stocks_m60 <- Patient_Stocks_m60 %>% left_join(Patient_flows_12m)

# How many pats in each sotck at m60, OKAY
Patient_Stocks_m60 %>% group_by(s2) %>% summarise(n=sum(weight))

# How many with vs without flow last 12months
Patient_Stocks_m60 <- Patient_Stocks_m60 %>% mutate(flows = ifelse(flows == 0, "NONE", "FLOW"))

Patient_Stocks_m60 %>% group_by(s2, flows) %>% summarise(n=sum(weight))


#   HbA1cs #
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) %>% filter(vague == 0)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% group_by(patid) %>% slice_tail()

Patient_Stocks_m60 %>% filter(flows == "NONE") %>% 
  left_join(DANU_Measures_HbA1c %>% select(patid, value), by=c("patient"="patid")) %>%
  filter(!is.na(value)) %>% mutate(value = ifelse(value > 7, "Above7", "Below7")) %>%
  group_by(s2, value) %>% summarise(n=sum(weight))



# Removing those who have done only Intraflows of Insulin

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))

string_Insulin <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")

Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- Treatment_exp_Vector  %>% left_join(DIA_Flows_Aux._Long)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2, flow)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1 = as.numeric(p1)) %>% filter(p1>=48)

Patient_Stocks_m60 <- DIA_Flows_Aux._Long %>% filter(p2 == "60") %>% select(patient, weight, s2)
Patient_Stocks_m60 %>% group_by(s2) %>% summarise(n=sum(weight))

data <- DIA_Flows_Aux._Long

# Insulin Therapy class - flags
data <- data[, Insulin_d1 := unlist(lapply(d1, function(x) ifelse(str_detect(x, string_Insulin), str_c(unlist(str_extract_all(x, string_Insulin)), collapse = ","),"")))]
data <- data[, Insulin_d2 := unlist(lapply(d2, function(x) ifelse(str_detect(x, string_Insulin), str_c(unlist(str_extract_all(x, string_Insulin)), collapse = ","),"")))]
data <- data[, nr_Insulin_d1 := unlist(lapply(d1, function(x) mapply(function (x) sum(str_detect(x, string_Insulin)*1), str_split(x,","))))]
data <- data[, nr_Insulin_d2 := unlist(lapply(d2, function(x) mapply(function (x) sum(str_detect(x, string_Insulin)*1), str_split(x,","))))]
data <- data[, nr_InsulinUnq_d1d2 := .(apply(.SD, 1, function(x) sum((unique(unlist(str_split(str_c(x,","),","))) != "")*1))), ,.SDcols = c("Insulin_d1","Insulin_d2")] 
data <- data[, Insulin_flow_type := ifelse(nr_Insulin_d2 < nr_Insulin_d1 & nr_InsulinUnq_d1d2 > nr_Insulin_d1, "D+S", 
                                           ifelse(nr_Insulin_d2 > nr_Insulin_d1 & nr_InsulinUnq_d1d2 > nr_Insulin_d2, "A+S",
                                                  ifelse(nr_Insulin_d2 < nr_Insulin_d1, "D", 
                                                         ifelse(nr_Insulin_d2 > nr_Insulin_d1, "A", 
                                                                ifelse(nr_Insulin_d2 == nr_Insulin_d1 & Insulin_d2 != Insulin_d1, "S","-")))))] 


data2 <- data %>% mutate(flow = ifelse((s1==s2) & Insulin_flow_type != "-", 0, flow)) 

Patient_flows_12m <- data2 %>% group_by(patient) %>% summarise(flows = sum(as.numeric(flow)))
Patient_Stocks_m60 <- Patient_Stocks_m60 %>% left_join(Patient_flows_12m)
Patient_Stocks_m60 <- Patient_Stocks_m60 %>% mutate(flows = ifelse(flows == 0, "NONE", "FLOW"))
Patient_Stocks_m60 %>% group_by(s2, flows) %>% summarise(n=sum(weight))

                                             
# ------
# HbA1c distribution Rybelsus 10k pats -------------------
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("RYBE Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]

DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))

#30951 (out of 34129, month out of range)

plot1 <- DANU_Measures_HbA1c %>% group_by(patid) %>% count()  

plot1 %>%
  filter(n<=100)%>%
  ggplot(aes(n))+
  geom_histogram(bins=100,fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  ylab("Number of Rybelsus Patients\n")+
  xlab("\nNumber of HbA1c Reads")


Last_read <- DANU_Measures_HbA1c %>% group_by(patid) %>% slice(n())

# last read = 4057

Last_read %>% filter(value>7) # 2364

# 58% (Last read > 7 !)

Last_read %>% group_by(value) %>%
  ggplot(aes(value))+
  geom_histogram(bins=40, fill="deepskyblue4", colour="deepskyblue4", alpha=0.9)+
  theme(panel.background = element_blank())+
  #xlim(4,10)+
  ylab("Number of Rybelsus Patients\n")+
  xlab("\nLast HbA1c read (%)")

length(unique(Last_read$patid)) #129502


mean(Last_read$value)
median(Last_read$value)



# ----------


# HbA1c reductions of patients eclusively on 1 or 2 therapies -----------------
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("RYBE Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]

DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 

DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)


# Lookup Drugs
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("RYBE Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Pick patients that had *ONLY* |Biguanide| AND |Rybelsus|

Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_SGLT2, Drugs)|
                             grepl(string_InjectableGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_Rybelsus_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

Pats_Biguanide_Rybelsus_only <- Pats_Biguanide_Rybelsus_only %>% mutate(Therapy = ifelse(Drugs=="-","none", 
                                                                                         ifelse(grepl(string_Biguanide, Drugs) & grepl(string_OralGLP1, Drugs),"Both",
                                                                                                ifelse(grepl(string_Biguanide, Drugs), "Biguanide", "Rybelsus"))))


Pats_to_keep <- Pats_Biguanide_Rybelsus_only %>% group_by(patient) %>% 
  filter(Therapy == "Biguanide" & 
           lead(Therapy, n=1L)=="Both" & lead(Therapy, n=2L)=="Both" & 
           lead(Therapy, n=3L)=="Both" & lead(Therapy, n=4L)=="Both" & 
           lead(Therapy, n=5L)=="Both" & lead(Therapy, n=6L)=="Both") %>%
  select(patient) %>% distinct()

Pats_Biguanide_Rybelsus_only <- Pats_to_keep %>% left_join(Pats_Biguanide_Rybelsus_only)

Pats_Biguanide_Rybelsus_only <- Pats_Biguanide_Rybelsus_only %>% left_join(DANU_Measures_HbA1c, by= c("patient"="patid", "weight"="weight", "Month"="Exact_Month"))

Pats_to_keep <- Pats_Biguanide_Rybelsus_only %>% filter(!is.na(value)) %>% group_by(patient, Therapy) %>% count() %>% 
  filter(Therapy=="Biguanide"|Therapy=="Both") %>% ungroup() %>% group_by(patient) %>% count() %>% filter(n==2) %>% select(patient) %>% distinct()

Pats_Biguanide_Rybelsus_only <- Pats_to_keep %>% left_join(Pats_Biguanide_Rybelsus_only)

Pats_Biguanide_Rybelsus_only %>% ungroup() %>% group_by(Therapy) %>% summarise(n = weighted.mean(value, weight, na.rm = T))



Pats_Biguanide_Rybelsus_only %>% group_by(Therapy) %>% count()



# # Pick patients that had *ONLY* |SGLT2| AND |Rybelsus|
# 
# Pats_to_remove <- DIA_Drug_Histories %>% 
#   mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
#                              grepl(string_Insulin, Drugs)|grepl(string_Biguanide, Drugs)|
#                              grepl(string_InjectableGLP1, Drugs),1,0)) %>% 
#   filter(Toremove==1) %>% select(patient) %>% distinct()
# 
# Pats_SGLT2_Rybelsus_only <- DIA_Drug_Histories %>% 
#   anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)
# 
# Pats_SGLT2_Rybelsus_only <- Pats_SGLT2_Rybelsus_only %>% mutate(Therapy = ifelse(Drugs=="-","none", 
#                                                                                          ifelse(grepl(string_SGLT2, Drugs) & grepl(string_OralGLP1, Drugs),"Both",
#                                                                                                 ifelse(grepl(string_SGLT2, Drugs), "SGLT2", "Rybelsus"))))
# 
# 
# # Pats_to_keep <- Pats_SGLT2_Rybelsus_only %>% group_by(patient) %>% 
# #   filter(Therapy == "SGLT2" & 
# #            lead(Therapy, n=1L)=="Both" & lead(Therapy, n=2L)=="Both" & 
# #            lead(Therapy, n=3L)=="Both" & lead(Therapy, n=4L)=="Both" & 
# #            lead(Therapy, n=5L)=="Both" & lead(Therapy, n=6L)=="Both") %>%
# #   select(patient) %>% distinct()
# 
# #Pats_SGLT2_Rybelsus_only <- Pats_to_keep %>% left_join(Pats_SGLT2_Rybelsus_only)
# 
# Pats_SGLT2_Rybelsus_only <- Pats_SGLT2_Rybelsus_only %>% left_join(DANU_Measures_HbA1c, by= c("patient"="patid", "weight"="weight", "Month"="Exact_Month"))
# 
# Pats_to_keep <- Pats_SGLT2_Rybelsus_only %>% filter(!is.na(value)) %>% group_by(patient, Therapy) %>% count() %>% 
#   filter(Therapy=="SGLT2"|Therapy=="Both") %>% ungroup() %>% group_by(patient) %>% count() %>% filter(n==2) %>% select(patient) %>% distinct()
# 
# Pats_SGLT2_Rybelsus_only <- Pats_to_keep %>% left_join(Pats_SGLT2_Rybelsus_only)
# 
# Pats_SGLT2_Rybelsus_only %>% ungroup() %>% group_by(Therapy) %>% summarise(n = weighted.mean(value, weight, na.rm = T))
# 
# Pats_SGLT2_Rybelsus_only %>% group_by(Therapy) %>% count()




# Pick patients that had |SGLT2| AND |Rybelsus| regardless of concomitant therapy

Pats_SGLT2_Rybelsus <- DIA_Drug_Histories 

Pats_SGLT2_Rybelsus <- Pats_SGLT2_Rybelsus %>% mutate(Therapy = ifelse(Drugs=="-","none", 
                                                                       ifelse(grepl(string_SGLT2, Drugs) & grepl(string_OralGLP1, Drugs),"Both",
                                                                              ifelse(grepl(string_SGLT2, Drugs), "SGLT2", 
                                                                                     ifelse(grepl(string_OralGLP1, Drugs),"Rybelsus", "other")))))



Pats_SGLT2_Rybelsus <- Pats_SGLT2_Rybelsus %>% left_join(DANU_Measures_HbA1c, by= c("patient"="patid", "weight"="weight", "Month"="Exact_Month"))

Pats_to_keep <- Pats_SGLT2_Rybelsus %>% filter(!is.na(value)) %>% group_by(patient, Therapy) %>% count() %>% 
  filter(Therapy=="SGLT2"|Therapy=="Both") %>% ungroup() %>% group_by(patient) %>% count() %>% filter(n==2) %>% select(patient) %>% distinct()

Pats_SGLT2_Rybelsus <- Pats_to_keep %>% left_join(Pats_SGLT2_Rybelsus)

Pats_SGLT2_Rybelsus %>% ungroup() %>% group_by(Therapy) %>% summarise(n = weighted.mean(value, weight, na.rm = T))



Pats_SGLT2_Rybelsus %>% group_by(Therapy) %>% count()



# ----------


# GLP1 Oral ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("RYBE Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 Oral too zero, and GLP1 Oral to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('47',.), ~replace(., grepl('47', .), "GLP1Oral"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1Oral",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("RYBE Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON GLP1 Oral
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to GLP1 Oral
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Oral
DIA_Drug_Histories_FIRST_GLP1Oral <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1Oral)[3] <- "Month_First_GLP1Oral"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("RYBE Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Oral criteria
Patient_first_GLP1Oral<-  DIA_Drug_Histories_FIRST_GLP1Oral %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_GLP1Oral %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first GLP1 Oral month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_GLP1Oral, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_GLP1Oral <- as.numeric(DANU_Measures_HbA1c$Month_First_GLP1Oral)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before GLP1 Oral start and months after GLP1 Oral start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_GLP1Oral <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_GLP1Oral)
HbA1cs_before_GLP1Oral <- HbA1cs_before_GLP1Oral %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_GLP1Oral)[4] <- "Month_Prior"
names(HbA1cs_before_GLP1Oral)[3] <- "HbA1c_Prior"

HbA1cs_after_GLP1Oral <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_GLP1Oral)
HbA1cs_after_GLP1Oral <- HbA1cs_after_GLP1Oral %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_GLP1Oral)[4] <- "Month_After"
names(HbA1cs_after_GLP1Oral)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_GLP1Oral_BEFORE_vs_AFTER <- HbA1cs_before_GLP1Oral %>% full_join(HbA1cs_after_GLP1Oral)
HbA1cs_GLP1Oral_BEFORE_vs_AFTER <- HbA1cs_GLP1Oral_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_GLP1Oral_BEFORE_vs_AFTER$HbA1c_Prior) # 9.016223
mean(HbA1cs_GLP1Oral_BEFORE_vs_AFTER$HbA1c_After) # 7.608535

write.csv(HbA1cs_GLP1Oral_BEFORE_vs_AFTER, "HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k.csv")






# SGLT2 --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("RYBE Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2 too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('34',.), ~replace(., grepl('34', .), "SGLT2"))%>%
  mutate_if(grepl('35',.), ~replace(., grepl('35', .), "SGLT2"))%>%
  mutate_if(grepl('36',.), ~replace(., grepl('36', .), "SGLT2"))%>%
  mutate_if(grepl('37',.), ~replace(., grepl('37', .), "SGLT2"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("RYBE Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("RYBE Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_SGLT2 %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first SGLT2 month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_SGLT2 <- as.numeric(DANU_Measures_HbA1c$Month_First_SGLT2)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_SGLT2)
HbA1cs_before_SGLT2 <- HbA1cs_before_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_SGLT2)[4] <- "Month_Prior"
names(HbA1cs_before_SGLT2)[3] <- "HbA1c_Prior"

HbA1cs_after_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_SGLT2)
HbA1cs_after_SGLT2 <- HbA1cs_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_SGLT2)[4] <- "Month_After"
names(HbA1cs_after_SGLT2)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_before_SGLT2 %>% full_join(HbA1cs_after_SGLT2)
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior) # 9.202466
mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_After) # 7.324211

write.csv(HbA1cs_SGLT2_BEFORE_vs_AFTER, "HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE.csv")




# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("RYBE Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('34',.)&grepl('47',.), ~replace(., grepl('34', .)&grepl('47',.), "Combo")) %>%
  mutate_if(grepl('35',.)&grepl('47',.), ~replace(., grepl('35', .)&grepl('47',.), "Combo")) %>%
  mutate_if(grepl('36',.)&grepl('47',.), ~replace(., grepl('36', .)&grepl('47',.), "Combo")) %>%
  mutate_if(grepl('37',.)&grepl('47',.), ~replace(., grepl('37', .)&grepl('47',.), "Combo")) 


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("RYBE Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("RYBE Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Combo criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Combo %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Combo month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_Combo <- as.numeric(DANU_Measures_HbA1c$Month_First_Combo)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Combo <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < Month_First_Combo)
HbA1cs_before_Combo <- HbA1cs_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Combo)[4] <- "Month_Prior"
names(HbA1cs_before_Combo)[3] <- "HbA1c_Prior"

HbA1cs_after_Combo <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > Month_First_Combo)
HbA1cs_after_Combo <- HbA1cs_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_Combo)[4] <- "Month_After"
names(HbA1cs_after_Combo)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Combo_BEFORE_vs_AFTER <- HbA1cs_before_Combo %>% full_join(HbA1cs_after_Combo)
HbA1cs_Combo_BEFORE_vs_AFTER <- HbA1cs_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_Prior) # 9.614745
mean(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_After) # 7.792895

write.csv(HbA1cs_Combo_BEFORE_vs_AFTER, "HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE.csv")


# Summary evolution over time -------
HbA1c_Evolution_US_Rybelsus_10k <- fread("HbA1c_Evolution_US_Rybelsus_10k.csv")

HbA1c_Evolution_US_Rybelsus_10k %>% group_by(Therapy, Period) %>% summarise(n=median(HbA1c))





HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k <- fread("HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k.csv")
HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE <- fread("HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE.csv")
HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE <- fread("HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE.csv")

mean(HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k$HbA1c_Prior-HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k$HbA1c_After)
mean(HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE$HbA1c_Prior-HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE$HbA1c_After)
mean(HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE$HbA1c_Prior-HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE$HbA1c_After)


Pats_to_keep_paired <- HbA1c_Evolution_US_Rybelsus_10k %>% group_by(patient, Therapy) %>% filter(Month>=-12 & Month<=12) %>% 
  count() %>% filter(n%%2==0) %>% select(patient, Therapy)

HbA1c_Evolution_US_Rybelsus_10k <- Pats_to_keep_paired %>% left_join(HbA1c_Evolution_US_Rybelsus_10k)


HbA1c_Evolution_US_Rybelsus_10k %>% 
  group_by(Therapy, Month) %>%  
  ggplot(aes(x=Month, y=HbA1c, fill=Therapy, colour=Therapy))+
  geom_smooth(size=2.5, method = "loess", se=F )+
  ylab("HbA1c %\n")+
  xlab("\nMonth")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_colour_jama()+
  ggsci::scale_fill_jama()

# Minimum 6months away from start --------------
# GLP1 Oral ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("RYBE Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 Oral too zero, and GLP1 Oral to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('47',.), ~replace(., grepl('47', .), "GLP1Oral"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1Oral",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("RYBE Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON GLP1 Oral
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to GLP1 Oral
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Oral
DIA_Drug_Histories_FIRST_GLP1Oral <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1Oral)[3] <- "Month_First_GLP1Oral"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("RYBE Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Oral criteria
Patient_first_GLP1Oral<-  DIA_Drug_Histories_FIRST_GLP1Oral %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_GLP1Oral %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first GLP1 Oral month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_GLP1Oral, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_GLP1Oral <- as.numeric(DANU_Measures_HbA1c$Month_First_GLP1Oral)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before GLP1 Oral start and months after GLP1 Oral start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_GLP1Oral <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1Oral)-6)
HbA1cs_before_GLP1Oral <- HbA1cs_before_GLP1Oral %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_GLP1Oral)[4] <- "Month_Prior"
names(HbA1cs_before_GLP1Oral)[3] <- "HbA1c_Prior"

HbA1cs_after_GLP1Oral <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1Oral+6))
HbA1cs_after_GLP1Oral <- HbA1cs_after_GLP1Oral %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_GLP1Oral)[4] <- "Month_After"
names(HbA1cs_after_GLP1Oral)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_GLP1Oral_BEFORE_vs_AFTER <- HbA1cs_before_GLP1Oral %>% full_join(HbA1cs_after_GLP1Oral)
HbA1cs_GLP1Oral_BEFORE_vs_AFTER <- HbA1cs_GLP1Oral_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_GLP1Oral_BEFORE_vs_AFTER$HbA1c_Prior) # 8.804751
mean(HbA1cs_GLP1Oral_BEFORE_vs_AFTER$HbA1c_After) # 7.369359

write.csv(HbA1cs_GLP1Oral_BEFORE_vs_AFTER, "HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k.csv")






# SGLT2 --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("RYBE Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2 too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('34',.), ~replace(., grepl('34', .), "SGLT2"))%>%
  mutate_if(grepl('35',.), ~replace(., grepl('35', .), "SGLT2"))%>%
  mutate_if(grepl('36',.), ~replace(., grepl('36', .), "SGLT2"))%>%
  mutate_if(grepl('37',.), ~replace(., grepl('37', .), "SGLT2"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("RYBE Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("RYBE Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_SGLT2 %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first SGLT2 month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_SGLT2 <- as.numeric(DANU_Measures_HbA1c$Month_First_SGLT2)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2)-6)
HbA1cs_before_SGLT2 <- HbA1cs_before_SGLT2 %>% group_by(patient) %>%  summarize(across(everything(), max))
names(HbA1cs_before_SGLT2)[4] <- "Month_Prior"
names(HbA1cs_before_SGLT2)[3] <- "HbA1c_Prior"

HbA1cs_after_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2+6))
HbA1cs_after_SGLT2 <- HbA1cs_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_SGLT2)[4] <- "Month_After"
names(HbA1cs_after_SGLT2)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_before_SGLT2 %>% full_join(HbA1cs_after_SGLT2)
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior) # 8.99616
mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_After) # 7.512268

write.csv(HbA1cs_SGLT2_BEFORE_vs_AFTER, "HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE.csv")




# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("RYBE Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('34',.)&grepl('47',.), ~replace(., grepl('34', .)&grepl('47',.), "Combo")) %>%
  mutate_if(grepl('35',.)&grepl('47',.), ~replace(., grepl('35', .)&grepl('47',.), "Combo")) %>%
  mutate_if(grepl('36',.)&grepl('47',.), ~replace(., grepl('36', .)&grepl('47',.), "Combo")) %>%
  mutate_if(grepl('37',.)&grepl('47',.), ~replace(., grepl('37', .)&grepl('47',.), "Combo")) 


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("RYBE Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Measures_HbA1c <- fread("RYBE Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Combo criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Combo %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Combo month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

#convert to numeric
DANU_Measures_HbA1c$Exact_Month <- as.numeric(DANU_Measures_HbA1c$Exact_Month)
DANU_Measures_HbA1c$value <- as.numeric(DANU_Measures_HbA1c$value)
DANU_Measures_HbA1c$Month_First_Combo <- as.numeric(DANU_Measures_HbA1c$Month_First_Combo)
DANU_Measures_HbA1c$weight <- as.numeric(DANU_Measures_HbA1c$weight)

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Combo <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo-6))
HbA1cs_before_Combo <- HbA1cs_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Combo)[4] <- "Month_Prior"
names(HbA1cs_before_Combo)[3] <- "HbA1c_Prior"

HbA1cs_after_Combo <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+6))
HbA1cs_after_Combo <- HbA1cs_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_Combo)[4] <- "Month_After"
names(HbA1cs_after_Combo)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Combo_BEFORE_vs_AFTER <- HbA1cs_before_Combo %>% full_join(HbA1cs_after_Combo)
HbA1cs_Combo_BEFORE_vs_AFTER <- HbA1cs_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_Prior) # 9.311475
mean(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_After) # 7.520492

write.csv(HbA1cs_Combo_BEFORE_vs_AFTER, "HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE.csv")


# Summary evolution over time -------
HbA1c_Evolution_US_Rybelsus_10k <- fread("HbA1c_Evolution_US_Rybelsus_10k.csv")

HbA1c_Evolution_US_Rybelsus_10k %>% group_by(Therapy, Period) %>% summarise(n=mean(HbA1c))


HbA1c_Evolution_US_Rybelsus_10k %>% group_by(Therapy, Period) %>% summarise(n=median(HbA1c))


HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k <- fread("HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k.csv")
HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE <- fread("HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE.csv")
HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE <- fread("HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE.csv")

mean(HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k$HbA1c_Prior-HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k$HbA1c_After)
mean(HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE$HbA1c_Prior-HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE$HbA1c_After)
mean(HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE$HbA1c_Prior-HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE$HbA1c_After)

median(HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k$HbA1c_Prior-HbA1cs_GLP1Oral_BEFORE_vs_AFTER_closest_Rybelsus_10k$HbA1c_After)
median(HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE$HbA1c_Prior-HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_RYBE$HbA1c_After)
median(HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE$HbA1c_Prior-HbA1cs_Combo_BEFORE_vs_AFTER_closest_RYBE$HbA1c_After)


Pats_to_keep_paired <- HbA1c_Evolution_US_Rybelsus_10k %>% group_by(patient, Therapy) %>% filter(Month>=-12 & Month<=12) %>% 
  count() %>% filter(n%%2==0) %>% select(patient, Therapy)

HbA1c_Evolution_US_Rybelsus_10k <- Pats_to_keep_paired %>% left_join(HbA1c_Evolution_US_Rybelsus_10k)


HbA1c_Evolution_US_Rybelsus_10k %>% 
  group_by(Therapy, Month) %>%  
  ggplot(aes(x=Month, y=HbA1c, fill=Therapy, colour=Therapy))+
  geom_smooth(size=2.5, method = "loess", se=F )+
  ylab("HbA1c %\n")+
  xlab("\nMonth")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  scale_colour_viridis_d()+
  scale_colour_viridis_d()



# ------
# Minimum 6months away from start ALL PATIENTS --------------
# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('48',.), ~replace(., grepl('48', .), "GLP1Injectable")) %>%
  mutate_if(grepl('49',.), ~replace(., grepl('49', .), "GLP1Injectable")) %>%
  mutate_if(grepl('50',.), ~replace(., grepl('50', .), "GLP1Injectable")) %>%
  mutate_if(grepl('51',.), ~replace(., grepl('51', .), "GLP1Injectable")) %>%
  mutate_if(grepl('52',.), ~replace(., grepl('52', .), "GLP1Injectable")) %>%
  mutate_if(grepl('53',.), ~replace(., grepl('53', .), "GLP1Injectable")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1Injectable",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1Injectable <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1Injectable)[3] <- "Month_First_GLP1Injectable"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1Injectable<-  DIA_Drug_Histories_FIRST_GLP1Injectable %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_GLP1Injectable %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first GLP1 Injectable month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_GLP1Injectable, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_GLP1Injectable <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1Injectable)-6)
HbA1cs_before_GLP1Injectable <- HbA1cs_before_GLP1Injectable %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_GLP1Injectable)[4] <- "Month_Prior"
names(HbA1cs_before_GLP1Injectable)[3] <- "HbA1c_Prior"

HbA1cs_after_GLP1Injectable <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1Injectable+6))
HbA1cs_after_GLP1Injectable <- HbA1cs_after_GLP1Injectable %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_GLP1Injectable)[4] <- "Month_After"
names(HbA1cs_after_GLP1Injectable)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- HbA1cs_before_GLP1Injectable %>% full_join(HbA1cs_after_GLP1Injectable)
HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- HbA1cs_GLP1Injectable_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_Prior) # 8.776789
mean(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_After) # 6.937497

median(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_Prior) # 8.4
median(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_After) # 6.8
write.csv(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER, "HbA1cs_GLP1Injectable_BEFORE_vs_AFTER_closest_6months.csv")
HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- read.csv("HbA1cs_GLP1Injectable_BEFORE_vs_AFTER_closest_6months.csv")



# SGLT2 --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2 too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('34',.), ~replace(., grepl('34', .), "SGLT2"))%>%
  mutate_if(grepl('35',.), ~replace(., grepl('35', .), "SGLT2"))%>%
  mutate_if(grepl('36',.), ~replace(., grepl('36', .), "SGLT2"))%>%
  mutate_if(grepl('37',.), ~replace(., grepl('37', .), "SGLT2"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_SGLT2 %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first SGLT2 month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2)-6)
HbA1cs_before_SGLT2 <- HbA1cs_before_SGLT2 %>% group_by(patient) %>%  summarize(across(everything(), max))
names(HbA1cs_before_SGLT2)[4] <- "Month_Prior"
names(HbA1cs_before_SGLT2)[3] <- "HbA1c_Prior"

HbA1cs_after_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2+6))
HbA1cs_after_SGLT2 <- HbA1cs_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_SGLT2)[4] <- "Month_After"
names(HbA1cs_after_SGLT2)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_before_SGLT2 %>% full_join(HbA1cs_after_SGLT2)
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior) # 8.763276
mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_After) # 7.022239

median(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior) # 8.3
median(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_After) # 6.9

write.csv(HbA1cs_SGLT2_BEFORE_vs_AFTER, "HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_6months.csv")




# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Combo criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Combo %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Combo month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Combo <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo-6))
HbA1cs_before_Combo <- HbA1cs_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Combo)[4] <- "Month_Prior"
names(HbA1cs_before_Combo)[3] <- "HbA1c_Prior"

HbA1cs_after_Combo <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+6))
HbA1cs_after_Combo <- HbA1cs_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_Combo)[4] <- "Month_After"
names(HbA1cs_after_Combo)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Combo_BEFORE_vs_AFTER <- HbA1cs_before_Combo %>% full_join(HbA1cs_after_Combo)
HbA1cs_Combo_BEFORE_vs_AFTER <- HbA1cs_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_Prior) # 9.205175
mean(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_After) # 7.12771

median(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_Prior) # 8.8
median(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_After) # 7

write.csv(HbA1cs_Combo_BEFORE_vs_AFTER, "HbA1cs_Combo_BEFORE_vs_AFTER_closest_6months.csv")



# Summary evolution over time -------
HbA1c_Evolution_US_All_6months <- fread("HbA1c_Evolution_US_All_6months.csv")

HbA1c_Evolution_US_All_6months %>% group_by(Therapy, Period) %>% summarise(n=mean(HbA1c))



HbA1c_Evolution_US_All_6months %>% group_by(Therapy, Period) %>% summarise(n=median(HbA1c))



Pats_to_keep_paired <- HbA1c_Evolution_US_All_6months %>% group_by(patient, Therapy) %>% filter(Month>=-12 & Month<=12) %>% 
  count() %>% filter(n%%2==0) %>% select(patient, Therapy)

HbA1c_Evolution_US_All_6months <- Pats_to_keep_paired %>% left_join(HbA1c_Evolution_US_All_6months)

HbA1c_Evolution_US_All_6months %>% 
  group_by(Therapy, Month) %>%  
  ggplot(aes(x=Month, y=HbA1c, fill=Therapy, colour=Therapy))+
  geom_smooth(size=2.5, method = "loess", se=F )+
  ylab("HbA1c %\n")+
  xlab("\nMonth")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  scale_colour_viridis_d()


# HbA1c reductions of patients eclusively on 1 or 2 therapies -----------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Pick patients that had *ONLY* |Biguanide| AND |SGLT2|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_InjectableGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj| AND SGLT2
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)


# SGLT2 --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2 too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('34',.), ~replace(., grepl('34', .), "SGLT2"))%>%
  mutate_if(grepl('35',.), ~replace(., grepl('35', .), "SGLT2"))%>%
  mutate_if(grepl('36',.), ~replace(., grepl('36', .), "SGLT2"))%>%
  mutate_if(grepl('37',.), ~replace(., grepl('37', .), "SGLT2"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

Pats_Biguanide_SGLT2_only <- Pats_Biguanide_SGLT2_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_SGLT2 %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first SGLT2 month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2)-6)
HbA1cs_before_SGLT2 <- HbA1cs_before_SGLT2 %>% group_by(patient) %>%  summarize(across(everything(), max))
names(HbA1cs_before_SGLT2)[4] <- "Month_Prior"
names(HbA1cs_before_SGLT2)[3] <- "HbA1c_Prior"

HbA1cs_after_SGLT2 <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2+6))
HbA1cs_after_SGLT2 <- HbA1cs_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_SGLT2)[4] <- "Month_After"
names(HbA1cs_after_SGLT2)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_before_SGLT2 %>% full_join(HbA1cs_after_SGLT2)
HbA1cs_SGLT2_BEFORE_vs_AFTER <- HbA1cs_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior) # 7.502625
mean(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_After) # 6.557399

median(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior) # 7.2
median(HbA1cs_SGLT2_BEFORE_vs_AFTER$HbA1c_After) # 6.5

write.csv(HbA1cs_SGLT2_BEFORE_vs_AFTER, "HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_6months_Big_SGLT2_only.csv")




# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('48',.), ~replace(., grepl('48', .), "GLP1Injectable")) %>%
  mutate_if(grepl('49',.), ~replace(., grepl('49', .), "GLP1Injectable")) %>%
  mutate_if(grepl('50',.), ~replace(., grepl('50', .), "GLP1Injectable")) %>%
  mutate_if(grepl('51',.), ~replace(., grepl('51', .), "GLP1Injectable")) %>%
  mutate_if(grepl('52',.), ~replace(., grepl('52', .), "GLP1Injectable")) %>%
  mutate_if(grepl('53',.), ~replace(., grepl('53', .), "GLP1Injectable")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1Injectable",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_GLP1Inj_only)


#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1Injectable <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1Injectable)[3] <- "Month_First_GLP1Injectable"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1Injectable<-  DIA_Drug_Histories_FIRST_GLP1Injectable %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_GLP1Injectable %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first GLP1 Injectable month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_GLP1Injectable, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_GLP1Injectable <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1Injectable)-6)
HbA1cs_before_GLP1Injectable <- HbA1cs_before_GLP1Injectable %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_GLP1Injectable)[4] <- "Month_Prior"
names(HbA1cs_before_GLP1Injectable)[3] <- "HbA1c_Prior"

HbA1cs_after_GLP1Injectable <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1Injectable+6))
HbA1cs_after_GLP1Injectable <- HbA1cs_after_GLP1Injectable %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_GLP1Injectable)[4] <- "Month_After"
names(HbA1cs_after_GLP1Injectable)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- HbA1cs_before_GLP1Injectable %>% full_join(HbA1cs_after_GLP1Injectable)
HbA1cs_GLP1Injectable_BEFORE_vs_AFTER <- HbA1cs_GLP1Injectable_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_Prior) # 6.984714
mean(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_After) # 5.989349

median(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_Prior) # 6.6
median(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER$HbA1c_After) # 5.9

write.csv(HbA1cs_GLP1Injectable_BEFORE_vs_AFTER, "HbA1cs_GLP1Injectable_BEFORE_vs_AFTER_closest_6months_Big_GLP1Inj_only.csv")





# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

Pats_Biguanide_SGLT2_GLP1Inj_only <- Pats_Biguanide_SGLT2_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the HbA1x levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Combo criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures_HbA1c <- Patient_first_Combo %>% left_join(DANU_Measures_HbA1c, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(!is.na(weight))


#join the patient first Combo month to his HbA1c readings
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(-weight.y)
names(DANU_Measures_HbA1c)[2] <- "weight"

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1cs_before_Combo <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo-6))
HbA1cs_before_Combo <- HbA1cs_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1cs_before_Combo)[4] <- "Month_Prior"
names(HbA1cs_before_Combo)[3] <- "HbA1c_Prior"

HbA1cs_after_Combo <- DANU_Measures_HbA1c %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+6))
HbA1cs_after_Combo <- HbA1cs_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1cs_after_Combo)[4] <- "Month_After"
names(HbA1cs_after_Combo)[3] <- "HbA1c_After"

#join the before and after HbA1cs
HbA1cs_Combo_BEFORE_vs_AFTER <- HbA1cs_before_Combo %>% full_join(HbA1cs_after_Combo)
HbA1cs_Combo_BEFORE_vs_AFTER <- HbA1cs_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_Prior) # 8.257495
mean(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_After) # 6.509155

median(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_Prior) # 7.9
median(HbA1cs_Combo_BEFORE_vs_AFTER$HbA1c_After) # 6.4

write.csv(HbA1cs_Combo_BEFORE_vs_AFTER, "HbA1cs_Combo_BEFORE_vs_AFTER_closest_6months_Big_SGLT_GLP1Inj_only.csv")



# Summary evolution over time -------
HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")

HbA1c_Evolution_US_All_6months_2_classes_only %>% group_by(Therapy, Period) %>% summarise(n=mean(HbA1c))


HbA1c_Evolution_US_All_6months_2_classes_only %>% group_by(Therapy, Period) %>% summarise(n=median(HbA1c))


Pats_to_keep_paired <- HbA1c_Evolution_US_All_6months_2_classes_only %>% group_by(patient, Therapy) %>% filter(Month>=-12 & Month<=12) %>% 
  count() %>% filter(n%%2==0) %>% select(patient, Therapy)

HbA1c_Evolution_US_All_6months_2_classes_only <- Pats_to_keep_paired %>% left_join(HbA1c_Evolution_US_All_6months_2_classes_only)

HbA1c_Evolution_US_All_6months_2_classes_only %>% 
  group_by(Therapy, Month) %>%  
  ggplot(aes(x=Month, y=HbA1c, fill=Therapy, colour=Therapy))+
  geom_smooth(size=2.5, method = "loess", se=F )+
  ylab("HbA1c %\n")+
  xlab("\nMonth")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  scale_colour_viridis_d()


# -----
# Pathways / Class Penetrance to Injectable GLP1 ---------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Injectable_GLP1_pats <- DIA_Flows_Aux._Long %>% filter(grepl("G",s1)|grepl("G",s2)) %>% select(patient) %>% distinct()

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Injectable_GLP1_pats)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")


DIA_Drug_Histories_2 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_InjectableGLP1,Treat))) 1:which.max(grepl(string_InjectableGLP1,Treat)) else row_number())   

DIA_Drug_Histories_2 <-DIA_Drug_Histories_2 %>% arrange(patient, desc(Month))

DIA_Drug_Histories_2 <- DIA_Drug_Histories_2 %>% mutate(New_Month = row_number()) %>% mutate(New_Month=New_Month-1L)

Month_total <- data.frame(DIA_Drug_Histories_2 %>% ungroup() %>% group_by(New_Month) %>% summarise(Month_total=sum(weight)))


DIA_Drug_Histories_2 <- separate_rows(DIA_Drug_Histories_2, Treat, sep = ",", convert=T )
names(DIA_Drug_Histories_2)[4] <- "molecule"

DIA_Drug_Histories_2 <- DIA_Drug_Histories_2 %>% left_join(DANU_Ingredients, by=c("molecule"="drug_id")) 

Drug_penetrance_month <- DIA_Drug_Histories_2 %>% ungroup() %>% group_by(New_Month, drug_group) %>% summarise(n=sum(weight))
Drug_penetrance_month <- Drug_penetrance_month %>% left_join(Month_total)
Drug_penetrance_month <- Drug_penetrance_month %>% mutate(Penetrance= round((n/Month_total)*100,0))

Drug_penetrance_month %>% 
  filter(New_Month!=0) %>% 
  #filter(New_Month<=42)%>%
  mutate(drug_group=ifelse(is.na(drug_group),"Lapsed",drug_group))%>%
  mutate(New_Month=New_Month*-1L) %>% filter(!is.na(drug_group))%>%
  ggplot(aes(x=New_Month, y=Penetrance, fill=factor(drug_group, levels=c("Lapsed", "Biguanide", "Antidiabetic", "DPP4", "SGLT2", "Insulin", "GLP1 Oral", "GLP1 Injectable")))) + 
  geom_area(alpha=0.8 , size=1, position = "stack", show.legend = T)+
  scale_fill_brewer(palette = "Paired") + theme(panel.background = element_blank())+
  xlab("\nMonths to Rybelsus")+ylab("Drug Penetrance (%)\n")


# -----
# PATHS TO GLP1 INJECTBALE ----------------------------------------------------------------

DIA_US_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)

DIA_Flows_Aux._Long <- read.table("DIA_Flows_Aux._Long.txt", header = T, sep=",", colClasses = "character", stringsAsFactors = FALSE)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, p2, d1, d2, s1, s2)

GLP1_Patients <- DIA_Flows_Aux._Long %>% filter(grepl("G",s2) | grepl("G",s1)) %>% select(patient) %>% distinct()

GLP1_Patients <- GLP1_Patients %>% left_join(DIA_US_Drug_Histories)
GLP1_Patients <- GLP1_Patients %>% select(-c(disease))
GLP1_Patients <- gather(GLP1_Patients, Month, Treat, month1:month60, factor_key=TRUE)
GLP1_Patients <- separate_rows(GLP1_Patients, Treat, sep = ",", convert=T )
names(GLP1_Patients)[4] <- "molecule"

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)

GLP1_Patients<- GLP1_Patients %>% left_join(DANU_Ingredients, by=c("molecule"="drug_id")) %>%  arrange(patient)


GLP1_Patients_first_48m <- GLP1_Patients %>% group_by(patient) %>% filter(Month == "month1" | Month == "month2" | Month == "month3" | Month == "month4" |
                                                                            Month == "month5" | Month == "month6" | Month == "month7" | Month == "month8" |
                                                                            Month == "month9" | Month == "month10" | Month == "month11" | Month == "month12" | 
                                                                            Month == "month13" | Month == "month14" | Month == "month15" | Month == "month16" |
                                                                            Month == "month17" | Month == "month18" | Month == "month19" | Month == "month20" |
                                                                            Month == "month21" | Month == "month22" | Month == "month23" | Month == "month24" | 
                                                                            Month == "month25" | Month == "month26" | Month == "month27" | Month == "month28" |
                                                                            Month == "month29" | Month == "month30" | Month == "month31" | Month == "month32" |
                                                                            Month == "month33" | Month == "month34" | Month == "month35" | Month == "month36" | 
                                                                            Month == "month37" | Month == "month38" | Month == "month39" | Month == "month40" |
                                                                            Month == "month41" | Month == "month42" | Month == "month43" | Month == "month44" |
                                                                            Month == "month45" | Month == "month46" | Month == "month47" | Month == "month48") %>%
  filter(drug_group == "GLP1 Injectable") %>% select(patient) %>% distinct()

GLP1_Patients <- GLP1_Patients %>% anti_join(GLP1_Patients_first_48m)

GLP1_Patients2 <- GLP1_Patients %>% group_by(patient, weight) %>% 
  slice(if(any(drug_group == "GLP1 Injectable")) 1:which.max(drug_group == "GLP1 Injectable") else row_number())   

# 
# Paths_to_GLP1 <- GLP1_Patients2 %>% ungroup %>% select(-c(molecule)) %>% group_by(patient, Month, drug_group) %>% 
#   distinct() %>% ungroup %>% group_by(patient, Month) %>% 
#   mutate(paths_month = paste(drug_group, collapse=" + ")) %>% 
#   ungroup() %>% group_by(patient, weight, paths_month) %>% 
#   select(patient,weight, paths_month) %>% distinct() %>%
#   select(patient, weight, paths_month) %>% ungroup()
# 
# write.csv(Paths_to_GLP1, "Paths_to_GLP1.csv")

# Month_prior_to_GLP1_combos <- data.frame(GLP1_Patients2 %>% ungroup %>% select(-c(molecule)) %>% group_by(patient, Month, drug_group) %>% 
#                                            distinct() %>% ungroup %>% group_by(patient, Month) %>% 
#                                            mutate(paths_month = paste(drug_group, collapse=" + ")) %>% 
#                                            ungroup() %>% group_by(patient, weight, paths_month) %>% 
#                                            select(patient,weight, paths_month) %>% distinct() %>%
#                                            select(patient, weight, paths_month) %>% ungroup() %>% group_by(patient) %>% 
#                                            filter(row_number() == (n() - 1)) %>% ungroup() %>% group_by(paths_month) %>%
#                                            summarise(n = sum(as.numeric(weight))) %>% arrange(-n))
# 
# write.csv(Month_prior_to_GLP1_combos, "Month_prior_to_GLP1_combos.csv")


GLP1_Patients2_stocks <- GLP1_Patients2

GLP1_Patients2_stocks$Month <- as.character(GLP1_Patients2_stocks$Month)
GLP1_Patients2_stocks$Month <- parse_number(GLP1_Patients2_stocks$Month)

DIA_Flows_Aux._Long <- read.table("DIA_Flows_Aux._Long.txt", header = T, sep=",", colClasses = "character", stringsAsFactors = FALSE)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p2=as.numeric(p2)) %>% select(patient, p2, s2)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(p1 == 1)

GLP1_Patients2_stocks <- GLP1_Patients2_stocks %>% left_join(DIA_Flows_Aux._Long, by = c("patient"="patient", "Month"="p2"))

GLP1_Patients2_stocks <- GLP1_Patients2_stocks %>% left_join(DIA_Flows_Aux._Long, by = c("patient"="patient", "Month"="p1"))

GLP1_Patients2_stocks <- GLP1_Patients2_stocks %>% mutate(s2 = ifelse(is.na(s2), s1, s2))
GLP1_Patients2_stocks <- GLP1_Patients2_stocks%>%select(-c(s1))
names(GLP1_Patients2_stocks)[6] <- "stock"


GLP1_Patients2_stocks <- GLP1_Patients2_stocks %>% filter(stock!="x") %>% filter(stock!="g") %>% filter(stock!="I")

GLP1_Patients2_stocks_COPY <- GLP1_Patients2_stocks
GLP1_Patients2_stocks <- GLP1_Patients2_stocks_COPY


data.frame(GLP1_Patients2_stocks %>% ungroup %>% select(-c(molecule, drug_group)) %>% group_by(patient, weight, Month, stock) %>% 
             distinct() %>% ungroup %>% group_by(patient) %>% 
             #filter(row_number() >= (n() - 12)) %>%
             ungroup() %>% group_by(patient) %>%
             mutate(num = row_number()) %>% ungroup() %>% group_by(num, stock) %>%
             summarise(total = sum(as.numeric(weight))))
# 
# 
# Stocks_evol_to_GLP1_13m_each_box <- data.frame(GLP1_Patients2_stocks %>% ungroup %>% select(-c(molecule, drug_group)) %>% group_by(patient, weight, Month, stock) %>% 
#                                                  distinct() %>% ungroup %>% group_by(patient) %>% 
#                                                  filter(row_number() >= (n() - 12)) %>%
#                                                  ungroup() %>% 
#                                                  select(patient, weight, stock) %>% 
#                                                  group_by(patient, weight) %>% 
#                                                  mutate(paths_stocks = paste(stock, collapse="->")) %>% 
#                                                  ungroup() %>% select(-c(stock)) %>% distinct() %>% group_by(paths_stocks) %>%
#                                                  summarise(total = sum(as.numeric(weight))) %>% arrange(-total))
# 
# write.csv(Stocks_evol_to_GLP1_13m_each_box, "Stocks_evol_to_GLP1_13m_each_box.csv")




Stocks_evol_to_GLP1_13m <- data.frame(GLP1_Patients2_stocks %>% ungroup %>% select(-c(molecule, drug_group)) %>% group_by(patient, weight, Month, stock) %>% 
                                        distinct() %>% ungroup %>% group_by(patient) %>% 
                                        #filter(row_number() >= (n() - 12)) %>%
                                        ungroup() %>% 
                                        select(patient, weight, stock) %>% 
                                        group_by(patient, weight) %>% 
                                        mutate(paths_stocks = paste(stock, collapse="->")) %>% 
                                        ungroup() %>% select(-c(stock)) %>% distinct() %>% group_by(paths_stocks) %>%
                                        summarise(total = sum(as.numeric(weight))) %>% arrange(-total))


Stocks_evol_to_GLP1_13m <- Stocks_evol_to_GLP1_13m %>% mutate(ID = row_number())

Stocks_evol_to_GLP1_13m <- separate_rows(Stocks_evol_to_GLP1_13m, paths_stocks, sep = "->", convert=T )

Stocks_evol_to_GLP1_13m <- data.frame(Stocks_evol_to_GLP1_13m %>% group_by(ID) %>% filter(row_number()==1 | lag(paths_stocks) != paths_stocks))

Stocks_evol_to_GLP1_13m <- Stocks_evol_to_GLP1_13m %>% group_by(ID) %>% mutate(paths_stocks = paste(paths_stocks, collapse="->")) %>% 
  ungroup() %>% group_by(ID, total, paths_stocks) %>% distinct()

data.frame(Stocks_evol_to_GLP1_13m)

Stocks_evol_to_GLP1_13m <- Stocks_evol_to_GLP1_13m %>% ungroup() %>% select(-c(ID)) %>% group_by(paths_stocks) %>% summarise(pats=sum(total))

write.csv(Stocks_evol_to_GLP1_13m, "Stocks_evol_to_GLP1_Inj_EXC_LAPSED_ORAL_INSULIN_all_months.csv")



# -----
# PATHS TO GLP1 ORAL  ----------------------------------------------------------------

DIA_US_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)

DIA_Flows_Aux._Long <- read.table("DIA_Flows_Aux._Long.txt", header = T, sep=",", colClasses = "character", stringsAsFactors = FALSE)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, p1, p2, d1, d2, s1, s2)

GLP1_Patients <- DIA_Flows_Aux._Long %>% filter(grepl("47",d2) | grepl("47",d1)) %>% select(patient) %>% distinct()

GLP1_Patients <- GLP1_Patients %>% left_join(DIA_US_Drug_Histories)
GLP1_Patients <- GLP1_Patients %>% select(-c(disease))
GLP1_Patients <- gather(GLP1_Patients, Month, Treat, month1:month60, factor_key=TRUE)
GLP1_Patients <- separate_rows(GLP1_Patients, Treat, sep = ",", convert=T )
names(GLP1_Patients)[4] <- "molecule"

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)

GLP1_Patients<- GLP1_Patients %>% left_join(DANU_Ingredients, by=c("molecule"="drug_id")) %>%  arrange(patient)


GLP1_Patients_first_48m <- GLP1_Patients %>% group_by(patient) %>% filter(Month == "month1" | Month == "month2" | Month == "month3" | Month == "month4" |
                                                                            Month == "month5" | Month == "month6" | Month == "month7" | Month == "month8" |
                                                                            Month == "month9" | Month == "month10" | Month == "month11" | Month == "month12" | 
                                                                            Month == "month13" | Month == "month14" | Month == "month15" | Month == "month16" |
                                                                            Month == "month17" | Month == "month18" | Month == "month19" | Month == "month20" |
                                                                            Month == "month21" | Month == "month22" | Month == "month23" | Month == "month24" | 
                                                                            Month == "month25" | Month == "month26" | Month == "month27" | Month == "month28" |
                                                                            Month == "month29" | Month == "month30" | Month == "month31" | Month == "month32" |
                                                                            Month == "month33" | Month == "month34" | Month == "month35" | Month == "month36" | 
                                                                            Month == "month37" | Month == "month38" | Month == "month39" | Month == "month40" |
                                                                            Month == "month41" | Month == "month42" | Month == "month43" | Month == "month44" |
                                                                            Month == "month45" | Month == "month46" | Month == "month47" | Month == "month48") %>%
  filter(drug_group == "GLP1 Oral") %>% select(patient) %>% distinct()

GLP1_Patients <- GLP1_Patients %>% anti_join(GLP1_Patients_first_48m)

GLP1_Patients2 <- GLP1_Patients %>% group_by(patient, weight) %>% 
  slice(if(any(drug_group == "GLP1 Oral")) 1:which.max(drug_group == "GLP1 Oral") else row_number())   

# 
# Paths_to_GLP1 <- GLP1_Patients2 %>% ungroup %>% select(-c(molecule)) %>% group_by(patient, Month, drug_group) %>% 
#   distinct() %>% ungroup %>% group_by(patient, Month) %>% 
#   mutate(paths_month = paste(drug_group, collapse=" + ")) %>% 
#   ungroup() %>% group_by(patient, weight, paths_month) %>% 
#   select(patient,weight, paths_month) %>% distinct() %>%
#   select(patient, weight, paths_month) %>% ungroup()
# 
# write.csv(Paths_to_GLP1, "Paths_to_GLP1.csv")

# Month_prior_to_GLP1_combos <- data.frame(GLP1_Patients2 %>% ungroup %>% select(-c(molecule)) %>% group_by(patient, Month, drug_group) %>% 
#                                            distinct() %>% ungroup %>% group_by(patient, Month) %>% 
#                                            mutate(paths_month = paste(drug_group, collapse=" + ")) %>% 
#                                            ungroup() %>% group_by(patient, weight, paths_month) %>% 
#                                            select(patient,weight, paths_month) %>% distinct() %>%
#                                            select(patient, weight, paths_month) %>% ungroup() %>% group_by(patient) %>% 
#                                            filter(row_number() == (n() - 1)) %>% ungroup() %>% group_by(paths_month) %>%
#                                            summarise(n = sum(as.numeric(weight))) %>% arrange(-n))
# 
# write.csv(Month_prior_to_GLP1_combos, "Month_prior_to_GLP1_combos.csv")


GLP1_Patients2_stocks <- GLP1_Patients2

GLP1_Patients2_stocks$Month <- as.character(GLP1_Patients2_stocks$Month)
GLP1_Patients2_stocks$Month <- parse_number(GLP1_Patients2_stocks$Month)

DIA_Flows_Aux._Long <- read.table("DIA_Flows_Aux._Long.txt", header = T, sep=",", colClasses = "character", stringsAsFactors = FALSE)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1=as.numeric(p1)) %>% select(patient, p1, s1)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(p1 == 1)

GLP1_Patients2_stocks <- GLP1_Patients2_stocks %>% left_join(DIA_Flows_Aux._Long, by = c("patient"="patient", "Month"="p2"))

GLP1_Patients2_stocks <- GLP1_Patients2_stocks %>% left_join(DIA_Flows_Aux._Long, by = c("patient"="patient", "Month"="p1"))

GLP1_Patients2_stocks <- GLP1_Patients2_stocks %>% mutate(s2 = ifelse(is.na(s2), s1, s2))
GLP1_Patients2_stocks <- GLP1_Patients2_stocks%>%select(-c(s1))
names(GLP1_Patients2_stocks)[6] <- "stock"


GLP1_Patients2_stocks <- GLP1_Patients2_stocks %>% filter(stock!="x")
GLP1_Patients2_stocks <- GLP1_Patients2_stocks %>% filter(stock!="I")


GLP1_Patients2_stocks_COPY <- GLP1_Patients2_stocks




data.frame(GLP1_Patients2_stocks %>% ungroup %>% select(-c(molecule, drug_group)) %>% group_by(patient, weight, Month, stock) %>% 
             distinct() %>% ungroup %>% group_by(patient) %>% 
             #filter(row_number() >= (n() - 12)) %>%
             ungroup() %>% group_by(patient) %>%
             mutate(num = row_number()) %>% ungroup() %>% group_by(num, stock) %>%
             summarise(total = sum(as.numeric(weight))))
# 
# 
# Stocks_evol_to_GLP1_13m_each_box <- data.frame(GLP1_Patients2_stocks %>% ungroup %>% select(-c(molecule, drug_group)) %>% group_by(patient, weight, Month, stock) %>% 
#                                                  distinct() %>% ungroup %>% group_by(patient) %>% 
#                                                  filter(row_number() >= (n() - 12)) %>%
#                                                  ungroup() %>% 
#                                                  select(patient, weight, stock) %>% 
#                                                  group_by(patient, weight) %>% 
#                                                  mutate(paths_stocks = paste(stock, collapse="->")) %>% 
#                                                  ungroup() %>% select(-c(stock)) %>% distinct() %>% group_by(paths_stocks) %>%
#                                                  summarise(total = sum(as.numeric(weight))) %>% arrange(-total))
# 
# write.csv(Stocks_evol_to_GLP1_13m_each_box, "Stocks_evol_to_GLP1_13m_each_box.csv")




Stocks_evol_to_GLP1_13m <- data.frame(GLP1_Patients2_stocks %>% ungroup %>% select(-c(molecule, drug_group)) %>% group_by(patient, weight, Month, stock) %>% 
                                        distinct() %>% ungroup %>% group_by(patient) %>% 
                                        #filter(row_number() >= (n() - 12)) %>%
                                        ungroup() %>% 
                                        select(patient, weight, stock) %>% 
                                        group_by(patient, weight) %>% 
                                        mutate(paths_stocks = paste(stock, collapse="->")) %>% 
                                        ungroup() %>% select(-c(stock)) %>% distinct() %>% group_by(paths_stocks) %>%
                                        summarise(total = sum(as.numeric(weight))) %>% arrange(-total))


Stocks_evol_to_GLP1_13m <- Stocks_evol_to_GLP1_13m %>% mutate(ID = row_number())

Stocks_evol_to_GLP1_13m <- separate_rows(Stocks_evol_to_GLP1_13m, paths_stocks, sep = "->", convert=T )

Stocks_evol_to_GLP1_13m <- data.frame(Stocks_evol_to_GLP1_13m %>% group_by(ID) %>% filter(row_number()==1 | lag(paths_stocks) != paths_stocks))

Stocks_evol_to_GLP1_13m <- Stocks_evol_to_GLP1_13m %>% group_by(ID) %>% mutate(paths_stocks = paste(paths_stocks, collapse="->")) %>% 
  ungroup() %>% group_by(ID, total, paths_stocks) %>% distinct()

data.frame(Stocks_evol_to_GLP1_13m)

Stocks_evol_to_GLP1_13m <- Stocks_evol_to_GLP1_13m %>% ungroup() %>% select(-c(ID)) %>% group_by(paths_stocks) %>% summarise(pats=sum(total))

write.csv(Stocks_evol_to_GLP1_13m, "Stocks_evol_to_GLP1_Oral_EXC_LAPSED_INSULIN_all_months.csv")
# ---------
# How many flows to GLP1 Injectable had SGLT2 ? --------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

DIA_Flows_Aux._Long <- read.table("DIA_Flows_Aux._Long.txt", header = T, sep=",", colClasses = "character", stringsAsFactors = FALSE)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1 = as.numeric(p1)) %>% filter(p1>=48)

DIA_Flows_Aux._Long %>% filter(grepl("G",s2) & !grepl("G",s1)) %>% filter(grepl(string_SGLT2,d1)) %>% summarise(n=sum(as.numeric(weight)))

# 2115344

DIA_Flows_Aux._Long %>% filter(grepl("G",s2) & !grepl("G",s1)) %>% summarise(n=sum(as.numeric(weight)))

# 301458.3
# ------
# Concomitant drug therapy patietns Oral GLP1 -------------------------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight, month60)
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, month60, sep = ",", convert=T )

Patients_GLP1_Oral <- DIA_Drug_Histories %>% 
  group_by(patient) %>% filter(month60 == "47") %>% select(patient)  %>% distinct()

DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight, month60)

Patients_GLP1_Oral <- Patients_GLP1_Oral %>% left_join(DIA_Drug_Histories)

sum(as.numeric(Patients_GLP1_Oral$weight)) # 141840.6

Patients_GLP1_Oral_combos <- Patients_GLP1_Oral %>% ungroup() %>% filter(grepl(",",month60))
sum(as.numeric(Patients_GLP1_Oral_combos$weight)) # 109008.5

# 0.7685282 in combo

Patients_GLP1_Oral_combos <- separate_rows(Patients_GLP1_Oral_combos, month60, sep = ",", convert=T )
names(Patients_GLP1_Oral_combos)[3] <- "molecule"
Patients_GLP1_Oral_combos$molecule <- as.character(Patients_GLP1_Oral_combos$molecule)

Patients_GLP1_Oral_combos <- Patients_GLP1_Oral_combos %>% left_join(DANU_Ingredients %>% select(molecule, generic_name, drug_group))
Patients_GLP1_Oral_combos <- Patients_GLP1_Oral_combos %>%  select(patient, weight, drug_group)
Patients_GLP1_Oral_combos <- Patients_GLP1_Oral_combos %>% distinct()
Patients_GLP1_Oral_combos <- Patients_GLP1_Oral_combos %>% group_by(patient) %>% arrange(drug_group)

Combos_weights <- Patients_GLP1_Oral_combos %>% select(patient, weight)  %>% distinct()

Patients_GLP1_Oral_combos <- Patients_GLP1_Oral_combos %>% group_by(patient) %>% summarise(drug_groupes = toString(drug_group))
Patients_GLP1_Oral_combos <- Patients_GLP1_Oral_combos %>% left_join(Combos_weights)
data.frame(Patients_GLP1_Oral_combos %>% group_by(drug_groupes) %>% summarise(n = sum(as.numeric(weight))) %>% arrange(-n))

Patients_GLP1_Oral_combos %>% group_by(drug_groupes) %>% summarise(n = sum(as.numeric(weight))) %>% arrange(-n) %>%
  mutate(drug_groupes= as.factor(drug_groupes)) %>%
  filter(n>=500) %>%
  ggplot(aes(x=n, y=reorder(drug_groupes,n))) +
  geom_bar(stat="identity", alpha = 0.7, show.legend = FALSE, fill="firebrick" )+
  xlab("\nProjected Population") + ylab("Drug Class Combinations\n")+
  ggtitle("Constitution of concomitant drug therapy among ORAL GLP1 patients")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())

Patients_GLP1_Oral_combos %>% group_by(drug_groupes) %>% summarise(n = sum(as.numeric(weight))) %>% arrange(-n) %>%
  filter(grepl("SGLT2", drug_groupes)) %>% ungroup() %>% summarise(n = sum(as.numeric(n)))

# --------
# Persistency of SGLT2+GLP1 combo -----------------------------------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")

DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(SGLT2_GLP1_Status = ifelse(str_detect(Drugs,string_SGLT2) & str_detect(Drugs,string_OralGLP1),"COmbo_SGLT2_GLP1",
                                                                               ifelse(str_detect(Drugs,string_SGLT2), "SGLT2",
                                                                                      ifelse(str_detect(Drugs,string_OralGLP1), "GLP1", "Other"))))

SGLT2_GLP1Oral_Status <- DIA_Drug_Histories

pats_to_keep <- data.frame(DIA_Drug_Histories %>% group_by(patient) %>% 
                             filter(SGLT2_GLP1_Status == "COmbo_SGLT2_GLP1" & lag(SGLT2_GLP1_Status) == "SGLT2") %>% select(patient) %>% distinct())


SGLT2_GLP1Oral_Status <- pats_to_keep %>% left_join(SGLT2_GLP1Oral_Status)

SGLT2_GLP1Oral_Status <- SGLT2_GLP1Oral_Status %>% mutate(SGLT2_GLP1_Status = ifelse(SGLT2_GLP1_Status=="COmbo_SGLT2_GLP1",1,0))


SGLT2_GLP1Oral_Status <- SGLT2_GLP1Oral_Status %>% group_by(patient) %>% mutate(grp = rle(SGLT2_GLP1_Status)$lengths %>% {rep(seq(length(.)), .)})

SGLT2_GLP1Oral_Status <- SGLT2_GLP1Oral_Status %>% filter(SGLT2_GLP1_Status == 1)

SGLT2_GLP1Oral_Status <- SGLT2_GLP1Oral_Status %>% group_by(patient, grp) %>% summarise(n=n())
names(SGLT2_GLP1Oral_Status)[3] <- "Duration"
SGLT2_GLP1Oral_Status <- SGLT2_GLP1Oral_Status %>% select(patient, Duration) 

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

SGLT2_GLP1Oral_Status <- SGLT2_GLP1Oral_Status %>% left_join(DIA_Drug_Histories  %>% select(patient, weight)) 
SGLT2_GLP1Oral_Status <- SGLT2_GLP1Oral_Status %>% mutate(weight = as.numeric(weight))
SGLT2_GLP1Oral_Status <- SGLT2_GLP1Oral_Status %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
SGLT2_GLP1Oral_Status <- SGLT2_GLP1Oral_Status %>% distinct()

library(spatstat)
weighted.mean(SGLT2_GLP1Oral_Status$Total_Duration, SGLT2_GLP1Oral_Status$weight)  # 4.430876
weighted.median(SGLT2_GLP1Oral_Status$Total_Duration, SGLT2_GLP1Oral_Status$weight) # 2.5




# -----------
# Get Script Data + Physician on that date. Scripts past day 15 add +1 month -------
Dia_US_Doses <- fread("DIA Doses.txt")
Dia_US_Doses <- Dia_US_Doses %>% filter(status != "G")
Dia_US_Doses <- Dia_US_Doses %>% select(pat_id, from_dt, prov)
Dia_US_Doses <- Dia_US_Doses %>% mutate(from_dt = as.Date(from_dt))

setDT(Dia_US_Doses)[, yearmon := format(as.Date(from_dt), "%Y-%m") ]

setDT(Dia_US_Doses)[, day := format(as.Date(from_dt), "%d") ]

Dia_US_Doses$day <- as.numeric(Dia_US_Doses$day)

Dia_US_Doses$from_dt[Dia_US_Doses$day >=16] <- Dia_US_Doses$from_dt[Dia_US_Doses$day >=16] %m+% months(1)

setDT(Dia_US_Doses)[, yearmon := format(as.Date(from_dt), "%Y-%m") ]


# Exact month acc. to drug/stocks table
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

Dia_US_Doses <- Dia_US_Doses %>% left_join(Months_lookup, by=c("yearmon"="Month"))
Dia_US_Doses <- Dia_US_Doses %>% select(pat_id, prov, Exact_Month)
names(Dia_US_Doses)[1] <- "patient"
Dia_US_Doses <- Dia_US_Doses %>% distinct()
Dia_US_Doses <- Dia_US_Doses %>% arrange(patient, Exact_Month, prov)

Dia_US_Doses <- Dia_US_Doses %>% group_by(patient, Exact_Month) %>% mutate(prov=paste(prov, collapse="+"))
Dia_US_Doses <- Dia_US_Doses %>% distinct()


Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")

DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt")


DIA_Flows_Aux._Long <- Treatment_exp_Vector %>% select(patient) %>% inner_join(DIA_Flows_Aux._Long)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2, p1_RxExp, flow, stops, starts)

DIA_Flows_Aux._Long %>% ungroup()  %>% summarise(n=sum(weight)) #367508280

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% ungroup() 


DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% left_join(Dia_US_Doses, by=c("patient"="patient", "p2"="Exact_Month"))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% arrange(patient)

DIA_Flows_Aux._Long %>% ungroup() %>% select(patient, p1,p2,weight) %>%
  distinct() %>% summarise(n=sum(weight)) #367508280

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(prov=ifelse(prov=="0", NA, prov))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% fill(prov) %>% fill(prov, .direction = c("up"))


DIA_Flows_Aux._Long  %>% ungroup()  %>% summarise(n=sum(weight)) #367508280
DIA_Flows_Aux._Long  %>% ungroup()  %>% filter(!is.na(prov)) %>% summarise(n=sum(weight)) #251080450
DIA_Flows_Aux._Long  %>% ungroup()  %>% filter(is.na(prov)) %>% summarise(n=sum(weight))  #116427830

DIA_Flows_Aux._Long %>% group_by(patient) %>% filter(!is.na(prov)) %>% ungroup() %>% 
  summarise(n=sum(weight)) # 251080450

DIA_Flows_Aux._Long %>% group_by(patient) %>% filter(!is.na(prov)) %>% filter(prov==lag(prov)) %>%
  ungroup() %>% summarise(n=sum(weight)) # 210360049

DIA_Flows_Aux._Long %>% group_by(patient) %>% filter(!is.na(prov)) %>% filter(prov!=lag(prov)) %>%
  ungroup() %>% summarise(n=sum(weight)) # 19797030

DIA_Flows_Aux._Long  %>%  filter(!is.na(prov)) %>% ungroup() %>%  group_by(patient) %>% mutate(provstatus=ifelse(prov==lag(prov),0,1)) %>%
  ungroup() %>% group_by(flow, provstatus) %>% summarise(n=sum(weight))



# Put patients on the highest Box tried over the past 12 months -------
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
Treatment_exp_Vector$weight <- as.character(Treatment_exp_Vector$weight)

DIA_Box_Histories <- read.table("DIA Box Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Box_Histories <- Treatment_exp_Vector %>% left_join(DIA_Box_Histories, by=c("patient"="patient"))

DIA_Box_Histories <- DIA_Box_Histories %>% select(1,2,52:64)
DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Treat, month48:month60, factor_key=TRUE)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Treat = str_sub(Treat, 2L, 2L))
names(DIA_Box_Histories)[4] <- "Box"

DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Box = ifelse(Box=="x", 0,
                                                               ifelse(Box=="b",1,
                                                                      ifelse(Box=="d",2,
                                                                             ifelse(Box=="D",3,
                                                                                    ifelse(Box=="S",4,
                                                                                           ifelse(Box=="I",5,
                                                                                                  ifelse(Box=="g",6,7))))))))

DIA_Box_Histories <- DIA_Box_Histories %>% select(-c(Month)) %>% group_by(patient, weight.x) %>% summarise(across(everything(),max))

sum(as.numeric(DIA_Box_Histories$weight.x)) # 30625690

DIA_Box_Histories %>% group_by(Box) %>% summarise(pats=sum(as.numeric(weight.x)))



names(DIA_Box_Histories)[2] <- "weight"
names(DIA_Box_Histories)[3] <- "Max_stock"

fwrite(DIA_Box_Histories, "Max_Stock_April21_12m.txt", sep="\t")

# ------
# Over the past 12m, % share of each category (grouped) among all used drugs? -------
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
Treatment_exp_Vector$weight <- as.character(Treatment_exp_Vector$weight)

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories, by=c("patient"="patient"))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(1,2,53:64)
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month49:month60, factor_key=TRUE)

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(Month)) %>% filter(Treat!="-")
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, Treat, sep = ",", convert=T)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients$molecule <- as.numeric(DANU_Ingredients$molecule)

DIA_Drug_Histories <- DIA_Drug_Histories %>% left_join(DANU_Ingredients %>% select(molecule, drug_group), by=c("Treat"="molecule"))
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient, drug_group) %>% mutate(total=n()) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight.x, drug_group, total) %>% distinct()

DIA_Drug_Histories %>% ungroup() %>% group_by(drug_group) %>% summarise(n=sum(total*as.numeric(weight.x)))


DIA_Box_Histories <- read.table("DIA Box Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Box_Histories <- Treatment_exp_Vector %>% left_join(DIA_Box_Histories, by=c("patient"="patient"))

DIA_Box_Histories <- DIA_Box_Histories %>% select(1,64)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(month60 = str_sub(month60, 2L, 2L))

DIA_Drug_Histories <- DIA_Drug_Histories %>% left_join(DIA_Box_Histories)

DIA_Drug_Histories %>% ungroup() %>% group_by(month60, drug_group) %>% 
  summarise(n=sum(total*as.numeric(weight.x))) %>%
  spread(key=month60, value=n)

# --------

# Dosages over time (without filling in) ------------
DANU_Prescriptions_Written_GLP1 <- fread("DANU Prescriptions Written GLP1.txt")

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% filter(!is.na(daily_dose))

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% select(patid, rxdate, daily_dose, generic_desc)

unique(DANU_Prescriptions_Written_GLP1$generic_desc)

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% filter(generic_desc!="")

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% drop_na()

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% arrange(patid, generic_desc, rxdate)

unique(DANU_Prescriptions_Written_GLP1$generic_desc)



DANU_Prescriptions_Written_GLP1$rxdate <- as.Date(DANU_Prescriptions_Written_GLP1$rxdate)

DANU_Prescriptions_Written_GLP1 %>% filter(generic_desc=="DULAGLUTIDE" & daily_dose<0.25) %>% 
  group_by(patid) %>% arrange(patid, rxdate) %>% 
  mutate(index = rxdate-lag(rxdate)) %>% ungroup() %>% mutate(index = as.numeric(index)) %>%
  mutate(index = ifelse(is.na(index), 0, index)) %>% group_by(patid) %>%
  mutate(time_progression = cumsum(index)) %>% select(-c(generic_desc , rxdate, index)) %>%
  ungroup() %>% 
  ggplot(aes(x=time_progression, y=daily_dose , fill=daily_dose , colour=-daily_dose ))+
  geom_jitter(height =0.01, width = 0.1, show.legend = F, alpha=0.6, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 20))+
  xlab("\nTime since therapy initiation (days)")+
  ylab("Dosage Prescribed\n")

# ------
# Dosages over time (filling in doses, generic name) ------------------
DANU_Prescriptions_Written_GLP1 <- fread("DANU Prescriptions Written GLP1.txt")

Drug_name_lookup <- DANU_Prescriptions_Written_GLP1 %>% select(ndc, generic_desc) %>% distinct()

names(Drug_name_lookup)[2] <- "Missing_Names"

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% left_join(Drug_name_lookup)

sum(!is.na(DANU_Prescriptions_Written_GLP1$daily_dose)) # 56482

DANU_Prescriptions_Written_GLP1$quantity_per_fill <- parse_number(DANU_Prescriptions_Written_GLP1$quantity_per_fill)
DANU_Prescriptions_Written_GLP1$strength <- parse_number(DANU_Prescriptions_Written_GLP1$strength)
DANU_Prescriptions_Written_GLP1$days_supply <- parse_number(DANU_Prescriptions_Written_GLP1$days_supply)

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% 
  mutate(daily_dose_2 = ifelse(is.na(num_refills),daily_dose,((strength*quantity_per_fill)/days_supply)*(num_refills+1)))

sum(!is.na(DANU_Prescriptions_Written_GLP1$daily_dose_2)) # 61597

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% filter(!is.na(daily_dose_2))
DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% filter(days_supply != 0)

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% mutate(generic_desc_2 = ifelse(generic_desc=="", Missing_Names, generic_desc))

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% select(patid, rxdate, daily_dose_2, generic_desc)

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% distinct()

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% filter(generic_desc!="")

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% drop_na()

DANU_Prescriptions_Written_GLP1 <- DANU_Prescriptions_Written_GLP1 %>% arrange(patid, generic_desc, rxdate)

unique(DANU_Prescriptions_Written_GLP1$generic_desc)

DANU_Prescriptions_Written_GLP1$rxdate <- as.Date(DANU_Prescriptions_Written_GLP1$rxdate)



DANU_Prescriptions_Written_GLP1 %>% filter(generic_desc=="DULAGLUTIDE" & daily_dose_2<0.25) %>% 
  group_by(patid) %>% arrange(patid, rxdate) %>% 
  mutate(index = rxdate-lag(rxdate)) %>% ungroup() %>% mutate(index = as.numeric(index)) %>%
  mutate(index = ifelse(is.na(index), 0, index)) %>% group_by(patid) %>%
  mutate(time_progression = cumsum(index)) %>% select(-c(generic_desc , rxdate, index)) %>%
  ungroup() %>% 
  filter(time_progression<=730) %>%
  ggplot(aes(x=time_progression, y=daily_dose_2 , fill=daily_dose_2 , colour=-daily_dose_2 ))+
  geom_jitter(height =0.01, width = 0.1, show.legend = F, alpha=0.6, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 20))+
  xlab("\nTime since therapy initiation (days)")+
  ylab("Dosage Prescribed\n")

# ----------


# Drug Specialties all ----------------

OBE_Drug_Specialties_Annual <- fread("OBE Drug Specialties Annual.txt")

OBE_Drug_Specialties_Annual %>% group_by(specialty) %>% 
  summarise(n=sum(physician_sample)) %>%
  arrange(-n)
data.frame(OBE_Drug_Specialties_Annual %>% group_by(class, specialty) %>% 
  summarise(n=sum(physician_sample)) %>%
  arrange(class, -n))


data.frame(OBE_Drug_Specialties_Annual %>% group_by(generic, specialty) %>% 
             summarise(n=sum(physician_sample)) %>%
             arrange(generic, -n))







DIA_Drug_Specialties_Annual <- fread("DIA Drug Specialties Annual.txt")

DIA_Drug_Specialties_Annual %>% group_by(specialty) %>% 
  summarise(n=sum(physician_sample)) %>%
  arrange(-n)

data.frame(DIA_Drug_Specialties_Annual %>% group_by(class, specialty) %>% 
             summarise(n=sum(physician_sample)) %>%
             arrange(class, -n))


data.frame(DIA_Drug_Specialties_Annual %>% group_by(generic, specialty) %>% 
             summarise(n=sum(physician_sample)) %>%
             arrange(generic, -n))


data.frame(DIA_Drug_Specialties_Annual %>% filter(start=="1") %>% group_by(class, specialty) %>% 
             summarise(n=sum(physician_sample)) %>%
             arrange(class, -n))


# --------
# --------
# Predicting HbA1c reduction ~baseline : patients on metformin -------------


# HbA1c reductions patients only ON Metformin, SGLT2 and GLP1 Injectbale
HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")


# SGLT2 Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="SGLT2"])) # 419


SGLT2_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% 
  select(-c(Therapy, patient, Exact_month))

SGLT2_temp <- SGLT2_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(SGLT2_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

SGLT2_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="midnightblue", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(SGLT2_temp$HbA1c...1,SGLT2_temp$Difference) # -0.6567754


model_SGLT2 <- lm(Difference ~ HbA1c...1, data = SGLT2_temp)

summary(model_SGLT2)

# GLP1 Injectable Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="GLP1 Injectable"])) # 507


GLP1_Injectable_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% 
  select(-c(Therapy, patient, Exact_month))

GLP1_Injectable_temp <- GLP1_Injectable_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(GLP1_Injectable_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

GLP1_Injectable_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="darksalmon", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="cyan4", fill="cyan4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(GLP1_Injectable_temp$HbA1c...1,GLP1_Injectable_temp$Difference) # -0.7740298


model_GLP1_Injectable <- lm(Difference ~ HbA1c...1, data = GLP1_Injectable_temp)

summary(model_GLP1_Injectable)


# Combo Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="Combo"])) # 142


Combo_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% 
  select(-c(Therapy, patient, Exact_month))


Combo_temp <- Combo_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(Combo_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

Combo_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="firebrick", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="darkkhaki", fill="darkkhaki")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")




cor(Combo_temp$HbA1c...1,Combo_temp$Difference) # -0.7766928


model_Combo <- lm(Difference ~ HbA1c...1, data = Combo_temp)

summary(model_Combo)

# Predicting HbA1c reduction ~baseline : patients on any drug -------------

HbA1c_Evolution_US_All_6months <- fread("HbA1c_Evolution_US_All_6months.csv")

length(unique(HbA1c_Evolution_US_All_6months$patient)) # 7861 



# SGLT2 Patients
length(unique(HbA1c_Evolution_US_All_6months$patient
              [HbA1c_Evolution_US_All_6months$Therapy=="SGLT2"])) # 3993


SGLT2_temp <- HbA1c_Evolution_US_All_6months %>% filter(Therapy=="SGLT2") %>% 
  select(-c(Therapy, patient, Exact_month))

SGLT2_temp <- SGLT2_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(SGLT2_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

SGLT2_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="midnightblue", size=1, alpha=0.7)+
  geom_smooth(method="loess", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,6)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(SGLT2_temp$HbA1c...1,SGLT2_temp$Difference) # -0.7057512


model_SGLT2 <- lm(Difference ~ HbA1c...1, data = SGLT2_temp)

summary(model_SGLT2)


# GLP1 Injectable Patients
length(unique(HbA1c_Evolution_US_All_6months$patient
              [HbA1c_Evolution_US_All_6months$Therapy=="GLP1 Injectable"])) # 4816


GLP1_Injectable_temp <- HbA1c_Evolution_US_All_6months %>% filter(Therapy=="GLP1 Injectable") %>% 
  select(-c(Therapy, patient, Exact_month))

GLP1_Injectable_temp <- GLP1_Injectable_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(GLP1_Injectable_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

GLP1_Injectable_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="darksalmon", size=1, alpha=0.7)+
  geom_smooth(method="loess", colour="cyan4", fill="cyan4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(GLP1_Injectable_temp$HbA1c...1,GLP1_Injectable_temp$Difference) # -0.711746


model_GLP1_Injectable <- lm(Difference ~ HbA1c...1, data = GLP1_Injectable_temp)

summary(model_GLP1_Injectable)



# Combo Patients
length(unique(HbA1c_Evolution_US_All_6months$patient
              [HbA1c_Evolution_US_All_6months$Therapy=="Combo"])) # 1551


Combo_temp <- HbA1c_Evolution_US_All_6months %>% filter(Therapy=="Combo") %>% 
  select(-c(Therapy, patient, Exact_month))


Combo_temp <- Combo_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(Combo_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

Combo_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="firebrick", size=1, alpha=0.7)+
  geom_smooth(method="loess", colour="darkkhaki", fill="darkkhaki")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")




cor(Combo_temp$HbA1c...1,Combo_temp$Difference) # -0.7202394


model_Combo <- lm(Difference ~ HbA1c...1, data = Combo_temp)

summary(model_Combo)

# 
# Predicting HbA1c reduction ~baseline : patients on metformin ONLY < 0 -------------


# HbA1c reductions patients only ON Metformin, SGLT2 and GLP1 Injectbale
HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")


# SGLT2 Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="SGLT2"])) # 419


SGLT2_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% 
  select(-c(Therapy, patient, Exact_month))

SGLT2_temp <- SGLT2_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(SGLT2_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

SGLT2_temp <- SGLT2_temp %>% filter(Difference<0) # 326


SGLT2_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="midnightblue", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(SGLT2_temp$HbA1c...1,SGLT2_temp$Difference) # -0.6646886


model_SGLT2 <- lm(Difference ~ HbA1c...1, data = SGLT2_temp)

summary(model_SGLT2)


# GLP1 Injectable Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="GLP1 Injectable"])) # 507


GLP1_Injectable_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% 
  select(-c(Therapy, patient, Exact_month))

GLP1_Injectable_temp <- GLP1_Injectable_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(GLP1_Injectable_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

GLP1_Injectable_temp <- GLP1_Injectable_temp %>% filter(Difference<0) # 421


GLP1_Injectable_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="darksalmon", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="cyan4", fill="cyan4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(GLP1_Injectable_temp$HbA1c...1,GLP1_Injectable_temp$Difference) # -0.8342175


model_GLP1_Injectable <- lm(Difference ~ HbA1c...1, data = GLP1_Injectable_temp)

summary(model_GLP1_Injectable)


# Combo Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="Combo"])) # 142


Combo_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% 
  select(-c(Therapy, patient, Exact_month))


Combo_temp <- Combo_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(Combo_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

Combo_temp <- Combo_temp %>% filter(Difference<0) # 125


Combo_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="firebrick", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="darkkhaki", fill="darkkhaki")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")




cor(Combo_temp$HbA1c...1,Combo_temp$Difference) # -0.8126979


model_Combo <- lm(Difference ~ HbA1c...1, data = Combo_temp)

summary(model_Combo)


# Predicting HbA1c reduction ~baseline : patients on any drug ONLY < 0  -------------

HbA1c_Evolution_US_All_6months <- fread("HbA1c_Evolution_US_All_6months.csv")

length(unique(HbA1c_Evolution_US_All_6months$patient)) # 7861 



# SGLT2 Patients
length(unique(HbA1c_Evolution_US_All_6months$patient
              [HbA1c_Evolution_US_All_6months$Therapy=="SGLT2"])) # 3993


SGLT2_temp <- HbA1c_Evolution_US_All_6months %>% filter(Therapy=="SGLT2") %>% 
  select(-c(Therapy, patient, Exact_month))

SGLT2_temp <- SGLT2_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(SGLT2_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

SGLT2_temp <- SGLT2_temp %>% filter(Difference<0) #3339

SGLT2_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="midnightblue", size=1, alpha=0.7)+
  geom_smooth(method="loess", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,6)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(SGLT2_temp$HbA1c...1,SGLT2_temp$Difference) # -0.7276613


model_SGLT2 <- lm(Difference ~ HbA1c...1, data = SGLT2_temp)

summary(model_SGLT2)


# GLP1 Injectable Patients
length(unique(HbA1c_Evolution_US_All_6months$patient
              [HbA1c_Evolution_US_All_6months$Therapy=="GLP1 Injectable"])) # 4816


GLP1_Injectable_temp <- HbA1c_Evolution_US_All_6months %>% filter(Therapy=="GLP1 Injectable") %>% 
  select(-c(Therapy, patient, Exact_month))

GLP1_Injectable_temp <- GLP1_Injectable_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(GLP1_Injectable_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

GLP1_Injectable_temp <- GLP1_Injectable_temp %>% filter(Difference<0) # 4078


GLP1_Injectable_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="darksalmon", size=1, alpha=0.7)+
  geom_smooth(method="loess", colour="cyan4", fill="cyan4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(GLP1_Injectable_temp$HbA1c...1,GLP1_Injectable_temp$Difference) # -0.7488222


model_GLP1_Injectable <- lm(Difference ~ HbA1c...1, data = GLP1_Injectable_temp)

summary(model_GLP1_Injectable)




# Combo Patients
length(unique(HbA1c_Evolution_US_All_6months$patient
              [HbA1c_Evolution_US_All_6months$Therapy=="Combo"])) # 1551


Combo_temp <- HbA1c_Evolution_US_All_6months %>% filter(Therapy=="Combo") %>% 
  select(-c(Therapy, patient, Exact_month))


Combo_temp <- Combo_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(Combo_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

Combo_temp <- Combo_temp %>% filter(Difference<0) # 1343

Combo_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="firebrick", size=1, alpha=0.7)+
  geom_smooth(method="loess", colour="darkkhaki", fill="darkkhaki")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")




cor(Combo_temp$HbA1c...1,Combo_temp$Difference) # -0.7400585


model_Combo <- lm(Difference ~ HbA1c...1, data = Combo_temp)

summary(model_Combo)


# ---------

# Selet for Combo patients that stayed long on combo therapy --------

HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")

Combo_Pats <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct()

# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories <- Combo_Pats %>% left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories_LONG <- Combo_Pats %>% left_join(DIA_Drug_Histories_LONG)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)

# Pats_Biguanide_SGLT2_GLP1Inj_only <- Pats_Biguanide_SGLT2_GLP1Inj_only %>% select(patient) %>% distinct()
# DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))


Combo_Pats <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>%
  filter(Month>0) %>% select(patient, Exact_month)


Combo_pats_12months_plus <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% 
  mutate(Months_Lapsed=Month-lag(Month)) %>% drop_na() %>% mutate(Cum_exposure=cumsum(Months_Lapsed)+1) %>%
  select(patient, Month, Cum_exposure) %>%
  inner_join(Combo_Pats) %>% filter(Month==max(Month)) filter(Month>Exact_month) %>% filter(Cum_exposure>12) %>%
  select(patient) %>% distinct()


# Predicting HbA1c reduction ~baseline: patients on metformin (Combbos treated >12months, on treatment after HbA1c measure) -------------


# HbA1c reductions patients only ON Metformin, SGLT2 and GLP1 Injectbale
HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")


# SGLT2 Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="SGLT2"])) # 419


SGLT2_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% 
  select(-c(Therapy, patient, Exact_month))

SGLT2_temp <- SGLT2_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(SGLT2_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

SGLT2_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="midnightblue", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(SGLT2_temp$HbA1c...1,SGLT2_temp$Difference) # -0.6567754


model_SGLT2 <- lm(Difference ~ HbA1c...1, data = SGLT2_temp)

summary(model_SGLT2)


# GLP1 Injectable Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="GLP1 Injectable"])) # 507


GLP1_Injectable_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% 
  select(-c(Therapy, patient, Exact_month))

GLP1_Injectable_temp <- GLP1_Injectable_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(GLP1_Injectable_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

GLP1_Injectable_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="darksalmon", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="cyan4", fill="cyan4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(GLP1_Injectable_temp$HbA1c...1,GLP1_Injectable_temp$Difference) # -0.7740298


model_GLP1_Injectable <- lm(Difference ~ HbA1c...1, data = GLP1_Injectable_temp)

summary(model_GLP1_Injectable)


# Combo Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="Combo"])) # 142


Combo_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% 
  inner_join(Combo_pats_12months_plus) %>%
  select(-c(Therapy, patient, Exact_month))


Combo_temp <- Combo_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(Combo_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) # 82

Combo_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="firebrick", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="darkkhaki", fill="darkkhaki")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")




cor(Combo_temp$HbA1c...1,Combo_temp$Difference) # -0.6533279


model_Combo <- lm(Difference ~ HbA1c...1, data = Combo_temp)

summary(model_Combo)

# --------



# Predicting HbA1c reduction ~baseline : patients on metformin - MichaelisMenten kinetics -------------

# HbA1c reductions patients only ON Metformin, SGLT2 and GLP1 Injectbale
HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")


# SGLT2 Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="SGLT2"])) # 419


SGLT2_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% 
  select(-c(Therapy, patient, Exact_month))

SGLT2_temp <- SGLT2_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(SGLT2_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

MM.model <- drm(Difference~HbA1c...1, data=SGLT2_temp, fct=MM.2())

summary(MM.model)


# GLP1 Injectable Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="GLP1 Injectable"])) # 507


GLP1_Injectable_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% 
  select(-c(Therapy, patient, Exact_month))

GLP1_Injectable_temp <- GLP1_Injectable_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(GLP1_Injectable_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 



MM.model <- drm(Difference~HbA1c...1, data=GLP1_Injectable_temp, fct=MM.2())

summary(MM.model)

# Combo Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="Combo"])) # 142

Combo_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% 
  select(-c(Therapy, patient, Exact_month))


Combo_temp <- Combo_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(Combo_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 


 MM.model <- drm(Difference~HbA1c...1, data=Combo_temp, fct=MM.2())


summary(MM.model)

# -----
# Predict using Generalized Additive Model (GAM) ---------------
# HbA1c reductions patients only ON Metformin, SGLT2 and GLP1 Injectbale
HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")


# SGLT2 Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="SGLT2"])) # 419


SGLT2_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% 
  select(-c(Therapy, patient, Exact_month))

SGLT2_temp <- SGLT2_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(SGLT2_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

SGLT2_temp <- SGLT2_temp %>% select(HbA1c...1, Difference)

gam1<-gam(Difference~s(HbA1c...1,df=8) ,data = SGLT2_temp)

summary(gam1)

plot(gam1,se = TRUE) 

new.HbA1c <- data.frame(HbA1c...1 = 8)

predict(gam1, newdata = new.HbA1c) # -1.347668



# GLP1 Injectable Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="GLP1 Injectable"])) # 507


GLP1_Injectable_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% 
  select(-c(Therapy, patient, Exact_month))

GLP1_Injectable_temp <- GLP1_Injectable_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(GLP1_Injectable_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 



GLP1_Injectable_temp <- GLP1_Injectable_temp %>% select(HbA1c...1, Difference)

gam1<-gam(Difference~s(HbA1c...1,df=8) ,data = GLP1_Injectable_temp)

summary(gam1)

plot(gam1,se = TRUE) 

new.HbA1c <- data.frame(HbA1c...1 = 8)

predict(gam1, newdata = new.HbA1c) # -1.627048 




# Combo Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="Combo"])) # 142

Combo_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% 
  select(-c(Therapy, patient, Exact_month))


Combo_temp <- Combo_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(Combo_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 



Combo_temp <- Combo_temp %>% select(HbA1c...1, Difference)

gam1<-gam(Difference~s(HbA1c...1,df=8) ,data = Combo_temp)

summary(gam1)


plot(gam1,se = TRUE) 

new.HbA1c <- data.frame(HbA1c...1 = 8)

predict(gam1, newdata = new.HbA1c) # -1.461645  

# ----

# How long do GLP1 Inj vs Combo patients stay ON GLP1 ? --------------------------
HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")


# Combo
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were combo pats ON GLP1 Injectable ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

Combo_Pats <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>%
  filter(Month>0) %>% select(patient, Exact_month)

GLP1_Histories_Combo <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(Combo_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

GLP1_Histories_Combo %>% summarise(n=mean(n)) #  14.7
GLP1_Histories_Combo %>% summarise(n=median(n)) #  11
GLP1_Histories_Combo %>% summarise(n=max(n)) #  50
GLP1_Histories_Combo %>% summarise(n=min(n)) #  1






# GLP1 Injectable
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were combo pats ON GLP1 Injectable ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

GLP1_Injectable_Pats <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>%
  filter(Month>0) %>% select(patient, Exact_month)

GLP1_Histories_GLP1 <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(GLP1_Injectable_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

GLP1_Histories_GLP1 %>% summarise(n=mean(n)) #  7.89
GLP1_Histories_GLP1 %>% summarise(n=median(n)) #  8
GLP1_Histories_GLP1 %>% summarise(n=max(n)) #  34
GLP1_Histories_GLP1 %>% summarise(n=min(n)) #  1

GLP1_Histories_GLP1 %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON GLP1 until HbA1c read")+ylab("Proportion \n")



# ------------



# Predicting HbA1c reduction ~baseline : patients on metformin -------------


# HbA1c reductions patients only ON Metformin, SGLT2 and GLP1 Injectbale
HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")


# SGLT2 Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="SGLT2"])) # 419


SGLT2_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% 
  select(-c(Therapy, patient, Exact_month))

SGLT2_temp <- SGLT2_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(SGLT2_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

SGLT2_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="midnightblue", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(SGLT2_temp$HbA1c...1,SGLT2_temp$Difference) # -0.6567754


model_SGLT2 <- lm(Difference ~ HbA1c...1, data = SGLT2_temp)

summary(model_SGLT2)



# GLP1 Injectable Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="GLP1 Injectable"])) # 507


GLP1_Injectable_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% 
  select(-c(Therapy, patient, Exact_month))

GLP1_Injectable_temp <- GLP1_Injectable_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(GLP1_Injectable_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

GLP1_Injectable_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="darksalmon", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="cyan4", fill="cyan4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


cor(GLP1_Injectable_temp$HbA1c...1,GLP1_Injectable_temp$Difference) # -0.7740298


model_GLP1_Injectable <- lm(Difference ~ HbA1c...1, data = GLP1_Injectable_temp)

summary(model_GLP1_Injectable)

# Combo Patients
length(unique(HbA1c_Evolution_US_All_6months_2_classes_only$patient
              [HbA1c_Evolution_US_All_6months_2_classes_only$Therapy=="Combo"])) # 142


Combo_temp <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% 
  select(-c(Therapy, patient, Exact_month))


Combo_temp <- Combo_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(Combo_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference=HbA1c...2 - HbA1c...1) 

Combo_temp %>% ggplot(aes(HbA1c...1, Difference)) +
  geom_jitter(colour="firebrick", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="darkkhaki", fill="darkkhaki")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")




cor(Combo_temp$HbA1c...1,Combo_temp$Difference) # -0.7766928


model_Combo <- lm(Difference ~ HbA1c...1, data = Combo_temp)

summary(model_Combo)

# ---------
# How long do patients stay therapy - PREDICTIONS CONTINUOUSLY ON THERAPY HBA1c ? --------------------------
HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")

# SGLT2
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were ats ON SGLT2 ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

SGLT2_Pats <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>%
  filter(Month>0) %>% select(patient, Exact_month)

SGLT2_Histories<- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(SGLT2_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

SGLT2_Histories %>% summarise(n=mean(n)) #  8.08
SGLT2_Histories %>% summarise(n=median(n)) #  8
SGLT2_Histories %>% summarise(n=max(n)) #  28
SGLT2_Histories %>% summarise(n=min(n)) #  1



# GLP1 Injectable
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were GLP1 pats ON GLP1 Injectable ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

GLP1_Injectable_Pats <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>%
  filter(Month>0) %>% select(patient, Exact_month)

GLP1_Histories_GLP1 <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(GLP1_Injectable_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

GLP1_Histories_GLP1 %>% summarise(n=mean(n)) #  7.89
GLP1_Histories_GLP1 %>% summarise(n=median(n)) #  8
GLP1_Histories_GLP1 %>% summarise(n=max(n)) #  34
GLP1_Histories_GLP1 %>% summarise(n=min(n)) #  1





# Combo
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were combo pats ON Combo ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

Combo_Pats <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>%
  filter(Month>0) %>% select(patient, Exact_month)

Combo_Histories_Combo <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(Combo_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

Combo_Histories_Combo %>% summarise(n=mean(n)) #  6.77
Combo_Histories_Combo %>% summarise(n=median(n)) #  7.5
Combo_Histories_Combo %>% summarise(n=max(n)) #  25
Combo_Histories_Combo %>% summarise(n=min(n)) #  1






names(SGLT2_Histories)[1] <- "patient" 
names(SGLT2_Histories)[2] <- "Time_Treated" 
SGLT2_Histories <- SGLT2_Histories %>% mutate(Therapy = "SGLT2")

names(GLP1_Histories_GLP1)[1] <- "patient" 
names(GLP1_Histories_GLP1)[2] <- "Time_Treated" 
GLP1_Histories_GLP1 <- GLP1_Histories_GLP1 %>% mutate(Therapy = "GLP1 Injectable")

names(Combo_Histories_Combo)[1] <- "patient" 
names(Combo_Histories_Combo)[2] <- "Time_Treated" 
Combo_Histories_Combo <- Combo_Histories_Combo %>% mutate(Therapy = "Combo")

HbA1c_Evolution_US_All_6months_2_classes_only <- HbA1c_Evolution_US_All_6months_2_classes_only %>% left_join(SGLT2_Histories) %>%
  left_join(GLP1_Histories_GLP1, by=c("patient"="patient", "Therapy"="Therapy")) %>% 
  left_join(Combo_Histories_Combo, by=c("patient"="patient", "Therapy"="Therapy")) 


HbA1c_Evolution_US_All_6months_2_classes_only <- HbA1c_Evolution_US_All_6months_2_classes_only %>% 
  mutate(Duration=ifelse(!is.na(Time_Treated), Time_Treated,
                         ifelse(!is.na(Time_Treated.x), Time_Treated.x,
                                ifelse(!is.na(Time_Treated.y), Time_Treated.y, NA)))) %>%
  select(-c(Time_Treated.x, Time_Treated.y, Time_Treated))


HbA1c_Evolution_US_All_6months_2_classes_only_Before <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Period=="Before")
names(HbA1c_Evolution_US_All_6months_2_classes_only_Before)[2] <- "Month_Before"
names(HbA1c_Evolution_US_All_6months_2_classes_only_Before)[3] <- "HbA1c_Before"
names(HbA1c_Evolution_US_All_6months_2_classes_only_Before)[4] <- "Exact_Month_Before"
HbA1c_Evolution_US_All_6months_2_classes_only_Before <- HbA1c_Evolution_US_All_6months_2_classes_only_Before %>% select(-c(Period, Duration))


HbA1c_Evolution_US_All_6months_2_classes_only_After <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Period=="After")
names(HbA1c_Evolution_US_All_6months_2_classes_only_After)[2] <- "Month_After"
names(HbA1c_Evolution_US_All_6months_2_classes_only_After)[3] <- "HbA1c_After"
names(HbA1c_Evolution_US_All_6months_2_classes_only_After)[4] <- "Exact_Month_After"
HbA1c_Evolution_US_All_6months_2_classes_only_After <- HbA1c_Evolution_US_All_6months_2_classes_only_After %>% select(-c(Period))


HbA1c_Evolution_US_All_6months_2_classes_only_Duration <- HbA1c_Evolution_US_All_6months_2_classes_only_Before %>% 
  left_join(HbA1c_Evolution_US_All_6months_2_classes_only_After, by=c("patient"="patient","Therapy"="Therapy"))


HbA1c_Evolution_US_All_6months_2_classes_only_Duration <- HbA1c_Evolution_US_All_6months_2_classes_only_Duration %>% select(1,2,6,3,7,4,8,9,5)


names(HbA1c_Evolution_US_All_6months_2_classes_only_Duration)[4] <- "HbA1c_Before"
names(HbA1c_Evolution_US_All_6months_2_classes_only_Duration)[5] <- "HbA1c_After"

fwrite(HbA1c_Evolution_US_All_6months_2_classes_only_Duration, "HbA1c_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")












HbA1c_Evolution_US_All_6months_2_classes_only_Duration <- fread("HbA1c_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")

HbA1c_Evolution_2classes <- HbA1c_Evolution_US_All_6months_2_classes_only_Duration %>% 
  filter(Duration>=Month_After) 


HbA1c_Evolution_2classes %>% group_by(Therapy) %>% count()



HbA1c_Evolution_2classes %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  group_by(Therapy) %>% summarise(n=mean(Difference))


HbA1c_Evolution_2classes %>%
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2","GLP1 Injectable","Combo"))) %>%
  ggplot(aes(Difference, colour=Therapy, fill=Therapy)) + 
  geom_density(size=2, alpha=0.7) +
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  #xlim(-30,30)+
  xlab("\n Absolute % HbA1c Reduction")+ylab(" Cohort Proportion \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()



HbA1c_Evolution_2classes %>%
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  ggplot(aes(HbA1c_Before, HbA1c_After, colour=Therapy, fill=Therapy)) + 
  geom_point(size=3, alpha=0.5)+
  geom_smooth(method="lm")+
  xlim(5, 12.5)+ylim(5,12.5)+
  geom_abline(slope=1, intercept = 0)+
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n HbA1c Before Therapy")+ylab(" HbA1c After Therapy \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()








# Redution ~ Baseline BMI


# SGLT2 

SGLT2_temp <- HbA1c_Evolution_2classes %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  filter(Therapy=="SGLT2") %>% select(HbA1c_Before, Difference, Duration)

model_SGLT2 <- lm(Difference ~ HbA1c_Before+Duration, data = SGLT2_temp)

summary(model_SGLT2)
# 
SGLT2_temp %>% ggplot(aes(HbA1c_Before, Difference)) +
  geom_jitter(colour="midnightblue", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


# GLP1 

GLP1_temp <- HbA1c_Evolution_2classes %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  filter(Therapy=="GLP1 Injectable") %>% select(HbA1c_Before, Difference, Duration)

model_GLP1 <- lm(Difference ~ HbA1c_Before+Duration, data = GLP1_temp)

summary(model_GLP1)

GLP1_temp %>% ggplot(aes(HbA1c_Before, Difference)) +
  geom_jitter(colour="darksalmon", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="cyan4", fill="cyan4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")



# Combo 

Combo_temp <- HbA1c_Evolution_2classes %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  filter(Therapy=="Combo") %>% select(HbA1c_Before, Difference, Duration)

model_Combo <- lm(Difference ~ HbA1c_Before+Duration, data = Combo_temp)

summary(model_Combo)



Combo_temp %>% ggplot(aes(HbA1c_Before, Difference)) +
  geom_jitter(colour="firebrick", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="darkkhaki", fill="darkkhaki")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


SGLT2_temp <- SGLT2_temp %>% filter(HbA1c_Before<=10 & Duration <=12)

GLP1_temp <- GLP1_temp %>% filter(HbA1c_Before<=10 & Duration <=12)



plot_ly(x = SGLT2_temp$HbA1c_Before , 
        y = SGLT2_temp$Duration, 
        z = SGLT2_temp$Difference , type="mesh3d") 

# --------
# ----------
# 3 MONTHS HBA1c ------------
# ---------
#  HbA1c  reductions of patients eclusively on 1 or 2 therapies ------------


DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Pick patients that had *ONLY* |Biguanide| AND |SGLT2|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_InjectableGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj| AND SGLT2
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)


# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_GLP1Inj_only)


#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[3] <- "Month_First_GLP1"

# Now get the HbA1c levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="HbA1c Level") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first GLP1 Injectable month to his HbA1c readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1c_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1)-3)
HbA1c_before_GLP1 <- HbA1c_before_GLP1 %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1c_before_GLP1)[4] <- "Month_Prior"
names(HbA1c_before_GLP1)[3] <- "HbA1c_Prior"

HbA1c_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1+3))
HbA1c_after_GLP1 <- HbA1c_after_GLP1 %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1c_after_GLP1)[4] <- "Month_After"
names(HbA1c_after_GLP1)[3] <- "HbA1c_After"

#join the before and after HbA1c
HbA1c_GLP1_BEFORE_vs_AFTER <- HbA1c_before_GLP1 %>% full_join(HbA1c_after_GLP1)
HbA1c_GLP1_BEFORE_vs_AFTER <- HbA1c_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1c_GLP1_BEFORE_vs_AFTER$HbA1c_Prior) #7.041424
mean(HbA1c_GLP1_BEFORE_vs_AFTER$HbA1c_After) #5.889159

median(HbA1c_GLP1_BEFORE_vs_AFTER$HbA1c_Prior) #6.7
median(HbA1c_GLP1_BEFORE_vs_AFTER$HbA1c_After) #.8

write.csv(HbA1c_GLP1_BEFORE_vs_AFTER, "HbA1c_GLP1_BEFORE_vs_AFTER_closest_3months_Big_GLP1_only.csv")



# SGLT2 --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2  too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)



Pats_Biguanide_SGLT2_only <- Pats_Biguanide_SGLT2_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_only)



#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the HbA1c levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="HbA1c Level") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures <- Patient_first_SGLT2 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first SGLT2 month to his HbA1c readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1c_before_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2)-3)
HbA1c_before_SGLT2 <- HbA1c_before_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1c_before_SGLT2)[4] <- "Month_Prior"
names(HbA1c_before_SGLT2)[3] <- "HbA1c_Prior"

HbA1c_after_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2+3))
HbA1c_after_SGLT2 <- HbA1c_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1c_after_SGLT2)[4] <- "Month_After"
names(HbA1c_after_SGLT2)[3] <- "HbA1c_After"

#join the before and after HbA1c
HbA1c_SGLT2_BEFORE_vs_AFTER <- HbA1c_before_SGLT2 %>% full_join(HbA1c_after_SGLT2)
HbA1c_SGLT2_BEFORE_vs_AFTER <- HbA1c_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1c_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior) #7.668985
mean(HbA1c_SGLT2_BEFORE_vs_AFTER$HbA1c_After) #6.497274

median(HbA1c_SGLT2_BEFORE_vs_AFTER$HbA1c_Prior) #7.3

median(HbA1c_SGLT2_BEFORE_vs_AFTER$HbA1c_After) #6.5

write.csv(HbA1c_SGLT2_BEFORE_vs_AFTER, "HbA1c_SGLT2_BEFORE_vs_AFTER_closest_3months_Big_SGLT2_only.csv")




# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)



Pats_Biguanide_SGLT2_GLP1Inj_only <- Pats_Biguanide_SGLT2_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)


DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the HbA1c levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="HbA1c Level") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures <- Patient_first_Combo %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first Combo month to his HbA1c readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1c_before_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo)-3)
HbA1c_before_Combo <- HbA1c_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1c_before_Combo)[4] <- "Month_Prior"
names(HbA1c_before_Combo)[3] <- "HbA1c_Prior"

HbA1c_after_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+3))
HbA1c_after_Combo <- HbA1c_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1c_after_Combo)[4] <- "Month_After"
names(HbA1c_after_Combo)[3] <- "HbA1c_After"

#join the before and after HbA1c
HbA1c_Combo_BEFORE_vs_AFTER <- HbA1c_before_Combo %>% full_join(HbA1c_after_Combo)
HbA1c_Combo_BEFORE_vs_AFTER <- HbA1c_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1c_Combo_BEFORE_vs_AFTER$HbA1c_Prior) 
mean(HbA1c_Combo_BEFORE_vs_AFTER$HbA1c_After)

median(HbA1c_Combo_BEFORE_vs_AFTER$HbA1c_Prior) 
median(HbA1c_Combo_BEFORE_vs_AFTER$HbA1c_After) 

write.csv(HbA1c_Combo_BEFORE_vs_AFTER, "HbA1c_Combo_BEFORE_vs_AFTER_closest_3months_Big_SGLT_GLP1Inj_only.csv")



# --------
# How long do patients stay therapy ? --------------------------
HbA1c_Evolution_US_All_3months_2_classes_only <- fread("HbA1c_Evolution_US_All_3months_2_classes_only.csv")

# SGLT2
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Therapy=="SGLT2") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were ats ON SGLT2 ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Therapy=="SGLT2") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

SGLT2_Pats <- HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Therapy=="SGLT2") %>%
  filter(Month>0) %>% select(patient, Exact_month)

SGLT2_Histories<- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(SGLT2_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

SGLT2_Histories %>% summarise(n=mean(n)) #  10.9
SGLT2_Histories %>% summarise(n=median(n)) #  13
SGLT2_Histories %>% summarise(n=max(n)) #  30
SGLT2_Histories %>% summarise(n=min(n)) #  1

SGLT2_Histories %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON SGLT2 until HbA1c read")+ylab("Proportion \n")



# GLP1 Injectable
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <-HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Therapy=="GLP1") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were GLP1 pats ON GLP1 Injectable ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <-HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Therapy=="GLP1") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

GLP1_Injectable_Pats <- HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Therapy=="GLP1") %>%
  filter(Month>0) %>% select(patient, Exact_month)

GLP1_Histories_GLP1 <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(GLP1_Injectable_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

GLP1_Histories_GLP1 %>% summarise(n=mean(n)) #  9.05
GLP1_Histories_GLP1 %>% summarise(n=median(n)) #  8
GLP1_Histories_GLP1 %>% summarise(n=max(n)) #  36
GLP1_Histories_GLP1 %>% summarise(n=min(n)) #  1

GLP1_Histories_GLP1 %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON GLP1 until HbA1c read")+ylab("Proportion \n")





# Combo
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were combo pats ON Combo ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

Combo_Pats <- HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Therapy=="Combo") %>%
  filter(Month>0) %>% select(patient, Exact_month)

Combo_Histories_Combo <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(Combo_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

Combo_Histories_Combo %>% summarise(n=mean(n)) #  9.59
Combo_Histories_Combo %>% summarise(n=median(n)) #  10
Combo_Histories_Combo %>% summarise(n=max(n)) #  23
Combo_Histories_Combo %>% summarise(n=min(n)) #  1

Combo_Histories_Combo %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON Combo until HbA1c read")+ylab("Proportion \n")






names(SGLT2_Histories)[1] <- "patient" 
names(SGLT2_Histories)[2] <- "Time_Treated" 
SGLT2_Histories <- SGLT2_Histories %>% mutate(Therapy = "SGLT2")

names(GLP1_Histories_GLP1)[1] <- "patient" 
names(GLP1_Histories_GLP1)[2] <- "Time_Treated" 
GLP1_Histories_GLP1 <- GLP1_Histories_GLP1 %>% mutate(Therapy = "GLP1")

names(Combo_Histories_Combo)[1] <- "patient" 
names(Combo_Histories_Combo)[2] <- "Time_Treated" 
Combo_Histories_Combo <- Combo_Histories_Combo %>% mutate(Therapy = "Combo")

HbA1c_Evolution_US_All_3months_2_classes_only <- HbA1c_Evolution_US_All_3months_2_classes_only %>% left_join(SGLT2_Histories) %>%
  left_join(GLP1_Histories_GLP1, by=c("patient"="patient", "Therapy"="Therapy")) %>% 
  left_join(Combo_Histories_Combo, by=c("patient"="patient", "Therapy"="Therapy")) 


HbA1c_Evolution_US_All_3months_2_classes_only <- HbA1c_Evolution_US_All_3months_2_classes_only %>% 
  mutate(Duration=ifelse(!is.na(Time_Treated), Time_Treated,
                         ifelse(!is.na(Time_Treated.x), Time_Treated.x,
                                ifelse(!is.na(Time_Treated.y), Time_Treated.y, NA)))) %>%
  select(-c(Time_Treated.x, Time_Treated.y, Time_Treated))


HbA1c_Evolution_US_All_3months_2_classes_only_Before <- HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Period=="Before")
names(HbA1c_Evolution_US_All_3months_2_classes_only_Before)[2] <- "Month_Before"
names(HbA1c_Evolution_US_All_3months_2_classes_only_Before)[3] <- "HbA1c_Before"
names(HbA1c_Evolution_US_All_3months_2_classes_only_Before)[4] <- "Exact_Month_Before"
HbA1c_Evolution_US_All_3months_2_classes_only_Before <- HbA1c_Evolution_US_All_3months_2_classes_only_Before %>% select(-c(Period, Duration))


HbA1c_Evolution_US_All_3months_2_classes_only_After <- HbA1c_Evolution_US_All_3months_2_classes_only %>% filter(Period=="After")
names(HbA1c_Evolution_US_All_3months_2_classes_only_After)[2] <- "Month_After"
names(HbA1c_Evolution_US_All_3months_2_classes_only_After)[3] <- "HbA1c_After"
names(HbA1c_Evolution_US_All_3months_2_classes_only_After)[4] <- "Exact_Month_After"
HbA1c_Evolution_US_All_3months_2_classes_only_After <- HbA1c_Evolution_US_All_3months_2_classes_only_After %>% select(-c(Period))


HbA1c_Evolution_US_All_3months_2_classes_only_Duration <- HbA1c_Evolution_US_All_3months_2_classes_only_Before %>% 
  left_join(HbA1c_Evolution_US_All_3months_2_classes_only_After, by=c("patient"="patient","Therapy"="Therapy"))



HbA1c_Evolution_US_All_3months_2_classes_only_Duration <- HbA1c_Evolution_US_All_3months_2_classes_only_Duration %>% select(1,2,6,3,7,4,8,9,5)

fwrite(HbA1c_Evolution_US_All_3months_2_classes_only_Duration, "HbA1c_Evolution_US_All_3months_2_classes_only_Duration.txt", sep="\t")


# ---------
# HbA1c reductions ~ treatment duration -------------------

HbA1c_Evolution_US_All_3months_2_classes_only_Duration <- fread("HbA1c_Evolution_US_All_3months_2_classes_only_Duration.txt", sep="\t")


HbA1c_Evolution_US_All_3months_2_classes_only_Duration %>% filter(Duration>=Month_After) %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  group_by(Therapy) %>% summarise(n=mean(Difference))


HbA1c_Evolution_US_All_3months_2_classes_only_Duration %>% filter(Duration>=Month_After) %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  group_by(Therapy) %>% count()


HbA1c_Evolution_US_All_3months_2_classes_only_Duration <- HbA1c_Evolution_US_All_3months_2_classes_only_Duration %>% 
  filter(Duration>=Month_After) 





HbA1c_Evolution_US_All_3months_2_classes_only_Duration %>%
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2","GLP1","Combo"))) %>%
  ggplot(aes(Difference, colour=Therapy, fill=Therapy)) + 
  geom_density(size=2, alpha=0.7) +
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  #xlim(-30,30)+
  xlab("\n HbA1c % Reduction")+ylab(" Cohort Proportion \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()





HbA1c_Evolution_US_All_3months_2_classes_only_Duration %>%
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2","GLP1","Combo"))) %>%
  ggplot(aes(HbA1c_Before, HbA1c_After, colour=Therapy, fill=Therapy)) + 
  geom_point(size=3, alpha=0.5)+
  geom_smooth(method="lm")+
  xlim(4, 12.5)+ylim(4,12.5)+
  geom_abline(slope=1, intercept = 0)+
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n HbA1c Before Therapy")+ylab(" HbA1c After Therapy \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()







# Redution ~ Baseline HbA1c



# SGLT2 

SGLT2_temp <- HbA1c_Evolution_US_All_3months_2_classes_only_Duration %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  filter(Therapy=="SGLT2") %>% select(HbA1c_Before, Difference)

model_SGLT2 <- lm(Difference ~ HbA1c_Before , data = SGLT2_temp)

summary(model_SGLT2)

SGLT2_temp %>% ggplot(aes(HbA1c_Before , Difference)) +
  geom_jitter(colour="midnightblue", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


# GLP1 

GLP1_temp <- HbA1c_Evolution_US_All_3months_2_classes_only_Duration %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  filter(Therapy=="GLP1") %>% select(HbA1c_Before, Difference, Duration)

model_GLP1 <- lm(Difference ~ HbA1c_Before, data = GLP1_temp)

summary(model_GLP1)


GLP1_temp %>% ggplot(aes(HbA1c_Before, Difference)) +
  geom_jitter(colour="darksalmon", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="cyan4", fill="cyan4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


# Combo 

Combo_temp <- HbA1c_Evolution_US_All_3months_2_classes_only_Duration %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  filter(Therapy=="Combo") %>% select(HbA1c_Before, Difference)

model_Combo <- lm(Difference ~ HbA1c_Before, data = Combo_temp)

summary(model_Combo)




Combo_temp %>% ggplot(aes(HbA1c_Before, Difference)) +
  geom_jitter(colour="firebrick", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="darkkhaki", fill="darkkhaki")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-8,5)+xlim(5,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


# -------
# --------
# 6 MONTHS ------------
# ---------
# ---------
# BMI Reductions ------------



# Minimum 6months away from start ALL PATIENTS --------------
# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[3] <- "Month_First_GLP1"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first GLP1 Injectable month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1)-3)
BMI_before_GLP1 <- BMI_before_GLP1 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_GLP1)[4] <- "Month_Prior"
names(BMI_before_GLP1)[3] <- "BMI_Prior"

BMI_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1+3))
BMI_after_GLP1 <- BMI_after_GLP1 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_GLP1)[4] <- "Month_After"
names(BMI_after_GLP1)[3] <- "BMI_After"

#join the before and after BMI
BMI_GLP1_BEFORE_vs_AFTER <- BMI_before_GLP1 %>% full_join(BMI_after_GLP1)
BMI_GLP1_BEFORE_vs_AFTER <- BMI_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) # 38.30628
mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) # 34.2646

median(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) # 37
median(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) # 33.1

write.csv(BMI_GLP1_BEFORE_vs_AFTER, "BMI_GLP1_BEFORE_vs_AFTER_closest_6months.csv")



# SGLT2 --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2  too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures <- Patient_first_SGLT2 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first SGLT2 month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2)-3)
BMI_before_SGLT2 <- BMI_before_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_SGLT2)[4] <- "Month_Prior"
names(BMI_before_SGLT2)[3] <- "BMI_Prior"

BMI_after_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2+3))
BMI_after_SGLT2 <- BMI_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_SGLT2)[4] <- "Month_After"
names(BMI_after_SGLT2)[3] <- "BMI_After"

#join the before and after BMI
BMI_SGLT2_BEFORE_vs_AFTER <- BMI_before_SGLT2 %>% full_join(BMI_after_SGLT2)
BMI_SGLT2_BEFORE_vs_AFTER <- BMI_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_SGLT2_BEFORE_vs_AFTER$BMI_Prior) # 36.64671
mean(BMI_SGLT2_BEFORE_vs_AFTER$BMI_After) # 32.75273

median(BMI_SGLT2_BEFORE_vs_AFTER$BMI_Prior) # 35.3
median(BMI_SGLT2_BEFORE_vs_AFTER$BMI_After) # 31.78

write.csv(BMI_SGLT2_BEFORE_vs_AFTER, "BMI_SGLT2_BEFORE_vs_AFTER_closest_6months.csv")




# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)


DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures <- Patient_first_Combo %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first Combo month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo)-6)
BMI_before_Combo <- BMI_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_Combo)[4] <- "Month_Prior"
names(BMI_before_Combo)[3] <- "BMI_Prior"

BMI_after_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+6))
BMI_after_Combo <- BMI_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_Combo)[4] <- "Month_After"
names(BMI_after_Combo)[3] <- "BMI_After"

#join the before and after BMI
BMI_Combo_BEFORE_vs_AFTER <- BMI_before_Combo %>% full_join(BMI_after_Combo)
BMI_Combo_BEFORE_vs_AFTER <- BMI_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) # 37.90845
mean(BMI_Combo_BEFORE_vs_AFTER$BMI_After) # 33.85393

median(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) # 36.7
median(BMI_Combo_BEFORE_vs_AFTER$BMI_After) # 32.72

write.csv(BMI_Combo_BEFORE_vs_AFTER, "BMI_Combo_BEFORE_vs_AFTER_closest_6months.csv")



# Insulin --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no Insulin too zero, and Insulin to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_Insulin,.), ~replace(., grepl(string_Insulin, .), "Insulin"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Insulin",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)


DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Insulin
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Insulin
DIA_Drug_Histories_FIRST_Insulin <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Insulin)[3] <- "Month_First_Insulin"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Insulin criteria
Patient_first_Insulin<-  DIA_Drug_Histories_FIRST_Insulin %>% select(patient)
DANU_Measures <- Patient_first_Insulin %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first Insulin month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Insulin, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before Insulin start and months after Insulin start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_Insulin <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Insulin)-6)
BMI_before_Insulin <- BMI_before_Insulin %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_Insulin)[4] <- "Month_Prior"
names(BMI_before_Insulin)[3] <- "BMI_Prior"

BMI_after_Insulin <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Insulin+6))
BMI_after_Insulin <- BMI_after_Insulin %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_Insulin)[4] <- "Month_After"
names(BMI_after_Insulin)[3] <- "BMI_After"

#join the before and after BMI
BMI_Insulin_BEFORE_vs_AFTER <- BMI_before_Insulin %>% full_join(BMI_after_Insulin)
BMI_Insulin_BEFORE_vs_AFTER <- BMI_Insulin_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_Insulin_BEFORE_vs_AFTER$BMI_Prior) # 35.22746
mean(BMI_Insulin_BEFORE_vs_AFTER$BMI_After) # 31.74171

median(BMI_Insulin_BEFORE_vs_AFTER$BMI_Prior) # 33.9
median(BMI_Insulin_BEFORE_vs_AFTER$BMI_After) # 30.6

write.csv(BMI_Insulin_BEFORE_vs_AFTER, "BMI_Insulin_BEFORE_vs_AFTER_closest_6months.csv")

# ----------
# ----------

# BMI reductions of patients exclusively on 1 or 2 therapies -----------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Pick patients that had *ONLY* |Biguanide| AND |SGLT2|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_InjectableGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj| AND SGLT2
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)



# Pick patients that had *ONLY* |Biguanide| AND |Insulin| 
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_OralGLP1, Drugs)|grepl(string_InjectableGLP1, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_Insulin_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_GLP1Inj_only)


#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[3] <- "Month_First_GLP1"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first GLP1 Injectable month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1)-6)
BMI_before_GLP1 <- BMI_before_GLP1 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_GLP1)[4] <- "Month_Prior"
names(BMI_before_GLP1)[3] <- "BMI_Prior"

BMI_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1+6))
BMI_after_GLP1 <- BMI_after_GLP1 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_GLP1)[4] <- "Month_After"
names(BMI_after_GLP1)[3] <- "BMI_After"

#join the before and after BMI
BMI_GLP1_BEFORE_vs_AFTER <- BMI_before_GLP1 %>% full_join(BMI_after_GLP1)
BMI_GLP1_BEFORE_vs_AFTER <- BMI_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) # 39.27755
mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) # 35.39377

median(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) # 37.87
median(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) # 34.3

write.csv(BMI_GLP1_BEFORE_vs_AFTER, "BMI_GLP1_BEFORE_vs_AFTER_closest_6months_Big_GLP1_only.csv")



# SGLT2 --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2  too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)



Pats_Biguanide_SGLT2_only <- Pats_Biguanide_SGLT2_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_only)



#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures <- Patient_first_SGLT2 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first SGLT2 month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2)-6)
BMI_before_SGLT2 <- BMI_before_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_SGLT2)[4] <- "Month_Prior"
names(BMI_before_SGLT2)[3] <- "BMI_Prior"

BMI_after_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2+6))
BMI_after_SGLT2 <- BMI_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_SGLT2)[4] <- "Month_After"
names(BMI_after_SGLT2)[3] <- "BMI_After"

#join the before and after BMI
BMI_SGLT2_BEFORE_vs_AFTER <- BMI_before_SGLT2 %>% full_join(BMI_after_SGLT2)
BMI_SGLT2_BEFORE_vs_AFTER <- BMI_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_SGLT2_BEFORE_vs_AFTER$BMI_Prior) # 36.25171
mean(BMI_SGLT2_BEFORE_vs_AFTER$BMI_After) # 32.7254

median(BMI_SGLT2_BEFORE_vs_AFTER$BMI_Prior) # 34.6
median(BMI_SGLT2_BEFORE_vs_AFTER$BMI_After) # 31.65

write.csv(BMI_SGLT2_BEFORE_vs_AFTER, "HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_6months_Big_SGLT2_only.csv")




# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)



Pats_Biguanide_SGLT2_GLP1Inj_only <- Pats_Biguanide_SGLT2_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)


DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures <- Patient_first_Combo %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first Combo month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo)-6)
BMI_before_Combo <- BMI_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_Combo)[4] <- "Month_Prior"
names(BMI_before_Combo)[3] <- "BMI_Prior"

BMI_after_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+6))
BMI_after_Combo <- BMI_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_Combo)[4] <- "Month_After"
names(BMI_after_Combo)[3] <- "BMI_After"

#join the before and after BMI
BMI_Combo_BEFORE_vs_AFTER <- BMI_before_Combo %>% full_join(BMI_after_Combo)
BMI_Combo_BEFORE_vs_AFTER <- BMI_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) # 37.88156
mean(BMI_Combo_BEFORE_vs_AFTER$BMI_After) # 34.13919

median(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) # 36.7
median(BMI_Combo_BEFORE_vs_AFTER$BMI_After) # 33.45

write.csv(BMI_Combo_BEFORE_vs_AFTER, "BMI_Combo_BEFORE_vs_AFTER_closest_6months_Big_SGLT_GLP1Inj_only.csv")




# Insulin --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no Insulin too zero, and Insulin to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_Insulin,.), ~replace(., grepl(string_Insulin, .), "Insulin"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Insulin",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)



Pats_Biguanide_Insulin_only <- Pats_Biguanide_Insulin_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_Insulin_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)


DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Insulin
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Insulin
DIA_Drug_Histories_FIRST_Insulin <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Insulin)[3] <- "Month_First_Insulin"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the Insulin criteria
Patient_first_Insulin<-  DIA_Drug_Histories_FIRST_Insulin %>% select(patient)
DANU_Measures <- Patient_first_Insulin %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first Insulin month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Insulin, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before Insulin start and months after Insulin start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_Insulin <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Insulin)-6)
BMI_before_Insulin <- BMI_before_Insulin %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_Insulin)[4] <- "Month_Prior"
names(BMI_before_Insulin)[3] <- "BMI_Prior"

BMI_after_Insulin <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Insulin+6))
BMI_after_Insulin <- BMI_after_Insulin %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_Insulin)[4] <- "Month_After"
names(BMI_after_Insulin)[3] <- "BMI_After"

#join the before and after BMI
BMI_Insulin_BEFORE_vs_AFTER <- BMI_before_Insulin %>% full_join(BMI_after_Insulin)
BMI_Insulin_BEFORE_vs_AFTER <- BMI_Insulin_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_Insulin_BEFORE_vs_AFTER$BMI_Prior) # 33.4487
mean(BMI_Insulin_BEFORE_vs_AFTER$BMI_After) # 30.34975

median(BMI_Insulin_BEFORE_vs_AFTER$BMI_Prior) # 32.1
median(BMI_Insulin_BEFORE_vs_AFTER$BMI_After) # 29.4

write.csv(BMI_Insulin_BEFORE_vs_AFTER, "BMI_Insulin_BEFORE_vs_AFTER_closest_6months_Big_SGLT_GLP1Inj_only.csv")




# ---------


# Summary --------------------
# BMI reductions patients only ON Metformin, SGLT2 and GLP1 Injectable
BMI_Evolution_US_All_6months_2_classes_only <- fread("BMI_Evolution_US_All_6months_2_classes_only.csv")

BMI_Evolution_US_All_6months_2_classes_only %>% group_by(Therapy, Period) %>% summarise(n=mean(BMI))


# GLP1 Patients
length(unique(BMI_Evolution_US_All_6months_2_classes_only$patient
              [BMI_Evolution_US_All_6months_2_classes_only$Therapy=="GLP1"])) # 800


GLP1_temp <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1") %>% 
  select(-c(Therapy, patient, Exact_month))

GLP1_temp <- GLP1_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(GLP1_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference= (BMI...2 - BMI...1)*100/BMI...1)

GLP1_temp %>% ggplot(aes(Difference)) + geom_density()


GLP1_temp %>% ggplot(aes(BMI...1, Difference)) +
  geom_jitter(colour="midnightblue", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-60,20)+xlim(20,80)+
  xlab("\n Baseline BMI")+ylab(" % BMI Reduction \n")


GLP1_temp <- GLP1_temp %>% filter(BMI...1 >30)

cor(GLP1_temp$BMI...1,GLP1_temp$Difference) # -0.2983152

model_GLP1 <- lm(Difference ~ BMI...1, data = GLP1_temp)

summary(model_GLP1)

# SGLT2 Patients
length(unique(BMI_Evolution_US_All_6months_2_classes_only$patient
              [BMI_Evolution_US_All_6months_2_classes_only$Therapy=="SGLT2"])) # 502


SGLT2_temp <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% 
  select(-c(Therapy, patient, Exact_month))

SGLT2_temp <- SGLT2_temp %>% filter(Period=="Before") %>% select(-Period, -Month) %>% 
  bind_cols(SGLT2_temp %>% filter(Period=="After")  %>% select(-Period, -Month)) %>%
  mutate(Difference= (BMI...2 - BMI...1)*100/BMI...1)

SGLT2_temp %>% ggplot(aes(Difference)) + geom_density()


SGLT2_temp %>% ggplot(aes(BMI...1, Difference)) +
  geom_jitter(colour="midnightblue", size=2, alpha=0.7)+
  geom_smooth(method="lm", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-60,20)+xlim(20,80)+
  xlab("\n Baseline BMI")+ylab(" % BMI Reduction \n")


SGLT2_temp <- SGLT2_temp %>% filter(BMI...1 >30)

cor(SGLT2_temp$BMI...1,SGLT2_temp$Difference) # -0.2983152

model_SGLT2 <- lm(Difference ~ BMI...1, data = SGLT2_temp)

summary(model_SGLT2)

# BMI reductions patients SGLT2 /  GLP1 Injectable / Combo
BMI_Evolution_US_All_6months <- fread("BMI_Evolution_US_All_6months.csv")

BMI_Evolution_US_All_6months %>% group_by(Therapy, Period) %>% summarise(n=mean(BMI))


# --------
# How long do patients stay therapy ? --------------------------
BMI_Evolution_US_All_6months_2_classes_only <- fread("BMI_Evolution_US_All_6months_2_classes_only.csv")

# SGLT2
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were ats ON SGLT2 ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

SGLT2_Pats <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="SGLT2") %>%
  filter(Month>0) %>% select(patient, Exact_month)

SGLT2_Histories<- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(SGLT2_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

SGLT2_Histories %>% summarise(n=mean(n)) #  7.78
SGLT2_Histories %>% summarise(n=median(n)) #  8
SGLT2_Histories %>% summarise(n=max(n)) #  48
SGLT2_Histories %>% summarise(n=min(n)) #  1

SGLT2_Histories %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON SGLT2 until HbA1c read")+ylab("Proportion \n")



# GLP1 Injectable
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were GLP1 pats ON GLP1 Injectable ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

GLP1_Injectable_Pats <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1") %>%
  filter(Month>0) %>% select(patient, Exact_month)

GLP1_Histories_GLP1 <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(GLP1_Injectable_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

GLP1_Histories_GLP1 %>% summarise(n=mean(n)) #  6.46
GLP1_Histories_GLP1 %>% summarise(n=median(n)) #  6
GLP1_Histories_GLP1 %>% summarise(n=max(n)) #  35
GLP1_Histories_GLP1 %>% summarise(n=min(n)) #  1

GLP1_Histories_GLP1 %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON GLP1 until HbA1c read")+ylab("Proportion \n")





# Combo
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were combo pats ON Combo ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

Combo_Pats <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>%
  filter(Month>0) %>% select(patient, Exact_month)

Combo_Histories_Combo <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(Combo_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

Combo_Histories_Combo %>% summarise(n=mean(n)) #  7.24
Combo_Histories_Combo %>% summarise(n=median(n)) #  8
Combo_Histories_Combo %>% summarise(n=max(n)) #  30
Combo_Histories_Combo %>% summarise(n=min(n)) #  1

Combo_Histories_Combo %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON Combo until BMI read")+ylab("Proportion \n")






names(SGLT2_Histories)[1] <- "patient" 
names(SGLT2_Histories)[2] <- "Time_Treated" 
SGLT2_Histories <- SGLT2_Histories %>% mutate(Therapy = "SGLT2")

names(GLP1_Histories_GLP1)[1] <- "patient" 
names(GLP1_Histories_GLP1)[2] <- "Time_Treated" 
GLP1_Histories_GLP1 <- GLP1_Histories_GLP1 %>% mutate(Therapy = "GLP1")

names(Combo_Histories_Combo)[1] <- "patient" 
names(Combo_Histories_Combo)[2] <- "Time_Treated" 
Combo_Histories_Combo <- Combo_Histories_Combo %>% mutate(Therapy = "Combo")

BMI_Evolution_US_All_6months_2_classes_only <- BMI_Evolution_US_All_6months_2_classes_only %>% left_join(SGLT2_Histories) %>%
  left_join(GLP1_Histories_GLP1, by=c("patient"="patient", "Therapy"="Therapy")) %>% 
  left_join(Combo_Histories_Combo, by=c("patient"="patient", "Therapy"="Therapy")) 


BMI_Evolution_US_All_6months_2_classes_only <- BMI_Evolution_US_All_6months_2_classes_only %>% 
  mutate(Duration=ifelse(!is.na(Time_Treated), Time_Treated,
                         ifelse(!is.na(Time_Treated.x), Time_Treated.x,
                                ifelse(!is.na(Time_Treated.y), Time_Treated.y, NA)))) %>%
  select(-c(Time_Treated.x, Time_Treated.y, Time_Treated))


BMI_Evolution_US_All_6months_2_classes_only_Before <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Period=="Before")
names(BMI_Evolution_US_All_6months_2_classes_only_Before)[2] <- "Month_Before"
names(BMI_Evolution_US_All_6months_2_classes_only_Before)[3] <- "BMI_Before"
names(BMI_Evolution_US_All_6months_2_classes_only_Before)[4] <- "Exact_Month_Before"
BMI_Evolution_US_All_6months_2_classes_only_Before <- BMI_Evolution_US_All_6months_2_classes_only_Before %>% select(-c(Period, Duration))


BMI_Evolution_US_All_6months_2_classes_only_After <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Period=="After")
names(BMI_Evolution_US_All_6months_2_classes_only_After)[2] <- "Month_After"
names(BMI_Evolution_US_All_6months_2_classes_only_After)[3] <- "BMI_After"
names(BMI_Evolution_US_All_6months_2_classes_only_After)[4] <- "Exact_Month_After"
BMI_Evolution_US_All_6months_2_classes_only_After <- BMI_Evolution_US_All_6months_2_classes_only_After %>% select(-c(Period))


BMI_Evolution_US_All_6months_2_classes_only_Duration <- BMI_Evolution_US_All_6months_2_classes_only_Before %>% 
  left_join(BMI_Evolution_US_All_6months_2_classes_only_After, by=c("patient"="patient","Therapy"="Therapy"))



BMI_Evolution_US_All_6months_2_classes_only_Duration <- BMI_Evolution_US_All_6months_2_classes_only_Duration %>% select(1,2,6,3,7,4,8,9,5)

fwrite(BMI_Evolution_US_All_6months_2_classes_only_Duration, "BMI_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")



# ---------
# BMI reductions ~ treatment duration -------------------

BMI_Evolution_US_All_6months_2_classes_only_Duration <- fread("BMI_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")




BMI_Evolution_US_All_6months_2_classes_only_Duration %>% filter(Duration>=Month_After) %>% 
  filter(BMI_Before>24)%>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  group_by(Therapy) %>% summarise(n=mean(Difference))




BMI_Evolution_US_All_6months_2_classes_only_Duration %>% filter(Duration>=Month_After) %>% 
  filter(BMI_Before>24)%>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  group_by(Therapy) %>% count()


BMI_Evolution_2classes <- BMI_Evolution_US_All_6months_2_classes_only_Duration %>% 
  filter(BMI_Before>24)%>%
  filter(Duration>=Month_After) 





BMI_Evolution_2classes %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2","GLP1","Combo"))) %>%
  ggplot(aes(Difference, colour=Therapy, fill=Therapy)) + 
  geom_density(size=2, alpha=0.7) +
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(-40,20)+
  xlab("\n % BMI Reduction")+ylab(" Cohort Proportion \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()




BMI_Evolution_2classes %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2","GLP1","Combo"))) %>%
  ggplot(aes(BMI_Before, BMI_After, colour=Therapy, fill=Therapy)) + 
  geom_point(size=3, alpha=0.5)+
  geom_smooth(method="lm")+
  xlim(20, 60)+ylim(20,60)+
  geom_abline(slope=1, intercept = 0)+
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n BMI Before Therapy")+ylab(" BMI After Therapy \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()





# Reduction ~ Baseline BMI


# SGLT2 

SGLT2_temp <- BMI_Evolution_2classes %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>% 
  filter(Therapy=="SGLT2") %>% select(BMI_Before, Difference)

model_SGLT2 <- lm(Difference ~ BMI_Before, data = SGLT2_temp)

summary(model_SGLT2)
                                                         
#GLP1 

GLP1_temp <- BMI_Evolution_2classes %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>% 
  filter(Therapy=="GLP1") %>% select(BMI_Before, Difference)

model_GLP1 <- lm(Difference ~ BMI_Before, data = GLP1_temp)

summary(model_GLP1)
# Combo 

Combo_temp <- BMI_Evolution_2classes %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>% 
  filter(Therapy=="Combo") %>% select(BMI_Before, Difference)

model_Combo <- lm(Difference ~ BMI_Before, data = Combo_temp)

summary(model_Combo)

BMI_Reduction_Predictions <- fread("BMI_Reduction_Predictions_ALL.txt")

BMI_Reduction_Predictions <- BMI_Reduction_Predictions %>% filter(Baseline_BMI<=50)
BMI_Reduction_Predictions <- gather(BMI_Reduction_Predictions, Therapy, BMI_Reduction, SGLT2:Combo, factor_key=TRUE)

ggplot(data=BMI_Reduction_Predictions, aes(x=Baseline_BMI , y=BMI_Reduction, colour=Therapy)) + 
  geom_smooth(size=2) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Baseline BMI")+ylab(" % BMI Reduction \n")+
  scale_color_viridis_d()




BMI_Evolution_US_All_6months_2_classes_only_Duration %>% select(Therapy, BMI_Before) %>%
  ggplot(aes(BMI_Before))+
  geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  facet_wrap(~Therapy)

# ------







# ------
# -------
# ------
# -------
# 12 MONTHS ------------
# ---------
# BMI Reductions ------------

# Minimum 12months away from start ALL PATIENTS --------------
# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[3] <- "Month_First_GLP1"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first GLP1 Injectable month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1)-3)
BMI_before_GLP1 <- BMI_before_GLP1 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_GLP1)[4] <- "Month_Prior"
names(BMI_before_GLP1)[3] <- "BMI_Prior"

BMI_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1+3))
BMI_after_GLP1 <- BMI_after_GLP1 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_GLP1)[4] <- "Month_After"
names(BMI_after_GLP1)[3] <- "BMI_After"

#join the before and after BMI
BMI_GLP1_BEFORE_vs_AFTER <- BMI_before_GLP1 %>% full_join(BMI_after_GLP1)
BMI_GLP1_BEFORE_vs_AFTER <- BMI_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) # 38.30628
mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) # 34.2646

median(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) # 37
median(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) # 33.1

write.csv(BMI_GLP1_BEFORE_vs_AFTER, "BMI_GLP1_BEFORE_vs_AFTER_closest_6months.csv")



# SGLT2 --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2  too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures <- Patient_first_SGLT2 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first SGLT2 month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2)-3)
BMI_before_SGLT2 <- BMI_before_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_SGLT2)[4] <- "Month_Prior"
names(BMI_before_SGLT2)[3] <- "BMI_Prior"

BMI_after_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2+3))
BMI_after_SGLT2 <- BMI_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_SGLT2)[4] <- "Month_After"
names(BMI_after_SGLT2)[3] <- "BMI_After"

#join the before and after BMI
BMI_SGLT2_BEFORE_vs_AFTER <- BMI_before_SGLT2 %>% full_join(BMI_after_SGLT2)
BMI_SGLT2_BEFORE_vs_AFTER <- BMI_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_SGLT2_BEFORE_vs_AFTER$BMI_Prior) # 36.64671
mean(BMI_SGLT2_BEFORE_vs_AFTER$BMI_After) # 32.75273

median(BMI_SGLT2_BEFORE_vs_AFTER$BMI_Prior) # 35.3
median(BMI_SGLT2_BEFORE_vs_AFTER$BMI_After) # 31.78

write.csv(BMI_SGLT2_BEFORE_vs_AFTER, "BMI_SGLT2_BEFORE_vs_AFTER_closest_6months.csv")




# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)


DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures <- Patient_first_Combo %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first Combo month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo)-6)
BMI_before_Combo <- BMI_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_Combo)[4] <- "Month_Prior"
names(BMI_before_Combo)[3] <- "BMI_Prior"

BMI_after_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+6))
BMI_after_Combo <- BMI_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_Combo)[4] <- "Month_After"
names(BMI_after_Combo)[3] <- "BMI_After"

#join the before and after BMI
BMI_Combo_BEFORE_vs_AFTER <- BMI_before_Combo %>% full_join(BMI_after_Combo)
BMI_Combo_BEFORE_vs_AFTER <- BMI_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) # 37.90845
mean(BMI_Combo_BEFORE_vs_AFTER$BMI_After) # 33.85393

median(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) # 36.7
median(BMI_Combo_BEFORE_vs_AFTER$BMI_After) # 32.72

write.csv(BMI_Combo_BEFORE_vs_AFTER, "BMI_Combo_BEFORE_vs_AFTER_closest_6months.csv")



# ----------
# ----------

# BMI reductions of patients eclusively on 1 or 2 therapies -----------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Pick patients that had *ONLY* |Biguanide| AND |SGLT2|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_InjectableGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj| AND SGLT2
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)



# Pick patients that had *ONLY* |Biguanide| AND |Insulin| 
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_OralGLP1, Drugs)|grepl(string_InjectableGLP1, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_Insulin_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_GLP1Inj_only)


#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[3] <- "Month_First_GLP1"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first GLP1 Injectable month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1)-12)
BMI_before_GLP1 <- BMI_before_GLP1 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_GLP1)[4] <- "Month_Prior"
names(BMI_before_GLP1)[3] <- "BMI_Prior"

BMI_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1+12))
BMI_after_GLP1 <- BMI_after_GLP1 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_GLP1)[4] <- "Month_After"
names(BMI_after_GLP1)[3] <- "BMI_After"

#join the before and after BMI
BMI_GLP1_BEFORE_vs_AFTER <- BMI_before_GLP1 %>% full_join(BMI_after_GLP1)
BMI_GLP1_BEFORE_vs_AFTER <- BMI_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior)
mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) 

median(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) 
median(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) 

write.csv(BMI_GLP1_BEFORE_vs_AFTER, "BMI_GLP1_BEFORE_vs_AFTER_closest_12months_Big_GLP1_only.csv")



# SGLT2 --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2  too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)



Pats_Biguanide_SGLT2_only <- Pats_Biguanide_SGLT2_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_only)



#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures <- Patient_first_SGLT2 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first SGLT2 month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2)-12)
BMI_before_SGLT2 <- BMI_before_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_SGLT2)[4] <- "Month_Prior"
names(BMI_before_SGLT2)[3] <- "BMI_Prior"

BMI_after_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2+12))
BMI_after_SGLT2 <- BMI_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_SGLT2)[4] <- "Month_After"
names(BMI_after_SGLT2)[3] <- "BMI_After"

#join the before and after BMI
BMI_SGLT2_BEFORE_vs_AFTER <- BMI_before_SGLT2 %>% full_join(BMI_after_SGLT2)
BMI_SGLT2_BEFORE_vs_AFTER <- BMI_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_SGLT2_BEFORE_vs_AFTER$BMI_Prior) 
mean(BMI_SGLT2_BEFORE_vs_AFTER$BMI_After) 

median(BMI_SGLT2_BEFORE_vs_AFTER$BMI_Prior) 
median(BMI_SGLT2_BEFORE_vs_AFTER$BMI_After) 

write.csv(BMI_SGLT2_BEFORE_vs_AFTER, "HbA1cs_SGLT2_BEFORE_vs_AFTER_closest_12months_Big_SGLT2_only.csv")




# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)



Pats_Biguanide_SGLT2_GLP1Inj_only <- Pats_Biguanide_SGLT2_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)


DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures <- Patient_first_Combo %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first Combo month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo)-12)
BMI_before_Combo <- BMI_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_Combo)[4] <- "Month_Prior"
names(BMI_before_Combo)[3] <- "BMI_Prior"

BMI_after_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+12))
BMI_after_Combo <- BMI_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_Combo)[4] <- "Month_After"
names(BMI_after_Combo)[3] <- "BMI_After"

#join the before and after BMI
BMI_Combo_BEFORE_vs_AFTER <- BMI_before_Combo %>% full_join(BMI_after_Combo)
BMI_Combo_BEFORE_vs_AFTER <- BMI_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) 
mean(BMI_Combo_BEFORE_vs_AFTER$BMI_After)

median(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) 
median(BMI_Combo_BEFORE_vs_AFTER$BMI_After) 

write.csv(BMI_Combo_BEFORE_vs_AFTER, "BMI_Combo_BEFORE_vs_AFTER_closest_12months_Big_SGLT_GLP1Inj_only.csv")



# --------
# How long do patients stay therapy ? --------------------------
BMI_Evolution_US_All_12months_2_classes_only <- fread("BMI_Evolution_US_All_12months_2_classes_only.csv")

# SGLT2
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Therapy=="SGLT2") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were ats ON SGLT2 ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Therapy=="SGLT2") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

SGLT2_Pats <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Therapy=="SGLT2") %>%
  filter(Month>0) %>% select(patient, Exact_month)

SGLT2_Histories<- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(SGLT2_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

SGLT2_Histories %>% summarise(n=mean(n)) #  10.9
SGLT2_Histories %>% summarise(n=median(n)) #  13
SGLT2_Histories %>% summarise(n=max(n)) #  30
SGLT2_Histories %>% summarise(n=min(n)) #  1

SGLT2_Histories %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON SGLT2 until HbA1c read")+ylab("Proportion \n")



# GLP1 Injectable
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Therapy=="GLP1") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were GLP1 pats ON GLP1 Injectable ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Therapy=="GLP1") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

GLP1_Injectable_Pats <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Therapy=="GLP1") %>%
  filter(Month>0) %>% select(patient, Exact_month)

GLP1_Histories_GLP1 <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(GLP1_Injectable_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

GLP1_Histories_GLP1 %>% summarise(n=mean(n)) #  9.05
GLP1_Histories_GLP1 %>% summarise(n=median(n)) #  8
GLP1_Histories_GLP1 %>% summarise(n=max(n)) #  36
GLP1_Histories_GLP1 %>% summarise(n=min(n)) #  1

GLP1_Histories_GLP1 %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON GLP1 until HbA1c read")+ylab("Proportion \n")





# Combo
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were combo pats ON Combo ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

Combo_Pats <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Therapy=="Combo") %>%
  filter(Month>0) %>% select(patient, Exact_month)

Combo_Histories_Combo <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(Combo_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

Combo_Histories_Combo %>% summarise(n=mean(n)) #  9.59
Combo_Histories_Combo %>% summarise(n=median(n)) #  10
Combo_Histories_Combo %>% summarise(n=max(n)) #  23
Combo_Histories_Combo %>% summarise(n=min(n)) #  1

Combo_Histories_Combo %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON Combo until BMI read")+ylab("Proportion \n")






names(SGLT2_Histories)[1] <- "patient" 
names(SGLT2_Histories)[2] <- "Time_Treated" 
SGLT2_Histories <- SGLT2_Histories %>% mutate(Therapy = "SGLT2")

names(GLP1_Histories_GLP1)[1] <- "patient" 
names(GLP1_Histories_GLP1)[2] <- "Time_Treated" 
GLP1_Histories_GLP1 <- GLP1_Histories_GLP1 %>% mutate(Therapy = "GLP1")

names(Combo_Histories_Combo)[1] <- "patient" 
names(Combo_Histories_Combo)[2] <- "Time_Treated" 
Combo_Histories_Combo <- Combo_Histories_Combo %>% mutate(Therapy = "Combo")

BMI_Evolution_US_All_12months_2_classes_only <- BMI_Evolution_US_All_12months_2_classes_only %>% left_join(SGLT2_Histories) %>%
  left_join(GLP1_Histories_GLP1, by=c("patient"="patient", "Therapy"="Therapy")) %>% 
  left_join(Combo_Histories_Combo, by=c("patient"="patient", "Therapy"="Therapy")) 


BMI_Evolution_US_All_12months_2_classes_only <- BMI_Evolution_US_All_12months_2_classes_only %>% 
  mutate(Duration=ifelse(!is.na(Time_Treated), Time_Treated,
                         ifelse(!is.na(Time_Treated.x), Time_Treated.x,
                                ifelse(!is.na(Time_Treated.y), Time_Treated.y, NA)))) %>%
  select(-c(Time_Treated.x, Time_Treated.y, Time_Treated))


BMI_Evolution_US_All_12months_2_classes_only_Before <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Period=="Before")
names(BMI_Evolution_US_All_12months_2_classes_only_Before)[2] <- "Month_Before"
names(BMI_Evolution_US_All_12months_2_classes_only_Before)[3] <- "BMI_Before"
names(BMI_Evolution_US_All_12months_2_classes_only_Before)[4] <- "Exact_Month_Before"
BMI_Evolution_US_All_12months_2_classes_only_Before <- BMI_Evolution_US_All_12months_2_classes_only_Before %>% select(-c(Period, Duration))


BMI_Evolution_US_All_12months_2_classes_only_After <- BMI_Evolution_US_All_12months_2_classes_only %>% filter(Period=="After")
names(BMI_Evolution_US_All_12months_2_classes_only_After)[2] <- "Month_After"
names(BMI_Evolution_US_All_12months_2_classes_only_After)[3] <- "BMI_After"
names(BMI_Evolution_US_All_12months_2_classes_only_After)[4] <- "Exact_Month_After"
BMI_Evolution_US_All_12months_2_classes_only_After <- BMI_Evolution_US_All_12months_2_classes_only_After %>% select(-c(Period))


BMI_Evolution_US_All_12months_2_classes_only_Duration <- BMI_Evolution_US_All_12months_2_classes_only_Before %>% 
  left_join(BMI_Evolution_US_All_12months_2_classes_only_After, by=c("patient"="patient","Therapy"="Therapy"))



BMI_Evolution_US_All_12months_2_classes_only_Duration <- BMI_Evolution_US_All_12months_2_classes_only_Duration %>% select(1,2,6,3,7,4,8,9,5)

fwrite(BMI_Evolution_US_All_12months_2_classes_only_Duration, "BMI_Evolution_US_All_12months_2_classes_only_Duration.txt", sep="\t")


# ---------
# BMI reductions ~ treatment duration -------------------

BMI_Evolution_US_All_6months_2_classes_only_Duration <- fread("BMI_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")

BMI_Evolution_US_All_12months_2_classes_only_Duration %>% filter(Duration>=Month_After) %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  group_by(Therapy) %>% summarise(n=mean(Difference))


BMI_Evolution_US_All_6months_2_classes_only_Duration %>% filter(Duration>=Month_After) %>% 
  filter(BMI_Before>25) %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  group_by(Therapy) %>% summarise(n=mean(Difference))




BMI_Evolution_2classes_Above30 <- BMI_Evolution_US_All_12months_2_classes_only_Duration %>% 
  filter(Duration>=Month_After) %>%  filter(BMI_Before>30)





BMI_Evolution_2classes_Above30 %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2","GLP1","Combo"))) %>%
  ggplot(aes(Difference, colour=Therapy, fill=Therapy)) + 
  geom_density(size=2, alpha=0.7) +
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(-30,30)+
  xlab("\n % BMI Reduction")+ylab(" Cohort Proportion \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()




BMI_Evolution_2classes_Above30 %>%
  mutate(Difference= ((BMI_After-BMI_Before)*100/BMI_Before)/Duration) %>%
  ggplot(aes(BMI_Before, Difference, colour=Therapy, fill=Therapy)) + 
  geom_point(size=3, alpha=0.5)+
  geom_smooth(method="lm")+
  #xlim(20, 60)+ylim(20,60)+
  geom_abline(slope=1, intercept = 0)+
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n BMI Before Therapy")+ylab(" BMI After Therapy \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()







# Redution ~ Baseline BMI


# SGLT2 

SGLT2_temp <- BMI_Evolution_2classes_Above30 %>% 
  mutate(Difference= ((BMI_After-BMI_Before)*100/BMI_Before)/Duration) %>% 
  filter(Therapy=="SGLT2") %>% select(BMI_Before, Difference)

model_SGLT2 <- lm(Difference ~ BMI_Before , data = SGLT2_temp)

summary(model_SGLT2)


# GLP1 

GLP1_temp <- BMI_Evolution_2classes_Above30 %>% 
  mutate(Difference= ((BMI_After-BMI_Before)*100/BMI_Before)/Duration) %>% 
  filter(Therapy=="GLP1") %>% select(BMI_Before, Difference, Duration)

model_GLP1 <- lm(Difference ~ BMI_Before, data = GLP1_temp)

summary(model_GLP1)
# 



# Combo 

Combo_temp <- BMI_Evolution_2classes_Above30 %>% 
  mutate(Difference= ((BMI_After-BMI_Before)*100/BMI_Before)/Duration) %>% 
  filter(Therapy=="Combo") %>% select(BMI_Before, Difference, Duration)

model_Combo <- lm(Difference ~ BMI_Before, data = Combo_temp)

summary(model_Combo)
Call:
  lm(formula = Difference ~ BMI_Before, data = Combo_temp)
# 


# ------
# med_codes all drugs diabetes -----------
DANU_Medications <- fread("DANU Medications.txt")

DANU_Medications <- DANU_Medications %>% select(drug_class, med_code) %>% distinct()


DANU_Medications %>% 
  
  
  
  unlist(lapply(DANU_Medications$med_code, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))


DANU_Medications$med_code2 <- lapply(DANU_Medications[,2],function(x) str_sub(x, 3L, ))

MED_Codes_GLP1_Injectable <- DANU_Medications %>% filter(drug_class=="GLP1 Injectable") %>% select(drug_class, med_code2) %>%  distinct()

names(MED_Codes_GLP1_Injectable)[2] <- "med_code"

fwrite(MED_Codes_GLP1_Injectable, "MED_Codes_GLP1_Injectable.txt", sep="\t")

DANU_Medications <- DANU_Medications %>% select(drug_class, med_code2) %>% distinct()
names(DANU_Medications)[2] <- "med_code"

fwrite(DANU_Medications, "MED_Codes_All_Classes.txt", sep="\t")

# ---------
# Diabetes Incidence ------------------------

# Sum of starts, per year (exc. Year 1), using long table

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
length(unique(DIA_Flows_Aux._Long$patient)) # 344289
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(p1==12 & p1_RxExp==0) %>% select(patient) %>% distinct() %>% left_join(DIA_Flows_Aux._Long)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(p1>=12) %>% select(patient, weight, p2, starts)
length(unique(DIA_Flows_Aux._Long$patient)) # 209065

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(Year=ifelse(p2>=13&p2<=24, 2,
                                                                  ifelse(p2>=25&p2<=36,3,
                                                                         ifelse(p2>=37&p2<=48,4,5))))

DIA_Flows_Aux._Long %>% group_by(Year) %>% filter(starts==1) %>% summarise(n=sum(weight))




#How many patients lapsed until month 12 started being treated thereafter each year? 

DIA_Drug_Histories <- fread("DIA Drug Histories.txt") # 344289
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-weight)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Treat=ifelse(Treat=="-",0,1))

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(Treat_exp=cumsum(Treat))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Month==13 & Treat_exp==0) %>% 
  select(patient) %>% distinct() %>% left_join(DIA_Drug_Histories)

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Month>=13)

DIA_Drug_Histories <- DIA_Drug_Histories  %>% mutate(Year=ifelse(Month>=13&Month<=24, 2,
                                                                 ifelse(Month>=25&Month<=36,3,
                                                                        ifelse(Month>=37&Month<=48,4,5))))

Treatment_Experience <- DIA_Drug_Histories
Treatment_Experience <- Treatment_Experience %>% group_by(patient) %>% filter(Treat_exp != 0) %>% slice(1)

DIA_Drug_Histories <- fread("DIA Drug Histories.txt") 
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight)

Treatment_Experience <- Treatment_Experience %>% left_join(DIA_Drug_Histories)

Treatment_Experience %>% group_by(Year) %>% summarise(n=sum(weight))


names(Treatment_Experience)[2] <- "First_Treat_Month"

# Remove pats already with Dx despite no having Rx first 12m
DANU_Events <- fread("DANU Events.txt")
DANU_Events <- DIA_Drug_Histories %>% select(patient) %>% left_join(DANU_Events, by=c("patient"="patid"))
DANU_Events <- DANU_Events %>% select(patient, claimed) %>% distinct()
DANU_Events$Month_Yr <- format(as.Date(DANU_Events$claimed), "%Y-%m")
DANU_Events <- DANU_Events %>% select(-claimed) %>% distinct()
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")
DANU_Events <- DANU_Events %>% left_join(Months_lookup, by=c("Month_Yr"="Month")) %>% 
  drop_na() %>% select(patient, Exact_Month) %>% distinct()
to_remove <- DANU_Events %>% filter(Exact_Month<13) %>% select(patient) %>% distinct()

Treatment_Experience_filtered <- Treatment_Experience %>% anti_join(to_remove)


Treatment_Experience_filtered %>% group_by(Year) %>% summarise(n=sum(weight))




# ALl Events 
DANU_Events <- fread("DANU Events.txt")
DANU_Events <- DIA_Drug_Histories %>% select(patient) %>% left_join(DANU_Events, by=c("patient"="patid"))
DANU_Events <- DANU_Events %>% select(patient, claimed) %>% distinct()
DANU_Events$Month_Yr <- format(as.Date(DANU_Events$claimed), "%Y-%m")
DANU_Events <- DANU_Events %>% select(-claimed) %>% distinct()

Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Events <- DANU_Events %>% left_join(Months_lookup, by=c("Month_Yr"="Month")) %>% 
  drop_na() %>% select(patient, Exact_Month) %>% distinct()

DANU_Events <- DANU_Events %>% anti_join(DANU_Events %>% filter(Exact_Month<13) %>% select(patient) %>% distinct())
DANU_Events <- DANU_Events %>% group_by(patient) %>% filter(Exact_Month==min(Exact_Month))
names(DANU_Events)[2] <- "First_Dx_Month"

DIA_Drug_Histories <- fread("DIA Drug Histories.txt") 
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight)

DANU_Events %>% inner_join(DIA_Drug_Histories) %>% 
  filter(First_Dx_Month<=60) %>% mutate(Year=ifelse(First_Dx_Month>=13&First_Dx_Month<=24, 2,
                                                    ifelse(First_Dx_Month>=25&First_Dx_Month<=36,3,
                                                           ifelse(First_Dx_Month>=37&First_Dx_Month<=48,4,5)))) %>%
  group_by(Year) %>% summarise(n=sum(weight))

DANU_Events_to_keep <- DANU_Events

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
to_remove_2 <- DIA_Flows_Aux._Long %>% filter(p1==12 & p1_RxExp==1) %>% select(patient) %>% distinct() 

DANU_Events_to_keep <- DANU_Events_to_keep %>% anti_join(to_remove_2)

DANU_Events_to_keep %>% inner_join(DIA_Drug_Histories) %>% 
  filter(First_Dx_Month<=60) %>% mutate(Year=ifelse(First_Dx_Month>=13&First_Dx_Month<=24, 2,
                                                    ifelse(First_Dx_Month>=25&First_Dx_Month<=36,3,
                                                           ifelse(First_Dx_Month>=37&First_Dx_Month<=48,4,5)))) %>%
  group_by(Year) %>% summarise(n=sum(weight))


# Dx or Rx, whichever comes first
temp <- Treatment_Experience_filtered %>% full_join(DANU_Events_to_keep)

temp <- temp %>% mutate(First_Exposure=ifelse(is.na(First_Treat_Month),First_Dx_Month,
                                              ifelse(is.na(First_Dx_Month), First_Treat_Month,
                                                     ifelse( First_Treat_Month<First_Dx_Month, First_Treat_Month, First_Dx_Month)))) %>%
  mutate(Year_Both=ifelse(First_Exposure>=13&First_Exposure<=24, 2,
                          ifelse(First_Exposure>=25&First_Exposure<=36,3,
                                 ifelse(First_Exposure>=37&First_Exposure<=48,4,5))))


DIA_Drug_Histories <- fread("DIA Drug Histories.txt") 
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight)

temp <- temp %>% inner_join(DIA_Drug_Histories, by=c("patient"="patient"))

temp %>% filter(!is.na(First_Dx_Month)) %>% group_by(Year_Both) %>% summarise(n=sum(weight.y))


# ----------
# NEW HbA1cs and BMIs - ALL GLP1 Patients Injectable ------------

GLP_Measures <- fread("GLP Measures.txt")
length(unique(GLP_Measures$patid)) # 147872
New_Pats <- GLP_Measures %>% select(patid) %>% distinct()
fwrite(New_Pats, "All_GLP1_Ever_Pats_HbA1c_BMI.txt")

# ------
# NEW GLP1 DATA - ALL GLP1 PATS - HBA1C and BMI -----------
# ----------
# 6 MONTHS HBA1c ------------
# HbA1c  reductions of patients eclusively on 1 or 2 therapies ------------
DANU_Ingredients       <- fread("DANU Ingredients New Lookup.csv", integer64 = "character", stringsAsFactors = F)

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)


# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- DIA_Drug_Histories %>%  anti_join(Pats_to_remove)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj| AND SGLT2
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_GLP1Inj_only <- DIA_Drug_Histories %>%  anti_join(Pats_to_remove) 


# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[2] <- "Month_First_GLP1"

# Now get the HbA1c levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="HbA1c Level") %>% select(patid, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first GLP1 Injectable month to his HbA1c readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient")) %>% drop_na()

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1c_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1)-6)
HbA1c_before_GLP1 <- HbA1c_before_GLP1 %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1c_before_GLP1)[3] <- "Month_Prior"
names(HbA1c_before_GLP1)[2] <- "HbA1c_Prior"

HbA1c_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1+6))
HbA1c_after_GLP1 <- HbA1c_after_GLP1 %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1c_after_GLP1)[3] <- "Month_After"
names(HbA1c_after_GLP1)[2] <- "HbA1c_After"

#join the before and after HbA1c
HbA1c_GLP1_BEFORE_vs_AFTER <- HbA1c_before_GLP1 %>% full_join(HbA1c_after_GLP1)
HbA1c_GLP1_BEFORE_vs_AFTER <- HbA1c_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1c_GLP1_BEFORE_vs_AFTER$HbA1c_Prior) #6.948549
mean(HbA1c_GLP1_BEFORE_vs_AFTER$HbA1c_After) #5.995803

median(HbA1c_GLP1_BEFORE_vs_AFTER$HbA1c_Prior) # 6.5
median(HbA1c_GLP1_BEFORE_vs_AFTER$HbA1c_After) # 5.8

write.csv(HbA1c_GLP1_BEFORE_vs_AFTER, "HbA1c_GLP1_BEFORE_vs_AFTER_closest_6months_Big_GLP1_only.csv")


# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)


# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


Pats_Biguanide_SGLT2_GLP1Inj_only <- Pats_Biguanide_SGLT2_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[2] <- "Month_First_Combo"

# Now get the HbA1c levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="HbA1c Level") %>% select(patid, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures <- Patient_first_Combo %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no HbA1c level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first Combo month to his HbA1c readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
HbA1c_before_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo)-6)
HbA1c_before_Combo <- HbA1c_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(HbA1c_before_Combo)[3] <- "Month_Prior"
names(HbA1c_before_Combo)[2] <- "HbA1c_Prior"

HbA1c_after_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+6))
HbA1c_after_Combo <- HbA1c_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(HbA1c_after_Combo)[3] <- "Month_After"
names(HbA1c_after_Combo)[2] <- "HbA1c_After"

#join the before and after HbA1c
HbA1c_Combo_BEFORE_vs_AFTER <- HbA1c_before_Combo %>% full_join(HbA1c_after_Combo)
HbA1c_Combo_BEFORE_vs_AFTER <- HbA1c_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(HbA1c_Combo_BEFORE_vs_AFTER$HbA1c_Prior) # 8.282118
mean(HbA1c_Combo_BEFORE_vs_AFTER$HbA1c_After) # 6.55456

median(HbA1c_Combo_BEFORE_vs_AFTER$HbA1c_Prior) # 7.9
median(HbA1c_Combo_BEFORE_vs_AFTER$HbA1c_After) # 6.5

write.csv(HbA1c_Combo_BEFORE_vs_AFTER, "HbA1c_Combo_BEFORE_vs_AFTER_closest_6months_Big_SGLT_GLP1Inj_only.csv")



# --------
# How long do patients stay therapy ? --------------------------
HbA1c_Evolution_US_All_6months_2_classes_only <- fread("HbA1c_Evolution_US_All_6months_2_classes_only.csv")


# GLP1 Injectable
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)


DIA_Drug_Histories <-HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# How long were GLP1 pats ON GLP1 Injectable ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

GLP1_Injectable_Pats <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>%
  filter(Month>0) %>% select(patient, Exact_month)

GLP1_Histories_GLP1 <- DIA_Drug_Histories %>%  group_by(patient) %>% inner_join(GLP1_Injectable_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

GLP1_Histories_GLP1 %>% summarise(n=mean(n)) #  7.66
GLP1_Histories_GLP1 %>% summarise(n=median(n)) #  8
GLP1_Histories_GLP1 %>% summarise(n=max(n)) #  36
GLP1_Histories_GLP1 %>% summarise(n=min(n)) #  1

GLP1_Histories_GLP1 %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON GLP1 until HbA1c read")+ylab("Proportion \n")





# Combo
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# How long were combo pats ON Combo ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <-  fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

Combo_Pats <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>%
  filter(Month>0) %>% select(patient, Exact_month)

Combo_Histories_Combo <- DIA_Drug_Histories %>% group_by(patient) %>% inner_join(Combo_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

Combo_Histories_Combo %>% summarise(n=mean(n)) #  7.03
Combo_Histories_Combo %>% summarise(n=median(n)) #  7
Combo_Histories_Combo %>% summarise(n=max(n)) #  41
Combo_Histories_Combo %>% summarise(n=min(n)) #  1

Combo_Histories_Combo %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON Combo until HbA1c read")+ylab("Proportion \n")


names(GLP1_Histories_GLP1)[1] <- "patient" 
names(GLP1_Histories_GLP1)[2] <- "Time_Treated" 
GLP1_Histories_GLP1 <- GLP1_Histories_GLP1 %>% mutate(Therapy = "GLP1 Injectable")

names(Combo_Histories_Combo)[1] <- "patient" 
names(Combo_Histories_Combo)[2] <- "Time_Treated" 
Combo_Histories_Combo <- Combo_Histories_Combo %>% mutate(Therapy = "Combo")

HbA1c_Evolution_US_All_6months_2_classes_only <- HbA1c_Evolution_US_All_6months_2_classes_only %>% 
  left_join(GLP1_Histories_GLP1, by=c("patient"="patient", "Therapy"="Therapy")) %>% 
  left_join(Combo_Histories_Combo, by=c("patient"="patient", "Therapy"="Therapy")) 


HbA1c_Evolution_US_All_6months_2_classes_only <- HbA1c_Evolution_US_All_6months_2_classes_only %>% 
  mutate(Duration = ifelse(!is.na(Time_Treated.x), Time_Treated.x,
                           ifelse(!is.na(Time_Treated.y), Time_Treated.y, NA))) %>%
  select(-c(Time_Treated.x, Time_Treated.y))


HbA1c_Evolution_US_All_6months_2_classes_only_Before <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Period=="Before")
names(HbA1c_Evolution_US_All_6months_2_classes_only_Before)[2] <- "Month_Before"
names(HbA1c_Evolution_US_All_6months_2_classes_only_Before)[3] <- "HbA1c_Before"
names(HbA1c_Evolution_US_All_6months_2_classes_only_Before)[4] <- "Exact_Month_Before"
HbA1c_Evolution_US_All_6months_2_classes_only_Before <- HbA1c_Evolution_US_All_6months_2_classes_only_Before %>% select(-c(Period, Duration))


HbA1c_Evolution_US_All_6months_2_classes_only_After <- HbA1c_Evolution_US_All_6months_2_classes_only %>% filter(Period=="After")
names(HbA1c_Evolution_US_All_6months_2_classes_only_After)[2] <- "Month_After"
names(HbA1c_Evolution_US_All_6months_2_classes_only_After)[3] <- "HbA1c_After"
names(HbA1c_Evolution_US_All_6months_2_classes_only_After)[4] <- "Exact_Month_After"
HbA1c_Evolution_US_All_6months_2_classes_only_After <- HbA1c_Evolution_US_All_6months_2_classes_only_After %>% select(-c(Period))


HbA1c_Evolution_US_All_6months_2_classes_only_Duration <- HbA1c_Evolution_US_All_6months_2_classes_only_Before %>% 
  left_join(HbA1c_Evolution_US_All_6months_2_classes_only_After, by=c("patient"="patient","Therapy"="Therapy"))



fwrite(HbA1c_Evolution_US_All_6months_2_classes_only_Duration, "HbA1c_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")


# ---------
# HbA1c reductions ~ treatment duration WITH OLD SGLT2 -------------------

HbA1c_Evolution_US_All_6months_2_classes_only_Duration <- fread("HbA1c_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")

HbA1c_Evolution_US_All_6months_2_classes_only_Duration <- fread("HbA1c_Evolution_US_All_6months_2_classes_only_Duration.csv", sep=",")

HbA1c_Evolution_US_All_6months_2_classes_only_Duration %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  group_by(Therapy) %>% summarise(n=mean(Difference))


HbA1c_Evolution_US_All_6months_2_classes_only_Duration %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  group_by(Therapy) %>% count()


HbA1c_Evolution_US_All_6months_2_classes_only_Duration <- HbA1c_Evolution_US_All_6months_2_classes_only_Duration 

HbA1c_Evolution_US_All_6months_2_classes_only_Duration %>%
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2", "GLP1 Injectable","Combo"))) %>%
  ggplot(aes(Difference, colour=Therapy, fill=Therapy)) + 
  geom_density(size=2, alpha=0.7) +
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  #xlim(-30,30)+
  xlab("\n HbA1c % Reduction")+ylab(" Cohort Proportion \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()





HbA1c_Evolution_US_All_6months_2_classes_only_Duration %>%
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2", "GLP1 Injectable","Combo"))) %>%
  ggplot(aes(HbA1c_Before, HbA1c_After, colour=Therapy, fill=Therapy)) + 
  geom_point(size=3, alpha=0.5)+
  geom_smooth(method="lm")+
  xlim(4, 15)+ylim(4,15)+
  geom_abline(slope=1, intercept = 0)+
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n HbA1c Before Therapy")+ylab(" HbA1c After Therapy \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()







# Redution ~ Baseline HbA1c


# SGLT2 

SGLT2_temp <- HbA1c_Evolution_US_All_6months_2_classes_only_Duration %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  filter(Therapy=="SGLT2") %>% select(HbA1c_Before, Difference, Duration) 


model_SGLT2 <- lm(Difference ~ HbA1c_Before, data = SGLT2_temp)

summary(model_SGLT2)
# 

SGLT2_temp %>% ggplot(aes(HbA1c_Before, Difference)) +
  geom_jitter(colour="midnightblue", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="deeppink4", fill="deeppink4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-10,10)+xlim(4,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


# GLP1 

GLP1_temp <- HbA1c_Evolution_US_All_6months_2_classes_only_Duration %>% 
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  filter(Therapy=="GLP1 Injectable") %>% select(HbA1c_Before, Difference, Duration) 


model_GLP1 <- lm(Difference ~ HbA1c_Before, data = GLP1_temp)

summary(model_GLP1)



GLP1_temp %>% ggplot(aes(HbA1c_Before, Difference)) +
  geom_jitter(colour="darksalmon", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="cyan4", fill="cyan4")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-10,10)+xlim(4,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


# Combo 

Combo_temp <- HbA1c_Evolution_US_All_6months_2_classes_only_Duration %>%  
  mutate(Difference= HbA1c_After-HbA1c_Before) %>%
  filter(Therapy=="Combo") %>% select(HbA1c_Before, Difference)  


model_Combo <- lm(Difference ~ HbA1c_Before, data = Combo_temp)

summary(model_Combo)
# 
Combo_temp %>% ggplot(aes(HbA1c_Before, Difference)) +
  geom_jitter(colour="firebrick", size=2, alpha=0.7)+
  geom_smooth(method="loess", colour="darkkhaki", fill="darkkhaki")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ylim(-10,10)+xlim(4,15)+
  xlab("\n Baseline HbA1c")+ylab("Absolute % HbA1c Reduction \n")


# -------



# -----
# ------
# 6 MONTHS BMI ------------
# BMI  reductions of patients exclusively on 1 or 2 therapies ------------
DANU_Ingredients       <- fread("DANU Ingredients New Lookup.csv", integer64 = "character", stringsAsFactors = F)

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)


# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- DIA_Drug_Histories %>%  anti_join(Pats_to_remove)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj| AND SGLT2
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_GLP1Inj_only <- DIA_Drug_Histories %>%  anti_join(Pats_to_remove) 


# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[2] <- "Month_First_GLP1"

# Now get the HbA1c levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first GLP1 Injectable month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient")) %>% drop_na()

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1)-6)
BMI_before_GLP1 <- BMI_before_GLP1 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_GLP1)[3] <- "Month_Prior"
names(BMI_before_GLP1)[2] <- "BMI_Prior"

BMI_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1+6))
BMI_after_GLP1 <- BMI_after_GLP1 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_GLP1)[3] <- "Month_After"
names(BMI_after_GLP1)[2] <- "BMI_After"

#join the before and after BMI
BMI_GLP1_BEFORE_vs_AFTER <- BMI_before_GLP1 %>% full_join(BMI_after_GLP1)
BMI_GLP1_BEFORE_vs_AFTER <- BMI_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) #39.79385
mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) #35.73306

median(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) # 38.3
median(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) # 34.6

write.csv(BMI_GLP1_BEFORE_vs_AFTER, "BMI_GLP1_BEFORE_vs_AFTER_closest_6months_Big_GLP1_only.csv")


# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)


# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


Pats_Biguanide_SGLT2_GLP1Inj_only <- Pats_Biguanide_SGLT2_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[2] <- "Month_First_Combo"

# Now get the HbA1c levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures <- Patient_first_Combo %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first Combo month to his HbA1c readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo)-6)
BMI_before_Combo <- BMI_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_Combo)[3] <- "Month_Prior"
names(BMI_before_Combo)[2] <- "BMI_Prior"

BMI_after_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+6))
BMI_after_Combo <- BMI_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_Combo)[3] <- "Month_After"
names(BMI_after_Combo)[2] <- "BMI_After"

#join the before and after BMI
BMI_Combo_BEFORE_vs_AFTER <- BMI_before_Combo %>% full_join(BMI_after_Combo)
BMI_Combo_BEFORE_vs_AFTER <- BMI_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) # 38.32078
mean(BMI_Combo_BEFORE_vs_AFTER$BMI_After) # 34.23569

median(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) # 37.16
median(BMI_Combo_BEFORE_vs_AFTER$BMI_After) # 33.535

write.csv(BMI_Combo_BEFORE_vs_AFTER, "BMI_Combo_BEFORE_vs_AFTER_closest_6months_Big_SGLT_GLP1Inj_only.csv")



# --------
# How long do patients stay therapy ? --------------------------
BMI_Evolution_US_All_6months_2_classes_only <- fread("BMI_Evolution_US_All_6months_2_classes_only_NEW.csv")


# GLP1 Injectable
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)


DIA_Drug_Histories <-BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# How long were GLP1 pats ON GLP1 Injectable ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

GLP1_Injectable_Pats <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>%
  filter(Month>0) %>% select(patient, Exact_month)

GLP1_Histories_GLP1 <- DIA_Drug_Histories %>%  group_by(patient) %>% inner_join(GLP1_Injectable_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

GLP1_Histories_GLP1 %>% summarise(n=mean(n)) #  7.66
GLP1_Histories_GLP1 %>% summarise(n=median(n)) #  8
GLP1_Histories_GLP1 %>% summarise(n=max(n)) #  36
GLP1_Histories_GLP1 %>% summarise(n=min(n)) #  1

GLP1_Histories_GLP1 %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON GLP1 until BMI read")+ylab("Proportion \n")





# Combo
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# How long were combo pats ON Combo ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <-  fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

Combo_Pats <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>%
  filter(Month>0) %>% select(patient, Exact_month)

Combo_Histories_Combo <- DIA_Drug_Histories %>% group_by(patient) %>% inner_join(Combo_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

Combo_Histories_Combo %>% summarise(n=mean(n)) #  7.03
Combo_Histories_Combo %>% summarise(n=median(n)) #  7
Combo_Histories_Combo %>% summarise(n=max(n)) #  41
Combo_Histories_Combo %>% summarise(n=min(n)) #  1

Combo_Histories_Combo %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON Combo until BMI read")+ylab("Proportion \n")


names(GLP1_Histories_GLP1)[1] <- "patient" 
names(GLP1_Histories_GLP1)[2] <- "Time_Treated" 
GLP1_Histories_GLP1 <- GLP1_Histories_GLP1 %>% mutate(Therapy = "GLP1 Injectable")

names(Combo_Histories_Combo)[1] <- "patient" 
names(Combo_Histories_Combo)[2] <- "Time_Treated" 
Combo_Histories_Combo <- Combo_Histories_Combo %>% mutate(Therapy = "Combo")

BMI_Evolution_US_All_6months_2_classes_only <- BMI_Evolution_US_All_6months_2_classes_only %>% 
  left_join(GLP1_Histories_GLP1, by=c("patient"="patient", "Therapy"="Therapy")) %>% 
  left_join(Combo_Histories_Combo, by=c("patient"="patient", "Therapy"="Therapy")) 


BMI_Evolution_US_All_6months_2_classes_only <- BMI_Evolution_US_All_6months_2_classes_only %>% 
  mutate(Duration = ifelse(!is.na(Time_Treated.x), Time_Treated.x,
                           ifelse(!is.na(Time_Treated.y), Time_Treated.y, NA))) %>%
  select(-c(Time_Treated.x, Time_Treated.y))


BMI_Evolution_US_All_6months_2_classes_only_Before <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Period=="Before")
names(BMI_Evolution_US_All_6months_2_classes_only_Before)[2] <- "Month_Before"
names(BMI_Evolution_US_All_6months_2_classes_only_Before)[3] <- "BMI_Before"
names(BMI_Evolution_US_All_6months_2_classes_only_Before)[4] <- "Exact_Month_Before"
BMI_Evolution_US_All_6months_2_classes_only_Before <- BMI_Evolution_US_All_6months_2_classes_only_Before %>% select(-c(Period, Duration))


BMI_Evolution_US_All_6months_2_classes_only_After <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Period=="After")
names(BMI_Evolution_US_All_6months_2_classes_only_After)[2] <- "Month_After"
names(BMI_Evolution_US_All_6months_2_classes_only_After)[3] <- "BMI_After"
names(BMI_Evolution_US_All_6months_2_classes_only_After)[4] <- "Exact_Month_After"
BMI_Evolution_US_All_6months_2_classes_only_After <- BMI_Evolution_US_All_6months_2_classes_only_After %>% select(-c(Period))


BMI_Evolution_US_All_6months_2_classes_only_Duration <- BMI_Evolution_US_All_6months_2_classes_only_Before %>% 
  left_join(BMI_Evolution_US_All_6months_2_classes_only_After, by=c("patient"="patient","Therapy"="Therapy"))



fwrite(BMI_Evolution_US_All_6months_2_classes_only_Duration, "BMI_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")


# ---------
# BMI reductions ~ treatment duration WITH OLD SGLT2 -------------------

BMI_Evolution_US_All_6months_2_classes_only_Duration <- fread("BMI_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")


BMI_Evolution_US_All_6months_2_classes_only_Duration %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  group_by(Therapy) %>% summarise(n=mean(Difference))

BMI_Evolution_US_All_6months_2_classes_only_Duration %>% 
  filter(BMI_Before>24) %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  group_by(Therapy) %>% count()


BMI_Evolution_US_All_6months_2_classes_only_Duration <- BMI_Evolution_US_All_6months_2_classes_only_Duration 

BMI_Evolution_US_All_6months_2_classes_only_Duration %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2", "GLP1 Injectable","Combo"))) %>%
  ggplot(aes(Difference, colour=Therapy, fill=Therapy)) + 
  geom_density(size=2, alpha=0.7) +
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(-50,20)+
  xlab("\n BMI % Reduction")+ylab(" Cohort Proportion \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()





BMI_Evolution_US_All_6months_2_classes_only_Duration %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2", "GLP1 Injectable","Combo"))) %>%
  ggplot(aes(BMI_Before, BMI_After, colour=Therapy, fill=Therapy)) + 
  geom_point(size=3, alpha=0.5)+
  geom_smooth(method="lm")+
  #xlim(4, 15)+ylim(4,15)+
  geom_abline(slope=1, intercept = 0)+
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n HbA1c Before Therapy")+ylab(" HbA1c After Therapy \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()







# Redution ~ Baseline HbA1c


# SGLT2 

SGLT2_temp <- BMI_Evolution_US_All_6months_2_classes_only_Duration %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  filter(Therapy=="SGLT2") %>% select(BMI_Before, Difference, Duration) 


model_SGLT2 <- lm(Difference ~ BMI_Before, data = SGLT2_temp)

summary(model_SGLT2)

Call:
  lm(formula = Difference ~ BMI_Before, data = SGLT2_temp)

# GLP1 

GLP1_temp <- BMI_Evolution_US_All_6months_2_classes_only_Duration %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  filter(Therapy=="GLP1 Injectable") %>% select(BMI_Before, Difference, Duration) 


model_GLP1 <- lm(Difference ~ BMI_Before, data = GLP1_temp)

summary(model_GLP1)




# Combo 

Combo_temp <- BMI_Evolution_US_All_6months_2_classes_only_Duration %>%  
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  filter(Therapy=="Combo") %>% select(BMI_Before, Difference, Duration) 


model_Combo <- lm(Difference ~ BMI_Before, data = Combo_temp)

summary(model_Combo)




BMI_Reduction_Predictions <- fread("BMI_Reduction_Predictions_ALL.txt")

BMI_Reduction_Predictions <- BMI_Reduction_Predictions %>% filter(Baseline_BMI<=50)
BMI_Reduction_Predictions <- gather(BMI_Reduction_Predictions, Therapy, BMI_Reduction, SGLT2:Combo, factor_key=TRUE)

ggplot(data=BMI_Reduction_Predictions, aes(x=Baseline_BMI , y=BMI_Reduction, colour=Therapy)) + 
  geom_smooth(size=2) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Baseline BMI")+ylab(" % BMI Reduction \n")+
  scale_color_viridis_d()


# -------



# -----------
# ---------
# NEW GLP1 DATA V3 ALL GLP1 PATS //  BMI -----------

# 6 MONTHS BMI ------------
# BMI  reductions of patients exclusively on 1 or 2 therapies ------------
DANU_Ingredients       <- fread("DANU Ingredients New Lookup.csv", integer64 = "character", stringsAsFactors = F)

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)


# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- DIA_Drug_Histories %>%  anti_join(Pats_to_remove)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj| AND SGLT2
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_GLP1Inj_only <- DIA_Drug_Histories %>%  anti_join(Pats_to_remove) 


# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[2] <- "Month_First_GLP1"

# Now get the HbA1c levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP_Measures_BMI.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first GLP1 Injectable month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient")) %>% drop_na()

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1)-6)
BMI_before_GLP1 <- BMI_before_GLP1 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_GLP1)[3] <- "Month_Prior"
names(BMI_before_GLP1)[2] <- "BMI_Prior"

BMI_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1+6))
BMI_after_GLP1 <- BMI_after_GLP1 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_GLP1)[3] <- "Month_After"
names(BMI_after_GLP1)[2] <- "BMI_After"

#join the before and after BMI
BMI_GLP1_BEFORE_vs_AFTER <- BMI_before_GLP1 %>% full_join(BMI_after_GLP1)
BMI_GLP1_BEFORE_vs_AFTER <- BMI_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) 
mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) 

median(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior)
median(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) 

write.csv(BMI_GLP1_BEFORE_vs_AFTER, "BMI_GLP1_BEFORE_vs_AFTER_closest_6months_Big_GLP1_only.csv")


# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)


# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


Pats_Biguanide_SGLT2_GLP1Inj_only <- Pats_Biguanide_SGLT2_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[2] <- "Month_First_Combo"

# Now get the HbA1c levels
# File with HbA1c over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP_Measures_BMI.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures <- Patient_first_Combo %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first Combo month to his HbA1c readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo)-6)
BMI_before_Combo <- BMI_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_Combo)[3] <- "Month_Prior"
names(BMI_before_Combo)[2] <- "BMI_Prior"

BMI_after_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+6))
BMI_after_Combo <- BMI_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_Combo)[3] <- "Month_After"
names(BMI_after_Combo)[2] <- "BMI_After"

#join the before and after BMI
BMI_Combo_BEFORE_vs_AFTER <- BMI_before_Combo %>% full_join(BMI_after_Combo)
BMI_Combo_BEFORE_vs_AFTER <- BMI_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) 
mean(BMI_Combo_BEFORE_vs_AFTER$BMI_After) 

median(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) 
median(BMI_Combo_BEFORE_vs_AFTER$BMI_After) 

write.csv(BMI_Combo_BEFORE_vs_AFTER, "BMI_Combo_BEFORE_vs_AFTER_closest_6months_Big_SGLT_GLP1Inj_only.csv")



# --------
# How long do patients stay therapy ? --------------------------
BMI_Evolution_US_All_6months_2_classes_only <- fread("BMI_Evolution_US_All_6months_2_classes_only_NEW.csv")


# GLP1 Injectable
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)


DIA_Drug_Histories <-BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# How long were GLP1 pats ON GLP1 Injectable ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

GLP1_Injectable_Pats <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1 Injectable") %>%
  filter(Month>0) %>% select(patient, Exact_month)

GLP1_Histories_GLP1 <- DIA_Drug_Histories %>%  group_by(patient) %>% inner_join(GLP1_Injectable_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

GLP1_Histories_GLP1 %>% summarise(n=mean(n)) 
GLP1_Histories_GLP1 %>% summarise(n=median(n)) 
GLP1_Histories_GLP1 %>% summarise(n=max(n)) # 
GLP1_Histories_GLP1 %>% summarise(n=min(n)) # 

GLP1_Histories_GLP1 %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON GLP1 until BMI read")+ylab("Proportion \n")





# Combo
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# How long were combo pats ON Combo ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <-  fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

Combo_Pats <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>%
  filter(Month>0) %>% select(patient, Exact_month)

Combo_Histories_Combo <- DIA_Drug_Histories %>% group_by(patient) %>% inner_join(Combo_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

Combo_Histories_Combo %>% summarise(n=mean(n)) #  7.03
Combo_Histories_Combo %>% summarise(n=median(n)) #  7
Combo_Histories_Combo %>% summarise(n=max(n)) #  41
Combo_Histories_Combo %>% summarise(n=min(n)) #  1

Combo_Histories_Combo %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON Combo until BMI read")+ylab("Proportion \n")


names(GLP1_Histories_GLP1)[1] <- "patient" 
names(GLP1_Histories_GLP1)[2] <- "Time_Treated" 
GLP1_Histories_GLP1 <- GLP1_Histories_GLP1 %>% mutate(Therapy = "GLP1 Injectable")

names(Combo_Histories_Combo)[1] <- "patient" 
names(Combo_Histories_Combo)[2] <- "Time_Treated" 
Combo_Histories_Combo <- Combo_Histories_Combo %>% mutate(Therapy = "Combo")

BMI_Evolution_US_All_6months_2_classes_only <- BMI_Evolution_US_All_6months_2_classes_only %>% 
  left_join(GLP1_Histories_GLP1, by=c("patient"="patient", "Therapy"="Therapy")) %>% 
  left_join(Combo_Histories_Combo, by=c("patient"="patient", "Therapy"="Therapy")) 


BMI_Evolution_US_All_6months_2_classes_only <- BMI_Evolution_US_All_6months_2_classes_only %>% 
  mutate(Duration = ifelse(!is.na(Time_Treated.x), Time_Treated.x,
                           ifelse(!is.na(Time_Treated.y), Time_Treated.y, NA))) %>%
  select(-c(Time_Treated.x, Time_Treated.y))


BMI_Evolution_US_All_6months_2_classes_only_Before <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Period=="Before")
names(BMI_Evolution_US_All_6months_2_classes_only_Before)[2] <- "Month_Before"
names(BMI_Evolution_US_All_6months_2_classes_only_Before)[3] <- "BMI_Before"
names(BMI_Evolution_US_All_6months_2_classes_only_Before)[4] <- "Exact_Month_Before"
BMI_Evolution_US_All_6months_2_classes_only_Before <- BMI_Evolution_US_All_6months_2_classes_only_Before %>% select(-c(Period, Duration))


BMI_Evolution_US_All_6months_2_classes_only_After <- BMI_Evolution_US_All_6months_2_classes_only %>% filter(Period=="After")
names(BMI_Evolution_US_All_6months_2_classes_only_After)[2] <- "Month_After"
names(BMI_Evolution_US_All_6months_2_classes_only_After)[3] <- "BMI_After"
names(BMI_Evolution_US_All_6months_2_classes_only_After)[4] <- "Exact_Month_After"
BMI_Evolution_US_All_6months_2_classes_only_After <- BMI_Evolution_US_All_6months_2_classes_only_After %>% select(-c(Period))


BMI_Evolution_US_All_6months_2_classes_only_Duration <- BMI_Evolution_US_All_6months_2_classes_only_Before %>% 
  left_join(BMI_Evolution_US_All_6months_2_classes_only_After, by=c("patient"="patient","Therapy"="Therapy"))



fwrite(BMI_Evolution_US_All_6months_2_classes_only_Duration, "BMI_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")


# ---------
# BMI reductions ~ treatment duration WITH OLD SGLT2 -------------------

BMI_Evolution_US_All_6months_2_classes_only_Duration <- fread("BMI_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")


BMI_Evolution_US_All_6months_2_classes_only_Duration %>% 
  filter(Duration>=Month_After) %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  group_by(Therapy) %>% summarise(n=mean(Difference))


BMI_Evolution_US_All_6months_2_classes_only_Duration %>% 
  filter(Duration>=Month_After) %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  group_by(Therapy) %>% count()



BMI_Evolution_US_All_6months_2_classes_only_Duration <- BMI_Evolution_US_All_6months_2_classes_only_Duration %>% filter(Duration>=Month_After)

BMI_Evolution_US_All_6months_2_classes_only_Duration <- BMI_Evolution_US_All_6months_2_classes_only_Duration %>% filter(BMI_Before>23)

BMI_Evolution_US_All_6months_2_classes_only_Duration %>%
  filter(Duration>=Month_After) %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2", "GLP1 Injectable","Combo"))) %>%
  ggplot(aes(Difference, colour=Therapy, fill=Therapy)) + 
  geom_density(size=2, alpha=0.7) +
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(-50,20)+
  xlab("\n BMI % Reduction")+ylab(" Cohort Proportion \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()





BMI_Evolution_US_All_6months_2_classes_only_Duration %>%
  filter(Duration>=Month_After) %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("SGLT2", "GLP1 Injectable","Combo"))) %>%
  ggplot(aes(BMI_Before, BMI_After, colour=Therapy, fill=Therapy)) + 
  geom_point(size=3, alpha=0.5)+
  geom_smooth(method="lm")+
  xlim(15, 80)+ylim(15,80)+
  geom_abline(slope=1, intercept = 0)+
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n HbA1c Before Therapy")+ylab(" HbA1c After Therapy \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()







# Redution ~ Baseline HbA1c


# SGLT2 

SGLT2_temp <- BMI_Evolution_US_All_6months_2_classes_only_Duration %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  filter(Therapy=="SGLT2") %>% select(BMI_Before, Difference, Duration) 


model_SGLT2 <- lm(Difference ~ BMI_Before, data = SGLT2_temp)

summary(model_SGLT2)




# GLP1 

GLP1_temp <- BMI_Evolution_US_All_6months_2_classes_only_Duration %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  filter(Therapy=="GLP1 Injectable") %>% select(BMI_Before, Difference, Duration) 


model_GLP1 <- lm(Difference ~ BMI_Before, data = GLP1_temp)

summary(model_GLP1)



# Combo 

Combo_temp <- BMI_Evolution_US_All_6months_2_classes_only_Duration %>%  
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  filter(Therapy=="Combo") %>% select(BMI_Before, Difference, Duration) 


model_Combo <- lm(Difference ~ BMI_Before, data = Combo_temp)

summary(model_Combo)




# -------


# --------
# ---------
# Split Diabetes patients into T2 only and T2D+Obesity ---------

DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DANU_Demographics <- fread("DANU Demographics.txt")

DANU_Demographics <- DANU_Demographics %>% select(patid, diagnosis) %>% filter(diagnosis=="Diabetes"|diagnosis=="Diabetes + Obesity")

names(DANU_Demographics)[1] <- "patient"

DIA_Drug_Histories_Comorbid <- DANU_Demographics %>% filter(diagnosis=="Diabetes + Obesity") %>% select(patient) %>% inner_join(DIA_Drug_Histories)
DIA_Drug_Histories_only <- DANU_Demographics %>% filter(diagnosis=="Diabetes") %>% select(patient) %>% inner_join(DIA_Drug_Histories)

fwrite(DIA_Drug_Histories_Comorbid, "DIA Drug Histories Comorbid.txt", sep="\t")
fwrite(DIA_Drug_Histories_only, "DIA Drug Histories T2D only.txt", sep="\t")

# --------
# HbA1c of T2 only and T2D+Obesity --------------------

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <-DANU_Measures %>% select(patient, test, claimed, value)

DIA_Drug_Histories_Comorbid <- fread("DIA Drug Histories Comorbid.txt", sep="\t")
DIA_Drug_Histories_only <- fread("DIA Drug Histories T2D only.txt", sep="\t")

DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% select(patient)
DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% select(patient)

# Mean of all records 
DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  summarise(n=mean(value)) # 7.145018

DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  summarise(n=mean(value)) # 6.861185


# Mean of max record
DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup() %>% summarise(n=mean(value)) # 7.66


DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup() %>%
  ggplot(aes(value))+
  geom_density(colour="firebrick", fill="firebrick", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(4,20)+
  xlab("\n Max HbA1c recorded")+ylab(" Cohort Proportion \n")


DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient)%>% filter(value==max(value)) %>% slice(1) %>% ungroup() %>% summarise(n=mean(value)) # 7.05


DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup() %>%
  ggplot(aes(value))+
  geom_density(colour="midnightblue", fill="midnightblue", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(4,20)+
  xlab("\n Max HbA1c recorded")+ylab(" Cohort Proportion \n")




# Mean of last records 
DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% summarise(n=mean(value)) # 6.86

DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>%  slice(n()) %>% ungroup() %>%
  ggplot(aes(value))+
  geom_density(colour="firebrick", fill="firebrick", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(4,20)+
  xlab("\n Max HbA1c recorded")+ylab(" Cohort Proportion \n")

DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% summarise(n=mean(value)) # 6.56

DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>%  slice(n()) %>% ungroup() %>%
  ggplot(aes(value))+
  geom_density(colour="midnightblue", fill="midnightblue", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(4,20)+
  xlab("\n Max HbA1c recorded")+ylab(" Cohort Proportion \n")



# Per stock ON month 60, closets read

DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Box, month1:month60, factor_key=TRUE)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Box = str_sub(Box, 2L, 2L))
DIA_Box_Histories$Month <- as.character(DIA_Box_Histories$Month)
DIA_Box_Histories$Month <- parse_number(DIA_Box_Histories$Month)
DIA_Box_Histories <- DIA_Box_Histories %>% filter(Month==60)
DIA_Box_Histories <- DIA_Box_Histories %>% select(patient, Box)

DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% left_join(DIA_Box_Histories)
DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% left_join(DIA_Box_Histories)


DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% group_by(Box) %>% summarise(n=mean(value)) 



DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% 
  mutate(Box = factor(Box, levels=c("x", "b", "d", "D", "S", "g", "G", "I"))) %>% group_by(Box) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = Box, colour=Box), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~Box, ncol = 8)+
  ggsci::scale_colour_jco()+
  ggsci::scale_fill_jco()+
  coord_flip()+
  xlim(4,12)+
  xlab("HbA1c (%)\n")+ ylab("\nProportion of patients")





DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% group_by(Box) %>% summarise(n=mean(value)) 



DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% 
  mutate(Box = factor(Box, levels=c("x", "b", "d", "D", "S", "g", "G", "I"))) %>% group_by(Box) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = Box, colour=Box), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~Box, ncol = 8)+
  ggsci::scale_colour_jco()+
  ggsci::scale_fill_jco()+
  coord_flip()+
  xlim(4,12)+
  xlab("HbA1c (%)\n")+ ylab("\nProportion of patients")



# All records, stock on month of records

Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")

DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))



DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Box, month1:month60, factor_key=TRUE)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Box = str_sub(Box, 2L, 2L))
DIA_Box_Histories$Month <- as.character(DIA_Box_Histories$Month)
DIA_Box_Histories$Month <- parse_number(DIA_Box_Histories$Month)
DIA_Box_Histories <- DIA_Box_Histories %>% select(patient, Box, Month)

DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% select(patient) %>% distinct() %>% left_join(DIA_Box_Histories)
DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% select(patient) %>% distinct() %>% left_join(DIA_Box_Histories)


DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level"), by=c("patient"="patient", "Month"="Exact_Month")) %>%
   group_by(Box) %>% summarise(n=mean(value)) 



DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level"), 
                                           by=c("patient"="patient", "Month"="Exact_Month")) %>%
  mutate(Box = factor(Box, levels=c("x", "b", "d", "D", "S", "g", "G", "I"))) %>% group_by(Box) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = Box, colour=Box), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~Box, ncol = 8)+
  ggsci::scale_colour_jco()+
  ggsci::scale_fill_jco()+
  coord_flip()+
  xlim(4,12)+
  xlab("HbA1c (%)\n")+ ylab("\nProportion of patients")

DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level"), by=c("patient"="patient", "Month"="Exact_Month")) %>%
  group_by(Box) %>% summarise(n=mean(value)) 



DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="HbA1c Level"), 
                                           by=c("patient"="patient", "Month"="Exact_Month")) %>%
  mutate(Box = factor(Box, levels=c("x", "b", "d", "D", "S", "g", "G", "I"))) %>% group_by(Box) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = Box, colour=Box), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~Box, ncol = 8)+
  ggsci::scale_colour_jco()+
  ggsci::scale_fill_jco()+
  coord_flip()+
  xlim(4,12)+
  xlab("HbA1c (%)\n")+ ylab("\nProportion of patients")




# ------
# AST/ALT of T2 only and T2D+Obesity --------

DIA_Drug_Histories_Comorbid <- fread("DIA Drug Histories Comorbid.txt", sep="\t")
DIA_Drug_Histories_only <- fread("DIA Drug Histories T2D only.txt", sep="\t")
DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% select(patient)
DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% select(patient)


# From NASH DANU Meaures 3.1
DANU_Measures <- fread("DANU Measures.txt", integer64 = "character", stringsAsFactors = F)

unique(DANU_Measures$test)

DANU_Measures <- DANU_Measures %>% filter(test=="AST Level"|test=="ALT Level"|test=="Platelet Count")
DANU_Measures <- DANU_Measures %>% select(patid, test, claimed, value)
names(DANU_Measures)[1] <- "patient"

DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures)
DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% inner_join(DANU_Measures)


DIA_Drug_Histories_Comorbid %>% filter(test=="AST Level") %>% mutate(Group="Comorbid") %>%
  bind_rows(DIA_Drug_Histories_only %>% filter(test=="AST Level") %>% mutate(Group="T2DM_only")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>%
  #filter(value<75&value>10) %>%
  group_by(Group) %>% summarise(n=mean(value))


DIA_Drug_Histories_Comorbid %>% filter(test=="AST Level") %>% mutate(Group="Comorbid") %>%
  bind_rows(DIA_Drug_Histories_only %>% filter(test=="AST Level") %>% mutate(Group="T2DM_only")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>%
  filter(value<75&value>10) %>%
  ggplot(aes(x = value, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n AST (IU/L)") + ylab("Disease Group \n")



DIA_Drug_Histories_Comorbid %>% filter(test=="ALT Level") %>% mutate(Group="Comorbid") %>%
  bind_rows(DIA_Drug_Histories_only %>% filter(test=="ALT Level") %>% mutate(Group="T2DM_only")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>%
  #filter(value<75&value>10) %>%
  group_by(Group) %>% summarise(n=mean(value))


DIA_Drug_Histories_Comorbid %>% filter(test=="ALT Level") %>% mutate(Group="Comorbid") %>%
  bind_rows(DIA_Drug_Histories_only %>% filter(test=="ALT Level") %>% mutate(Group="T2DM_only")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>%
  filter(value<75&value>10) %>%
  ggplot(aes(x = value, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n ALT (IU/L)") + ylab("Disease Group \n")






DIA_Drug_Histories_Comorbid %>% filter(test=="Platelet Count") %>% mutate(Group="Comorbid") %>%
  bind_rows(DIA_Drug_Histories_only %>% filter(test=="Platelet Count") %>% mutate(Group="T2DM_only")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>%
  #filter(value<75&value>10) %>%
  group_by(Group) %>% summarise(n=mean(value))


DIA_Drug_Histories_Comorbid %>% filter(test=="ALT Level") %>% mutate(Group="Comorbid") %>%
  bind_rows(DIA_Drug_Histories_only %>% filter(test=="ALT Level") %>% mutate(Group="T2DM_only")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>%
  filter(value<75&value>10) %>%
  ggplot(aes(x = value, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n ALT (IU/L)") + ylab("Disease Group \n")

# ------------

# BMI of T2 only and T2D+Obesity --------------------

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <-DANU_Measures %>% select(patient, test, claimed, value)

DIA_Drug_Histories_Comorbid <- fread("DIA Drug Histories Comorbid.txt", sep="\t")
DIA_Drug_Histories_only <- fread("DIA Drug Histories T2D only.txt", sep="\t")

DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% select(patient)
DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% select(patient)

# Mean of all records 
DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  summarise(n=mean(value)) # 33.83289

DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  summarise(n=mean(value)) # 21.42632


# Mean of max record
DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup() %>% summarise(n=mean(value)) # 35.3


DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup() %>%
  ggplot(aes(value))+
  geom_density(colour="firebrick", fill="firebrick", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(20,70)+
  xlab("\n Max BMI recorded")+ylab(" Cohort Proportion \n")


DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient)%>% filter(value==max(value)) %>% slice(1) %>% ungroup() %>% summarise(n=mean(value)) # 7.05


DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup() %>%
  ggplot(aes(value))+
  geom_density(colour="midnightblue", fill="midnightblue", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(20,30)+
  xlab("\n Max BMI recorded")+ylab(" Cohort Proportion \n")




# Mean of last records 
DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% summarise(n=mean(value)) # 33.3

DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>%  slice(n()) %>% ungroup() %>%
  ggplot(aes(value))+
  geom_density(colour="firebrick", fill="firebrick", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(20,70)+
  xlab("\n Max BMI recorded")+ylab(" Cohort Proportion \n")



DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% summarise(n=mean(value)) # 22.0

DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>%  slice(n()) %>% ungroup() %>%
  ggplot(aes(value))+
  geom_density(colour="midnightblue", fill="midnightblue", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(15,30)+
  xlab("\n Max BMI recorded")+ylab(" Cohort Proportion \n")



# Per stock ON month 60, closest read

DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Box, month1:month60, factor_key=TRUE)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Box = str_sub(Box, 2L, 2L))
DIA_Box_Histories$Month <- as.character(DIA_Box_Histories$Month)
DIA_Box_Histories$Month <- parse_number(DIA_Box_Histories$Month)
DIA_Box_Histories <- DIA_Box_Histories %>% filter(Month==60)
DIA_Box_Histories <- DIA_Box_Histories %>% select(patient, Box)

DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% left_join(DIA_Box_Histories)
DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% left_join(DIA_Box_Histories)


DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% group_by(Box) %>% summarise(n=mean(value)) 


DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% 
  mutate(Box = factor(Box, levels=c("x", "b", "d", "D", "S", "g", "G", "I"))) %>% group_by(Box) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = Box, colour=Box), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~Box, ncol = 8)+
  ggsci::scale_colour_jco()+
  ggsci::scale_fill_jco()+
  coord_flip()+
  xlim(15,70)+
  xlab("BMI\n")+ ylab("\nProportion of patients")





DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% group_by(Box) %>% summarise(n=mean(value)) 


DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="BMI")) %>%
  group_by(patient) %>% slice(n()) %>% ungroup() %>% 
  mutate(Box = factor(Box, levels=c("x", "b", "d", "D", "S", "g", "G", "I"))) %>% group_by(Box) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = Box, colour=Box), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~Box, ncol = 8)+
  ggsci::scale_colour_jco()+
  ggsci::scale_fill_jco()+
  coord_flip()+
  xlim(15,30)+
  xlab("BMI (%)\n")+ ylab("\nProportion of patients")



# All records, stock on month of records

Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")

DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month))



DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Box, month1:month60, factor_key=TRUE)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Box = str_sub(Box, 2L, 2L))
DIA_Box_Histories$Month <- as.character(DIA_Box_Histories$Month)
DIA_Box_Histories$Month <- parse_number(DIA_Box_Histories$Month)
DIA_Box_Histories <- DIA_Box_Histories %>% select(patient, Box, Month)

DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% select(patient) %>% distinct() %>% left_join(DIA_Box_Histories)
DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% select(patient) %>% distinct() %>% left_join(DIA_Box_Histories)


DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="BMI"), by=c("patient"="patient", "Month"="Exact_Month")) %>%
  group_by(Box) %>% summarise(n=mean(value)) 



DIA_Drug_Histories_Comorbid %>% inner_join(DANU_Measures %>% filter(test=="BMI"), 
                                           by=c("patient"="patient", "Month"="Exact_Month")) %>%
  mutate(Box = factor(Box, levels=c("x", "b", "d", "D", "S", "g", "G", "I"))) %>% group_by(Box) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = Box, colour=Box), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~Box, ncol = 8)+
  ggsci::scale_colour_jco()+
  ggsci::scale_fill_jco()+
  coord_flip()+
  xlim(15,70)+
  xlab("BMI (%)\n")+ ylab("\nProportion of patients")

DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="BMI"), by=c("patient"="patient", "Month"="Exact_Month")) %>%
  group_by(Box) %>% summarise(n=mean(value)) 



DIA_Drug_Histories_only %>% inner_join(DANU_Measures %>% filter(test=="BMI"), 
                                       by=c("patient"="patient", "Month"="Exact_Month")) %>%
  mutate(Box = factor(Box, levels=c("x", "b", "d", "D", "S", "g", "G", "I"))) %>% group_by(Box) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = Box, colour=Box), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~Box, ncol = 8)+
  ggsci::scale_colour_jco()+
  ggsci::scale_fill_jco()+
  coord_flip()+
  xlim(18,28)+
  xlab("BMI (%)\n")+ ylab("\nProportion of patients")


# --------
# Concomitant diseases of T2 only and T2D+Obesity  -------------------------
DIA_Drug_Histories_Comorbid <- fread("DIA Drug Histories Comorbid.txt", sep="\t")
DIA_Drug_Histories_only <- fread("DIA Drug Histories T2D only.txt", sep="\t")

DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% select(patient)
DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% select(patient)

DIA_Disorder_Histories <- fread("DIA Disorder Histories.txt")
DIA_Disorder_Histories <- DIA_Disorder_Histories %>% select(patient, month60)
DIA_Disorder_Histories$month60 <- as.character(DIA_Disorder_Histories$month60)
DIA_Disorder_Histories$score <- parse_number(DIA_Disorder_Histories$month60)

DIA_Drug_Histories_Comorbid %>% left_join(DIA_Disorder_Histories) %>% summarise(n=mean(score)) # 5.587956
DIA_Drug_Histories_only %>% left_join(DIA_Disorder_Histories) %>% summarise(n=mean(score)) # 5.312362

DIA_Drug_Histories_Comorbid <-  DIA_Drug_Histories_Comorbid %>% left_join(DIA_Disorder_Histories)
DIA_Drug_Histories_only <-  DIA_Drug_Histories_only %>% left_join(DIA_Disorder_Histories)


length(unique(DIA_Drug_Histories_Comorbid$patient)) #288998
length(unique(DIA_Drug_Histories_only$patient)) #55202



DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% mutate(comorbs = str_extract(month60, "[a-z]+"))
DIA_Drug_Histories_Comorbid <- DIA_Drug_Histories_Comorbid %>% mutate(comorbs = ifelse(is.na(comorbs), "-", comorbs))
DIA_Drug_Histories_Comorbid <- separate_rows(DIA_Drug_Histories_Comorbid, comorbs, sep = "", convert=F )
DIA_Drug_Histories_Comorbid %>% group_by(comorbs) %>% count() %>% mutate(percent = n/288998)
 


DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% mutate(comorbs = str_extract(month60, "[a-z]+"))
DIA_Drug_Histories_only <- DIA_Drug_Histories_only %>% mutate(comorbs = ifelse(is.na(comorbs), "-", comorbs))
DIA_Drug_Histories_only <- separate_rows(DIA_Drug_Histories_only, comorbs, sep = "", convert=F )
DIA_Drug_Histories_only %>% group_by(comorbs) %>% count() %>% mutate(percent = n/55202)


# -----------

# Develop a classification method for GLP1 Experience ---------------


# Cumulative drug class experience every month 
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(s1, s2, p1_RxExp, flow, weight))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_OralExp = ifelse(grepl("47",d1)|grepl("47",d2),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = cumsum(p1_OralExp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_OralExp = ifelse(p1_OralExp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_InjExp = ifelse(grepl("48",d1)|grepl("49",d1)|grepl("50",d1)|
                                                                           grepl("51",d1)|grepl("52",d1)|grepl("53",d1)|grepl("48",d2)|
                                                                           grepl("49",d2)|grepl("50",d2)|grepl("51",d2)|grepl("52",d2)|grepl("53",d2),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = cumsum(p1_InjExp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InjExp = ifelse(p1_InjExp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_InsulinExp = ifelse(grepl("38",d1)|grepl("39",d1)|grepl("40",d1)|grepl("41",d1)|grepl("42",d1)|
                                                                               grepl("43",d1)|grepl("44",d1)|grepl("45",d1)|grepl("46",d1)|grepl("38",d2)|
                                                                               grepl("39",d2)|grepl("40",d2)|grepl("41",d2)|grepl("42",d2)|grepl("43",d2)|
                                                                               grepl("44",d2)|grepl("45",d2)|grepl("46",d2),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InsulinExp = cumsum(p1_InsulinExp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_InsulinExp = ifelse(p1_InsulinExp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_SGLT2Exp = ifelse(grepl("34",d1)|grepl("35",d1)|grepl("36",d1)|grepl("37",d1)|
                                                                             grepl("34",d2)|grepl("35",d2)|grepl("36",d2)|grepl("37",d2),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_SGLT2Exp = cumsum(p1_SGLT2Exp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_SGLT2Exp = ifelse(p1_SGLT2Exp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_DPP4Exp = ifelse(grepl("30",d1)|grepl("31",d1)|grepl("32",d1)|grepl("33",d1)|
                                                                            grepl("30",d2)|grepl("31",d2)|grepl("32",d2)|grepl("33",d2),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_DPP4Exp = cumsum(p1_DPP4Exp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_DPP4Exp = ifelse(p1_DPP4Exp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_AntiDiabeticExp = ifelse(grepl("14",d1)|grepl("15",d1)|grepl("16",d1)|grepl("17",d1)|
                                                                                    grepl("18",d1)|grepl("19",d1)|grepl("20",d1)|grepl("21",d1)|
                                                                                    grepl("22",d1)|grepl("23",d1)|grepl("24",d1)|grepl("25",d1)|grepl("26",d1)|
                                                                                    grepl("27",d1)|grepl("28",d1)|grepl("29",d1)|grepl("14",d2)|grepl("15",d2)|
                                                                                    grepl("16",d2)|grepl("17",d2)|grepl("18",d2)|grepl("19",d2)|grepl("20",d2)|
                                                                                    grepl("21",d2)|grepl("22",d2)|grepl("23",d2)|grepl("24",d2)|grepl("25",d2)|
                                                                                    grepl("26",d2)|grepl("27",d2)|grepl("28",d2)|grepl("29",d2),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_AntiDiabeticExp = cumsum(p1_AntiDiabeticExp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_AntiDiabeticExp = ifelse(p1_AntiDiabeticExp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1_BiguanideExp = ifelse(grepl("(^|\\D)(1{1})(\\D|$)",d1)|grepl("(^|\\D)(1{1})(\\D|$)",d2),1,0))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_BiguanideExp = cumsum(p1_BiguanideExp))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(p1_BiguanideExp = ifelse(p1_BiguanideExp==0,0,1))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(d1, d2))

fwrite(DIA_Flows_Aux._Long, "Cum_Class_Experience_EveryMonth.txt", sep="\t")

# Patients that get to the end experienced in Injectables  vs naive 
temp <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

temp <- temp %>% filter(p2==60) %>% filter((p1_OralExp==0 & p1_InjExp==1 & p1_InsulinExp==1 & p1_SGLT2Exp==0 &
                                              p1_DPP4Exp==0 & p1_AntiDiabeticExp==0 & p1_BiguanideExp==0)| 
                                             (p1_OralExp==0 & p1_InjExp==0 & p1_InsulinExp==0 & p1_SGLT2Exp==0 &
                                                p1_DPP4Exp==0 & p1_AntiDiabeticExp==0 & p1_BiguanideExp==0))

temp %>% filter((p1_OralExp==0 & p1_InjExp==1 & p1_InsulinExp==1 & p1_SGLT2Exp==0 &
                   p1_DPP4Exp==0 & p1_AntiDiabeticExp==0 & p1_BiguanideExp==0)) %>% count() # 2920

temp %>% filter((p1_OralExp==0 & p1_InjExp==0 & p1_InsulinExp==0 & p1_SGLT2Exp==0 &
                   p1_DPP4Exp==0 & p1_AntiDiabeticExp==0 & p1_BiguanideExp==0)) %>% count() # 123520







# Get MAX HbA1c & MAX BMI & GENDER & MAX AGE & Comorbidity status per patient
# Demographics
DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% filter(diagnosis=="Diabetes"|diagnosis=="Diabetes + Obesity")
names(DANU_Demographics)[1] <- "patient"

DANU_Demographics <- DANU_Demographics %>% select(patient, age, gender, diagnosis)







#MAX HbA1c & BMI
DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <-DANU_Measures %>% select(patient, test, value)

MAX_HbA1c <- DANU_Measures %>% filter(test=="HbA1c Level") %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
names(MAX_HbA1c)[4] <- "MAX_HbA1c"
MAX_HbA1c <- MAX_HbA1c[,c(1,4)]

MAX_BMI <- DANU_Measures %>% filter(test=="BMI") %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
names(MAX_BMI)[4] <- "MAX_BMI"
MAX_BMI <- MAX_BMI[,c(1,4)]

DANU_Demographics <- DANU_Demographics %>% left_join(MAX_HbA1c) %>% left_join(MAX_BMI)







#MAX AST & ALT
# From NASH DANU Meaures 3.1
DANU_Measures <- fread("DANU Measures.txt", integer64 = "character", stringsAsFactors = F)

DANU_Measures <- DANU_Measures %>% filter(test=="AST Level"|test=="ALT Level")
DANU_Measures <- DANU_Measures %>% select(patid, test, value)
names(DANU_Measures)[1] <- "patient"

MAX_AST <- DANU_Measures %>% filter(test=="AST Level") %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
names(MAX_AST)[3] <- "MAX_AST"
MAX_AST <- MAX_AST[,c(1,3)]

MAX_ALT <- DANU_Measures %>% filter(test=="ALT Level") %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
names(MAX_ALT)[3] <- "MAX_AST"
MAX_ALT <- MAX_ALT[,c(1,3)]

DANU_Demographics <- DANU_Demographics %>% left_join(MAX_AST) %>% left_join(MAX_ALT)

fwrite(DANU_Demographics, "MAX_Labs_Demographics.txt", sep="\t")

















# Number of lines and number of drugs and number of flows 

# Flows
Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(s1, s2, p1_RxExp, weight))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(cumflow = cumsum(flow))

Cummulative_Flows <- DIA_Flows_Aux._Long  %>% select(patient, p1, p2, cumflow)

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% left_join(Cummulative_Flows)

fwrite(Cum_Class_Experience_EveryMonth, "Cum_Class_Experience_EveryMonth.txt", sep="\t")









# Lines
drgDIA2 <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

data <- data.frame(drgDIA2, stringsAsFactors = F)

nrLines <- data[,c(1:3)] 
nrLines$month1 <- (data$month1 != "-")*1

for(i in 2:60){
  cat(i)
  nrLines[,i+3] <- apply(data[,(4:(i+3))], 1, function(x) length(unique(x[x!="-"])))
  names(nrLines)[i+3] <- paste0("month",i)
}

fwrite(nrLines,"DIA_nrLines_Histories.txt")

nrLines <- gather(nrLines, Month, Lines, month1:month60, factor_key=TRUE)

nrLines <- nrLines %>% select(patient, Month, Lines)

nrLines$Month <- as.character(nrLines$Month)
nrLines$Month <- parse_number(nrLines$Month)

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% left_join(nrLines, by=c("patient"="patient", "p2"="Month"))

fwrite(Cum_Class_Experience_EveryMonth, "Cum_Class_Experience_EveryMonth.txt", sep="\t")


# Nr drugs cumm

DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-weight)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)

DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Drugs != "-")

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>% distinct()
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, Drugs, sep = ",", convert=T )

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% count()

names(DIA_Drug_Histories)[2] <- "Diff_Drugs_exp"


fwrite(DIA_Drug_Histories, "Number_Drugs_EverExperienced.txt", sep="\t")









# Physicians Experience
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient)

Dia_US_Doses <- fread("DIA Doses.txt")
Dia_US_Doses <- Dia_US_Doses %>% filter(status != "G")
Dia_US_Doses <- Dia_US_Doses %>% select(-c(drug_id, weight, dayssup, taxonomy1, taxonomy2, status))
Dia_US_Doses <- Dia_US_Doses %>% mutate(from_dt = as.Date(from_dt))
Dia_US_Doses <- Dia_US_Doses %>%filter(from_dt >= "2016-05-01" & from_dt <= "2021-04-30") 
names(Dia_US_Doses)[4] <- "patient"


Dia_US_Doses <- DIA_Drug_Histories %>% left_join(Dia_US_Doses)

PROVCAT <- fread("PROVCAT.txt", sep="|")
PROVCAT$PROVCAT <- sub("^0+", "", PROVCAT$PROVCAT)  
PROVCAT <- PROVCAT %>% mutate(PROVCAT = ifelse(PROVCAT=="","0",PROVCAT))
PROVCAT$PROVCAT <- as.numeric(PROVCAT$PROVCAT)

Specialties_to_keep <- fread("Specialties_to_keep.txt")

temp <- Dia_US_Doses %>% select(patient, specialty) %>% distinct() %>% 
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) %>%
  select(patient, PHYSICIAN) %>% distinct() %>% mutate(Physician_Exp = 1) %>% 
  spread(key=PHYSICIAN, value=Physician_Exp) %>% select(-c(5,10,11,13))

length(unique(temp$patient))

temp[is.na(temp)] <- 0

fwrite(temp, "Physicians_Experience.txt", sep="\t")



# Logistic regression GLP1 Inj Exp vs No Exp

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Physicians_Experience <- fread("Physicians_Experience.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Physicians_Experience)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(Dems_Labs_TreatExp)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_InjExp==1, "GLP1_Exp", "No_GLP1"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_GLP1")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_InjExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))

Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(14000)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()



create_train_test <- function(data, size = 0.8, train = TRUE) {
  n_row = nrow(data)
  total_row = size * n_row
  train_sample <- 1: total_row
  if (train == TRUE) {
    return (data[train_sample, ])
  } else {
    return (data[-train_sample, ])
  }
}



Dems_Labs_TreatExp <- Dems_Labs_TreatExp[sample(1:nrow(Dems_Labs_TreatExp)), ]

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(c(Group, age, gender, diagnosis, Lines, p1_SGLT2Exp, ENDOCRINOLOGY, `EMERGENCY MEDICINE` ))

data_train <- create_train_test(Dems_Labs_TreatExp, 0.8, train = TRUE)
data_test <- create_train_test(Dems_Labs_TreatExp, 0.8, train = FALSE)

Risk_pred_model <- glm( Group ~ ., data = data_train, family = binomial)

summary(Risk_pred_model)

predict <- predict(Risk_pred_model, data_test, type = 'response')

table_mat <- table(data_test$Group, predict > 0.50)
table_mat

plot(table_mat)

accuracy_Test <- sum(diag(table_mat)) / sum(table_mat)
accuracy_Test


precision <- function(matrix) {
  # True positive
  tp <- matrix[2, 2]
  # false positive
  fp <- matrix[1, 2]
  return (tp / (tp + fp))
}



recall <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]# false positive
  fn <- matrix[2, 1]
  return (tp / (tp + fn))
}


prec <- precision(table_mat)
prec # 0.8196265

rec <- recall(table_mat)
rec # 0.7499091

f1 <- 2 * ((prec * rec) / (prec + rec))
f1 # 0.7832194



ggcorr(Dems_Labs_TreatExp, method = c("pairwise", "spearman"),
       nbreaks = 6, hjust = 0.8,label = TRUE,label_size = 3, color = "grey50")



Dems_Labs_TreatExp %>% filter(MAX_BMI<65) %>% ggplot(aes(x = MAX_BMI, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Max BMI") + ylab("GLP1 Injectable Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(MAX_BMI))



Dems_Labs_TreatExp %>% filter(MAX_HbA1c>3&MAX_HbA1c<15) %>% ggplot(aes(x = MAX_HbA1c, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Max HbA1c") + ylab("GLP1 Injectable Experience \n")


Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(MAX_HbA1c))



Dems_Labs_TreatExp %>% ggplot(aes(x = age, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Age") + ylab("GLP1 Injectable Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(age))

Dems_Labs_TreatExp %>% filter(MAX_AST<80) %>% ggplot(aes(x = MAX_AST, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n MAX AST") + ylab("GLP1 Injectable Experience \n")


Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(MAX_AST))



Dems_Labs_TreatExp %>% filter(MAX_ALT<80) %>% ggplot(aes(x = MAX_ALT, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n MAX ALT") + ylab("GLP1 Injectable Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(MAX_ALT))




Dems_Labs_TreatExp %>% filter(cumflow<30) %>% ggplot(aes(x = cumflow, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Flows") + ylab("GLP1 Injectable Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(cumflow))


Dems_Labs_TreatExp %>% filter(Lines<15) %>% ggplot(aes(x = Lines, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Terapy Lines") + ylab("GLP1 Injectable Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(Lines))



Dems_Labs_TreatExp %>% filter(Diff_Drugs_exp<40) %>% ggplot(aes(x = Diff_Drugs_exp, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Different Molecules") + ylab("GLP1 Injectable Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(Diff_Drugs_exp))

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_OralExp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Oral GLP1 Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_InsulinExp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Insulin Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_SGLT2Exp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "SGLT2 Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_DPP4Exp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "DPP4 Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_AntiDiabeticExp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Antidiabetics Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_BiguanideExp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Biguanide Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(ENDOCRINOLOGY))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Endocrionology Experience")+
  scale_fill_viridis_d()


_Odd_ratios_GLP1_noGLP1_TreatExt <- fread("Odd_ratios_GLP1_noGLP1_TreatExt_short.txt", sep="\t")

Odd_ratios_GLP1_noGLP1_TreatExt$Predictor <- as.factor(Odd_ratios_GLP1_noGLP1_TreatExt$Predictor)

Odd_ratios_GLP1_noGLP1_TreatExt <- Odd_ratios_GLP1_noGLP1_TreatExt %>% arrange(`Odd ratio`)

Odd_ratios_GLP1_noGLP1_TreatExt <- Odd_ratios_GLP1_noGLP1_TreatExt %>% filter(`Sig. ?`!="ns")

Odd_ratios_GLP1_noGLP1_TreatExt %>%
  filter(Predictor=="DPP4 Exp"|Predictor=="Antidiabetic Exp"|Predictor=="Biguanide Exp"|Predictor=="Insulin Exp"|Predictor=="Oral GLP1 Exp"| Predictor=="SGLT2 Exp") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylim(0.5,1.5)+
  ylab("\n Odd ratio (Lower-Upper ends)")



Odd_ratios_GLP1_noGLP1_TreatExt %>%
  filter(Predictor=="Nephrology"|Predictor=="Obestretics & Gyne."|Predictor=="Emergency Medicine"|Predictor=="Geriatrics"|Predictor=="Internal Medicine"| Predictor=="Cardiology"|Predictor=="PCP"| Predictor=="Endocrinology") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")



Odd_ratios_GLP1_noGLP1_TreatExt %>%
  filter(Predictor=="Gender"|Predictor=="Nr Flows"|Predictor=="Age"|Predictor=="Weight"|Predictor=="AST"| Predictor=="ALT"|Predictor=="HbA1c"| Predictor=="BMI"|Predictor=="Nr Diff. Molecules"| Predictor=="Nr Therapy Lines"| Predictor=="Obesity comorb") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")












# Logistic regression GLP1 Oral Exp vs No Exp

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Physicians_Experience <- fread("Physicians_Experience.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Physicians_Experience)


Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(Dems_Labs_TreatExp)


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_OralExp==1, "GLP1_Exp", "No_GLP1"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_GLP1")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_OralExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))

Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(668)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()


# Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(age=scale(age),
#                               MAX_HbA1c =scale(MAX_HbA1c ),
#                               MAX_BMI =scale(MAX_BMI ),
#                               MAX_ALT =scale(MAX_ALT ),
#                               MAX_AST =scale(MAX_AST ),
#                               age=scale(age))




create_train_test <- function(data, size = 0.8, train = TRUE) {
  n_row = nrow(data)
  total_row = size * n_row
  train_sample <- 1: total_row
  if (train == TRUE) {
    return (data[train_sample, ])
  } else {
    return (data[-train_sample, ])
  }
}



Dems_Labs_TreatExp <- Dems_Labs_TreatExp[sample(1:nrow(Dems_Labs_TreatExp)), ]

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(c(Group, age, Lines, p1_InsulinExp, p1_SGLT2Exp ))

data_train <- create_train_test(Dems_Labs_TreatExp, 0.8, train = TRUE)
data_test <- create_train_test(Dems_Labs_TreatExp, 0.8, train = FALSE)

Risk_pred_model <- glm( Group ~ ., data = data_train, family = binomial)

summary(Risk_pred_model)

predict <- predict(Risk_pred_model, data_test, type = 'response')

table_mat <- table(data_test$Group, predict > 0.50)
table_mat

plot(table_mat)

accuracy_Test <- sum(diag(table_mat)) / sum(table_mat)
accuracy_Test


precision <- function(matrix) {
  # True positive
  tp <- matrix[2, 2]
  # false positive
  fp <- matrix[1, 2]
  return (tp / (tp + fp))
}



recall <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]# false positive
  fn <- matrix[2, 1]
  return (tp / (tp + fn))
}


prec <- precision(table_mat)
prec # 0.7637795

rec <- recall(table_mat)
rec # 0.6830986

f1 <- 2 * ((prec * rec) / (prec + rec))
f1 # 0.7211896



ggcorr(Dems_Labs_TreatExp, method = c("pairwise", "spearman"),
       nbreaks = 6, hjust = 0.8,label = TRUE,label_size = 3, color = "grey50")



Dems_Labs_TreatExp %>% filter(MAX_BMI<65) %>% ggplot(aes(x = MAX_BMI, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Max BMI") + ylab("GLP1 Oral Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(MAX_BMI))



Dems_Labs_TreatExp %>% filter(MAX_HbA1c>3&MAX_HbA1c<15) %>% ggplot(aes(x = MAX_HbA1c, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Max HbA1c") + ylab("GLP1 Oral Experience \n")


Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(MAX_HbA1c))

Dems_Labs_TreatExp %>% ggplot(aes(x = age, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Age") + ylab("GLP1 Oral Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(age))


Dems_Labs_TreatExp %>% filter(MAX_AST<80) %>% ggplot(aes(x = MAX_AST, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n MAX AST") + ylab("GLP1 Oral Experience \n")


Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(MAX_AST))

Dems_Labs_TreatExp %>% filter(MAX_ALT<80) %>% ggplot(aes(x = MAX_ALT, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n MAX ALT") + ylab("GLP1 Oral Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(MAX_ALT))



Dems_Labs_TreatExp %>% filter(cumflow<30) %>% ggplot(aes(x = cumflow, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Flows") + ylab("GLP1 Oral Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(cumflow))

Dems_Labs_TreatExp %>% filter(Lines <20) %>% ggplot(aes(x = Lines, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Terapy Lines") + ylab("GLP1 Oral Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(Lines))


Dems_Labs_TreatExp %>% filter(Diff_Drugs_exp<40) %>% ggplot(aes(x = Diff_Drugs_exp, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Different Molecules") + ylab("GLP1 Oral Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(Diff_Drugs_exp))


ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_InjExp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Oral GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Injectable GLP1 Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_InsulinExp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Oral GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Insulin Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_SGLT2Exp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Oral GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "SGLT2 Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_DPP4Exp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Oral GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "DPP4 Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_AntiDiabeticExp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Oral GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Antidiabetics Experience")+
  scale_fill_viridis_d()

ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_BiguanideExp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Oral GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Biguanide Experience")+
  scale_fill_viridis_d()




Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short <- fread("Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short.txt", sep="\t")

Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short$Predictor <- as.factor(Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short$Predictor)

Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short <- Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short %>% arrange(`Odd ratio`)

Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short <- Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short %>% filter(`Sig. ?`!="ns")

Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short %>%
  filter(Predictor=="DPP4 Exp"|Predictor=="Antidiabetic Exp"|Predictor=="Biguanide Exp"|Predictor=="Insulin Exp"|Predictor=="Oral GLP1 Exp"| Predictor=="SGLT2 Exp") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")



Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short %>%
  filter(Predictor=="Nephrology"|Predictor=="Obestretics & Gyne."|Predictor=="Emergency Medicine"|Predictor=="Geriatrics"|Predictor=="Internal Medicine"| Predictor=="Cardiology"|Predictor=="PCP"| Predictor=="Endocrinology") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")



Odd_ratios_ORAL_GLP1_noGLP1_TreatExt_short %>%
  filter(Predictor=="Gender"|Predictor=="Nr Flows"|Predictor=="Age"|Predictor=="Weight"|Predictor=="AST"| Predictor=="ALT"|Predictor=="HbA1c"| Predictor=="BMI"|Predictor=="Nr Diff. Molecules"| Predictor=="Nr Therapy Lines"| Predictor=="Obesity comorb") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")
















# Logistic regression Antidiabetic Exp vs No Exp

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Physicians_Experience <- fread("Physicians_Experience.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Physicians_Experience)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(Dems_Labs_TreatExp)


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_AntiDiabeticExp ==1, "Antidiabetic_Exp", "No_Antidiabetic"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_Antidiabetic")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_AntiDiabeticExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))

Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(26000)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()


# Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(age=scale(age),
#                               MAX_HbA1c =scale(MAX_HbA1c ),
#                               MAX_BMI =scale(MAX_BMI ),
#                               MAX_ALT =scale(MAX_ALT ),
#                               MAX_AST =scale(MAX_AST ),
#                               age=scale(age))




create_train_test <- function(data, size = 0.8, train = TRUE) {
  n_row = nrow(data)
  total_row = size * n_row
  train_sample <- 1: total_row
  if (train == TRUE) {
    return (data[train_sample, ])
  } else {
    return (data[-train_sample, ])
  }
}



Dems_Labs_TreatExp <- Dems_Labs_TreatExp[sample(1:nrow(Dems_Labs_TreatExp)), ]


data_train <- create_train_test(Dems_Labs_TreatExp, 0.8, train = TRUE)
data_test <- create_train_test(Dems_Labs_TreatExp, 0.8, train = FALSE)

Risk_pred_model <- glm( Group ~ ., data = data_train, family = binomial)

summary(Risk_pred_model)

predict <- predict(Risk_pred_model, data_test, type = 'response')

table_mat <- table(data_test$Group, predict > 0.50)
table_mat

plot(table_mat)

accuracy_Test <- sum(diag(table_mat)) / sum(table_mat)
accuracy_Test


precision <- function(matrix) {
  # True positive
  tp <- matrix[2, 2]
  # false positive
  fp <- matrix[1, 2]
  return (tp / (tp + fp))
}



recall <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]# false positive
  fn <- matrix[2, 1]
  return (tp / (tp + fn))
}


prec <- precision(table_mat)
prec # 

rec <- recall(table_mat)
rec # 

f1 <- 2 * ((prec * rec) / (prec + rec))
f1 # 









Odd_ratios_Antidiabetics_TreatExp <- fread("Odd_ratios_Antidiabetics_TreatExp.txt", sep="\t")

Odd_ratios_Antidiabetics_TreatExp$Predictor <- as.factor(Odd_ratios_Antidiabetics_TreatExp$Predictor)

Odd_ratios_Antidiabetics_TreatExp <- Odd_ratios_Antidiabetics_TreatExp %>% arrange(`Odd ratio`)

Odd_ratios_Antidiabetics_TreatExp <- Odd_ratios_Antidiabetics_TreatExp %>% filter(`Sig. ?`!="ns")

Odd_ratios_Antidiabetics_TreatExp %>%
  filter(Predictor=="DPP4 Exp"|Predictor=="Antidiabetic Exp"|Predictor=="Biguanide Exp"|Predictor=="Insulin Exp"|Predictor=="Oral GLP1 Exp"| Predictor=="SGLT2 Exp") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")



Odd_ratios_Antidiabetics_TreatExp %>%
  filter(Predictor=="Nephrology"|Predictor=="Obestretics & Gyne."|Predictor=="Emergency Medicine"|Predictor=="Geriatrics"|Predictor=="Internal Medicine"| Predictor=="Cardiology"|Predictor=="PCP"| Predictor=="Endocrinology") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")



Odd_ratios_Antidiabetics_TreatExp %>%
  filter(Predictor=="Gender"|Predictor=="Nr Flows"|Predictor=="Age"|Predictor=="Weight"|Predictor=="AST"| Predictor=="ALT"|Predictor=="HbA1c"| Predictor=="BMI"|Predictor=="Nr Diff. Molecules"| Predictor=="Nr Therapy Lines"| Predictor=="Obesity comorb") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")













# Logistic regression Biguanide Exp vs No Exp

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Physicians_Experience <- fread("Physicians_Experience.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Physicians_Experience)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(Dems_Labs_TreatExp)


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_AntiDiabeticExp ==1, "Antidiabetic_Exp", "No_Antidiabetic"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_Antidiabetic")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_AntiDiabeticExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))

Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(26000)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()


# Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(age=scale(age),
#                               MAX_HbA1c =scale(MAX_HbA1c ),
#                               MAX_BMI =scale(MAX_BMI ),
#                               MAX_ALT =scale(MAX_ALT ),
#                               MAX_AST =scale(MAX_AST ),
#                               age=scale(age))




create_train_test <- function(data, size = 0.8, train = TRUE) {
  n_row = nrow(data)
  total_row = size * n_row
  train_sample <- 1: total_row
  if (train == TRUE) {
    return (data[train_sample, ])
  } else {
    return (data[-train_sample, ])
  }
}



Dems_Labs_TreatExp <- Dems_Labs_TreatExp[sample(1:nrow(Dems_Labs_TreatExp)), ]


data_train <- create_train_test(Dems_Labs_TreatExp, 0.8, train = TRUE)
data_test <- create_train_test(Dems_Labs_TreatExp, 0.8, train = FALSE)

Risk_pred_model <- glm( Group ~ ., data = data_train, family = binomial)

summary(Risk_pred_model)

predict <- predict(Risk_pred_model, data_test, type = 'response')

table_mat <- table(data_test$Group, predict > 0.50)
table_mat

plot(table_mat)

accuracy_Test <- sum(diag(table_mat)) / sum(table_mat)
accuracy_Test


precision <- function(matrix) {
  # True positive
  tp <- matrix[2, 2]
  # false positive
  fp <- matrix[1, 2]
  return (tp / (tp + fp))
}



recall <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]# false positive
  fn <- matrix[2, 1]
  return (tp / (tp + fn))
}


prec <- precision(table_mat)
prec # 

rec <- recall(table_mat)
rec # 

f1 <- 2 * ((prec * rec) / (prec + rec))
f1 # 









Odd_ratios_Antidiabetics_TreatExp <- fread("Odd_ratios_Antidiabetics_TreatExp.txt", sep="\t")

Odd_ratios_Antidiabetics_TreatExp$Predictor <- as.factor(Odd_ratios_Antidiabetics_TreatExp$Predictor)

Odd_ratios_Antidiabetics_TreatExp <- Odd_ratios_Antidiabetics_TreatExp %>% arrange(`Odd ratio`)

Odd_ratios_Antidiabetics_TreatExp <- Odd_ratios_Antidiabetics_TreatExp %>% filter(`Sig. ?`!="ns")

Odd_ratios_Antidiabetics_TreatExp %>%
  filter(Predictor=="DPP4 Exp"|Predictor=="Injectanle GLP1 Exp"|Predictor=="Biguanide Exp"|Predictor=="Insulin Exp"|Predictor=="Oral GLP1 Exp"| Predictor=="SGLT2 Exp") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")



Odd_ratios_Antidiabetics_TreatExp %>%
  filter(Predictor=="Nephrology"|Predictor=="Obestretics & Gyne."|Predictor=="Emergency Medicine"|Predictor=="Geriatrics"|Predictor=="Internal Medicine"| Predictor=="Cardiology"|Predictor=="PCP"| Predictor=="Endocrinology") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")



Odd_ratios_Antidiabetics_TreatExp %>%
  filter(Predictor=="Gender"|Predictor=="Nr Flows"|Predictor=="Age"|Predictor=="Weight"|Predictor=="AST"| Predictor=="ALT"|Predictor=="HbA1c"| Predictor=="BMI"|Predictor=="Nr Diff. Molecules"| Predictor=="Nr Therapy Lines"| Predictor=="Obesity comorb") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_ridges() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylab("\n Odd ratio (Lower-Upper ends)")


# -------
# Fasting Glucose -----------------------

GLP_Measures_Glucose <- fread("GLP_Measures_Glucose.txt")

GLP_Measures_Glucose %>% group_by(patid) %>% count() %>% ungroup() %>% summarise(n=mean(n))

GLP_Measures_Glucose %>% group_by(patid) %>% count() %>% ungroup() %>%
  arrange(-n) %>%
  filter(n<25) %>%
  ggplot(aes(n)) +
  geom_density(colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Number of Fasting Glucose Reads") +
  ylab("Proportion \n")




unique(GLP_Measures_Glucose$unit) # mg/dL
length(unique(GLP_Measures_Glucose$patid)) #18417

GLP_Measures_Glucose <- GLP_Measures_Glucose %>% select(patid, claimed, value)

mean(GLP_Measures_Glucose$value) # 153.1037
median(GLP_Measures_Glucose$value) # 134

GLP_Measures_Glucose %>% 
  ggplot(aes(value))+
  geom_density(colour="firebrick", fill="firebrick", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(0,500)+
  xlab("\n All Fasting Glucose Reads (mg/dL)") +
  ylab("Proportion \n")


GLP_Measures_Glucose %>% 
  group_by(patid) %>% filter(value==max(value)) %>% slice(1) %>%
  ungroup() %>% summarise(n=mean(value)) # 177

GLP_Measures_Glucose %>% 
  group_by(patid) %>% filter(value==max(value)) %>% slice(1) %>%
  ungroup() %>% summarise(n=median(value)) # 154

GLP_Measures_Glucose %>% 
  group_by(patid) %>% filter(value==max(value)) %>% slice(1) %>%
  ggplot(aes(value))+
  geom_density(colour="firebrick", fill="firebrick", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(0,500)+
  xlab("\n Max Fasting Glucose Read (mg/dL)") +
  ylab("Proportion \n")




GLP_Measures_Glucose %>% 
  group_by(patid) %>% filter(value==min(value)) %>% slice(1) %>%
  ungroup() %>% summarise(n=mean(value)) # 135

GLP_Measures_Glucose %>% 
  group_by(patid) %>% filter(value==min(value)) %>% slice(1) %>%
  ungroup() %>% summarise(n=median(value)) # 120

GLP_Measures_Glucose %>% 
  group_by(patid) %>% filter(value==min(value)) %>% slice(1) %>%
  ggplot(aes(value))+
  geom_density(colour="firebrick", fill="firebrick", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(0,500)+
  xlab("\n Min Fasting Glucose Read (mg/dL)") +
  ylab("Proportion \n")




GLP_Measures_Glucose %>% group_by(patid) %>% summarise(n=range(value)) %>%
  mutate(range=n-lag(n)) %>% drop_na() %>% ungroup() %>% summarise(n=mean(range)) # 41.7


GLP_Measures_Glucose %>% group_by(patid) %>% summarise(n=range(value)) %>%
  mutate(range=n-lag(n)) %>% drop_na() %>% ungroup() %>% summarise(n=median(range)) # 0


GLP_Measures_Glucose %>% group_by(patid) %>% summarise(n=range(value)) %>%
  mutate(range=n-lag(n)) %>% drop_na() %>% ungroup() %>% summarise(n=max(range)) # 1378


GLP_Measures_Glucose %>% group_by(patid) %>% summarise(n=range(value)) %>%
  mutate(range=n-lag(n)) %>% drop_na() %>% ungroup() %>% summarise(n=min(range)) # 0


GLP_Measures_Glucose %>% group_by(patid) %>% summarise(n=range(value)) %>%
  mutate(range=n-lag(n)) %>% drop_na() %>% ungroup() %>%
  select(patid, range) %>% 
  ggplot(aes(range)) +
  geom_density(colour="midnightblue", fill="midnightblue", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(0,200)+
  xlab("\n Fasting Glucose Read Range Distribution (Max-Min read, mg/dL)") +
  ylab("Proportion \n")



GLP_Measures_Glucose$Month_Yr <- format(as.Date(GLP_Measures_Glucose$claimed), "%Y-%m")



GLP_Measures_Glucose %>% group_by(patid, Month_Yr) %>% summarise(n=range(value)) %>%
  mutate(range=n-lag(n)) %>% drop_na() %>% ungroup() %>% summarise(n=mean(range)) # 5.01


GLP_Measures_Glucose %>% group_by(patid, Month_Yr) %>% summarise(n=range(value)) %>%
  mutate(range=n-lag(n)) %>% drop_na() %>% ungroup() %>% summarise(n=median(range)) # 0


GLP_Measures_Glucose %>% group_by(patid, Month_Yr) %>% summarise(n=range(value)) %>%
  mutate(range=n-lag(n)) %>% drop_na() %>% ungroup() %>% summarise(n=max(range)) # 1378


GLP_Measures_Glucose %>% group_by(patid, Month_Yr) %>% summarise(n=range(value)) %>%
  mutate(range=n-lag(n)) %>% drop_na() %>% ungroup() %>% summarise(n=min(range)) # 0


GLP_Measures_Glucose %>% group_by(patid, Month_Yr) %>% summarise(n=range(value)) %>%
  mutate(range=n-lag(n)) %>% drop_na() %>% ungroup() %>%
  select(patid, range) %>% 
  ggplot(aes(range)) +
  geom_density(colour="midnightblue", fill="midnightblue", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlim(0,10)+
  xlab("\n Fasting Glucose Read Monthly Range Distribution (Max-Min read, mg/dL)") +
  ylab("Proportion \n")



# ---------

# Median Fasting Glucose Before vs After GLP1 Injectable Start ------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")


# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[2] <- "Month_First_GLP1"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP_Measures_Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patid, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first GLP1 Injectable month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient")) %>% drop_na()

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
Glucose_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1))
Glucose_before_GLP1 <- Glucose_before_GLP1 %>% group_by(patient, Month_First_GLP1) %>% summarize(value=median(value))
names(Glucose_before_GLP1)[2] <- "Month_First"
names(Glucose_before_GLP1)[3] <- "Glucose_Prior"

Glucose_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1))
Glucose_after_GLP1 <- Glucose_after_GLP1 %>% group_by(patient, Month_First_GLP1) %>% summarize(value=median(value))
names(Glucose_after_GLP1)[2] <- "Month_First"
names(Glucose_after_GLP1)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_GLP1_BEFORE_vs_AFTER <- Glucose_before_GLP1 %>% full_join(Glucose_after_GLP1)
Glucose_GLP1_BEFORE_vs_AFTER <- Glucose_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior) #163.7296
mean(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After) #147.042

median(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior) # 147.5
median(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After) # 134



wilcox.test(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior, Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")


Glucose_GLP1_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_GLP1_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to Injectable GLP1 Initiation")+
  ylab("Fasting glucose (mg/dL) \n")


write.csv(Glucose_GLP1_BEFORE_vs_AFTER, "Glucose_GLP1_BEFORE_vs_AFTER.csv")










# -----------

# GLP1 only vs combo SGLT2 ---------

# Median Fasting Glucose Before vs After GLP1 Injectable Start ------------
DANU_Ingredients       <- fread("DANU Ingredients New Lookup.csv", integer64 = "character", stringsAsFactors = F)

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")




# All pats
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)


# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- DIA_Drug_Histories %>%  anti_join(Pats_to_remove)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj| AND SGLT2
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_GLP1Inj_only <- DIA_Drug_Histories %>%  anti_join(Pats_to_remove) 



# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_GLP1Inj_only)


#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[2] <- "Month_First_GLP1"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP_Measures_Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patid, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first GLP1 Injectable month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient")) %>% drop_na()

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
Glucose_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1))
Glucose_before_GLP1 <- Glucose_before_GLP1 %>% group_by(patient, Month_First_GLP1) %>% summarize(value=median(value))
names(Glucose_before_GLP1)[2] <- "Month_First"
names(Glucose_before_GLP1)[3] <- "Glucose_Prior"

Glucose_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1))
Glucose_after_GLP1 <- Glucose_after_GLP1 %>% group_by(patient, Month_First_GLP1) %>% summarize(value=median(value))
names(Glucose_after_GLP1)[2] <- "Month_First"
names(Glucose_after_GLP1)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_GLP1_BEFORE_vs_AFTER <- Glucose_before_GLP1 %>% full_join(Glucose_after_GLP1)
Glucose_GLP1_BEFORE_vs_AFTER <- Glucose_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior) #130.7742
mean(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After) #117.5867

median(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior) # 120
median(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After) # 110

wilcox.test(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior, Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")




Glucose_GLP1_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_GLP1_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=3, alpha=0.5, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to Injectable GLP1 Initiation")+
  ylab("Median Fasting glucose (mg/dL) \n")


write.csv(Glucose_GLP1_BEFORE_vs_AFTER, "Glucose_GLP1_BEFORE_vs_AFTER_Big_GLP1_only.csv")






# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)


# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(2:61)

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("All_GLP1_Ever_Pats_HbA1c_BMI_drghist.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


Pats_Biguanide_SGLT2_GLP1Inj_only <- Pats_Biguanide_SGLT2_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[2] <- "Month_First_Combo"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP_Measures_Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patid, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the combo criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures <- Patient_first_Combo %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first Combo month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient")) %>% drop_na()

# now split into months before Combostart and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
Glucose_before_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo))
Glucose_before_Combo <- Glucose_before_Combo %>% group_by(patient, Month_First_Combo) %>% summarize(value=median(value))
names(Glucose_before_Combo)[2] <- "Month_First"
names(Glucose_before_Combo)[3] <- "Glucose_Prior"

Glucose_after_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo))
Glucose_after_Combo <- Glucose_after_Combo %>% group_by(patient, Month_First_Combo) %>% summarize(value=median(value))
names(Glucose_after_Combo)[2] <- "Month_First"
names(Glucose_after_Combo)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_Combo_BEFORE_vs_AFTER <- Glucose_before_Combo %>% full_join(Glucose_after_Combo)
Glucose_Combo_BEFORE_vs_AFTER <- Glucose_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_Combo_BEFORE_vs_AFTER$Glucose_Prior) #155.5176
mean(Glucose_Combo_BEFORE_vs_AFTER$Glucose_After) #131.2042

median(Glucose_Combo_BEFORE_vs_AFTER$Glucose_Prior) # 135.5
median( Glucose_Combo_BEFORE_vs_AFTER$Glucose_After) # 124


wilcox.test(Glucose_Combo_BEFORE_vs_AFTER$Glucose_Prior, Glucose_Combo_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")



Glucose_Combo_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_Combo_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=3, alpha=0.5, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to SGLT + GLP1 Combo Initiation")+
  ylab("Fasting glucose (mg/dL) \n")


write.csv(Glucose_Combo_BEFORE_vs_AFTER, "Glucose_Combo_BEFORE_vs_AFTER_Big_GLP1_SGLT2_only.csv")












# -----
# -----



# -----





# Diagnosis among Treated vs non-Treated Diabetes -----------

DIA_Treated_Patients <- fread("DIA Treated Patients.txt")

sum(DIA_Treated_Patients$treated_patient_sample) # 220769
sum(DIA_Treated_Patients$treated_patient_population)  # 30625690
sum(DIA_Treated_Patients$untreated_patient_population)  # 17618734

DIA_Treated_Diagnosis <- fread("DIA Treated Diagnosis.txt")


# As a general trend, complications tend to be more often observed for the treated pats
# But so do the general diabetes Dx codes, so we should be carefull interpreting these
# If in general a patients is just seen more often then of course he will have more codes.
# Still, complications-assocatied codes are disproportionally higher



Dx_Treat_VS_Untred_Penetrance <- DIA_Treated_Diagnosis %>% select(code, description, treated_patient_population, untreated_patient_population) %>%
  group_by(code) %>%
  mutate(total_treat_pop=sum(treated_patient_population)) %>%
  mutate(total_untreat_pop=sum(untreated_patient_population)) %>%
  mutate(penetance_treat_pop=(total_treat_pop/30625690)*100) %>%
  mutate(penetance_untreat_pop=(total_untreat_pop/17618734)*100) %>%
  select(code, description, penetance_treat_pop, penetance_untreat_pop) %>% distinct() %>%
  mutate(difference=penetance_treat_pop-penetance_untreat_pop) %>%
  arrange(-difference) %>%
  mutate(fold_change=penetance_treat_pop/penetance_untreat_pop) %>%
  filter(penetance_treat_pop!=0 & penetance_untreat_pop!=0)

Dx_Treat_VS_Untred_Penetrance <- Dx_Treat_VS_Untred_Penetrance %>% filter(penetance_treat_pop>=4)

# Dx_Treat_VS_Untred_Penetrance <- Dx_Treat_VS_Untred_Penetrance[nchar(Dx_Treat_VS_Untred_Penetrance$code) == 6,]


# Visits per patient are trickier as there are conditions that lead to way too many visits
# Whilst having nothing to deal with Diabetes

Dx_Treat_VS_Untred_visit_per_pat <- DIA_Treated_Diagnosis %>% select(description, treated_patient_population, untreated_patient_population, treated_visit_population, untreated_visit_population) %>%
  group_by(description) %>%
  mutate(total_treat_pop=sum(treated_patient_population)) %>%
  mutate(total_untreat_pop=sum(untreated_patient_population)) %>%
  mutate(total_treat_visit=sum(treated_visit_population)) %>%
  mutate(total_untreat_visit=sum(untreated_visit_population)) %>%
  select(description, total_treat_pop, total_untreat_pop, total_treat_visit, total_untreat_visit) %>% distinct() %>%
  mutate(treat_vist_per_pat=total_treat_visit/total_treat_pop) %>%
  mutate(untreat_vist_per_pat=total_untreat_visit/total_untreat_pop) %>%
  select(description,treat_vist_per_pat,untreat_vist_per_pat) %>%
  mutate(difference=treat_vist_per_pat-untreat_vist_per_pat) %>%
  filter(treat_vist_per_pat!=0 & untreat_vist_per_pat!=0)





# Diagnosis among Treated vs non-Treated Obesity -----------

OBE_Treated_Patients <- fread("OBE Treated Patients.txt")

sum(OBE_Treated_Patients$treated_patient_sample) # 60282
sum(OBE_Treated_Patients$treated_patient_population)  # 9155116
sum(OBE_Treated_Patients$untreated_patient_population)  # 97313933

OBE_Treated_Diagnosis <- fread("OBE Treated Diagnosis.txt")



# It seems that treated patients are more liekly to suffer from mood/phschiatric disorders (?)

Dx_Treat_VS_Untred_Penetrance <- OBE_Treated_Diagnosis %>% select(code, description, treated_patient_population, untreated_patient_population) %>%
  group_by(code) %>%
  mutate(total_treat_pop=sum(treated_patient_population)) %>%
  mutate(total_untreat_pop=sum(untreated_patient_population)) %>%
  mutate(penetance_treat_pop=(total_treat_pop/9155116)*100) %>%
  mutate(penetance_untreat_pop=(total_untreat_pop/97313933)*100) %>%
  select(code, description, penetance_treat_pop, penetance_untreat_pop) %>% distinct() %>%
  mutate(difference=penetance_treat_pop-penetance_untreat_pop) %>%
  arrange(-difference) %>%
  mutate(fold_change=penetance_treat_pop/penetance_untreat_pop) %>%
  filter(penetance_treat_pop!=0 & penetance_untreat_pop!=0)

Dx_Treat_VS_Untred_Penetrance <- Dx_Treat_VS_Untred_Penetrance %>% filter(grepl("D=", code)) %>% filter(grepl("$", code))

Dx_Treat_VS_Untred_Penetrance[c('First', 'Last')] <- str_split_fixed(Dx_Treat_VS_Untred_Penetrance$code, '=', 2)

Dx_Treat_VS_Untred_Penetrance <- Dx_Treat_VS_Untred_Penetrance[nchar(as.character(Dx_Treat_VS_Untred_Penetrance$Last))==4,]

Dx_Treat_VS_Untred_Penetrance <- Dx_Treat_VS_Untred_Penetrance %>% filter(grepl("[a-zA-Z]", Last))
Dx_Treat_VS_Untred_Penetrance <- Dx_Treat_VS_Untred_Penetrance %>% filter(grepl("$", Last))

Dx_Treat_VS_Untred_Penetrance <- Dx_Treat_VS_Untred_Penetrance %>% filter(penetance_treat_pop>1) 
Dx_Treat_VS_Untred_Penetrance <- Dx_Treat_VS_Untred_Penetrance %>% arrange(Last)
Dx_Treat_VS_Untred_Penetrance <- Dx_Treat_VS_Untred_Penetrance[1:181,]

fwrite(Dx_Treat_VS_Untred_Penetrance, "Circular_Bar_Chart_Dx_Pen_TreatVSNonTreat_Obesity.txt", sep="\t")

Dx_Treat_VS_Untred_Penetrance <- Dx_Treat_VS_Untred_Penetrance %>% filter(penetance_treat_pop>=4)





# Again, many things unrelated to diabetes (or are they?)
# Transpalnts, fractures, etc.
# It could also be that treated patients are simply patients that go to the doctor more often

Dx_Treat_VS_Untred_visit_per_pat <- OBE_Treated_Diagnosis %>% select(description, treated_patient_population, untreated_patient_population, treated_visit_population, untreated_visit_population) %>%
  group_by(description) %>%
  mutate(total_treat_pop=sum(treated_patient_population)) %>%
  mutate(total_untreat_pop=sum(untreated_patient_population)) %>%
  mutate(total_treat_visit=sum(treated_visit_population)) %>%
  mutate(total_untreat_visit=sum(untreated_visit_population)) %>%
  select(description, total_treat_pop, total_untreat_pop, total_treat_visit, total_untreat_visit) %>% distinct() %>%
  mutate(treat_vist_per_pat=total_treat_visit/total_treat_pop) %>%
  mutate(untreat_vist_per_pat=total_untreat_visit/total_untreat_pop) %>%
  select(description,treat_vist_per_pat,untreat_vist_per_pat) %>%
  mutate(difference=treat_vist_per_pat-untreat_vist_per_pat) %>%
  filter(treat_vist_per_pat!=0 & untreat_vist_per_pat!=0)


# --------




# Drugs among Treated vs non-Treated Diabetes -----------

DIA_Treated_Patients <- fread("DIA Treated Patients.txt")

sum(DIA_Treated_Patients$treated_patient_sample) # 220769
sum(DIA_Treated_Patients$untreated_patient_sample) # 123520

sum(DIA_Treated_Patients$treated_patient_population)  # 30625690
sum(DIA_Treated_Patients$untreated_patient_population)  # 17618734

DIA_Treated_Drug <- fread("DIA Treated Drug.txt")


# Treated patients use more cardiovascular drugs (diuretics, beta-blockers, anti-dislipidemics, etc)
# On top of the antidiabetic drugs

Drug_Treat_VS_Untred_Penetrance <- DIA_Treated_Drug %>% select(drug, treated_patient_population, untreated_patient_population) %>%
  group_by(drug) %>%
  mutate(total_treat_pop=sum(treated_patient_population)) %>%
  mutate(total_untreat_pop=sum(untreated_patient_population)) %>%
  mutate(penetance_treat_pop=(total_treat_pop/30625690)*100) %>%
  mutate(penetance_untreat_pop=(total_untreat_pop/17618734)*100) %>%
  select(drug, total_treat_pop, total_untreat_pop, penetance_treat_pop, penetance_untreat_pop) %>% distinct() %>%
  mutate(difference=penetance_treat_pop-penetance_untreat_pop) %>%
  arrange(-difference) %>%
  mutate(fold_change=penetance_treat_pop/penetance_untreat_pop) %>%
  filter(penetance_treat_pop!=0 & penetance_untreat_pop!=0)


# No discernable trend, but we can spend more time on it

Drug_Treat_VS_Untred_visit_per_pat <- DIA_Treated_Drug %>% select(drug, treated_patient_population, untreated_patient_population, treated_visit_population, untreated_visit_population) %>%
  group_by(drug) %>%
  mutate(total_treat_pop=sum(treated_patient_population)) %>%
  mutate(total_untreat_pop=sum(untreated_patient_population)) %>%
  mutate(total_treat_visit=sum(treated_visit_population)) %>%
  mutate(total_untreat_visit=sum(untreated_visit_population)) %>%
  select(drug, total_treat_pop, total_untreat_pop, total_treat_visit, total_untreat_visit) %>% distinct() %>%
  mutate(treat_vist_per_pat=total_treat_visit/total_treat_pop) %>%
  mutate(untreat_vist_per_pat=total_untreat_visit/total_untreat_pop) %>%
  select(drug,treat_vist_per_pat,untreat_vist_per_pat) %>%
  mutate(difference=treat_vist_per_pat-untreat_vist_per_pat) %>%
  filter(treat_vist_per_pat!=0 & untreat_vist_per_pat!=0)



# Drugs among Treated vs non-Treated Obesity -----------

OBE_Treated_Patients <- fread("OBE Treated Patients.txt")

sum(OBE_Treated_Patients$treated_patient_sample) # 60282
sum(OBE_Treated_Patients$untreated_patient_sample) # 663496

sum(OBE_Treated_Patients$treated_patient_population)  # 9155116
sum(OBE_Treated_Patients$untreated_patient_population)  # 97313933

OBE_Treated_Drug <- fread("OBE Treated Drug.txt")


# On top of the antiobesity/amphetamines, obesity treated patients use more CNS acting drugs 
# antidepressants, anxiolytics, mood stabrs .....

Drug_Treat_VS_Untred_Penetrance <- OBE_Treated_Drug %>% select(drug, treated_patient_population, untreated_patient_population) %>%
  group_by(drug) %>%
  mutate(total_treat_pop=sum(treated_patient_population)) %>%
  mutate(total_untreat_pop=sum(untreated_patient_population)) %>%
  mutate(penetance_treat_pop=(total_treat_pop/9155116)*100) %>%
  mutate(penetance_untreat_pop=(total_untreat_pop/97313933)*100) %>%
  select(drug, penetance_treat_pop, penetance_untreat_pop) %>% distinct() %>%
  mutate(difference=penetance_treat_pop-penetance_untreat_pop) %>%
  arrange(-difference) %>%
  mutate(fold_change=penetance_treat_pop/penetance_untreat_pop) %>%
  filter(penetance_treat_pop!=0 & penetance_untreat_pop!=0)


Drug_Treat_VS_Untred_visit_per_pat <- OBE_Treated_Drug %>% select(drug, treated_patient_population, untreated_patient_population, treated_visit_population, untreated_visit_population) %>%
  group_by(drug) %>%
  mutate(total_treat_pop=sum(treated_patient_population)) %>%
  mutate(total_untreat_pop=sum(untreated_patient_population)) %>%
  mutate(total_treat_visit=sum(treated_visit_population)) %>%
  mutate(total_untreat_visit=sum(untreated_visit_population)) %>%
  select(drug, total_treat_pop, total_untreat_pop, total_treat_visit, total_untreat_visit) %>% distinct() %>%
  mutate(treat_vist_per_pat=total_treat_visit/total_treat_pop) %>%
  mutate(untreat_vist_per_pat=total_untreat_visit/total_untreat_pop) %>%
  select(drug,treat_vist_per_pat,untreat_vist_per_pat) %>%
  mutate(difference=treat_vist_per_pat-untreat_vist_per_pat) %>%
  filter(treat_vist_per_pat!=0 & untreat_vist_per_pat!=0)



# ------
# Procedures among Treated vs non-Treated Diabetes -----------

DIA_Treated_Patients <- fread("DIA Treated Patients.txt")

sum(DIA_Treated_Patients$treated_patient_sample) # 220769
sum(DIA_Treated_Patients$untreated_patient_sample) # 123520

sum(DIA_Treated_Patients$treated_patient_population)  # 30625690
sum(DIA_Treated_Patients$untreated_patient_population)  # 17618734

DIA_Treated_Procedure <- fread("DIA Treated Procedure.txt")


Procedure_Treat_VS_Untred_Penetrance <- DIA_Treated_Procedure %>% select(description, treated_patient_population, untreated_patient_population) %>%
  group_by(description) %>%
  mutate(total_treat_pop=sum(treated_patient_population)) %>%
  mutate(total_untreat_pop=sum(untreated_patient_population)) %>%
  mutate(penetance_treat_pop=(total_treat_pop/30625690)*100) %>%
  mutate(penetance_untreat_pop=(total_untreat_pop/17618734)*100) %>%
  select(description, total_treat_pop, total_untreat_pop, penetance_treat_pop, penetance_untreat_pop) %>% distinct() %>%
  mutate(difference=penetance_treat_pop-penetance_untreat_pop) %>%
  arrange(-difference) %>%
  mutate(fold_change=penetance_treat_pop/penetance_untreat_pop) %>%
  filter(penetance_treat_pop!=0 & penetance_untreat_pop!=0)



# Procedures among Treated vs non-Treated Obesity -----------

OBE_Treated_Patients <- fread("OBE Treated Patients.txt")

sum(OBE_Treated_Patients$treated_patient_sample) # 60282
sum(OBE_Treated_Patients$untreated_patient_sample) # 663496

sum(OBE_Treated_Patients$treated_patient_population)  # 9155116
sum(OBE_Treated_Patients$untreated_patient_population)  # 97313933

OBE_Treated_Procedure <- fread("OBE Treated Procedure.txt")


Procedure_Treat_VS_Untred_Penetrance <- OBE_Treated_Procedure %>% select(description, treated_patient_population, untreated_patient_population) %>%
  group_by(description) %>%
  mutate(total_treat_pop=sum(treated_patient_population)) %>%
  mutate(total_untreat_pop=sum(untreated_patient_population)) %>%
  mutate(penetance_treat_pop=(total_treat_pop/9155116)*100) %>%
  mutate(penetance_untreat_pop=(total_untreat_pop/97313933)*100) %>%
  select(description, penetance_treat_pop, penetance_untreat_pop) %>% distinct() %>%
  mutate(difference=penetance_treat_pop-penetance_untreat_pop) %>%
  arrange(-difference) %>%
  mutate(fold_change=penetance_treat_pop/penetance_untreat_pop) %>%
  filter(penetance_treat_pop!=0 & penetance_untreat_pop!=0)


# -----
# Fasting Glucose before vs after for all patients -----
# ----
# All pats - Median Fasting Glucose Before vs After SGLT2 ------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)

DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients <- DANU_Ingredients %>% select(molecule, drug_group)

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")




# SGLT2 ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2 too zero, and SGLT2to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[2] <- "Month_First_SGLT2"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2 <-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures <- Patient_first_SGLT2 %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first SGLT2 month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeSGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2))
Glucose_before_SGLT2 <- Glucose_before_SGLT2 %>% group_by(patient, Month_First_SGLT2) %>% summarize(value=median(value))
names(Glucose_before_SGLT2)[2] <- "Month_First"
names(Glucose_before_SGLT2)[3] <- "Glucose_Prior"

Glucose_after_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2))
Glucose_after_SGLT2 <- Glucose_after_SGLT2 %>% group_by(patient, Month_First_SGLT2) %>% summarize(value=median(value))
names(Glucose_after_SGLT2)[2] <- "Month_First"
names(Glucose_after_SGLT2)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_SGLT2_BEFORE_vs_AFTER <- Glucose_before_SGLT2 %>% full_join(Glucose_after_SGLT2)
Glucose_SGLT2_BEFORE_vs_AFTER <- Glucose_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_SGLT2_BEFORE_vs_AFTER$Glucose_Prior) #168.5995
mean(Glucose_SGLT2_BEFORE_vs_AFTER$Glucose_After) #148.4509

median(Glucose_SGLT2_BEFORE_vs_AFTER$Glucose_Prior) # 155
median(Glucose_SGLT2_BEFORE_vs_AFTER$Glucose_After) # 140


wilcox.test(Glucose_SGLT2_BEFORE_vs_AFTER$Glucose_Prior, Glucose_SGLT2_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 534
Glucose_SGLT2_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_SGLT2_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to SGLT2 Initiation")+
  ylab("Fasting glucose (mg/dL) \n")


write.csv(Glucose_SGLT2_BEFORE_vs_AFTER, "Glucose_SGLT2_BEFORE_vs_AFTER.csv")











# Insulin ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no Insulin too zero, and Insulinto one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_Insulin,.), ~replace(., grepl(string_Insulin, .), "Insulin")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Insulin",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Insulin
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Insulin
DIA_Drug_Histories_FIRST_Insulin <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Insulin)[2] <- "Month_First_Insulin"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the Insulin criteria
Patient_first_Insulin <-  DIA_Drug_Histories_FIRST_Insulin %>% select(patient)
DANU_Measures <- Patient_first_Insulin %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first Insulin month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Insulin, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeInsulin start and months after Insulin start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_Insulin <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Insulin))
Glucose_before_Insulin <- Glucose_before_Insulin %>% group_by(patient, Month_First_Insulin) %>% summarize(value=median(value))
names(Glucose_before_Insulin)[2] <- "Month_First"
names(Glucose_before_Insulin)[3] <- "Glucose_Prior"

Glucose_after_Insulin <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Insulin))
Glucose_after_Insulin <- Glucose_after_Insulin %>% group_by(patient, Month_First_Insulin) %>% summarize(value=median(value))
names(Glucose_after_Insulin)[2] <- "Month_First"
names(Glucose_after_Insulin)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_Insulin_BEFORE_vs_AFTER <- Glucose_before_Insulin %>% full_join(Glucose_after_Insulin)
Glucose_Insulin_BEFORE_vs_AFTER <- Glucose_Insulin_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_Insulin_BEFORE_vs_AFTER$Glucose_Prior) #154.5227
mean(Glucose_Insulin_BEFORE_vs_AFTER$Glucose_After) #138.252

median(Glucose_Insulin_BEFORE_vs_AFTER$Glucose_Prior) # 136
median(Glucose_Insulin_BEFORE_vs_AFTER$Glucose_After) # 128


wilcox.test(Glucose_Insulin_BEFORE_vs_AFTER$Glucose_Prior, Glucose_Insulin_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 749
Glucose_Insulin_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_Insulin_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to Insulin Initiation")+
  ylab("Fasting glucose (mg/dL) \n")


# GLP1 ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 too zero, and GLP1to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[2] <- "Month_First_GLP1"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the GLP1 criteria
Patient_first_GLP1 <-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first GLP1 month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeGLP1 start and months after GLP1 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1))
Glucose_before_GLP1 <- Glucose_before_GLP1 %>% group_by(patient, Month_First_GLP1) %>% summarize(value=median(value))
names(Glucose_before_GLP1)[2] <- "Month_First"
names(Glucose_before_GLP1)[3] <- "Glucose_Prior"

Glucose_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1))
Glucose_after_GLP1 <- Glucose_after_GLP1 %>% group_by(patient, Month_First_GLP1) %>% summarize(value=median(value))
names(Glucose_after_GLP1)[2] <- "Month_First"
names(Glucose_after_GLP1)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_GLP1_BEFORE_vs_AFTER <- Glucose_before_GLP1 %>% full_join(Glucose_after_GLP1)
Glucose_GLP1_BEFORE_vs_AFTER <- Glucose_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior) #165.403
mean(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After) #145.7293

median(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior) # 149
median(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After) # 132


wilcox.test(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior, Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 652
Glucose_GLP1_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_GLP1_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to GLP1 Initiation")+
  ylab("Fasting glucose (mg/dL) \n")

# Biguanide ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no Biguanide too zero, and Biguanideto one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_Biguanide,.), ~replace(., grepl(string_Biguanide, .), "Biguanide")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Biguanide",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Biguanide
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Biguanide
DIA_Drug_Histories_FIRST_Biguanide <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Biguanide)[2] <- "Month_First_Biguanide"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the Biguanide criteria
Patient_first_Biguanide <-  DIA_Drug_Histories_FIRST_Biguanide %>% select(patient)
DANU_Measures <- Patient_first_Biguanide %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first Biguanide month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Biguanide, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeBiguanide start and months after Biguanide start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_Biguanide <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Biguanide))
Glucose_before_Biguanide <- Glucose_before_Biguanide %>% group_by(patient, Month_First_Biguanide) %>% summarize(value=median(value))
names(Glucose_before_Biguanide)[2] <- "Month_First"
names(Glucose_before_Biguanide)[3] <- "Glucose_Prior"

Glucose_after_Biguanide <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Biguanide))
Glucose_after_Biguanide <- Glucose_after_Biguanide %>% group_by(patient, Month_First_Biguanide) %>% summarize(value=median(value))
names(Glucose_after_Biguanide)[2] <- "Month_First"
names(Glucose_after_Biguanide)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_Biguanide_BEFORE_vs_AFTER <- Glucose_before_Biguanide %>% full_join(Glucose_after_Biguanide)
Glucose_Biguanide_BEFORE_vs_AFTER <- Glucose_Biguanide_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_Biguanide_BEFORE_vs_AFTER$Glucose_Prior) #140.5683
mean(Glucose_Biguanide_BEFORE_vs_AFTER$Glucose_After) #130.2967

median(Glucose_Biguanide_BEFORE_vs_AFTER$Glucose_Prior) # 123
median(Glucose_Biguanide_BEFORE_vs_AFTER$Glucose_After) # 120.5


wilcox.test(Glucose_Biguanide_BEFORE_vs_AFTER$Glucose_Prior, Glucose_Biguanide_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 1288
Glucose_Biguanide_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_Biguanide_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to Biguanide Initiation")+
  ylab("Fasting glucose (mg/dL) \n")

# DPP4 ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no DPP4 too zero, and DPP4to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_DPP4,.), ~replace(., grepl(string_DPP4, .), "DPP4")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="DPP4",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to DPP4
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took DPP4
DIA_Drug_Histories_FIRST_DPP4 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_DPP4)[2] <- "Month_First_DPP4"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the DPP4 criteria
Patient_first_DPP4 <-  DIA_Drug_Histories_FIRST_DPP4 %>% select(patient)
DANU_Measures <- Patient_first_DPP4 %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first DPP4 month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_DPP4, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeDPP4 start and months after DPP4 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_DPP4 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_DPP4))
Glucose_before_DPP4 <- Glucose_before_DPP4 %>% group_by(patient, Month_First_DPP4) %>% summarize(value=median(value))
names(Glucose_before_DPP4)[2] <- "Month_First"
names(Glucose_before_DPP4)[3] <- "Glucose_Prior"

Glucose_after_DPP4 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_DPP4))
Glucose_after_DPP4 <- Glucose_after_DPP4 %>% group_by(patient, Month_First_DPP4) %>% summarize(value=median(value))
names(Glucose_after_DPP4)[2] <- "Month_First"
names(Glucose_after_DPP4)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_DPP4_BEFORE_vs_AFTER <- Glucose_before_DPP4 %>% full_join(Glucose_after_DPP4)
Glucose_DPP4_BEFORE_vs_AFTER <- Glucose_DPP4_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_DPP4_BEFORE_vs_AFTER$Glucose_Prior) #162.0805
mean(Glucose_DPP4_BEFORE_vs_AFTER$Glucose_After) #151.0074

median(Glucose_DPP4_BEFORE_vs_AFTER$Glucose_Prior) # 148.5
median(Glucose_DPP4_BEFORE_vs_AFTER$Glucose_After) # 140


wilcox.test(Glucose_DPP4_BEFORE_vs_AFTER$Glucose_Prior, Glucose_DPP4_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 407
Glucose_DPP4_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_DPP4_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to DPP4 Initiation")+
  ylab("Fasting glucose (mg/dL) \n")

# Antidiabetic ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no Antidiabetic too zero, and Antidiabeticto one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_Antidiabetic,.), ~replace(., grepl(string_Antidiabetic, .), "Antidiabetic")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Antidiabetic",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Antidiabetic
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Antidiabetic
DIA_Drug_Histories_FIRST_Antidiabetic <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Antidiabetic)[2] <- "Month_First_Antidiabetic"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the Antidiabetic criteria
Patient_first_Antidiabetic <-  DIA_Drug_Histories_FIRST_Antidiabetic %>% select(patient)
DANU_Measures <- Patient_first_Antidiabetic %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first Antidiabetic month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Antidiabetic, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeAntidiabetic start and months after Antidiabetic start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_Antidiabetic <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Antidiabetic))
Glucose_before_Antidiabetic <- Glucose_before_Antidiabetic %>% group_by(patient, Month_First_Antidiabetic) %>% summarize(value=median(value))
names(Glucose_before_Antidiabetic)[2] <- "Month_First"
names(Glucose_before_Antidiabetic)[3] <- "Glucose_Prior"

Glucose_after_Antidiabetic <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Antidiabetic))
Glucose_after_Antidiabetic <- Glucose_after_Antidiabetic %>% group_by(patient, Month_First_Antidiabetic) %>% summarize(value=median(value))
names(Glucose_after_Antidiabetic)[2] <- "Month_First"
names(Glucose_after_Antidiabetic)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_Antidiabetic_BEFORE_vs_AFTER <- Glucose_before_Antidiabetic %>% full_join(Glucose_after_Antidiabetic)
Glucose_Antidiabetic_BEFORE_vs_AFTER <- Glucose_Antidiabetic_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_Antidiabetic_BEFORE_vs_AFTER$Glucose_Prior) #154.6701
mean(Glucose_Antidiabetic_BEFORE_vs_AFTER$Glucose_After) #139.9731

median(Glucose_Antidiabetic_BEFORE_vs_AFTER$Glucose_Prior) # 140
median(Glucose_Antidiabetic_BEFORE_vs_AFTER$Glucose_After) # 132


wilcox.test(Glucose_Antidiabetic_BEFORE_vs_AFTER$Glucose_Prior, Glucose_Antidiabetic_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 677
Glucose_Antidiabetic_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_Antidiabetic_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to Antidiabetic Initiation")+
  ylab("Fasting glucose (mg/dL) \n")

# ------
# All pats - Mean Fasting Glucose Before vs After  ------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)

DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients <- DANU_Ingredients %>% select(molecule, drug_group)

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")




# SGLT2 ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2 too zero, and SGLT2to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[2] <- "Month_First_SGLT2"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2 <-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures <- Patient_first_SGLT2 %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first SGLT2 month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeSGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2))
Glucose_before_SGLT2 <- Glucose_before_SGLT2 %>% group_by(patient, Month_First_SGLT2) %>% summarize(value=mean(value))
names(Glucose_before_SGLT2)[2] <- "Month_First"
names(Glucose_before_SGLT2)[3] <- "Glucose_Prior"

Glucose_after_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2))
Glucose_after_SGLT2 <- Glucose_after_SGLT2 %>% group_by(patient, Month_First_SGLT2) %>% summarize(value=mean(value))
names(Glucose_after_SGLT2)[2] <- "Month_First"
names(Glucose_after_SGLT2)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_SGLT2_BEFORE_vs_AFTER <- Glucose_before_SGLT2 %>% full_join(Glucose_after_SGLT2)
Glucose_SGLT2_BEFORE_vs_AFTER <- Glucose_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_SGLT2_BEFORE_vs_AFTER$Glucose_Prior) #169.9741
mean(Glucose_SGLT2_BEFORE_vs_AFTER$Glucose_After) #149.4779



wilcox.test(Glucose_SGLT2_BEFORE_vs_AFTER$Glucose_Prior, Glucose_SGLT2_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 534
Glucose_SGLT2_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_SGLT2_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to SGLT2 Initiation")+
  ylab("Fasting glucose (mg/dL) \n")











# Insulin ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no Insulin too zero, and Insulinto one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_Insulin,.), ~replace(., grepl(string_Insulin, .), "Insulin")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Insulin",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Insulin
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Insulin
DIA_Drug_Histories_FIRST_Insulin <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Insulin)[2] <- "Month_First_Insulin"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the Insulin criteria
Patient_first_Insulin <-  DIA_Drug_Histories_FIRST_Insulin %>% select(patient)
DANU_Measures <- Patient_first_Insulin %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first Insulin month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Insulin, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeInsulin start and months after Insulin start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_Insulin <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Insulin))
Glucose_before_Insulin <- Glucose_before_Insulin %>% group_by(patient, Month_First_Insulin) %>% summarize(value=mean(value))
names(Glucose_before_Insulin)[2] <- "Month_First"
names(Glucose_before_Insulin)[3] <- "Glucose_Prior"

Glucose_after_Insulin <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Insulin))
Glucose_after_Insulin <- Glucose_after_Insulin %>% group_by(patient, Month_First_Insulin) %>% summarize(value=mean(value))
names(Glucose_after_Insulin)[2] <- "Month_First"
names(Glucose_after_Insulin)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_Insulin_BEFORE_vs_AFTER <- Glucose_before_Insulin %>% full_join(Glucose_after_Insulin)
Glucose_Insulin_BEFORE_vs_AFTER <- Glucose_Insulin_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_Insulin_BEFORE_vs_AFTER$Glucose_Prior) #156.0541
mean(Glucose_Insulin_BEFORE_vs_AFTER$Glucose_After) #139.7438


wilcox.test(Glucose_Insulin_BEFORE_vs_AFTER$Glucose_Prior, Glucose_Insulin_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 749
Glucose_Insulin_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_Insulin_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to Insulin Initiation")+
  ylab("Fasting glucose (mg/dL) \n")


# GLP1 ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 too zero, and GLP1to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[2] <- "Month_First_GLP1"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the GLP1 criteria
Patient_first_GLP1 <-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first GLP1 month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeGLP1 start and months after GLP1 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1))
Glucose_before_GLP1 <- Glucose_before_GLP1 %>% group_by(patient, Month_First_GLP1) %>% summarize(value=mean(value))
names(Glucose_before_GLP1)[2] <- "Month_First"
names(Glucose_before_GLP1)[3] <- "Glucose_Prior"

Glucose_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1))
Glucose_after_GLP1 <- Glucose_after_GLP1 %>% group_by(patient, Month_First_GLP1) %>% summarize(value=mean(value))
names(Glucose_after_GLP1)[2] <- "Month_First"
names(Glucose_after_GLP1)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_GLP1_BEFORE_vs_AFTER <- Glucose_before_GLP1 %>% full_join(Glucose_after_GLP1)
Glucose_GLP1_BEFORE_vs_AFTER <- Glucose_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior) #166.5839
mean(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After) #147.2543


wilcox.test(Glucose_GLP1_BEFORE_vs_AFTER$Glucose_Prior, Glucose_GLP1_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 652
Glucose_GLP1_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_GLP1_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to GLP1 Initiation")+
  ylab("Fasting glucose (mg/dL) \n")

# Biguanide ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no Biguanide too zero, and Biguanideto one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_Biguanide,.), ~replace(., grepl(string_Biguanide, .), "Biguanide")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Biguanide",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Biguanide
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Biguanide
DIA_Drug_Histories_FIRST_Biguanide <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Biguanide)[2] <- "Month_First_Biguanide"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the Biguanide criteria
Patient_first_Biguanide <-  DIA_Drug_Histories_FIRST_Biguanide %>% select(patient)
DANU_Measures <- Patient_first_Biguanide %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first Biguanide month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Biguanide, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeBiguanide start and months after Biguanide start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_Biguanide <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Biguanide))
Glucose_before_Biguanide <- Glucose_before_Biguanide %>% group_by(patient, Month_First_Biguanide) %>% summarize(value=mean(value))
names(Glucose_before_Biguanide)[2] <- "Month_First"
names(Glucose_before_Biguanide)[3] <- "Glucose_Prior"

Glucose_after_Biguanide <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Biguanide))
Glucose_after_Biguanide <- Glucose_after_Biguanide %>% group_by(patient, Month_First_Biguanide) %>% summarize(value=mean(value))
names(Glucose_after_Biguanide)[2] <- "Month_First"
names(Glucose_after_Biguanide)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_Biguanide_BEFORE_vs_AFTER <- Glucose_before_Biguanide %>% full_join(Glucose_after_Biguanide)
Glucose_Biguanide_BEFORE_vs_AFTER <- Glucose_Biguanide_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_Biguanide_BEFORE_vs_AFTER$Glucose_Prior) #142.1242
mean(Glucose_Biguanide_BEFORE_vs_AFTER$Glucose_After) #132.1015


wilcox.test(Glucose_Biguanide_BEFORE_vs_AFTER$Glucose_Prior, Glucose_Biguanide_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 1288
Glucose_Biguanide_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_Biguanide_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to Biguanide Initiation")+
  ylab("Fasting glucose (mg/dL) \n")

# DPP4 ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no DPP4 too zero, and DPP4to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_DPP4,.), ~replace(., grepl(string_DPP4, .), "DPP4")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="DPP4",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to DPP4
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took DPP4
DIA_Drug_Histories_FIRST_DPP4 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_DPP4)[2] <- "Month_First_DPP4"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the DPP4 criteria
Patient_first_DPP4 <-  DIA_Drug_Histories_FIRST_DPP4 %>% select(patient)
DANU_Measures <- Patient_first_DPP4 %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first DPP4 month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_DPP4, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeDPP4 start and months after DPP4 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_DPP4 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_DPP4))
Glucose_before_DPP4 <- Glucose_before_DPP4 %>% group_by(patient, Month_First_DPP4) %>% summarize(value=mean(value))
names(Glucose_before_DPP4)[2] <- "Month_First"
names(Glucose_before_DPP4)[3] <- "Glucose_Prior"

Glucose_after_DPP4 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_DPP4))
Glucose_after_DPP4 <- Glucose_after_DPP4 %>% group_by(patient, Month_First_DPP4) %>% summarize(value=mean(value))
names(Glucose_after_DPP4)[2] <- "Month_First"
names(Glucose_after_DPP4)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_DPP4_BEFORE_vs_AFTER <- Glucose_before_DPP4 %>% full_join(Glucose_after_DPP4)
Glucose_DPP4_BEFORE_vs_AFTER <- Glucose_DPP4_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_DPP4_BEFORE_vs_AFTER$Glucose_Prior) #164.1205
mean(Glucose_DPP4_BEFORE_vs_AFTER$Glucose_After) #152.4148


wilcox.test(Glucose_DPP4_BEFORE_vs_AFTER$Glucose_Prior, Glucose_DPP4_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 407
Glucose_DPP4_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_DPP4_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to DPP4 Initiation")+
  ylab("Fasting glucose (mg/dL) \n")

# Antidiabetic ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no Antidiabetic too zero, and Antidiabeticto one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_Antidiabetic,.), ~replace(., grepl(string_Antidiabetic, .), "Antidiabetic")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Antidiabetic",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Antidiabetic
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Antidiabetic
DIA_Drug_Histories_FIRST_Antidiabetic <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Antidiabetic)[2] <- "Month_First_Antidiabetic"

# Now get the Fasting Glucose levels
# File with Fasting Glucose over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures 3.1 Fasting Glucose.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% select(patient, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patient, Exact_Month, value) %>% group_by(patient)
#filter for the patients that fit the Antidiabetic criteria
Patient_first_Antidiabetic <-  DIA_Drug_Histories_FIRST_Antidiabetic %>% select(patient)
DANU_Measures <- Patient_first_Antidiabetic %>% left_join(DANU_Measures, by=c("patient"="patient"))
#remove those ptients with no  Fasting Glucose  level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(value))

#join the patient first Antidiabetic month to his Fasting Glucose readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Antidiabetic, by = c("patient" = "patient")) %>% drop_na()

# now split into months beforeAntidiabetic start and months after Antidiabetic start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
# rename
Glucose_before_Antidiabetic <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Antidiabetic))
Glucose_before_Antidiabetic <- Glucose_before_Antidiabetic %>% group_by(patient, Month_First_Antidiabetic) %>% summarize(value=mean(value))
names(Glucose_before_Antidiabetic)[2] <- "Month_First"
names(Glucose_before_Antidiabetic)[3] <- "Glucose_Prior"

Glucose_after_Antidiabetic <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Antidiabetic))
Glucose_after_Antidiabetic <- Glucose_after_Antidiabetic %>% group_by(patient, Month_First_Antidiabetic) %>% summarize(value=mean(value))
names(Glucose_after_Antidiabetic)[2] <- "Month_First"
names(Glucose_after_Antidiabetic)[3] <- "Glucose_After"

#join the before and after Glucose
Glucose_Antidiabetic_BEFORE_vs_AFTER <- Glucose_before_Antidiabetic %>% full_join(Glucose_after_Antidiabetic)
Glucose_Antidiabetic_BEFORE_vs_AFTER <- Glucose_Antidiabetic_BEFORE_vs_AFTER %>% na.omit()

mean(Glucose_Antidiabetic_BEFORE_vs_AFTER$Glucose_Prior) #156.3969
mean(Glucose_Antidiabetic_BEFORE_vs_AFTER$Glucose_After) #141.4837



wilcox.test(Glucose_Antidiabetic_BEFORE_vs_AFTER$Glucose_Prior, Glucose_Antidiabetic_BEFORE_vs_AFTER$Glucose_After, paired = TRUE, alternative = "greater")

# 677
Glucose_Antidiabetic_BEFORE_vs_AFTER %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_Prior)) %>% mutate(Period="Before") %>% mutate(Glucose=Glucose_Prior) %>% select(-Glucose_Prior) %>% 
  bind_rows(
    Glucose_Antidiabetic_BEFORE_vs_AFTER  %>% filter(Glucose_Prior<400 & Glucose_After<400) %>% ungroup() %>% select(c(Glucose_After)) %>% mutate(Period="After") %>% mutate(Glucose=Glucose_After) %>% select(-Glucose_After)) %>%
  ggplot(aes(x=factor(Period, levels=c("Before", "After")), y=Glucose, colour=Period)) +
  geom_boxplot(outlier.colour = "white", size=1.5, notch = TRUE, width=0.4 , show.legend = FALSE)+
  geom_jitter(size=1.5, alpha=0.3, show.legend = F) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Period relative to Antidiabetic Initiation")+
  ylab("Fasting glucose (mg/dL) \n")


# ------------
# -----------
# Apply the classification/regression for GLP1 to all Diabetes patients ------------



# Logistic regression GLP1 Inj Exp vs No Exp

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis))

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Physicians_Experience <- fread("Physicians_Experience.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Physicians_Experience)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(Dems_Labs_TreatExp)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_InjExp==1, "GLP1_Exp", "No_GLP1"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_GLP1")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_InjExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))

temp <- Dems_Labs_TreatExp

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)

Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(40761)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()


# Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(age=scale(age),
#                               MAX_HbA1c =scale(MAX_HbA1c ),
#                               MAX_BMI =scale(MAX_BMI ),
#                               MAX_ALT =scale(MAX_ALT ),
#                               MAX_AST =scale(MAX_AST ),
#                               age=scale(age))


create_train_test <- function(data, size = 0.8, train = TRUE) {
  n_row = nrow(data)
  total_row = size * n_row
  train_sample <- 1: total_row
  if (train == TRUE) {
    return (data[train_sample, ])
  } else {
    return (data[-train_sample, ])
  }
}


Dems_Labs_TreatExp <- Dems_Labs_TreatExp[sample(1:nrow(Dems_Labs_TreatExp)), ]

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(c(Group, age, gender, diagnosis, Lines, p1_SGLT2Exp, ENDOCRINOLOGY, `EMERGENCY MEDICINE` ))

data_train <- create_train_test(Dems_Labs_TreatExp, 0.8, train = TRUE)
data_test <- create_train_test(Dems_Labs_TreatExp, 0.8, train = FALSE)

Risk_pred_model <- glm( Group ~ ., data = data_train, family = binomial)

summary(Risk_pred_model)

predict <- predict(Risk_pred_model, data_test, type = 'response')


table_mat <- table(data_test$Group, predict > 0.50)
table_mat

plot(table_mat)

accuracy_Test <- sum(diag(table_mat)) / sum(table_mat)
accuracy_Test


precision <- function(matrix) {
  # True positive
  tp <- matrix[2, 2]
  # false positive
  fp <- matrix[1, 2]
  return (tp / (tp + fp))
}


recall <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]# false positive
  fn <- matrix[2, 1]
  return (tp / (tp + fn))
}


prec <- precision(table_mat)
prec # 0.7955437

rec <- recall(table_mat)
rec # 0.6930778

f1 <- 2 * ((prec * rec) / (prec + rec))
f1 # 0.7407842


pred <- data.frame(predict(Risk_pred_model, temp, type = 'response')) %>% bind_cols(temp)

names(pred)[1] <- "Probability"

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Stocksm60 <- DIA_Flows_Aux._Long %>% filter(p2 == 60) %>% select(patient, s2)

pred <- pred %>% left_join(Stocksm60)

pred %>% select(c(Probability, s2, weight)) %>% mutate(RiskLevel = ifelse(Probability>0.95, "HighRisk", "LowRisk")) %>%
  group_by(s2, RiskLevel) %>% summarise(n=sum(weight))



# 


# Logistic regression GLP1 Oral Exp vs No Exp

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis))

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Physicians_Experience <- fread("Physicians_Experience.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Physicians_Experience)


Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(Dems_Labs_TreatExp)


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_OralExp==1, "GLP1_Exp", "No_GLP1"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_GLP1")


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_OralExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))

temp <- Dems_Labs_TreatExp

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)

Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(2036)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()


# Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(age=scale(age),
#                               MAX_HbA1c =scale(MAX_HbA1c ),
#                               MAX_BMI =scale(MAX_BMI ),
#                               MAX_ALT =scale(MAX_ALT ),
#                               MAX_AST =scale(MAX_AST ),
#                               age=scale(age))




create_train_test <- function(data, size = 0.8, train = TRUE) {
  n_row = nrow(data)
  total_row = size * n_row
  train_sample <- 1: total_row
  if (train == TRUE) {
    return (data[train_sample, ])
  } else {
    return (data[-train_sample, ])
  }
}



Dems_Labs_TreatExp <- Dems_Labs_TreatExp[sample(1:nrow(Dems_Labs_TreatExp)), ]

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(c(Group, age, Lines, p1_InsulinExp, p1_SGLT2Exp ))

data_train <- create_train_test(Dems_Labs_TreatExp, 0.8, train = TRUE)
data_test <- create_train_test(Dems_Labs_TreatExp, 0.8, train = FALSE)

Risk_pred_model <- glm( Group ~ ., data = data_train, family = binomial)

summary(Risk_pred_model)




predict <- predict(Risk_pred_model, data_test, type = 'response')

table_mat <- table(data_test$Group, predict > 0.50)
table_mat

plot(table_mat)

accuracy_Test <- sum(diag(table_mat)) / sum(table_mat)
accuracy_Test


precision <- function(matrix) {
  # True positive
  tp <- matrix[2, 2]
  # false positive
  fp <- matrix[1, 2]
  return (tp / (tp + fp))
}



recall <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]# false positive
  fn <- matrix[2, 1]
  return (tp / (tp + fn))
}


prec <- precision(table_mat)
prec # 0.7277778

rec <- recall(table_mat)
rec # 0.6805195

f1 <- 2 * ((prec * rec) / (prec + rec))
f1 # 0.7033557



pred <- data.frame(predict(Risk_pred_model, temp, type = 'response')) %>% bind_cols(temp)

names(pred)[1] <- "Probability"

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Stocksm60 <- DIA_Flows_Aux._Long %>% filter(p2 == 60) %>% select(patient, s2)

pred <- pred %>% left_join(Stocksm60)

pred %>% select(c(Probability, s2, weight)) %>% mutate(RiskLevel = ifelse(Probability>0.95, "HighRisk", "LowRisk")) %>%
  group_by(s2, RiskLevel) %>% summarise(n=sum(weight))












# -------
# Logistic regression GLP1 Inj Exp vs No Exp  !! UP UNTIL M54 only  !! ------------


# Nr of drugs ! UP UNTIL M40 !
DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-weight)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)

DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Drugs != "-")

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% filter(Month<=54)

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>% distinct()
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, Drugs, sep = ",", convert=T )

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% count()

names(DIA_Drug_Histories)[2] <- "Diff_Drugs_exp"

fwrite(DIA_Drug_Histories, "Number_Drugs_EverExperienced_54.txt", sep="\t")


# Physicians Experience ! UP UNTIL M40 !

DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient)

Dia_US_Doses <- fread("DIA Doses.txt")
Dia_US_Doses <- Dia_US_Doses %>% filter(status != "G")
Dia_US_Doses <- Dia_US_Doses %>% select(-c(drug_id, weight, dayssup, taxonomy1, taxonomy2, status))
Dia_US_Doses <- Dia_US_Doses %>% mutate(from_dt = as.Date(from_dt))
Dia_US_Doses <- Dia_US_Doses %>%filter(from_dt >= "2016-05-01" & from_dt <= "2020-10-31") 
names(Dia_US_Doses)[4] <- "patient"

Dia_US_Doses <- DIA_Drug_Histories %>% left_join(Dia_US_Doses)

PROVCAT <- fread("PROVCAT.txt", sep="|")
PROVCAT$PROVCAT <- sub("^0+", "", PROVCAT$PROVCAT)  
PROVCAT <- PROVCAT %>% mutate(PROVCAT = ifelse(PROVCAT=="","0",PROVCAT))
PROVCAT$PROVCAT <- as.numeric(PROVCAT$PROVCAT)

Specialties_to_keep <- fread("Specialties_to_keep.txt")

temp <- Dia_US_Doses %>% select(patient, specialty) %>% distinct() %>% 
  left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) %>%
  select(patient, PHYSICIAN) %>% distinct() %>% mutate(Physician_Exp = 1) %>% 
  spread(key=PHYSICIAN, value=Physician_Exp) %>% select(-c(5,10,11,13))

length(unique(temp$patient))

temp[is.na(temp)] <- 0

fwrite(temp, "Physicians_Experience_54.txt", sep="\t")





# Nr of HbA1c & BMIs


Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <-DANU_Measures %>% select(patient, test, value, claimed)

DANU_Measures$Month_yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")

DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patient, test, value, Exact_Month)

Nr_HbA1cs <- DANU_Measures %>% filter(test=="HbA1c Level") %>% group_by(patient, Exact_Month) %>% count()
Nr_HbA1cs <- Nr_HbA1cs %>% group_by(patient) %>% mutate(CumSumHbA1c = cumsum(n))
Nr_HbA1cs <- Nr_HbA1cs %>% select(-3)

Nr_BMIs <- DANU_Measures %>% filter(test=="BMI") %>% group_by(patient, Exact_Month) %>% count()
Nr_BMIs <- Nr_BMIs %>% group_by(patient) %>% mutate(CumSumBMI = cumsum(n))
Nr_BMIs <- Nr_BMIs %>% select(-3)

fwrite(Nr_HbA1cs, "Nr_HbA1c_Cummulative_MonthOverMonth.txt", sep="\t")
fwrite(Nr_BMIs, "Nr_BMI_Cummulative_MonthOverMonth.txt", sep="\t")





# All together
MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis)) # age if off by one


Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==54) %>% select(-c(p1, p2)) # Exp until M40

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced_54.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Physicians_Experience <- fread("Physicians_Experience_54.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Physicians_Experience)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(Dems_Labs_TreatExp)

# Nr_HbA1c_Cummulative_MonthOverMonth <- fread("Nr_HbA1c_Cummulative_MonthOverMonth.txt")
# Nr_BMI_Cummulative_MonthOverMonth <- fread("Nr_BMI_Cummulative_MonthOverMonth.txt")
# 
# Nr_HbA1c_Cummulative_MonthOverMonth <- Nr_HbA1c_Cummulative_MonthOverMonth %>% group_by(patient) %>% filter(Exact_Month<=54) %>% filter(CumSumHbA1c==max(CumSumHbA1c)) %>%
#   select(patient, CumSumHbA1c)
# 
# Nr_BMI_Cummulative_MonthOverMonth <- Nr_BMI_Cummulative_MonthOverMonth %>% group_by(patient) %>% filter(Exact_Month<=54) %>% filter(CumSumBMI==max(CumSumBMI)) %>%
#   select(patient, CumSumBMI)
# 
# Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Nr_HbA1c_Cummulative_MonthOverMonth) %>% mutate(CumSumHbA1c = ifelse(is.na(CumSumHbA1c), 0, CumSumHbA1c))
# Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Nr_BMI_Cummulative_MonthOverMonth) %>% mutate(CumSumBMI = ifelse(is.na(CumSumBMI), 0, CumSumHbA1c))


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_InjExp==1, "GLP1_Exp", "No_GLP1"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_GLP1")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_InjExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))

temp <- Dems_Labs_TreatExp

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)

Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(33776)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()


# Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(age=scale(age),
#                               MAX_HbA1c =scale(MAX_HbA1c ),
#                               MAX_BMI =scale(MAX_BMI ),
#                               MAX_ALT =scale(MAX_ALT ),
#                               MAX_AST =scale(MAX_AST ),
#                               age=scale(age))


create_train_test <- function(data, size = 0.8, train = TRUE) {
  n_row = nrow(data)
  total_row = size * n_row
  train_sample <- 1: total_row
  if (train == TRUE) {
    return (data[train_sample, ])
  } else {
    return (data[-train_sample, ])
  }
}


Dems_Labs_TreatExp <- Dems_Labs_TreatExp[sample(1:nrow(Dems_Labs_TreatExp)), ]

# Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(c(Group, age, gender, diagnosis, cumflow, Lines, Diff_Drugs_exp, p1_SGLT2Exp, ENDOCRINOLOGY, `EMERGENCY MEDICINE` ))

data_train <- create_train_test(Dems_Labs_TreatExp, 0.8, train = TRUE)
data_test <- create_train_test(Dems_Labs_TreatExp, 0.8, train = FALSE)

Risk_pred_model <- glm( Group ~ ., data = data_train, family = binomial)

summary(Risk_pred_model)


predict <- predict(Risk_pred_model, data_test, type = 'response')


table_mat <- table(data_test$Group, predict > 0.5)
table_mat

plot(table_mat)

accuracy_Test <- sum(diag(table_mat)) / sum(table_mat)
accuracy_Test #0.7965362


precision <- function(matrix) {
  # True positive
  tp <- matrix[2, 2]
  # false positive
  fp <- matrix[1, 2]
  return (tp / (tp + fp))
}


recall <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]# false positive
  fn <- matrix[2, 1]
  return (tp / (tp + fn))
}


prec <- precision(table_mat)
prec # 0.8447819

rec <- recall(table_mat)
rec # 0.718966

f1 <- 2 * ((prec * rec) / (prec + rec))
f1 # 0.7768125


pred <- data.frame(predict(Risk_pred_model, temp, type = 'response')) %>% bind_cols(temp)

names(pred)[1] <- "Probability"



DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

GLP1_Exp_M48forward <- DIA_Flows_Aux._Long %>% filter(p2 >= 54) %>% select(patient, s2) %>% filter(s2=="G") %>% distinct()

pred <- pred %>% left_join(GLP1_Exp_M48forward) %>% mutate(s2=ifelse(is.na(s2),"No_GLP1", "GLP1_Exp"))


pred %>% select(c(Probability, s2, weight)) %>% mutate(RiskLevel = ifelse(Probability>0.5, "HighRisk", "LowRisk")) %>%
  group_by(s2, RiskLevel) %>% summarise(n=sum(weight)) %>% ungroup()




pred %>% select(c(Probability, s2, weight)) %>% mutate(RiskLevel = ifelse(Probability>0.95, "HighRisk", "LowRisk")) %>%
  group_by(s2, RiskLevel) %>% summarise(n=sum(weight)) %>% ungroup()





DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

Stock_M54 <- DIA_Flows_Aux._Long %>% filter(p2 == 54) %>% select(patient, s2) 


pred %>% left_join(Stock_M54) %>%  select(c(Probability, s2, weight)) %>%
  mutate(RiskLevel = ifelse(Probability>0.5, "HighRisk", "LowRisk")) %>% 
  group_by(s2, RiskLevel) %>% summarise(n=sum(weight)) %>% ungroup() %>%
  spread(key=RiskLevel, value=n)


ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(p1_SGLT2Exp))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "SGLT2 Experience")+
  scale_fill_viridis_d()


ggplot(Dems_Labs_TreatExp, aes(x = Group, fill = as.factor(ENDOCRINOLOGY))) +
  geom_bar(position = "fill", alpha=0.8) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Endocrionology Experience")+
  scale_fill_viridis_d()


Dems_Labs_TreatExp %>% filter(Diff_Drugs_exp<40) %>% ggplot(aes(x = Diff_Drugs_exp, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Different Molecules") + ylab("GLP1 Injectable Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(Diff_Drugs_exp))


Dems_Labs_TreatExp %>% filter(Lines<15) %>% ggplot(aes(x = Lines, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Terapy Lines") + ylab("GLP1 Injectable Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(Lines))


Dems_Labs_TreatExp %>% filter(cumflow<30) %>% ggplot(aes(x = cumflow, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Flows") + ylab("GLP1 Injectable Experience \n")

Dems_Labs_TreatExp %>% group_by(Group) %>% summarise(n=mean(cumflow))






Odd_ratios_GLP1_noGLP1_TreatExt <- fread("Odd_ratios_GLP1_noGLP1_TreatExt_short_M54.txt", sep="\t")

Odd_ratios_GLP1_noGLP1_TreatExt$Predictor <- as.factor(Odd_ratios_GLP1_noGLP1_TreatExt$Predictor)

Odd_ratios_GLP1_noGLP1_TreatExt <- Odd_ratios_GLP1_noGLP1_TreatExt %>% arrange(`Odd ratio`)

Odd_ratios_GLP1_noGLP1_TreatExt <- Odd_ratios_GLP1_noGLP1_TreatExt %>% filter(`Sig. ?`!="ns")

Odd_ratios_GLP1_noGLP1_TreatExt %>%
  filter(Predictor!="Nr Flows Tried ?") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_minimal() +
  scale_y_continuous(trans='log10')+
  theme(legend.position = "none",) +
  geom_hline(yintercept=1, linetype='dashed', color='firebrick', size=1) +
  xlab("Predictor \n") +
  #ylim(0.5,1.5)+
  ylab("\n Log10 Odd ratio (Lower-Upper ends)")



# ---------



# Doses All
DIA_US_Doses <- fread("DIA Doses.txt")
DIA_US_Doses <- DIA_US_Doses %>% filter(status != "G")
DIA_US_Doses <- DIA_US_Doses %>% filter(paid != "?")
DIA_US_Doses <- DIA_US_Doses %>% select(drug_group, pat_id, from_dt, paid)
DIA_US_Doses$from_dt <- as.Date(DIA_US_Doses$from_dt)
DIA_US_Doses <- DIA_US_Doses %>% arrange(drug_group, pat_id, from_dt)

unique(DIA_US_Doses$drug_group)

# Injectable GLP1
DIA_US_Doses_GLP1_Injectable <- DIA_US_Doses %>% filter(drug_group=="GLP1 Injectable")
Paid_dates_GLP1 <- DIA_US_Doses_GLP1_Injectable %>% filter(paid=="P") %>% select(-paid)
names(Paid_dates_GLP1)[3] <- "Paid_dates"
DIA_US_Doses_GLP1_Injectable <- DIA_US_Doses_GLP1_Injectable %>% left_join(Paid_dates_GLP1)
DIA_US_Doses_GLP1_Injectable <- DIA_US_Doses_GLP1_Injectable %>% group_by(pat_id) %>% mutate(ElapsedTime=as.numeric(from_dt-Paid_dates))
To_keep <- DIA_US_Doses_GLP1_Injectable %>% filter(paid=="D"&ElapsedTime<=0&ElapsedTime>=(-90)) %>% select(-c(Paid_dates, ElapsedTime)) %>% distinct()
To_keep$tokeep <- "Yes"
DIA_US_Doses_GLP1_Injectable <- DIA_US_Doses %>% filter(drug_group=="GLP1 Injectable")
DIA_US_Doses_GLP1_Injectable <- DIA_US_Doses_GLP1_Injectable %>% left_join(To_keep)
DIA_US_Doses_GLP1_Injectable <- DIA_US_Doses_GLP1_Injectable %>% filter(!(paid=="D"&is.na(tokeep)))

DIA_US_Doses_GLP1_Injectable %>% group_by(paid) %>% count()

# Oral GLP1
DIA_US_Doses_GLP1_Oral <- DIA_US_Doses %>% filter(drug_group=="GLP1 Oral")
Paid_dates_GLP1 <- DIA_US_Doses_GLP1_Oral %>% filter(paid=="P") %>% select(-paid)
names(Paid_dates_GLP1)[3] <- "Paid_dates"
DIA_US_Doses_GLP1_Oral <- DIA_US_Doses_GLP1_Oral %>% left_join(Paid_dates_GLP1)
DIA_US_Doses_GLP1_Oral <- DIA_US_Doses_GLP1_Oral %>% group_by(pat_id) %>% mutate(ElapsedTime=as.numeric(from_dt-Paid_dates))
To_keep <- DIA_US_Doses_GLP1_Oral %>% filter(paid=="D"&ElapsedTime<=0&ElapsedTime>=(-90)) %>% select(-c(Paid_dates, ElapsedTime)) %>% distinct()
To_keep$tokeep <- "Yes"
DIA_US_Doses_GLP1_Oral <- DIA_US_Doses %>% filter(drug_group=="GLP1 Oral")
DIA_US_Doses_GLP1_Oral <- DIA_US_Doses_GLP1_Oral %>% left_join(To_keep)
DIA_US_Doses_GLP1_Oral <- DIA_US_Doses_GLP1_Oral %>% filter(!(paid=="D"&is.na(tokeep)))

DIA_US_Doses_GLP1_Oral %>% group_by(paid) %>% count()



# Biguanide
DIA_US_Doses_Biguanide <- DIA_US_Doses %>% filter(drug_group=="Biguanide")
Paid_dates_Biguanide <- DIA_US_Doses_Biguanide %>% filter(paid=="P") %>% select(-paid)
names(Paid_dates_Biguanide)[3] <- "Paid_dates"
DIA_US_Doses_Biguanide <- DIA_US_Doses_Biguanide %>% left_join(Paid_dates_Biguanide)
DIA_US_Doses_Biguanide <- DIA_US_Doses_Biguanide %>% group_by(pat_id) %>% mutate(ElapsedTime=as.numeric(from_dt-Paid_dates))
To_keep <- DIA_US_Doses_Biguanide %>% filter(paid=="D"&ElapsedTime<=0&ElapsedTime>=(-90)) %>% select(-c(Paid_dates, ElapsedTime)) %>% distinct()
To_keep$tokeep <- "Yes"
DIA_US_Doses_Biguanide <- DIA_US_Doses %>% filter(drug_group=="Biguanide")
DIA_US_Doses_Biguanide <- DIA_US_Doses_Biguanide %>% left_join(To_keep)
DIA_US_Doses_Biguanide <- DIA_US_Doses_Biguanide %>% filter(!(paid=="D"&is.na(tokeep)))

DIA_US_Doses_Biguanide %>% group_by(paid) %>% count()



# Antidiabetic
DIA_US_Doses_Antidiabetic <- DIA_US_Doses %>% filter(drug_group=="Antidiabetic")
Paid_dates_Antidiabetic <- DIA_US_Doses_Antidiabetic %>% filter(paid=="P") %>% select(-paid)
names(Paid_dates_Antidiabetic)[3] <- "Paid_dates"
DIA_US_Doses_Antidiabetic <- DIA_US_Doses_Antidiabetic %>% left_join(Paid_dates_Antidiabetic)
DIA_US_Doses_Antidiabetic <- DIA_US_Doses_Antidiabetic %>% group_by(pat_id) %>% mutate(ElapsedTime=as.numeric(from_dt-Paid_dates))
To_keep <- DIA_US_Doses_Antidiabetic %>% filter(paid=="D"&ElapsedTime<=0&ElapsedTime>=(-90)) %>% select(-c(Paid_dates, ElapsedTime)) %>% distinct()
To_keep$tokeep <- "Yes"
DIA_US_Doses_Antidiabetic <- DIA_US_Doses %>% filter(drug_group=="Antidiabetic")
DIA_US_Doses_Antidiabetic <- DIA_US_Doses_Antidiabetic %>% left_join(To_keep)
DIA_US_Doses_Antidiabetic <- DIA_US_Doses_Antidiabetic %>% filter(!(paid=="D"&is.na(tokeep)))

DIA_US_Doses_Antidiabetic %>% group_by(paid) %>% count()

# Insulin
DIA_US_Doses_Insulin <- DIA_US_Doses %>% filter(drug_group=="Insulin")
Paid_dates_Insulin <- DIA_US_Doses_Insulin %>% filter(paid=="P") %>% select(-paid)
names(Paid_dates_Insulin)[3] <- "Paid_dates"
DIA_US_Doses_Insulin <- DIA_US_Doses_Insulin %>% left_join(Paid_dates_Insulin)
DIA_US_Doses_Insulin <- DIA_US_Doses_Insulin %>% group_by(pat_id) %>% mutate(ElapsedTime=as.numeric(from_dt-Paid_dates))
To_keep <- DIA_US_Doses_Insulin %>% filter(paid=="D"&ElapsedTime<=0&ElapsedTime>=(-90)) %>% select(-c(Paid_dates, ElapsedTime)) %>% distinct()
To_keep$tokeep <- "Yes"
DIA_US_Doses_Insulin <- DIA_US_Doses %>% filter(drug_group=="Insulin")
DIA_US_Doses_Insulin <- DIA_US_Doses_Insulin %>% left_join(To_keep)
DIA_US_Doses_Insulin <- DIA_US_Doses_Insulin %>% filter(!(paid=="D"&is.na(tokeep)))

DIA_US_Doses_Insulin %>% group_by(paid) %>% count()



# DPP4
DIA_US_Doses_DPP4 <- DIA_US_Doses %>% filter(drug_group=="DPP4")
Paid_dates_DPP4 <- DIA_US_Doses_DPP4 %>% filter(paid=="P") %>% select(-paid)
names(Paid_dates_DPP4)[3] <- "Paid_dates"
DIA_US_Doses_DPP4 <- DIA_US_Doses_DPP4 %>% left_join(Paid_dates_DPP4)
DIA_US_Doses_DPP4 <- DIA_US_Doses_DPP4 %>% group_by(pat_id) %>% mutate(ElapsedTime=as.numeric(from_dt-Paid_dates))
To_keep <- DIA_US_Doses_DPP4 %>% filter(paid=="D"&ElapsedTime<=0&ElapsedTime>=(-90)) %>% select(-c(Paid_dates, ElapsedTime)) %>% distinct()
To_keep$tokeep <- "Yes"
DIA_US_Doses_DPP4 <- DIA_US_Doses %>% filter(drug_group=="DPP4")
DIA_US_Doses_DPP4 <- DIA_US_Doses_DPP4 %>% left_join(To_keep)
DIA_US_Doses_DPP4 <- DIA_US_Doses_DPP4 %>% filter(!(paid=="D"&is.na(tokeep)))

DIA_US_Doses_DPP4 %>% group_by(paid) %>% count()




# SGLT2
DIA_US_Doses_SGLT2 <- DIA_US_Doses %>% filter(drug_group=="SGLT2")
Paid_dates_SGLT2 <- DIA_US_Doses_SGLT2 %>% filter(paid=="P") %>% select(-paid)
names(Paid_dates_SGLT2)[3] <- "Paid_dates"
DIA_US_Doses_SGLT2 <- DIA_US_Doses_SGLT2 %>% left_join(Paid_dates_SGLT2)
DIA_US_Doses_SGLT2 <- DIA_US_Doses_SGLT2 %>% group_by(pat_id) %>% mutate(ElapsedTime=as.numeric(from_dt-Paid_dates))
To_keep <- DIA_US_Doses_SGLT2 %>% filter(paid=="D"&ElapsedTime<=0&ElapsedTime>=(-90)) %>% select(-c(Paid_dates, ElapsedTime)) %>% distinct()
To_keep$tokeep <- "Yes"
DIA_US_Doses_SGLT2 <- DIA_US_Doses %>% filter(drug_group=="SGLT2")
DIA_US_Doses_SGLT2 <- DIA_US_Doses_SGLT2 %>% left_join(To_keep)
DIA_US_Doses_SGLT2 <- DIA_US_Doses_SGLT2 %>% filter(!(paid=="D"&is.na(tokeep)))

DIA_US_Doses_SGLT2 %>% group_by(paid) %>% count()




DIA_US_Doses_GLP1_Injectable # From above, but ove time now

DIA_US_Doses_GLP1_Injectable$Month_Yr <-  format(as.Date(DIA_US_Doses_GLP1_Injectable$from_dt), "%Y-%m")
DIA_US_Doses_GLP1_Injectable <- DIA_US_Doses_GLP1_Injectable %>% select(-from_dt)

temp <- DIA_US_Doses_GLP1_Injectable %>% group_by(Month_Yr, paid) %>% count() %>%
  spread(key=paid, value=n) %>%
  mutate(total=D+P) %>% 
  mutate(Percent_paid=100*P/total) 

temp$Month_Yr <- paste0("\'",temp$Month_Yr) 


temp %>% ggplot(aes(x=Month_Yr     , y=Percent_paid))+
  geom_point()+
  geom_smooth(method = "lm")

fwrite(temp,"Percent_PaidDenied_GLP1_OverTime.txt", sep="\t")

# How many patients have ever used injectables ? -------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Drugs != "-")
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, Drugs, sep = ",", convert=T )
DIA_Drug_Histories$Drugs <- as.character(DIA_Drug_Histories$Drugs)

DIA_Drug_Histories <- DIA_Drug_Histories %>% left_join(DANU_Ingredients %>% 
                                                         select(molecule, drug_group), by=c("Drugs"="molecule"))


DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Drugs)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(drug_group=="Insulin"|drug_group=="GLP1 Injectable")

DIA_Drug_Histories <- DIA_Drug_Histories %>% distinct()
DIA_Drug_Histories %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 13924971

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(N = n()) 

DIA_Drug_Histories %>% ungroup() %>% filter(N==2) %>% select(patient, weight) %>% distinct() %>% 
  summarise(n=sum(weight)) # 3257278

DIA_Drug_Histories %>% ungroup() %>% filter(N==1 & drug_group=="Insulin") %>% select(patient, weight) %>% distinct() %>% 
  summarise(n=sum(weight)) # 8551613

DIA_Drug_Histories %>% ungroup() %>% filter(N==1 & drug_group=="GLP1 Injectable") %>% select(patient, weight) %>% distinct() %>% 
  summarise(n=sum(weight)) # 2116079

# ----------
# -------

# Total Durations on each GLP1 molecule over 60 months------------------------------------------------------------

DANU_Ingredients <- fread("DANU Ingredients.txt")

# Albiglutide
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('48',.), ~replace(., grepl('48', .), "GLP1 Injectable"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1 Injectable",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>%  arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

GLP1_Injectable_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(GLP1_Injectable_Periods)[3] <- "Duration"
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% left_join(DIA_Drug_Histories) 
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% mutate(weight = as.numeric(weight))
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% distinct()

library(spatstat)
weighted.mean(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight)  # 8.744434
weighted.median(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight) #8.5

data.frame(GLP1_Injectable_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))




# Dulaglutide
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('49',.), ~replace(., grepl('49', .), "GLP1 Injectable"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1 Injectable",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>%  arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

GLP1_Injectable_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(GLP1_Injectable_Periods)[3] <- "Duration"
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% left_join(DIA_Drug_Histories) 
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% mutate(weight = as.numeric(weight))
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% distinct()

library(spatstat)
weighted.mean(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight)  # 14.23477
weighted.median(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight) #8.5

data.frame(GLP1_Injectable_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))

# Exenatide
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('50',.), ~replace(., grepl('50', .), "GLP1 Injectable"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1 Injectable",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>%  arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

GLP1_Injectable_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(GLP1_Injectable_Periods)[3] <- "Duration"
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% left_join(DIA_Drug_Histories) 
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% mutate(weight = as.numeric(weight))
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% distinct()

library(spatstat)
weighted.mean(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight)  # 12.40028
weighted.median(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight) #5.5

data.frame(GLP1_Injectable_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))


# Liraglutide
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('51',.), ~replace(., grepl('51', .), "GLP1 Injectable"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1 Injectable",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>%  arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

GLP1_Injectable_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(GLP1_Injectable_Periods)[3] <- "Duration"
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% left_join(DIA_Drug_Histories) 
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% mutate(weight = as.numeric(weight))
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% distinct()

library(spatstat)
weighted.mean(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight)  # 16.38384
weighted.median(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight) #9.5

data.frame(GLP1_Injectable_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))




# Lixisenatide
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('52',.), ~replace(., grepl('52', .), "GLP1 Injectable"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1 Injectable",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>%  arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

GLP1_Injectable_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(GLP1_Injectable_Periods)[3] <- "Duration"
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% left_join(DIA_Drug_Histories) 
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% mutate(weight = as.numeric(weight))
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% distinct()

library(spatstat)
weighted.mean(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight)  # 11.59064
weighted.median(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight) #7.5

data.frame(GLP1_Injectable_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))


# Semaglutide Injectable
DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('53',.), ~replace(., grepl('53', .), "GLP1 Injectable"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1 Injectable",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt", colClasses = "character")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>%  arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

GLP1_Injectable_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(GLP1_Injectable_Periods)[3] <- "Duration"
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% select(patient, Duration) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% left_join(DIA_Drug_Histories) 
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% mutate(weight = as.numeric(weight))
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
GLP1_Injectable_Periods <- GLP1_Injectable_Periods %>% distinct()

library(spatstat)
weighted.mean(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight)  # 9.033893
weighted.median(GLP1_Injectable_Periods$Total_Duration, GLP1_Injectable_Periods$weight) #5.5

data.frame(GLP1_Injectable_Periods %>% distinct() %>% group_by(Total_Duration) %>% summarise(pats = sum(weight)))
# -----------
# GLP1 Experienced ever VS  NEVER GLP1 (within treat experienced)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1,p2))
Cum_Class_Experience_EveryMonth <- Treatment_exp_Vector %>% left_join(Cum_Class_Experience_EveryMonth)

p1_InjExp <- Cum_Class_Experience_EveryMonth %>% filter(p1_InjExp==1) %>% select(patient, weight) %>% distinct()
p1_NO_InjExp <- Cum_Class_Experience_EveryMonth %>% filter(p1_InjExp!=1) %>% select(patient, weight) %>% distinct()

sum(p1_InjExp$weight) # 5373357
sum(p1_NO_InjExp$weight) # 25252333


DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories <- Treatment_exp_Vector %>% left_join(DIA_Comorbidity_Inventories, by=c("patient"="patid"))
DIA_Comorbidity_Inventories <-DIA_Comorbidity_Inventories %>% filter(!grepl("A", diagnosis) & !grepl("B", diagnosis) & !grepl("C", diagnosis) &
                                                                       !grepl("O", diagnosis) & !grepl("P", diagnosis) & !grepl("Q", diagnosis) &
                                                                       !grepl("R", diagnosis) & !grepl("S", diagnosis) & !grepl("T", diagnosis) &
                                                                       !grepl("X", diagnosis) & !grepl("Y", diagnosis) & !grepl("Z", diagnosis))


p1_InjExp <- p1_InjExp %>% left_join(DIA_Comorbidity_Inventories) %>% select(-c(weight.x, weight.y))
p1_NO_InjExp <- p1_NO_InjExp %>% left_join(DIA_Comorbidity_Inventories) %>% select(-c(weight.x, weight.y))


p1_InjExp <- p1_InjExp %>% group_by(diagnosis) %>% summarise(n=sum(weight)) %>% mutate(penetrance=100*n/5373357) %>% select(-n)
names(p1_InjExp)[1] <- "Last"
names(p1_InjExp)[2] <- "Penetrance_p1_InjExp"


p1_NO_InjExp <- p1_NO_InjExp %>% group_by(diagnosis) %>% summarise(n=sum(weight)) %>% mutate(penetrance=100*n/25252333) %>% select(-n)
names(p1_NO_InjExp)[1] <- "Last"
names(p1_NO_InjExp)[2] <- "Penetrance_p1_NO_InjExp"

Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- p1_InjExp %>% full_join(p1_NO_InjExp) %>% drop_na() %>% 
  mutate(Difference=Penetrance_p1_InjExp-Penetrance_p1_NO_InjExp) %>%
  mutate(fol_change = Penetrance_p1_InjExp/Penetrance_p1_NO_InjExp)


Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% filter(Difference>2|Difference< (-2))
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% select(Penetrance_p1_InjExp, Penetrance_p1_NO_InjExp, Last)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Last <- gsub('[^[:alnum:] ]','',Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Last)


p1_InjExp <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% select(Penetrance_p1_InjExp, Last) %>% mutate(Group="GLP1 Exp") 
names(p1_InjExp)[1] <- "Penetrance"

p1_NO_InjExp <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% select(Penetrance_p1_NO_InjExp, Last) %>% mutate(Group="No GLP1 Exp")
names(p1_NO_InjExp)[1] <- "Penetrance"

Diabetes_circular <- p1_InjExp %>% bind_rows(p1_NO_InjExp)

Diabetes_circular <- Diabetes_circular %>% mutate(Last=as.factor(Last), Group=as.factor(Group))
Diabetes_circular <- data.frame(Diabetes_circular)

row_num = length(levels(Diabetes_circular$Group))

g = ggplot(Diabetes_circular,aes(x=Last,y=as.numeric(Group),fill=Penetrance)) + 
  xlim(c("",as.vector(unique(Diabetes_circular$Last)))) + 
  ylim(c(-row_num/1.5,row_num+1))+
  geom_tile()+ ylab("")+
  scale_fill_gradientn(colours=wes_palette("Zissou1", 116, type = "continuous"))+
  annotate(x="",y=1:row_num,label=levels(Diabetes_circular$Group),size=4,geom="text", colour="firebrick") 

g + coord_polar(start=-0.15,) + theme_bw() + theme(axis.text = element_text(size = 8)) 







Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% mutate(Difference=Penetrance_p1_InjExp-Penetrance_p1_NO_InjExp)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% select(Difference, Last)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% filter(Difference>2 | Difference<(-2))
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% mutate(Group = str_sub(Last, 1L, 1L))

Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Last <- gsub('[^[:alnum:] ]','',Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Last)

empty_bar <- 4
to_add <- data.frame( matrix(NA, empty_bar*nlevels(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Group), ncol(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes)) )
colnames(to_add) <- colnames(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes)
to_add$group <- rep(levels(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Group), each=empty_bar)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- rbind(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes, to_add)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% arrange(Group)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$id <- seq(1, nrow(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes))

label_data <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)


ggplot(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes, aes(x=as.factor(id), y=Difference, fill=Group)) +  
  geom_bar(stat="identity", alpha=0.5) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank()) +
  coord_polar() + 
  scale_fill_viridis_d()+
  geom_text(data=label_data, aes(x=id, y=Difference+4, label=Last , hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2, angle= label_data$angle, inherit.aes = FALSE ) 


fwrite(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes, "Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes.txt", sep="\t") 










# Treat Experienced VS Naive

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

sum(Treatment_exp_Vector$weight) # 30625690
Treatment_exp_Vector$Treat_Exp <- "Treat_Exp"


DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories %>% select(patid, weight) %>% distinct() %>% summarise(n=sum(weight)) # 48192518 (17566828 naive)
DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% left_join(Treatment_exp_Vector, by=c("patid"="patient")) %>% mutate(Treat_Exp = ifelse(is.na(Treat_Exp),"Naive",Treat_Exp))

DIA_Comorbidity_Inventories <-DIA_Comorbidity_Inventories %>% filter(!grepl("A", diagnosis) & !grepl("B", diagnosis) & !grepl("C", diagnosis) &
                                                                       !grepl("O", diagnosis) & !grepl("P", diagnosis) & !grepl("Q", diagnosis) &
                                                                       !grepl("R", diagnosis) & !grepl("S", diagnosis) & !grepl("T", diagnosis) &
                                                                       !grepl("X", diagnosis) & !grepl("Y", diagnosis) & !grepl("Z", diagnosis))


Pats_Treat_exp <- DIA_Comorbidity_Inventories %>% filter(Treat_Exp=="Treat_Exp")
Pats_Naive <- DIA_Comorbidity_Inventories %>% filter(Treat_Exp=="Naive")


Pats_Treat_exp <- Pats_Treat_exp %>% group_by(diagnosis) %>% summarise(n=sum(weight.x)) %>% mutate(penetrance=100*n/30625690) %>% select(-n) 
names(Pats_Treat_exp)[1] <- "Last"
names(Pats_Treat_exp)[2] <- "Penetrance_Experienced"


Pats_Naive <- Pats_Naive %>% group_by(diagnosis) %>% summarise(n=sum(weight.x)) %>% mutate(penetrance=100*n/17566828) %>% select(-n)
names(Pats_Naive)[1] <- "Last"
names(Pats_Naive)[2] <- "Penetrance_Naive"

Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes <- Pats_Treat_exp %>% full_join(Pats_Naive) %>% drop_na() %>% 
  mutate(Difference=Penetrance_Experienced-Penetrance_Naive) %>%
  mutate(fol_change = Penetrance_Experienced/Penetrance_Naive)


Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes <- Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes %>% filter(Difference>2|Difference< (-2))
Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes <- Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes %>% select(Penetrance_Experienced, Penetrance_Naive, Last)
Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes$Last <- gsub('[^[:alnum:] ]','',Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes$Last)


Pats_Treat_exp <- Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes %>% select(Penetrance_Experienced, Last) %>% mutate(Group="Experienced") 
names(Pats_Treat_exp)[1] <- "Penetrance"

Pats_Naive <- Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes %>% select(Penetrance_Naive, Last) %>% mutate(Group="Naive")
names(Pats_Naive)[1] <- "Penetrance"

Diabetes_circular <- Pats_Treat_exp %>% bind_rows(Pats_Naive)

Diabetes_circular <- Diabetes_circular %>% mutate(Last=as.factor(Last), Group=as.factor(Group))
Diabetes_circular <- data.frame(Diabetes_circular)

row_num = length(levels(Diabetes_circular$Group))

g = ggplot(Diabetes_circular,aes(x=Last,y=as.numeric(Group),fill=Penetrance)) + 
  xlim(c("",as.vector(unique(Diabetes_circular$Last)))) + 
  ylim(c(-row_num/1.5,row_num+1))+
  geom_tile()+ ylab("")+
  scale_fill_gradientn(colours=wes_palette("Zissou1", 116, type = "continuous"))+
  annotate(x="",y=1:row_num,label=levels(Diabetes_circular$Group),size=4,geom="text", colour="firebrick") 

g + coord_polar(start=-0.15,) + theme_bw() + theme(axis.text = element_text(size = 8)) 







Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes <- Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes %>% mutate(Difference=Penetrance_Experienced -Penetrance_Naive )
Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes <- Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes %>% select(Difference, Last)
Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes <- Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes %>% filter(Difference>2 | Difference<(-2))
Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes <- Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes %>% mutate(Group = str_sub(Last, 1L, 1L))

Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes$Last <- gsub('[^[:alnum:] ]','',Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes$Last)

empty_bar <- 4
to_add <- data.frame( matrix(NA, empty_bar*nlevels(Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes$Group), ncol(Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes)) )
colnames(to_add) <- colnames(Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes)
to_add$group <- rep(levels(Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes$Group), each=empty_bar)
Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes <- rbind(Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes, to_add)
Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes <- Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes %>% arrange(Group)
Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes$id <- seq(1, nrow(Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes))

label_data <- Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)


ggplot(Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes, aes(x=as.factor(id), y=Difference, fill=Group)) +  
  geom_bar(stat="identity", alpha=0.5) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank()) +
  coord_polar() + 
  scale_fill_viridis_d()+
  geom_text(data=label_data, aes(x=id, y=Difference+4, label=Last , hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2, angle= label_data$angle, inherit.aes = FALSE ) 


fwrite(Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes, "Circular_Bar_Chart_Dx_TreatExpVSNaive_Diabetes.txt", sep="\t") 






# GLP1 Experienced ever and NO SGLT2 VS  SGLT2 Experienced ever and NO GLP1 (within treat experienced)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1,p2))
Cum_Class_Experience_EveryMonth <- Treatment_exp_Vector %>% left_join(Cum_Class_Experience_EveryMonth)

p1_InjExp <- Cum_Class_Experience_EveryMonth %>% filter(p1_InjExp==1&p1_SGLT2Exp==0) %>% select(patient, weight) %>% distinct()
p1_SGLT2Exp <- Cum_Class_Experience_EveryMonth %>% filter(p1_InjExp==0&p1_SGLT2Exp==1) %>% select(patient, weight) %>% distinct()

sum(p1_InjExp$weight) # 3353698
sum(p1_SGLT2Exp$weight) # 2723096


DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories <- Treatment_exp_Vector %>% left_join(DIA_Comorbidity_Inventories, by=c("patient"="patid"))
DIA_Comorbidity_Inventories <-DIA_Comorbidity_Inventories %>% filter(!grepl("A", diagnosis) & !grepl("B", diagnosis) & !grepl("C", diagnosis) &
                                                                       !grepl("O", diagnosis) & !grepl("P", diagnosis) & !grepl("Q", diagnosis) &
                                                                       !grepl("R", diagnosis) & !grepl("S", diagnosis) & !grepl("T", diagnosis) &
                                                                       !grepl("X", diagnosis) & !grepl("Y", diagnosis) & !grepl("Z", diagnosis))


p1_InjExp <- p1_InjExp %>% left_join(DIA_Comorbidity_Inventories) %>% select(-c(weight.x, weight.y))
p1_SGLT2Exp <- p1_SGLT2Exp %>% left_join(DIA_Comorbidity_Inventories) %>% select(-c(weight.x, weight.y))


p1_InjExp <- p1_InjExp %>% group_by(diagnosis) %>% summarise(n=sum(weight)) %>% mutate(penetrance=100*n/3353698) %>% select(-n)
names(p1_InjExp)[1] <- "Last"
names(p1_InjExp)[2] <- "Penetrance_p1_InjExp"


p1_SGLT2Exp <- p1_SGLT2Exp %>% group_by(diagnosis) %>% summarise(n=sum(weight)) %>% mutate(penetrance=100*n/2723096) %>% select(-n)
names(p1_SGLT2Exp)[1] <- "Last"
names(p1_SGLT2Exp)[2] <- "Penetrance_p1_SGLT2Exp"

Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- p1_InjExp %>% full_join(p1_SGLT2Exp) %>% drop_na() %>% 
  mutate(Difference=Penetrance_p1_InjExp-Penetrance_p1_SGLT2Exp) %>%
  mutate(fol_change = Penetrance_p1_InjExp/Penetrance_p1_SGLT2Exp)


Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% filter(Difference>2|Difference< (-2))
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% select(Penetrance_p1_InjExp, Penetrance_p1_SGLT2Exp, Last)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Last <- gsub('[^[:alnum:] ]','',Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Last)


p1_InjExp <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% select(Penetrance_p1_InjExp, Last) %>% mutate(Group="GLP1 Exp") 
names(p1_InjExp)[1] <- "Penetrance"

p1_SGLT2Exp <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% select(Penetrance_p1_SGLT2Exp, Last) %>% mutate(Group="SGLT2 Exp")
names(p1_SGLT2Exp)[1] <- "Penetrance"

Diabetes_circular <- p1_InjExp %>% bind_rows(p1_SGLT2Exp)

Diabetes_circular <- Diabetes_circular %>% mutate(Last=as.factor(Last), Group=as.factor(Group))
Diabetes_circular <- data.frame(Diabetes_circular)

row_num = length(levels(Diabetes_circular$Group))

g = ggplot(Diabetes_circular,aes(x=Last,y=as.numeric(Group),fill=Penetrance)) + 
  xlim(c("",as.vector(unique(Diabetes_circular$Last)))) + 
  ylim(c(-row_num/1.5,row_num+1))+
  geom_tile()+ ylab("")+
  scale_fill_gradientn(colours=wes_palette("Zissou1", 116, type = "continuous"))+
  annotate(x="",y=1:row_num,label=levels(Diabetes_circular$Group),size=4,geom="text", colour="firebrick") 

g + coord_polar(start=-0.15,) + theme_bw() + theme(axis.text = element_text(size = 8)) 







Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% mutate(Difference=Penetrance_p1_InjExp-Penetrance_p1_SGLT2Exp)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% select(Difference, Last)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% filter(Difference>2 | Difference<(-2))
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% mutate(Group = str_sub(Last, 1L, 1L))

Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Last <- gsub('[^[:alnum:] ]','',Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Last)

empty_bar <- 4
to_add <- data.frame( matrix(NA, empty_bar*nlevels(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Group), ncol(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes)) )
colnames(to_add) <- colnames(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes)
to_add$group <- rep(levels(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$Group), each=empty_bar)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- rbind(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes, to_add)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes %>% arrange(Group)
Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes$id <- seq(1, nrow(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes))

label_data <- Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id-0.5) /number_of_bar     # I substract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse( angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle+180, angle)


ggplot(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes, aes(x=as.factor(id), y=Difference, fill=Group)) +  
  geom_bar(stat="identity", alpha=0.5) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank()) +
  coord_polar() + 
  scale_fill_viridis_d()+
  geom_text(data=label_data, aes(x=id, y=Difference+4, label=Last , hjust=hjust), color="black", fontface="bold",alpha=0.6, size=2, angle= label_data$angle, inherit.aes = FALSE ) 


fwrite(Circular_Bar_Chart_Dx_Pen_GLPqVSNoGLP1_Diabetes, "Circular_Bar_Chart_Dx_Pen_GLP1VSSGLT2_Diabetes.txt", sep="\t") 




# BMI distribution per stock -------------------------------------------------------------------
# BMI on each stock each time-point

DIA_Box_histories <- fread("DIA Box Histories.txt")

DIA_Box_histories <- DIA_Box_histories %>% gather(Month, stock, month1:month60, factor_key=TRUE)
DIA_Box_histories$Month <- as.character(DIA_Box_histories$Month)
DIA_Box_histories$Month <- parse_number(DIA_Box_histories$Month)
DIA_Box_histories <- DIA_Box_histories %>% select(-disease)

Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>%  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <- DANU_Measures %>% select(-weight)
names(DANU_Measures)[3] <- "Month"

DANU_Measures <- DIA_Box_histories %>% inner_join(DANU_Measures)

DANU_Measures <- DANU_Measures %>% mutate(stock = str_extract(stock, "[a-zA-Z]"))


DANU_Measures %>% group_by(stock) %>% summarise(n=weighted.mean(as.numeric(value), as.numeric(weight)))


DANU_Measures %>% group_by(stock) %>% summarise(n=weighted.median(as.numeric(value), as.numeric(weight)))



DANU_Measures %>% select(stock, value, weight) %>% 
  filter(value>20) %>%
  mutate(stock = factor(stock, levels=c("x", "b", "d", "D", "S", "I", "g", "G"))) %>% group_by(stock) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = stock, colour=stock), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~stock, ncol = 8)+
  scale_fill_viridis_d()+
  scale_colour_viridis_d()+
  coord_flip()+
  xlim(20,60)+
  xlab("BMI (kg/m2)\n")+ ylab("\nProportion of patients")


DANU_Measures %>% select(stock, value, weight) %>% 
  filter(value>20) %>%
  mutate(stock = factor(stock, levels=c("x", "b", "d", "D", "S", "I", "g", "G"))) %>% group_by(stock) %>%
  ggplot(aes(value))+
  geom_boxplot(aes(fill = stock, colour=stock), width=0.1 , alpha =0.4,  show.legend = F, size=1, outlier.shape = NA)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~stock, ncol = 8)+
  scale_fill_viridis_d()+
  scale_colour_viridis_d()+
  coord_flip()+
  xlim(20,60)+
  xlab("BMI (kg/m2)\n")+ ylab("\nProportion of patients")


data.frame(DANU_Measures %>% select(stock, value, weight) %>% 
             mutate(stock = factor(stock, levels=c("x", "b", "d", "D", "S", "I", "g", "G"))) %>% group_by(stock) %>% 
             summarise(x = quantile(value, c(0.25, 0.5, 0.75)), q = c(0.25, 0.5, 0.75)))


library(plyr)
library(dplyr)
library(Hmisc)

DANU_Measures %>% select(stock, value, weight) %>% 
  filter(stock=="I") %>% 
  plyr::summarize(ptile25 = wtd.quantile(value, weights = weight, 
                                         probs = .25, na.rm = TRUE),
                  ptile50 = wtd.quantile(value, weights = weight, 
                                         probs = .50, na.rm = TRUE),
                  ptile75 = wtd.quantile(value, weights = weight, 
                                         probs = .75, na.rm = TRUE))


DANU_Measures %>% group_by(stock) %>% summarise(n=sum(weight))


data.frame(DANU_Measures %>% select(stock, value, weight) %>%
             mutate(BMI_bucket=ifelse(value>40,">40",
                                      ifelse(value>35,">35",
                                             ifelse(value>30,">30",
                                                    ifelse(value>25,">25", "<25"))))) %>%
             group_by(stock, BMI_bucket) %>% summarise(n=sum(as.numeric(weight)))) %>%
  mutate(Percent=ifelse(stock=="x",100*n/277494896.,
                        ifelse(stock=="b",100*n/57875868.,
                               ifelse(stock=="d",100*n/28112738.,
                                      ifelse(stock=="D",100*n/12246686.,
                                             ifelse(stock=="S",100*n/7296613.,
                                                    ifelse(stock=="I",100*n/53874009.,
                                                           ifelse(stock=="g",100*n/131501.,
                                                                  ifelse(stock=="G",100*n/17548389.,NA))))))))) %>%
  select(-n) %>%
  spread(key=stock, value=Percent)



# ----------------
# Insulin use schemes (acute, intermitent, continuous) -----------------------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))

string_Insulin <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")


DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(51:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_Insulin,.), ~replace(., grepl(string_Insulin, .), "Insulin")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Insulin",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)


DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month49:month60, factor_key=TRUE)


DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)


DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

Insulin_Periods <- DIA_Drug_Histories %>% group_by(patient, grp) %>% summarise(n=n())
names(Insulin_Periods)[3] <- "Duration"


DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight) %>% distinct()
Insulin_Periods <- Insulin_Periods %>% left_join(DIA_Drug_Histories) 



# 12 months
Insulin_Periods %>% ungroup() %>% filter(Duration==12) %>% summarise(n=sum(as.numeric(weight))) # 3017249

Total_Duration %>% filter(Total_Duration==1|Total_Duration==2) %>% ungroup() %>% select(patient) %>% distinct() %>% inner_join(Insulin_Periods) %>%
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 1376720

# 1 or 2 months
Insulin_Periods <- Insulin_Periods %>% anti_join(Total_Duration %>% filter(Total_Duration==1|Total_Duration==2) %>% ungroup() %>% select(patient) %>% distinct()) %>% filter(Duration!=12)

Insulin_Periods %>% group_by(patient) %>% filter(length(unique(grp))==1) %>% ungroup() %>% summarise(n=sum(as.numeric(weight))) # 1996418

Insulin_Periods %>% group_by(patient) %>% filter(length(unique(grp))==2) %>% ungroup() %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 1074600

Insulin_Periods %>% group_by(patient) %>% filter(length(unique(grp))>2) %>% ungroup() %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 152679





Total_Duration <- Insulin_Periods %>% group_by(patient) %>% mutate(Total_Duration = sum(Duration)) %>% select(patient, weight, Total_Duration)
Total_Duration <- Total_Duration %>% distinct()


Total_Duration %>% group_by(Total_Duration) %>% summarise(n=sum(as.numeric(weight)))

sum(as.numeric(Total_Duration$weight))


# -----
# % of patients on each stock above HbA1c > 1 FLow vs no flow -------------------------------------------
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2, flow)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1 = as.numeric(p1)) %>% filter(p1>=48)

Patient_Stocks_m60 <- DIA_Flows_Aux._Long %>% filter(p2 == "60") %>% select(patient, weight, s2)
Patient_flows_12m <- DIA_Flows_Aux._Long %>% group_by(patient) %>% summarise(flows = sum(as.numeric(flow)))
Patient_Stocks_m60 <- Patient_Stocks_m60 %>% left_join(Patient_flows_12m)



Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(test=="HbA1c Level")
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% filter(!is.na(Exact_Month)) 

Last_read <- DANU_Measures_HbA1c %>% group_by(patid) %>% slice(n())
Last_read <- Last_read %>% select(patid, Exact_Month, value)



Patient_Stocks_m60 <- Patient_Stocks_m60 %>% mutate(flows = ifelse(flows == 0, "NONE", "FLOW"))

Patient_Stocks_m60 <- Patient_Stocks_m60 %>% left_join(Last_read, by=c("patient"="patid"))
Patient_Stocks_m60 <- Patient_Stocks_m60 %>% filter(!is.na(value))

Patient_Stocks_m60 <- Patient_Stocks_m60 %>% mutate(value = ifelse(value > 7, "More than 7", "Less than 7"))
Patient_Stocks_m60 <- Patient_Stocks_m60 %>% mutate(value = ifelse(value == "More than 7", "More7", "Less7"))

data.frame(Patient_Stocks_m60 %>% group_by(s2, value, flows) %>% summarise(total = sum(as.numeric(weight)))) %>%
  spread(key=s2, value=total)


## # # # # # # 
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2, flow)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1 = as.numeric(p1)) %>% filter(p1>=48)

Patient_Stocks_m60 <- DIA_Flows_Aux._Long %>% filter(p2 == "60") %>% select(patient, weight, s2)
Patient_flows_12m <- DIA_Flows_Aux._Long %>% group_by(patient) %>% summarise(flows = sum(as.numeric(flow)))
Patient_Stocks_m60 <- Patient_Stocks_m60 %>% left_join(Patient_flows_12m)


Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(test=="HbA1c Level")
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% filter(!is.na(Exact_Month)) 

Last_read <- DANU_Measures_HbA1c %>% group_by(patid) %>% slice(n())
Last_read <- Last_read %>% select(patid, Exact_Month, value)

Patient_Stocks_m60 <- Patient_Stocks_m60 %>% left_join(Last_read, by=c("patient"="patid"))
Patient_Stocks_m60 <- Patient_Stocks_m60 %>% filter(!is.na(value))


Patient_Stocks_m60 <- Patient_Stocks_m60 %>% mutate(flows = ifelse(flows == 0, "NONE", 
                                                                   ifelse(flows ==1, "1", "+2")))

Patient_Stocks_m60 <- Patient_Stocks_m60 %>% mutate(value = ifelse(value > 8, ">8",
                                                                   ifelse(value >7 & value <=8, "7_to_8",
                                                                          ifelse(value >6 & value <=7, "6_to_7", "<6"))))

Patient_Stocks_m60 <- Patient_Stocks_m60 %>% mutate(s2 = ifelse(s2 == "d" | s2 == "b", "Early_Therapies", s2))

data.frame(Patient_Stocks_m60 %>% group_by(s2, flows, value) %>% summarise(n=sum(as.numeric(weight))) %>% arrange(flows)) %>%
  spread(key=s2, value=n)




###
DIA_Flows_Aux._Long <- read.table("DIA_Flows_Aux._Long_v2.1.txt", header = T, sep=",", colClasses = "character", stringsAsFactors = FALSE)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, d1, d2, s1, s2, flow)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p1 = as.numeric(p1)) %>% filter(p1>=48)

# STOCK m60
Patient_Stocks_m60 <- DIA_Flows_Aux._Long %>% filter(p2 == "60") %>% select(patient, weight, s2)
# FLOWS Last 12m
Patient_flows_12m <- DIA_Flows_Aux._Long %>% group_by(patient, weight) %>% summarise(flows = sum(as.numeric(flow)))
# STOCK vs Flows
PatientStocksFlows <- Patient_Stocks_m60 %>% left_join(Patient_flows_12m)

PatientStocksFlows <- PatientStocksFlows %>% mutate(flows = ifelse(flows == 0, "NONE", 
                                                                   ifelse(flows ==1, "1", "+2")))

PatientStocksFlows <- PatientStocksFlows %>% mutate(s2 = ifelse(s2 == "d" | s2 == "b", "Early_Therapies", s2))

data.frame(PatientStocksFlows %>% group_by(s2, flows) %>% summarise(n=sum(as.numeric(weight))) %>% arrange(flows))


# ----------
# Characterize the profile of starts vs no starts, persist vs no persist INJECTABLE -------------

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

# Filter for pats that did not have GLP1 Inj up until Month 48
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==48&p1_InjExp==0) %>% 
  select(patient) %>% distinct() %>% left_join(Cum_Class_Experience_EveryMonth)

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

# How ling they were on it (after month 48 since naive until then)
DurationsGLP1Exp <- Cum_Class_Experience_EveryMonth %>% select(patient) %>% distinct() %>% left_join(DIA_Flows_Aux._Long) %>% 
  group_by(patient) %>% summarise(DurationGLP1Exp=cumsum(s2=="G"))

DurationsGLP1Exp <- DurationsGLP1Exp %>% group_by(patient) %>% filter(DurationGLP1Exp==max(DurationGLP1Exp)) %>% slice(1)

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% left_join(DurationsGLP1Exp)

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_HbA1c, MAX_BMI, MAX_AST, MAX_ALT))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Physicians_Experience <- fread("Physicians_Experience.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Physicians_Experience)



Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_InjExp==0, "No_GLP1", 
                                                                   ifelse(p1_InjExp==1&DurationGLP1Exp>=9,"GLP1_Persist", 
                                                                          ifelse(p1_InjExp==1&DurationGLP1Exp<=3,"GLP1_NotPersist", "Intermediate"))))


Temp <- Dems_Labs_TreatExp %>% filter(Group=="GLP1_Persist"|Group=="No_GLP1")

Temp$Group <- as.factor(Temp$Group)

Temp$Group <- relevel(Temp$Group,"No_GLP1")

eirm(formula = "Group ~ -1 + MAX_HbA1c  + ENDOCRINOLOGY + diagnosis + (1|patient)", data = Temp)

Temp <- Temp %>% select(-c(p1_InjExp, DurationGLP1Exp))

Temp <- Temp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Temp <- Temp %>% mutate(gender = ifelse(gender=="M", 1, 0))

Temp <- Temp %>% select(-patient)

Temp %>% group_by(Group) %>% count()

Temp <- Temp %>% group_by(Group) %>% sample_n(4050)
Temp <- Temp %>% ungroup()



create_train_test <- function(data, size = 0.8, train = TRUE) {
  n_row = nrow(data)
  total_row = size * n_row
  train_sample <- 1: total_row
  if (train == TRUE) {
    return (data[train_sample, ])
  } else {
    return (data[-train_sample, ])
  }
}

Temp <- Temp[sample(1:nrow(Temp)), ]

Temp <- Temp %>% select(c(Group, diagnosis, Lines,cumflow, Diff_Drugs_exp,  p1_SGLT2Exp, p1_DPP4Exp, p1_OralExp,
                          ENDOCRINOLOGY, `INTERNAL MEDICINE`, PCP, MAX_AST, MAX_ALT))

Temp <- Temp %>% mutate(Ratio=MAX_AST/MAX_ALT) %>% select(-c(MAX_AST, MAX_ALT))


data_train <- create_train_test(Temp, 0.8, train = TRUE)
data_test <- create_train_test(Temp, 0.8, train = FALSE)

Risk_pred_model <- glm( Group ~ ., data = data_train, family = binomial)

summary(Risk_pred_model)





Odd_ratios_GLP1_noGLP1_AllPats <- fread("Odd_ratios_GLP1_noGLP1_AllPats.txt", sep="\t")

Odd_ratios_GLP1_noGLP1_AllPats$Predictor <- as.factor(Odd_ratios_GLP1_noGLP1_AllPats$Predictor)

Odd_ratios_GLP1_noGLP1_AllPats <- Odd_ratios_GLP1_noGLP1_AllPats %>% arrange(`Odd ratio`)

Odd_ratios_GLP1_noGLP1_AllPats %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_minimal() +
  scale_y_continuous(trans='log10')+
  theme(legend.position = "none",) +
  geom_hline(yintercept=1, linetype='dashed', color='firebrick', size=1) +
  xlab("Predictor \n") +
  #ylim(0.5,1.5)+
  ylab("\n Log10 Odd ratio (Lower-Upper ends)")







ggplot(Temp, aes(x = Group, fill = as.factor(p1_SGLT2Exp))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "SGLT2 Experience")+
  scale_fill_viridis_d()


ggplot(Temp, aes(x = Group, fill = as.factor(p1_DPP4Exp))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "DPP4 Experience")+
  scale_fill_viridis_d()


ggplot(Temp, aes(x = Group, fill = as.factor(gender))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Gender (M)")+
  scale_fill_viridis_d()


ggplot(Temp, aes(x = Group, fill = as.factor(`INTERNAL MEDICINE`))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Internal Medicine Experience")+
  scale_fill_viridis_d()


ggplot(Temp, aes(x = Group, fill = as.factor(ENDOCRINOLOGY))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Endocrinology Experience")+
  scale_fill_viridis_d()


ggplot(Temp, aes(x = Group, fill = as.factor(diagnosis ))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Obesity Comorb")+
  scale_fill_viridis_d()


Temp %>% filter(Diff_Drugs_exp<40) %>% ggplot(aes(x = Diff_Drugs_exp, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Different Molecules") + ylab("GLP1 Injectable Experience \n")

Temp %>% group_by(Group) %>% summarise(n=mean(Diff_Drugs_exp))


Temp %>% filter(MAX_BMI<60&MAX_BMI>20) %>% ggplot(aes(x = MAX_BMI, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n BMI") + ylab("GLP1 Injectable Experience \n")

Temp %>% group_by(Group) %>% summarise(n=mean(MAX_BMI))


Temp  %>% ggplot(aes(x = age, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Age") + ylab("GLP1 Injectable Experience \n")

Temp %>% group_by(Group) %>% summarise(n=mean(age))



Temp %>% filter(Lines<15) %>% ggplot(aes(x = Lines, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Terapy Lines") + ylab("GLP1 Injectable Experience \n")

Temp %>% group_by(Group) %>% summarise(n=mean(Lines))


Temp %>% filter(cumflow<30) %>% ggplot(aes(x = cumflow, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Flows") + ylab("GLP1 Injectable Experience \n")

Temp %>% group_by(Group) %>% summarise(n=mean(cumflow))
















Odd_ratios_GLP1Persist_noPersist_AllPats <- fread("Odd_ratios_GLP1Persist_noPersist_AllPats.txt", sep="\t")

Odd_ratios_GLP1Persist_noPersist_AllPats$Predictor <- as.factor(Odd_ratios_GLP1Persist_noPersist_AllPats$Predictor)

Odd_ratios_GLP1Persist_noPersist_AllPats <- Odd_ratios_GLP1Persist_noPersist_AllPats %>% arrange(`Odd ratio`)

Odd_ratios_GLP1Persist_noPersist_AllPats %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="brown3", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=3 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deeppink4", size=3 ) +
  coord_flip()+
  theme_minimal() +
  scale_y_continuous(trans='log10')+
  theme(legend.position = "none",) +
  geom_hline(yintercept=1, linetype='dashed', color='firebrick', size=1) +
  xlab("Predictor \n") +
  #ylim(0.5,1.5)+
  ylab("\n Log10 Odd ratio (Lower-Upper ends)")






ggplot(Temp, aes(x = Group, fill = as.factor(p1_SGLT2Exp))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "SGLT2 Experience")+
  scale_fill_viridis_d()


ggplot(Temp, aes(x = Group, fill = as.factor(p1_DPP4Exp))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "DPP4 Experience")+
  scale_fill_viridis_d()


ggplot(Temp, aes(x = Group, fill = as.factor(p1_OralExp))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Oral GLP1 Experience")+
  scale_fill_viridis_d()





ggplot(Temp, aes(x = Group, fill = as.factor(`INTERNAL MEDICINE`))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Internal Medicine Experience")+
  scale_fill_viridis_d()


ggplot(Temp, aes(x = Group, fill = as.factor(PCP))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "PCP Experience")+
  scale_fill_viridis_d()


ggplot(Temp, aes(x = Group, fill = as.factor(diagnosis ))) +
  geom_bar(position = "fill", alpha=0.8, show.legend = F) +
  theme_minimal()+
  xlab("\n Injectable GLP1 Experience")+ylab("Proportion \n")+
  labs(title = "Obesity Comorb")+
  scale_fill_viridis_d()


Temp %>% filter(Diff_Drugs_exp<40) %>% ggplot(aes(x = Diff_Drugs_exp, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Different Molecules") + ylab("GLP1 Injectable Experience \n")

Temp %>% group_by(Group) %>% summarise(n=mean(Diff_Drugs_exp))


Temp %>% filter(Lines<15) %>% ggplot(aes(x = Lines, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Terapy Lines") + ylab("GLP1 Injectable Experience \n")

Temp %>% group_by(Group) %>% summarise(n=mean(Lines))


Temp %>% filter(cumflow<30) %>% ggplot(aes(x = cumflow, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n Total Number of Flows") + ylab("GLP1 Injectable Experience \n")

Temp %>% group_by(Group) %>% summarise(n=mean(cumflow))



Temp %>% filter(Ratio<2) %>% ggplot(aes(x = Ratio, y = Group, fill = 0.5 - abs(0.5 - stat(ecdf)))) + 
  geom_density_ridges_gradient( scale = 2,  calc_ecdf = TRUE) +
  scale_fill_viridis_c(name = "Tail Probability", option = "D", direction = -1)  +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  xlab("\n AST/ALT ratio") + ylab("GLP1 Injectable Experience \n")

Temp %>% group_by(Group) %>% summarise(n=mean(Ratio))




# ---------------

# Characterize the profile of Oral GLP1 based on departure stock  -------------

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

# Filter for pats that did not have GLP1 Oral up until Month 48
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==48&p1_OralExp==0) %>% 
  select(patient) %>% distinct() %>% left_join(Cum_Class_Experience_EveryMonth)

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

# How long they were on it (after month 48 since naive until then)
DurationsGLP1Exp <- Cum_Class_Experience_EveryMonth %>% select(patient) %>% distinct() %>% left_join(DIA_Flows_Aux._Long) %>% 
  group_by(patient) %>% summarise(DurationGLP1Exp=cumsum(grepl("47",d2)))

DurationsGLP1Exp <- DurationsGLP1Exp %>% group_by(patient) %>% filter(DurationGLP1Exp==max(DurationGLP1Exp)) %>% slice(1)

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% left_join(DurationsGLP1Exp)

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_HbA1c, MAX_BMI, MAX_AST, MAX_ALT))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Physicians_Experience <- fread("Physicians_Experience.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Physicians_Experience)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_OralExp ==0, "No_GLP1", "GLP1"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)
Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_GLP1")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))


DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(flow==1) %>% filter(p1>=48) %>% filter(!grepl("47",d1) & grepl("47",d2)) 

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, s1) %>% distinct()

temp <- Dems_Labs_TreatExp %>% filter(Group == "GLP1") %>% left_join(DIA_Flows_Aux._Long)

LiverKidneyHeart_Diseases_Pen <- fread("LiverKidneyHeartFailureonly_Diseases_Pen.txt", sep="\t")

temp <- temp %>% left_join(LiverKidneyHeart_Diseases_Pen, by=c("patient"="patid"))

temp[is.na(temp)] <- 0

names(temp)

temp <- temp %>% select(-Group)
temp <- temp %>% group_by(patient) %>% summarize(across(everything(), max))


describeBy(temp$age, group=temp$s1) # 
describeBy(temp$gender, group=temp$s1) # 
describeBy(temp$diagnosis, group=temp$s1) # 
describeBy(temp$MAX_HbA1c, group=temp$s1) # 
describeBy(temp$MAX_BMI, group=temp$s1) # 
describeBy(temp$MAX_AST, group=temp$s1) # 
describeBy(temp$MAX_ALT, group=temp$s1) # 
describeBy(temp$cumflow, group=temp$s1) # 
describeBy(temp$Lines, group=temp$s1) # 
describeBy(temp$Diff_Drugs_exp, group=temp$s1) # 
describeBy(temp$LiverDisease, group=temp$s1) # 
describeBy(temp$KidneyDisease, group=temp$s1) # 
describeBy(temp$HeartDisease, group=temp$s1) # 



# Compare with overall cohort


Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_HbA1c, MAX_BMI, MAX_AST, MAX_ALT))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Physicians_Experience <- fread("Physicians_Experience.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Physicians_Experience)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(p2==60) 
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, s2) %>% distinct()

temp <- Dems_Labs_TreatExp %>% left_join(DIA_Flows_Aux._Long)


LiverKidneyHeart_Diseases_Pen <- fread("LiverKidneyHeartFailureonly_Diseases_Pen.txt", sep="\t")

temp <- temp %>% left_join(LiverKidneyHeart_Diseases_Pen, by=c("patient"="patid"))

temp[is.na(temp)] <- 0

names(temp)

temp <- temp %>% group_by(patient) %>% summarize(across(everything(), max))

describeBy(temp$age, group=temp$s2) # 
describeBy(temp$gender, group=temp$s2) # 
describeBy(temp$diagnosis, group=temp$s2) # 
describeBy(temp$MAX_HbA1c, group=temp$s2) # 
describeBy(temp$MAX_BMI, group=temp$s2) # 
describeBy(temp$MAX_AST, group=temp$s2) # 
describeBy(temp$MAX_ALT, group=temp$s2) # 
describeBy(temp$cumflow, group=temp$s2) # 
describeBy(temp$Lines, group=temp$s2) # 
describeBy(temp$Diff_Drugs_exp, group=temp$s2) # 
describeBy(temp$LiverDisease, group=temp$s2) # 
describeBy(temp$KidneyDisease, group=temp$s2) # 
describeBy(temp$HeartDisease, group=temp$s2) # 


temp <- temp %>% select(patient, age, MAX_HbA1c, MAX_BMI, cumflow, Lines, Diff_Drugs_exp, s2)

temp %>% distinct()
temp <- temp %>% group_by(patient) %>% summarize(across(everything(), max))

temp %>% ungroup() %>% group_by(s2) %>% count()



temp %>% mutate(To_keep = ifelse(s2=="x"&age<=56.47&MAX_HbA1c>=8.08&MAX_BMI>=38.74&cumflow>=7.21&Lines>=3.88&Diff_Drugs_exp>=6.34,"Yes",
                                 ifelse(s2=="b"&age<=57.02&MAX_HbA1c>=8.32&MAX_BMI>=38.81&cumflow>=6.25&Lines>=3.77&Diff_Drugs_exp>=6.99,"Yes",
                                        ifelse(s2=="d"&age<=61.57&MAX_HbA1c>=9.51&MAX_BMI>=37.62&cumflow>=8.5&Lines>=5.45&Diff_Drugs_exp>=13.89,"Yes",
                                               ifelse(s2=="D"&age<=62.88&MAX_HbA1c>=9.3&MAX_BMI>=35.07&cumflow>=8.6&Lines>=5.8&Diff_Drugs_exp>=16.29,"Yes",
                                                      ifelse(s2=="S"&age<=59.24&MAX_HbA1c>=9.15&MAX_BMI>=36.21&cumflow>=9.4&Lines>=6.54&Diff_Drugs_exp>=17.94,"Yes",
                                                             ifelse(s2=="I"&age<=60.04&MAX_HbA1c>=10.37&MAX_BMI>=40.89&cumflow>=14.12&Lines>=9.31&Diff_Drugs_exp>=28.51,"Yes",
                                                                    ifelse(s2=="G"&age<=59.62&MAX_HbA1c>=9.52&MAX_BMI>=38.04&cumflow>=11.19&Lines>=8.12&Diff_Drugs_exp>=29.34,"Yes","No")))))))) %>%
  group_by(s2, To_keep) %>% count()

# -------
# Predict how many are likely to start oral GLP1 from each class ----------


# Logistic regression GLP1 Oral Exp vs No Exp

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_BMI,MAX_HbA1c ))

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_OralExp==1, "GLP1_Exp", "No_GLP1"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_GLP1")


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_OralExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))


temp <- Dems_Labs_TreatExp
Dems_Labs_TreatExp<-temp
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)

Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(731)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()


create_train_test <- function(data, size = 0.8, train = TRUE) {
  n_row = nrow(data)
  total_row = size * n_row
  train_sample <- 1: total_row
  if (train == TRUE) {
    return (data[train_sample, ])
  } else {
    return (data[-train_sample, ])
  }
}



Dems_Labs_TreatExp <- Dems_Labs_TreatExp[sample(1:nrow(Dems_Labs_TreatExp)), ]

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(c(Group, age, gender, Lines, cumflow,Diff_Drugs_exp,MAX_BMI, MAX_HbA1c,p1_InjExp, p1_InsulinExp, p1_SGLT2Exp, p1_DPP4Exp, p1_AntiDiabeticExp, p1_BiguanideExp))

data_train <- create_train_test(Dems_Labs_TreatExp, 0.8, train = TRUE)
data_test <- create_train_test(Dems_Labs_TreatExp, 0.8, train = FALSE)

Risk_pred_model <- glm( Group ~ ., data = data_train, family = binomial)

summary(Risk_pred_model)







# **************
# DALEX

library(breakDown)
library(DALEX)
library(ranger)

Risk_pred_model <- glm( Group ~ ., data = data_train, family = binomial)

explainer_glm <- DALEX::explain(Risk_pred_model,
                        data = data_train,
                        y = as.numeric(data_train$Group)-1)
diag_glm <- model_diagnostics(explainer_glm)
diag_glm
plot(diag_glm)

plot(variable_importance(explainer_glm,  loss_function = loss_root_mean_square))

new_pred <- Dems_Labs_TreatExp[3,]
new_pred$Group <- as.numeric(new_pred$Group)-1
new_pred_glm <- predict_parts_break_down(explainer_glm, new_observation  = new_pred)

head(new_pred_glm)
plot(new_pred_glm)


data_train$Group <- as.numeric(data_train$Group)-1

model_ranger <- randomForest::randomForest(Group ~ .,
                       data = data_train, num.trees = 50)

explainer_ranger <- explain(model_ranger,
                            data = data_train,
                            y =  data_train$Group,
                            label = "model_ranger")

bd_ranger <- predict_parts_break_down(explainer_ranger, new_observation = new_pred)
head(bd_ranger)
plot(bd_ranger)

# *******************


predict <- predict(model_ranger, data_test), type = 'response')

table_mat <- table(data_test$Group, predict > 0.50)
table_mat

plot(table_mat)

accuracy_Test <- sum(diag(table_mat)) / sum(table_mat)
accuracy_Test


precision <- function(matrix) {
  # True positive
  tp <- matrix[2, 2]
  # false positive
  fp <- matrix[1, 2]
  return (tp / (tp + fp))
}



recall <- function(matrix) {
  # true positive
  tp <- matrix[2, 2]# false positive
  fn <- matrix[2, 1]
  return (tp / (tp + fn))
}


prec <- precision(table_mat)
prec # 0.7876712

rec <- recall(table_mat)
rec # 0.7931034

f1 <- 2 * ((prec * rec) / (prec + rec))
f1 # 0.790378


# predict(Risk_pred_model, new_pred, type = 'response')

pred <- data.frame(predict(model_ranger, temp) %>% bind_cols(temp)

names(pred)[1] <- "Probability"

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Stocksm60 <- DIA_Flows_Aux._Long %>% filter(p2 == 60) %>% select(patient, s2)

pred <- pred %>% left_join(Stocksm60)


pred %>% select(c(Probability, s2)) %>% mutate(RiskLevel = ifelse(Probability>0.75, "HighRisk", "LowRisk")) %>%
  group_by(s2,RiskLevel) %>% count()





# --------------
# Distribution of COMBOS GLPs Contents DRUG GROUP ---------------------------------------------------------------------

DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", 
                                       header = T, sep="\t", 
                                       colClasses = "character", stringsAsFactors = FALSE)


DIA_Drug_Histories <- DIA_Drug_Histories %>%  select(patient, weight, month60)

DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, month60, sep = ",", convert=T )

Patients_GLP1 <- DIA_Drug_Histories %>%
  group_by(patient) %>%
  filter(month60 == "47" | month60=="48" | month60=="49" | month60=="50"  | month60=="51" |
           month60=="52" | month60=="53") 

length(unique(Patients_GLP1$patient)) #20926 total GLPs

Patients_GLP1_ORAL <- Patients_GLP1  %>% filter(month60 == "47") %>% select(patient) %>% distinct()

Patients_GLP1_INJECT <- Patients_GLP1  %>% 
  filter(month60=="48" | month60=="49" | month60=="50"  | month60=="51" | month60=="52" | month60=="53") %>% select(patient) %>% distinct()

DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", 
                                 header = T, sep="\t", 
                                 colClasses = "character", stringsAsFactors = FALSE)

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight, month60)

Patients_GLP1_ORAL <- Patients_GLP1_ORAL %>% left_join(DIA_Drug_Histories)
Patients_GLP1_INJECT <- Patients_GLP1_INJECT %>% left_join(DIA_Drug_Histories)


# Constitution of concomitant drug therapy among ORAL GLP1 patients 
Patients_GLP1_ORAL_combos <- Patients_GLP1_ORAL %>% ungroup() %>% filter(grepl(",",month60))

# IMPORT DICTIONARY WITH LABELS FOR MOLECULE, DRUG GROUP, AND INDICATION
DANU_Ingredients <- read.table("DANU Ingredients.txt", 
                                     header = T, sep="\t", quote="", 
                                     colClasses = "character", stringsAsFactors = FALSE)

# SEPERATE THE INGREDIENTS X:Y INTO 2 COLUMNS CONTAINING EACH ELEMENT/ DEGREE OF ABSTRACTION
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

Patients_GLP1_ORAL_combos <- separate_rows(Patients_GLP1_ORAL_combos, month60, sep = ",", convert=T )

names(Patients_GLP1_ORAL_combos)[3] <- "molecule"

Patients_GLP1_ORAL_combos$molecule <- as.character(Patients_GLP1_ORAL_combos$molecule)

Patients_GLP1_ORAL_combos <- Patients_GLP1_ORAL_combos %>% left_join(DANU_Ingredients %>% select(molecule, generic_name, drug_group))

Patients_GLP1_ORAL_combos <- Patients_GLP1_ORAL_combos %>%  select(patient, weight, drug_group)

Patients_GLP1_ORAL_combos <- Patients_GLP1_ORAL_combos %>% distinct()

Patients_GLP1_ORAL_combos <- Patients_GLP1_ORAL_combos %>% group_by(patient) %>% arrange(drug_group)

Combos_weights <- Patients_GLP1_ORAL_combos %>% select(patient, weight)

Combos_weights <- Combos_weights %>% distinct()

Patients_GLP1_ORAL_combos <- Patients_GLP1_ORAL_combos %>% group_by(patient) %>% summarise(drug_groups = toString(drug_group))

Patients_GLP1_ORAL_combos <- Patients_GLP1_ORAL_combos %>% left_join(Combos_weights)

Patients_GLP1_ORAL_combos_DRUG_GROUPS <- data.frame(Patients_GLP1_ORAL_combos %>% group_by(drug_groups) %>% summarise(n = sum(as.numeric(weight))) %>% arrange(n))
write.csv(Patients_GLP1_ORAL_combos_DRUG_GROUPS, "Patients_GLP1_ORAL_combos_DRUG_GROUPS.csv")



Patients_GLP1_ORAL_combos %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 109009


Patients_GLP1_ORAL_combos %>% filter(grepl("Biguanide", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 80269

Patients_GLP1_ORAL_combos %>% filter(grepl("Antidiabetic", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 32904

Patients_GLP1_ORAL_combos %>% filter(grepl("DPP4", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 13659

Patients_GLP1_ORAL_combos %>% filter(grepl("SGLT2", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 37903

Patients_GLP1_ORAL_combos %>% filter(grepl("GLP1 Injectable", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 4217

Patients_GLP1_ORAL_combos %>% filter(grepl("Insulin", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 22533



Patients_GLP1_ORAL_combos %>% group_by(drug_groups) %>% summarise(n = sum(as.numeric(weight))) %>% arrange(n) %>%
  mutate(drug_groups= as.factor(drug_groups)) %>%
  ggplot(aes(x=n, y=reorder(drug_groups,n))) +
  geom_bar(stat="identity", alpha = 0.7, show.legend = FALSE, fill="firebrick" )+
  xlab("\nProjected Population") + ylab("Drug Group Combinations\n")+
  ggtitle("Constitution of concomitant drug therapy among ORAL GLP1 patients")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())



# Constitution of concomitant drug therapy among INJECTABLE GLP1 patients
Patients_GLP1_INJECT_combos <- Patients_GLP1_INJECT %>% ungroup() %>% filter(grepl(",",month60))

# IMPORT DICTIONARY WITH LABELS FOR MOLECULE, DRUG GROUP, AND INDICATION
DANU_Ingredients <- read.table("DANU Ingredients.txt", 
                               header = T, sep="\t", quote="", 
                               colClasses = "character", stringsAsFactors = FALSE)

# SEPERATE THE INGREDIENTS X:Y INTO 2 COLUMNS CONTAINING EACH ELEMENT/ DEGREE OF ABSTRACTION
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

Patients_GLP1_INJECT_combos <- separate_rows(Patients_GLP1_INJECT_combos, month60, sep = ",", convert=T )

names(Patients_GLP1_INJECT_combos)[3] <- "molecule"

Patients_GLP1_INJECT_combos$molecule <- as.character(Patients_GLP1_INJECT_combos$molecule)

Patients_GLP1_INJECT_combos <- Patients_GLP1_INJECT_combos %>% left_join(DANU_Ingredients %>% select(molecule, generic_name, drug_group))

Patients_GLP1_INJECT_combos <- Patients_GLP1_INJECT_combos %>%  select(patient, weight, drug_group)

Patients_GLP1_INJECT_combos <- Patients_GLP1_INJECT_combos %>% distinct()

Patients_GLP1_INJECT_combos <- Patients_GLP1_INJECT_combos %>% group_by(patient) %>% arrange(drug_group)

Combos_weights <- Patients_GLP1_INJECT_combos %>% select(patient, weight)

Combos_weights <- Combos_weights %>% distinct()

Patients_GLP1_INJECT_combos <- Patients_GLP1_INJECT_combos %>% group_by(patient) %>% summarise(drug_groups = toString(drug_group))

Patients_GLP1_INJECT_combos <- Patients_GLP1_INJECT_combos %>% left_join(Combos_weights)

Patients_GLP1_INJECT_combos_DRUG_GROUPS <- data.frame(Patients_GLP1_INJECT_combos %>% group_by(drug_groups) %>% summarise(n = sum(as.numeric(weight))) %>% arrange(n))
write.csv(Patients_GLP1_INJECT_combos_DRUG_GROUPS, "Patients_GLP1_INJECT_combos_DRUG_GROUPS.csv")



Patients_GLP1_INJECT_combos %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 2137881


Patients_GLP1_INJECT_combos %>% filter(grepl("Biguanide", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 1451897

Patients_GLP1_INJECT_combos %>% filter(grepl("Antidiabetic", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 608623

Patients_GLP1_INJECT_combos %>% filter(grepl("DPP4", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 157520

Patients_GLP1_INJECT_combos %>% filter(grepl("SGLT2", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 644480

Patients_GLP1_INJECT_combos %>% filter(grepl("GLP1 Oral", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 4217

Patients_GLP1_INJECT_combos %>% filter(grepl("Insulin", drug_groups)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(as.numeric(weight))) # 1018231




Patients_GLP1_INJECT_combos %>% group_by(drug_groups) %>% summarise(n = sum(as.numeric(weight))) %>% arrange(n) %>%
  mutate(drug_groups= as.factor(drug_groups)) %>%
  filter(n>1000)%>%
  ggplot(aes(x=n, y=reorder(drug_groups,n))) +
  geom_bar(stat="identity", alpha = 0.7, show.legend = FALSE, fill="midnightblue")+
  xlab("\nProjected Population") + ylab("Drug Group Combinations\n")+
  ggtitle("Constitution of concomitant drug therapy among INJECTABLE GLP1 patients", subtitle = "n>1000")+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())


# -----
# Predict how many are likely to start oral GLP1 from each class COMPARE MODELS ----------
# Logistic regression GLP1 Oral Exp vs No Exp

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_BMI,MAX_HbA1c ))

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_OralExp==1, "GLP1_Exp", "No_GLP1"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_GLP1")


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_OralExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))


temp <- Dems_Labs_TreatExp
Dems_Labs_TreatExp<-temp
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)


Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(731)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()

Dems_Labs_TreatExp$Group <- as.numeric(Dems_Labs_TreatExp$Group)-1


library("randomForest")
GLP1_rf <- randomForest(Group ~ . , data = Dems_Labs_TreatExp)
summary(GLP1_rf)

library("gbm")
GLP1_gbm <- gbm(Group == 1 ~ ., data = Dems_Labs_TreatExp, 
                n.trees = 15000, distribution = "bernoulli")

library("rms")
GLP1_lmr <- lrm(Group == 1 ~ age+gender+diagnosis+MAX_BMI+MAX_HbA1c+p1_InjExp+p1_InsulinExp+
                  p1_SGLT2Exp+p1_DPP4Exp+p1_AntiDiabeticExp+p1_BiguanideExp+cumflow+
                  Lines+Diff_Drugs_exp, data = Dems_Labs_TreatExp)




library(breakDown)
library(DALEX)
explainer_rf <- DALEX::explain(GLP1_rf,
                               data = Dems_Labs_TreatExp,
                               y = Dems_Labs_TreatExp$Group )
diag_rf <- model_diagnostics(explainer_rf)
diag_rf
plot(diag_rf)

plot(variable_importance(explainer_rf,  loss_function = loss_root_mean_square))

new_pred <- Dems_Labs_TreatExp[991,]
new_pred_rf <- predict_parts_break_down(explainer_rf, new_observation  = new_pred)

head(new_pred_rf)
plot(new_pred_rf)





explainer_gbm <- DALEX::explain(GLP1_gbm,
                                data = Dems_Labs_TreatExp,
                                y = Dems_Labs_TreatExp$Group )
diag_gbm <- model_diagnostics(explainer_gbm)
diag_gbm
plot(diag_gbm)

plot(variable_importance(explainer_gbm,  loss_function = loss_root_mean_square))

new_pred <- Dems_Labs_TreatExp[991,]
new_pred_gbm <- predict_parts_break_down(explainer_gbm, new_observation  = new_pred)

head(new_pred_gbm)
plot(new_pred_gbm)






explainer_lmr <- DALEX::explain(GLP1_lmr,
                                data = Dems_Labs_TreatExp[,-15],
                                y = Dems_Labs_TreatExp$Group )
diag_lmr <- model_diagnostics(explainer_lmr)
diag_lmr
plot(diag_lmr)

plot(variable_importance(explainer_lmr,  loss_function = loss_root_mean_square))

new_pred <- Dems_Labs_TreatExp[991,]
new_pred_glm <- predict_parts_break_down(explainer_lmr, new_observation  = new_pred)

head(new_pred_glm)
plot(new_pred_glm)










temp$Group <- as.numeric(temp$Group)-1

pred <- data.frame(predict(GLP1_rf, temp)) %>% bind_cols(temp)

names(pred)[1] <- "Probability"

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Stocksm60 <- DIA_Flows_Aux._Long %>% filter(p2 == 60) %>% select(patient, s2)

pred <- pred %>% left_join(Stocksm60)

pred %>% select(c(Probability, s2)) %>% mutate(RiskLevel = ifelse(Probability>0.75, "HighRisk", "LowRisk")) %>%
  group_by(s2,RiskLevel) %>% count()

pred <- data.frame(predict(GLP1_gbm, temp, type = "response")) %>% bind_cols(temp)

names(pred)[1] <- "Probability"

pred <- pred %>% filter(Probability>0.75)
pred <- pred %>% filter(Group=="GLP1_Exp")

fwrite(pred, "High_Risk_GLP1_Oral.txt")

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Stocksm60 <- DIA_Flows_Aux._Long %>% filter(p2 == 60) %>% select(patient, s2)

pred <- pred %>% left_join(Stocksm60)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

pred %>% inner_join(Treatment_exp_Vector) %>% select(c(Probability, s2)) %>% mutate(RiskLevel = ifelse(Probability>0.75, "HighRisk", "LowRisk")) %>%
  group_by(s2,RiskLevel) %>% count()

pred <- data.frame(predict(GLP1_lmr, temp)) %>% bind_cols(temp)

names(pred)[1] <- "Probability"

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Stocksm60 <- DIA_Flows_Aux._Long %>% filter(p2 == 60) %>% select(patient, s2)

pred <- pred %>% left_join(Stocksm60)

pred %>% select(c(Probability, s2)) %>% mutate(RiskLevel = ifelse(Probability>0.75, "HighRisk", "LowRisk")) %>%
  group_by(s2,RiskLevel) %>% count()




# ------------
# Predict how many are likely to start Injectable GLP1 from each class COMPARE MODELS ----------
# Logistic regression GLP1 Injectable Exp vs No Exp

MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_BMI,MAX_HbA1c ))

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_InjExp==1, "GLP1_Exp", "No_GLP1"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_GLP1")


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_InjExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))


temp <- Dems_Labs_TreatExp
Dems_Labs_TreatExp<-temp
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)


Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(16327)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()

Dems_Labs_TreatExp$Group <- as.numeric(Dems_Labs_TreatExp$Group)-1


library("randomForest")
GLP1_rf <- randomForest(Group ~ . , data = Dems_Labs_TreatExp)
summary(GLP1_rf)

library("gbm")
GLP1_gbm <- gbm(Group == 1 ~ ., data = Dems_Labs_TreatExp, 
                n.trees = 15000, distribution = "bernoulli")
summary(GLP1_gbm)

library("rms")
GLP1_lmr <- lrm(Group == 1 ~ age+gender+diagnosis+MAX_BMI+MAX_HbA1c+p1_OralExp+p1_InsulinExp+
                  p1_SGLT2Exp+p1_DPP4Exp+p1_AntiDiabeticExp+p1_BiguanideExp+cumflow+
                  Lines+Diff_Drugs_exp, data = Dems_Labs_TreatExp)
summary(GLP1_lmr)




library(breakDown)
library(DALEX)
explainer_rf <- DALEX::explain(GLP1_rf,
                               data = Dems_Labs_TreatExp,
                               y = Dems_Labs_TreatExp$Group )
diag_rf <- model_diagnostics(explainer_rf)
diag_rf
plot(diag_rf)

plot(variable_importance(explainer_rf,  loss_function = loss_root_mean_square))

new_pred <- Dems_Labs_TreatExp[Dems_Labs_TreatExp$Diff_Drugs_exp==62&Dems_Labs_TreatExp$Lines==21&Dems_Labs_TreatExp$cumflow==22,]
new_pred_rf <- predict_parts_break_down(explainer_rf, new_observation  = new_pred)

head(new_pred_rf)
plot(new_pred_rf)





explainer_gbm <- DALEX::explain(GLP1_gbm,
                                data = Dems_Labs_TreatExp,
                                y = Dems_Labs_TreatExp$Group  )
diag_gbm <- model_diagnostics(explainer_gbm)
diag_gbm
plot(diag_gbm)

plot(variable_importance(explainer_gbm,  loss_function = loss_root_mean_square))

new_pred <- Dems_Labs_TreatExp[Dems_Labs_TreatExp$Diff_Drugs_exp==62&Dems_Labs_TreatExp$Lines==21&Dems_Labs_TreatExp$cumflow==22,]
new_pred_gbm <- predict_parts_break_down(explainer_gbm, new_observation  = new_pred)

head(new_pred_gbm)
plot(new_pred_gbm)






explainer_lmr <- DALEX::explain(GLP1_lmr,
                                data = Dems_Labs_TreatExp,
                                y = Dems_Labs_TreatExp$Group )
diag_lmr <- model_diagnostics(explainer_lmr)
diag_lmr
plot(diag_lmr)

plot(variable_importance(explainer_lmr,  loss_function = loss_root_mean_square))

new_pred <- Dems_Labs_TreatExp[50,]
new_pred_glm <- predict_parts_break_down(explainer_lmr, new_observation  = new_pred)

head(new_pred_glm)
plot(new_pred_glm)










temp$Group <- as.numeric(temp$Group)-1

pred <- data.frame(predict(GLP1_rf, temp)) %>% bind_cols(temp)

names(pred)[1] <- "Probability"

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Stocksm60 <- DIA_Flows_Aux._Long %>% filter(p2 == 60) %>% select(patient, s2)

pred <- pred %>% left_join(Stocksm60)


Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

pred %>% inner_join(Treatment_exp_Vector) %>% select(c(Probability, s2)) %>% mutate(RiskLevel = ifelse(Probability>0.95, "HighRisk", "LowRisk")) %>%
  group_by(s2,RiskLevel) %>% count()


pred <- data.frame(predict(GLP1_gbm, temp)) %>% bind_cols(temp)

names(pred)[1] <- "Probability"

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Stocksm60 <- DIA_Flows_Aux._Long %>% filter(p2 == 60) %>% select(patient, s2)

pred <- pred %>% left_join(Stocksm60)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

pred %>% inner_join(Treatment_exp_Vector) %>% select(c(Probability, s2)) %>% mutate(RiskLevel = ifelse(Probability>0.95, "HighRisk", "LowRisk")) %>%
  group_by(s2,RiskLevel) %>% count()





pred <- data.frame(predict(GLP1_lmr, temp)) %>% bind_cols(temp)

names(pred)[1] <- "Probability"

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Stocksm60 <- DIA_Flows_Aux._Long %>% filter(p2 == 60) %>% select(patient, s2)

pred <- pred %>% left_join(Stocksm60)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

pred %>% inner_join(Treatment_exp_Vector) %>% select(c(Probability, s2)) %>% mutate(RiskLevel = ifelse(Probability>0.95, "HighRisk", "LowRisk")) %>%
  group_by(s2,RiskLevel) %>% count()

# -----
# Molecule Penetrance  Month 60 -------------------------------------------------------------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight, month60)

# all pats
DIA_Drug_Histories %>% summarise(sum_weights = sum(as.numeric(weight))) # 48244424
# sum of weights of the treated ones at m60 9590919 
DIA_Drug_Histories %>% filter(month60 != "-") %>% summarise(sum_weights = sum(as.numeric(weight))) # 17735052
# sum of weights of the non-treated ones 9452149
DIA_Drug_Histories %>% filter(month60 == "-") %>% summarise(sum_weights = sum(as.numeric(weight))) # 30509372

DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, month60, sep = ",", convert=T)
names(DIA_Drug_Histories)[3] <- "molecule"


temp <- data.frame(DIA_Drug_Histories %>% 
                     filter(molecule != "-")%>%
                     group_by(molecule) %>% 
                     summarise(pats=sum(as.numeric(weight))) %>% 
                     mutate(percentage = (pats/17735052)*100) %>%
                     left_join(DANU_Ingredients %>% select(molecule, generic_name, drug_group)) %>% 
                     group_by(drug_group)%>%
                     arrange(drug_group, -percentage)) 

write.csv(temp, "Molecule_Penetrance_month60.csv")

plots <- data.frame(DIA_Drug_Histories %>% 
                      filter(molecule != "-")%>%
                      group_by(molecule) %>% 
                      summarise(pats=sum(as.numeric(weight))) %>% 
                      mutate(percentage = (pats/17735052)*100) %>%
                      left_join(DANU_Ingredients %>% select(molecule, generic_name, drug_class)) %>% 
                      group_by(drug_class)%>%
                      arrange(drug_class, -percentage)) %>% group_by(drug_class)%>%
  do(plots=ggplot(data=.) + aes(x=reorder(generic_name, -percentage), y=percentage, fill=generic_name, label=round(percentage, digits = 2)) + 
       scale_fill_viridis_d() + geom_col(show.legend = F) + ylim(0,7) +  geom_text(vjust=-1)+
       ylab("% Penetrance Month 60\n") + xlab("") + ggtitle(unique(.$drug_class)) +
       theme(panel.grid.major=element_blank(), panel.grid.minor = element_blank(),
             panel.background = element_blank(), axis.title.x=element_blank(),
             axis.text.x = element_text(angle = 45, vjust = 0.9, hjust=1)))

plots[[2]]


# -----------
# Share of GLP1 Injectable Molecules , share of flows per molecule ------------------------ 
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(patient, weight, month60)

DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, month60, sep = ",", convert=T )
names(DIA_Drug_Histories)[3] <- "molecule"
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(molecule != "-")

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients <- DANU_Ingredients %>% select(molecule, generic_name, drug_group)
DANU_Ingredients <- DANU_Ingredients %>% filter(drug_group=="GLP1 Injectable")

DIA_Drug_Histories <- DIA_Drug_Histories %>% left_join(DANU_Ingredients) %>% drop_na()

DIA_Drug_Histories %>% group_by(generic_name) %>% summarise(n=sum(weight))


# ----------
# Flows to Injectable per molecule last 12 months and last 60 months -----------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))

temp <- DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("G",s1)) %>% filter(grepl("G",s2)) 
temp <- temp %>% select(patient, weight, d2)
temp <- separate_rows(temp, d2, sep = ",", convert=T )
temp <- temp %>% filter(d2==48|d2==49|d2==50|d2==51|d2==52|d2==53)

temp %>% group_by(d2) %>% summarise(n=sum(weight))


length(unique(temp$patient)) # 14725



temp %>% group_by(d2) %>% summarise(n=sum(weight))

length(unique(temp$patient)) # 38565

# --------
# Inflows/Outflows to/from oral, by GLP1 Inj molecule -----------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))

temp <- DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(!grepl("g",s1)) %>% filter(grepl("g",s2)) 
temp <- temp %>% filter(s1 == "G")

temp <- temp %>% select(patient, weight, d1)
temp <- separate_rows(temp, d1, sep = ",", convert=T )
temp <- temp %>% filter(d1==48|d1==49|d1==50|d1==51|d1==52|d1==53)

temp %>% group_by(d1) %>% summarise(n=sum(weight))


length(unique(temp$patient)) # 123



DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, starts, stops, re_starts))

temp <- DIA_Flows_Aux._Long %>% filter(p1>=48) %>% filter(grepl("g",s1)) %>% filter(!grepl("g",s2)) 
temp <- temp %>% filter(s2 == "G")

temp <- temp %>% select(patient, weight, d2)
temp <- separate_rows(temp, d2, sep = ",", convert=T )
temp <- temp %>% filter(d2==48|d2==49|d2==50|d2==51|d2==52|d2==53)

temp %>% group_by(d2) %>% summarise(n=sum(weight))

length(unique(temp$patient)) # 88

# -----
# Waterfall, GLP1 pats, exclusive, BMI ------------------
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")
sum(Treatment_exp_Vector$weight) # 30625690


DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long     <- DIA_Flows_Aux._Long %>% filter(s1=="G"|s2=="G"|s1=="g"|s2=="g") %>% select(patient, weight) %>% distinct()
sum(DIA_Flows_Aux._Long$weight) # 5537205  GLP1 Experienced   |   25088485 GLP1 Naive

GLP1_Exp <- DIA_Flows_Aux._Long


DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- Treatment_exp_Vector %>% inner_join(GLP1_Exp) %>% inner_join(DIA_Flows_Aux._Long)
GLP1_Exp_OtherDrugs <- DIA_Flows_Aux._Long %>% filter(s1!="G"&s2!="G"&s1!="g"&s2!="g") %>% select(patient, weight) %>% distinct()
sum(GLP1_Exp_OtherDrugs$weight) # 5386581  GLP1 Experienced  with other drugs  |   150624 GLP1 only

GLP1_only <- GLP1_Exp %>% anti_join(GLP1_Exp_OtherDrugs)
sum(GLP1_only$weight) # 150624.1


# Pick patients that had *ONLY* |Biguanide| AND |GLP1|
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)


Pats_Biguanide_GLP1_only <- Pats_Biguanide_GLP1_only %>% select(patient, weight) %>% distinct()
Pats_Biguanide_GLP1_only <- Pats_Biguanide_GLP1_only %>% inner_join(GLP1_Exp)

sum(Pats_Biguanide_GLP1_only$weight) # 832561.7 # GLP1 and/or Biguanide

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- Treatment_exp_Vector %>% inner_join(GLP1_Exp) %>% inner_join(DIA_Flows_Aux._Long)

DIA_Flows_Aux._Long <- Pats_Biguanide_GLP1_only %>% select(patient) %>% distinct() %>% left_join(DIA_Flows_Aux._Long)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease, p1_RxExp, flow, stops, starts, re_starts))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(grepl(string_Biguanide,d1)|grepl(string_Biguanide,d2)) %>% 
  select(patient) %>% distinct() %>% 
  inner_join(DIA_Flows_Aux._Long %>% filter(grepl(string_InjectableGLP1,d1)|grepl(string_InjectableGLP1,d2)|grepl(string_OralGLP1,d1)|grepl(string_OralGLP1,d2))  %>% 
  select(patient) %>% distinct()) %>% left_join(DIA_Flows_Aux._Long)
  

DIA_Flows_Aux._Long %>% ungroup() %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 652626 glp1 & biguanide


DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient, weight) %>% 
  slice(if(any(grepl("G",s2)|grepl("g",s2))) 1:which.max(grepl("G",s2)|grepl("g",s2)) else row_number())   


DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient, weight) %>% slice(-n())


GLP1_Big_Pats <- DIA_Flows_Aux._Long %>% ungroup() %>% 
  filter(grepl(string_Biguanide,d1)|grepl(string_Biguanide,d2)) %>%
  select(patient, weight) %>% distinct()

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% ungroup() %>% 
  filter(grepl(string_Biguanide,d1)|grepl(string_Biguanide,d2)) %>%
  select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) 


DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)

CurrentlyONGLP1 <- DIA_Flows_Aux._Long %>% filter(p2==60 & (s2=="G"|s1=="g")) %>% select(patient, weight) %>% distinct()

GLP1_only %>% inner_join(CurrentlyONGLP1) %>% summarise(n=sum(weight)) # 147605.5
GLP1_Big_Pats %>% inner_join(CurrentlyONGLP1) %>% summarise(n=sum(weight)) # 235651

GLP1_only <- GLP1_Exp %>% anti_join(GLP1_Exp_OtherDrugs)
sum(GLP1_only$weight) # 150624.1



DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed)
DANU_Measures <- DANU_Measures %>% group_by(patid) %>% filter(value==mean(value)) %>% slice(1)
names(DANU_Measures)[1] <- "patient"

GLP1_only <- GLP1_only %>% left_join(DANU_Measures)

GLP1_only %>% drop_na() %>% summarise(n=sum(weight)) # 12299.23 with BMI

GLP1_only <- GLP1_only %>% drop_na()

GLP1_only %>% filter(value>25) %>% summarise(n=sum(weight)) # 84772.7

# --------
# How long have patients been on their current stock ? --------- 
DIA_Box_Histories <- fread("DIA Box Histories.txt")
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

DIA_Box_Histories <- Treatment_exp_Vector %>% left_join(DIA_Box_Histories)

temp <- DIA_Box_Histories[,4:63]

temp[] <- lapply(temp,function(x) str_sub(x, 2L, 2L))

DIA_Box_Histories <- DIA_Box_Histories %>% select(patient, weight) %>% bind_cols(temp)

DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Stock, month1:month60, factor_key=TRUE)

DIA_Box_Histories <- DIA_Box_Histories %>% group_by(patient) %>% mutate(grp = rle(Stock)$lengths %>% {rep(seq(length(.)), .)})

DIA_Box_Histories <- DIA_Box_Histories %>% group_by(patient) %>% filter(grp==max(grp))

DIA_Box_Histories %>% ungroup() %>% group_by(Stock) %>% summarise(N=weighted.mean(grp, weight))



DIA_Box_Histories <- fread("DIA Box Histories.txt")
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

DIA_Box_Histories <- Treatment_exp_Vector %>% left_join(DIA_Box_Histories)

# High_Risk_GLP1_Oral <- fread("High_Risk_GLP1_Oral.txt")
# DIA_Box_Histories <- High_Risk_GLP1_Oral %>% select(patient) %>% inner_join(DIA_Box_Histories)


Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p1_BiguanideExp==1) %>% select(patient)
DIA_Box_Histories <- Cum_Class_Experience_EveryMonth %>% inner_join(DIA_Box_Histories)

temp <- DIA_Box_Histories[,4:63]

temp[] <- lapply(temp,function(x) str_sub(x, 2L, 2L))

DIA_Box_Histories <- DIA_Box_Histories %>% select(patient, weight) %>% bind_cols(temp)

DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Stock, month1:month60, factor_key=TRUE)

DIA_Box_Histories <- DIA_Box_Histories %>% group_by(patient) %>% mutate(grp = rle(Stock)$lengths %>% {rep(seq(length(.)), .)})

DIA_Box_Histories <- DIA_Box_Histories %>% group_by(patient) %>% filter(grp==max(grp))

DIA_Box_Histories %>% ungroup() %>% group_by(Stock) %>% summarise(N=weighted.mean(grp, weight))



# ----------
# Dulaglutide vs Semaglutide share ----------------------

DIA_Medications <- fread("DANU Medications.txt")

DIA_Medications <- DIA_Medications %>% filter(generic_name =="Dulaglutide"|generic_name=="Semaglutide Injectable") %>% 
  select(drug_id, generic_name)

names(DIA_Medications)[2] <- "generic"

Dia_US_Doses <- fread("DIA Doses.txt")

Dia_US_Doses <- Dia_US_Doses %>% left_join(DIA_Medications) 

Dia_US_Doses <- Dia_US_Doses %>% filter(drug_group=="GLP1 Injectable")

Dia_US_Doses <- Dia_US_Doses %>% select(generic, pat_id, weight, from_dt, prov, specialty)

Dia_US_Doses$from_dt <- as.Date(Dia_US_Doses$from_dt)

Dia_US_Doses <- Dia_US_Doses %>% filter(from_dt>="2020-05-01")

Dia_US_Doses <- Dia_US_Doses %>% mutate(generic=ifelse(is.na(generic),"other", generic))

Dia_US_Doses <- Dia_US_Doses %>% drop_na()




# Year 2
Dia_US_Doses %>% filter(from_dt<"2018-05-01") %>% group_by(prov, generic_name) %>% count() %>%
  spread(key=generic_name, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(sum=sum(Dulaglutide+`Semaglutide Injectable`)) %>%
  mutate(`Semaglutide Injectable Prop`=100*`Semaglutide Injectable`/sum) %>%
  ungroup() %>% summarise(n=mean(`Semaglutide Injectable Prop`))  # 1.54


# Year 3
Dia_US_Doses %>% filter(from_dt<"2019-05-01"&from_dt>="2018-05-01") %>% group_by(prov, generic_name) %>% count() %>%
  spread(key=generic_name, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(sum=sum(Dulaglutide+`Semaglutide Injectable`)) %>%
  mutate(`Semaglutide Injectable Prop`=100*`Semaglutide Injectable`/sum) %>%
  ungroup() %>% summarise(n=mean(`Semaglutide Injectable Prop`))  # 18.4


Dia_US_Doses %>% filter(from_dt<"2019-05-01"&from_dt>="2018-05-01") %>% group_by(prov, generic_name) %>% count() %>%
  spread(key=generic_name, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(sum=sum(Dulaglutide+`Semaglutide Injectable`)) %>%
  mutate(`Semaglutide Injectable Prop`=100*`Semaglutide Injectable`/sum) %>%
  ggplot(aes(`Semaglutide Injectable Prop`))+
  geom_density(colour="firebrick",size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 10))+
  xlab("\n Share of Semaglutide Injectable (Semaglutide:Dulaglutide)")+
  ylab("Physician Proportion")


# Year 4
Dia_US_Doses %>% filter(from_dt<"2020-05-01"&from_dt>="2019-05-01") %>% group_by(prov, generic_name) %>% count() %>%
  spread(key=generic_name, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(sum=sum(Dulaglutide+`Semaglutide Injectable`)) %>%
  mutate(`Semaglutide Injectable Prop`=100*`Semaglutide Injectable`/sum) %>%
  ungroup() %>% summarise(n=mean(`Semaglutide Injectable Prop`))  # 34.6


Dia_US_Doses %>% filter(from_dt<"2020-05-01"&from_dt>="2019-05-01") %>% group_by(prov, generic_name) %>% count() %>%
  spread(key=generic_name, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(sum=sum(Dulaglutide+`Semaglutide Injectable`)) %>%
  mutate(`Semaglutide Injectable Prop`=100*`Semaglutide Injectable`/sum) %>%
  ggplot(aes(`Semaglutide Injectable Prop`))+
  geom_density(colour="firebrick",size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 10))+
  xlab("\n Share of Semaglutide Injectable (Semaglutide:Dulaglutide)")+
  ylab("Physician Proportion")




# Year 5
Dia_US_Doses %>% filter(from_dt>="2020-05-01") %>% group_by(prov, generic_name) %>% count() %>%
  spread(key=generic_name, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(sum=sum(Dulaglutide+`Semaglutide Injectable`)) %>%
  mutate(`Semaglutide Injectable Prop`=100*`Semaglutide Injectable`/sum) %>%
  ungroup() %>% summarise(n=mean(`Semaglutide Injectable Prop`)) # 41.9


Dia_US_Doses %>% filter(from_dt>="2020-05-01") %>% group_by(prov, generic_name) %>% count() %>%
  spread(key=generic_name, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(sum=sum(Dulaglutide+`Semaglutide Injectable`)) %>%
  mutate(`Semaglutide Injectable Prop`=100*`Semaglutide Injectable`/sum) %>%
  ggplot(aes(`Semaglutide Injectable Prop`))+
  geom_density(colour="firebrick",size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 10))+
  xlab("\n Share of Semaglutide Injectable (Semaglutide:Dulaglutide)")+
  ylab("Physician Proportion")



Dia_US_Doses %>% filter(from_dt>="2020-05-01") %>% group_by(prov, generic) %>% count() %>% arrange(prov) %>%
  spread(key=generic, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(other=ifelse(is.na(other),0,other)) %>%
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(sum=sum(Dulaglutide+`Semaglutide Injectable`+other)) %>%
  ungroup() %>%
  summarise(n=median(sum)) # mean 11.7  # median 7


Dia_US_Doses %>% filter(from_dt>="2020-05-01") %>% group_by(prov, generic) %>% count() %>% arrange(prov) %>%
  spread(key=generic, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(other=ifelse(is.na(other),0,other)) %>%
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(sum=sum(Dulaglutide+`Semaglutide Injectable`+other)) %>%
  ggplot(aes(sum))+
  geom_density(colour="midnightblue", size=2)+
  xlim(0,50)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 10))+
  xlab("\n Number of individual GLP1 Injectable scripts")+
  ylab("Physician Proportion \n")


temp <- Dia_US_Doses %>% filter(from_dt>="2020-05-01") %>% group_by(prov, generic) %>% count() %>% arrange(prov) %>%
  spread(key=generic, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(other=ifelse(is.na(other),0,other)) %>%
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(sum=sum(Dulaglutide+`Semaglutide Injectable`+other)) %>%
  mutate(`Dulaglutide Prop`=100*Dulaglutide/sum) %>%
  mutate(`other Prop`=100*other/sum) %>%
  mutate(`Semaglutide Injectable Prop`=100*`Semaglutide Injectable`/sum) %>%
  ungroup() %>% 
  select(prov, `Dulaglutide Prop`, `other Prop`, `Semaglutide Injectable Prop`)


temp <- gather(temp, Drug, Prop, `Dulaglutide Prop`:`Semaglutide Injectable Prop`, factor_key=TRUE)

temp %>% ggplot(aes(Prop, colour=Drug))+
  geom_density(size=1, alpha=0.1) +
  ggsci::scale_colour_jama()+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 10))+
  xlab("\n Share of Semaglutide/Dulaglutide/other (~ GLP1 Injectable)")+
  ylab("Physician Proportion \n")
  
# ----------
# Physicians Dulaglutide vs Semaglutide ----------------------

DIA_Medications <- fread("DANU Medications.txt")
DIA_Medications <- DIA_Medications %>% 
  filter(generic_name =="Dulaglutide"|generic_name=="Semaglutide Injectable") %>% 
  select(drug_id, generic_name)
names(DIA_Medications)[2] <- "generic"

Dia_US_Doses <- fread("DIA Doses.txt")
Dia_US_Doses <- Dia_US_Doses %>% left_join(DIA_Medications) 
Dia_US_Doses <- Dia_US_Doses %>% filter(drug_group=="GLP1 Injectable")
Dia_US_Doses <- Dia_US_Doses %>% select(generic, pat_id, weight, from_dt, prov, specialty)
Dia_US_Doses$from_dt <- as.Date(Dia_US_Doses$from_dt)
Dia_US_Doses <- Dia_US_Doses %>% filter(from_dt>="2019-05-01")
Dia_US_Doses <- Dia_US_Doses %>% mutate(generic=ifelse(is.na(generic),"other", generic))
Dia_US_Doses <- Dia_US_Doses %>% drop_na()


# Semaglutide

Sem_temp <- Dia_US_Doses %>% 
  filter(from_dt<"2020-05-01"&from_dt>="2019-05-01") %>% 
  mutate(generic=ifelse(generic=="Semaglutide Injectable", generic, "other")) %>%
  group_by(prov, generic) %>% 
  count() %>%
  spread(key=generic, value=n) %>% 
  mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
  mutate(other=ifelse(is.na(other),0,other)) %>%
  mutate(sumYear4=sum(other+`Semaglutide Injectable`)) %>%
  select(-2) %>%
  rename("SemaglutideYear4"=`Semaglutide Injectable`) %>%
  rename("GLP1Year4"=sumYear4) %>% 
  mutate(ClassYear4 = ifelse(SemaglutideYear4==0,"No_Semaglutide",
                             ifelse(SemaglutideYear4/GLP1Year4>0.5,"High_Share", "Low_Share"))) %>%
  full_join(Dia_US_Doses %>% 
              filter(from_dt<"2021-05-01"&from_dt>="2020-05-01") %>% 
              mutate(generic=ifelse(generic=="Semaglutide Injectable", generic, "other")) %>%
              group_by(prov, generic) %>% count() %>%
              spread(key=generic, value=n) %>% 
              mutate(`Semaglutide Injectable`=ifelse(is.na(`Semaglutide Injectable`),0,`Semaglutide Injectable`)) %>%
              mutate(other=ifelse(is.na(other),0,other)) %>%
              mutate(sumYear5=sum(other+`Semaglutide Injectable`)) %>%
              select(-2) %>%
              rename("SemaglutideYear5"=`Semaglutide Injectable`) %>%
              rename("GLP1Year5"=sumYear5) %>% 
              mutate(ClassYear5 = ifelse(SemaglutideYear5==0,"No_Semaglutide",
                                         ifelse(SemaglutideYear5/GLP1Year5>0.5,"High_Share", "Low_Share")))
  ) %>%
  mutate(SemaglutideYear4=ifelse(is.na(SemaglutideYear4),0,SemaglutideYear4)) %>%
  mutate(GLP1Year4=ifelse(is.na(GLP1Year4),0,GLP1Year4)) %>%
  mutate(SemaglutideYear5=ifelse(is.na(SemaglutideYear5),0,SemaglutideYear5)) %>%
  mutate(GLP1Year5=ifelse(is.na(GLP1Year5),0,GLP1Year5)) %>%
  mutate(ClassYear4 = ifelse(SemaglutideYear4==0,"No_Semaglutide",
                             ifelse(SemaglutideYear4/GLP1Year4>0.5,"High_Share", "Low_Share"))) %>%
  mutate(ClassYear5 = ifelse(SemaglutideYear5==0,"No_Semaglutide",
                             ifelse(SemaglutideYear5/GLP1Year5>0.5,"High_Share", "Low_Share"))) %>%
  mutate(Delta=SemaglutideYear5-SemaglutideYear4) %>% 
  mutate(PhysicianClass=ifelse(SemaglutideYear4==0&SemaglutideYear5!=0,"New_Physician",
                               ifelse(SemaglutideYear4!=0&SemaglutideYear5==0,"Lost_Physician",
                                      ifelse(ClassYear4=="High_Share"&ClassYear5=="High_Share", "Maintain_High",
                                             ifelse(ClassYear4=="Low_Share"&ClassYear5=="Low_Share", "Maintain_Low",
                                                    ifelse(ClassYear4=="High_Share"&ClassYear5=="Low_Share", "Decreased_Share",
                                                           ifelse(ClassYear4=="Low_Share"&ClassYear5=="High_Share", "Increased_Share", "None")))))))

sum(Sem_temp$SemaglutideYear4) # 43043
sum(Sem_temp$SemaglutideYear5) # 69407
sum(Sem_temp$Delta) # 26364

Sem_temp %>% group_by(PhysicianClass) %>% count()


Sem_temp %>% group_by(PhysicianClass) %>% summarise(n=sum(Delta))



fwrite(Sem_temp, "Sem_temp_physicians.csv")

Sem_temp %>% group_by(PhysicianClass, ClassYear5) %>% summarise(n=sum(SemaglutideYear5))



# Dulaglutide

Dulaglutide_temp <- Dia_US_Doses %>% 
  filter(from_dt<"2020-05-01"&from_dt>="2019-05-01") %>% 
  mutate(generic=ifelse(generic=="Dulaglutide", generic, "other")) %>%
  group_by(prov, generic) %>% 
  count() %>%
  spread(key=generic, value=n) %>% 
  mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
  mutate(other=ifelse(is.na(other),0,other)) %>%
  mutate(sumYear4=sum(other+Dulaglutide)) %>%
  select(-3) %>%
  rename("DulaglutideYear4"="Dulaglutide") %>%
  rename("GLP1Year4"="sumYear4") %>% 
  mutate(ClassYear4 = ifelse(DulaglutideYear4==0,"No_Dulaglutide",
                             ifelse(DulaglutideYear4/GLP1Year4>0.5,"High_Share", "Low_Share"))) %>%
  full_join(Dia_US_Doses %>% 
              filter(from_dt<"2021-05-01"&from_dt>="2020-05-01") %>% 
              mutate(generic=ifelse(generic=="Dulaglutide", generic, "other")) %>%
              group_by(prov, generic) %>% count() %>%
              spread(key=generic, value=n) %>% 
              mutate(Dulaglutide=ifelse(is.na(Dulaglutide),0,Dulaglutide)) %>%
              mutate(other=ifelse(is.na(other),0,other)) %>%
              mutate(sumYear5=sum(other+Dulaglutide)) %>%
              select(-3) %>%
              rename("DulaglutideYear5"="Dulaglutide") %>%
              rename("GLP1Year5"="sumYear5") %>% 
              mutate(ClassYear5 = ifelse(DulaglutideYear5==0,"No_Dulaglutide",
                                         ifelse(DulaglutideYear5/GLP1Year5>0.5,"High_Share", "Low_Share")))
  ) %>%
  mutate(DulaglutideYear4=ifelse(is.na(DulaglutideYear4),0,DulaglutideYear4)) %>%
  mutate(GLP1Year4=ifelse(is.na(GLP1Year4),0,GLP1Year4)) %>%
  mutate(DulaglutideYear5=ifelse(is.na(DulaglutideYear5),0,DulaglutideYear5)) %>%
  mutate(GLP1Year5=ifelse(is.na(GLP1Year5),0,GLP1Year5)) %>%
  mutate(ClassYear4 = ifelse(DulaglutideYear4==0,"No_Dulaglutide",
                             ifelse(DulaglutideYear4/GLP1Year4>0.5,"High_Share", "Low_Share"))) %>%
  mutate(ClassYear5 = ifelse(DulaglutideYear5==0,"No_Dulaglutide",
                             ifelse(DulaglutideYear5/GLP1Year5>0.5,"High_Share", "Low_Share"))) %>%
  mutate(Delta=DulaglutideYear5-DulaglutideYear4) %>% 
  mutate(PhysicianClass=ifelse(DulaglutideYear4==0&DulaglutideYear5!=0,"New_Physician",
                               ifelse(DulaglutideYear4!=0&DulaglutideYear5==0,"Lost_Physician",
                                      ifelse(ClassYear4=="High_Share"&ClassYear5=="High_Share", "Maintain_High",
                                             ifelse(ClassYear4=="Low_Share"&ClassYear5=="Low_Share", "Maintain_Low",
                                                    ifelse(ClassYear4=="High_Share"&ClassYear5=="Low_Share", "Decreased_Share",
                                                           ifelse(ClassYear4=="Low_Share"&ClassYear5=="High_Share", "Increased_Share", "None")))))))

sum(Dulaglutide_temp$DulaglutideYear4) # 82872
sum(Dulaglutide_temp$DulaglutideYear5) # 98049
sum(Dulaglutide_temp$Delta) # 15177
Dulaglutide_temp %>% group_by(PhysicianClass) %>% count()


Dulaglutide_temp %>% group_by(PhysicianClass) %>% summarise(n=sum(Delta))



Dulaglutide_temp %>% group_by(PhysicianClass, ClassYear5) %>% summarise(n=sum(DulaglutideYear5))


Dia_US_Doses <- fread("DIA Doses.txt")
Provs_unique <- Dia_US_Doses %>% select(prov, specialty) %>% distinct()


Sem_temp
Dulaglutide_temp


PROVCAT <- fread("PROVCAT.txt", sep="|")
PROVCAT$PROVCAT <- sub("^0+", "", PROVCAT$PROVCAT)  
PROVCAT <- PROVCAT %>% mutate(PROVCAT = ifelse(PROVCAT=="","0",PROVCAT))
PROVCAT$PROVCAT <- as.numeric(PROVCAT$PROVCAT)

Specialties_to_keep <- fread("Specialties_to_keep.txt")

Provs_unique <- Provs_unique %>% left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) 

unique(Provs_unique$PHYSICIAN)

Provs_unique <- Provs_unique %>% drop_na() %>% filter(!PHYSICIAN=="FACILITY") %>% mutate(PHYSICIAN=ifelse(PHYSICIAN=="PCP"|PHYSICIAN=="INERNAL MEDICINE","GP",
                                                                                                          ifelse(PHYSICIAN=="ENDOCRINOLOGY","ENDOCRINOLOGY","OTHER")))

Provs_unique <- Provs_unique %>% select(prov, PHYSICIAN)

Sem_temp %>% inner_join(Provs_unique) %>% 
  mutate(PhysicianClass=ifelse(PhysicianClass=="New_Physician","New_Physican","Existing")) %>%
  group_by(PhysicianClass, ClassYear5,PHYSICIAN) %>% 
  summarise(n=sum(SemaglutideYear5))




Dulaglutide_temp %>% inner_join(Provs_unique) %>% 
  mutate(PhysicianClass=ifelse(PhysicianClass=="New_Physician","New_Physican","Existing")) %>%
  group_by(PhysicianClass, ClassYear5,PHYSICIAN) %>% 
  summarise(n=sum(DulaglutideYear5))



# ----------
# Share of brands per physician -----------

Dia_US_Doses <- fread("DIA Doses.txt")
Provs_unique <- Dia_US_Doses %>% select(prov, specialty) %>% distinct()

PROVCAT <- fread("PROVCAT.txt", sep="|")
PROVCAT$PROVCAT <- sub("^0+", "", PROVCAT$PROVCAT)  
PROVCAT <- PROVCAT %>% mutate(PROVCAT = ifelse(PROVCAT=="","0",PROVCAT))
PROVCAT$PROVCAT <- as.numeric(PROVCAT$PROVCAT)

Specialties_to_keep <- fread("Specialties_to_keep.txt")

Provs_unique <- Provs_unique %>% left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) 

unique(Provs_unique$PHYSICIAN)

Provs_unique <- Provs_unique %>% drop_na() %>% filter(!PHYSICIAN=="FACILITY") %>% mutate(PHYSICIAN=ifelse(PHYSICIAN=="PCP"|PHYSICIAN=="INERNAL MEDICINE","GP",
                                                                                                          ifelse(PHYSICIAN=="ENDOCRINOLOGY","ENDOCRINOLOGY","OTHER")))

Provs_unique <- Provs_unique %>% select(prov, PHYSICIAN)


DIA_Medications <- fread("DANU Medications.txt")
DIA_Medications <- DIA_Medications %>% 
  filter(drug_group =="GLP1 Injectable") %>% 
  select(drug_id, generic_name)
names(DIA_Medications)[2] <- "generic"



Dia_US_Doses <- fread("DIA Doses.txt")
Dia_US_Doses <- Dia_US_Doses %>% left_join(DIA_Medications) 
Dia_US_Doses <- Dia_US_Doses %>% filter(drug_group=="GLP1 Injectable")
Dia_US_Doses <- Dia_US_Doses %>% select(generic, pat_id, weight, from_dt, prov, specialty)
Dia_US_Doses$from_dt <- as.Date(Dia_US_Doses$from_dt)
Dia_US_Doses <- Dia_US_Doses %>% filter(from_dt>="2019-05-01")
Dia_US_Doses <- Dia_US_Doses %>% mutate(generic=ifelse(is.na(generic),"other", generic))
Dia_US_Doses <- Dia_US_Doses %>% drop_na()


Dia_US_Doses %>% inner_join(Provs_unique) %>% group_by(PHYSICIAN, generic) %>% count()





Dia_US_Doses %>% inner_join(Provs_unique) %>% select(generic, prov, PHYSICIAN) %>% distinct() %>%
  group_by(PHYSICIAN, prov) %>% count() %>% ungroup() %>% group_by(PHYSICIAN) %>% summarise(n2=mean(n))

Dia_US_Doses %>% inner_join(Provs_unique) %>% select(generic, prov, PHYSICIAN) %>%
  group_by(PHYSICIAN, prov) %>% mutate(total=n()) %>% ungroup() %>% group_by(PHYSICIAN, prov,generic) %>% mutate(totalgeneric=n()) %>%
  mutate(prcentgeneric=totalgeneric/total) %>% ungroup() %>% distinct() %>%
  group_by(PHYSICIAN, generic) %>% summarise(globalmean=median(prcentgeneric))


temp <- Dia_US_Doses %>% mutate(generic=ifelse(generic=="Dulaglutide","Dulaglutide",
                                               ifelse(generic=="Semaglutide Injectable","Semaglutide Injectable","other"))) %>% 
  inner_join(Provs_unique) %>% select(generic, prov, PHYSICIAN) %>%
  arrange(generic, PHYSICIAN, prov) %>%
  group_by(PHYSICIAN, prov) %>% mutate(total_GLP1=n()) %>% ungroup() %>% 
  group_by(PHYSICIAN,prov,generic) %>%  mutate(total_generic=n()) %>% ungroup() %>%
  mutate(percent_generic=total_generic/total_GLP1)


temp   %>% group_by(PHYSICIAN) %>% count()

temp <- temp %>% select(generic, prov, PHYSICIAN, percent_generic) %>% 
  spread(key=generic, value=percent_generic) %>%
  mutate(prov_proportion=ifelse(PHYSICIAN=="OTHER",100*1/15628,
                                ifelse(PHYSICIAN=="ENDOCRINOLOGY",100*1/4073,100*1/10165)))

temp <- temp %>% mutate(prov_proportion=ifelse(PHYSICIAN=="OTHER",100*1/15628,
                                               ifelse(PHYSICIAN=="ENDOCRINOLOGY",100*1/4073,100*1/10165)))


temp <- mutate_if(temp, is.numeric, ~replace(., is.na(.), 0))


temp %>% arrange(PHYSICIAN, `Semaglutide Injectable`) %>%
  select(-c(Dulaglutide, other, prov)) %>%
  filter(PHYSICIAN=="ENDOCRINOLOGY") %>%
  mutate(CumProportion=cumsum(prov_proportion)) %>%
  bind_rows(  temp %>% arrange(PHYSICIAN, `Semaglutide Injectable`) %>%
                select(-c(Dulaglutide, other, prov)) %>%
                filter(PHYSICIAN=="OTHER") %>%
                mutate(CumProportion=cumsum(prov_proportion))) %>%
  bind_rows( temp %>% arrange(PHYSICIAN, `Semaglutide Injectable`) %>%
               select(-c(Dulaglutide, other, prov)) %>%
               filter(PHYSICIAN=="GP") %>%
               mutate(CumProportion=cumsum(prov_proportion))) %>%
  mutate(`Semaglutide Injectable`=100*`Semaglutide Injectable`) %>%
  ggplot(aes(x=CumProportion,y=`Semaglutide Injectable`, colour=PHYSICIAN)) +
  geom_line(size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Physician Proportion (%)")+ylab("Semaglutide Injectable Share \n (% of GLP1 scripts) \n")



temp %>% arrange(PHYSICIAN, Dulaglutide ) %>%
  select(-c(`Semaglutide Injectable`, other, prov)) %>%
  filter(PHYSICIAN=="ENDOCRINOLOGY") %>%
  mutate(CumProportion=cumsum(prov_proportion)) %>%
  bind_rows(  temp %>% arrange(PHYSICIAN, Dulaglutide) %>%
                select(-c(`Semaglutide Injectable`, other, prov)) %>%
                filter(PHYSICIAN=="OTHER") %>%
                mutate(CumProportion=cumsum(prov_proportion))) %>%
  bind_rows( temp %>% arrange(PHYSICIAN, Dulaglutide) %>%
               select(-c(`Semaglutide Injectable`, other, prov)) %>%
               filter(PHYSICIAN=="GP") %>%
               mutate(CumProportion=cumsum(prov_proportion))) %>%
  mutate(Dulaglutide=100*Dulaglutide) %>%
  ggplot(aes(x=CumProportion,y=Dulaglutide, colour=PHYSICIAN)) +
  geom_line(size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Physician Proportion (%)")+ylab("Dulaglutide Share \n (% of GLP1 scripts) \n")



temp %>% arrange(PHYSICIAN, other ) %>%
  select(-c(`Semaglutide Injectable`, Dulaglutide, prov)) %>%
  filter(PHYSICIAN=="ENDOCRINOLOGY") %>%
  mutate(CumProportion=cumsum(prov_proportion)) %>%
  bind_rows(  temp %>% arrange(PHYSICIAN, other) %>%
                select(-c(`Semaglutide Injectable`, Dulaglutide, prov)) %>%
                filter(PHYSICIAN=="OTHER") %>%
                mutate(CumProportion=cumsum(prov_proportion))) %>%
  bind_rows( temp %>% arrange(PHYSICIAN, other) %>%
               select(-c(`Semaglutide Injectable`, Dulaglutide, prov)) %>%
               filter(PHYSICIAN=="GP") %>%
               mutate(CumProportion=cumsum(prov_proportion))) %>%
  mutate(other=100*other) %>%
  ggplot(aes(x=CumProportion,y=other, colour=PHYSICIAN)) +
  geom_line(size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  ggsci::scale_color_jco()+
  xlab("\n Physician Proportion (%)")+ylab("Other GLP1s Share \n (% of GLP1 scripts) \n")

data.frame(temp %>% mutate(Type=ifelse(Dulaglutide==1,"100Dulaglutide",
                            ifelse(`Semaglutide Injectable`==1,"100Semaglutide",
                                   ifelse(other==1,"100other",
                                          ifelse( `Semaglutide Injectable`>0.5,"50Semaglutide" ,
                                                 ifelse(Dulaglutide>0.5,"50Dulaglutide",
                                                        ifelse(other>0.5,"50other","portfolio"))))))) %>%
  group_by(PHYSICIAN, Type) %>% count())











# V2 -----------------
Dia_US_Doses <- fread("DIA Doses.txt")
Provs_unique <- Dia_US_Doses %>% select(prov, specialty) %>% distinct()
PROVCAT <- fread("PROVCAT.txt", sep="|")
PROVCAT$PROVCAT <- sub("^0+", "", PROVCAT$PROVCAT)  
PROVCAT <- PROVCAT %>% mutate(PROVCAT = ifelse(PROVCAT=="","0",PROVCAT))
PROVCAT$PROVCAT <- as.numeric(PROVCAT$PROVCAT)

Specialties_to_keep <- fread("Specialties_to_keep.txt")

Provs_unique <- Provs_unique %>% left_join(Specialties_to_keep %>% 
                                             select(specialty, PHYSICIAN), 
                                           by=c("specialty"="specialty")) 


Provs_unique <- Provs_unique %>% drop_na() %>% filter(!PHYSICIAN=="FACILITY") %>%
  mutate(PHYSICIAN=ifelse(PHYSICIAN=="PCP"|PHYSICIAN=="INERNAL MEDICINE","GP",
                          ifelse(PHYSICIAN=="ENDOCRINOLOGY","ENDOCRINOLOGY","OTHER")))

Provs_unique <- Provs_unique %>% select(prov, PHYSICIAN)

DIA_Medications <- fread("DANU Medications.txt")
DIA_Medications <- DIA_Medications %>% 
  filter(drug_group =="GLP1 Injectable") %>% 
  select(drug_id, generic_name)
names(DIA_Medications)[2] <- "generic"

Dia_US_Doses <- fread("DIA Doses.txt")
Dia_US_Doses <- Dia_US_Doses %>% left_join(DIA_Medications) 
Dia_US_Doses <- Dia_US_Doses %>% filter(drug_group=="GLP1 Injectable")
Dia_US_Doses <- Dia_US_Doses %>% select(generic, pat_id, weight, from_dt, prov, specialty)
Dia_US_Doses$from_dt <- as.Date(Dia_US_Doses$from_dt)
Dia_US_Doses <- Dia_US_Doses %>% filter(from_dt>="2019-05-01")
# Dia_US_Doses <- Dia_US_Doses %>% mutate(generic=ifelse(is.na(generic),"other", generic))
Dia_US_Doses <- Dia_US_Doses %>% drop_na()

temp <- Dia_US_Doses %>% inner_join(Provs_unique) %>% select(generic, prov) %>%
  group_by(prov) %>% mutate(total=n()) %>% ungroup() %>% 
  group_by(prov,generic) %>% mutate(totalgeneric=n()) %>%
  mutate(prcentgeneric=totalgeneric/total) %>% ungroup() %>% distinct() %>%
  select(generic, prov, prcentgeneric) %>%
  spread(key=generic, value=prcentgeneric)

temp <- mutate_if(temp, is.numeric, ~replace(., is.na(.), 0))

names(temp)

data.frame(temp %>% mutate(Type=ifelse(Dulaglutide==1,"100Dulaglutide",
                            ifelse(`Semaglutide Injectable`==1,"100Semaglutide",
                                   ifelse(Albiglutide ==1|Liraglutide ==1|Exenatide ==1|Lixisenatide ==1,"100other",
                                          ifelse( `Semaglutide Injectable`>0.5,"50Semaglutide" ,
                                                 ifelse(Dulaglutide>0.5,"50Dulaglutide",
                                                        ifelse(Albiglutide >0.5|Liraglutide >0.5|Exenatide >0.5|Lixisenatide>0.5,"50other","portfolio"))))))) %>%
  group_by(Type) %>% count())



# --------
# GLP1 dosages over time --------------------------------

# WEGOVY

# Last Year
GLP1_sel_lstYr_prescrip <- fread("GLP1_sel_lstYr_prescrip.txt")
GLP1_sel_lstYr_prescrip$rxdate <- as.Date(GLP1_sel_lstYr_prescrip$rxdate)
GLP1_sel_lstYr_prescrip <- GLP1_sel_lstYr_prescrip %>% inner_join(Wegovy_ndcs)

GLP1_sel_lstYr_prescrip <- GLP1_sel_lstYr_prescrip %>% group_by(ptid) %>% filter(rxdate==max(rxdate))
GLP1_sel_lstYr_prescrip <- GLP1_sel_lstYr_prescrip  %>% group_by(ptid) %>% filter(strength==max(strength)) %>% slice(1)

GLP1_sel_lstYr_prescrip %>% select(strength) %>% ungroup() %>%
  group_by(strength) %>% count()


Wegovy_1y_pats <- GLP1_sel_lstYr_prescrip %>% select(ptid) %>% distinct()



# Last 5 Years
GLP1_sel_lstYr_prescrip_with_brand <- fread("GLP1_sel_lstYr_prescrip with brand.txt")
Wegovy_ndcs <- GLP1_sel_lstYr_prescrip_with_brand %>% filter(Brand =="Wegovy") %>% select(ndc) %>% distinct()

length(unique(GLP1_sel_lstYr_prescrip_with_brand$ptid))

GLP1_sel_lst5Yr_prescrip <- fread("GLP1_sel_lst5Yr_prescrip.txt")
GLP1_sel_lst5Yr_prescrip <- Wegovy_ndcs %>% distinct() %>% left_join(GLP1_sel_lst5Yr_prescrip)

GLP1_sel_lst5Yr_prescrip  %>% group_by(ptid) %>% filter(strength==max(strength)) %>% slice(1) %>%
  ungroup() %>% group_by(strength) %>% count()


GLP1_sel_lst5Yr_prescrip$rxdate <- as.Date(GLP1_sel_lst5Yr_prescrip$rxdate)
GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% group_by(ptid) %>% filter(rxdate==max(rxdate))
GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip  %>% group_by(ptid) %>% filter(strength==max(strength)) %>% slice(1)

GLP1_sel_lst5Yr_prescrip %>% select(strength) %>% ungroup() %>%
  group_by(strength) %>% count()

Wegovy_5y_pats <- GLP1_sel_lst5Yr_prescrip %>% select(ptid) %>% distinct()




GLP1_sel_lst5Yr_prescrip <- fread("GLP1_sel_lst5Yr_prescrip.txt")
GLP1_sel_lst5Yr_prescrip$rxdate <- as.Date(GLP1_sel_lst5Yr_prescrip$rxdate)
GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% inner_join(Wegovy_ndcs)
GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% select(ptid, rxdate, strength) %>%
  group_by(ptid,rxdate ) %>% filter(strength==max(strength)) %>% slice(1)

GLP1_sel_lst5Yr_prescrip_summary <- GLP1_sel_lst5Yr_prescrip %>% group_by(ptid) %>% arrange(ptid, rxdate) %>% 
  mutate(index = rxdate-lag(rxdate)) %>% ungroup() %>% mutate(index = as.numeric(index)) %>%
  mutate(index = ifelse(is.na(index), 0, index)) %>% group_by(ptid) %>%
  mutate(time_progression = cumsum(index)) 


GLP1_sel_lst5Yr_prescrip_summary %>% ungroup() %>% select(ptid, strength, time_progression) %>%
  filter(strength != "") %>%
  filter(time_progression>0) %>%
  ggplot(aes(x=time_progression, y=strength, fill=strength))+
  geom_jitter(height =0.2, width = 0.7, show.legend = F, alpha=0.2, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 20))+
  xlab("\nTime since therapy initiation (days)")+
  ylab("Strength Prescribed\n")

GLP1_sel_lst5Yr_prescrip_summary %>% ungroup() %>% select(ptid, strength, time_progression) %>%
  filter(strength != "") %>% group_by(strength) %>% summarise(n=mean(time_progression))



GLP1_sel_lst5Yr_prescrip_summary %>% ungroup() %>% select(ptid, strength, time_progression) %>%
  filter(strength != "") %>% group_by(strength) %>% summarise(n=median(time_progression))



temp <- GLP1_sel_lst5Yr_prescrip_summary %>% ungroup() %>% 
  filter(strength != "") %>%
  filter(time_progression>0) %>%
  group_by(ptid) %>% filter(time_progression <=7) %>% slice_tail() %>% ungroup() %>% 
  group_by(strength ) %>% count() %>% filter(strength!="")


for(i in 1:23){
  temp2 <- GLP1_sel_lst5Yr_prescrip_summary %>% ungroup() %>% 
    filter(strength != "") %>%
    filter(time_progression>0) %>%
    group_by(ptid) %>% filter(time_progression <=7*i) %>% slice_tail() %>% ungroup() %>% 
    group_by(strength ) %>% count() %>% filter(strength!="")
  temp <- temp %>% bind_cols(temp2 %>% ungroup %>% select(n))
}


fwrite(temp, "Wegovy_over_time.csv")


# SAXENDA

# Last Year
GLP1_sel_lstYr_prescrip <- fread("GLP1_sel_lstYr_prescrip.txt")
GLP1_sel_lstYr_prescrip$rxdate <- as.Date(GLP1_sel_lstYr_prescrip$rxdate)
GLP1_sel_lstYr_prescrip <- GLP1_sel_lstYr_prescrip %>% inner_join(Saxenda_ndcs)
GLP1_sel_lstYr_prescrip <- GLP1_sel_lstYr_prescrip %>% group_by(ptid) %>% filter(rxdate==max(rxdate))
GLP1_sel_lstYr_prescrip <- GLP1_sel_lstYr_prescrip  %>% group_by(ptid) %>% filter(strength==max(strength)) %>% slice(1)

GLP1_sel_lstYr_prescrip %>% select(strength) %>% ungroup() %>%
  group_by(strength) %>% count()


# Last 5 Years
GLP1_sel_lstYr_prescrip_with_brand <- fread("GLP1_sel_lstYr_prescrip with brand.txt")
Saxenda_ndcs <- GLP1_sel_lstYr_prescrip_with_brand %>% filter(Brand =="Saxenda") %>% select(ndc) %>% distinct()

GLP1_sel_lst5Yr_prescrip <- fread("GLP1_sel_lst5Yr_prescrip.txt")
GLP1_sel_lst5Yr_prescrip <- Saxenda_ndcs %>% distinct() %>% inner_join(GLP1_sel_lst5Yr_prescrip)
GLP1_sel_lst5Yr_prescrip$rxdate <- as.Date(GLP1_sel_lst5Yr_prescrip$rxdate)
GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% group_by(ptid) %>% filter(rxdate==max(rxdate))
GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip  %>% group_by(ptid) %>% filter(strength==max(strength)) %>% slice(1)

data.frame(GLP1_sel_lst5Yr_prescrip %>% select(strength) %>% ungroup() %>%
             group_by(strength) %>% count())

GLP1_sel_lst5Yr_scripts <- fread("GLP1_sel_lst5Yr_scripts.txt")
GLP1_sel_lst5Yr_medAdmin <- fread("GLP1_sel_lst5Yr_medAdmin.txt")





# RYBELSUS

# Last Year
GLP1_sel_lstYr_prescrip <- fread("GLP1_sel_lstYr_prescrip.txt")
GLP1_sel_lstYr_prescrip$rxdate <- as.Date(GLP1_sel_lstYr_prescrip$rxdate)
GLP1_sel_lstYr_prescrip <- GLP1_sel_lstYr_prescrip %>% filter(grepl("4307", ndc)|grepl("4303", ndc)|grepl("4314", ndc))

GLP1_sel_lstYr_prescrip <- GLP1_sel_lstYr_prescrip %>% filter(strength=="3"|strength=="7"|strength=="14")

GLP1_sel_lstYr_prescrip <- GLP1_sel_lstYr_prescrip %>% group_by(ptid) %>% filter(rxdate==max(rxdate))
GLP1_sel_lstYr_prescrip <- GLP1_sel_lstYr_prescrip  %>% group_by(ptid) %>% filter(strength==max(strength)) %>% slice(1)

GLP1_sel_lstYr_prescrip %>% select(strength) %>% ungroup() %>%
  group_by(strength) %>% count()



# Last 5 Years
GLP1_sel_lst5Yr_prescrip <- fread("GLP1_sel_lst5Yr_prescrip.txt")
GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% filter(grepl("4307", ndc)|grepl("4303", ndc)|grepl("4314", ndc))

GLP1_sel_lst5Yr_prescrip$rxdate <- as.Date(GLP1_sel_lst5Yr_prescrip$rxdate)

GLP1_sel_lst5Yr_prescrip  %>% group_by(ptid) %>% filter(strength==max(strength)) %>% slice(1) %>%
  ungroup() %>% group_by(strength) %>% count()





unique(GLP1_sel_lst5Yr_prescrip$strength)

GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% filter(strength=="3"|strength=="7"|strength=="14")


data.frame(GLP1_sel_lst5Yr_prescrip %>% group_by(strength) %>% count())



GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% group_by(ptid) %>% filter(rxdate==max(rxdate))
GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip  %>% group_by(ptid) %>% filter(strength==max(strength)) %>% slice(1)

GLP1_sel_lst5Yr_prescrip %>% select(strength) %>% ungroup() %>%
  group_by(strength) %>% count()



GLP1_sel_lst5Yr_prescrip <- fread("GLP1_sel_lst5Yr_prescrip.txt")
GLP1_sel_lst5Yr_prescrip$rxdate <- as.Date(GLP1_sel_lst5Yr_prescrip$rxdate)
GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% filter(grepl("4307", ndc)|grepl("4303", ndc)|grepl("4314", ndc))
GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% filter(strength=="3"|strength=="7"|strength=="14")

GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% select(ptid, rxdate, strength) %>%
  group_by(ptid,rxdate ) %>% filter(strength==max(strength)) %>% slice(1)

GLP1_sel_lst5Yr_prescrip_summary <- GLP1_sel_lst5Yr_prescrip %>% group_by(ptid) %>% arrange(ptid, rxdate) %>% 
  mutate(index = rxdate-lag(rxdate)) %>% ungroup() %>% mutate(index = as.numeric(index)) %>%
  mutate(index = ifelse(is.na(index), 0, index)) %>% group_by(ptid) %>%
  mutate(time_progression = cumsum(index)) 


GLP1_sel_lst5Yr_prescrip_summary$strength <- factor(GLP1_sel_lst5Yr_prescrip_summary$strength, levels=c("3","7","14"))

GLP1_sel_lst5Yr_prescrip_summary %>% ungroup() %>% select(ptid, strength, time_progression) %>%
  filter(time_progression>0) %>%
  ggplot(aes(x=time_progression, y=strength, fill=strength))+
  geom_jitter(height =0.3, width = 0.7, show.legend = F, alpha=0.1, size=1)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 20))+
  xlab("\nTime since therapy initiation (days)")+
  ylab("Strength Prescribed\n")

GLP1_sel_lst5Yr_prescrip_summary %>% ungroup() %>% select(ptid, strength, time_progression) %>%
  group_by(strength) %>% summarise(n=mean(time_progression))

GLP1_sel_lst5Yr_prescrip_summary %>% ungroup() %>% select(ptid, strength, time_progression) %>%
  group_by(strength) %>% summarise(n=median(time_progression))


temp <- GLP1_sel_lst5Yr_prescrip_summary %>% ungroup() %>% 
  filter(time_progression>0) %>%
  group_by(ptid) %>% filter(time_progression <=7) %>% slice_tail() %>% ungroup() %>% 
  group_by(strength ) %>% count()


for(i in 1:52){
  temp2 <- GLP1_sel_lst5Yr_prescrip_summary %>% ungroup() %>% 
    filter(time_progression>0) %>%
    group_by(ptid) %>% filter(time_progression <=7*i) %>% slice_tail() %>% ungroup() %>% 
    group_by(strength ) %>% count() 
  temp <- temp %>% bind_cols(temp2 %>% ungroup %>% select(n))
}


fwrite(temp, "Rybelsus_over_time_weeks.csv")













# SAXENDA DAILY DOSE CALC 


# Last 5 Years
GLP1_sel_lstYr_prescrip_with_brand <- fread("GLP1_sel_lstYr_prescrip with brand.txt")
Saxenda_ndcs <- GLP1_sel_lstYr_prescrip_with_brand %>% filter(Brand =="Saxenda") %>% select(ndc) %>% distinct()

GLP1_sel_lst5Yr_prescrip <- fread("GLP1_sel_lst5Yr_prescrip.txt")
GLP1_sel_lst5Yr_prescrip <- Saxenda_ndcs %>% distinct() %>% inner_join(GLP1_sel_lst5Yr_prescrip)
GLP1_sel_lst5Yr_prescrip$rxdate <- as.Date(GLP1_sel_lst5Yr_prescrip$rxdate)

GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% select(2,3,4,15,16)

unique(GLP1_sel_lst5Yr_prescrip$quantity_per_fill)
data.frame(GLP1_sel_lst5Yr_prescrip %>% group_by(quantity_per_fill) %>% count() %>% arrange(-n))

GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% 
  mutate(quantity_per_fill=as.numeric(quantity_per_fill)) %>%
  mutate(num_refills=as.numeric(num_refills)) %>% drop_na()

GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% arrange(ptid, rxdate, rxtime)

# Only pats with Rxs ON +5 different dates !
Distance_Between_Rxs <- 
  data.frame(GLP1_sel_lst5Yr_prescrip %>% select(ptid, rxdate) %>% distinct() %>% 
               group_by(ptid) %>% count() %>% filter(n>4) %>% select(ptid) %>% 
               inner_join(GLP1_sel_lst5Yr_prescrip) %>%
               select(ptid, rxdate) %>% distinct() %>%
               arrange(ptid, rxdate) %>%
               group_by(ptid) %>% mutate(NextDate = as.numeric(lead(rxdate))-as.numeric(rxdate))) %>%
  mutate(NextDate=ifelse(is.na(NextDate),0,NextDate))

GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% inner_join(Distance_Between_Rxs)

GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% 
  mutate(DailyDose = ( (1+num_refills) * (quantity_per_fill/15) * 18) / NextDate ) %>% ungroup() %>%
  filter(DailyDose != "NaN")

GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip  %>% filter(DailyDose != "Inf")

GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% ungroup() %>% filter(NextDate>=5)

GLP1_sel_lst5Yr_prescrip <- GLP1_sel_lst5Yr_prescrip %>% select(-rxtime) %>% group_by(ptid, rxdate) %>%
  filter(DailyDose==max(DailyDose)) %>% slice(1)

temp <- GLP1_sel_lst5Yr_prescrip %>% ungroup() %>% 
  mutate(DailyDose=round(DailyDose,1)) %>% group_by(DailyDose) %>% count()



temp2 <- GLP1_sel_lst5Yr_prescrip %>% ungroup() %>% 
  mutate(DailyDose=round(DailyDose,1)) %>%
  filter(DailyDose>0.1&DailyDose<10) %>%
  mutate(DailyDose=ifelse(DailyDose<=0.9,0.6,
                          ifelse(DailyDose<=1.5,1.2,ifelse(DailyDose<=2.1,1.8,
                                                           ifelse(DailyDose<=2.7,2.4,3))))) %>% drop_na()


temp2 %>% group_by(DailyDose) %>% count()

temp2 %>% group_by(ptid) %>% filter(DailyDose==max(DailyDose)) %>% slice(1) %>%
  ungroup() %>% group_by(DailyDose) %>% count()


temp2$DailyDose <- factor(temp2$DailyDose, levels=c(0.6,1.2,1.8,2.4,3))

temp2_summary <- temp2 %>% group_by(ptid) %>% arrange(ptid, rxdate) %>% 
  mutate(index = rxdate-lag(rxdate)) %>% ungroup() %>% mutate(index = as.numeric(index)) %>%
  mutate(index = ifelse(is.na(index), 0, index)) %>% group_by(ptid) %>%
  mutate(time_progression = cumsum(index)) 



MAX_Dose <- temp2_summary %>%  group_by(ptid) %>% filter(DailyDose==max(DailyDose)) %>% slice(1) %>%
  select(ptid, DailyDose)
names(MAX_Dose)[2] <- "MAX_Dose"

temp2_summary <- temp2_summary %>% left_join(MAX_Dose)

temp2_summary %>%  group_by(ptid) %>% filter(DailyDose==max(DailyDose)) %>%
  filter(time_progression==max(time_progression)) %>% 
  slice(1) %>%
  filter(time_progression>92) %>%
  ungroup() %>% group_by(DailyDose) %>% count()



temp2_summary %>% ungroup() %>% select(ptid, DailyDose, time_progression) %>%
  filter(time_progression>0&time_progression<120) %>%
  ggplot(aes(x=time_progression, y=DailyDose, fill=DailyDose))+
  geom_jitter(height =0.3, width = 0.7, show.legend = F, alpha=0.1, size=1)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        text = element_text(size = 20))+
  xlab("\nTime since therapy initiation (days)")+
  ylab("Daily Dose\n")


temp2_summary %>% ungroup() %>% select(ptid, DailyDose, time_progression) %>%
  group_by(DailyDose) %>% summarise(n=mean(time_progression))

temp2_summary %>% ungroup() %>% select(ptid, DailyDose, time_progression) %>%
  group_by(DailyDose) %>% summarise(n=median(time_progression))



temp <- temp2_summary %>% ungroup() %>% 
  filter(time_progression>0) %>%
  group_by(ptid) %>% filter(time_progression <=7) %>% slice_tail() %>% ungroup() %>% 
  group_by(DailyDose ) %>% count()


for(i in 1:52){
  temp2 <- temp2_summary %>% ungroup() %>% 
    filter(time_progression>0) %>%
    group_by(ptid) %>% filter(time_progression <=7*i) %>% slice_tail() %>% ungroup() %>% 
    group_by(DailyDose ) %>% count() 
  temp <- temp %>% bind_cols(temp2 %>% ungroup %>% select(n))
}

# --------
# BODY WEIGHT GLP1 Measures 3 reductions of patients exclusively on 1 or 2 therapies -----------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

# Pick patients that had *ONLY* |Biguanide| AND |SGLT2|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_InjectableGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj|
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# Pick patients that had *ONLY* |Biguanide| AND |GLP1 Inj| AND SGLT2
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_OralGLP1, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_SGLT2_GLP1Inj_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)



# Pick patients that had *ONLY* |Biguanide| AND |Insulin| 
Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_OralGLP1, Drugs)|grepl(string_InjectableGLP1, Drugs)|
                             grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_Insulin_only <- DIA_Drug_Histories %>% 
  anti_join(Pats_to_remove) %>% group_by(patient) %>% arrange(patient)

# GLP1 Injectable ------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no GLP1 Injectable too zero, and GLP1 Injectable to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP1")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)


Pats_Biguanide_GLP1Inj_only <- Pats_Biguanide_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_GLP1Inj_only)


#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to GLP1 Injectable
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took GLP1 Injectable
DIA_Drug_Histories_FIRST_GLP1 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_GLP1)[3] <- "Month_First_GLP1"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="Body Weight") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_GLP1<-  DIA_Drug_Histories_FIRST_GLP1 %>% select(patient)
DANU_Measures <- Patient_first_GLP1 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first GLP1 Injectable month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_GLP1, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before GLP1 Injectable start and months after GLP1 Injectable start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_GLP1)-6)
BMI_before_GLP1 <- BMI_before_GLP1 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_GLP1)[4] <- "Month_Prior"
names(BMI_before_GLP1)[3] <- "BMI_Prior"

BMI_after_GLP1 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_GLP1+6))
BMI_after_GLP1 <- BMI_after_GLP1 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_GLP1)[4] <- "Month_After"
names(BMI_after_GLP1)[3] <- "BMI_After"

#join the before and after BMI
BMI_GLP1_BEFORE_vs_AFTER <- BMI_before_GLP1 %>% full_join(BMI_after_GLP1)
BMI_GLP1_BEFORE_vs_AFTER <- BMI_GLP1_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) # 111.4549
mean(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) # 101.1958

median(BMI_GLP1_BEFORE_vs_AFTER$BMI_Prior) # 108.432
median(BMI_GLP1_BEFORE_vs_AFTER$BMI_After) # 97.98

write.csv(BMI_GLP1_BEFORE_vs_AFTER, "BODYWEIGHT_GLP1_BEFORE_vs_AFTER_closest_6months_Big_GLP1_only.csv")



# SGLT2 --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

# convert no SGLT2  too zero, and SGLT2 to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_SGLT2,.), ~replace(., grepl(string_SGLT2, .), "SGLT2")) 

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="SGLT2",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)



Pats_Biguanide_SGLT2_only <- Pats_Biguanide_SGLT2_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_only)



#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to SGLT2
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took SGLT2
DIA_Drug_Histories_FIRST_SGLT2 <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_SGLT2)[3] <- "Month_First_SGLT2"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")



DANU_Measures <- fread("GLP Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="Body Weight") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the SGLT2 criteria
Patient_first_SGLT2<-  DIA_Drug_Histories_FIRST_SGLT2 %>% select(patient)
DANU_Measures <- Patient_first_SGLT2 %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first SGLT2 month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_SGLT2, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before SGLT2 start and months after SGLT2 start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_SGLT2)-6)
BMI_before_SGLT2 <- BMI_before_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_SGLT2)[4] <- "Month_Prior"
names(BMI_before_SGLT2)[3] <- "BMI_Prior"

BMI_after_SGLT2 <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_SGLT2+6))
BMI_after_SGLT2 <- BMI_after_SGLT2 %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_SGLT2)[4] <- "Month_After"
names(BMI_after_SGLT2)[3] <- "BMI_After"

#join the before and after BMI
BMI_SGLT2_BEFORE_vs_AFTER <- BMI_before_SGLT2 %>% full_join(BMI_after_SGLT2)
BMI_SGLT2_BEFORE_vs_AFTER <- BMI_SGLT2_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_SGLT2_BEFORE_vs_AFTER$BMI_Prior) # 103.6119
mean(BMI_SGLT2_BEFORE_vs_AFTER$BMI_After) # 98.35623

median(BMI_SGLT2_BEFORE_vs_AFTER$BMI_Prior) # 101.2225
median(BMI_SGLT2_BEFORE_vs_AFTER$BMI_After) # 99.02525

write.csv(BMI_SGLT2_BEFORE_vs_AFTER, "BODYWEIGHT_SGLT2_BEFORE_vs_AFTER_closest_6months_Big_SGLT2_only.csv")




# Combo --------
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# convert no Combo too zero, and Combo to one, then convert everything to numeric 
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))


DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories_LONG <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)



Pats_Biguanide_SGLT2_GLP1Inj_only <- Pats_Biguanide_SGLT2_GLP1Inj_only %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% inner_join(Pats_Biguanide_SGLT2_GLP1Inj_only)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)


DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

DIA_Drug_Histories <- DIA_Drug_Histories  %>% arrange(patient, Month)

# select the min month, i.e. the month of first exposure to Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% summarize(across(everything(), min))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Treat)

# When each patient first took Combo
DIA_Drug_Histories_FIRST_Combo <- DIA_Drug_Histories
names(DIA_Drug_Histories_FIRST_Combo)[3] <- "Month_First_Combo"

# Now get the BMI levels
# File with BMI over time
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("GLP Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures <- DANU_Measures %>% filter(test=="Body Weight") %>% select(patid, weight, value, claimed)
setDT(DANU_Measures)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures$Month_Yr <- format(as.Date(DANU_Measures$claimed), "%Y-%m")
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% 
  filter(!is.na(Exact_Month)) 
DANU_Measures <- DANU_Measures %>% select(patid, weight, value, Exact_Month)

#group, arrange
DANU_Measures <- DANU_Measures %>% arrange(patid, Exact_Month, value) %>% group_by(patid)
#filter for the patients that fit the GLP1 Injectable criteria
Patient_first_Combo<-  DIA_Drug_Histories_FIRST_Combo %>% select(patient)
DANU_Measures <- Patient_first_Combo %>% left_join(DANU_Measures, by=c("patient"="patid"))
#remove those ptients with no BMI level readings
DANU_Measures <- DANU_Measures %>% filter(!is.na(weight))

#join the patient first Combo month to his BMI readings
DANU_Measures <- DANU_Measures %>% left_join(DIA_Drug_Histories_FIRST_Combo, by = c("patient" = "patient"))
DANU_Measures <- DANU_Measures %>% select(-weight.y)
names(DANU_Measures)[2] <- "weight"

# now split into months before Combo start and months after Combo start
# pick the max of the months before (the closest)
# pick the min of the months after (the closest)
#rename
BMI_before_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month < (Month_First_Combo)-6)
BMI_before_Combo <- BMI_before_Combo %>% group_by(patient) %>% summarize(across(everything(), max))
names(BMI_before_Combo)[4] <- "Month_Prior"
names(BMI_before_Combo)[3] <- "BMI_Prior"

BMI_after_Combo <- DANU_Measures %>% group_by(patient) %>% filter(Exact_Month > (Month_First_Combo+6))
BMI_after_Combo <- BMI_after_Combo %>% group_by(patient) %>% summarize(across(everything(), min))
names(BMI_after_Combo)[4] <- "Month_After"
names(BMI_after_Combo)[3] <- "BMI_After"

#join the before and after BMI
BMI_Combo_BEFORE_vs_AFTER <- BMI_before_Combo %>% full_join(BMI_after_Combo)
BMI_Combo_BEFORE_vs_AFTER <- BMI_Combo_BEFORE_vs_AFTER %>% na.omit()

mean(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) # 113.1557
mean(BMI_Combo_BEFORE_vs_AFTER$BMI_After) # 100.8588

median(BMI_Combo_BEFORE_vs_AFTER$BMI_Prior) # 109.999
median(BMI_Combo_BEFORE_vs_AFTER$BMI_After) # 100.4

write.csv(BMI_Combo_BEFORE_vs_AFTER, "BODYWEIGHT_Combo_BEFORE_vs_AFTER_closest_6months_Big_SGLT_GLP1Inj_only.csv")







# --------
# How long do patients stay therapy ? --------------------------
BODYWEIGHT_Evolution_US_All_6months_2_classes_only <- fread("BODYWEIGHT_Evolution_US_All_6months_2_classes_only.csv")


# GLP1 Injectable
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were GLP1 pats ON GLP1 Injectable ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate_if(grepl(string_InjectableGLP1,.), ~replace(., grepl(string_InjectableGLP1, .), "GLP"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

GLP1_Injectable_Pats <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="GLP1") %>%
  filter(Month>0) %>% select(patient, Exact_month)

GLP1_Histories_GLP1 <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(GLP1_Injectable_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

GLP1_Histories_GLP1 %>% summarise(n=mean(n)) #  6.52
GLP1_Histories_GLP1 %>% summarise(n=median(n)) #  6
GLP1_Histories_GLP1 %>% summarise(n=max(n)) #  35
GLP1_Histories_GLP1 %>% summarise(n=min(n)) #  1

GLP1_Histories_GLP1 %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON GLP1 until Body Weight read")+ylab("Proportion \n")





# Combo
# read table in wide format from months 1 to 60
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories)

# select only columns with the months / drugs
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(4:63)

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
DANU_Ingredients <- DANU_Ingredients %>% select(drug_id, drug_group)
DANU_Ingredients$drug_id <- as.character(DANU_Ingredients$drug_id)
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")

# How long were combo pats ON Combo ?
DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl(string_InjectableGLP1,.)&grepl(string_SGLT2,.), ~replace(., grepl(string_InjectableGLP1, .)&grepl(string_SGLT2,.), "Combo"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="Combo",1,0))

DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

# original table again, to go fetch the patient ID and weight
DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")

DIA_Drug_Histories_LONG <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)

#add those columns
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

#convert to long format
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient, Month)

#select those months ON Combo
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat == 1)

#recode the months, so that we can do comparisions/sortings
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))

Combo_Pats <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only %>% filter(Therapy=="Combo") %>%
  filter(Month>0) %>% select(patient, Exact_month)

Combo_Histories_Combo <- DIA_Drug_Histories %>% select(-weight) %>% group_by(patient) %>% inner_join(Combo_Pats) %>%
  filter(Month<=Exact_month) %>% group_by(patient) %>% count() %>% ungroup()

Combo_Histories_Combo %>% summarise(n=mean(n)) #  7.24
Combo_Histories_Combo %>% summarise(n=median(n)) #  8
Combo_Histories_Combo %>% summarise(n=max(n)) #  30
Combo_Histories_Combo %>% summarise(n=min(n)) #  1

Combo_Histories_Combo %>% ggplot(aes(n)) + geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Months ON Combo until BMI read")+ylab("Proportion \n")




names(GLP1_Histories_GLP1)[1] <- "patient" 
names(GLP1_Histories_GLP1)[2] <- "Time_Treated" 
GLP1_Histories_GLP1 <- GLP1_Histories_GLP1 %>% mutate(Therapy = "GLP1")

names(Combo_Histories_Combo)[1] <- "patient" 
names(Combo_Histories_Combo)[2] <- "Time_Treated" 
Combo_Histories_Combo <- Combo_Histories_Combo %>% mutate(Therapy = "Combo")

BODYWEIGHT_Evolution_US_All_6months_2_classes_only <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only %>%
  left_join(GLP1_Histories_GLP1, by=c("patient"="patient", "Therapy"="Therapy")) %>% 
  left_join(Combo_Histories_Combo, by=c("patient"="patient", "Therapy"="Therapy")) 


BODYWEIGHT_Evolution_US_All_6months_2_classes_only <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only %>% 
  mutate(Duration=ifelse(!is.na(Time_Treated.x), Time_Treated.x,
                         ifelse(!is.na(Time_Treated.y), Time_Treated.y, NA))) %>%
  select(-c(Time_Treated.x, Time_Treated.y))

BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Before <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only %>% filter(Period=="Before")
names(BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Before)[2] <- "Month_Before"
names(BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Before)[3] <- "BMI_Before"
names(BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Before)[4] <- "Exact_Month_Before"
BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Before <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Before %>% select(-c(Period, Duration))

BODYWEIGHT_Evolution_US_All_6months_2_classes_only_After <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only %>% filter(Period=="After")
names(BODYWEIGHT_Evolution_US_All_6months_2_classes_only_After)[2] <- "Month_After"
names(BODYWEIGHT_Evolution_US_All_6months_2_classes_only_After)[3] <- "BMI_After"
names(BODYWEIGHT_Evolution_US_All_6months_2_classes_only_After)[4] <- "Exact_Month_After"
BODYWEIGHT_Evolution_US_All_6months_2_classes_only_After <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only_After %>% select(-c(Period))


BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Duration <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Before %>% 
  left_join(BODYWEIGHT_Evolution_US_All_6months_2_classes_only_After, by=c("patient"="patient","Therapy"="Therapy"))



BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Duration <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Duration %>% select(1,2,6,3,7,4,8,9,5)

fwrite(BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Duration, "BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")



# ---------
# BMI reductions ~ treatment duration -------------------

BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Duration <- fread("BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Duration.txt", sep="\t")




BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Duration %>% filter(Duration>=Month_After) %>% 
  #filter(BMI_Before>24)%>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  group_by(Therapy) %>% summarise(n=mean(Difference))

BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Duration %>% filter(Duration>=Month_After) %>% 
  #filter(BMI_Before>24)%>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  group_by(Therapy) %>% count()



BODYWEIGHT_Evolution_2classes <- BODYWEIGHT_Evolution_US_All_6months_2_classes_only_Duration %>% 
  #filter(BMI_Before>24)%>%
  filter(Duration>=Month_After) 



BODYWEIGHT_Evolution_2classes %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("GLP1","Combo"))) %>%
  ggplot(aes(Difference, colour=Therapy, fill=Therapy)) + 
  geom_density(size=2, alpha=0.8) +
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        title = element_blank())+
  xlab("\n % Body Weight Reduction")+ylab(" Cohort Proportion \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()





BODYWEIGHT_Evolution_2classes %>%
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>%
  mutate(Therapy=factor(Therapy)) %>% 
  mutate(Therapy=fct_relevel(Therapy,c("GLP1","Combo"))) %>%
  ggplot(aes(BMI_Before, BMI_After, colour=Therapy, fill=Therapy)) + 
  geom_point(size=3, alpha=0.5)+
  geom_smooth(method="lm")+
  xlim(50, 200)+ylim(50,200)+
  geom_abline(slope=1, intercept = 0)+
  facet_wrap(~Therapy)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Body Weight Before Therapy")+ylab(" Body Weight After Therapy \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()





# Reduction ~ Baseline BMI


# GLP1 

GLP1_temp <- BODYWEIGHT_Evolution_2classes %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>% 
  filter(Therapy=="GLP1") %>% select(BMI_Before, Difference)

model_GLP1 <- lm(Difference ~ BMI_Before, data = GLP1_temp)

summary(model_GLP1)

Call:
  lm(formula = Difference ~ BMI_Before, data = GLP1_temp)

# Combo 

Combo_temp <- BODYWEIGHT_Evolution_2classes %>% 
  mutate(Difference= (BMI_After-BMI_Before)*100/BMI_Before) %>% 
  filter(Therapy=="Combo") %>% select(BMI_Before, Difference)

model_Combo <- lm(Difference ~ BMI_Before, data = Combo_temp)

summary(model_Combo)

BODYWEGHT_Reduction_Predictions_ALL <- fread("BODYWEGHT_Reduction_Predictions_ALL.txt")

BODYWEGHT_Reduction_Predictions_ALL <- gather(BODYWEGHT_Reduction_Predictions_ALL, Therapy, Reduction, GLP1:Combo, factor_key=TRUE)

ggplot(data=BODYWEGHT_Reduction_Predictions_ALL, aes(x=Baseline_Weight  , y=Reduction, colour=Therapy)) + 
  geom_smooth(size=2) +
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  xlab("\n Baseline BMI")+ylab(" % BMI Reduction \n")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()





BODYWEGHT_Reduction_Predictions_ALL %>% select(Therapy, Baseline_Weight) %>%
  ggplot(aes(Baseline_Weight))+
  geom_density(size=2, colour="deepskyblue4", fill="deepskyblue4", alpha=0.8)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())+
  facet_wrap(~Therapy)





# ----------------
# Number of months / lines until each class initiation 60, 48, 36 or 24m ------------
# Drugs / Classes to lookup
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))

DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% filter(Month<=12)
DIA_Drug_Histories <-  DIA_Drug_Histories %>% filter(Drugs == "-")

# Naive until 12m, apts to track
Naive_until_12 <- DIA_Drug_Histories %>% group_by(patient) %>% count() %>% filter(n==12) %>% select(patient)


# Number of months 60, 48, 36 or 24m ------------------------------------------------------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")



DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Month<=24)

# Time to first  Biguanide
DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Biguanide,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Biguanide,Drugs)) else NA) 

DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories_Biguanide %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_Biguanide %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Biguanide %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 2.32

# Time to first  Antidiabetic
DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Antidiabetic,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Antidiabetic,Drugs)) else NA) 

DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories_Antidiabetic %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 6.89


# Time to first  DPP4
DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_DPP4,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_DPP4,Drugs)) else NA) 

DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories_DPP4 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_DPP4 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_DPP4 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 9.78


# Time to first  SGLT2
DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_SGLT2,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_SGLT2,Drugs)) else NA) 

DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories_SGLT2 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
data.frame(DIA_Drug_Histories_SGLT2 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight)))
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 14.9


# Time to first  Insulin
DIA_Drug_Histories_Insulin <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Insulin,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Insulin,Drugs)) else NA) 

DIA_Drug_Histories_Insulin <- DIA_Drug_Histories_Insulin %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_Insulin %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Insulin %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 6.26


# Time to first  OralGLP1
DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_OralGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_OralGLP1,Drugs)) else NA) 

DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories_OralGLP1 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 33.3


# Time to first  InjectableGLP1
DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_InjectableGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_InjectableGLP1,Drugs)) else NA) 

DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories_InjectableGLP1 %>% group_by(patient, weight) %>% count() %>% arrange(-n)
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 15.5



# Number of lines 60, 48, 36 or 24m ------

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Month<=24)

# Lines to first  Biguanide
DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Biguanide,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Biguanide,Drugs)) else NA) 

DIA_Drug_Histories_Biguanide <- DIA_Drug_Histories_Biguanide %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_Biguanide %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Biguanide %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.18


# Time to first  Antidiabetic
DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Antidiabetic,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Antidiabetic,Drugs)) else NA) 

DIA_Drug_Histories_Antidiabetic <- DIA_Drug_Histories_Antidiabetic %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Antidiabetic %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.63

# Time to first  DPP4
DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_DPP4,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_DPP4,Drugs)) else NA) 

DIA_Drug_Histories_DPP4 <- DIA_Drug_Histories_DPP4 %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_DPP4 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_DPP4 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.98

# Time to first  SGLT2
DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_SGLT2,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_SGLT2,Drugs)) else NA) 

DIA_Drug_Histories_SGLT2 <- DIA_Drug_Histories_SGLT2 %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_SGLT2 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 2.68


# Time to first  Insulin
DIA_Drug_Histories_Insulin <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_Insulin,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_Insulin,Drugs)) else NA) 

DIA_Drug_Histories_Insulin <- DIA_Drug_Histories_Insulin %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_Insulin %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_Insulin %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 1.60


# Time to first  OralGLP1
DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_OralGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_OralGLP1,Drugs)) else NA) 

DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories_OralGLP1 %>% select(-c(Month)) %>% filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_OralGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 4.72


# Time to first  InjectableGLP1
DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_InjectableGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_InjectableGLP1,Drugs)) else NA) 

DIA_Drug_Histories_InjectableGLP1 <- DIA_Drug_Histories_InjectableGLP1 %>% select(-c(Month)) %>%  filter(Drugs!="-") %>% group_by(patient, weight) %>% distinct() %>% count() %>% arrange(-n)
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% group_by(n) %>% summarise(pats=sum(weight))
DIA_Drug_Histories_InjectableGLP1 %>% ungroup() %>% summarise(mean=weighted.mean(n, weight)) # 2.82




# X vs Y plot of months to class vs lines to class 60, 48, 36 or 24m -----------

Months_vs_Lines_to_class <- fread("Months_vs_Lines_to_class_60_to_24.txt")

library(ggrepel)
library(hrbrthemes)
library(viridis)

Months_vs_Lines_to_class <- Months_vs_Lines_to_class %>% select(10,11,12)
names(Months_vs_Lines_to_class) <- c("drug_class", "average_months_to_class_all", "average_lines_to_class_all")

ggplot(Months_vs_Lines_to_class, aes(x=average_months_to_class_all, y=average_lines_to_class_all, colour=drug_class)) +
  geom_point(alpha=0.7, size=5)+
  geom_text_repel(aes(label = drug_class), 
                  colour = "black", 
                  size = 3,
                  hjust = -1,
                  vjust=0.5,
                  fontface=2)+ 
  theme(legend.position = "none",
        panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.ticks = element_blank(),
        text = element_text(size = 10))+
  scale_colour_viridis_d(option = "D")+
  xlab("\nAverage Number of Months to Class Initiation")+
  ylab("Average Number of Therapy Lines to Class Initiation\n")















# -----

# Oral GLP1 Early Starters vs Late Starters ------------------------------------------------------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")


DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)
DIA_Drug_Histories     <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)


# Time to first  OralGLP1
DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories %>% group_by(patient, weight) %>% 
  slice(if(any(grepl(string_OralGLP1,Drugs))) which.max(!grepl("-",Drugs)):which.max(grepl(string_OralGLP1,Drugs)) else NA) 

DIA_Drug_Histories_OralGLP1 <- DIA_Drug_Histories_OralGLP1 %>% group_by(patient, weight) %>% count() %>% arrange(-n)

data.frame(DIA_Drug_Histories_OralGLP1 %>% filter(n>36 | n<12) %>% ungroup() %>% group_by(n) %>% count())

# Early Starters vs late Starters
OralGLP1Pats <- data.frame(DIA_Drug_Histories_OralGLP1 %>% filter(n>36 | n<12) %>% ungroup())
OralGLP1Pats <- OralGLP1Pats %>% ungroup() %>% mutate(Group = ifelse(n<12, "Early", "Late")) %>% select(patient, Group)

OralGLP1Pats %>% group_by(Group) %>% count()


MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_BMI,MAX_HbA1c ))

OralGLP1Pats <- OralGLP1Pats %>% left_join(MAX_Labs_Demographics)
#OralGLP1Pats <- OralGLP1Pats %>% drop_na()

OralGLP1Pats %>% group_by(Group) %>% count()
 
OralGLP1Pats %>% group_by(Group) %>% summarise(n=mean(MAX_BMI))


OralGLP1Pats %>% group_by(Group) %>% summarise(n=mean(MAX_HbA1c))


OralGLP1Pats %>% group_by(Group, gender) %>% count()


OralGLP1Pats <- OralGLP1Pats %>% mutate(gender = ifelse(gender=="M", 1, 0))

OralGLP1Pats <- OralGLP1Pats %>% select(-diagnosis)

OralGLP1Pats %>% group_by(Group) %>% count()

OralGLP1Pats < OralGLP1Pats %>% ungroup() %>% group_by(Group) %>% sample_n(97) %>% ungroup()

OralGLP1Pats$Group <- as.factor(OralGLP1Pats$Group)

OralGLP1Pats$Group <- relevel(OralGLP1Pats$Group,"Late")

OralGLP1Pats$Group <- as.numeric(OralGLP1Pats$Group)-1

OralGLP1Pats <- OralGLP1Pats %>% select(-patient)


OralGLP1Pats_lmr <- lrm(Group==1 ~ age+gender+MAX_BMI+MAX_HbA1c, data = OralGLP1Pats)

OralGLP1Pats_gbm <- gbm(Group == 1 ~ ., data = OralGLP1Pats, 
                n.trees = 15000, distribution = "bernoulli")
summary(OralGLP1Pats_gbm)


OralGLP1Pats_rf <- randomForest(Group ~ . , data = OralGLP1Pats)
summary(OralGLP1Pats_rf)
OralGLP1Pats_rf$importance
varImpPlot(OralGLP1Pats_rf)



# Comorbidities 

DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories <- OralGLP1Pats %>% select(patient) %>% left_join(DIA_Comorbidity_Inventories, by=c("patient"="patid"))
# DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% filter(!grepl("A", diagnosis) & !grepl("B", diagnosis) & !grepl("C", diagnosis) &
                                                                       # !grepl("O", diagnosis) & !grepl("P", diagnosis) & !grepl("Q", diagnosis) &
                                                                       # !grepl("R", diagnosis) & !grepl("S", diagnosis) & !grepl("T", diagnosis) &
                                                                       # !grepl("X", diagnosis) & !grepl("Y", diagnosis) & !grepl("Z", diagnosis))

DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% select(-weight)
unique(DIA_Comorbidity_Inventories$diagnosis)

# OralGLP1Pats %>% group_by(Group) %>% count()
# OralGLP1Pats <- OralGLP1Pats %>% group_by(Group) %>% sample_n(365) %>% ungroup()

DIA_Comorbidity_Inventories <- OralGLP1Pats %>% select(patient, Group) %>% left_join(DIA_Comorbidity_Inventories)
DIA_Comorbidity_Inventories$Comorb <- 1

DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% spread(key=diagnosis, value=Comorb)
DIA_Comorbidity_Inventories <- mutate_if(DIA_Comorbidity_Inventories, is.numeric, ~replace(., is.na(.), 0))

DIA_Comorbidity_Inventories$Group <- as.factor(DIA_Comorbidity_Inventories$Group)

DIA_Comorbidity_Inventories$Group <- relevel(DIA_Comorbidity_Inventories$Group,"Late")

temp <- DIA_Comorbidity_Inventories

DIA_Comorbidity_Inventories$Group <- as.numeric(DIA_Comorbidity_Inventories$Group)-1
DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% select(-3)
DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% select(-patient)


library("randomForest")
EarlyvsLate_rf <- randomForest(Group ~ . , data = DIA_Comorbidity_Inventories)
summary(EarlyvsLate_rf)
varImpPlot(EarlyvsLate_rf)
temp <- EarlyvsLate_rf$importance

library("gbm")
EarlyvsLate_gbm <- gbm(Group == 1 ~ ., data = DIA_Comorbidity_Inventories, 
                n.trees = 15000, distribution = "bernoulli")
summary(EarlyvsLate_gbm)



library("rms")
EarlyvsLate_lmr <- lrm(Group == 1 ~ ., data = DIA_Comorbidity_Inventories)
glm <- glm(Group==1 ~., data=DIA_Comorbidity_Inventories)
summary(glm)


# ---------------------------------------------------------------------------
# Disease penentrance Oral GLP1 vs Inj GLP1 vs GLP1 naive------------------------------------------
Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Oral_Pats <- Cum_Class_Experience_EveryMonth %>% filter(p1_OralExp==1) %>% select(patient)
Injectable_Pats <- Cum_Class_Experience_EveryMonth %>% filter(p1_InjExp==1) %>% select(patient)
Naive_Pats <- Cum_Class_Experience_EveryMonth %>% filter(p1_InjExp==0&p1_OralExp==0) %>% select(patient)

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Oral_Pats <- Oral_Pats %>% inner_join(Treatment_exp_Vector)
Injectable_Pats <- Injectable_Pats %>% inner_join(Treatment_exp_Vector)
Naive_Pats <- Naive_Pats %>% inner_join(Treatment_exp_Vector)

sum(Oral_Pats$weight)  # 264137.4
sum(Injectable_Pats$weight) # 5373357
sum(Naive_Pats$weight) # 25088485


DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories <- Treatment_exp_Vector %>% select(patient) %>% left_join(DIA_Comorbidity_Inventories, by=c("patient"="patid"))
DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% filter(!grepl("A", diagnosis) & !grepl("B", diagnosis) & !grepl("C", diagnosis) &
                                                                       !grepl("O", diagnosis) & !grepl("P", diagnosis) & !grepl("Q", diagnosis) &
                                                                       !grepl("R", diagnosis) & !grepl("S", diagnosis) & !grepl("T", diagnosis) &
                                                                       !grepl("X", diagnosis) & !grepl("Y", diagnosis) & !grepl("Z", diagnosis))

DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% mutate(diagnosis=str_sub(diagnosis, 1L, 2L)) %>% distinct()

Oral_Pats <- Oral_Pats %>% left_join(DIA_Comorbidity_Inventories) %>% drop_na()
Injectable_Pats <- Injectable_Pats %>% left_join(DIA_Comorbidity_Inventories) %>% drop_na()
Naive_Pats <- Naive_Pats %>% left_join(DIA_Comorbidity_Inventories) %>% drop_na()


Oral_Pats <- Oral_Pats %>% group_by(diagnosis) %>% summarise(n=sum(weight)) %>% mutate(penetrance=100*n/264137.4) %>% select(-n)
names(Oral_Pats)[1] <- "Last"
names(Oral_Pats)[2] <- "Penetrance_OralExp"


Injectable_Pats <- Injectable_Pats %>% group_by(diagnosis) %>% summarise(n=sum(weight)) %>% mutate(penetrance=100*n/5373357) %>% select(-n)
names(Injectable_Pats)[1] <- "Last"
names(Injectable_Pats)[2] <- "Penetrance_InjExp"


Naive_Pats <- Naive_Pats %>% group_by(diagnosis) %>% summarise(n=sum(weight)) %>% mutate(penetrance=100*n/25088485) %>% select(-n)
names(Naive_Pats)[1] <- "Last"
names(Naive_Pats)[2] <- "Penetrance_Naive"

All_Comorbidities <- Oral_Pats %>% 
  full_join(Injectable_Pats) %>% 
  full_join(Naive_Pats) %>%
  drop_na() 

All_Comorbidities <- All_Comorbidities %>% 
  mutate(diff_Inj_to_Naive = Penetrance_InjExp-Penetrance_Naive) %>%
  mutate(diff_oral_to_Naive = Penetrance_OralExp-Penetrance_Naive) %>%
  mutate(diff_Inj_to_Oral = Penetrance_InjExp-Penetrance_OralExp) 
  
fwrite(All_Comorbidities, "DiseasePenetrance_OralGLp1_InjGLP1_NaiveGLP1.csv")

# ------------------
# HbA1c per stock at the time of read -------------
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(test=="HbA1c Level")
setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by = c("Month_Yr" = "Month")) %>% filter(!is.na(Exact_Month)) 
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, weight, Exact_Month, value)
Last_read <- DANU_Measures_HbA1c %>% group_by(patid) %>% slice(n())
names(Last_read)[1] <- "patient"

DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p2, s2)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(p2 = as.numeric(p2)) 
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-weight)
names(DIA_Flows_Aux._Long)[2] <- "Exact_Month"

Last_read <- Last_read %>% left_join(DIA_Flows_Aux._Long, by=c("patient"="patient", "Exact_Month"="Exact_Month")) %>% drop_na()
Last_read <- Last_read %>% mutate(value=ifelse(value<7.5,"<7.5", ">7.5"))

Last_read %>% group_by(s2, value) %>% summarise(n=sum(weight)) %>% ungroup() %>%
  group_by(s2) %>% mutate(TOTAL=sum(n)) %>% ungroup() %>%
  mutate(percentage=n/TOTAL) %>%
  select(s2, value, percentage) %>%
  spread(key=s2, value=percentage)



# --------------------------------
# % of inflows Oral/Injectable from Injectable/Oral --------------------------------------------------------------------------------------------------------

DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(patient, weight, p1, p2, s1, s2, flow)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(flow=="1")

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(s1=ifelse(s1=="g",s1,
                                                         ifelse(s1=="G",s1,"other"))) %>%
                                               mutate(s2=ifelse(s2=="g",s2,
                                                         ifelse(s2=="G",s2,"other"))) 

data.frame(DIA_Flows_Aux._Long %>% filter(s2=="g") %>% group_by(p2,s1) %>% summarise(n=sum(weight))) %>%
  spread(key=s1,value=n)

data.frame(DIA_Flows_Aux._Long %>% filter(s2=="G") %>% group_by(p2,s1) %>% summarise(n=sum(weight))) %>%
  spread(key=s1,value=n)

# ---------------------------------------------------------------------------------------------------------------------

# % specialties over time -  GLP1s ---------------------------------------------------------------------------

Dia_US_Doses <- fread("DIA Doses.txt")
Provs_unique <- Dia_US_Doses %>% select(prov, specialty) %>% distinct()
PROVCAT <- fread("PROVCAT.txt", sep="|")
PROVCAT$PROVCAT <- sub("^0+", "", PROVCAT$PROVCAT)  
PROVCAT <- PROVCAT %>% mutate(PROVCAT = ifelse(PROVCAT=="","0",PROVCAT))
PROVCAT$PROVCAT <- as.numeric(PROVCAT$PROVCAT)
Specialties_to_keep <- fread("Specialties_to_keep.txt")
Provs_unique <- Provs_unique %>% left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN), by=c("specialty"="specialty")) 

Provs_unique <- Provs_unique %>% drop_na() %>% filter(!PHYSICIAN=="FACILITY") %>% 
  mutate(PHYSICIAN=ifelse(PHYSICIAN=="PCP"|PHYSICIAN=="INTERNAL MEDICINE","GP",
                          ifelse(PHYSICIAN=="ENDOCRINOLOGY","ENDOCRINOLOGY","OTHER")))

Provs_unique <- Provs_unique %>% select(prov, PHYSICIAN)
names(Provs_unique)[2] <- "Specialty"


Dia_US_Doses <- fread("DIA Doses.txt")
Dia_US_Doses <- Dia_US_Doses %>% filter(status != "G")
Dia_US_Doses <- Dia_US_Doses %>% select(drug_class,from_dt, prov)
Dia_US_Doses <- Dia_US_Doses %>% inner_join(Provs_unique)
Dia_US_Doses$from_dt <- as.Date(Dia_US_Doses$from_dt)

Dia_US_Doses <- Dia_US_Doses %>% mutate(Year=ifelse(from_dt>="2020-05-01" &  from_dt<"2021-05-01","Year5",
                                    ifelse(from_dt<"2020-05-01"&from_dt>="2019-05-01", "Year4",
                                           ifelse(from_dt<"2019-05-01"&from_dt>="2018-05-01", "Year3",
                                                  ifelse(from_dt<"2018-05-01"&from_dt>="2017-05-01","Year2",
                                                         ifelse(from_dt>="2016-05-01"&from_dt<"2017-05-01","Year1", NA))))))

Dia_US_Doses <- Dia_US_Doses %>% drop_na()
Dia_US_Doses <- Dia_US_Doses %>% mutate(drug_class=ifelse(grepl("GLP1",drug_class), "GLP1", "Other"))


Dia_US_Doses %>% select(prov, Specialty, Year) %>% distinct() %>%
  group_by(Year, Specialty) %>% count() %>% 
  left_join(
    Dia_US_Doses %>% filter(drug_class=="GLP1") %>% select(prov, Specialty, Year) %>% distinct()  %>% group_by(Year, Specialty) %>% count(), 
    by=c("Year"="Year", "Specialty"="Specialty")) %>%
  mutate(Percentage=n.y/n.x)

Dia_US_Doses %>% group_by(Year, Specialty) %>% count() %>% 
  left_join(
    Dia_US_Doses %>% filter(drug_class=="GLP1") %>% group_by(Year, Specialty) %>% count(), 
    by=c("Year"="Year", "Specialty"="Specialty")) %>%
  mutate(Percentage=n.y/n.x)

Dia_US_Doses %>% filter(drug_class=="GLP1") %>% group_by(Year, Specialty) %>% count()



Dia_US_Doses %>% filter(drug_class=="GLP1") %>% 
  group_by(Year) %>% count() %>%
  left_join(Dia_US_Doses %>% filter(drug_class=="GLP1") %>% 
  group_by(Year, Specialty) %>% count(), by=c("Year"="Year", "Specialty"="Specialty"))

data.frame(Dia_US_Doses %>% filter(drug_class=="GLP1") %>% 
  group_by(Year, Specialty) %>% count() %>% spread(key=Year, value=n))


Dia_US_Doses %>% filter(drug_class=="GLP1") %>% select(prov, Specialty, Year) %>% distinct()  %>% 
  group_by(Year, Specialty) %>% count() %>%
  left_join(Dia_US_Doses %>% filter(drug_class=="GLP1") %>% 
              group_by(Year, Specialty) %>% count(), 
                                                                                                                                                      by=c("Year"="Year", "Specialty"="Specialty")) %>% 
  mutate(ScriptPerPhysi = n.y/n.x)


# -------------------------------------------------------------

# HbA1c Last vs Stock - Projected to the 30,626k ---------------------------------------------------------------


DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(test=="HbA1c Level") %>% select(patid, value, claimed)
DANU_Measures_HbA1c$claimed <- as.Date(DANU_Measures_HbA1c$claimed)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% group_by(patid) %>% filter(claimed==max(claimed)) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()

setDT(DANU_Measures_HbA1c)[, Month_Yr := format(as.Date(claimed), "%Y-%m") ]
Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(Months_lookup, by=c("Month_Yr"="Month"))

DIA_Box_Histories     <- fread("DIA Box Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Box, month1:month60, factor_key=TRUE)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Box = str_sub(Box, 2L, 2L))
DIA_Box_Histories$Month <- as.character(DIA_Box_Histories$Month)
DIA_Box_Histories$Month <- parse_number(DIA_Box_Histories$Month)
DIA_Box_Histories <- DIA_Box_Histories %>% select(patient, weight, Month, Box)

DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% left_join(DIA_Box_Histories, by=c("patid"="patient", "Exact_Month"="Month")) %>% drop_na()
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, value, weight, Box)

DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% mutate(value=ifelse(value<6,"<6",
                                            ifelse(value>=6&value<6.5,"6-6.5",
                                                   ifelse(value>=6.5&value<7,"6.5-7",
                                                          ifelse(value>=7&value<7.5,"7-7.5",
                                                                 ifelse(value>=7.5&value<8,"7.5-8",
                                                                        ifelse(value>=8&value<8.5,"8-8.5",
                                                                               ifelse(value>=8.5&value<9,"8.5-9",">9")))))))) 

Treatment_Exp_vector <- fread("Treatment_Exp_vector.txt")
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% inner_join(Treatment_Exp_vector, by=c("patid"="patient"))

DANU_Measures_HbA1c %>% group_by(Box, value) %>% summarise(n=sum(weight.x)) %>% ungroup() %>% spread(key=value, value=n)


DANU_Measures_HbA1c %>% mutate(Box=ifelse(Box=="x"|Box=="b"|Box=="d","Early",
                                          ifelse(Box=="D"|Box=="S", "Interm",
                                                 ifelse(Box=="g"|Box=="G","GLP1","Insulin")))) %>% 
  group_by(Box, value) %>% summarise(n=sum(weight.x)) %>% ungroup() %>% spread(key=value, value=n)

Stock_vs_NeedHbA1c <- fread("Stock_vs_NeedHbA1c_Dec1.csv")
#Stock_vs_NeedHbA1c <- gather(Stock_vs_NeedHbA1c , Need, Pop, 2:9, factor_key=TRUE)
colnames(Stock_vs_NeedHbA1c)
row.names(Stock_vs_NeedHbA1c) <- Stock_vs_NeedHbA1c$Box
row.names(Stock_vs_NeedHbA1c)
Stock_vs_NeedHbA1c <- Stock_vs_NeedHbA1c[,2:9]
row.names(Stock_vs_NeedHbA1c) <- c("Early Therapies","Intermediate Therapies","GLP1s","Insulins")

grid.bubble.plot <- function(df, 
                             axis_labels_size=16, 
                             aspect_ratio=1/3,
                             values_text_size=5,
                             values_text_color="black",
                             x_axis_position="top", # or "bottom",
                             bubble_size_range=c(5, 50),
                             bubble_alpha=0.7,
                             bubble_shape=21,
                             bubble_edge_stroke=0.01) {
  col_names <- colnames(df)
  row_names <- rownames(df)
  values <- as.vector(as.matrix(df))
  values_x <- as.vector(sapply(col_names, function(i) rep(i, nrow(Stock_vs_NeedHbA1c))))
  values_y <- as.vector(rep(row_names, dim(df)[2]))
  res_df <- data.frame(values = values, values_x = values_x, values_y)
 res_df <- data.frame(res_df %>%
                        mutate(values_y=fct_relevel(values_y,c("Early Therapies","Intermediate Therapies","GLP1s","Insulins"))))
  gg <- ggplot(res_df, aes(x=values_x, y=values_y, size = values, fill=factor(values_x))) +
    geom_point(alpha=bubble_alpha, shape=bubble_shape, stroke=bubble_edge_stroke) +
    scale_size(range = bubble_size_range) +
    scale_fill_brewer(palette = "RdYlBu") +
    scale_x_discrete(position = x_axis_position) +
    scale_y_discrete(limits=rev)+
    geom_text(aes(label=paste0(values," k") ), size=values_text_size, color=values_text_color, fontface = "bold") +
    theme(line=element_blank(), 
          panel.background=element_blank(),
          legend.position="none",
          axis.title=element_blank(),
          axis.text=element_text(size=axis_labels_size),
          aspect.ratio=aspect_ratio)
  gg
}

grid.bubble.plot(Stock_vs_NeedHbA1c)



# ---------------------------------------------------------------------------------------
# CKD and PAD in Diabetes and Obesity ---------------------------------------
DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")

CKD_pats <- DIA_Comorbidity_Inventories %>% filter(diagnosis=="N18") %>% select(patid) %>% distinct()
PAD_pats <- DIA_Comorbidity_Inventories %>% filter(diagnosis=="I70"|diagnosis=="I73") %>% select(patid) %>% distinct()

DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% select(patid, weight, diagnosis)
unique(DANU_Demographics$diagnosis)
DANU_Demographics <- DANU_Demographics %>% filter(diagnosis=="Diabetes"|diagnosis=="Obesity"|diagnosis=="Diabetes + Obesity")


DANU_Demographics %>% filter(diagnosis=="Diabetes"|diagnosis=="Diabetes + Obesity") %>% summarise(n=sum(weight)) # 48232675
DANU_Demographics %>% filter(diagnosis=="Diabetes"|diagnosis=="Diabetes + Obesity") %>% inner_join(CKD_pats) %>% summarise(n=sum(weight)) # 10101923
DANU_Demographics %>% filter(diagnosis=="Diabetes"|diagnosis=="Diabetes + Obesity") %>% inner_join(PAD_pats) %>% summarise(n=sum(weight)) # 11109066




OBE_Comorbidity_Inventories <- fread("OBE Comorbidity Inventories.txt")

CKD_pats <- OBE_Comorbidity_Inventories %>% filter(diagnosis=="N18") %>% select(patid) %>% distinct()
PAD_pats <- OBE_Comorbidity_Inventories %>% filter(diagnosis=="I70"|diagnosis=="I73") %>% select(patid) %>% distinct()

DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% select(patid, weight, diagnosis)
unique(DANU_Demographics$diagnosis)
DANU_Demographics <- DANU_Demographics %>% filter(diagnosis=="Diabetes"|diagnosis=="Obesity"|diagnosis=="Diabetes + Obesity")


DANU_Demographics %>% filter(diagnosis=="Obesity") %>% summarise(n=sum(weight)) # 106469049
DANU_Demographics %>% filter(diagnosis=="Obesity") %>% inner_join(CKD_pats) %>% summarise(n=sum(weight)) # 5860767
DANU_Demographics %>% filter(diagnosis=="Obesity") %>% inner_join(PAD_pats) %>% summarise(n=sum(weight)) # 4655224

# ----------------------------------------------------------
# Short vs Long persitency ON GLP1 INjetcbale - TOlerabitlity ' -------------------------------------------------

DIA_Drug_Histories <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)


Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60)  %>% filter(p1_InjExp==1) %>% select(patient)
DIA_Drug_Histories <- Cum_Class_Experience_EveryMonth %>% left_join(DIA_Drug_Histories)

DIA_Drug_Histories     <- DIA_Drug_Histories %>% select(-c(disease))
DIA_Drug_Histories <-  DIA_Drug_Histories %>%  select(3:62)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  mutate_if(grepl('48',.), ~replace(., grepl('48', .), "GLP1 Injectable"))%>% 
  mutate_if(grepl('49',.), ~replace(., grepl('49', .), "GLP1 Injectable"))%>% 
  mutate_if(grepl('50',.), ~replace(., grepl('50', .), "GLP1 Injectable"))%>% 
  mutate_if(grepl('51',.), ~replace(., grepl('51', .), "GLP1 Injectable"))%>% 
  mutate_if(grepl('52',.), ~replace(., grepl('52', .), "GLP1 Injectable"))%>% 
  mutate_if(grepl('53',.), ~replace(., grepl('53', .), "GLP1 Injectable"))

DIA_Drug_Histories <-  DIA_Drug_Histories %>% mutate_all(function(x) ifelse(x=="GLP1 Injectable",1,0))
DIA_Drug_Histories[] <-  lapply(DIA_Drug_Histories,as.numeric)

DIA_Drug_Histories_LONG <- read.table("DIA Drug Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)

Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt", colClasses = "character", stringsAsFactors = FALSE)
DIA_Drug_Histories_LONG     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories_LONG)
Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60)  %>% filter(p1_InjExp==1) %>% select(patient)
DIA_Drug_Histories_LONG <- Cum_Class_Experience_EveryMonth %>% left_join(DIA_Drug_Histories_LONG)

DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(patient, weight)
DIA_Drug_Histories <- DIA_Drug_Histories_LONG %>% bind_cols(DIA_Drug_Histories)
rm(DIA_Drug_Histories_LONG)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% arrange(patient)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories <- DIA_Drug_Histories %>% ungroup() %>% filter(Treat == 1)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% filter(grp==min(grp)) %>% select(-Treat)

DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% filter(Month==min(Month)) %>% filter(Month<=48) %>%
  select(patient) %>% left_join(DIA_Drug_Histories)

DIA_Drug_Histories %>% select(patient, weight) %>% distinct() %>% ungroup() %>% summarise(n=sum(as.numeric(weight))) # 4153990




DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% count() %>% filter(n<=3|n>=12) %>%
  mutate(n=ifelse(n<=3,"<3",
                  ifelse(n>=12,">12",NA))) %>% left_join(DIA_Drug_Histories) %>%
  ungroup() %>% group_by(patient) %>% filter(Month==max(Month)) %>% select(-grp)

GLP1_Hist <- DIA_Drug_Histories %>% mutate(Month=Month+1)

DIA_Box_Histories <- read.table("DIA Box Histories.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)
DIA_Box_Histories <- GLP1_Hist %>% select(patient) %>% left_join(DIA_Box_Histories)
DIA_Box_Histories <- gather(DIA_Box_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Box_Histories <- DIA_Box_Histories %>% mutate(Treat = str_sub(Treat, 2L, 2L))
DIA_Box_Histories$Month <- as.character(DIA_Box_Histories$Month)
DIA_Box_Histories$Month <- parse_number(DIA_Box_Histories$Month)
DIA_Box_Histories <- DIA_Box_Histories %>% select(patient, Month, Treat)

GLP1_Hist <- GLP1_Hist %>% left_join(DIA_Box_Histories)
GLP1_Hist <- GLP1_Hist %>% drop_na()
GLP1_Hist %>% ungroup() %>% group_by(n) %>% summarise(n2=sum(as.numeric(weight)))
 

GLP1_Hist %>% ungroup() %>% group_by(n, Treat) %>% summarise(n2=sum(as.numeric(weight))) %>%
  spread(key=Treat, value=n2)

 

# --------------------------------------------------------------
# Diabetes with ASCVD -------------------------------------------------------------------------------

DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")

ASCVD_pats <- DIA_Comorbidity_Inventories %>% filter(diagnosis=="G45"|
                                                     diagnosis=="I20"|
                                                     diagnosis=="I21"|
                                                     diagnosis=="I22"|
                                                     diagnosis=="I23"|
                                                     diagnosis=="I24"|
                                                     diagnosis=="I25"|
                                                     diagnosis=="I63"|
                                                     diagnosis=="I65"|
                                                     diagnosis=="I66"|
                                                     diagnosis=="I67"|
                                                     diagnosis=="I69"|
                                                     diagnosis=="Z95") %>% select(patid) %>% distinct()

DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% select(patid, weight)

ASCVD_pats <- ASCVD_pats %>%  left_join(DANU_Demographics)

sum(ASCVD_pats$weight) # 19456157



Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60)  %>% filter(p1_InjExp==1) %>% select(patient)
Cum_Class_Experience_EveryMonth$GLP1INJExp <- "Glp1InjExp"

ASCVD_pats <- ASCVD_pats %>% left_join(Cum_Class_Experience_EveryMonth, by=c("patid"="patient"))

ASCVD_pats %>% group_by(GLP1INJExp) %>% summarise(n=sum(weight))


DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% filter(p2==60) %>% select(patient, s2) %>% filter(s2=="G") %>% select(-s2) %>% mutate(GLP1m60="GLP1m60")

ASCVD_pats <- ASCVD_pats %>% left_join(DIA_Flows_Aux._Long, by=c("patid"="patient"))

ASCVD_pats %>% group_by(GLP1m60) %>% summarise(n=sum(weight))

Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt", colClasses = "character", stringsAsFactors = FALSE)
ASCVD_pats <- Treatment_exp_Vector %>% select(patient) %>% inner_join(ASCVD_pats, by=c("patient"="patid"))

sum(ASCVD_pats$weight) # 11707890

ASCVD_pats %>% group_by(GLP1INJExp) %>% summarise(n=sum(weight))

ASCVD_pats %>% group_by(GLP1m60) %>% summarise(n=sum(weight))

# ---------------------------------------
# Who has SGLT2 vs GLP1 --------------------------------------------------------------------------
MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_BMI,MAX_HbA1c ))

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(Dems_Labs_TreatExp)

LiverKidneyHeart_Diseases_Pen <- fread("LiverKidneyHeartFailureonly_Diseases_Pen.txt", sep="\t")
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(LiverKidneyHeart_Diseases_Pen, by=c("patient"="patid"))
Dems_Labs_TreatExp[is.na(Dems_Labs_TreatExp)] <- 0

# DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
# DIA_Comorbidity_Inventories <- Treatment_exp_Vector %>% select(patient) %>% left_join(DIA_Comorbidity_Inventories, by=c("patient"="patid"))
# 
# DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% select(-weight) %>% filter(diagnosis=="G45"|
#                                                      diagnosis=="I20"|
#                                                      diagnosis=="I21"|
#                                                      diagnosis=="I22"|
#                                                      diagnosis=="I23"|
#                                                      diagnosis=="I24"|
#                                                      diagnosis=="I25"|
#                                                      diagnosis=="I63"|
#                                                      diagnosis=="I65"|
#                                                      diagnosis=="I66"|
#                                                      diagnosis=="I67"|
#                                                      diagnosis=="I69"|
#                                                      diagnosis=="Z95"|
#                                          diagnosis=="N00"|
#                                          diagnosis=="N01"|
#                                          diagnosis=="N02"|
#                                          diagnosis=="N03"|
#                                          diagnosis=="N04"|
#                                          diagnosis=="N05"|
#                                          diagnosis=="N06"|
#                                          diagnosis=="N07"|
#                                          diagnosis=="N08"|
#                                          diagnosis=="N09"|
#                                          diagnosis=="N10"|
#                                          diagnosis=="N11"|
#                                          diagnosis=="N12"|
#                                          diagnosis=="N13"|
#                                          diagnosis=="N14"|
#                                          diagnosis=="N15"|
#                                          diagnosis=="N16"|
#                                          diagnosis=="N17"|
#                                          diagnosis=="N18"|
#                                          diagnosis=="N19")
# 
# DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% mutate(label=1) %>% spread(key=diagnosis, value=label) 
# DIA_Comorbidity_Inventories[is.na(DIA_Comorbidity_Inventories)] <-0
# 
# Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(DIA_Comorbidity_Inventories)
# Dems_Labs_TreatExp[is.na(Dems_Labs_TreatExp)] <-0


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(Group = ifelse(p1_SGLT2Exp==0&(p1_OralExp==1|p1_InjExp==1), "GLP1_Exp", "No_GLP1"))

Dems_Labs_TreatExp$Group <- as.factor(Dems_Labs_TreatExp$Group)

Dems_Labs_TreatExp$Group <- relevel(Dems_Labs_TreatExp$Group,"No_GLP1")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_SGLT2Exp, p1_OralExp, p1_InjExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))

temp <- Dems_Labs_TreatExp

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-weight)

Dems_Labs_TreatExp %>% group_by(Group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(Group) %>% sample_n(10000)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()



library("randomForest")
modelAll_1_randomForest <- randomForest(Group ~ ., data = Dems_Labs_TreatExp)
summary(modelAll_1_randomForest)
modelAll_1_randomForest$importance

modelAll_1_glm <- glm(Group ~ ., data = Dems_Labs_TreatExp, family = binomial)
summary(modelAll_1_glm)

library("gbm")
modelAll_1_gradientBoost <- gbm(Group=="No_SGLT2" ~ ., data = Dems_Labs_TreatExp, n.trees = 15000, distribution = "bernoulli")
summary(modelAll_1_gradientBoost)



Odd_ratio_SGLT2_vs_GLP1 <- fread("Odd_ratio_SGLT2_vs_GLP1.csv", sep=",")

Odd_ratio_SGLT2_vs_GLP1$Predictor <- as.factor(Odd_ratio_SGLT2_vs_GLP1$Predictor)

Odd_ratio_SGLT2_vs_GLP1 <- Odd_ratio_SGLT2_vs_GLP1 %>% arrange(Drug, `Odd ratio`)


Odd_ratio_SGLT2_vs_GLP1 %>%
  filter(Drug=="GLP1") %>%
  ggplot() +
  geom_segment( aes(x=reorder(Predictor, `Odd ratio`) , xend=reorder(Predictor, `Odd ratio`), y=Low, yend=High), color="deepskyblue4", size=1) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=Low), color="deepskyblue4", size=4 ) +
  geom_point( aes(x=reorder(Predictor, `Odd ratio`), y=High), color="deepskyblue4", size=4 ) +
  coord_flip()+
  theme_minimal() +
  theme(legend.position = "none",) +
  xlab("Predictor \n") +
  ylim(0,3)+
  ylab("\n Odd ratio (Lower-Upper ends)") +
  geom_hline(yintercept=1, linetype='dashed', color='deepskyblue4', size=1) 




# ------------------------------------------------------------------------------------------------
# Last BMI per GLP1 molecule experienced -----------------------

DIA_Medications <- fread("DANU Medications.txt")
unique(DIA_Medications$drug_class)
DIA_Medications <- DIA_Medications %>% filter(grepl("GLP1", drug_class))
DIA_Medications <- DIA_Medications %>% select(drug_id, brand_name, generic_name)

DIA_Doses <- fread("DIA Doses.txt")

DIA_Doses <- DIA_Doses %>% filter(grepl("GLP", drug_class)) %>% select(drug_id, generic_name, pat_id) %>% distinct()
DIA_Doses <- DIA_Doses %>% inner_join(DIA_Medications)
DIA_Doses <- DIA_Doses %>% select(pat_id, brand_name) %>% distinct()
names(DIA_Doses)[1] <- "patient"


DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
unique(DANU_Measures$test)
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") 
DANU_Measures <- DANU_Measures %>% select(patient, claimed, value) %>% distinct()
DANU_Measures <- DANU_Measures %>% inner_join(DIA_Doses %>% select(patient) %>% distinct())

DANU_Measures <- DANU_Measures %>% group_by(patient) %>% filter(claimed==max(claimed)) %>% slice(1)

DANU_Measures %>% inner_join(DIA_Doses) %>% ungroup() %>% group_by(brand_name) %>% summarise(n=median(value)) %>%
  arrange(n)


DIA_Medications <- fread("DANU Medications.txt")
DIA_Medications <- DIA_Medications %>% select(brand_name, drug_class) %>% distinct()


DANU_Measures %>% inner_join(DIA_Doses) %>% ungroup() %>%
  left_join(DIA_Medications) %>%
    mutate(brand_name = factor(brand_name, levels=c("Lixisenatide", "Liraglutide", "Rybelsus", "Trulicity", "Tanzeum", "Bydureon", "Ozempic", "Byetta", "Victoza", "Saxenda", "Adlyxin", "Wegovy"))) %>% group_by(brand_name) %>%
  ggplot(aes(value))+
  geom_density(aes(fill = drug_class, colour=drug_class), alpha =0.7, show.legend = F, size=2)+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  facet_wrap(~brand_name, ncol=12)+
  ggsci::scale_colour_jco()+
  ggsci::scale_fill_jco()+
  coord_flip()+
  xlim(20,60)+
  xlab("MAX BMI \n ")+ ylab("\nProportion of patients")


# -------------------------------------------------
# Ozempic off-label use ---------------------
DIA_Medications <- fread("DANU Medications.txt")
unique(DIA_Medications$drug_class)
DIA_Medications <- DIA_Medications %>% filter(grepl("GLP1", drug_class))
DIA_Medications <- DIA_Medications %>% select(drug_id, brand_name, generic_name)

DIA_Doses <- fread("DIA Doses.txt")

DIA_Doses <- DIA_Doses %>% filter(grepl("GLP", drug_class)) %>% select(drug_id, generic_name, pat_id) %>% distinct()
DIA_Doses <- DIA_Doses %>% inner_join(DIA_Medications)
DIA_Doses <- DIA_Doses %>% select(pat_id, brand_name) %>% distinct()
names(DIA_Doses)[1] <- "patient"

GLP1_pats <- DIA_Doses %>%  select(patient) %>% distinct()


DIA_Flows_Aux._Long     <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
DIA_Flows_Aux._Long %>% filter(s1=="G"|s2=="G") %>% inner_join(GLP1_pats) %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 5373357 Trulicity_pats

GLP1_pats <- DIA_Flows_Aux._Long %>% filter(s1=="G"|s2=="G") %>% inner_join(GLP1_pats) %>% select(patient, weight) %>% distinct()


# Pick patients that had *ONLY* |Biguanide| AND |GLP1|
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4            <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2           <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin         <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1        <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1  <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

# All pats
DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- GLP1_pats %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

Pats_to_remove <- DIA_Drug_Histories %>% 
  mutate(Toremove = ifelse(grepl(string_Antidiabetic, Drugs)|grepl(string_DPP4, Drugs)|
                             grepl(string_Insulin, Drugs)|grepl(string_SGLT2, Drugs),1,0)) %>% 
  filter(Toremove==1) %>% select(patient) %>% distinct()

Pats_Biguanide_GLP1_only <- DIA_Drug_Histories %>%  anti_join(Pats_to_remove)

Pats_Biguanide_GLP1_only <- Pats_Biguanide_GLP1_only %>% select(patient, weight) %>% distinct()
GLP1_pats <- Pats_Biguanide_GLP1_only %>% inner_join(GLP1_pats)

sum(GLP1_pats$weight) # 355926.9 # GLP1 and/or Biguanide


# ------------------------------------
# Diabetes Experience Comorbidities GLP1 SGLT2 Combo ----------------------------

# ALL DIABETES TREAT-EXP

Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
sum(Treatment_exp_Vector$weight) # 30625690



# HbA1!C <= 10.5

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <- DANU_Measures %>% inner_join(Treatment_exp_Vector)
DANU_Measures <- DANU_Measures %>% filter(test=="HbA1c Level") %>% select(patient, weight, claimed, value) %>% distinct()
DANU_Measures <- DANU_Measures %>% group_by(patient) %>% filter(claimed==max(claimed)) %>% slice(1)

DANU_Measures %>% ungroup() %>% summarise(n=sum(weight)) # 13560972
DANU_Measures %>% filter(value<=10.5) %>% ungroup() %>% summarise(n=sum(weight)) # 12880377  (0.9498122 prop.)
DANU_Measures <- DANU_Measures %>% filter(value<=10.5) %>% ungroup()  %>% select(patient, weight)

PatsToTrack <- DANU_Measures


# ICD10 Dx CVD vs CKD

DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories <- PatsToTrack %>% left_join(DIA_Comorbidity_Inventories %>% select(-weight), by=c("patient"="patid"))
DIA_Comorbidity_Inventories %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 12880377

DIA_Comorbidity_Inventories %>% filter(grepl("I21", diagnosis)|grepl("I22", diagnosis)|grepl("I25", diagnosis)|grepl("I63", diagnosis)|
                                         grepl("I75", diagnosis)|grepl("I74", diagnosis)|grepl("I70", diagnosis)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) 

CVD <- DIA_Comorbidity_Inventories %>% filter(grepl("I21", diagnosis)|grepl("I22", diagnosis)|grepl("I25", diagnosis)|grepl("I63", diagnosis)|
                                         grepl("I75", diagnosis)|grepl("I74", diagnosis)|grepl("I70", diagnosis)) %>% 
  select(patient, weight) %>% distinct() 

DIA_Comorbidity_Inventories %>% filter(grepl("N18", diagnosis)) %>% 
  select(patient, weight) %>% distinct() %>% summarise(n=sum(weight))

CKD <- DIA_Comorbidity_Inventories %>% filter(grepl("N18", diagnosis)) %>% 
  select(patient, weight) %>% distinct()

sum(CVD$weight)
sum(CKD$weight)



# Drugs for everyone 

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients <- DANU_Ingredients %>% select(molecule, generic_name)
DANU_Ingredients <- DANU_Ingredients %>% filter(generic_name=="Empagliflozin"|generic_name=="Canagliflozin"|generic_name=="Dapagliflozin"|generic_name=="Ertugliflozin"|
                              generic_name=="Exenatide"|generic_name=="Liraglutide"|generic_name=="Albiglutide"|generic_name=="Dulaglutide"|generic_name=="Lixisenatide"|generic_name=="Semaglutide Injectable")
DANU_Ingredients$molecule <- as.numeric(DANU_Ingredients$molecule)

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% group_by(patient) %>% filter(Month==60)
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, Drugs, sep = ",", convert=T )
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease, Month))

names(DIA_Drug_Histories)[3] <- "molecule"

DIA_Drug_Histories <- DIA_Drug_Histories %>% left_join(DANU_Ingredients %>% mutate(molecule = as.character(molecule)))
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Class=ifelse(grepl("flozin",generic_name),"SGLT2",
                                                                 ifelse(is.na(generic_name),"none", "GLP1")))




# CVD Drugs
CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight)) # 249484.4


CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct() %>%
  anti_join(CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) # 715173.8

CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  anti_join(CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  full_join(CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) # 681447.3

CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="none"&molecule!="-") %>% select(patient, weight) %>% distinct() %>%
  anti_join(CVD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1"|Class=="SGLT2") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight)) # 5938994




# CKD Drugs

CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight)) # 128352.2


CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct() %>%
  anti_join(CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) # 504989.6

CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  anti_join(CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  full_join(CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) # 335544.1

CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="none"&molecule!="-") %>% select(patient, weight) %>% distinct() %>%
  anti_join(CKD %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1"|Class=="SGLT2") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight)) # 3985348




# Macroalbuminuria 


DANU_Measures_50 <- fread("DANU Measures.txt")
DANU_Measures_50 <- DANU_Measures_50 %>% select(patid, test, unit, claimed, value)

DANU_Measures_50 <- DANU_Measures_50 %>% filter(test=="ACR Ratio"|test=="Creatinine Urine"|test=="Microalbumin Urine")

DANU_Measures_50 <- PatsToTrack %>% inner_join(DANU_Measures_50, by=c("patient"="patid"))

DANU_Measures_50 %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 7872382

DANU_Measures_50 %>% filter(test=="ACR Ratio") %>%
  group_by(patient) %>% filter(claimed==max(claimed)) %>% filter(value==max(value)) %>% slice(1) %>%
  select(patient, weight) %>% distinct() %>% ungroup() %>% summarise(n=sum(weight)) # 6381190 (0.2193704)

range(DANU_Measures_50$value[DANU_Measures_50$test=="ACR Ratio"])

DANU_Measures_50 %>% filter(test=="ACR Ratio") %>% 
  ggplot(aes(value)) +
  geom_density()+
  xlim(0,1000)


DANU_Measures_50 %>% filter(test=="ACR Ratio") %>%
  group_by(patient) %>% filter(claimed==max(claimed)) %>% filter(value==max(value)) %>% slice(1) %>%
  filter(value>=300) %>%
  select(patient, weight) %>% distinct() %>% ungroup() %>% summarise(n=sum(weight))  # 458653 (/0.2193704 = 2090770)


Macroalbuminuria <- DANU_Measures_50 %>% filter(test=="ACR Ratio") %>%
  group_by(patient) %>% filter(claimed==max(claimed)) %>% filter(value==max(value)) %>% slice(1) %>%
  filter(value>=300) %>% select(patient, weight) %>% distinct()


sum(CVD$weight)
sum(CKD$weight)

CVD %>% inner_join(CKD) %>% ungroup() %>% summarise(n=sum(weight)) * 0.32 * 2.25837
CVD %>% inner_join(CKD) %>% ungroup() %>% summarise(n=sum(weight)) * 0.30 * 2.25837

Macroalbuminuria %>% inner_join(CVD) %>% ungroup() %>% summarise(n=sum(weight)) / 0.2193704 # 1279661
Macroalbuminuria %>% inner_join(CKD) %>% ungroup() %>% summarise(n=sum(weight)) / 0.2193704 * 0.32 # 466673.8
Macroalbuminuria %>% inner_join(CKD) %>% ungroup() %>% summarise(n=sum(weight)) / 0.2193704 * 0.30 # 437506.7

CVD %>% inner_join(CKD) %>% inner_join(Macroalbuminuria) %>% ungroup() %>% summarise(n=sum(weight)) / 0.2193704 * 0.32 # 322855.4
CVD %>% inner_join(CKD) %>% inner_join(Macroalbuminuria) %>% ungroup() %>% summarise(n=sum(weight)) / 0.2193704 * 0.30 # 302676.9


# Drugs 
# Macroalbuminuria
Macroalbuminuria <- Macroalbuminuria %>% ungroup()

Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight)) / 0.2193704 # 41219.1

Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) / 0.2193704 # 154811.5

Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  full_join(Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) / 0.2193704 # 88110.16

Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="none"&molecule!="-") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1"|Class=="SGLT2") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight))  / 0.2193704 # 1163491


# 1+2 8.2% CKD 0.32 or 7.6% CKD 0.30
CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight)) * 2.25837 * 0.32 # 24163.58

CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct() %>%
  anti_join(CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) * 2.25837 * 0.32 # 96338.89

CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  anti_join(CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  full_join(CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) * 2.25837 * 0.32 # 71219.34

CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="none"&molecule!="-") %>% select(patient, weight) %>% distinct() %>%
  anti_join(CVD %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1"|Class=="SGLT2") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight))  * 2.25837 * 0.32 # 835325.7

# 1 + 3
Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight)) / 0.2193704 # 25010.89

Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) / 0.2193704 # 85012.61

Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  full_join(Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) / 0.2193704 # 48355.11

Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="none"&molecule!="-") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1"|Class=="SGLT2") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight))  / 0.2193704 # 717678.9

# 2 + 3 0.32 or 0.30
Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight)) / 0.2193704 * 0.3 # 7758.043

Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) / 0.2193704 * 0.3 # 29201.05

Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  full_join(Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) / 0.2193704* 0.3 # 14605.65

Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="none"&molecule!="-") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% inner_join(CKD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1"|Class=="SGLT2") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight))  / 0.2193704 * 0.3 # 246337


# 1+2+3 0.32 OR O.30
Macroalbuminuria %>% inner_join(CKD) %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% inner_join(CKD) %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight)) / 0.2193704 * 0.32 # 5746.876

Macroalbuminuria %>% inner_join(CKD) %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% inner_join(CKD) %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% inner_join(CKD) %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) / 0.2193704 * 0.32 # 20223.42

Macroalbuminuria %>% inner_join(CKD) %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% inner_join(CKD) %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="SGLT2") %>% select(patient, weight) %>% distinct() %>%
  inner_join(Macroalbuminuria %>% inner_join(CKD) %>%  inner_join(CVD) %>%left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct()) %>%
  full_join(Macroalbuminuria %>% inner_join(CKD) %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1") %>% select(patient, weight) %>% distinct())) %>%
  summarise(n=sum(weight)) / 0.2193704* 0.32 # 9709.459

Macroalbuminuria %>% inner_join(CKD) %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="none"&molecule!="-") %>% select(patient, weight) %>% distinct() %>%
  anti_join(Macroalbuminuria %>% inner_join(CKD) %>% inner_join(CVD) %>% left_join(DIA_Drug_Histories) %>% filter(Class=="GLP1"|Class=="SGLT2") %>% select(patient, weight) %>% distinct()) %>%
  summarise(n=sum(weight))  / 0.2193704 * 0.32 # 182836.6



# ------------------------------------------
# Lapsed patients characterization ---------------------------------------------
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

DIA_Flows_Aux._Long <- Treatment_exp_Vector %>% inner_join(DIA_Flows_Aux._Long)

DIA_Flows_Aux._Long %>% filter(p2==60 & s2=="x") %>% summarise(n=sum(as.numeric(weight))) # 12890638

# Lapsed m60
Lapsedm60 <- DIA_Flows_Aux._Long %>% filter(p2==60 & s2=="x") %>% select(patient, weight) # 12890638

# Lasped Duration After starting treatment
Lapsedm60 %>%
  anti_join(
    DIA_Flows_Aux._Long %>% filter(s2=="x" & p1_RxExp) %>% group_by(patient) %>% count() %>% filter(n>=12) %>% select(patient)
  ) %>% ungroup() %>% summarise(n=sum(as.numeric(weight))) # 2807287 >12 months lapsed AFTER already being experienced

Lapsedm60 %>%
  anti_join(
    DIA_Flows_Aux._Long %>% filter(s2=="x" & p1_RxExp) %>% group_by(patient) %>% count() %>% filter(n>=24) %>% select(patient)
  ) %>% ungroup() %>% summarise(n=sum(as.numeric(weight))) # 5853509 >24 months lapsed AFTER already being experienced - okayish?

# Classes experienced
Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60)
Lapsed_Biguanide_only <- Cum_Class_Experience_EveryMonth %>% filter(p1_BiguanideExp==1 & 
                                             p1_AntiDiabeticExp==0 & 
                                             p1_DPP4Exp==0 & 
                                             p1_SGLT2Exp==0 & 
                                             p1_InsulinExp==0 & 
                                             p1_InjExp==0 & 
                                             p1_OralExp==0) %>% select(patient)

Lapsedm60 %>% anti_join(Lapsed_Biguanide_only) %>% summarise(n=sum(as.numeric(weight)))  # Remove those that only had biguanide  ->  7590533

Lapsedm60 %>% 
  anti_join(Lapsed_Biguanide_only) %>%
    anti_join(
    DIA_Flows_Aux._Long %>% filter(s2=="x" & p1_RxExp) %>% group_by(patient) %>% count() %>% filter(n>=24) %>% select(patient)
  ) %>%
  summarise(n=sum(as.numeric(weight))) # Remove those that only had biguanide  and were lapsed > 24 months after being experienced already  # 3498670

# Insulin pats
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
string_Insulin    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")

#InsulinInOut_pats <- DIA_Flows_Aux._Long %>% filter(flow==1 & grepl(string_Insulin, d2) & !grepl(string_Insulin, d1)) %>% group_by(patient) %>% count() %>% filter(n>3) %>% select(patient) %>% ungroup()
InsulinInOut_pats <- DIA_Flows_Aux._Long %>% select(patient, d1,d2) %>% distinct() %>% filter(grepl(string_Insulin, d2) | grepl(string_Insulin, d1)) %>% select(patient) %>% distinct()


Lapsedm60 %>% anti_join(InsulinInOut_pats) %>% summarise(n=sum(as.numeric(weight)))  # Patients moving in & out of insulin ->  12408820

Lapsedm60 %>% 
  anti_join(InsulinInOut_pats) %>%
    anti_join(
    DIA_Flows_Aux._Long %>% filter(s2=="x" & p1_RxExp) %>% group_by(patient) %>% count() %>% filter(n>=24) %>% select(patient)
  ) %>%
  summarise(n=sum(as.numeric(weight))) # Remove those that only had biguanide  and were lapsed > 24 months after being experienced already  # 5651150

# ADD METRICS
Lapsedm60
# MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
# MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_BMI,MAX_HbA1c ))
# Lapsedm60 %>% left_join(MAX_Labs_Demographics)

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))
Lapsedm60_Pred <- Lapsedm60 %>% left_join(Cum_Class_Experience_EveryMonth)

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")
Lapsedm60_Pred <- Lapsedm60_Pred %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

LiverKidneyHeart_Diseases_Pen <- fread("LiverKidneyHeartFailureonly_Diseases_Pen.txt", sep="\t")
Lapsedm60_Pred <- Lapsedm60_Pred %>% left_join(LiverKidneyHeart_Diseases_Pen, by=c("patient"="patid"))
Lapsedm60_Pred[is.na(Lapsedm60_Pred)] <- 0


library(factoextra)
library(cluster)
Lapsedm60_Pred

Lapsedm60_Pred_short <- Lapsedm60_Pred %>% 
  anti_join(InsulinInOut_pats) %>%
    anti_join(
    DIA_Flows_Aux._Long %>% filter(s2=="x" & p1_RxExp) %>% group_by(patient) %>% count() %>% filter(n>=24) %>% select(patient)
  ) 

df <- Lapsedm60_Pred_short
df <- df %>% sample_n(26649)
df <- df %>% select(-p1_InsulinExp)
df2 <- scale(df[,3:14])

# fviz_nbclust(df2, kmeans, method = "wss")

# gap_stat <- clusGap(df2,
#                     FUN = kmeans,
#                     nstart = 25,
#                     K.max = 10,
#                     B = 50)
# 
# fviz_gap_stat(gap_stat)

set.seed(1)

km <- kmeans(df2, centers = 2, nstart = 25)

km # K-means clustering with 2 clusters of sizes 77493, 13507  ~15%

fviz_cluster(km, data = df2, labelsize = 1, ggtheme = theme_minimal(), axes = c(1, 2)) +
  ggsci::scale_color_jco(palette = "default") +
  ggsci::scale_fill_jco(palette = "default") +
  xlim(-2,10)


aggregate(df[,3:14], by=list(cluster=km$cluster), mean)


ignore <- data.frame(km$cluster) %>% bind_cols(df)
ignore %>% group_by(km.cluster) %>% summarise(n=sum(as.numeric(weight)))


DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories <- ignore  %>% select(patient, km.cluster) %>% inner_join(DIA_Comorbidity_Inventories, by=c("patient"="patid"))
length(unique(DIA_Comorbidity_Inventories$patient)) # 36265
DIA_Comorbidity_Inventories <-DIA_Comorbidity_Inventories %>% filter(!grepl("A", diagnosis) & !grepl("B", diagnosis) & !grepl("C", diagnosis) &
                                                                       !grepl("O", diagnosis) & !grepl("P", diagnosis) & !grepl("Q", diagnosis) &
                                                                       !grepl("R", diagnosis) & !grepl("S", diagnosis) & !grepl("T", diagnosis) &
                                                                       !grepl("X", diagnosis) & !grepl("Y", diagnosis) & !grepl("Z", diagnosis))

DIA_Comorbidity_Inventories %>% select(km.cluster, patient, weight) %>% distinct() %>% group_by(km.cluster) %>% summarise(n=sum(as.numeric(weight)))

 

ignore2 <-  DIA_Comorbidity_Inventories %>% group_by(km.cluster,diagnosis ) %>% summarise(n=sum(weight)) %>%
  spread(key=km.cluster, value=n) %>% 
  mutate(`1` = ifelse(is.na(`1`),0, `1`)) %>%
  mutate(`2` = ifelse(is.na(`2`),0, `2`)) 

ignore2 <- ignore2 %>% arrange(-`1`) %>% mutate(`1`= `1` / 459235)  %>% mutate(`2`= `2` / 3260200)


ignore2 <- ignore2 %>% mutate(Diff=`2`-`1`) %>% mutate(Fold=`2`/`1`) 

ignore2 <- ignore2 %>% filter(`1`>=0.05 & `2`>=0.05)

fwrite(ignore2, "Comorbidities_Diabeteslapsed_2klusters.csv")

# ---------------------------------------------------------------
# Lapsed patients characterization part 2 ---------------------------------------------
DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

DIA_Flows_Aux._Long <- Treatment_exp_Vector %>% inner_join(DIA_Flows_Aux._Long)

DIA_Flows_Aux._Long %>% filter(p2==60 & s2=="x") %>% summarise(n=sum(as.numeric(weight))) # 12890638

# Lapsed m60
Lapsedm60 <- DIA_Flows_Aux._Long %>% filter(p2==60 & s2=="x") %>% select(patient, weight) # 12890638

# Lasped Duration After starting treatment
Lapsedm60 %>%
  anti_join(
    DIA_Flows_Aux._Long %>% filter(s2=="x" & p1_RxExp) %>% group_by(patient) %>% count() %>% filter(n>=12) %>% select(patient)
  ) %>% ungroup() %>% summarise(n=sum(as.numeric(weight))) # 2807287 >12 months lapsed AFTER already being experienced

Lapsedm60 %>%
  anti_join(
    DIA_Flows_Aux._Long %>% filter(s2=="x" & p1_RxExp) %>% group_by(patient) %>% count() %>% filter(n>=24) %>% select(patient)
  ) %>% ungroup() %>% summarise(n=sum(as.numeric(weight))) # 5853509 >24 months lapsed AFTER already being experienced - okayish?

# Classes experienced
Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60)
Lapsed_Biguanide_only <- Cum_Class_Experience_EveryMonth %>% filter(p1_BiguanideExp==1 & 
                                             p1_AntiDiabeticExp==0 & 
                                             p1_DPP4Exp==0 & 
                                             p1_SGLT2Exp==0 & 
                                             p1_InsulinExp==0 & 
                                             p1_InjExp==0 & 
                                             p1_OralExp==0) %>% select(patient)

Lapsedm60 %>% anti_join(Lapsed_Biguanide_only) %>% summarise(n=sum(as.numeric(weight)))  # Remove those that only had biguanide  ->  7590533

Lapsedm60 %>% 
  anti_join(Lapsed_Biguanide_only) %>%
    anti_join(
    DIA_Flows_Aux._Long %>% filter(s2=="x" & p1_RxExp) %>% group_by(patient) %>% count() %>% filter(n>=24) %>% select(patient)
  ) %>%
  summarise(n=sum(as.numeric(weight))) # Remove those that only had biguanide  and were lapsed > 24 months after being experienced already  # 3498670

# Insulin pats
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
string_Insulin    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")

#InsulinInOut_pats <- DIA_Flows_Aux._Long %>% filter(flow==1 & grepl(string_Insulin, d2) & !grepl(string_Insulin, d1)) %>% group_by(patient) %>% count() %>% filter(n>3) %>% select(patient) %>% ungroup()
InsulinInOut_pats <- DIA_Flows_Aux._Long %>% select(patient, d1,d2) %>% distinct() %>% filter(grepl(string_Insulin, d2) | grepl(string_Insulin, d1)) %>% select(patient) %>% distinct()


Lapsedm60 %>% anti_join(InsulinInOut_pats) %>% summarise(n=sum(as.numeric(weight)))  # Patients moving in & out of insulin ->  12408820

Lapsedm60 %>% 
  anti_join(InsulinInOut_pats) %>%
    anti_join(
    DIA_Flows_Aux._Long %>% filter(s2=="x" & p1_RxExp) %>% group_by(patient) %>% count() %>% filter(n>=24) %>% select(patient)
  ) %>%
  summarise(n=sum(as.numeric(weight))) # Remove those that only had biguanide  and were lapsed > 24 months after being experienced already  # 5651150

# ADD METRICS
Lapsedm60
# MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
# MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_BMI,MAX_HbA1c ))
# Lapsedm60 %>% left_join(MAX_Labs_Demographics)

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))
Lapsedm60_Pred <- Lapsedm60 %>% left_join(Cum_Class_Experience_EveryMonth)

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")
Lapsedm60_Pred <- Lapsedm60_Pred %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

LiverKidneyHeart_Diseases_Pen <- fread("LiverKidneyHeartFailureonly_Diseases_Pen.txt", sep="\t")
Lapsedm60_Pred <- Lapsedm60_Pred %>% left_join(LiverKidneyHeart_Diseases_Pen, by=c("patient"="patid"))
Lapsedm60_Pred[is.na(Lapsedm60_Pred)] <- 0


library(factoextra)
library(cluster)
Lapsedm60_Pred

Lapsedm60_Pred_short <- Lapsedm60_Pred %>% 
  anti_join(InsulinInOut_pats) %>%
    anti_join(
    DIA_Flows_Aux._Long %>% filter(s2=="x" & p1_RxExp) %>% group_by(patient) %>% count() %>% filter(n>=24) %>% select(patient)
  ) 

df <- Lapsedm60_Pred_short
df <- df %>% sample_n(26649)
df <- df %>% select(-p1_InsulinExp)
df2 <- scale(df[,3:14])

# fviz_nbclust(df2, kmeans, method = "wss")

# gap_stat <- clusGap(df2,
#                     FUN = kmeans,
#                     nstart = 25,
#                     K.max = 10,
#                     B = 50)
# 
# fviz_gap_stat(gap_stat)

set.seed(1)

km <- kmeans(df2, centers = 2, nstart = 25)

km # K-means clustering with 2 clusters of sizes 77493, 13507  ~15%

fviz_cluster(km, data = df2, labelsize = 1, ggtheme = theme_minimal(), axes = c(1, 2)) +
  ggsci::scale_color_jco(palette = "default") +
  ggsci::scale_fill_jco(palette = "default") +
  xlim(-2,10)


aggregate(df[,3:14], by=list(cluster=km$cluster), mean)


ignore <- data.frame(km$cluster) %>% bind_cols(df)
ignore %>% group_by(km.cluster) %>% summarise(n=sum(as.numeric(weight)))

km_clusters <- ignore  %>% select(patient, km.cluster)# 1 active 2 inactive

DANU_Events <- fread("DANU Events.txt")

DANU_Events <- DANU_Events %>% filter(grepl("E11", code)) %>% select(patid, code) 

km_clusters %>% inner_join(DANU_Events %>% group_by(patid) %>% count(), by=c("patient"="patid")) %>% ungroup() %>%
  group_by(km.cluster) %>% summarise(mean=mean(n))


DANU_Utilizations <- fread("DANU Utilizations.txt")

DANU_Utilizations <- km_clusters %>% inner_join(DANU_Utilizations, by=c("patient"="patid"))


for (i in names(DANU_Utilizations[,4:25])){
  print(i)
  print(DANU_Utilizations  %>% group_by(km.cluster) %>% summarise(n=mean(get(i))))
}

DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% select(patid, age, diabetes_onset)
DANU_Demographics <- DANU_Demographics %>% mutate(diabetes_onset=format(as.Date(diabetes_onset), "%Y-%m"))

km_clusters %>% inner_join(DANU_Demographics, by=c("patient"="patid")) %>%
  group_by(km.cluster) %>% summarise(n=median(age))


DANU_Events <- fread("DANU Events.txt")

DANU_Events <- DANU_Events %>% inner_join(km_clusters %>% select(patient), by=c("patid"="patient")) %>%
  filter(grepl("E11", code)) %>% group_by(patid) %>%
  filter(claimed==min(claimed)) %>% select(patid, claimed)  %>% distinct()
DANU_Events$claimed <- as.Date(DANU_Events$claimed)

DANU_Events %>% inner_join(km_clusters, by=c("patid"="patient")) %>% drop_na() %>%
  mutate(claimed=format(as.Date(claimed), "%Y-%m")) %>%
  left_join(Months_lookup, by=c("claimed"="Month")) %>% drop_na() %>%
  group_by(km.cluster) %>% summarise(n=mean(Exact_Month))
  


DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)

DANU_Measures_HbA1c %>% inner_join(km_clusters, by=c("patid"="patient")) %>% drop_na() %>%
  filter(test=="HbA1c Level") %>% group_by(patid) %>%  filter(claimed==max(claimed)) %>% slice(1) %>%
  ungroup() %>%
  select(patid, km.cluster, value) %>%
  group_by(km.cluster) %>% summarise(n=mean(value))

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)

DANU_Measures_HbA1c %>% inner_join(km_clusters, by=c("patid"="patient")) %>% drop_na() %>%
  filter(test=="BMI") %>% group_by(patid) %>%  filter(claimed==max(claimed)) %>% slice(1) %>%
  ungroup() %>%
  select(patid, km.cluster, value) %>%
  group_by(km.cluster) %>% summarise(n=mean(value))

DANU_Measures_HbA1c %>% inner_join(km_clusters, by=c("patid"="patient")) %>% drop_na() %>%
  filter(test=="BMI") %>% group_by(patid) %>%  filter(claimed==max(claimed)) %>% slice(1) %>%
  ungroup() %>%
  select(patid, km.cluster, value) %>%
  mutate(km.cluster=as.factor(km.cluster)) %>%
  mutate(km.cluster=ifelse(km.cluster==1, "Mod-Severe", "Milder")) %>%
  ggplot(aes(value, colour=km.cluster, fill=km.cluster)) +
  geom_density(alpha=0.5) + 
  theme_minimal() +
  ggsci::scale_fill_aaas() +
  ggsci::scale_colour_aaas() +
  xlim(12,70) +
  xlab("\n Last BMI record") + ylab("Density distribution \n")
  

DANU_Measures_HbA1c %>% inner_join(km_clusters, by=c("patid"="patient")) %>% drop_na() %>%
  filter(test=="BMI") %>% group_by(patid) %>%  filter(claimed==max(claimed)) %>% slice(1) %>%
  ungroup() %>%
  select(patid, km.cluster, value) %>%
  mutate(value=ifelse(value<25, "<25", ifelse(value<27, "25-27", ifelse(value<30, "27-30", "+30")))) %>%
  group_by(km.cluster, value) %>% count() %>% spread(key=km.cluster, value=n)


DIA_Drug_Histories_LONG <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% inner_join(km_clusters)
DIA_Drug_Histories_LONG <- gather(DIA_Drug_Histories_LONG, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories_LONG <- DIA_Drug_Histories_LONG %>% select(-c(Month, disease, weight))
km_clusters %>% left_join(DIA_Drug_Histories_LONG %>% filter(Treat!="-") %>% group_by(patient) %>% count()) %>%
  ungroup() %>% group_by(km.cluster) %>% summarise(n2=mean(n))

# ----------------------------------------------------------------
# % potential patient days actually spent ON therapy ---------------------------------------

# ORAL
DIA_Doses_BIG <- read.table("DIA Doses.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)

DIA_Doses_BIG <- DIA_Doses_BIG %>% filter(drug_group=="GLP1 Oral") %>% 
  select(drug_class, pat_id, weight, from_dt, dayssup, paid,status)

DIA_Doses_BIG$from_dt <- as.Date(DIA_Doses_BIG$from_dt)
DIA_Doses_BIG$dayssup <- as.numeric(DIA_Doses_BIG$dayssup)
DIA_Doses_BIG$weight <- as.numeric(DIA_Doses_BIG$weight)

DIA_Doses_BIG <- DIA_Doses_BIG %>% filter(status != "G")

# 193657*365 = 70684805
DIA_Doses_BIG <- DIA_Doses_BIG %>% filter(from_dt>="2020-05-01"&from_dt<="2021-04-30")
DIA_Doses_BIG <- DIA_Doses_BIG %>% filter(paid=="P")
sum(DIA_Doses_BIG$weight*DIA_Doses_BIG$dayssup) # 35422675 0.5011356   ||   32676427  0.4622836


# INJECTABLE
DIA_Doses_BIG <- read.table("DIA Doses.txt", header = T, sep="\t", colClasses = "character", stringsAsFactors = FALSE)

DIA_Doses_BIG <- DIA_Doses_BIG %>% filter(drug_group=="GLP1 Injectable") %>% 
  select(drug_class, pat_id, weight, from_dt, dayssup, paid,status)

DIA_Doses_BIG$from_dt <- as.Date(DIA_Doses_BIG$from_dt)
DIA_Doses_BIG$dayssup <- as.numeric(DIA_Doses_BIG$dayssup)
DIA_Doses_BIG$weight <- as.numeric(DIA_Doses_BIG$weight)

DIA_Doses_BIG <- DIA_Doses_BIG %>% filter(status != "G")

# 3700624*365 = 1350727760
DIA_Doses_BIG <- DIA_Doses_BIG %>% filter(from_dt>="2020-05-01"&from_dt<="2021-04-30")
DIA_Doses_BIG <- DIA_Doses_BIG %>% filter(paid=="P")
sum(DIA_Doses_BIG$weight*DIA_Doses_BIG$dayssup) # 907777184  # 0.6720652  ||  827881404   0.6129151

# -----------------------------------------------------------





DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Drugs!="-")
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
  
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Injectables       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_Oral    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group != "Insulin" & DANU_Ingredients$drug_group != "GLP1 Injectable"], collapse = "|"),")\\b")

DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Inj = ifelse( grepl(string_Injectables, Drugs)&grepl(string_Oral, Drugs), "I+O",
                                                                  ifelse(grepl(string_Injectables, Drugs),"I", 
                                                                        ifelse(grepl(string_Oral,Drugs), "O", NA))))

DIA_Drug_Histories_2 <- DIA_Drug_Histories %>% select(patient, weight, Month, Inj) %>%
  filter(grepl("I", Inj)) %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories %>% select(patient, weight, Month, Inj))

DIA_Drug_Histories_2

DIA_Drug_Histories_2 <- DIA_Drug_Histories_2 %>% spread(key=Month, value=Inj)

DIA_Drug_Histories_2[is.na(DIA_Drug_Histories_2)] <- "-"

DIA_Drug_Histories_2 <- gather(DIA_Drug_Histories_2, Month, Drugs, `1`:`60`, factor_key=TRUE)

DIA_Drug_Histories_2 <- DIA_Drug_Histories_2 %>% arrange(patient, Month)




DIA_Drug_Histories_3 <- DIA_Drug_Histories_2 %>% group_by(patient, weight) %>% 
  slice(if(any(grepl("I",Drugs))) which.max(grepl("I",Drugs)):which.max(Month=="60") else NA) 

DIA_Drug_Histories_3 <- DIA_Drug_Histories_3 %>% group_by(patient) %>% mutate(grp = rle(Drugs)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories_3 <- DIA_Drug_Histories_3 %>% arrange(patient, Month)



DIA_Drug_Histories_3 %>% ungroup() %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 5373357 Inj exp



DIA_Drug_Histories_3 %>% ungroup() %>% filter(grp!=1) %>%
   filter(!grepl("I", Drugs)) %>% select(patient, weight, Drugs, grp) %>%
  group_by(patient, weight, grp) %>% count() %>% ungroup() %>%
  filter(n>=3) %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # stopped >= 6 months 2745147 / 3445663


DIA_Drug_Histories_3 %>% ungroup() %>% filter(grp!=1) %>%
   filter(!grepl("I", Drugs)) %>% select(patient, weight, Drugs, grp) %>%
  group_by(patient, weight, grp) %>% count() %>% ungroup() %>%
  filter(n>=3) %>% select(patient, weight, grp) %>% distinct() %>%
  group_by(patient, weight) %>% filter(grp==min(grp)) %>%
  rename("Stopgrp"="grp") %>%
  inner_join(
    DIA_Drug_Histories_3 %>% ungroup() %>% filter(grp!=1) %>%
   filter(grepl("I", Drugs)) %>% select(patient, weight, grp) %>% distinct() %>%
  rename("Injgrp"="grp")
  ) %>%
  filter(Injgrp>Stopgrp) %>%
  select(patient, weight)  %>% distinct() %>% ungroup() %>% summarise(n=sum(weight)) # 948467 / 1680926 went back to Inj after a 6 month lapse


DIA_Drug_Histories_3 %>% ungroup() %>% group_by(Drugs) %>% summarise(n=sum(weight))



# SGLT2+GLP1 vs GLP1 vs SGLT2 --------------------------------------------------------------------------
MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(c(patient, age, gender, diagnosis, MAX_BMI,MAX_HbA1c ))

Cum_Class_Experience_EveryMonth <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")

Cum_Class_Experience_EveryMonth <- Cum_Class_Experience_EveryMonth %>% filter(p2==60) %>% select(-c(p1, p2))

Dems_Labs_TreatExp <- MAX_Labs_Demographics %>% inner_join(Cum_Class_Experience_EveryMonth)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% drop_na()

Number_Drugs_EverExperienced <- fread("Number_Drugs_EverExperienced.txt")

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(Number_Drugs_EverExperienced) %>% mutate(Diff_Drugs_exp = ifelse(is.na(Diff_Drugs_exp),0,Diff_Drugs_exp))

Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(Dems_Labs_TreatExp)

DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories <- Treatment_exp_Vector %>% select(patient) %>% left_join(DIA_Comorbidity_Inventories, by=c("patient"="patid"))

DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% filter(grepl("I", diagnosis) | grepl("N", diagnosis))



DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% mutate(label=1) %>% spread(key=diagnosis, value=label)
DIA_Comorbidity_Inventories[is.na(DIA_Comorbidity_Inventories)] <-0

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% left_join(DIA_Comorbidity_Inventories)
Dems_Labs_TreatExp[is.na(Dems_Labs_TreatExp)] <-0


DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
string_SGLT2 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_GLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"|DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")


DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, Treat) %>% distinct() %>% filter(Treat!="-")
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(GLP1_SGLT2_Status = ifelse(grepl(string_GLP1, Treat)&grepl(string_SGLT2, Treat), "Combo", 
                                                                               ifelse(grepl(string_GLP1, Treat), "GLP1",
                                                                                            ifelse(grepl(string_SGLT2, Treat), "SGLT2", "none"))))

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, GLP1_SGLT2_Status) %>% distinct() 

Combos <- DIA_Drug_Histories %>% filter(GLP1_SGLT2_Status=="Combo") %>% select(patient) %>% distinct()
GLP1 <- DIA_Drug_Histories %>% filter(GLP1_SGLT2_Status=="GLP1") %>% select(patient) %>% distinct()
SGLT2 <- DIA_Drug_Histories %>% filter(GLP1_SGLT2_Status=="SGLT2") %>% select(patient) %>% distinct()

GLP1_Pats <- GLP1 %>% anti_join(Combos) %>% anti_join(SGLT2)
SGLT2_Pats <- SGLT2 %>% anti_join(Combos) %>% anti_join(GLP1)
Combo_Pats <- Combos

SGLT2_Pats$group <- 0
GLP1_Pats$group <- 1
Combo_Pats$group <- 2


Dems_Labs_TreatExp <- SGLT2_Pats %>% full_join(GLP1_Pats) %>% full_join(Combo_Pats) %>%
  inner_join(Dems_Labs_TreatExp)

Dems_Labs_TreatExp$group <- as.factor(Dems_Labs_TreatExp$group)

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-c(p1_SGLT2Exp, p1_OralExp, p1_InjExp))

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(diagnosis = ifelse(diagnosis=="Diabetes + Obesity", 1, 0))
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% mutate(gender = ifelse(gender=="M", 1, 0))

temp <- Dems_Labs_TreatExp

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-patient)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% select(-weight)

Dems_Labs_TreatExp %>% group_by(group) %>% count()

Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% group_by(group) %>% sample_n(2000)
Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% ungroup()


Dems_Labs_TreatExp <- Dems_Labs_TreatExp %>% sample_n(6000)


modelAll_1_randomForest <- randomForest(group ~ ., data = Dems_Labs_TreatExp)
summary(modelAll_1_randomForest)
data.frame(modelAll_1_randomForest$importance) %>% arrange(-MeanDecreaseGini)


explainer_ranger <- explain(modelAll_1_randomForest,
                            data = Dems_Labs_TreatExp,
                            y =  Dems_Labs_TreatExp$group,
                            label = "model_RandomForest")

predict(modelAll_1_randomForest, Dems_Labs_TreatExp)


new_observation <- Dems_Labs_TreatExp[953,]
bd_ranger <- predict_parts_break_down(explainer_ranger, new_observation = new_observation)
head(bd_ranger)
plot(bd_ranger)


new_observation <- Dems_Labs_TreatExp[998,]
bd_ranger <- predict_parts_break_down(explainer_ranger, new_observation = new_observation)
head(bd_ranger)
plot(bd_ranger)


new_observation <- Dems_Labs_TreatExp[1000,]
bd_ranger <- predict_parts_break_down(explainer_ranger, new_observation = new_observation)
head(bd_ranger)
plot(bd_ranger)

names(Dems_Labs_TreatExp)

Dems_Labs_TreatExp %>% group_by(group) %>% summarise(n=mean(cumflow))







# --------------------------
# Nancy's Excel -----------------------------

DANU_Demographics <- fread("DANU Demographics.txt")
unique(DANU_Demographics$diagnosis)
DANU_Demographics <- DANU_Demographics %>% filter(diagnosis!="-")
DANU_Demographics %>% group_by(diagnosis) %>% summarise(n=sum(weight))



DANU_Demographics %>% mutate(diagnosis=ifelse(diagnosis!="Obesity", "Diabetes", diagnosis)) %>%
  group_by(diagnosis, gender) %>% summarise(n=sum(weight))



DANU_Demographics %>% mutate(diagnosis=ifelse(diagnosis!="Obesity", "Diabetes", diagnosis)) %>%
  mutate(age=ifelse(age>=18&age<=34, "18-34",
                    ifelse(age>=35&age<=49, "35-49",
                           ifelse(age>=50&age<=64, "50-64",
                                  ifelse(age>=65, "65-80", NA))))) %>%
  group_by(diagnosis, age) %>% summarise(n=sum(weight)) %>%
  mutate(n=ifelse(diagnosis=="Obesity", 100*n/106469049., 100*n/(7949715.+40282960.)))

names(DANU_Demographics)

DANU_Demographics %>% mutate(diagnosis=ifelse(diagnosis!="Obesity", "Diabetes", diagnosis))  %>%
  group_by(diagnosis, race) %>% summarise(n=sum(weight)) %>%
  mutate(n=ifelse(diagnosis=="Obesity", 100*n/106469049., 100*n/(7949715.+40282960.)))


DANU_Demographics <- DANU_Demographics %>% mutate(diagnosis=ifelse(diagnosis!="Obesity", "Diabetes", diagnosis))  %>%
  select(patid, weight, diagnosis)

DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
unique(DANU_Measures_HbA1c$test)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(test=="HbA1c Level")
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, claimed, value) %>% distinct()
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% group_by(patid) %>% filter(claimed==max(claimed))  %>% filter(value==max(value))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% distinct() %>% ungroup() %>% select(-claimed)

DANU_Measures_HbA1c %>% inner_join(DANU_Demographics) %>% mutate(value=ifelse(value<5.7, "<5.7",
                                            ifelse(value<=6.4, "<6.4",
                                                   ifelse(value<=6.9, "<6.9",
                                                          ifelse(value<=7.9, "<7.9",
                                                                 ifelse(value<=8.9, "<8.9", ">9")))))) %>%
  group_by(diagnosis, value) %>% summarise(n=sum(weight))




DANU_Measures_BMI <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
unique(DANU_Measures_BMI$test)
DANU_Measures_BMI <- DANU_Measures_BMI %>% filter(test=="BMI")
DANU_Measures_BMI <- DANU_Measures_BMI %>% select(patid, claimed, value) %>% distinct()
DANU_Measures_BMI <- DANU_Measures_BMI %>% group_by(patid) %>% filter(claimed==max(claimed))  %>% filter(value==max(value))
DANU_Measures_BMI <- DANU_Measures_BMI %>% distinct() %>% ungroup() %>% select(-claimed)

DANU_Measures_BMI %>% inner_join(DANU_Demographics) %>% mutate(value=ifelse(value<18.5, "<18.5",
                                            ifelse(value<=26.9, "<26.9",
                                                   ifelse(value<=29.9, "<29.9",
                                                          ifelse(value<=34.9, "<34.9",
                                                                 ifelse(value<=39.9, "<39.9", ">40")))))) %>%
  group_by(diagnosis, value) %>% summarise(n=sum(weight))





OBE_Comorbidity_Inventories <- fread("OBE Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
Comorbidity_Inventories <- OBE_Comorbidity_Inventories %>% full_join(DIA_Comorbidity_Inventories) %>% distinct()

names(Comorbidity_Inventories)[3] <- "ICD"

Comorbidity_Inventories <- DANU_Demographics %>% inner_join(Comorbidity_Inventories)

DANU_Demographics %>% group_by(diagnosis) %>% summarise(n=sum(weight)) 


# CKD
Comorbidity_Inventories %>% filter(grepl("N18", ICD)) %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 

# CVD
Comorbidity_Inventories %>% filter(grepl("I20", ICD)|
                                   grepl("I21", ICD)|
                                   grepl("I22", ICD)|
                                   grepl("I23", ICD)|
                                   grepl("I24", ICD)|
                                   grepl("I25", ICD)|
                                   grepl("I4", ICD)|
                                   grepl("I6", ICD)|
                                   grepl("G45", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 

# HF
Comorbidity_Inventories %>% filter(grepl("I5", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 


# Ischemic heart Disease
Comorbidity_Inventories %>% filter(grepl("I20", ICD)|
                                   grepl("I21", ICD)|
                                   grepl("I22", ICD)|
                                   grepl("I23", ICD)|
                                   grepl("I24", ICD)|
                                   grepl("I25", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 

# OA
Comorbidity_Inventories %>% filter(grepl("M15", ICD)|
                                   grepl("M16", ICD)|
                                   grepl("M17", ICD)|
                                   grepl("M18", ICD)|
                                   grepl("M19", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 

# SA
Comorbidity_Inventories %>% filter(grepl("G47", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 

# Dyslipidemia
Comorbidity_Inventories %>% filter(grepl("E78", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 

# HTN
Comorbidity_Inventories %>% filter(grepl("I10", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 

# Ischemic heart dis
Comorbidity_Inventories %>% filter(grepl("I20", ICD)|
                                   grepl("I21", ICD)|
                                   grepl("I22", ICD)|
                                   grepl("I23", ICD)|
                                   grepl("I24", ICD)|
                                   grepl("I25", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 


# Pred-Diabetes
Comorbidity_Inventories %>% filter(grepl("R73", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 

# POS
Comorbidity_Inventories %>% filter(grepl("E28", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 

# PAD
Comorbidity_Inventories %>% filter(grepl("I70", ICD)|grepl("I73", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() %>%
  group_by(diagnosis) %>% summarise(n=sum(weight)) 

Groups <- fread("Groups_Diastolic_vs_Systolic_ALL.txt", sep=",")
names(Groups)[1] <- "patid"

Groups %>% inner_join(DANU_Demographics) %>% group_by(diagnosis, group) %>% summarise(n=sum(weight)) 






Dia_US_Doses <- fread("DIA Doses.txt", colClasses = "character")
Dia_US_Doses <- Dia_US_Doses %>% select(pat_id, specialty) %>% distinct()

OBE_US_Doses <- fread("OBE Doses.txt", colClasses = "character")
OBE_US_Doses <- OBE_US_Doses %>% select(pat_id, specialty) %>% distinct()

Doses <- Dia_US_Doses %>% full_join(OBE_US_Doses) %>% distinct()

# names(Doses)[2] <- "code"
# 
# DANU_Specialty_Codes <- fread("DANU Specialty Codes.txt")
# DANU_Specialty_Codes <- DANU_Specialty_Codes %>% select(code, specialty)
# 
# Endos <- Doses %>% left_join(DANU_Specialty_Codes) %>% filter(specialty=="Endocrinologist") %>% select(pat_id) %>% distinct()

Specialties_to_keep <- fread("Specialties_to_keep.txt", , colClasses = "character")
unique(Specialties_to_keep$PHYSICIAN)

Dia_US_Doses %>% left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN))  %>%
  select(pat_id, PHYSICIAN) %>% distinct() %>% drop_na() %>%
  filter(PHYSICIAN!="OTHER PHYSICIAN"&PHYSICIAN!="FACILITY"&PHYSICIAN!="UNKNOWN"&PHYSICIAN!="OTHER HCP") %>% distinct() %>%
  filter(PHYSICIAN=="ENDOCRINOLOGY") %>% select(pat_id) %>% distinct() # 69%


OBE_US_Doses %>% left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN))  %>%
  select(pat_id, PHYSICIAN) %>% distinct() %>% drop_na() %>%
  filter(PHYSICIAN!="OTHER PHYSICIAN"&PHYSICIAN!="FACILITY"&PHYSICIAN!="UNKNOWN"&PHYSICIAN!="OTHER HCP") %>% distinct() %>%
  filter(PHYSICIAN=="ENDOCRINOLOGY") %>%select(pat_id) %>% distinct() 3 435

# ----------------------------------
# Stops and Returns to GLP1  ------------------------------



DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories     <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Drugs!="-")
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
  
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Injectables       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_Oral    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group != "Insulin" & DANU_Ingredients$drug_group != "GLP1 Injectable"], collapse = "|"),")\\b")

DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Inj = ifelse( grepl(string_Injectables, Drugs)&grepl(string_Oral, Drugs), "I+O",
                                                                  ifelse(grepl(string_Injectables, Drugs),"I", 
                                                                        ifelse(grepl(string_Oral,Drugs), "O", NA))))

DIA_Drug_Histories_2 <- DIA_Drug_Histories %>% select(patient, weight, Month, Inj) %>%
  filter(grepl("I", Inj)) %>% select(patient) %>% distinct() %>%
  left_join(DIA_Drug_Histories %>% select(patient, weight, Month, Inj))

DIA_Drug_Histories_2

DIA_Drug_Histories_2 <- DIA_Drug_Histories_2 %>% spread(key=Month, value=Inj)

DIA_Drug_Histories_2[is.na(DIA_Drug_Histories_2)] <- "-"

DIA_Drug_Histories_2 <- gather(DIA_Drug_Histories_2, Month, Drugs, `1`:`60`, factor_key=TRUE)

DIA_Drug_Histories_2 <- DIA_Drug_Histories_2 %>% arrange(patient, Month)




DIA_Drug_Histories_3 <- DIA_Drug_Histories_2 %>% group_by(patient, weight) %>% 
  slice(if(any(grepl("I",Drugs))) which.max(grepl("I",Drugs)):which.max(Month=="60") else NA) 

DIA_Drug_Histories_3 <- DIA_Drug_Histories_3 %>% group_by(patient) %>% mutate(grp = rle(Drugs)$lengths %>% {rep(seq(length(.)), .)})

DIA_Drug_Histories_3 <- DIA_Drug_Histories_3 %>% arrange(patient, Month)



DIA_Drug_Histories_3 %>% ungroup() %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 5373357 Inj exp



DIA_Drug_Histories_3 %>% ungroup() %>% filter(grp!=1) %>%
   filter(!grepl("I", Drugs)) %>% select(patient, weight, Drugs, grp) %>%
  group_by(patient, weight, grp) %>% count() %>% ungroup() %>%
  filter(n>=3) %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # stopped >= 6 months 2745147 / 3445663


DIA_Drug_Histories_3 %>% ungroup() %>% filter(grp!=1) %>%
   filter(!grepl("I", Drugs)) %>% select(patient, weight, Drugs, grp) %>%
  group_by(patient, weight, grp) %>% count() %>% ungroup() %>%
  filter(n>=3) %>% select(patient, weight, grp) %>% distinct() %>%
  group_by(patient, weight) %>% filter(grp==min(grp)) %>%
  rename("Stopgrp"="grp") %>%
  inner_join(
    DIA_Drug_Histories_3 %>% ungroup() %>% filter(grp!=1) %>%
   filter(grepl("I", Drugs)) %>% select(patient, weight, grp) %>% distinct() %>%
  rename("Injgrp"="grp")
  ) %>%
  filter(Injgrp>Stopgrp) %>%
  select(patient, weight)  %>% distinct() %>% ungroup() %>% summarise(n=sum(weight)) # 948467 / 1680926 went back to Inj after a 6 month lapse


# went back to injectables: same or different injectable? 


Months_Return <- DIA_Drug_Histories_3 %>% ungroup() %>% filter(grp!=1) %>%
   filter(!grepl("I", Drugs)) %>% select(patient, weight, Drugs, grp) %>%
  group_by(patient, weight, grp) %>% count() %>% ungroup() %>%
  filter(n>=3) %>% select(patient, weight, grp) %>% distinct() %>%
  group_by(patient, weight) %>% filter(grp==min(grp)) %>%
  rename("Stopgrp"="grp") %>%
  inner_join(
    DIA_Drug_Histories_3 %>% ungroup() %>% filter(grp!=1) %>%
   filter(grepl("I", Drugs)) %>% select(patient, weight, grp) %>% distinct() %>%
  rename("Injgrp"="grp")
  ) %>%
  filter(Injgrp>Stopgrp) %>%
  select(patient, weight, Injgrp)  %>% distinct() %>%   
  group_by(patient, weight) %>% filter(Injgrp==min(Injgrp)) %>%
  rename("grp"="Injgrp") %>%
  left_join(DIA_Drug_Histories_3 %>% select(-Drugs)) %>% mutate(Month=as.numeric(Month))

First_I <- DIA_Drug_Histories_3  %>%   group_by(patient, weight) %>%
  mutate(Month=as.numeric(Month)) %>% filter(grp ==min(grp )) %>% select(-Drugs)


DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories     <- Months_Return %>% select(patient) %>% distinct() %>% ungroup() %>% left_join(DIA_Drug_Histories) %>% select(-c(disease))
DIA_Drug_Histories %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight))
DIA_Drug_Histories       <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Drugs!="-")
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, Drugs, sep = ",", convert=T )

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
string_Injectables       <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(grepl(string_Injectables, Drugs))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, weight, Month, Drugs) %>%
  group_by(patient, weight, Month) %>% mutate(Drugs = paste(Drugs, collapse=",")) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% distinct()


data.frame(Months_Return %>% group_by(patient) %>%
            filter(Month==min(Month)) %>% select(-grp) %>%
             left_join(DIA_Drug_Histories) %>%
             rename("ReturnMonth"="Month", "ReturnGLP"="Drugs")) %>%
  left_join(First_I %>% group_by(patient) %>% filter(Month==min(Month)) %>% select(-grp)) %>%
  left_join(DIA_Drug_Histories) %>%
  rename("FirstMonth"="Month", "FirstGLP"="Drugs") %>%
  #select(patient, weight)  %>% summarise(n=sum(weight)) # 948467.2  # 1680926
  filter(ReturnGLP==FirstGLP) %>% select(patient, weight)  %>% summarise(n=sum(weight)) # 515491.5 # 0.5434996   ,  # 1124250 # 67%



Months_Return  %>% select(-grp) %>% inner_join(DIA_Drug_Histories) %>% rename("ReturnMonth"="Month", "ReturnGLP"="Drugs") %>%
  select(patient, weight, ReturnGLP) %>% distinct() %>% 
  separate_rows(ReturnGLP,  sep = ",", convert=T ) %>%
  arrange(patient, weight, ReturnGLP) %>% distinct() %>%
  group_by(patient, weight) %>% mutate(ReturnGLP = paste(ReturnGLP, collapse=","))  %>% distinct() %>%
  left_join(
    First_I  %>% select(-grp) %>% inner_join(DIA_Drug_Histories) %>% rename("FirstMonth"="Month", "FirstGLP"="Drugs") %>%
  select(patient, weight, FirstGLP) %>% distinct() %>%
    separate_rows(FirstGLP,  sep = ",", convert=T ) %>%
  arrange(patient, weight, FirstGLP) %>% distinct() %>%
  arrange(patient, weight, FirstGLP) %>%
  group_by(patient, weight) %>% mutate(FirstGLP = paste(FirstGLP, collapse=","))  %>% distinct()
  ) %>%
  filter(ReturnGLP==FirstGLP) %>% select(patient, weight) %>% distinct() %>%  ungroup() %>% summarise(n=sum(weight)) # 486832 , 51%  # 1062332, 63%

# ----------------------
# Prevalence DIA / OBE / CKD / HF / NAFLD per age group -----------------------------------

# Diabetes
DANU_Demographics <- fread("DANU Demographics.txt")
Diabetes <- DANU_Demographics %>% select(patid, weight, diagnosis, age) %>% filter(grepl("Diabetes", diagnosis))
Diabetes <- Diabetes %>% group_by(age) %>% summarise(DIA_Population=sum(weight))
data.frame(Diabetes)
# Obesity
DANU_Demographics <- fread("DANU Demographics.txt")
Obesity <- DANU_Demographics %>% select(patid, weight, diagnosis, age) %>% filter(grepl("Obesity", diagnosis))
Obesity <- Obesity %>% group_by(age) %>% summarise(OBE_Population=sum(weight))

DANU_Measures <- fread("DANU Measures.txt")
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patid, weight, value, claimed) %>%
  mutate(claimed=as.Date(claimed)) %>% group_by(patid) %>% filter(claimed==max(claimed)) %>% filter(value==max(value))
DANU_Measures <- DANU_Measures %>% distinct()
DANU_Measures <- DANU_Measures %>% select(patid, weight, value)

DANU_Demographics <- fread("DANU Demographics.txt")

Obesity_30_share <- DANU_Demographics %>% filter(grepl("Obesity", diagnosis)) %>% select(patid, weight, age) %>%
  inner_join(DANU_Measures) %>%
  group_by(age) %>% summarise(n=sum(weight)) %>%
  left_join(
    DANU_Demographics %>% filter(grepl("Obesity", diagnosis)) %>% select(patid, weight, age) %>%
  inner_join(DANU_Measures %>% filter(value>=30)) %>%
  group_by(age) %>% summarise(n2=sum(weight))
  ) %>% mutate(share=n2/n)

Obesity_30_share <- Obesity_30_share %>% select(age, share)



# Chronic Kidney Disease
DANU_Dossiers_Full <- fread("DANU Dossiers Full.txt")
CKD_Demographics <- fread("CKD Demographics.txt")
Chronic_Kidney_Disease <- CKD_Demographics %>% filter(died=="N" ) %>% 
  inner_join(DANU_Dossiers_Full %>% filter(grepl("N18",code)) %>% select(patid, weight, age) %>% distinct()) %>% 
  group_by(age)  %>% summarise(CKD_Population=sum(weight))  


# Heart Failure
HF_Demographics <- fread("HF Demographics.txt")
names(HF_Demographics)[1] <- "patient"
HF_Demographics <- HF_Demographics %>% filter(died=="N") %>% select(patient, weight, age) %>% drop_na()

DANU_Diagnosis_Codes <- fread("DANU Diagnosis Codes.txt")
DANU_Diagnosis_Codes <- DANU_Diagnosis_Codes %>% filter(diagnosis == "Heart Failure") %>% select(code, description)

DANU_Dossiers <- fread("DANU Dossiers.txt")
names(DANU_Dossiers)[1] <- "patient"

DANU_Dossiers <- HF_Demographics %>% select(patient) %>% inner_join(DANU_Dossiers) %>% select(patient, weight, code, earliest, latest, frequency)
DANU_Dossiers <- DANU_Dossiers %>% left_join(DANU_Diagnosis_Codes) %>% drop_na()

Heart_Failure <- DANU_Dossiers %>% filter(grepl("ystolic", description)|grepl("iastolic", description)) %>%
  group_by(patient) %>% summarise(n=sum(frequency)) %>% filter(n>1) %>%
  select(patient) %>% left_join(HF_Demographics) %>% 
  group_by(age)  %>% summarise(HF_Population=sum(weight))  

# NAFLD
NAFLD_Demographics <- fread("NAFLD Demographics.txt")
NAFLD_Demographics <- NAFLD_Demographics %>% select(patid, weight, age)
NAFLD <- NAFLD_Demographics  %>% group_by(age)  %>% summarise(NAFLD_Population=sum(weight))  




US_Population <- fread("Optum weights.txt")
US_Population <- US_Population %>% group_by(age) %>% summarise(TOTAL_US=sum(insured_population))
sum(US_Population$TOTAL_US)


data.frame(Diabetes %>% 
             left_join(Obesity_30_share) %>% 
             left_join(Chronic_Kidney_Disease) %>% 
             left_join(Heart_Failure) %>% 
             left_join(NAFLD) %>%
             left_join(US_Population)) %>%
  mutate(DIA_Population = DIA_Population / TOTAL_US,
         OBE_Population  = share  ,
         CKD_Population  = CKD_Population  / TOTAL_US,
         HF_Population  = HF_Population  / TOTAL_US,
         NAFLD_Population = NAFLD_Population / TOTAL_US) %>% select(-c(TOTAL_US, share)) %>%
  select(age, DIA_Population, OBE_Population, CKD_Population, HF_Population, NAFLD_Population) %>%
  gather(Disease, Prevalence, DIA_Population:NAFLD_Population, factor_key=TRUE) %>%
  ggplot((aes(age, Prevalence, colour=Disease))) +
  geom_smooth(size=2, se = F) +
    theme_minimal() +
  scale_y_continuous(labels = scales::percent)+
  xlab("\n \n Age (years)") +  ylab("US Insured Population Prevalence\n \n") +
  ggsci::scale_colour_jco()



# --------------------------------------


# Age at onset ---------------
# Diabetes
DANU_Demographics <- fread("DANU Demographics.txt")
Diabetes <- DANU_Demographics %>% filter(grepl("Diabetes", diagnosis)) %>% filter(diabetes_onset>="2020-05-01") %>% select(patid, weight, age) 


# Obesity
DANU_Demographics <- fread("DANU Demographics.txt")
Obesity <- DANU_Demographics %>% filter(grepl("Obesity", diagnosis)&obesity_condition !="Overweight") %>% filter(obesity_onset>="2020-05-01") %>% select(patid, weight, age) 


# Chronic Kidney Disease
DANU_Dossiers_Full <- fread("DANU Dossiers Full.txt")
CKD_Demographics <- fread("CKD Demographics.txt")
Chronic_Kidney_Disease <- CKD_Demographics %>% filter(died=="N" ) %>% 
  inner_join(DANU_Dossiers_Full %>% filter(grepl("N18",code)) %>% select(patid) %>% distinct()) %>%
              filter(ckd_onset>="2020-05-01" ) %>% select(patid, weight, age) %>% distinct()


# Heart Failure
HF_Demographics <- fread("HF Demographics.txt")
names(HF_Demographics)[1] <- "patient"
HF_Demographics <- HF_Demographics %>% filter(died=="N") %>% select(patient, weight, age) %>% drop_na()

DANU_Diagnosis_Codes <- fread("DANU Diagnosis Codes.txt")
DANU_Diagnosis_Codes <- DANU_Diagnosis_Codes %>% filter(diagnosis == "Heart Failure") %>% select(code, description)

DANU_Dossiers <- fread("DANU Dossiers.txt")
names(DANU_Dossiers)[1] <- "patient"

DANU_Dossiers <- HF_Demographics %>% select(patient) %>% inner_join(DANU_Dossiers) %>% select(patient, weight, code, earliest, latest, frequency)
DANU_Dossiers <- DANU_Dossiers %>% left_join(DANU_Diagnosis_Codes) %>% drop_na()

Heart_Failure <- DANU_Dossiers %>% filter(grepl("ystolic", description)|grepl("iastolic", description)) %>%
  group_by(patient) %>% summarise(n=sum(frequency)) %>% filter(n>1) %>%
  left_join(DANU_Dossiers) %>% filter(earliest>="2020-05-01") %>%
  select(patient) %>% left_join(HF_Demographics) 
names(Heart_Failure)[1] <- "patid"

# NAFLD
NAFLD_Demographics <- fread("NAFLD Demographics.txt")
NAFLD <- NAFLD_Demographics %>% filter(nafld >="2020-05-01") %>% select(patid, weight, age)

Diabetes$group <- "Diabetes"
Obesity$group <- "Obesity"
Chronic_Kidney_Disease$group <- "CKD"
Heart_Failure$group <- "HF"
NAFLD$group <- "NAFLD"


Diabetes %>%
  bind_rows(Obesity) %>%
  bind_rows(Chronic_Kidney_Disease) %>%
  bind_rows(Heart_Failure) %>%
  bind_rows(NAFLD) %>%
  group_by(group) %>% summarise(n=weighted.mean(age, weight))



Diabetes %>%
  bind_rows(Obesity) %>%
  bind_rows(Chronic_Kidney_Disease) %>%
  bind_rows(Heart_Failure) %>%
  bind_rows(NAFLD) %>%
  mutate(group=as.factor(group)) %>%
    mutate(group=fct_relevel(group,c("Diabetes","Obesity","CKD","HF","NAFLD"))) %>%
  ggplot(aes(age, colour=as.factor(group), fill=as.factor(group))) +
  geom_density() +
    ggsci::scale_colour_jco(alpha = 0.8)+
    ggsci::scale_fill_jco(alpha = 0.8) +
      theme_minimal() +
  xlab("\n \n Age at onset (years)") +  ylab("Cohort Proportion\n \n") +
    facet_wrap(~group, ncol = 1)

# --------------
# Dx or Rx Last year ---------------------------------

DIA_Doses <- fread("DIA Doses.txt")

Rx_LastYear <- DIA_Doses %>% filter(paid=="P") %>% 
  select(pat_id, weight, from_dt) %>% 
  mutate(from_dt=as.Date(from_dt)) %>%
  filter(from_dt>="2020-05-01") %>%
  select(pat_id, weight) %>% distinct() %>% rename("patient"="pat_id")

DANU_Events <- fread("DANU Events.txt")
DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
DANU_Events <- DANU_Events %>% inner_join(DIA_Drug_Histories %>% select(patient), by=c("patid"="patient"))

Dx_LastYear <- DANU_Events %>%
  mutate(claimed=as.Date(claimed)) %>%
  filter(claimed>="2020-05-01") %>%
  select(patid, weight) %>% distinct() %>% rename("patient"="patid")
 
Rx_LastYear$Rx <- "Rx"

Dx_LastYear$Dx <- "Dx"

Rx_LastYear %>% full_join(Dx_LastYear) %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 39980514

Treatment_exp_vector <- fread("Treatment_exp_vector.txt")
      

Rx_LastYear %>% full_join(Dx_LastYear) %>% inner_join(Treatment_exp_vector) %>%
  select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 27992576

Rx_LastYear %>% full_join(Dx_LastYear) %>% inner_join(Treatment_exp_vector) %>%
  filter(Rx=="Rx"&is.na(Dx)) %>%
  select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 2056603

Rx_LastYear %>% full_join(Dx_LastYear) %>% inner_join(Treatment_exp_vector) %>%
  filter(Dx=="Dx"&is.na(Rx)) %>%
  select(patient, weight) %>% distinct() %>% summarise(n=sum(weight)) # 5684657
# ---------------------------
# Drug usage per age bucket ---------------------

# Drugs Diabetes
DANU_Ingredients <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients <- DANU_Ingredients %>% select(molecule, generic_name, drug_class)
DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease)) %>% select(1,2,3:62)
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Drugs!="-")
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, Drugs, sep = ",", convert=T )
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(patient, weight, Drugs) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Drugs=as.character(Drugs)) %>%  left_join(DANU_Ingredients, by=c("Drugs"="molecule"))  %>%
  select(patient, weight, generic_name, drug_class) %>% distinct()

# Drugs Obesity
DANU_Ingredients <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients <- DANU_Ingredients %>% select(molecule, generic_name, drug_class)
OBE_Drug_Histories <- fread("OBE Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
OBE_Drug_Histories <- OBE_Drug_Histories %>% select(-c(disease)) %>% select(1,2,3:62)
OBE_Drug_Histories <- gather(OBE_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
OBE_Drug_Histories$Month <- as.character(OBE_Drug_Histories$Month)
OBE_Drug_Histories$Month <- parse_number(OBE_Drug_Histories$Month)
OBE_Drug_Histories <- OBE_Drug_Histories %>% filter(Drugs!="-")
OBE_Drug_Histories <- separate_rows(OBE_Drug_Histories, Drugs, sep = ",", convert=T )
OBE_Drug_Histories <- OBE_Drug_Histories %>% select(patient, weight, Drugs) %>% distinct()
OBE_Drug_Histories <- OBE_Drug_Histories %>%  mutate(Drugs=as.character(Drugs)) %>%  left_join(DANU_Ingredients, by=c("Drugs"="molecule"))  %>%
  select(patient, weight, generic_name, drug_class) %>% distinct()


# Drugs Heart Failure
HF_Ingredients <- fread("HF Ingredients.txt", integer64 = "character", stringsAsFactors = F)
HF_Ingredients <- HF_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
HF_Ingredients <- HF_Ingredients %>% select(molecule, generic_name, drug_class)
HF_Drug_Histories     <- fread("HF Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
HF_Drug_Histories     <- HF_Drug_Histories %>% select(-c(disease))  %>% select(1,2,3:62)
HF_Drug_Histories     <- gather(HF_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
HF_Drug_Histories$Month <- as.character(HF_Drug_Histories$Month)
HF_Drug_Histories$Month <- parse_number(HF_Drug_Histories$Month)
HF_Drug_Histories <- HF_Drug_Histories %>% filter(Drugs != "-") 
HF_Drug_Histories <- separate_rows(HF_Drug_Histories, Drugs, sep = ",", convert=T )
HF_Drug_Histories <- HF_Drug_Histories %>% select(patient, weight, Drugs) %>% distinct()
HF_Drug_Histories <- HF_Drug_Histories %>% mutate(Drugs=as.character(Drugs)) %>% left_join(HF_Ingredients, by=c("Drugs"="molecule"))  %>%
  select(patient, weight, generic_name, drug_class) %>% distinct()


# Drugs CKD 
CKD_Ingredients <- fread("CKD Ingredients.txt", integer64 = "character", stringsAsFactors = F)
CKD_Ingredients <- CKD_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
CKD_Ingredients <- CKD_Ingredients %>% select(molecule, generic_name, drug_class)
CKD_Drug_Histories     <- fread("CKD Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
CKD_Drug_Histories     <- CKD_Drug_Histories %>% select(-c(disease))  %>% select(1,2,3:62)
CKD_Drug_Histories     <- gather(CKD_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
CKD_Drug_Histories$Month <- as.character(CKD_Drug_Histories$Month)
CKD_Drug_Histories$Month <- parse_number(CKD_Drug_Histories$Month)
CKD_Drug_Histories <- CKD_Drug_Histories %>% filter(Drugs != "-") 
CKD_Drug_Histories <- separate_rows(CKD_Drug_Histories, Drugs, sep = ",", convert=T )
CKD_Drug_Histories <- CKD_Drug_Histories %>% select(patient, weight, Drugs) %>% distinct()
CKD_Drug_Histories <- CKD_Drug_Histories %>% mutate(Drugs=as.character(Drugs)) %>% left_join(CKD_Ingredients, by=c("Drugs"="molecule"))  %>%
  select(patient, weight, generic_name, drug_class) %>% distinct()




# Drugs NAFLD 
NASH_Ingredients <- fread("NASH Ingredients.txt", integer64 = "character", stringsAsFactors = F)
NASH_Ingredients <- NASH_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
NASH_Ingredients <- NASH_Ingredients %>% select(molecule, generic_name, drug_class)
NAFLD_Drug_Histories     <- fread("NAFLD Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
NAFLD_Drug_Histories     <- NAFLD_Drug_Histories %>% select(-c(disease))  %>% select(1,2,3:62)
NAFLD_Drug_Histories     <- gather(NAFLD_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
NAFLD_Drug_Histories$Month <- as.character(NAFLD_Drug_Histories$Month)
NAFLD_Drug_Histories$Month <- parse_number(NAFLD_Drug_Histories$Month)
NAFLD_Drug_Histories <- NAFLD_Drug_Histories %>% filter(Drugs != "-") 
NAFLD_Drug_Histories <- separate_rows(NAFLD_Drug_Histories, Drugs, sep = ",", convert=T )
NAFLD_Drug_Histories <- NAFLD_Drug_Histories %>% select(patient, weight, Drugs) %>% distinct()
NAFLD_Drug_Histories <- NAFLD_Drug_Histories %>% mutate(Drugs=as.character(Drugs)) %>% left_join(NASH_Ingredients, by=c("Drugs"="molecule"))  %>%
  select(patient, weight, generic_name, drug_class) %>% distinct()




ALL_Drug_Histories <- DIA_Drug_Histories %>% 
bind_rows(OBE_Drug_Histories) %>% 
  bind_rows(HF_Drug_Histories) %>%
  bind_rows(CKD_Drug_Histories) %>%
  bind_rows(NAFLD_Drug_Histories) %>% distinct()

data.frame(unique(ALL_Drug_Histories$drug_class))


# Diabetes
DANU_Demographics <- fread("DANU Demographics.txt")
Diabetes <- DANU_Demographics %>% select(patid, weight, diagnosis, age) %>% filter(grepl("Diabetes", diagnosis)) %>% select(-diagnosis)

# Obesity
DANU_Demographics <- fread("DANU Demographics.txt")
Obesity <- DANU_Demographics %>% select(patid, weight, diagnosis, age) %>% filter(grepl("Obesity", diagnosis))  %>% select(-diagnosis)




# Chronic Kidney Disease
DANU_Dossiers_Full <- fread("DANU Dossiers Full.txt")
CKD_Demographics <- fread("CKD Demographics.txt")
Chronic_Kidney_Disease <- CKD_Demographics %>% filter(died=="N" ) %>% 
  inner_join(DANU_Dossiers_Full %>% filter(grepl("N18",code)) %>% select(patid, weight, age) %>% distinct()) 
Chronic_Kidney_Disease <- Chronic_Kidney_Disease %>% select(patid, weight, age) %>% distinct()

# Heart Failure
HF_Demographics <- fread("HF Demographics.txt")
names(HF_Demographics)[1] <- "patient"
HF_Demographics <- HF_Demographics %>% filter(died=="N") %>% select(patient, weight, age) %>% drop_na()

DANU_Diagnosis_Codes <- fread("DANU Diagnosis Codes.txt")
DANU_Diagnosis_Codes <- DANU_Diagnosis_Codes %>% filter(diagnosis == "Heart Failure") %>% select(code, description)

DANU_Dossiers <- fread("DANU Dossiers.txt")
names(DANU_Dossiers)[1] <- "patient"

DANU_Dossiers <- HF_Demographics %>% select(patient) %>% inner_join(DANU_Dossiers) %>% select(patient, weight, code, earliest, latest, frequency)
DANU_Dossiers <- DANU_Dossiers %>% left_join(DANU_Diagnosis_Codes) %>% drop_na()

Heart_Failure <- DANU_Dossiers %>% filter(grepl("ystolic", description)|grepl("iastolic", description)) %>%
  group_by(patient) %>% summarise(n=sum(frequency)) %>% filter(n>1) %>%
  select(patient) %>% left_join(HF_Demographics)
names(Heart_Failure)[1] <- "patid"

# NAFLD
NAFLD_Demographics <- fread("NAFLD Demographics.txt")
NAFLD_Demographics <- NAFLD_Demographics %>% select(patid, weight, age)

All_Ages <- Diabetes %>%  bind_rows(Obesity) %>% distinct() %>%
  bind_rows(Chronic_Kidney_Disease) %>% bind_rows(Heart_Failure) %>% bind_rows(NAFLD_Demographics) %>% distinct()


data.frame(
  All_Ages %>% rename("patient"="patid") %>% 
  left_join(
    ALL_Drug_Histories %>% select(-drug_class) %>% group_by(patient, weight) %>% count()
    ) %>% 
  mutate(n=ifelse(is.na(n),0,n)) %>% ungroup() %>%
  group_by(age) %>% summarise(n=weighted.median(n, weight))
  )

data.frame(All_Ages %>% rename("patient"="patid") %>%
  group_by(age) %>% summarise(n=sum(weight)))

ALL_Drug_Histories_short <- data.frame(ALL_Drug_Histories %>% select(-generic_name) %>% 
             drop_na() %>%
             filter(drug_class!="Death") %>%
  mutate(drug_class=ifelse(grepl("Insulin", drug_class), "Insulin", drug_class)) %>%
  mutate(drug_class=ifelse(grepl("GLP1", drug_class), "GLP1", drug_class)) %>%
      mutate(drug_class=ifelse(grepl("Sulfonylurea", drug_class)|grepl("Antidiabetic", drug_class)|grepl("Glinide", drug_class)|grepl("Glitazone", drug_class)|grepl("AGI", drug_class), "Antidiabetic", drug_class)) %>%
      mutate(drug_class=ifelse(grepl("Device", drug_class)|grepl("Dialysis", drug_class)|grepl("Transplant", drug_class)|grepl("Surgery", drug_class)|grepl("Inpatient", drug_class), "Procedure", drug_class)) %>%
      mutate(drug_class=ifelse(grepl("Weight Loss", drug_class)|grepl("Antiobesity", drug_class)|grepl("Anorectic", drug_class), "Antiobesity", drug_class)) %>%
          mutate(drug_class=ifelse(grepl("Statin", drug_class)|grepl("Hepatoprotective", drug_class)|grepl("Fibrate", drug_class)|grepl("Biologic", drug_class)|grepl("BAS", drug_class)|grepl("Anticholesterol", drug_class), "Lipid_Lowering", drug_class)) %>%
          mutate(drug_class=ifelse(grepl("Other", drug_class)|grepl("Vasodilator", drug_class)|grepl("Inotropic", drug_class)|grepl("Antihypertensive", drug_class), "Other_Antihypertensive", drug_class)) %>%
          mutate(drug_class=ifelse(grepl("ARNI", drug_class)|grepl("ARB", drug_class)|grepl("ACE", drug_class), "RAAS", drug_class)) %>%
                      select(patient, weight, drug_class) %>% distinct() ) 


temp <- data.frame(All_Ages %>% rename("patient"="patid") %>% group_by(age) %>% summarise(n=sum(weight)) %>%
  left_join(ALL_Drug_Histories_short %>% inner_join(All_Ages %>% rename("patient"="patid")) %>% group_by(age, drug_class) %>% summarise(n2=sum(weight)) %>%
  ungroup() %>% spread(key=drug_class, value=n2)))


fwrite(temp, "temp.csv", sep=",")


# -----------------------

# % of Treatment-experienced patients  Who have tried GLP1 ---------------
DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
string_GLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"|DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")


Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories  %>% select(patient, weight, Treat) %>% distinct() %>%
  filter(grepl(string_GLP1, Treat)) %>% select(patient, weight) %>% distinct() %>% mutate(GLP1exp="GLP1exp")

DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% select(patid, age) %>% rename("patient"="patid")

DANU_Demographics %>% inner_join(Treatment_exp_Vector) %>%
  left_join(DIA_Drug_Histories) %>%
  group_by(age, GLP1exp) %>% summarise(n=sum(weight)) %>%
  ungroup() %>% spread(key=GLP1exp, value=n) %>%
  rename("No_GLP1"="<NA>") %>%
  mutate(Perc=GLP1exp/(GLP1exp+No_GLP1)) %>%
  ggplot(aes(age, Perc)) +
  geom_col(width=0.6, alpha=0.4) +
  geom_smooth(size=2, colour="firebrick", fill="firebrick", alpha=0.5) +
  scale_y_continuous(labels = scales::percent)+
  xlab(" \n Age (years)") + ylab("% of Treatment-experienced patients \n Who have tried GLP1") +
  theme_minimal()

# -----------------------------
# GLP1 patients, 1st vs 2nd one, ON vs OFF over time -----------------------------------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
string_GLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"|DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_Sema <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$generic_name == "Semaglutide Injectable"], collapse = "|"),")\\b")


Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories <- DIA_Drug_Histories  %>% filter(Treat!="-" & grepl(string_GLP1, Treat)) 
DIA_Drug_Histories <- DIA_Drug_Histories  %>% mutate(Sema=ifelse(grepl(string_Sema, Treat), 1,0))

data.frame(DIA_Drug_Histories   %>% group_by(Month, Sema) %>% summarise(n=sum(weight)) %>%
  ungroup() %>% spread(key=Sema, value=n))


DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% select(patid, age) %>% rename("patient"="patid")

data.frame(DIA_Drug_Histories %>% left_join(DANU_Demographics) %>%
  group_by(age, Sema)  %>% summarise(n=sum(weight)) %>%
  ungroup() %>% spread(key=Sema, value=n)) %>% 
  mutate(Perc=X1/(X1+X0)) %>% ungroup() %>%
  ggplot(aes(age, Perc)) +
    geom_col(width=0.6, alpha=0.4) +
  geom_smooth(size=2, colour="firebrick", fill="firebrick", alpha=0.5) +
  scale_y_continuous(labels = scales::percent)+
  xlab(" \n Age (years)") + ylab("% of GLP1 patients \n ON Semaglutide Injectable \n") +
  theme_minimal()


DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patient, claimed, value)
DANU_Measures <- DANU_Measures %>% inner_join(DIA_Drug_Histories %>% select(patient) %>% distinct())
DANU_Measures <- DANU_Measures %>% mutate(claimed=format(as.Date(claimed), "%Y-%m")) 

Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by=c("claimed"="Month"))
DANU_Measures <- DANU_Measures %>% select(-claimed)
DANU_Measures <- DANU_Measures %>% drop_na() %>% rename("Month"="Exact_Month")

DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

temp <- DANU_Measures %>% inner_join(DIA_Drug_Histories) %>% group_by(value, Sema) %>% summarise(n=sum(weight)) %>%
  ungroup() %>% spread(key=Sema, value=n)

temp[is.na(temp)] <- 0

temp %>% mutate(Perc=`1`/(`1`+`0`)) %>%
  ggplot(aes(value, Perc)) +
  geom_point() +
  #geom_smooth(se=F, size=2, colour="deepskyblue4", method="loess") +
  scale_y_continuous(labels = scales::percent)+
  xlab(" \n HbA1c Level (%)") + ylab("% of GLP1 patients \n ON Semaglutide Injectable \n") +
  theme_minimal()





DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
string_GLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"|DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")


Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

FirstGLP1 <- DIA_Drug_Histories %>% filter(Treat!="-") %>% filter(grepl(string_GLP1, Treat)) %>%
  group_by(patient) %>% filter(Month==min(Month))
FirstGLP1 <- separate_rows(FirstGLP1, Treat, sep = ",", convert=T )
FirstGLP1 <- FirstGLP1 %>% filter(grepl(string_GLP1, Treat))
FirstGLP1 <- FirstGLP1 %>% arrange(patient, weight, Month, Treat) %>% group_by(patient, weight, Month) %>% mutate(Treat=paste(Treat, collapse=",")) %>% distinct()

DIA_Drug_Histories <- DIA_Drug_Histories  %>% inner_join(FirstGLP1 %>% ungroup() %>% select(patient))
names(FirstGLP1)[3] <- "FirstGLP1_Month"
names(FirstGLP1)[4] <- "FirstGLP1_Mol"


ignore <- separate_rows(DIA_Drug_Histories, Treat, sep = ",", convert=T )
ignore <- ignore %>% arrange(patient, weight, Month, Treat) %>% group_by(patient, weight, Month) %>% mutate(Treat=paste(Treat, collapse=",")) %>% distinct()



temp <- ignore %>% left_join(FirstGLP1)

temp$SameFirst <- mapply(grepl, temp$FirstGLP1_Mol, temp$Treat)
temp$SameFirst <- as.numeric(temp$SameFirst)

temp <- temp %>% mutate(ON_GLP1=ifelse(grepl(string_GLP1, Treat),1,0)) 
temp <- temp %>% group_by(patient) %>% mutate(CumSameFirst=cumsum(SameFirst))
temp <- temp %>% arrange(patient, Month)
temp <- temp %>% mutate(CumSameFirst=ifelse(CumSameFirst==0,0,1))

temp <- temp %>% mutate(OtherGLP=ifelse(grepl(string_GLP1, Treat) & SameFirst==0,1,0))
temp <- temp %>% group_by(patient) %>% mutate(CumOther=cumsum(OtherGLP))
temp <- temp %>% mutate(CumOther=ifelse(CumOther==0,0,1))

data.frame(temp %>% ungroup()  %>% group_by(Month, ON_GLP1, CumSameFirst, SameFirst, CumOther) %>% summarise(n=sum(weight)) %>%
  mutate(Group=ifelse(ON_GLP1==1 & CumOther==0, "ON_1st",
                      ifelse(ON_GLP1==1 & CumOther==1, "ON_2nd",
                             ifelse(ON_GLP1==0 & CumOther==0 & CumSameFirst==1, "OFF_1st",
                                    ifelse(ON_GLP1==0 & CumOther==1 & CumSameFirst==1, "OFF_2nd", "Naive"))))) %>%
  group_by(Month, Group) %>% summarise(n2=sum(n)) %>% 
  ungroup() %>% spread(key=Group, value=n2))
  


  


# ---------------------------------------
# Max HbA1c , BMI, age per Semaglutide Inj vs No Semaglutide Inj ---------------------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients$drug_id <- unlist(lapply(DANU_Ingredients$drug_id, function(x) as.numeric(unlist(str_extract_all(x,"[:digit:]+$")))))
string_GLP1 <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$drug_group == "GLP1 Injectable"|DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_Sema <- paste0("\\b(",paste0(DANU_Ingredients$drug_id[DANU_Ingredients$generic_name == "Semaglutide Injectable"], collapse = "|"),")\\b")


Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Dems_Labs_TreatExp <- Treatment_exp_Vector %>% inner_join(DIA_Drug_Histories)
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-c(disease)) 
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)

DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)


GLP1_exp <- DIA_Drug_Histories  %>% select(patient, weight, Treat) %>% distinct() %>%
  filter(grepl(string_GLP1, Treat)) %>% select(patient, weight) %>% distinct() %>% mutate(GLP1exp="GLP1exp")

GLP1_exp <- GLP1_exp %>% left_join(DIA_Drug_Histories  %>%  distinct() %>%
  filter(grepl(string_GLP1, Treat)) %>% group_by(patient) %>% filter(Month==min(Month)) %>% select(patient, Month) %>% 
  rename("FirstGLP1"="Month"))

Sema_exp <- DIA_Drug_Histories  %>% select(patient, weight, Treat) %>% distinct() %>%
  filter(grepl(string_Sema, Treat)) %>% select(patient, weight) %>% distinct() %>% mutate(Semaexp="Semaexp")


Sema_exp <- Sema_exp %>% left_join(DIA_Drug_Histories  %>%  distinct() %>%
  filter(grepl(string_Sema, Treat)) %>% group_by(patient) %>% filter(Month==min(Month)) %>% select(patient, Month) %>% 
  rename("FirstGLP1"="Month"))


temp <- GLP1_exp %>% left_join(Sema_exp) %>% mutate(Semaexp=ifelse(is.na(Semaexp), "None", Semaexp))


Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")


DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <- DANU_Measures %>% filter(test=="BMI") %>% select(patient, claimed, value)
DANU_Measures <- DANU_Measures %>% inner_join(temp %>% select(patient) %>% distinct())
DANU_Measures <- DANU_Measures %>% mutate(claimed=format(as.Date(claimed), "%Y-%m")) 
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by=c("claimed"="Month"))
DANU_Measures <- DANU_Measures %>% select(-claimed)
DANU_Measures <- DANU_Measures %>% drop_na() %>% rename("Month"="Exact_Month")

temp <- DANU_Measures %>% inner_join(temp)
temp <- temp %>% mutate(Elapsed=Month-FirstGLP1)


temp %>% filter(Month>=FirstGLP1) %>% group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% 
  select(patient, value, Semaexp) %>% rename("MAX"="value") %>%
  left_join(
temp %>% filter(Month>=FirstGLP1) %>% group_by(patient) %>% filter(value==min(value)) %>% slice(1) %>% 
  select(patient, value, Semaexp) %>% rename("MIN"="value")) %>%
  mutate(DIFF=MIN-MAX) %>% ungroup() %>% group_by(Semaexp) %>% summarise(n=mean(DIFF))
 

temp %>%
  mutate(Semaexp=ifelse(Semaexp=="None", "Other", "Semaglutide Inj")) %>%
  filter(Elapsed>=(-24) & Elapsed<24) %>%
  ggplot(aes(Elapsed, value, colour=Semaexp, fill=Semaexp)) +
  geom_smooth(size=1, apha=0.8) +
  xlab(" \n No. lapsed months relative to GLP/Sema Initiation") + 
  ylab("BMI Level \n") +
  theme_minimal() +
  ggsci::scale_colour_npg() +
  ggsci::scale_fill_npg() 

# ------------------------------------
# Persistency ON Rybelsus vs other classes - new starts last 12 months -----------------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")


DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease) %>% select(patient, weight, Month, Treat) %>% distinct()

GLP1_Oral_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_OralGLP1, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>% filter(Month>=49) %>% select(patient)

SGLT2_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_SGLT2, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>% filter(Month>=49) %>% select(patient)

GLP1_Inj_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_InjectableGLP1, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>% filter(Month>=49) %>% select(patient)


Insulin_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_Insulin, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>% filter(Month>=49) %>% select(patient)



DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, Month)


GLP1_Oral_Pasts<-  GLP1_Oral_Pasts %>% left_join(DIA_Drug_Histories) %>%
   mutate(Treat=ifelse(grepl(string_OralGLP1,Treat), 1,0)) %>%
   group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

GLP1_Oral_Pasts <- GLP1_Oral_Pasts %>% filter(Treat == 1) %>% filter(grp==min(grp))
GLP1_Oral_Pasts %>% group_by(patient, weight) %>% count() %>% ungroup() %>% summarise(Persis=weighted.mean(n, weight)) # 3.53
GLP1_Oral_Pasts %>% group_by(patient, weight) %>% count() %>% ungroup()  %>% group_by(n) %>% summarise(n2=sum(weight))


SGLT2_Pasts<-  SGLT2_Pasts %>% left_join(DIA_Drug_Histories) %>%
   mutate(Treat=ifelse(grepl(string_SGLT2,Treat), 1,0)) %>%
   group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

SGLT2_Pasts  <- SGLT2_Pasts %>% filter(Treat == 1) %>% filter(grp==min(grp))
SGLT2_Pasts %>% group_by(patient, weight) %>% count() %>% ungroup() %>% summarise(Persis=weighted.mean(n, weight)) # 4.33
SGLT2_Pasts %>% group_by(patient, weight) %>% count() %>% ungroup()  %>% group_by(n) %>% summarise(n2=sum(weight))



GLP1_Inj_Pasts<-  GLP1_Inj_Pasts %>% left_join(DIA_Drug_Histories) %>%
   mutate(Treat=ifelse(grepl(string_InjectableGLP1,Treat), 1,0)) %>%
   group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

GLP1_Inj_Pasts  <- GLP1_Inj_Pasts %>% filter(Treat == 1) %>% filter(grp==min(grp))
GLP1_Inj_Pasts %>% group_by(patient, weight) %>% count() %>% ungroup() %>% summarise(Persis=weighted.mean(n, weight)) # 4.19
GLP1_Inj_Pasts %>% group_by(patient, weight) %>% count() %>% ungroup()  %>% group_by(n) %>% summarise(n2=sum(weight))



GLP1_Inj_Pasts<-  GLP1_Inj_Pasts %>% left_join(DIA_Drug_Histories) %>%
   mutate(Treat=ifelse(grepl(string_InjectableGLP1,Treat), 1,0)) %>%
   group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

GLP1_Inj_Pasts  <- GLP1_Inj_Pasts %>% filter(Treat == 1) %>% filter(grp==min(grp))
GLP1_Inj_Pasts %>% group_by(patient, weight) %>% count() %>% ungroup() %>% summarise(Persis=weighted.mean(n, weight)) # 4.19




Insulin_Pasts<-  Insulin_Pasts %>% left_join(DIA_Drug_Histories) %>%
   mutate(Treat=ifelse(grepl(string_Insulin,Treat), 1,0)) %>%
   group_by(patient) %>% mutate(grp = rle(Treat)$lengths %>% {rep(seq(length(.)), .)})

Insulin_Pasts  <- Insulin_Pasts %>% filter(Treat == 1) %>% filter(grp==min(grp))
Insulin_Pasts %>% group_by(patient, weight) %>% count() %>% ungroup() %>% summarise(Persis=weighted.mean(n, weight)) # 3.18
Insulin_Pasts %>% group_by(patient, weight) %>% count() %>% ungroup()  %>% group_by(n) %>% summarise(n2=sum(weight))



# ------------------
# Hba1c reductions Orals vs others ----------------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")


DIA_Drug_Histories <- fread("DIA Drug Histories.txt")
DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Treat, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)
DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(Month = as.numeric(Month))
DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(Treat!="-")
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease) %>% select(patient, weight, Month, Treat) %>% distinct()

GLP1_Oral_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_OralGLP1, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>% select(patient, Month)

SGLT2_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_SGLT2, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>%  select(patient, Month)

GLP1_Inj_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_InjectableGLP1, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>% select(patient, Month)

Insulin_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_Insulin, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>%  select(patient, Month)

Biguanide_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_Biguanide, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>%  select(patient, Month)

Antidiabetic_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_Antidiabetic, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>%  select(patient, Month)

DPP4_Pasts <- DIA_Drug_Histories %>% filter(grepl(string_DPP4, Treat)) %>% 
                   group_by(patient) %>% filter(Month==min(Month)) %>%  select(patient, Month)



Months_lookup <- fread("Months_lookup.txt",  integer64 = "character", stringsAsFactors = F)
Months_lookup$Month <- paste0(Months_lookup$Month,"-1")
Months_lookup$Month <- format(as.Date(Months_lookup$Month), "%Y-%m")

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <- DANU_Measures %>% filter(test=="HbA1c Level") %>% select(patient, claimed, value) %>% distinct()
DANU_Measures <- DANU_Measures %>% mutate(claimed=format(as.Date(claimed), "%Y-%m")) 
DANU_Measures <- DANU_Measures %>% left_join(Months_lookup, by=c("claimed"="Month"))
DANU_Measures <- DANU_Measures %>% select(-claimed)
DANU_Measures <- DANU_Measures %>% drop_na() %>% rename("Month"="Exact_Month")

DANU_Measures <- DANU_Measures %>% rename("Read"="Month")

temp <- GLP1_Oral_Pasts %>% mutate(Group="GLP1_Oral") %>%
  bind_rows(GLP1_Inj_Pasts %>% mutate(Group="GLP1_Injectable") ) %>%
    bind_rows(Biguanide_Pasts %>% mutate(Group="Biguanide") ) %>%
    bind_rows(SGLT2_Pasts %>% mutate(Group="SGLT2") ) %>%
      bind_rows(Insulin_Pasts %>% mutate(Group="Insulin") ) %>%
      bind_rows(Antidiabetic_Pasts %>% mutate(Group="Antidiabetic") ) %>%
      bind_rows(DPP4_Pasts %>% mutate(Group="DPP4") ) %>% ungroup() %>%
  inner_join(DANU_Measures) %>% mutate(Elapsed=Read-Month) 


temp %>%  filter(Elapsed>=(-12) & Elapsed < 12) %>%
  group_by(patient, Group) %>%
  filter(Elapsed<0 & value==max(value)) %>% slice(1) %>% rename("MAX"="value") %>% select(patient, Group, MAX) %>%
  left_join(temp %>%  filter(Elapsed>=(-12) & Elapsed < 12) %>%
  group_by(patient, Group) %>%
  filter(Elapsed>0 & value==min(value)) %>% slice(1) %>% rename("MIN"="value") %>% select(patient, Group, MIN) ) %>%
  drop_na() %>%
  mutate(Diff=MIN-MAX) %>%
  ungroup() %>% group_by(Group) %>% summarise(n=mean(Diff)) %>%
  arrange(-n)
  

    
temp %>% filter(Elapsed>=(-12) & Elapsed < 12) %>%
  ggplot(aes(Elapsed, value, colour=Group, fill=Group)) +
  geom_smooth(se=F, size=2, alpha=0.6) +
  ggsci::scale_color_d3() +
  ggsci::scale_fill_d3() +
  theme_minimal()

# -----------------------
# NEW DIA Architecture --------------------------------------------

DIA_Flows_Aux._Long <- fread("DIA_Flows_Aux._Long.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

DIA_Flows_Aux._Long <- Treatment_exp_Vector %>% inner_join(DIA_Flows_Aux._Long)
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(disease,s1,s2))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% select(-c(starts,stops,re_starts, p1_RxExp))


DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% arrange(patient, p1)
data.frame(DIA_Flows_Aux._Long)


DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(d1=ifelse(d1=="-" & lag(d1)=="-" & lag(lag(d1))!="-",lag(lag(d1)),d1 ))
DIA_Flows_Aux._Long[is.na(DIA_Flows_Aux._Long)] <- "-"
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(d2=ifelse(d2=="-" & lag(d2)=="-" & lag(lag(d2))!="-",lag(lag(d2)),d2 ))
DIA_Flows_Aux._Long[is.na(DIA_Flows_Aux._Long)] <- "-"



DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(d1=ifelse(d1=="-" & lag(d1)!="-",lag(d1),d1 ))
DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient) %>% mutate(d2=ifelse(d2=="-" & lag(d2)!="-",lag(d2),d2 ))
DIA_Flows_Aux._Long[is.na(DIA_Flows_Aux._Long)] <- "-"



DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% mutate(flow=ifelse(flow==1 & (d1 == d2), 0, flow)) %>% mutate(flow=ifelse(flow==0 & (d1!=d2), 1, flow))


DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients       <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

string_Biguanide    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Biguanide"], collapse = "|"),")\\b")
string_Antidiabetic    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Antidiabetic"], collapse = "|"),")\\b")
string_DPP4    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "DPP4"], collapse = "|"),")\\b")
string_SGLT2    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "SGLT2"], collapse = "|"),")\\b")
string_Insulin    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "Insulin"], collapse = "|"),")\\b")
string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")
string_InjectableGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")


DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>%
  mutate(s1=ifelse(grepl(string_InjectableGLP1, d1), "GLP1_Inj",
                   ifelse(grepl(string_OralGLP1, d1), "GLP1_Oral",
                   ifelse(grepl("-", d1), "Lapsed", "Other")))) %>%
  mutate(s2=ifelse(grepl(string_InjectableGLP1, d2), "GLP1_Inj",
                   ifelse(grepl(string_OralGLP1, d2), "GLP1_Oral",
                   ifelse(grepl("-", d2), "Lapsed", "Other"))))

DIA_Flows_Aux._Long <- DIA_Flows_Aux._Long %>% group_by(patient, weight) %>% 
  mutate(s2_GLP1_exp=ifelse(cumsum(s2=="GLP1_Inj")>0|cumsum(s2=="GLP1_Oral")>0,1,0)) %>%  
  mutate(s1_GLP1_exp=ifelse(cumsum(s1=="GLP1_Inj")>0|cumsum(s1=="GLP1_Oral")>0,1,0))

DIA_Flows_Aux._Long %>% filter(p2==60) %>%
  group_by(s2, s2_GLP1_exp) %>% summarise(n=sum(weight))









DIA_Flows_Aux._Long %>% filter(p2>=49 & flow==1) %>%
  mutate(s1=paste(s1, s1_GLP1_exp, sep="_")) %>%
  mutate(s2=paste(s2, s2_GLP1_exp, sep="_")) %>%
  group_by(s1, s2) %>% summarise(n=sum(weight)) %>%
  ungroup() %>% spread(key=s2, value=n)

# ---------------------------------------------


# NEW definition lines of therapy ------------------------------------

DANU_Ingredients <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients <- DANU_Ingredients %>% select(molecule, drug_group) 

DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease) %>%
  gather(Month, Drugs, month1:month60) %>% filter(Drugs != "-")

DIA_Drug_Histories <- Treatment_exp_Vector %>% inner_join(DIA_Drug_Histories)
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, Drugs, sep = ",", convert=T)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  left_join(DANU_Ingredients %>% mutate(molecule=as.numeric(molecule)), by=c("Drugs"="molecule"))
                                                       
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Drugs) %>% distinct()

unique(DIA_Drug_Histories$drug_group)

DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(drug_group=ifelse(drug_group=="Insulin", "I",
                                                ifelse(drug_group=="Biguanide", "b",
                                                       ifelse(drug_group=="SGLT2", "S",
                                                              ifelse(drug_group=="Antidiabetic", "d",
                                                                     ifelse(drug_group=="DPP4", "D",
                                                                            ifelse(drug_group=="GLP1 Injectable", "G", "g")))))))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, weight, Month, drug_group) %>%
  group_by(patient, weight, Month) %>% mutate(drug_group=paste(drug_group, collapse=",")) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% ungroup() 
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight))

DIA_Drug_Histories %>% group_by(patient) %>% filter(Month==min(Month)) %>%
  ungroup() %>% separate_rows(drug_group, sep = ",", convert=T) %>%
  group_by(drug_group) %>% summarise(n=sum(weight)/30625690) %>%
  arrange(-n)


DIA_Drug_Histories %>%
  anti_join(DIA_Drug_Histories %>% group_by(patient) %>% filter(Month==min(Month)) %>% select(patient, drug_group) %>% ungroup()) %>%
  group_by(patient) %>% filter(Month==min(Month)) %>%
  ungroup() %>% separate_rows(drug_group, sep = ",", convert=T) %>%
  group_by(drug_group) %>% summarise(n=sum(weight)/30625690) %>%
  arrange(-n)

temp <- DIA_Drug_Histories

temp <- temp %>% select(patient, weight, drug_group) %>% distinct() %>%
   group_by(patient, weight) %>% mutate(grp = rle(drug_group)$lengths %>% {rep(seq(length(.)), .)})

temp %>% ungroup() %>% filter(grp==1) %>%
  separate_rows(drug_group, sep = ",", convert=T) %>%
  group_by(drug_group) %>% summarise(n=sum(weight)/30625690) %>%
  arrange(-n)


temp %>% ungroup() %>% filter(grp==2) %>%
  separate_rows(drug_group, sep = ",", convert=T) %>%
  group_by(drug_group) %>% summarise(n=sum(weight)/30625690) %>%
  arrange(-n)


temp %>% ungroup() %>% filter(grp==3) %>%
  separate_rows(drug_group, sep = ",", convert=T) %>%
  group_by(drug_group) %>% summarise(n=sum(weight)/30625690) %>%
  arrange(-n)



temp %>% ungroup() %>% 
  separate_rows(drug_group, sep = ",", convert=T) %>%
  group_by(grp, drug_group) %>% summarise(n=sum(weight)) %>%
  left_join(temp %>% ungroup() %>%  group_by(grp) %>% summarise(Total=sum(weight))) %>%
  mutate(Perc=100*n/Total) %>% select(-c(n, Total)) %>%
  spread(key=grp, value=Perc)



data.frame(temp %>% group_by(patient) %>% filter(grp==max(grp)) %>% ungroup() %>%  group_by(grp) %>% summarise(Total=sum(weight)/30625690))



DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% select(patid, weight, diabetes_onset) %>% filter(diabetes_onset>="2016-05-01" & diabetes_onset<="2017-04-30")




InsulinStart_PlusOther <- temp %>% ungroup() %>% filter(grp==1) %>% filter(grepl("I", drug_group)) %>%
  select(patient, weight) %>% distinct() %>% # summarise(n=sum(weight))  # 7919110
  left_join(temp) %>% ungroup() %>%
  filter(grepl("b", drug_group)|grepl("d", drug_group)|grepl("D", drug_group)|grepl("S", drug_group)|grepl("g", drug_group)|grepl("G", drug_group)) %>%
  select(patient, weight) %>% distinct() # %>%  summarise(n=sum(weight)) # 4037908 had something else also


InsulinStart_Only <- temp %>% ungroup() %>% filter(grp==1) %>% filter(grepl("I", drug_group)) %>%
  select(patient, weight) %>% distinct() %>% anti_join(InsulinStart_PlusOther)


temp2 <- data.frame(temp %>% ungroup() %>% anti_join(InsulinStart_Only) %>%
  inner_join(DANU_Demographics %>% select(patid), by=c("patient"="patid")) %>%
  filter(grp==1) %>%
  group_by(drug_group) %>% summarise(n=sum(weight)) %>% arrange(-n))

temp2 <- data.frame(lapply(temp2, function(x) {gsub("g", "go", x)}))
temp2 <- data.frame(lapply(temp2, function(x) {gsub("d", "a", x)}))




temp %>% group_by(grp) %>% summarise(n=sum(weight))
temp %>%  group_by(patient) %>% filter(grp==max(grp)) %>%  mutate(grp=ifelse(grp>=5,5,grp)) %>% group_by(grp) %>% summarise(n=sum(weight))


temp %>% anti_join(InsulinStart_Only) %>% ungroup() %>% inner_join(DANU_Demographics %>% select(patid), by=c("patient"="patid")) %>%
  group_by(patient) %>% filter(grp==max(grp)) %>%
  mutate(grp=ifelse(grp>=5,5,grp)) %>%
  group_by(grp) %>% summarise(Total=sum(weight)) %>%
  left_join(
    temp %>% ungroup() %>% anti_join(InsulinStart_Only) %>% inner_join(DANU_Demographics %>% select(patid), by=c("patient"="patid")) %>%
      group_by(patient) %>% filter(grp==max(grp)) %>%
      separate_rows(drug_group, sep = ",", convert=T) %>%   mutate(grp=ifelse(grp>=5,5,grp)) %>% group_by(grp, drug_group) %>% summarise(n=sum(weight))
  ) %>%
    mutate(Perc=100*n/Total) %>% select(-c(n, Total)) %>%
  spread(key=drug_group, value=Perc)



temp %>% anti_join(InsulinStart_Only) %>% ungroup() %>% inner_join(DANU_Demographics %>% select(patid), by=c("patient"="patid"))  %>%
  mutate(grp=ifelse(grp>=5,5,grp)) %>% 
  separate_rows(drug_group, sep = ",", convert=T) %>%
  group_by(drug_group  , grp) %>% 
  summarise(Total=sum(weight)) %>%
  spread(key=grp, value=Total)




temp %>% ungroup() %>% 
  anti_join(InsulinStart_Only) %>%
  inner_join(DANU_Demographics %>% select(patid), by=c("patient"="patid")) %>%
  #select(patient, weight) %>% distinct() %>% summarise(n=sum(weight))
  separate_rows(drug_group, sep = ",", convert=T) %>%
  group_by(grp, drug_group) %>% summarise(n=sum(weight)) %>%
  left_join(
    temp %>% ungroup() %>% inner_join(DANU_Demographics %>% select(patid), by=c("patient"="patid")) %>% group_by(grp) %>% summarise(Total=sum(weight))) %>%
  mutate(Perc=100*n/Total) %>% select(-c(n, Total)) %>%
  mutate(Perc=ifelse(is.na(Perc), 0, Perc)) %>%
  mutate(drug_group=ifelse(drug_group=="I", "Insulin",
                                                ifelse(drug_group=="b", "Biguanide",
                                                       ifelse(drug_group=="S", "SGLT2",
                                                              ifelse(drug_group=="d", "Antidiabetic",
                                                                     ifelse(drug_group=="D", "DPP4",
                                                                            ifelse(drug_group=="G", "GLP1 Injectable", "GLP1 Oral"))))))) %>%
  mutate(drug_group=factor(drug_group, levels=c("Biguanide", "Antidiabetic", "DPP4", "SGLT2", "Insulin", "GLP1 Oral", "GLP1 Injectable"))) %>%
  filter(drug_group!="Insulin") %>%
  ggplot(aes(grp, Perc, colour=drug_group, fill=drug_group)) +
  geom_smooth(size=2,alpha=0.9, se=F) +
  theme_minimal() +
  xlim(1,5) +
  ylim(0,75) +
  xlab("\n No. Therapy Lines Tried") + ylab("Class Penetrance (%) \n") +
  scale_colour_manual(values=c("#f2eded","#7d95be","#0d2b4e","#daa520", "#f6546a","#a52a2a")) 

  

# ------------------------------------------------
# SGLT2 only vs GLP1 only % with HF or CKD --------------------------------------------------------

DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% filter(grepl("Diabetes", diagnosis)) %>% select(patid, weight)
names(DANU_Demographics)[1] <- "patient"

temp <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
temp <- temp %>% filter(p2==60) %>% inner_join(DANU_Demographics)

DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% filter(grepl("I5", diagnosis)|grepl("N18", diagnosis)) 


DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% mutate(group=ifelse(grepl("I5", diagnosis), "HF", 
                                                    ifelse(grepl("N18", diagnosis), "CKD", NA))) %>%
  select(patid, weight, group) %>% distinct()


temp %>% filter(p1_SGLT2Exp==1) %>% select(patient, weight) %>% summarise(n=sum(weight)) # 4742756

temp %>% filter(p1_SGLT2Exp==1&
                  p1_OralExp==0 & p1_InjExp==0 & p1_InsulinExp==0 & 
                  p1_DPP4Exp==0 & p1_AntiDiabeticExp==0 & p1_BiguanideExp==0) %>%
  select(patient, weight) %>% summarise(n=sum(weight)) # 105725       2%

temp %>% filter(p1_SGLT2Exp==1&
                  p1_OralExp==0 & p1_InjExp==0 & p1_InsulinExp==0 & 
                  p1_DPP4Exp==0 & p1_AntiDiabeticExp==0 & p1_BiguanideExp==0) %>%
  select(patient, weight) %>%  inner_join(DIA_Comorbidity_Inventories %>% filter(group=="CKD"), by=c("patient"="patid", "weight"="weight")) %>% 
  summarise(n=sum(as.numeric(weight))) # 20334.77  0.1923364 no dfif than the overall DIA

temp %>% filter(p1_SGLT2Exp==1&
                  p1_OralExp==0 & p1_InjExp==0 & p1_InsulinExp==0 & 
                  p1_DPP4Exp==0 & p1_AntiDiabeticExp==0 & p1_BiguanideExp==0) %>%
  select(patient, weight) %>%  inner_join(DIA_Comorbidity_Inventories %>% filter(group=="HF"), by=c("patient"="patid", "weight"="weight")) %>% 
  summarise(n=sum(as.numeric(weight))) # 33670.21  0.3184697 nmaybe higher than overall DIA







temp %>% filter(p1_InjExp==1) %>% select(patient, weight) %>% summarise(n=sum(weight)) # 5363623

temp %>% filter(p1_SGLT2Exp==0&
                  p1_OralExp==0 & p1_InjExp==1 & p1_InsulinExp==0 & 
                  p1_DPP4Exp==0 & p1_AntiDiabeticExp==0 & p1_BiguanideExp==0) %>%
  select(patient, weight) %>% summarise(n=sum(weight)) # 225940.5    4%   

temp %>% filter(p1_SGLT2Exp==0&
                  p1_OralExp==0 & p1_InjExp==1 & p1_InsulinExp==0 & 
                  p1_DPP4Exp==0 & p1_AntiDiabeticExp==0 & p1_BiguanideExp==0) %>%
  select(patient, weight) %>%  inner_join(DIA_Comorbidity_Inventories %>% filter(group=="CKD"), by=c("patient"="patid", "weight"="weight")) %>% 
  summarise(n=sum(as.numeric(weight))) # 28704.04  0.1270425 no dfif than the overall DIA

temp %>% filter(p1_SGLT2Exp==0&
                  p1_OralExp==0 & p1_InjExp==1 & p1_InsulinExp==0 & 
                  p1_DPP4Exp==0 & p1_AntiDiabeticExp==0 & p1_BiguanideExp==0) %>%
  select(patient, weight) %>%  inner_join(DIA_Comorbidity_Inventories %>% filter(group=="HF"), by=c("patient"="patid", "weight"="weight")) %>% 
  summarise(n=sum(as.numeric(weight))) # 39285.56  0.1738757 nmaybe higher than overall DIA



# -----------------------------------------------------
# WHo starts directly ON SGLT2 or GLP1 ? --------------------------------------------
DANU_Ingredients <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients <- DANU_Ingredients %>% select(molecule, drug_group) 

DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease) %>%
  gather(Month, Drugs, month1:month60) %>% filter(Drugs != "-")

DIA_Drug_Histories <- Treatment_exp_Vector %>% inner_join(DIA_Drug_Histories)
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, Drugs, sep = ",", convert=T)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  left_join(DANU_Ingredients %>% mutate(molecule=as.numeric(molecule)), by=c("Drugs"="molecule"))
                                                       
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Drugs) %>% distinct()

unique(DIA_Drug_Histories$drug_group)

DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(drug_group=ifelse(drug_group=="Insulin", "I",
                                                ifelse(drug_group=="Biguanide", "b",
                                                       ifelse(drug_group=="SGLT2", "S",
                                                              ifelse(drug_group=="Antidiabetic", "d",
                                                                     ifelse(drug_group=="DPP4", "D",
                                                                            ifelse(drug_group=="GLP1 Injectable", "G", "g")))))))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, weight, Month, drug_group) %>%
  group_by(patient, weight, Month) %>% mutate(drug_group=paste(drug_group, collapse=",")) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% ungroup() 
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight))

temp <- DIA_Drug_Histories

temp <- temp %>% select(patient, weight, drug_group) %>% distinct() %>%
   group_by(patient, weight) %>% mutate(grp = rle(drug_group)$lengths %>% {rep(seq(length(.)), .)})

DANU_Demographics <- fread("DANU Demographics.txt")
DANU_Demographics <- DANU_Demographics %>% select(patid, weight, diabetes_onset) %>% filter(diabetes_onset>="2016-05-01" & diabetes_onset<="2017-04-30") %>% select(patid)

temp <- temp %>% inner_join(DANU_Demographics %>% select(patid), by=c("patient"="patid")) 

Early_SGLT2 <- temp %>% group_by(patient) %>% filter(grp==min(grp))  %>%
  filter(grepl("S", drug_group)) %>% select(patient) %>% distinct()

Not_Early <- temp %>% group_by(patient) %>% filter(grp==min(grp))  %>%
  filter(!grepl("S", drug_group)) %>% select(patient) %>% distinct()

DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
names(DIA_Comorbidity_Inventories)[1]  <- "patient"

DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% select(-weight) %>% inner_join(Early_SGLT2 %>% bind_rows(Not_Early))

#DIA_Comorbidity_Inventories <-DIA_Comorbidity_Inventories %>% filter(grepl("I", diagnosis)|grepl("N", diagnosis))


to_fit <- Early_SGLT2 %>% mutate(group=1) %>% bind_rows(Not_Early %>% mutate(group=0)) %>%
  left_join(DIA_Comorbidity_Inventories) %>%
  mutate(Exp=1) %>%
  spread(key=diagnosis, value=Exp) 

to_fit[is.na(to_fit)] <- 0

to_fit$group <- as.factor(to_fit$group)

DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <-DANU_Measures %>% select(patient, test, value)

MAX_HbA1c <- DANU_Measures %>% filter(test=="HbA1c Level") %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
names(MAX_HbA1c)[3] <- "MAX_HbA1c"
MAX_HbA1c <- MAX_HbA1c[,c(1,3)]

MAX_BMI <- DANU_Measures %>% filter(test=="BMI") %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
names(MAX_BMI)[3] <- "MAX_BMI"
MAX_BMI <- MAX_BMI[,c(1,3)]

to_fit <- to_fit %>% inner_join(MAX_HbA1c) %>% inner_join(MAX_BMI)

to_fit <- to_fit[,-1]

library(ISLR2)
library(leaps)
library(glmnet)
library(bestglm)


x <- model.matrix(group ~ ., to_fit)[, -1]
y <- to_fit$group



cv.lasso <- cv.glmnet(x, y, alpha = 1, family = "binomial", type.measure ="auc")
plot(cv.lasso)
cv.lasso$cvm
cv.lasso$lambda
model <- glmnet(x, y, alpha = 1, family = "binomial", lambda = cv.lasso$lambda.min, standardize =T)
coef(model)
model$beta
plot(model)


to_fit %>% group_by(group) %>% summarise(n=mean(MAX_BMI))
to_fit %>% group_by(group) %>% count()


# Females, BMI

# ---------------------------------------------------------
# WHo starts in ORAL GLP1 vs INJ -> Oral --------------------------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease) %>% filter(Drugs!="-")

string_InjGLP1    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(grepl(string_InjGLP1, Drugs)|grepl(string_OralGLP1, Drugs))
To_remove <- DIA_Drug_Histories %>% filter(Month<=37) %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% anti_join(To_remove)

FirstOral <- DIA_Drug_Histories %>% filter(grepl(string_OralGLP1, Drugs)) %>% group_by(patient) %>%
  filter(Month==min(Month)) %>% select(patient, Month) %>% rename("FirstOral"="Month")

FirstInjGLP <- DIA_Drug_Histories %>% filter(grepl(string_InjGLP1, Drugs)) %>%
                                            group_by(patient) %>%
  filter(Month==min(Month)) %>% select(patient, Month) %>% rename("FirstInj"="Month")

GLPs <- FirstOral %>% left_join(FirstInjGLP) %>% ungroup()


GLPs <- GLPs %>% mutate(First=ifelse(FirstOral<FirstInj, "Oral", ifelse(FirstOral>FirstInj, "Inj", 
                                                                           ifelse(FirstOral==FirstInj, "Both", 
                                                                                  ifelse(is.na(FirstInj), "Oralonly", NA)))))

GLPs %>% group_by(First) %>% count()


temp <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
names(temp)

GLPs <- GLPs %>% left_join(temp %>% select(patient, cumflow, Lines, p2), by=c("patient"="patient", "FirstOral"="p2"))

to_fit <- GLPs %>% select(patient, First, cumflow, Lines) %>% drop_na() %>% filter(First!="Both")

to_fit


DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <-DANU_Measures %>% select(patient, test, value)
MAX_HbA1c <- DANU_Measures %>% filter(test=="HbA1c Level") %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
names(MAX_HbA1c)[3] <- "MAX_HbA1c"
MAX_HbA1c <- MAX_HbA1c[,c(1,3)]
MAX_BMI <- DANU_Measures %>% filter(test=="BMI") %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
names(MAX_BMI)[3] <- "MAX_BMI"
MAX_BMI <- MAX_BMI[,c(1,3)]

to_fit <- to_fit %>% inner_join(MAX_HbA1c) %>% inner_join(MAX_BMI)

to_fit %>% group_by(First) %>% summarise(n=mean(MAX_HbA1c))
to_fit %>% group_by(First) %>% summarise(n=mean(cumflow))
to_fit %>% group_by(First) %>% summarise(n=mean(Lines))

DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
names(DIA_Comorbidity_Inventories)[1]  <- "patient"

DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% select(-weight) %>%
  inner_join(to_fit %>% select(patient)) 

DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% filter(
                                         grepl("E", diagnosis)|
                                         grepl("F", diagnosis)|
                                         grepl("G", diagnosis)|
                                         grepl("I", diagnosis)|
                                         grepl("J", diagnosis)|
                                         grepl("K", diagnosis)|
                                         grepl("M", diagnosis)|
                                         grepl("N", diagnosis)|
                                         grepl("R", diagnosis))
  

to_fit <- to_fit %>% left_join(DIA_Comorbidity_Inventories) %>%
  mutate(Exp=1) %>%
  spread(key=diagnosis, value=Exp) 

to_fit[is.na(to_fit)] <- 0

to_fit$First <- as.factor(to_fit$First)

to_fit <- to_fit %>% select(-patient)


#model <- regsubsets(to_fit$First~. , data=to_fit, nvmax = 5, really.big=T)
names(to_fit)

OralGLP1Pats_rf <-randomForest::randomForest(First ~ . , data = to_fit)
summary(OralGLP1Pats_rf)
OralGLP1Pats_rf$importance
varImpPlot(OralGLP1Pats_rf)

# -----------------------------
# WHo starts in ORAL GLP1 with vs without INJ -----------------------------------

DANU_Ingredients       <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))

DIA_Drug_Histories     <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector   <-fread("Treatment_exp_Vector.txt")
DIA_Drug_Histories <- Treatment_exp_Vector %>% left_join(DIA_Drug_Histories)

DIA_Drug_Histories <- gather(DIA_Drug_Histories, Month, Drugs, month1:month60, factor_key=TRUE)
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease) %>% filter(Drugs!="-")

string_InjGLP1    <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Injectable"], collapse = "|"),")\\b")
string_OralGLP1 <- paste0("\\b(",paste0(DANU_Ingredients$molecule[DANU_Ingredients$drug_group == "GLP1 Oral"], collapse = "|"),")\\b")

DIA_Drug_Histories <- DIA_Drug_Histories %>% filter(grepl(string_InjGLP1, Drugs)|grepl(string_OralGLP1, Drugs))
To_remove <- DIA_Drug_Histories %>% filter(Month<=37) %>% select(patient) %>% distinct()
DIA_Drug_Histories <- DIA_Drug_Histories %>% anti_join(To_remove)

Pats_Oral <- DIA_Drug_Histories %>% filter(grepl(string_OralGLP1, Drugs)) %>% select(patient) %>%
  distinct() %>% mutate(Oral="Oral")

Pats_Inj <- DIA_Drug_Histories %>% filter(grepl(string_InjGLP1, Drugs)) %>% select(patient) %>%
  distinct() %>% mutate(Inj="Inj")

GLPs <- Pats_Oral %>% left_join(Pats_Inj) %>% ungroup()


GLPs <- GLPs %>% mutate(group=ifelse(Oral=="Oral"&Inj=="Inj", "Both", "Oral"))

GLPs %>% group_by(group) %>% count()
GLPs <- GLPs %>% mutate(group=ifelse(is.na(group), "Oral", group))



temp <- fread("Cum_Class_Experience_EveryMonth.txt", sep="\t")
names(temp)

GLPs <- GLPs %>% left_join(temp %>% filter(p2==60) %>% select(patient, cumflow, Lines))

to_fit <- GLPs %>% select(patient, group, cumflow, Lines) %>% drop_na()
to_fit


DANU_Measures <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
names(DANU_Measures)[1] <- "patient"
DANU_Measures <-DANU_Measures %>% select(patient, test, value)
MAX_HbA1c <- DANU_Measures %>% filter(test=="HbA1c Level") %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
names(MAX_HbA1c)[3] <- "MAX_HbA1c"
MAX_HbA1c <- MAX_HbA1c[,c(1,3)]
MAX_BMI <- DANU_Measures %>% filter(test=="BMI") %>%
  group_by(patient) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
names(MAX_BMI)[3] <- "MAX_BMI"
MAX_BMI <- MAX_BMI[,c(1,3)]

to_fit <- to_fit %>% inner_join(MAX_HbA1c) %>% inner_join(MAX_BMI)

to_fit %>% group_by(group) %>% summarise(n=mean(MAX_HbA1c))
to_fit %>% group_by(group) %>% summarise(n=mean(cumflow))
to_fit %>% group_by(group) %>% summarise(n=mean(Lines))
to_fit %>% group_by(group) %>% summarise(n=mean(MAX_BMI))


DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
names(DIA_Comorbidity_Inventories)[1]  <- "patient"

DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% select(-weight) %>%
  inner_join(to_fit %>% select(patient)) 

DIA_Comorbidity_Inventories <- DIA_Comorbidity_Inventories %>% filter(
                                         grepl("E", diagnosis)|
                                         grepl("F", diagnosis)|
                                         grepl("G", diagnosis)|
                                         grepl("I", diagnosis)|
                                         grepl("J", diagnosis)|
                                         grepl("K", diagnosis)|
                                         grepl("M", diagnosis)|
                                         grepl("N", diagnosis)|
                                         grepl("R", diagnosis))
  

to_fit <- to_fit %>% left_join(DIA_Comorbidity_Inventories) %>%
  mutate(Exp=1) %>%
  spread(key=diagnosis, value=Exp) 

to_fit[is.na(to_fit)] <- 0

to_fit$group <- as.factor(to_fit$group)

to_fit <- to_fit %>% select(-patient)


#model <- regsubsets(to_fit$First~. , data=to_fit, nvmax = 5, really.big=T)
names(to_fit)
to_fit <- to_fit[,-412]

to_fit %>% group_by(group, E78) %>% count()
 
OralGLP1Pats_rf <-randomForest::randomForest(group ~ . , data = to_fit)
summary(OralGLP1Pats_rf)
OralGLP1Pats_rf$importance
varImpPlot(OralGLP1Pats_rf)


# -----------------------------------------
# Nancy's excel vs - remove HbA1c <5.7 and BMI27-30 not comorb -----------------------
DANU_Demographics <- fread("DANU Demographics.txt")
unique(DANU_Demographics$diagnosis)
DANU_Demographics <- DANU_Demographics %>% filter(diagnosis!="-")
DANU_Demographics %>% group_by(diagnosis) %>% summarise(n=sum(weight))

# 1 Diabetes             7949715.
# 2 Diabetes + Obesity  40282960.
# 3 Obesity            106469049.

DANU_Demographics <- DANU_Demographics %>% 
  mutate(diagnosis=ifelse(diagnosis!="Obesity", "Diabetes", diagnosis))  %>%
  select(patid, weight, diagnosis)


DANU_Measures_HbA1c <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
unique(DANU_Measures_HbA1c$test)
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% filter(test=="HbA1c Level")
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% select(patid, claimed, value) %>% distinct()
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% group_by(patid) %>% filter(claimed==max(claimed))  %>% filter(value==max(value))
DANU_Measures_HbA1c <- DANU_Measures_HbA1c %>% distinct() %>% ungroup() %>% select(-claimed)

DANU_Demographics <- DANU_Measures_HbA1c %>% inner_join(DANU_Demographics) %>%
  mutate(diagnosis=ifelse(diagnosis=="Diabetes"&value<5.7,NA, diagnosis)) %>%
  drop_na()

names(DANU_Demographics)[2] <- "HbA1c"

DANU_Measures_BMI <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
unique(DANU_Measures_BMI$test)
DANU_Measures_BMI <- DANU_Measures_BMI %>% filter(test=="BMI")
DANU_Measures_BMI <- DANU_Measures_BMI %>% select(patid, claimed, value) %>% distinct()
DANU_Measures_BMI <- DANU_Measures_BMI %>% group_by(patid) %>% filter(claimed==max(claimed))  %>% filter(value==max(value))
DANU_Measures_BMI <- DANU_Measures_BMI %>% distinct() %>% ungroup() %>% select(-claimed)

DANU_Demographics <- DANU_Measures_BMI %>% inner_join(DANU_Demographics) %>%
  mutate(diagnosis=ifelse(diagnosis=="Obesity"&value<27,NA, diagnosis)) %>%
  drop_na()

names(DANU_Demographics)[2] <- "BMI"






OBE_Comorbidity_Inventories <- fread("OBE Comorbidity Inventories.txt")
DIA_Comorbidity_Inventories <- fread("DIA Comorbidity Inventories.txt")
Comorbidity_Inventories <- OBE_Comorbidity_Inventories %>% full_join(DIA_Comorbidity_Inventories) %>% distinct()

names(Comorbidity_Inventories)[3] <- "ICD"

Comorbidity_Inventories <- DANU_Demographics %>% inner_join(Comorbidity_Inventories)

DANU_Demographics %>% group_by(diagnosis) %>% summarise(n=sum(weight)) 

# 1 Diabetes  12873617.
# 2 Obesity   14488538.

# CKD
CKD <- Comorbidity_Inventories %>% filter(grepl("N18", ICD)) %>% select(patid, weight, diagnosis) %>% distinct() 

# CVD
CVD <- Comorbidity_Inventories %>% filter(grepl("I20", ICD)|
                                   grepl("I21", ICD)|
                                   grepl("I22", ICD)|
                                   grepl("I23", ICD)|
                                   grepl("I24", ICD)|
                                   grepl("I25", ICD)|
                                   grepl("I4", ICD)|
                                   grepl("I6", ICD)|
                                   grepl("G45", ICD))  %>% select(patid, weight, diagnosis) %>% distinct()


# HF
HF <- Comorbidity_Inventories %>% filter(grepl("I5", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() 


# Ischemic heart Disease
IHD <- Comorbidity_Inventories %>% filter(grepl("I20", ICD)|
                                   grepl("I21", ICD)|
                                   grepl("I22", ICD)|
                                   grepl("I23", ICD)|
                                   grepl("I24", ICD)|
                                   grepl("I25", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() 

# OA
OA <- Comorbidity_Inventories %>% filter(grepl("M15", ICD)|
                                   grepl("M16", ICD)|
                                   grepl("M17", ICD)|
                                   grepl("M18", ICD)|
                                   grepl("M19", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() 


# SA


SA <- Comorbidity_Inventories %>% filter(grepl("G47", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() 

# Dyslipidemia
Dyslipidemia <- Comorbidity_Inventories %>% filter(grepl("E78", ICD))  %>% select(patid, weight, diagnosis) %>% distinct()

# HTN
HTN <- Comorbidity_Inventories %>% filter(grepl("I10", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() 


# Pred-Diabetes
Pred <- Comorbidity_Inventories %>% filter(grepl("R73", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() 

# POS
POS <- Comorbidity_Inventories %>% filter(grepl("E28", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() 

# PAD
PAD <- Comorbidity_Inventories %>% filter(grepl("I70", ICD)|grepl("I73", ICD))  %>% select(patid, weight, diagnosis) %>% distinct() 

Comorbid <- PAD %>% full_join(POS) %>% full_join(Pred) %>% full_join(HTN) %>% full_join(Dyslipidemia) %>%
  full_join(SA) %>% full_join(OA) %>% full_join(CVD) %>% full_join(IHD) %>% full_join(HF) %>%
  full_join(CKD) %>% select(patid, weight, diagnosis) %>% distinct()

Comorbid$Comorbid <- "Comorbid"

DANU_Demographics <- DANU_Demographics %>% left_join(Comorbid) %>% 
  mutate(diagnosis=ifelse(diagnosis=="Obesity"&BMI<30&is.na(Comorbid), NA, diagnosis)) %>%
  select(-Comorbid) %>%
  drop_na()

DANU_Demographics %>%   group_by(diagnosis) %>% summarise(n=sum(weight))


DANU_Demographics %>% mutate(HbA1c=ifelse(HbA1c<5.7, "<5.7",
                                            ifelse(HbA1c<=6.4, "<6.4",
                                                   ifelse(HbA1c<=6.9, "<6.9",
                                                          ifelse(HbA1c<=7.9, "<7.9",
                                                                 ifelse(HbA1c<=8.9, "<8.9", ">9")))))) %>%
  group_by(diagnosis, HbA1c) %>% summarise(n=sum(weight)) %>%
  mutate(n=ifelse(diagnosis=="Diabetes", n/12873617, n/13618738))


DANU_Demographics %>% mutate(BMI=ifelse(BMI<18.5, "<18.5",
                                            ifelse(BMI<=26.9, "<26.9",
                                                   ifelse(BMI<=29.9, "<29.9",
                                                          ifelse(BMI<=34.9, "<34.9",
                                                                 ifelse(BMI<=39.9, "<39.9", ">40")))))) %>%
  group_by(diagnosis, BMI) %>% summarise(n=sum(weight)) %>%
    mutate(n=ifelse(diagnosis=="Diabetes", n/12873617, n/13618738))

DANU_Demographics_Complete <- fread("DANU Demographics.txt")



DANU_Demographics %>% left_join(DANU_Demographics_Complete %>% select(patid, age)) %>%
  mutate(age=ifelse(age>=18&age<=34, "18-34",
                    ifelse(age>=35&age<=49, "35-49",
                           ifelse(age>=50&age<=64, "50-64",
                                  ifelse(age>=65, "65-80", NA))))) %>%
  group_by(diagnosis, age) %>% summarise(n=sum(weight)) %>%
  mutate(n=ifelse(diagnosis=="Obesity", n/13618738, n/(12873617)))


DANU_Demographics %>% left_join(DANU_Demographics_Complete %>% select(patid, gender)) %>%
  group_by(diagnosis, gender) %>% summarise(n=sum(weight)) %>%
  mutate(n=ifelse(diagnosis=="Obesity", n/13618738, n/(12873617)))


DANU_Demographics %>% left_join(DANU_Demographics_Complete %>% select(patid, race)) %>%
  group_by(diagnosis, race) %>% summarise(n=sum(weight)) %>%
  mutate(n=ifelse(diagnosis=="Obesity", n/13618738, n/(12873617)))


Comorbid <- PAD %>% full_join(POS) %>% full_join(Pred) %>% full_join(HTN) %>% full_join(Dyslipidemia) %>%
  full_join(SA) %>% full_join(OA) %>% full_join(CVD) %>% full_join(IHD) %>% full_join(HF) %>%
  full_join(CKD) %>% select(patid, weight, diagnosis) %>% distinct()

DANU_Demographics %>% inner_join(CVD) %>% group_by(diagnosis) %>% summarise(n=sum(weight)) %>%
  mutate(n=ifelse(diagnosis=="Obesity", n/13618738, n/(12873617)))

DANU_Demographics %>% anti_join(Comorbid) %>% group_by(diagnosis) %>% summarise(n=sum(weight)) %>%
  mutate(n=ifelse(diagnosis=="Obesity", n/13618738, n/(12873617)))




Dia_US_Doses <- fread("DIA Doses.txt", colClasses = "character")
Dia_US_Doses <- Dia_US_Doses %>% select(pat_id, specialty) %>% distinct()

OBE_US_Doses <- fread("OBE Doses.txt", colClasses = "character")
OBE_US_Doses <- OBE_US_Doses %>% select(pat_id, specialty) %>% distinct()

Doses <- Dia_US_Doses %>% full_join(OBE_US_Doses) %>% distinct()



Specialties_to_keep <- fread("Specialties_to_keep.txt",  colClasses = "character")
unique(Specialties_to_keep$PHYSICIAN)

Dia_US_Doses <- Dia_US_Doses %>% inner_join(DANU_Demographics, by=c("pat_id"="patid"))
OBE_US_Doses <- OBE_US_Doses %>% inner_join(DANU_Demographics, by=c("pat_id"="patid"))
length(unique(Dia_US_Doses$pat_id)) # 73882
length(unique(OBE_US_Doses$pat_id)) # 8096


Dia_US_Doses %>% left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN))  %>%
  select(pat_id, PHYSICIAN) %>% distinct() %>% drop_na() %>%
  filter(PHYSICIAN!="OTHER PHYSICIAN"&PHYSICIAN!="FACILITY"&PHYSICIAN!="UNKNOWN"&PHYSICIAN!="OTHER HCP") %>% distinct() %>%
  filter(PHYSICIAN=="ENDOCRINOLOGY") %>% select(pat_id) %>% distinct() # 69%

 
OBE_US_Doses %>% left_join(Specialties_to_keep %>% select(specialty, PHYSICIAN))  %>%
  select(pat_id, PHYSICIAN) %>% distinct() %>% drop_na() %>%
  filter(PHYSICIAN!="OTHER PHYSICIAN"&PHYSICIAN!="FACILITY"&PHYSICIAN!="UNKNOWN"&PHYSICIAN!="OTHER HCP") %>% distinct() %>%
  filter(PHYSICIAN=="ENDOCRINOLOGY") %>%select(pat_id) %>% distinct() 



DANU_Demographics %>%  group_by(diagnosis) %>% summarise(n=sum(weight))

DANU_Demographics %>% left_join(DANU_Demographics_Complete %>% select(patid, diagnosis) %>% rename("original"="diagnosis")) %>%
   group_by(diagnosis, original) %>% summarise(n=sum(weight))

# ----------------------------
# Pathways May 15 ----------------------------------------

DANU_Ingredients <- fread("DANU Ingredients.txt", integer64 = "character", stringsAsFactors = F)
DANU_Ingredients <- DANU_Ingredients %>%  separate(drug_id, c('class', 'molecule'))
DANU_Ingredients <- DANU_Ingredients %>% select(molecule, drug_group) 

DIA_Drug_Histories <- fread("DIA Drug Histories.txt", integer64 = "character", stringsAsFactors = F)
Treatment_exp_Vector <- fread("Treatment_exp_Vector.txt")

DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-disease) %>%
  gather(Month, Drugs, month1:month60) %>% filter(Drugs != "-")

DIA_Drug_Histories <- Treatment_exp_Vector %>% inner_join(DIA_Drug_Histories)
DIA_Drug_Histories <- separate_rows(DIA_Drug_Histories, Drugs, sep = ",", convert=T)

DIA_Drug_Histories <- DIA_Drug_Histories %>% 
  left_join(DANU_Ingredients %>% mutate(molecule=as.numeric(molecule)), by=c("Drugs"="molecule"))
                                                       
DIA_Drug_Histories <- DIA_Drug_Histories %>% select(-Drugs) %>% distinct()

unique(DIA_Drug_Histories$drug_group)

DIA_Drug_Histories <- DIA_Drug_Histories %>% mutate(drug_group=ifelse(drug_group=="Insulin", "I",
                                                ifelse(drug_group=="Biguanide", "b",
                                                       ifelse(drug_group=="SGLT2", "S",
                                                              ifelse(drug_group=="Antidiabetic", "d",
                                                                     ifelse(drug_group=="DPP4", "D",
                                                                            ifelse(drug_group=="GLP1 Injectable", "G", "g")))))))

DIA_Drug_Histories <- DIA_Drug_Histories %>% arrange(patient, weight, Month, desc(drug_group)) %>%
  group_by(patient, weight, Month) %>% mutate(drug_group=paste(drug_group, collapse=",")) 

DIA_Drug_Histories <- DIA_Drug_Histories %>% ungroup() 
DIA_Drug_Histories$Month <- as.character(DIA_Drug_Histories$Month)
DIA_Drug_Histories$Month <- parse_number(DIA_Drug_Histories$Month)

DIA_Drug_Histories %>% select(patient, weight) %>% distinct() %>% summarise(n=sum(weight))


temp <- DIA_Drug_Histories

temp <- temp %>% select(patient, weight, drug_group) %>% distinct() %>%
   group_by(patient, weight) %>% mutate(grp = rle(drug_group)$lengths %>% {rep(seq(length(.)), .)})

# temp %>% ungroup() %>% filter(grp==1) %>%
#   separate_rows(drug_group, sep = ",", convert=T) %>%
#   group_by(drug_group) %>% summarise(n=sum(weight)/30625690) %>%
#   arrange(-n)

# temp %>% ungroup() %>% filter(grp==2) %>%
#   separate_rows(drug_group, sep = ",", convert=T) %>%
#   group_by(drug_group) %>% summarise(n=sum(weight)/30625690) %>%
#   arrange(-n)

temp %>% ungroup() %>% 
  separate_rows(drug_group, sep = ",", convert=T) %>%
  group_by(grp, drug_group) %>% summarise(n=sum(weight)) %>%
  left_join(temp %>% ungroup() %>%  group_by(grp) %>% summarise(Total=sum(weight))) %>%
  mutate(Perc=100*n/Total) %>% select(-c(n, Total)) %>%
  spread(key=grp, value=Perc)



temp %>% arrange(patient, grp)

DANU_Demographics <- fread("DANU Demographics.txt")
min(DANU_Demographics$diabetes_onset, na.rm=T)

DANU_Demographics <- DANU_Demographics %>% drop_na() %>% filter(diabetes_onset>="2016-05-01"&diabetes_onset<="2018-04-30")
DANU_Demographics <- DANU_Demographics %>% select(patid)

data.frame(temp %>% ungroup() %>% inner_join(DANU_Demographics, by=c("patient"="patid")) %>%
  separate_rows(drug_group, sep = ",", convert=T) %>%
  select(patient, weight, drug_group) %>%
  distinct() %>% 
  group_by(patient, weight) %>% mutate(drug_group=paste(drug_group, collapse=",")) %>% distinct() %>%
  ungroup() %>%
  group_by(drug_group) %>% summarise(n=sum(weight))) %>%
  arrange(-n) 


MAX_Labs_Demographics <- fread("MAX_Labs_Demographics.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(patient, age, gender, MAX_HbA1c, MAX_BMI)
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% drop_na()
DIA_Disorders <- fread("DIA Disorders.txt")
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% left_join(DIA_Disorders %>% select(-disease))

MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(heart_attack=ifelse(is.na(heart_attack),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(heart_failure =ifelse(is.na(heart_failure ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(vascular_disease=ifelse(is.na(vascular_disease),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(stroke   =ifelse(is.na(stroke   ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(dementia =ifelse(is.na(dementia ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(pulmonary_disease =ifelse(is.na(pulmonary_disease ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(rheumatic_disease  =ifelse(is.na(rheumatic_disease  ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(peptic_ulcer  =ifelse(is.na(peptic_ulcer  ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(liver_disease    =ifelse(is.na(liver_disease    ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(diabetes =ifelse(is.na(diabetes ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(kidney_disease  =ifelse(is.na(kidney_disease  ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(diabetes_complications    =ifelse(is.na(diabetes_complications    ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(paralysis       =ifelse(is.na(paralysis       ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(cancer   =ifelse(is.na(cancer   ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(severe_liver_disease  =ifelse(is.na(severe_liver_disease  ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(severe_kidney_disease   =ifelse(is.na(severe_kidney_disease   ),0,1))
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% mutate(metastatic_cancer   =ifelse(is.na(metastatic_cancer   ),0,1))

MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(-diabetes)
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(-hiv_infection)

MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(-weight)
MAX_Labs_Demographics <- MAX_Labs_Demographics %>% select(-charlson_index_without_age)


data.frame(temp %>% ungroup() %>% inner_join(DANU_Demographics, by=c("patient"="patid")) %>%
  separate_rows(drug_group, sep = ",", convert=T) %>%
  select(patient, weight, drug_group) %>%
  distinct() %>%
  arrange(patient, weight, drug_group) %>%
  group_by(patient, weight) %>% mutate(drug_group=paste(drug_group, collapse=",")) %>% distinct() %>%
  ungroup() %>%
  group_by(drug_group) %>% summarise(n=sum(weight))) %>%
  arrange(-n)  %>%
  mutate(Total=sum(n)) %>%
  mutate(n2=n/Total) %>%
  mutate(cum=cumsum(n2))


ignore <- data.frame(temp %>% ungroup() %>% inner_join(DANU_Demographics, by=c("patient"="patid")) %>%
                       separate_rows(drug_group, sep = ",", convert=T) %>%
                       select(patient, weight, drug_group) %>%
                       distinct() %>% 
                       arrange(patient, weight, drug_group) %>%
                       group_by(patient, weight) %>% mutate(drug_group=paste(drug_group, collapse=",")) %>% distinct() %>%
                       ungroup()) %>%
  inner_join(MAX_Labs_Demographics %>% select(patient, age, gender, MAX_HbA1c, MAX_BMI, charlson_index, kidney_disease, heart_failure , stroke ,  rheumatic_disease , liver_disease, vascular_disease))




data.frame(temp %>% ungroup() %>% inner_join(DANU_Demographics, by=c("patient"="patid")) %>%
  separate_rows(drug_group, sep = ",", convert=T) %>%
  select(patient, weight, drug_group) %>%
  distinct() %>%
  arrange(patient, weight, drug_group) %>%
  group_by(patient, weight) %>% mutate(drug_group=paste(drug_group, collapse=",")) %>% distinct() %>%
  ungroup() %>%
  group_by(drug_group) %>% summarise(n=sum(weight))) %>%
  arrange(-n)  %>% select(-n) %>%
  left_join(ignore %>% group_by(drug_group) %>% summarise(tot=sum(weight))) %>%
    left_join(ignore %>% filter(kidney_disease==1) %>% group_by(drug_group) %>% summarise(kidney_disease=sum(weight))) %>%
    left_join(ignore %>% filter(heart_failure==1) %>% group_by(drug_group) %>% summarise(heart_failure=sum(weight))) %>%
    left_join(ignore %>% filter(stroke==1) %>% group_by(drug_group) %>% summarise(stroke=sum(weight))) %>%
    left_join(ignore %>% filter(rheumatic_disease==1) %>% group_by(drug_group) %>% summarise(rheumatic_disease=sum(weight))) %>%
    left_join(ignore %>% filter(liver_disease==1) %>% group_by(drug_group) %>% summarise(liver_disease=sum(weight))) %>%
    left_join(ignore %>% filter(vascular_disease==1) %>% group_by(drug_group) %>% summarise(vascular_disease=sum(weight))) 




#  


to_fit <- data.frame(temp %>% ungroup() %>% inner_join(DANU_Demographics, by=c("patient"="patid")) %>%
  separate_rows(drug_group, sep = ",", convert=T) %>%
  select(patient, weight, drug_group) %>%
  distinct() %>% 
  arrange(patient, weight, drug_group) %>%
  group_by(patient, weight) %>% mutate(drug_group=paste(drug_group, collapse=",")) %>% distinct() %>%
  ungroup()) %>%
  filter(drug_group=="S,b,d"|drug_group=="b") %>% select(-weight)

to_fit <- to_fit %>% mutate(drug_group=ifelse(drug_group=="S,b,d",1,0))
to_fit <- to_fit %>% inner_join(MAX_Labs_Demographics)

to_fit <- to_fit %>% select(-patient)
to_fit$drug_group <- as.factor(to_fit$drug_group) 

model_rf <-randomForest::randomForest(drug_group ~ . , data = to_fit)
summary(model_rf)
model_rf$importance
randomForest::varImpPlot(model_rf)

to_fit %>% group_by(drug_group, kidney_disease) %>% count()

to_fit %>% group_by(drug_group) %>% summarise(n=mean(age))


# --------------------------------------


# Annual -------------------------
DANU_Demographics <- fread("DANU Demographics.txt")
unique(DANU_Demographics$diagnosis)
DANU_Demographics <- DANU_Demographics %>% filter(diagnosis!="-")
DANU_Demographics %>% group_by(diagnosis) %>% summarise(n=sum(weight))
 DANU_Demographics <- DANU_Demographics %>% select(patid, weight, diagnosis)
names(DANU_Demographics)[3] <- "group"
 
DANU_Demographics <- DANU_Demographics %>% mutate(group=ifelse(grepl("Diabetes", group), "Diabetes", group))
DANU_Demographics %>% group_by(group) %>% summarise(n=sum(weight))

# 1 Diabetes  48232675.
# 2 Obesity  106469049.

DIA_Comorbidities_Annual_Inventories <- fread("DIA Comorbidity Annual Inventories.txt")
DIA_Comorbidities_Annual_Inventories <- DIA_Comorbidities_Annual_Inventories %>% select(patid, weight, diagnosis, year5) %>% filter(year5!=0)

OBE_Comorbidities_Annual_Inventories <- fread("OBE Comorbidity Annual Inventories.txt")
OBE_Comorbidities_Annual_Inventories <- OBE_Comorbidities_Annual_Inventories %>% select(patid, weight, diagnosis, year5) %>% filter(year5!=0)

Comorbidities_Annual_Inventories <- DIA_Comorbidities_Annual_Inventories %>% bind_rows(OBE_Comorbidities_Annual_Inventories)

Comorbidities_Annual_Inventories <- Comorbidities_Annual_Inventories %>% inner_join(DANU_Demographics)

Comorbidities_Annual_Inventories <- Comorbidities_Annual_Inventories %>% mutate(group=ifelse(grepl("Diabetes", group), "Diabetes", group))

# CKD
CKD <- Comorbidities_Annual_Inventories %>% filter(grepl("N18", diagnosis)) %>% select(patid, weight, group) %>% distinct() 
 

# CVD
CVD <- Comorbidities_Annual_Inventories %>% filter(grepl("I20", diagnosis)|
                                   grepl("I21", diagnosis)|
                                   grepl("I22", diagnosis)|
                                   grepl("I23", diagnosis)|
                                   grepl("I24", diagnosis)|
                                   grepl("I25", diagnosis)|
                                   grepl("I4", diagnosis)|
                                   grepl("I6", diagnosis)|
                                   grepl("G45", diagnosis))  %>% select(patid, weight, group) %>% distinct()

# HF
HF <- Comorbidities_Annual_Inventories %>% filter(grepl("I5", diagnosis))  %>% select(patid, weight, group) %>% distinct() 


# Ischemic heart Disease
IHD <- Comorbidities_Annual_Inventories %>% filter(grepl("I20", diagnosis)|
                                   grepl("I21", diagnosis)|
                                   grepl("I22", diagnosis)|
                                   grepl("I23", diagnosis)|
                                   grepl("I24", diagnosis)|
                                   grepl("I25", diagnosis))  %>% select(patid, weight, group) %>% distinct() 


# OA
OA <- Comorbidities_Annual_Inventories %>% filter(grepl("M15", diagnosis)|
                                   grepl("M16", diagnosis)|
                                   grepl("M17", diagnosis)|
                                   grepl("M18", diagnosis)|
                                   grepl("M19", diagnosis))  %>% select(patid, weight, group) %>% distinct()


# SA
SA <- Comorbidities_Annual_Inventories %>% filter(grepl("G47", diagnosis))  %>% select(patid, weight, group) %>% distinct() 

# Dyslipidemia
Dyslipidemia <- Comorbidities_Annual_Inventories %>% filter(grepl("E78", diagnosis))  %>% select(patid, weight, group) %>% distinct()


# HTN
HTN <- Comorbidities_Annual_Inventories %>% filter(grepl("I10", diagnosis))  %>% select(patid, weight, group) %>% distinct() 


# Pred-Diabetes
Pre <- Comorbidities_Annual_Inventories %>% filter(grepl("R73", diagnosis))  %>% select(patid, weight, group) %>% distinct()

# POS
POS <- Comorbidities_Annual_Inventories %>% filter(grepl("E28", diagnosis))  %>% select(patid, weight, group) %>% distinct() 

# PAD
PAD <- Comorbidities_Annual_Inventories %>% filter(grepl("I70", diagnosis)|grepl("I73", diagnosis))  %>% select(patid, weight, group) %>% distinct() 


# -----------------


# BMI vs Health care  utilizations --------------------

DANU_Utilizations <- fread("DANU Utilizations.txt")


DANU_Measures_BMI <- fread("DANU Measures.txt",  integer64 = "character", stringsAsFactors = F)
DANU_Measures_BMI <- DANU_Measures_BMI %>% filter(test=="BMI")  %>% select(patid, value) %>% distinct()
DANU_Measures_BMI <- DANU_Measures_BMI %>% group_by(patid) %>% filter(value==max(value)) %>% slice(1) %>% ungroup()
DANU_Utilizations <- DANU_Measures_BMI %>% inner_join(DANU_Utilizations)
DANU_Utilizations <- DANU_Utilizations %>% filter(value>=27)
  DANU_Utilizations <- DANU_Utilizations %>% filter(value<=70)
DANU_Utilizations <- DANU_Utilizations %>% rename("BMI"="value")

cor(DANU_Utilizations$medical_visits, DANU_Utilizations$BMI)


DANU_Utilizations %>%
  ggplot(aes(BMI, hospital_long_stays )) +
  geom_smooth(fill="deepskyblue4", colour="black") +
  theme_minimal() +
  xlab("\n BMI [27-70]") + ylab("Hospital long-stays\n")


# -------------------
